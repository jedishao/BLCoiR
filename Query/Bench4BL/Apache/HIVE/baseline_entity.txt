545	Use ArrayList Vector threaded Hive codeMost Hive code is threaded are using Vector ArrayList class ArrayList is Vector is
3057	getMS calls get RawStore object HiveMetaStore set thread store shutdown shutdown function HiveMetaStore does set thread RawStore variable threadLocalMS
3408	seems race condition problem HashSet object is caused extractCounters updateCountersInQueryPlan are executed hit problem Hive think is caused 0 8 1 problem is reported persons mailing list following is part thread dump Thread prio tid nid Thread prio tid nid race condition is caused QueryPlan classHive threads are stopped is used QueryPlan  extractCounters QueryPlan  updateCountersInQueryPlan State State
4000	Hive client goes loop   cpu Hive client starts threads track progress MapReduce jobs threads access static HashMaps are protected locks HashMaps are modified cause race conditions lead client threads getting stuck loops
7011	HiveInputFormat split generation is thread Tez do split generation parallel Need protect inputformat cache access
7341	Support Table replication HCatalog instances Systems Apache Falcon find need replicate partition data clusters keep HCatalog metadata sync poses couple problems be avoided HCatAddPartitionDesc kept track partition schema flight source target metastores be running versions Hive patch attempts address concerns caveats HCatTable has diff method compare HCatTable instance resolve diff method copy specified table attributes HCatTable post patch trunk HCatClient does provide support replicating definitions HCatalog Server e Hive metastore instances definition source table change column schema O formats record formats serde parameters system need way diff tables update target metastore changes E g  addPartitions API requires partition schema be derived table schema requiring table schema be resolved partitions schema are added table is introduces race conditions partitions differing column schemas g right schema change are copied parallel serialize deserialize mechanism serializeTable deserializeTable instances constructed class loaders be used comparison HCatPartition provides grained control Partition column schema StorageDescriptor settings allows partitions be copied source ability override properties required g location updateTableSchema update table definition column schema  ve cleaned removed redundancy HCatTable HCatCreateTableDesc Builder API failed separate table attributes add table operation attributes providing interfaces HCatTable composing instance HCatCreateTableDesc interfaces are ish setters are deprecated favour HCatTable HCatPartition HCatAddPartitionDesc
8440	Hiveserver block query environment Hiveserver handle jobs day found number ETL tasks wait ETL schedule queue runIn situation Hadoop Job running Hadoop cluster maps reduces slots view Hiveserver heap found Hiveserver block number query pool  1 thread 17903 prio tid nid waiting monitor entry 0x00007f893413b000 is problem HiveServer handle requests client HiveServer handle requests synchronized compileMonitor State BLOCKED object monitor waiting lock Object code ql cause Hiveserver handle requests
9199	lock used DDLs DummyTxnManager DDL output WriteEntity is DDL operations be given locks are needed causes locking contention example createTable DummyTxnManager suggests lock table database writeentity is DummyTxnManager lockMode WriteEntity g database table is determined writeType
9598	catch SQLException e D JDBC Hortonworks_Hive13 commons configuration 1 6 jar D JDBC Hortonworks_Hive13 commons logging 1 1 3 jar D JDBC Hortonworks_Hive13 hadoop common 2 4 0 2 1 1 0 385 jar D JDBC Hortonworks_Hive13 hive exec 0 13 0 2 1 1 0 385 jar D JDBC Hortonworks_Hive13 hive jdbc 0 13 0 2 1 1 0 385 jar D JDBC Hortonworks_Hive13 hive service 0 13 0 2 1 1 0 385 jar D JDBC Hortonworks_Hive13 httpclient 4 2 5 jar D JDBC Hortonworks_Hive13 httpcore 4 2 5 jar D JDBC Hortonworks_Hive13 libfb303 0 9 0 jar D JDBC Hortonworks_Hive13 libthrift 0 9 0 jar D JDBC Hortonworks_Hive13 log4j 1 2 16 jar D JDBC Hortonworks_Hive13 slf4j api 1 7 5 jar D JDBC Hortonworks_Hive13 slf4j log4j12 1 7 5 jar tryRelease Exception thread IllegalMonitorStateException
10483	insert overwrite partition deadlocks DbTxnManagerinsert overwrite partition part xxxx select xxx tb join ta part xxxx seems Shared conflicts lock Insert Overwrite are part txn insert overwrite requires X lock partition read side needs S lock query case is insert overwrite partition part xxxx select ta
11036	Race condition DataNucleus makes Metastore hangUnder query workload Metastore gets deadlocked DataNucleus
11616	DelegationTokenSecretManager reuses objectstore has concurrency issues log get exception analysis found hivemetastore start DelegationTokenSecretManager maintain objectstore see lead issue DelegationTokenStore NucleusTransactionException state Transaction has started Caused NucleusTransactionException state Transaction has started
12238	Vectorization Thread safety errors VectorUDFDate Caused NumberFormatException input string
12248	rawStore used DBTokenStore be thread implementation RawStore ObjectStore set DBTokenStore is being shared multi threads causes race condition DataNuclues access backend DB DN PersistenceManager PM ObjectStore is thread DBTokenStore use ThreadLocal ObjectStore Following errors be root caused race condition DN PM Object type MDelegationToken is detached Detached objects be used operation ObjectDetachedException Object type MDelegationToken is detached Detached objects be used operation
12266	client exists does release ACID locks start Hive CLI locking enabled run command acquires locks C shell command completes locks command remain timeout believe Beeline has issue Need add hooks release locks command dies
12409	make initTxnMgr is thread make method synchronized HS2 run threads Session see HIVE
12529	throw exception timeout given method signature is written acquireLocks block DbTxnManager method block competing locks have gone is clients be way specify max wait time
12620	Misc improvement Acid module Add logic DBLockManager detect is attempt interleave transactions locks statements read auto commit mode TxnHandler  getTxnIdFromLockId include lock id  s found TxnHandler  checkRetryable log exception saw unlock fails lock turn timeout lock is removed DbLockManger tracking checkLock use connection timeOutLocks refactor log locks were expired simplifies debugging lock throw MetaException Couldn apos t find lock created include lockid
12768	Thread safety serde deserialization see thread safety issues static decimal buffer serde
12797	Synchronization issues tez llap session pool hs2 changes introduced part HIVE causes issues shutting hs2 session pools are used ConcurrentModificationException
12904	LLAP deadlock task scheduling Thread state BLOCKED Thread state BLOCKED IPC Server handler waiting lock Monitor 0x00007f5d322ecb08 Object 0x00007f67032cd2c0 org apache hadoop hive llap daemon impl TaskExecutorService is held ExecutionCompletionThread   ExecutionCompletionThread   waiting lock Monitor 0x00007f6066b9e8c8 Object 0x00007f66b6570200 org apache hadoop hive llap daemon impl QueryInfo is held IPC Server handler Found total deadlock Looks apos caused synchronized blocks TaskWrapper synchronized maybeUnregisterForFinishedStateNotifications calls FinishableStateTracker FST calls returns does need synchronized do know are issues is sync blocks  s fix isInWaitQueue  bci line Compiled frame TaskExecutorService  bci line Compiled frame TaskExecutorService TaskExecutorService  bci line Compiled frame finishableStateUpdated  bci line Compiled frame String  bci line Compiled frame String  bci line Compiled frame String String LlapDaemonProtocolProtos  bci line Compiled frame LlapDaemonProtocolProtos  bci line Compiled frame LlapDaemonProtocolProtos  bci line Compiled frame RpcController LlapDaemonProtocolProtos  bci line Compiled frame Descriptors MethodDescriptor RpcController Message  bci line Compiled frame RPC  Server String  bci line Compiled frame RPC  RpcKind String  bci line Compiled frame run  bci line Compiled frame run  bci line Compiled frame PrivilegedExceptionAction AccessControlContext  bci Compiled frame Subject PrivilegedExceptionAction  bci line Compiled frame PrivilegedExceptionAction  bci line Compiled frame run  bci line Interpreted frame FinishableStateUpdateHandler  bci line Compiled frame FinishableStateUpdateHandler  bci line Compiled frame FinishableStateUpdateHandler  bci line Compiled frame maybeUnregisterForFinishedStateNotifications  bci line Compiled frame TaskRunner2Result  bci line Compiled frame Object  bci line Compiled frame run  bci line Compiled frame ThreadPoolExecutor Worker  bci line Compiled frame run  bci line Interpreted frame run  bci line Interpreted frame say synch methods objects call objects be used be replace sync methods sync blocks cover method remove ones isWait scope blocks be adjusted based logic future
12926	synchronization issue tez llap session pool hs2 changes introduced part HIVE causes issues shutting hs2 session pools are used ConcurrentModificationException
12927	HBase metastore sequences be row row Is presence concurrency use HBase increment API
12996	Temp tables be locked INSERT INTO VALUES statements use temp table accomplish functionality CTC_TXNID acid t1 acid values tmp table acid t1 acid values tmp table acid values tmp table acid t1 acid values tmp table acid ds today acid values tmp table acid t3p ds today hour temp tables be stored metastore tables ACID are definition session created do allow threads session temp table is used query be ignored lock manager
13013	Improve concurrency TxnHandler are operations TxnHandler run Serializable isolation be dropped READ_COMMITTED have UPDATE support reduce number deadlocks DBs
13213	make DbLockManger work resources example insert T values T is ACID table acquire Read lock table acquire lock
13395	Lost Update problem ACIDACID users run Lost Update problem happen is compile time acquireLocksAndOpenTxn runInternal is called lock snapshot say value x snapshot get lock row second block makes x commits proceeds makes x  s snapshot x is issue is solved Hive HIVE 11077 is patch deals txns moving recordValidTxns locks are acquired reduces likelihood does eliminate problem start txn say txnid Say gets lock blocks commits problem is locks are MVCC architecture work term want support update user defined PK streaming ingest work statement txns case  d lock snapshot start txn queries use snapshot locks queries be acquired snapshot is locked be situation HIVE 11077 write set tracking requires metastore table keeping info HIVE_LOCKS state term SQL side things auto commit mode acquire locks open txn update locks txn id implies Thrift change pass lockId openTxn work Streaming API opens txns acquires locks  s is issue Streaming does Insert way feels is example need Write Set tracking txns Consider transactions T T T r x y c T x y c Suppose order operations is r x x R W lock manager w MVCSS block write T MVCC do want readers interfere writers following schedule is Hive write do conflict shared read locks Hive implementation r x x y c y c Hive recordValidTxns records snapshot use query is called compile suppose update T set x x   are executed simplicity assume is row T version code have issue Assume queries updates row x currentTransactionId proceed get snapshot includes e see x write x set currentTransactionId merge logic runs see x is version row e lost update level Row ID has originalTransactionId rowid bucket id currentTransactionId update do table scan check are write row currentTransactionId currentTransactionId row  ve read fail query currentTransactionId is surfaced level check be made solution used MVCC is keep track start commit time counter transaction detect txns overlap part is keep track write set e data rows partitions level granularity is were modified txn txns overlap time wrote element abort is called committer wins rule requires MS DB schema change be use sequence txnId start commit time case txnid start time case need add filed TXNS table complication is be using elements sequence are used part file name delta base dir limited digits be exceeded require thought handling upgrade migration time y happens T has committed released  s locks is lost update c is allowed commit  s write set tracking comes
13458	Heartbeater does fail query heartbeat fails heartbeat fails locate lock fail query does happen is bug thing is need make stopHeartbeat stops heartbeat e heartbeat be sent break assumption cause query fail
13512	Make initializing dag ids TezWork thread compilation query compilation is enabled is running threads create TezWork objects have dag id is counter used obtain dag id is thread counter be AtomicInteger int
13599	LLAP handling preemption queue state updates running tests pre emption enabled got following exception Looks race condition removing items pre emption queue Wait Queue Scheduler ERROR TaskExecutorService Wait queue scheduler worker exited failure NoSuchElementException Wait Queue Scheduler INFO LlapDaemon UncaughtExceptionHandler invoked Wait Queue Scheduler ERROR LlapDaemon Thread Thread Wait Queue Scheduler 0 5 threw Exception Shutting NoSuchElementException
13699	Make JavaDataModel  get thread compilation class JavaDataModel has static method  get is thread be issue query compilation is enabled threads attempt call JavaDataModel  get time
13725	ACID Streaming API synchronize calls threads use streaming endpoint creates metastore client gets used RPC sample use case is follows Thread creates streaming endpoint opens txn batch Thread heartbeats txn batch impl result sequence response response calls thread1 end going vice versa client is thread API methods provide synchronization methods be called threads
13753	Make metastore client thread DbTxnManager fact threads sharing metastore client is used RPC Thrift is thread Race condition happen sees sequence response error message Thrift server means response Thrift server is request thread Solution be synchronize methods client side
13833	Add delay starting heartbeat scheduling heartbeat happens lock acquisition  s send heartbeat time locks is acquired Add delay skip
13858	LLAP preempted task end waiting completeInitialization End result executor slot blocked LLAP Depending is running cause cluster level deadlock part executing code suppressed interruptAn interrupt abort call is made attempting preempt task case task was middle HDFS IO handled interrupt retrying result interrupt status thread was skipping get completeInitialization task ended blocking
14357	TestDbTxnManager2  testLocksInSubquery failing branch somebody explain be test case is failing expected order locks is supposed be T S R inspection seems be R S T   m locks are order is Raising jira try understand
14400	Handle insert partition users issuing insert statements partition has side effect queries see partition time  re issued realize partition is is trying add partition metastore get AlreadyExistsException query created race condition example imagine table is created following queries are launched time sessions insert table T partition ds values apos Joe apos apos today apos fail AlreadyExistsException
14463	hcatalog server extensions test cases getting module is getting stuck tests coming days TestMsgBusConnection is test case has problem ran tests environment took thread dump got stuck thread dump Java HotSpot TM Bit Server VM mode ActiveMQ Transport tcp daemon prio tid nid ActiveMQ Transport tcp prio tid nid BoneCP pool watch thread daemon prio tid nid waiting condition 0x0000000118a4f000 BoneCP keep scheduler daemon prio tid nid waiting condition 0x0000000118746000 BoneCP pool watch thread daemon prio tid nid waiting condition BoneCP keep scheduler daemon prio tid nid waiting condition 0x0000000118e28000 ActiveMQ Transport tcp daemon prio tid nid ActiveMQ Transport tcp prio tid nid ActiveMQ Journal Checkpoint Worker daemon prio tid nid waiting condition 0x0000000117c77000 RMI Scheduler daemon prio tid nid waiting condition 0x000000011796e000 RMI TCP Accept daemon prio tid nid RMI TCP Accept daemon prio tid nid Service Thread daemon prio tid nid C2 CompilerThread1 daemon prio tid nid waiting condition 0x0000000000000000 C2 CompilerThread0 daemon prio tid nid waiting condition 0x0000000000000000 Signal Dispatcher daemon prio tid nid waiting condition 0x0000000000000000 VM Thread prio tid nid GC task thread   ParallelGC prio tid nid GC task thread   ParallelGC prio tid nid GC task thread   ParallelGC prio tid nid GC task thread   ParallelGC prio tid nid VM Periodic Task Thread prio tid nid waiting condition JNI references Heap PSYoungGen 526336K used 184063K 0x00000007d5500000 0x00000007f6d00000 0x0000000800000000 eden space 503808K   used x00000007dfa320c 0 0 x00000007f4100000 space 22528K   used 0x00000007f x00000007f658de x00000007f6d00000 space 22528K   used 0x00000007f x00000007f x00000007f5700000 ParOldGen 174592K used 27797K 0x0000000780000000 0x000000078aa80000 0x00000007d5500000 object space 174592K   used 0x x0000000781b257c x000000078aa80000 PSPermGen 53760K used 53538K 0x0000000760000000 0x0000000763480000 0x0000000780000000 object space 53760K   used 0x 0000000760000000 0x x0000000763480000 Ashutosh Chauhan check  re author test InactivityMonitor Async Task ThreadPoolExecutor State queue daemon prio tid nid waiting condition 0x0000000117b74000 State TIMED_WAITING parking parking wait SynchronousQueue InactivityMonitor Async Task ThreadPoolExecutor State queue daemon prio tid nid waiting condition 0x000000011786b000 State TIMED_WAITING parking parking wait SynchronousQueue State State ActiveMQConnection ID IM1258 X1  56879 1470642083403 2 2 Scheduler daemon prio tid nid wait State WAITING object monitor waiting TaskQueue locked TaskQueue State WAITING parking parking wait AbstractQueuedSynchronizer State TIMED_WAITING parking parking wait AbstractQueuedSynchronizer Finalizer daemon prio tid nid wait State WAITING object monitor waiting ReferenceQueue Lock locked ReferenceQueue Lock State WAITING parking parking wait AbstractQueuedSynchronizer State TIMED_WAITING parking parking wait AbstractQueuedSynchronizer Finalizer daemon prio tid nid wait State WAITING object monitor waiting ReferenceQueue Lock locked ReferenceQueue Lock rawStoreDaemon daemon prio tid nid wait State TIMED_WAITING object monitor waiting BasicDaemon locked BasicDaemon Timer daemon prio tid nid wait State WAITING object monitor waiting TaskQueue locked TaskQueue InactivityMonitor WriteCheck daemon prio tid nid wait State TIMED_WAITING object monitor waiting TaskQueue locked TaskQueue InactivityMonitor ReadCheck daemon prio tid nid wait State TIMED_WAITING object monitor waiting TaskQueue locked TaskQueue State State ActiveMQConnection ID IM1258 X1  56879 1470642083403 2 1 Scheduler daemon prio tid nid wait State WAITING object monitor waiting TaskQueue locked TaskQueue ActiveMQ Transport Server daemon prio tid nid State ActiveMQ Transport Server Thread Handler daemon prio tid nid waiting condition 0x0000000118134000 State TIMED_WAITING parking parking wait AbstractQueuedSynchronizer ActiveMQ Broker localhost Scheduler daemon prio tid nid wait State TIMED_WAITING object monitor waiting TaskQueue locked TaskQueue ActiveMQ Data File Writer daemon prio tid nid wait State WAITING object monitor waiting DataFileAppender locked DataFileAppender State TIMED_WAITING sleeping KahaDB Scheduler daemon prio tid nid wait State TIMED_WAITING object monitor waiting TaskQueue locked TaskQueue RMI RenewClean daemon prio tid nid wait State TIMED_WAITING object monitor waiting ReferenceQueue Lock locked ReferenceQueue Lock State TIMED_WAITING parking parking wait AbstractQueuedSynchronizer GC Daemon daemon prio tid nid wait State TIMED_WAITING object monitor waiting GC  LatencyLock locked GC  LatencyLock RMI Reaper prio tid nid wait State WAITING object monitor waiting ReferenceQueue Lock locked ReferenceQueue Lock State State State State State State Finalizer daemon prio tid nid wait State WAITING object monitor waiting ReferenceQueue Lock locked ReferenceQueue Lock Reference Handler daemon prio tid nid wait State WAITING object monitor waiting Reference Lock locked Reference Lock prio tid nid wait State WAITING object monitor waiting Object locked Object
14739	Replace runnables added runtime shutdown hooks avoid deadlock Deepesh Khandelwal reported deadlock occur running queries hive cli Hive Hadoop has ShutdownHookManager runs shutdown hooks order based priority use avoid deadlock code Chris Nauroth analyzed reported hive adds shutdown hooks java Runtime execute order causing deadlocks hadoop shutdown hooks case shutdown locked FileSystem  Cache hive shutdown hook locked FileSystem  Cache order causing deadlock
14778	document threading model Streaming APIThe model is needs be documented StreamingConnection maintains MetaStoreClient objects has Thrift client RPC Let call heartbeat TransactionBatch created given StreamingConnection gets reference MetaStoreClients model is is is TransactionBatch given StreamingConnection given TransactionBatch be threads accessing thread calling heartbeat nothing calling methods
14924	MSCK REPAIR table threaded is throwing pointer exception Error order reproduce MSCK REPAIR TABLE is throwing Pointer Exception running threaded mode thread set thread run MSCK REPAIR TABLE command
15090	Temporary DB failure stop ExpiredTokenRemover thread HIVE decided close metastore is exception token removal process fix leaves running metastore ExpiredTokenRemover thread fix move catch running loop hope thread recover exception