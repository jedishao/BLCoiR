132	BoundedQueueThreadPoolWriteAttributeHandler does not deal with undefined core threads correctly  BoundedQueueThreadPoolWriteAttributeHandler doesn t deal with undefined values for core threads correctly  It assumes the attribute will be defined  and that s not required  The attribute doesn t have a fixed default value  Instead  the behavior in add is to set the runtime value to match max threads of core threads is undefined  BoundedQueueThreadPoolWriteAttributeHandler should do the same
196	Hang in HostController shutdown when CTRL C is usedIt is fairly easy to produce a hang in domain mode shutdown by launching domain sh and then soft killing the process with CTRL C  If this hang happens  a thread dump will show this        Host Controller   Remoting  localhost MANAGEMENT  task 16  prio 5 tid 0x00007fa07423b800 nid 0x3b0b waiting for monitor entry  0x000000010bce6000       Host Controller     java lang Thread State  BLOCKED  on object monitor       Host Controller  	at org jboss as host controller ManagedServer callbackUnregistered ManagedServer java 417       Host Controller  	  waiting to lock &lt 0x00000007f7946a30&gt   a org jboss as host controller ManagedServer       Host Controller  	at org jboss as host controller ServerInventoryImpl 1 handleClose ServerInventoryImpl java 461       Host Controller  	at org jboss as host controller ServerInventoryImpl 1 handleClose ServerInventoryImpl java 456       Host Controller  	at org jboss remoting3 spi SpiUtils safeHandleClose SpiUtils java 54       Host Controller  	at org jboss remoting3 spi AbstractHandleableCloseable CloseHandlerTask run AbstractHandleableCloseable java 501       Host Controller  	at org jboss remoting3 spi AbstractHandleableCloseable runCloseTask AbstractHandleableCloseable java 406       Host Controller  	at org jboss remoting3 spi AbstractHandleableCloseable closeComplete AbstractHandleableCloseable java 277       Host Controller  	at org jboss remoting3 remote RemoteConnectionChannel closeAction RemoteConnectionChannel java 532       Host Controller  	at org jboss remoting3 spi AbstractHandleableCloseable close AbstractHandleableCloseable java 153       Host Controller  	at org jboss as protocol mgmt ManagementChannelReceiver handleEnd ManagementChannelReceiver java 127       Host Controller  	at org jboss remoting3 remote RemoteConnectionChannel 2 run RemoteConnectionChannel java 282       Host Controller  	at java util concurrent ThreadPoolExecutor runWorker ThreadPoolExecutor java 1145       Host Controller  	at java util concurrent ThreadPoolExecutor Worker run ThreadPoolExecutor java 615       Host Controller  	at java lang Thread run Thread java 744                 Host Controller   Host Controller Service Threads   13  prio 5 tid 0x00007fa072cbc800 nid 0xa903 waiting on condition  0x000000010d93a000       Host Controller     java lang Thread State  WAITING  parking       Host Controller  	at sun misc Unsafe park Native Method       Host Controller  	  parking to wait for  &lt 0x00000007f61e5480&gt   a java util concurrent locks AbstractQueuedSynchronizer ConditionObject       Host Controller  	at java util concurrent locks LockSupport park LockSupport java 186       Host Controller  	at java util concurrent locks AbstractQueuedSynchronizer ConditionObject await AbstractQueuedSynchronizer java 2043       Host Controller  	at java util concurrent LinkedBlockingQueue take LinkedBlockingQueue java 442       Host Controller  	at org jboss as controller remote BlockingQueueOperationListener retrievePreparedOperation BlockingQueueOperationListener java 88       Host Controller  	at org jboss as controller remote TransactionalProtocolHandlers executeBlocking TransactionalProtocolHandlers java 76       Host Controller  	at org jboss as host controller ManagedServer ServerStopTask execute ManagedServer java 846       Host Controller  	at org jboss as host controller ManagedServer internalSetState ManagedServer java 531       Host Controller  	at org jboss as host controller ManagedServer stop ManagedServer java 259       Host Controller  	  locked &lt 0x00000007f7946a30&gt   a org jboss as host controller ManagedServer       Host Controller  	at org jboss as host controller ServerInventoryImpl stopServers ServerInventoryImpl java 339       Host Controller  	at org jboss as host controller ServerInventoryImpl shutdown ServerInventoryImpl java 437       Host Controller  	at org jboss as host controller ServerInventoryService 1 run ServerInventoryService java 124       Host Controller  	at java util concurrent ThreadPoolExecutor runWorker ThreadPoolExecutor java 1145       Host Controller  	at java util concurrent ThreadPoolExecutor Worker run ThreadPoolExecutor java 615       Host Controller  	at java lang Thread run Thread java 744       Host Controller  	at org jboss threads JBossThread run JBossThread java 320        The 2nd thread is blocking waiting for a prepared response from one of the servers  The first thread is trying to send a notification that the channel connecting to the server has been closed  The first thread will never unblock because the 2nd thread can t proceed and deliver the information that the channel is closed  This happens because all the processes  PC  HC  servers  respond to the CTRL C  So the server is shutting down in parallel and has closed the channel  In theory this could happen for other reasons too  though  Anything that results in closing the channel while the ManagedServer lock is held
202	Deadlock when shutdown Wildfly server during CLI client connectionCreating upstream issue as the same deadlock can be found in WFLY  Descirption as comment 5 in BZ1142538    The following deadlock still exists    Steps to Reproduce      1  Prepare a running EAP instance with secured management port   optionally in VM     2  Execute export JAVA_OPTS   agentlib jdwp transport dt_socket address 8787 server y suspend y      3  In the same terminal  execute  bin jboss cli sh   connect   controller  EAP_IP   user admin   password password &amp apos  read resource&amp apos       4  From yet another terminal  execute  jdb  attach localhost 8787      5  In JDB      5 a  Create breakpoint   stop in org xnio channels FramedMessageChannel receive java nio ByteBuffer       5 b  Resume all threads   resume      5 c   Execute five times  Wait until breakpoint is hit and execute  resume   Either set timeout or be fast so that timeout does not occur first     6  Execute  kill  9  EAP_PID    optionally in VM     7  In JDB      8 a  Remove breakpoint   clear org xnio channels FramedMessageChannel receive java nio ByteBuffer       8 b  Resume all threads   resume      9  Now dump the stack trace of jboss cli sh   kill  3  JBOSS_CLI_PID                          Found one Java level deadlock                                         Remoting  cli client  read 1       waiting to lock monitor 0x00007ff9c829b558  object 0x0000000783433408  a java lang String       which is held by  main       main       waiting to lock monitor 0x00007ff9c8333c48  object 0x00000007851ae6e0  a java util ArrayDeque       which is held by  Remoting  cli client  read 1           Java stack information for the threads listed above                                                               Remoting  cli client  read 1       at org jboss as cli impl CLIModelControllerClient ChannelCloseHandler handleClose CLIModelControllerClient java 286        waiting to lock &lt 0x0000000783433408&gt   a java lang String      at org jboss as cli impl CLIModelControllerClient ChannelCloseHandler handleClose CLIModelControllerClient java 269      at org jboss remoting3 spi SpiUtils safeHandleClose SpiUtils java 54      at org jboss remoting3 spi AbstractHandleableCloseable CloseHandlerTask run AbstractHandleableCloseable java 501      at org jboss remoting3 spi AbstractHandleableCloseable runCloseTask AbstractHandleableCloseable java 406      at org jboss remoting3 spi AbstractHandleableCloseable closeComplete AbstractHandleableCloseable java 277      at org jboss remoting3 remote RemoteConnectionChannel closeAction RemoteConnectionChannel java 532      at org jboss remoting3 spi AbstractHandleableCloseable closeAsync AbstractHandleableCloseable java 359      at org jboss remoting3 remote RemoteConnectionHandler closeAllChannels RemoteConnectionHandler java 392        locked &lt 0x00000007851ae6e0&gt   a java util ArrayDeque      at org jboss remoting3 remote RemoteConnectionHandler handleConnectionClose RemoteConnectionHandler java 109      at org jboss remoting3 remote RemoteReadListener handleEvent RemoteReadListener java 81        locked &lt 0x00000007851ae6e0&gt   a java util ArrayDeque      at org jboss remoting3 remote RemoteReadListener handleEvent RemoteReadListener java 45      at org xnio ChannelListeners invokeChannelListener ChannelListeners java 72      at org xnio channels TranslatingSuspendableChannel handleReadable TranslatingSuspendableChannel java 189      at org xnio channels TranslatingSuspendableChannel 1 handleEvent TranslatingSuspendableChannel java 103      at org xnio ChannelListeners invokeChannelListener ChannelListeners java 72      at org xnio channels TranslatingSuspendableChannel handleReadable TranslatingSuspendableChannel java 189      at org xnio ssl JsseConnectedSslStreamChannel handleReadable JsseConnectedSslStreamChannel java 183      at org xnio channels TranslatingSuspendableChannel 1 handleEvent TranslatingSuspendableChannel java 103      at org xnio ChannelListeners invokeChannelListener ChannelListeners java 72      at org xnio nio NioHandle run NioHandle java 90      at org xnio nio WorkerThread run WorkerThread java 198       main       at org jboss remoting3 remote RemoteConnectionChannel receiveMessage RemoteConnectionChannel java 361        waiting to lock &lt 0x00000007851ae6e0&gt   a java util ArrayDeque      at org jboss as protocol mgmt FutureManagementChannel Establishing connectionOpened FutureManagementChannel java 217      at org jboss as protocol ProtocolConnectionManager connect ProtocolConnectionManager java 78        locked &lt 0x0000000784978a00&gt   a org jboss as protocol ProtocolConnectionManager      at org jboss as protocol mgmt FutureManagementChannel Establishing getChannel FutureManagementChannel java 204      at org jboss as cli impl CLIModelControllerClient getOrCreateChannel CLIModelControllerClient java 160        locked &lt 0x0000000783433408&gt   a java lang String      at org jboss as cli impl CLIModelControllerClient 2 getChannel CLIModelControllerClient java 120      at org jboss as protocol mgmt ManagementChannelHandler executeRequest ManagementChannelHandler java 123      at org jboss as protocol mgmt ManagementChannelHandler executeRequest ManagementChannelHandler java 98      at org jboss as controller client impl AbstractModelControllerClient executeRequest AbstractModelControllerClient java 236      at org jboss as controller client impl AbstractModelControllerClient execute AbstractModelControllerClient java 141      at org jboss as controller client impl AbstractModelControllerClient executeForResult AbstractModelControllerClient java 127      at org jboss as controller client impl AbstractModelControllerClient execute AbstractModelControllerClient java 71      at org jboss as cli impl CommandContextImpl tryConnection CommandContextImpl java 980      at org jboss as cli impl CommandContextImpl connectController CommandContextImpl java 841      at org jboss as cli impl CommandContextImpl connectController CommandContextImpl java 817      at org jboss as cli impl CliLauncher initCommandContext CliLauncher java 282      at org jboss as cli impl CliLauncher main CliLauncher java 250      at org jboss as cli CommandLineMain main CommandLineMain java 34      at sun reflect NativeMethodAccessorImpl invoke0 Native Method      at sun reflect NativeMethodAccessorImpl invoke NativeMethodAccessorImpl java 62      at sun reflect DelegatingMethodAccessorImpl invoke DelegatingMethodAccessorImpl java 43      at java lang reflect Method invoke Method java 483      at org jboss modules Module run Module java 312      at org jboss modules Main main Main java 460        It can be easily reproduce with Eclipse as        1 start Wildfly     2 uncomment  JAVA_OPTS   JAVA_OPTS  agentlib jdwp transport dt_socket address 8787 server y suspend y  in jboss cli sh and connect to server     3 add two break points at     CLIModelControllerClient ChannelCloseHandler  line  285    handleClose Channel  IOException      RemoteConnectionChannel  line  360    receiveMessage Receiver      4 connect to 8787 from eclipse debug     5 shutdown Wildfly          A deadlock between  main  and  cli client  is in Eclipse debug stack
553	ModelControllerClientOperationHandler doesn t manage the clientRequestExecutor properly ModelControllerClientOperationHandler s constructor creates a ThreadPoolExecutor for handling client requests and then the class doesn t clean it up  In addition  an instance of ModelControllerClientOperationHandler is created per channel  not one per ModelControllerClientOperationHandlerFactoryService  I know I at least thought of the thread pool as being per remote management interface  not per channel  Making it be per ModelControllerClientOperationHandlerFactoryService and cleaning it up in that service s stop would be the easiest fix  but the pool settings may not be appropriate if we do that  so tread carefully
997	Security realm using ldaps hangs forever during SSL handshake  when ldap server is killedDuring failover testing we hit the problem of stuck thread  When ldap server is killed in particular time of ssl handshake EAP hangs and waits forever on response  which will never come  Causing thread to block forever  Same problem can be seen in LdapLoginModule using ldaps without specifying com sun jndi ldap connect timeout value  Possible solution is to add option to declare com sun jndi ldap connect timeout for security realm and provide some default non empty value  e g  15 seconds
1002	TransactionalProtocolOperationHandler AbortOperationHandler must initialize the ExecuteRequestContext before responding  If in a race a COMPLETE_TX_REQUEST cancelling an op is processed by a server slave HC before the original EXECUTE_TX_REQUEST is processed  when the EXECUTE_TX_REQUEST comes in the AbortOperationHandler attempts to respond with a  outcome  &gt  cancelled  response  This will fail because the ExecutionRequestContext will not be initialized  In this situation the AbortOperationHandler should initialize the ERC  With assertions enabled  this appears in the log     20 58 47 947 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  Exception in thread  Remoting  slave main three MANAGEMENT  task 6  java lang AssertionError      20 58 47 947 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as controller remote TransactionalProtocolOperationHandler ExecuteRequestContext failed TransactionalProtocolOperationHandler java 458      20 58 47 948 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as controller remote TransactionalProtocolOperationHandler AbortOperationHandler handleRequest TransactionalProtocolOperationHandler java 275     20 58 47 948 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 270           20 58 47 948 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 252           20 58 47 948 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 123           20 58 47 949 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as protocol mgmt ManagementChannelReceiver 1 handleMessage ManagementChannelReceiver java 56           20 58 47 949 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss as protocol mgmt ManagementChannelReceiver handleMessage ManagementChannelReceiver java 85           20 58 47 949 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss remoting3 remote RemoteConnectionChannel 5 run RemoteConnectionChannel java 451           20 58 47 949 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at org jboss remoting3 EndpointImpl TrackingExecutor 1 run EndpointImpl java 705           20 58 47 950 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at java util concurrent ThreadPoolExecutor runWorker ThreadPoolExecutor java 1142           20 58 47 950 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at java util concurrent ThreadPoolExecutor Worker run ThreadPoolExecutor java 617           20 58 47 950 ERROR  stderr   Remoting  slave main three MANAGEMENT  task 6  	at java lang Thread run Thread java 745    Without assertions  a few lines later a call to sendResponse will result in an NPE
1025	ManagementRequestContext executeAsync hides RejectedExecutionExceptionThe impl of ManagementRequestContext executeAsync catches RejectedExecutionException and doesn t notify the calling thread  The handling itself seems ok  call failed on the result handler and send a failure response to the client   but not notifying the caller is problematic  There are a number of cases where the caller thread waits for a latch to be tripped  with the async task tripping  If the latch never trips  the caller thread will block forever  The testsuite hang at http   brontes lab eng brq redhat com viewLog html buildId 71233&amp buildTypeId WildFlyCore_MasterLinux&amp tab buildLog _focus 13620 looks to be a case of this  with a server not stopping due to this              Remoting  master main one MANAGEMENT  task 13   55 prio 5 os_prio 0 tid 0xc6c3bc00 nid 0x19d9 waiting on condition  0xc215c000      java lang Thread State  WAITING  parking      at sun misc Unsafe park Native Method        parking to wait for  &lt 0xddbb4aa0&gt   a java util concurrent CountDownLatch Sync      at java util concurrent locks LockSupport park LockSupport java 175      at java util concurrent locks AbstractQueuedSynchronizer parkAndCheckInterrupt AbstractQueuedSynchronizer java 836      at java util concurrent locks AbstractQueuedSynchronizer doAcquireSharedInterruptibly AbstractQueuedSynchronizer java 997      at java util concurrent locks AbstractQueuedSynchronizer acquireSharedInterruptibly AbstractQueuedSynchronizer java 1304      at java util concurrent CountDownLatch await CountDownLatch java 231      at org jboss as controller remote TransactionalProtocolOperationHandler sendResponse TransactionalProtocolOperationHandler java 540      at org jboss as controller remote TransactionalProtocolOperationHandler ExecuteRequestContext failed TransactionalProtocolOperationHandler java 377        locked &lt 0xddbb2300&gt   a org jboss as controller remote TransactionalProtocolOperationHandler ExecuteRequestContext      at org jboss as protocol mgmt ActiveOperationSupport ActiveOperationImpl 2 handleFailed ActiveOperationSupport java 350      at org jboss threads AsyncFutureTask Reg run AsyncFutureTask java 60      at org jboss as protocol mgmt ActiveOperationSupport 1 execute ActiveOperationSupport java 55      at org jboss threads AsyncFutureTask safeExecute AsyncFutureTask java 169      at org jboss threads AsyncFutureTask setFailed AsyncFutureTask java 162      at org jboss as protocol mgmt ActiveOperationSupport ActiveOperationImpl access 400 ActiveOperationSupport java 295      at org jboss as protocol mgmt ActiveOperationSupport ActiveOperationImpl 1 failed ActiveOperationSupport java 315      at org jboss as protocol mgmt AbstractMessageHandler 2 executeAsync AbstractMessageHandler java 333      at org jboss as protocol mgmt AbstractMessageHandler 2 executeAsync AbstractMessageHandler java 315      at org jboss as controller remote TransactionalProtocolOperationHandler ExecuteRequestHandler handleRequest TransactionalProtocolOperationHandler java 144      at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 270      at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 252      at org jboss as protocol mgmt AbstractMessageHandler handleMessage AbstractMessageHandler java 123      at org jboss as protocol mgmt ManagementChannelReceiver 1 handleMessage ManagementChannelReceiver java 56      at org jboss as protocol mgmt ManagementChannelReceiver handleMessage ManagementChannelReceiver java 85      at org jboss remoting3 remote RemoteConnectionChannel 5 run RemoteConnectionChannel java 463      at java util concurrent ThreadPoolExecutor runWorker ThreadPoolExecutor java 1142      at java util concurrent ThreadPoolExecutor Worker run ThreadPoolExecutor java 617      at java lang Thread run Thread java 745        The RejectedExecutionException indicates a thread pool has been shutdown before the response has gone out  Ideally we would prevent that  for which I&amp apos ve recently filed a JIRA  but in any case we should make this more robust  I think having executeAsync return a boolean should suffice