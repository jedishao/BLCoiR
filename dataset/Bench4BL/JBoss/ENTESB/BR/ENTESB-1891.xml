<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 22:47:03 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/ENTESB-1891/ENTESB-1891.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[ENTESB-1891] Duplicate domain environment variables when creating 20 containers at the same time</title>
                <link>https://issues.jboss.org/browse/ENTESB-1891</link>
                <project id="12314570" key="ENTESB">JBoss Fuse</project>
                    <description>&lt;p&gt;After creating 20 containers at the same time, check mongo database. There&apos;ll be several duplicate domain env variable which will affect container&apos;s function.&lt;br/&gt;
env_vars&quot; : [&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_CONSOLE_URL&quot;,
			&quot;value&quot; : &quot;https://fuse-fuse.fuse-blade.com&quot;,
			&quot;component_id&quot; : ObjectId(&quot;5408047d064c34489f000ac6&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_DNS&quot;,
			&quot;value&quot; : &quot;test12-fuse.fuse-blade.com&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806c6064c34b3b000454c&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_SSH_PORT&quot;,
			&quot;value&quot; : &quot;23101&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806c6064c34b3b000454c&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_ZOOKEEPER_URL&quot;,
			&quot;value&quot; : &quot;fuse-fuse.fuse-blade.com:53921&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806c6064c34b3b000454c&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_PASSWORD&quot;,
			&quot;value&quot; : &quot;redhat&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806c6064c34b3b000454c&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_DNS&quot;,
			&quot;value&quot; : &quot;test14-fuse.fuse-blade.com&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806cc064c34232b00009e&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_SSH_PORT&quot;,
			&quot;value&quot; : &quot;23101&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806cc064c34232b00009e&quot;)
		}
&lt;p&gt;,&lt;br/&gt;
		&lt;/p&gt;
{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_ZOOKEEPER_URL&quot;,
			&quot;value&quot; : &quot;fuse-fuse.fuse-blade.com:53921&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806cc064c34232b00009e&quot;)
		}
&lt;p&gt;,&lt;/p&gt;
		{
			&quot;key&quot; : &quot;OPENSHIFT_FUSE_DOMAIN_PASSWORD&quot;,
			&quot;value&quot; : &quot;redhat&quot;,
			&quot;component_id&quot; : ObjectId(&quot;540806cc064c34232b00009e&quot;)
		}
&lt;p&gt;	],&lt;/p&gt;</description>
                <environment></environment>
        <key id="12551058">ENTESB-1891</key>
            <summary>Duplicate domain environment variables when creating 20 containers at the same time</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.jboss.org/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.jboss.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="xuanjia">Xuan Jia</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Sep 2014 02:54:40 -0400</created>
                <updated>Tue, 16 Sep 2014 22:17:46 -0400</updated>
                            <resolved>Tue, 16 Sep 2014 22:17:46 -0400</resolved>
                                    <version>jboss-fuse-6.1 on OSE</version>
                                                    <component>OpenShift</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="12998682" author="xuanjia" created="Thu, 4 Sep 2014 02:59:11 -0400"  >&lt;p&gt;I think this maybe a reason why fail to create containers. &lt;/p&gt;</comment>
                            <comment id="12999261" author="aileenc" created="Fri, 5 Sep 2014 05:51:45 -0400"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=bparees&quot; class=&quot;user-hover&quot; rel=&quot;bparees&quot;&gt;Ben Parees&lt;/a&gt; Can you comment on this one? You mentioned at Fuse PM meeting that we may not be able to do anything about this in which case it needs to be documented as a restriction.&lt;/p&gt;</comment>
                            <comment id="12999526" author="bparees" created="Fri, 5 Sep 2014 14:16:17 -0400"  >&lt;p&gt;I&apos;m investigating adding a feature to openshift to address this race condition, the PR is here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/openshift/origin-server/pull/5787&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/openshift/origin-server/pull/5787&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Assuming it gets accepted and ported down to OSE, we&apos;ll then have to update the cartridges to use the new add_domain_env_var_unique method instead of the current add_domain_env_var method.&lt;/p&gt;</comment>
                            <comment id="13000130" author="xuanjia" created="Tue, 9 Sep 2014 01:06:04 -0400"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=bparees&quot; class=&quot;user-hover&quot; rel=&quot;bparees&quot;&gt;Ben Parees&lt;/a&gt; : i have merged the code into my local test env. It works(include using add_domain_env_var_unique method). No duplicate domain variables are generated. &lt;br/&gt;
But all of 20 containers are deleted at last. What i want is that all the container are created successfully and can be able to work properly. Could you analyze this issue?&lt;br/&gt;
And another question is that the new created container knows its role is &apos;managed container&apos; , why it keeps adding these domain environment variable?&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="13000351" author="bparees" created="Tue, 9 Sep 2014 09:33:48 -0400"  >&lt;p&gt;Yes unfortunately the only way to handle the duplicate env variable creation scenario is by rejecting the creation of the additional applications, so that is what I did.  The timing and logic of the cartridge and how domain env variables are created is such that no other possibility exists.&lt;/p&gt;

&lt;p&gt;I don&apos;t follow your second statement that the new created container &quot;knows its role is manage container&quot;..  are you referring to the profile you selected when creating the container from within the Fabric UI?&lt;/p&gt;

&lt;p&gt;The cartridge decides whether to create the domain env variables or not based on whether they already existed when the cartridge install began.  If the variables did not exist, then it doesn&apos;t matter what the &quot;role&quot; is, because it needs to create those variables so it has a ZK location.  The scenario you&apos;re getting into is a timing condition in which another app is creating them, but they aren&apos;t yet available to the secondary app.  Again unfortunately there is no way for the secondary app to &quot;wait&quot; for the first app to finish create the variables, essentially this is an optimistic lock scenario in which the two operations encounter a write collision and the first one must win and the second one must be rolled back.&lt;/p&gt;</comment>
                            <comment id="13000750" author="maschmid" created="Wed, 10 Sep 2014 06:29:26 -0400"  >&lt;p&gt;This may be related to &lt;a href=&quot;https://issues.jboss.org/browse/ENTESB-1929&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.jboss.org/browse/ENTESB-1929&lt;/a&gt;  I believe the properties should not have been set by all the other containers in the first place.&lt;/p&gt;</comment>
                            <comment id="13000766" author="xuanjia" created="Wed, 10 Sep 2014 07:03:43 -0400"  >&lt;p&gt;It&apos;s not customer expects when he wants to create 20 containers, but none of them are created at last. Customer has to create one and wait it works, then create the next one.. Could we find another solution ? Such as using a queue to save &apos;create&apos; request. &lt;/p&gt;</comment>
                            <comment id="13000851" author="bparees" created="Wed, 10 Sep 2014 09:34:04 -0400"  >&lt;p&gt;One of the 20 should be successfully created, is that not happening?&lt;/p&gt;

&lt;p&gt;Queuing the requests is a much more complicated solution that OSE is not going to pursue in this timeframe.&lt;/p&gt;</comment>
                            <comment id="13000855" author="bparees" created="Wed, 10 Sep 2014 09:37:52 -0400"  >&lt;p&gt;Also this only occurs when creating the first app, correct?  If you create a single app (the master), you can then subsequently create as many apps simultaneously as you want.&lt;/p&gt;</comment>
                            <comment id="13002984" author="aileenc" created="Tue, 16 Sep 2014 11:36:10 -0400"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=xuanjia&quot; class=&quot;user-hover&quot; rel=&quot;xuanjia&quot;&gt;Xuan Jia&lt;/a&gt; Can you answer these questions from Ben?&lt;/p&gt;</comment>
                            <comment id="13003043" author="xuanjia" created="Tue, 16 Sep 2014 12:57:06 -0400"  >&lt;p&gt;Sorry, i miss this question. &lt;br/&gt;
Unfortunately none of the 20 containers are created at the end. This issue occurs when use creates more than 3  containers from Hawtio at the same time.(It provides the option &apos;Number of containers&apos; to create more than 1 container at one time).&lt;br/&gt;
I am wondering if now we are talking about a performance issue. Too many containers are trying to connect to fabric server, but get the wrong response or wait too long time, then openshift delete these containers at last.&lt;/p&gt;</comment>
                            <comment id="13003044" author="bparees" created="Tue, 16 Sep 2014 13:00:46 -0400"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=xuanjia&quot; class=&quot;user-hover&quot; rel=&quot;xuanjia&quot;&gt;Xuan Jia&lt;/a&gt; ok so you&apos;re no longer seeing the duplicate domain env variable issue specifically, just a general failure?  Can you open a new JIRA that describes the scenario and result?  It sounds like perhaps we can close this one.&lt;/p&gt;</comment>
                            <comment id="13003273" author="xuanjia" created="Tue, 16 Sep 2014 22:17:46 -0400"  >&lt;p&gt;Now we don&apos;t have duplicate domain env when creating 20 containers at the same time.&lt;br/&gt;
Version: OpenShiftEnterpriseErrata/2.1.z/2014-09-12.1/&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310001">
                    <name>Related</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12550679">ENTESB-1877</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzt37j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12310183" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Steps to Reproduce</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;1. Create a fuse app named fuse&lt;br/&gt;
2. on FWC, create 20 containers at the same time&lt;br/&gt;
3. check mongodb database.&lt;br/&gt;
 -&amp;gt;db.domains.find().pretty()&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>