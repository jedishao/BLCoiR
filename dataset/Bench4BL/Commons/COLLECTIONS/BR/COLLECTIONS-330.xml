<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Nov 19 23:20:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/COLLECTIONS-330/COLLECTIONS-330.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[COLLECTIONS-330] ConcurrentModificationException using remove from the keySet the LRUMap</title>
                <link>https://issues.apache.org/jira/browse/COLLECTIONS-330</link>
                <project id="12310465" key="COLLECTIONS">Commons Collections</project>
                    <description>&lt;p&gt;Even if the access to a LRUMap is synced and the remove method of the iterator is used that has been returned from the keySet of the LRUMap, it is possible to get a ConcurrentModificationException. This does not happen for remove of the iterators returned by the entrySet or values of the LRUMap. See currently not executed unit test in TestLRUMap (marked as TODO for COLLECTION-3).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12428092">COLLECTIONS-330</key>
            <summary>ConcurrentModificationException using remove from the keySet the LRUMap</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="joehni">Joerg Schaible</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Jun 2009 09:52:58 +0000</created>
                <updated>Sun, 9 Nov 2014 14:31:38 +0000</updated>
                            <resolved>Mon, 21 Feb 2011 19:17:52 +0000</resolved>
                                                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Collection</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12720960" author="joehni" created="Wed, 17 Jun 2009 22:41:25 +0000"  >&lt;p&gt;Actually &quot;remove&quot; from the MapIterator does not work either.&lt;/p&gt;</comment>
                            <comment id="12720974" author="sebb@apache.org" created="Wed, 17 Jun 2009 23:07:00 +0000"  >&lt;p&gt;It works for me - but there needs to be an iter.next() before the map.get(iter.getValue()).&lt;/p&gt;</comment>
                            <comment id="12721091" author="joehni" created="Thu, 18 Jun 2009 06:37:41 +0000"  >&lt;p&gt;Thanks for heads-up. I &quot;fixed&quot; the invalid test, but it fails for me still. You did recognize that you have to rename the two tests with the TODO comment to get them running as unit test?&lt;/p&gt;</comment>
                            <comment id="12721177" author="sebb@apache.org" created="Thu, 18 Jun 2009 10:46:40 +0000"  >&lt;p&gt;Your fix was different from mine - I just added iter.next(), so the code became:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
iter.next();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map.get(iter.getValue()) == &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
     iter.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which works fine.&lt;/p&gt;

&lt;p&gt;However the current code is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)iter.next();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map.get(name) == &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
    iter.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which fails.&lt;/p&gt;</comment>
                            <comment id="12721235" author="sebb@apache.org" created="Thu, 18 Jun 2009 12:50:50 +0000"  >&lt;p&gt;Note that this does not appear to be a threading issue - the testSynchronizedRemoveFromMapIterator test fails even with only one thread. Similarly for testSynchronizedRemoveFromKeySet.&lt;/p&gt;

&lt;p&gt;Perhaps there should be separate single-threaded tests - or at least, the tests should check a single thread first before attempting multiple threads.&lt;/p&gt;

&lt;p&gt;BTW, I added some detail to the ConcurrentModificationException, this shows that the check that is failing is 1001!=1000 (single thread test)&lt;br/&gt;
i.e. the expectedModCount is one less than the parent.modCount. Looks like one of the methods is not updating expectedModCount correctly.&lt;/p&gt;</comment>
                            <comment id="12721254" author="sebb@apache.org" created="Thu, 18 Jun 2009 13:20:18 +0000"  >&lt;p&gt;Also, the tests both still fail even if the iter.remove() call is commented out, but they then fail on the iter.next().&lt;/p&gt;

&lt;p&gt;If the map.get() call is commented out, leaving just iter.remove(), the test works fine in single-threaded and multi-threaded mode.&lt;/p&gt;

&lt;p&gt;Looks like the get() is not maintaining expectedModCount.&lt;/p&gt;</comment>
                            <comment id="12721287" author="sebb@apache.org" created="Thu, 18 Jun 2009 14:57:26 +0000"  >&lt;p&gt;The test testSynchronizedRemoveFromEntrySet also fails if one adds the following to the iterator loop:&lt;/p&gt;

&lt;p&gt;map.get(entry.getKey());&lt;/p&gt;

&lt;p&gt;The problem is that get() has side effects.&lt;/p&gt;</comment>
                            <comment id="12993271" author="mbenson" created="Thu, 10 Feb 2011 23:46:16 +0000"  >&lt;p&gt;Correct, but the contract of the map permits this, as iteration order is based on RU concerns.  Calling &lt;tt&gt;get()&lt;/tt&gt; restructures the underlying data because the current entry becomes the LRU entry and so the map is modified.  The answer, therefore, is not to call get() when testing iterator behavior per the contract of the map.  Commit forthcoming.&lt;/p&gt;</comment>
                            <comment id="12997588" author="mbenson" created="Mon, 21 Feb 2011 22:16:33 +0000"  >&lt;p&gt;resolved with svn r#1069618&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12341922">COLLECTIONS-3</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Jun 2009 23:07:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18673</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0si3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164411</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>