<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun Nov 20 00:52:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/COLLECTIONS-474/COLLECTIONS-474.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[COLLECTIONS-474] Exception in ListOrderedMap#putAll if map contains null values</title>
                <link>https://issues.apache.org/jira/browse/COLLECTIONS-474</link>
                <project id="12310465" key="COLLECTIONS">Commons Collections</project>
                    <description>&lt;p&gt;Dear apache developers, thanks for the great project. Recently, I encountered an IndexOutOfBoundsException in ListOrderedMap in the latest revision (r1495998) with the crash stack trace: &lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.IndexOutOfBoundsException: Index: 2, Size: 1&lt;br/&gt;
	at java.util.ArrayList.add(ArrayList.java:367)&lt;br/&gt;
	at org.apache.commons.collections4.map.ListOrderedMap.put(ListOrderedMap.java:448)&lt;br/&gt;
	at org.apache.commons.collections4.map.ListOrderedMap.putAll(ListOrderedMap.java:246)&lt;br/&gt;
	at Test.main(Test.java:15)&lt;/p&gt;

&lt;p&gt;I&apos;ve also attached a test case that can reproduce this crash.&lt;/p&gt;

&lt;p&gt;I think this test case actually reveals the bug reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/COLLECTIONS-411&quot; title=&quot;Exception in ListOrderedMap.putAll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;COLLECTIONS-411&quot;&gt;&lt;del&gt;COLLECTIONS-411&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/COLLECTIONS-411&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/COLLECTIONS-411&lt;/a&gt;). However, it seems that the original patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/COLLECTIONS-411&quot; title=&quot;Exception in ListOrderedMap.putAll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;COLLECTIONS-411&quot;&gt;&lt;del&gt;COLLECTIONS-411&lt;/del&gt;&lt;/a&gt; missed a corner case.&lt;/p&gt;

&lt;p&gt;Could you please check if this is indeed a bug? Thanks!&lt;/p&gt;</description>
                <environment>&lt;p&gt;java 1.7.0_09&lt;/p&gt;</environment>
        <key id="12654559">COLLECTIONS-474</key>
            <summary>Exception in ListOrderedMap#putAll if map contains null values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cning">Ning Chen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Jun 2013 18:22:54 +0000</created>
                <updated>Sun, 9 Nov 2014 14:31:25 +0000</updated>
                            <resolved>Sun, 30 Jun 2013 20:10:32 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Map</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13692251" author="tn" created="Mon, 24 Jun 2013 18:55:12 +0000"  >&lt;p&gt;Thanks for the report.&lt;/p&gt;

&lt;p&gt;The putAll javadoc does not mention it explicitly, but the provided index has to be in range (see javadoc for put(int, Object, Object)) otherwise an IndexOutOfBoundsException will be thrown. So the behavior is actually correct, but the javadoc should be updated.&lt;/p&gt;</comment>
                            <comment id="13692257" author="sebb@apache.org" created="Mon, 24 Jun 2013 18:59:13 +0000"  >&lt;p&gt;Looks like a bug to me, because the size() is 2 just before the putAll().&lt;/p&gt;

&lt;p&gt;The problem is that the code assumes that the put method will only return null if the key was not replaced; however that is only true if the original value was not null. For maps that allow null, the return value of put cannot be used to determine if the key was replaced.&lt;/p&gt;</comment>
                            <comment id="13692264" author="tn" created="Mon, 24 Jun 2013 19:06:06 +0000"  >&lt;p&gt;Inserting with an index &amp;gt;= size() usually does not work in list-based collections, so I think the behavior is correct.&lt;br/&gt;
What worries me more is that the exception in put is thrown &lt;b&gt;after&lt;/b&gt; the collection has been modified, leaving it in an inconsistent state.&lt;/p&gt;

&lt;p&gt;We should check the index first and throw the exception if it is out-of-range.&lt;/p&gt;</comment>
                            <comment id="13692281" author="sebb@apache.org" created="Mon, 24 Jun 2013 19:20:56 +0000"  >&lt;p&gt;I&apos;ve just added two tests - one uses null values (as per the issue description) and the other uses non-null values.&lt;/p&gt;

&lt;p&gt;Only the null value test fails, so I think there is a bug; easy to fix.&lt;br/&gt;
Just replace&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; V old = put(index, entry.getKey(), entry.getValue());
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (old == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; contains = containsKey(entry.getKey());
put(index, entry.getKey(), entry.getValue());
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!contains) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13692291" author="tn" created="Mon, 24 Jun 2013 19:32:19 +0000"  >&lt;p&gt;Ok agree, we can fix this in the next RC if one is needed, or for alpha2.&lt;/p&gt;</comment>
                            <comment id="13692299" author="cning" created="Mon, 24 Jun 2013 19:39:39 +0000"  >&lt;p&gt;Wow! Thanks for the quick responses! &lt;/p&gt;

&lt;p&gt;Just to make sure, after applying the patch, is the &quot;index == size&quot; case considered in-range (no exception raised)? &lt;/p&gt;

&lt;p&gt;FYI, it is also possible to reproduce the exception even when &quot;index &amp;lt; size&quot;: &lt;br/&gt;
    Object key1 = new Object();&lt;br/&gt;
    Object key2 = new Object();&lt;br/&gt;
    Object key3 = new Object();&lt;br/&gt;
    HashMap&amp;lt;Object, Object&amp;gt; map = new HashMap&amp;lt;Object, Object&amp;gt;();&lt;br/&gt;
    map.put(key1, null);&lt;br/&gt;
    map.put(key2, null);&lt;br/&gt;
    map.put(key3, null);&lt;/p&gt;

&lt;p&gt;    ListOrderedMap&amp;lt;Object, Object&amp;gt; listMap = new ListOrderedMap&amp;lt;Object, Object&amp;gt;();&lt;br/&gt;
    listMap.put(key1, null);&lt;br/&gt;
    listMap.put(key2, null);&lt;br/&gt;
    listMap.put(key3, null);&lt;br/&gt;
    listMap.putAll(2, map);&lt;/p&gt;</comment>
                            <comment id="13692300" author="tn" created="Mon, 24 Jun 2013 19:42:13 +0000"  >&lt;p&gt;Looking at List.add(int, Object), the supported range is index &amp;gt;= 0 &amp;amp;&amp;amp; index &amp;lt;= size(), so I guess we should do the same here.&lt;/p&gt;</comment>
                            <comment id="13692308" author="sebb@apache.org" created="Mon, 24 Jun 2013 19:53:01 +0000"  >&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/r1496182&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/r1496182&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/COLLECTIONS-474&quot; title=&quot;Exception in ListOrderedMap#putAll if map contains null values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;COLLECTIONS-474&quot;&gt;&lt;del&gt;COLLECTIONS-474&lt;/del&gt;&lt;/a&gt; Exception in ListOrderedMap#putAll if map contains null values&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/collections/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/collections/trunk/src/main/java/org/apache/commons/collections4/map/ListOrderedMap.java&lt;/p&gt;</comment>
                            <comment id="13692315" author="sebb@apache.org" created="Mon, 24 Jun 2013 19:58:39 +0000"  >&lt;p&gt;putAll calls put before it changes anything, so I think we can leave the index check to the put method.&lt;/p&gt;</comment>
                            <comment id="13696405" author="tn" created="Sun, 30 Jun 2013 20:10:32 +0000"  >&lt;p&gt;Will be part of 4.0-alpha1 RC2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12589457" name="Test.java" size="536" author="cning" created="Mon, 24 Jun 2013 18:23:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 24 Jun 2013 18:55:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334836</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lrbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>335160</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>