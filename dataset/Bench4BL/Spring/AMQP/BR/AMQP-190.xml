<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 10:51:37 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/AMQP-190/AMQP-190.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[AMQP-190] CachingConnectionFactory leaks channels when synchronized with a TransactionManager</title>
                <link>https://jira.spring.io/browse/AMQP-190</link>
                <project id="10450" key="AMQP">Spring AMQP</project>
                    <description>&lt;p&gt;It seems that when I use RabbitTemplate, &lt;b&gt;channelTransacted=true&lt;/b&gt;, to &lt;tt&gt;convertAndSend()&lt;/tt&gt; a message to an exchange within the context of a &lt;b&gt;synchronized&lt;/b&gt; TransactionManager (e.g. an active transaction on the current thread), the channel is never closed, hence new publishes will always get their &quot;own&quot;, shiny, new channel (that is never closed or released to the channel pool) until Rabbit can&apos;t handle any more channels.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://forum.springsource.org/showthread.php?114411-CachingConnectionFactory-leaks-channels-in-when-synchronized-with-a-transaction&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Forum Reference&lt;/a&gt; for more info.&lt;/p&gt;

&lt;p&gt;The problem is not observed on the consumer side (e.g. MessageListenerContainer).  Its observed on the publishing side, (e.g. RabbitTemplate).  It is observed both if I use the RabbitTemplate, natively... or if I use spring-integration and the &amp;lt;int-amqp:outbound-channel-adapter...&amp;gt; tag.&lt;/p&gt;

&lt;p&gt;BTW, the observed &quot;channel leak&quot; goes away when I choose &lt;b&gt;channelTransacted=false&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;I will look to supply a simple recreate, if I can scrounge the time.&lt;/p&gt;</description>
                <environment></environment>
        <key id="39702">AMQP-190</key>
            <summary>CachingConnectionFactory leaks channels when synchronized with a TransactionManager</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Complete</resolution>
                                        <assignee username="grussell">Gary Russell</assignee>
                                    <reporter username="rparra">Rene Parra</reporter>
                        <labels>
                            <label>spring-amqp</label>
                    </labels>
                <created>Sat, 10 Sep 2011 20:24:17 +0000</created>
                <updated>Thu, 23 Aug 2012 14:56:27 +0000</updated>
                            <resolved>Wed, 18 Jul 2012 08:51:03 +0000</resolved>
                                    <version>1.0.0 GA</version>
                                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>1.2.0.M1</fixVersion>
                                    <component>RabbitMQ</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <timeoriginalestimate seconds="0">0d</timeoriginalestimate>
                            <timeestimate seconds="0">0d</timeestimate>
                                        <comments>
                            <comment id="70328" author="david_syer" created="Sun, 11 Sep 2011 04:24:11 +0000"  >&lt;p&gt;A short term workaround might be to call CachingConnectionFactory.reset() from time to time (not every transaction, otherwise you lose the benefit of the cache).&lt;/p&gt;</comment>
                            <comment id="70333" author="david_syer" created="Sun, 11 Sep 2011 09:05:17 +0000"  >&lt;p&gt;I fixed this by adding a call to set the resource holder&apos;s transaction synch flag before releasing its resources.  It might be tough to automate a test for this (suggestions welcome), but I verified manually that the channels on the broker are bounded using RabbitTemplatePerformanceIntegrationTests.&lt;/p&gt;</comment>
                            <comment id="70334" author="rparra" created="Sun, 11 Sep 2011 14:50:15 +0000"  >&lt;p&gt;Dave, I&apos;ve got a repro over on &lt;a href=&quot;https://github.com/neoword/amqp190&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/neoword/amqp190&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let me check out the master on SpringSource/spring-amqp, and see if that fixes it.&lt;/p&gt;</comment>
                            <comment id="70335" author="rparra" created="Sun, 11 Sep 2011 14:52:45 +0000"  >&lt;p&gt;In particular, take a look at [ Amqp190Test.java|https://github.com/neoword/amqp190/blob/master/src/test/java/org/springframework/amqp/amqp190/Amqp190Test.java]&lt;/p&gt;</comment>
                            <comment id="70337" author="rparra" created="Sun, 11 Sep 2011 15:19:29 +0000"  >&lt;p&gt;Looks like if you uncomment that line, it fixes it! I&apos;ll experiment with the workaround until 1.0.1 is out.  Thanks for the quick turnaround!&lt;/p&gt;</comment>
                            <comment id="70338" author="rparra" created="Sun, 11 Sep 2011 15:33:20 +0000"  >&lt;p&gt;CachingConnectionFactory.reset() is protected.&lt;/p&gt;</comment>
                            <comment id="70355" author="david_syer" created="Mon, 12 Sep 2011 05:51:37 +0000"  >&lt;p&gt;I&apos;m not sure which line you are uncommenting.  Does the fix I proposed work for you or not?&lt;/p&gt;

&lt;p&gt;Sorry about the protected method - you will have to extend to expose it publicly I guess.&lt;/p&gt;</comment>
                            <comment id="70362" author="rparra" created="Mon, 12 Sep 2011 08:08:37 +0000"  >&lt;p&gt;Yes. The fix works.&lt;/p&gt;

&lt;p&gt;The commented line I am referring to is this one:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://fisheye.springsource.org/browse/spring-amqp/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/connection/ConnectionFactoryUtils.java?r=7538a6072b2a0f9668ab5981bcdaadd1719e9132#to253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://fisheye.springsource.org/browse/spring-amqp/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/connection/ConnectionFactoryUtils.java?r=7538a6072b2a0f9668ab5981bcdaadd1719e9132#to253&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If this is uncommented, it works.&lt;/p&gt;</comment>
                            <comment id="70364" author="rparra" created="Mon, 12 Sep 2011 08:11:07 +0000"  >&lt;p&gt;For the workaround, I am using an @Aspect.&lt;/p&gt;

&lt;p/&gt;
&lt;div id=&quot;syntaxplugin&quot; class=&quot;syntaxplugin&quot; style=&quot;border: 1px dashed #bbb; border-radius: 5px !important; overflow: auto; max-height: 30em;&quot;&gt;
&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot; style=&quot;font-size: 1em; line-height: 1.4em !important; font-weight: normal; font-style: normal; color: black;&quot;&gt;
		&lt;tbody &gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;  margin-top: 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;/**&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; * Aspect for patching ConnectionFactoryUtils so that channels are not leaked within the context of a transaction&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; * @author Ren&#233; X. Parra&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; */&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;@Aspect&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;public class AMQP190Patch {&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;    @Around(value=&quot;execution(void org.springframework.amqp.rabbit.connection..*.afterCompletion(..))&quot;, argNames=&quot;pjp&quot;)&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;    public void patchAmqp190(ProceedingJoinPoint pjp) throws Throwable {&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        Field field = FieldUtils.getField(pjp.getTarget().getClass(), &quot;resourceHolder&quot;, true);&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        RabbitResourceHolder resourceHolder = (RabbitResourceHolder) field.get(pjp.getTarget()); &lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        resourceHolder.setSynchronizedWithTransaction(false);&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;        pjp.proceed();&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;    }&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   margin-bottom: 10px;  width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
			&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p/&gt;


&lt;p&gt;Thanks again Dave!!!&lt;/p&gt;</comment>
                            <comment id="81700" author="grussell" created="Fri, 13 Jul 2012 14:08:54 +0000"  >&lt;p&gt;Still an issue; see&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/SpringSource/spring-amqp/commit/7538a6072b2a0f9668ab5981bcdaadd1719e9132#commitcomment-1413088&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/SpringSource/spring-amqp/commit/7538a6072b2a0f9668ab5981bcdaadd1719e9132#commitcomment-1413088&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I repro&apos;d the issue with a mock test; when running in a tx, the channel is not returned to the pool.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 11 Sep 2011 04:24:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01053:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5900</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7054</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10120" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>Reference URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://forum.springsource.org/showthread.php?114411-CachingConnectionFactory-leaks-channels-in-when-synchronized-with-a-transaction]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>