<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 10:51:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SEC-547/SEC-547.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SEC-547] acls BasicLookupStrategy user too many (&gt; 1) databasse connections</title>
                <link>https://jira.spring.io/browse/SEC-547</link>
                <project id="10040" key="SEC">Spring Security</project>
                    <description>&lt;p&gt;BasicLookupStrategy opens an additional connection to the database for each ACL level of ACL parent that needs to be retrieved from the database.&lt;/p&gt;

&lt;p&gt;The error is in the private inner class ProcessResultSet (implements ResultSetExtractor) in the method extractData(ResultSet), at the end of the method&lt;/p&gt;

&lt;p&gt;// Lookup parents, adding Acls (with StubAclParents) to &quot;acl&quot; map&lt;br/&gt;
if (parentIdsToLookup.size() &amp;gt; 0) {&lt;br/&gt;
    lookupPrimaryKeys(acls, parentIdsToLookup, sids);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;lookupPrimaryKeys(acls, parentIdsToLookup, sids); creates another ProcessResultSet which as per Spring JDBC template classes grabs another connection to the database.  In a round about way this recursively uses one database connection per ACL -&amp;gt; parent ACL relationship to be looked up.&lt;/p&gt;

&lt;p&gt;In our case we have some test data where we have an ACL with a hierarchy of 16 parents, so for each level of the hierarchy a new connection to the DB is used  Our test set up had only 10 connections in the pool, which is how we found it.&lt;/p&gt;

&lt;p&gt;I&apos;m currently trying to fix this, as it&apos;s causing us problems.  As part of the fix I&apos;m writing some unit tests for BasicLookupStrategy (as there currently are none), not sure if I&apos;ll be able to get DB connection checking usage into the unit tests, but will investigate.&lt;/p&gt;

&lt;p&gt;I&apos;ll add my fixes to this Issue when they are ready.&lt;/p&gt;

&lt;p&gt;This issue should probably be added to &lt;br/&gt;
&lt;a href=&quot;http://opensource.atlassian.com/projects/spring/browse/SEC-532&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://opensource.atlassian.com/projects/spring/browse/SEC-532&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Ubuntu Linux (kernel 2.6.20-16-generic)&lt;br/&gt;
java 6 </environment>
        <key id="17838">SEC-547</key>
            <summary>acls BasicLookupStrategy user too many (&gt; 1) databasse connections</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="balex">Ben Alex</assignee>
                                    <reporter username="svanders">Simon van der Sluis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Sep 2007 09:28:42 +0000</created>
                <updated>Sat, 6 Feb 2016 06:33:43 +0000</updated>
                            <resolved>Fri, 9 Oct 2009 10:30:25 +0000</resolved>
                                    <version>1.0.3</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>ACLs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="25942" author="svanders" created="Mon, 3 Sep 2007 12:48:45 +0000"  >&lt;p&gt;I&apos;ve made some changes to the BasicLookupStrategy.  The recursive lookup for primary keys of parent ACLs has been moved out of ProcessResultSetMap#extractData(...) method, into lookupPrimaryKeys(...) itself, and lookupObjectIdentities(...) has been modified to call lookupPrimaryKeys(...)  if needed.  To allow this, ProcessResultSetMap#extractData(...) now returns a Set containing the parentIdsToLookup.&lt;/p&gt;

&lt;p&gt;These changes mean that JdbcTemplate can close the result set and connection (thus returning it to the pool) before the next recursion.  Previously it would start the recursion before JdbcTemplate was finished, and require as many concurrent connections as there were ACL parent relationships.&lt;/p&gt;

&lt;p&gt;Changed files will be attached.&lt;/p&gt;

&lt;p&gt;NOTE: To make the unit test be able to clear the ACL cache I had to split the AclCache configuration into 2 beans, 1 being the AclCache, the other being the underlying ehCache that needs to be cleared (emptied) during the test, so I&apos;ve also attached the modified application context xml, which comes from core/src/test/resources//org/acegisecurity/acls/jdbc/applicationContext-test.xml&lt;/p&gt;

&lt;p&gt;Also I didn&apos;t have time to think how / if the unit tests could be modified to monitor how many concurrent database connections are made at any one time.&lt;/p&gt;
</comment>
                            <comment id="25943" author="svanders" created="Mon, 3 Sep 2007 12:51:30 +0000"  >&lt;p&gt;There are also some additional depency injectable properties in BasicLookupStrategy, these are from an unfinished attempt to make the id method / data type of domain objects protected by ACLs configurable.  This is unfinished, but the default values are getId with data type Long, as per the 1.0.3 release version, so the changes will (should) have no effect.&lt;/p&gt;</comment>
                            <comment id="25944" author="svanders" created="Mon, 3 Sep 2007 12:53:48 +0000"  >&lt;p&gt;BasicLookupStrategy contained recursive parent acl lookup bug fix for concurrent DB connections.&lt;/p&gt;</comment>
                            <comment id="25945" author="svanders" created="Mon, 3 Sep 2007 12:55:09 +0000"  >&lt;p&gt;BasicLookupStrategy unit tests for recursive parent acl lookup bug fix for concurrent DB connections.&lt;/p&gt;

&lt;p&gt;Simply checks that parent are still looked up correctly&lt;/p&gt;</comment>
                            <comment id="25946" author="svanders" created="Mon, 3 Sep 2007 12:57:14 +0000"  >&lt;p&gt;modified application context for LookupStrategyTest.  has AclCache bean config split into two, to provide the ability to clear (empty) the underlying ehCache.&lt;/p&gt;</comment>
                            <comment id="34392" author="balex" created="Sat, 5 Apr 2008 08:21:08 +0000"  >&lt;p&gt;Modified BasicLookupStrategy to operate as per the patch, namely the ProcessResultSet.extractData(ResultSet) methods now returns a Set of AclIds that still remain to be looked up. The caller is then responsible for looking up those AclIds.&lt;/p&gt;

&lt;p&gt;Tests did not require modification, and still pass.&lt;/p&gt;

&lt;p&gt;SVN commit revision 2873.&lt;/p&gt;</comment>
                            <comment id="47365" author="luke" created="Fri, 9 Oct 2009 09:53:26 +0000"  >&lt;p&gt;Reopening to remove watchers because of spammer...&lt;/p&gt;</comment>
                            <comment id="126535" author="issuemaster" created="Sat, 6 Feb 2016 06:33:43 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/spring-projects/spring-security/issues/807&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/spring-projects/spring-security/issues/807&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10011">
                    <name>Depends</name>
                                                                <inwardlinks description="is depended on by">
                                        <issuelink>
            <issuekey id="18404">SEC-590</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="17737">SEC-532</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12875" name="BasicLookupStrategy.java" size="26849" author="svanders" created="Mon, 3 Sep 2007 12:53:48 +0000"/>
                            <attachment id="12876" name="LookupStrategyTest.java" size="5916" author="svanders" created="Mon, 3 Sep 2007 12:55:09 +0000"/>
                            <attachment id="12877" name="applicationContext-test.xml" size="4204" author="svanders" created="Mon, 3 Sep 2007 12:57:14 +0000"/>
                            <attachment id="15789" name="o1.html" size="19270" author="raz71abb6" created="Fri, 9 Oct 2009 09:58:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 5 Apr 2008 08:21:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03zun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>23350</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19837</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>