<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 07:21:04 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SWS-226/SWS-226.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SWS-226] Exception mapping corrupts the &apos;defaultFault&apos; instance</title>
                <link>https://jira.spring.io/browse/SWS-226</link>
                <project id="10060" key="SWS">Spring Web Services</project>
                    <description>&lt;p&gt;In AbstractSoapFaultDefinitionExceptionResolver (v. 1.0.1), have the following code fragment:&lt;/p&gt;

&lt;p&gt;    protected final boolean resolveExceptionInternal(MessageContext messageContext, Object endpoint, Exception ex) {&lt;br/&gt;
        Assert.isTrue(messageContext.getResponse() instanceof SoapMessage,&lt;br/&gt;
                &quot;AbstractSoapFaultDefinitionExceptionResolver requires a SoapMessage&quot;);&lt;/p&gt;

&lt;p&gt;        SoapFaultDefinition definition = getFaultDefinition(endpoint, ex);&lt;br/&gt;
        if (definition == null) &lt;/p&gt;
{
 1.           definition = defaultFault;
        }
&lt;p&gt;        if (definition == null) &lt;/p&gt;
{
            return false;
        }
&lt;p&gt;        if (!StringUtils.hasLength(definition.getFaultStringOrReason())) &lt;/p&gt;
{
2.            definition.setFaultStringOrReason(ex.getMessage());
        }
&lt;p&gt;....&lt;/p&gt;


&lt;p&gt;Problem is if (1.) and (2.) are hit on first exception handled by defaultFault, it is effectively calling &apos;defaultFault.setFaultOrReason(...)&apos;.  This in essence sets the defaultFault faultOrReason field (as defnition points to the defaultFault instance), making it non-null.  Problem is that subsequent exceptions that are assigned the defaultFault will now have an already populated faultOrReason code (from the first exception), and thus statement (2.) will never be invoked.  This results in all subsequent defaultFault exceptions having the exception message from the first defaultFault.&lt;/p&gt;

&lt;p&gt;Categorizing this as Major as all reported exceptions that map to &apos;defaultFault&apos; will be incorrect, with exception of first mapped defaultFault exception.  Solution is trivial: use &apos;default fault factory&apos; to create new instance of defaultFault for every use, or reset the faultOrReason code to null after the message has been constructed.&lt;/p&gt;

&lt;p&gt;====================================================================================&lt;/p&gt;

&lt;p&gt;Below test fragments found the behavior (the second test fails, as the returned exception has the message from the first test.  Yet running the second test standalone works fine:&lt;/p&gt;

&lt;p&gt;  /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This will happen on badly formed payload (validation error)&lt;br/&gt;
   */&lt;br/&gt;
  public void testInvalidXmlCharacter() throws NoSuchAlgorithmException, IOException, ServletException, DocumentException 
{
    // &amp;amp;#1 is illegal xml character
    String payload = buildEchoPayload(&quot;foo&quot;+ (char) 0x01);
    MockHttpServletResponse mockResp = invokeWebService(payload, &quot;guitest&quot;, &quot;bugBgone&quot;,
         HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
    Element resp = getSoapBodyPayload(mockResp);

    assertEquals(&quot;Invalid char preventing xml parsing&quot;,
        &quot;\n&quot; +
            &quot;&amp;lt;SOAP-ENV:Fault xmlns:SOAP-ENV=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&amp;gt;\n&quot; +
            &quot;  &amp;lt;faultcode&amp;gt;SOAP-ENV:Server&amp;lt;/faultcode&amp;gt;\n&quot; +
            &quot;  &amp;lt;faultstring xml:lang=\&quot;en\&quot;&amp;gt;Could not access envelope: Unable to create envelope from given source: ; nested exception is com.sun.xml.messaging.saaj.SOAPExceptionImpl: Unable to create envelope from given source:&amp;lt;/faultstring&amp;gt;\n&quot; +
            &quot;&amp;lt;/SOAP-ENV:Fault&amp;gt;&quot;,
        XmlUtils.toString(resp));
  }&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;  public void testThrownAppException() throws NoSuchAlgorithmException, IOException, ServletException, DocumentException &lt;/p&gt;
{
    String payload = buildEchoPayload(EchoController.THROW_NULL_POINTER_CMD);
    MockHttpServletResponse mockResp = invokeWebService(payload, &quot;guitest&quot;, &quot;bugBgone&quot;,
        HttpServletResponse.SC_INTERNAL_SERVER_ERROR);

    Element resp = getSoapBodyPayload(mockResp);
    assertEquals(&quot;\n&quot; +
        &quot;&amp;lt;SOAP-ENV:Fault xmlns:SOAP-ENV=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&amp;gt;\n&quot; +
        &quot;  &amp;lt;faultcode&amp;gt;SOAP-ENV:Server&amp;lt;/faultcode&amp;gt;\n&quot; +
        &quot;  &amp;lt;faultstring xml:lang=\&quot;en\&quot;&amp;gt;Thrown on purpose for testing...&amp;lt;/faultstring&amp;gt;\n&quot; +
        &quot;&amp;lt;/SOAP-ENV:Fault&amp;gt;&quot;,
        XmlUtils.toString(resp));
  }
</description>
                <environment>Windows XP, java 5</environment>
        <key id="18457">SWS-226</key>
            <summary>Exception mapping corrupts the &apos;defaultFault&apos; instance</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arjen.poutsma">Arjen Poutsma</assignee>
                                    <reporter username="blmiller">Brad L. Miller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Nov 2007 06:01:49 +0000</created>
                <updated>Fri, 7 Dec 2007 13:24:27 +0000</updated>
                            <resolved>Wed, 14 Nov 2007 04:09:14 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>1.5 M1</fixVersion>
                    <fixVersion>1.0.3</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <timeoriginalestimate seconds="7200">0.25d</timeoriginalestimate>
                            <timeestimate seconds="7200">0.25d</timeestimate>
                                        <comments>
                            <comment id="27433" author="blmiller" created="Thu, 8 Nov 2007 06:06:00 +0000"  >&lt;p&gt;Disregard second possible solution (resetting defaultFault faultOrReason code to null), as not thread-safe.&lt;/p&gt;</comment>
                            <comment id="27469" author="arjen.poutsma" created="Fri, 9 Nov 2007 14:18:42 +0000"  >&lt;p&gt;Fixed. Thanks for pointing this out!&lt;/p&gt;</comment>
                            <comment id="27615" author="arjen.poutsma" created="Wed, 14 Nov 2007 03:57:10 +0000"  >&lt;p&gt;Also fixing in 1.0.3&lt;/p&gt;</comment>
                            <comment id="27616" author="arjen.poutsma" created="Wed, 14 Nov 2007 03:57:40 +0000"  >&lt;p&gt;Reopening for 1.0.3&lt;/p&gt;</comment>
                            <comment id="27617" author="arjen.poutsma" created="Wed, 14 Nov 2007 04:09:14 +0000"  >&lt;p&gt;Also fixed in 1.0 branch.&lt;/p&gt;</comment>
                            <comment id="28381" author="arjen.poutsma" created="Fri, 7 Dec 2007 13:24:27 +0000"  >&lt;p&gt;Closing issues for 1.5.0 M1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 Nov 2007 14:18:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7879</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01w1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11070</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11049</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>