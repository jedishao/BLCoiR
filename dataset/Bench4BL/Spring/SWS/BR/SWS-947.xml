<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Fri Dec 23 07:20:15 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SWS-947/SWS-947.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SWS-947] race-condition breaks dynamic WSDL </title>
                <link>https://jira.spring.io/browse/SWS-947</link>
                <project id="10060" key="SWS">Spring Web Services</project>
                    <description>&lt;p&gt;We have developed a couple of Spring Webservices deployed on Tomcat in a (stateless) Docker container that from time to time somehow fail to start correctly and return a stacktrace instead of the WSDL. Restarting the container will almost always fix it at the first attempt.&lt;/p&gt;

&lt;p&gt;The same issue was reported here by someone else: &lt;a href=&quot;http://forum.spring.io/forum/spring-projects/web-services/122858-thread-safety-issue-with-requests-to-wsdl&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://forum.spring.io/forum/spring-projects/web-services/122858-thread-safety-issue-with-requests-to-wsdl&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;It looks like it is similar to bugs like these:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/XERCESJ-211&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/XERCESJ-211&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://netbeans.org/bugzilla/show_bug.cgi?id=111862#c15&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://netbeans.org/bugzilla/show_bug.cgi?id=111862#c15&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Below the complete stacktrace:&lt;/p&gt;

&lt;p&gt;08:14:35.378 &lt;span class=&quot;error&quot;&gt;&amp;#91;http-nio-8080-exec-1&amp;#93;&lt;/span&gt; DEBUG o.s.w.t.h.MessageDispatcherServlet - Could not complete request&lt;br/&gt;
javax.xml.transform.TransformerException: java.lang.NullPointerException&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transform(TransformerImpl.java:752) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transform(TransformerImpl.java:357) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.ws.transport.http.WsdlDefinitionHandlerAdapter.handle(WsdlDefinitionHandlerAdapter.java:144) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;spring-ws-core-2.2.0.RELEASE.jar:2.2.0.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.ws.transport.http.MessageDispatcherServlet.doService(MessageDispatcherServlet.java:285) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;spring-ws-core-2.2.0.RELEASE.jar:2.2.0.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:961) &lt;span class=&quot;error&quot;&gt;&amp;#91;spring-webmvc-4.0.5.RELEASE.jar:4.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:852) &lt;span class=&quot;error&quot;&gt;&amp;#91;spring-webmvc-4.0.5.RELEASE.jar:4.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:618) &lt;span class=&quot;error&quot;&gt;&amp;#91;servlet-api.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:837) &lt;span class=&quot;error&quot;&gt;&amp;#91;spring-webmvc-4.0.5.RELEASE.jar:4.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:725) &lt;span class=&quot;error&quot;&gt;&amp;#91;servlet-api.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:291) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-websocket.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:239) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:219) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:142) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:610) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:516) &lt;span class=&quot;error&quot;&gt;&amp;#91;catalina.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1086) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-coyote.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:659) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-coyote.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-coyote.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1558) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-coyote.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1515) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-coyote.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) &lt;span class=&quot;error&quot;&gt;&amp;#91;tomcat-util.jar:8.0.20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: java.lang.NullPointerException: null&lt;br/&gt;
        at com.sun.org.apache.xerces.internal.dom.DeferredElementNSImpl.synchronizeData(DeferredElementNSImpl.java:108) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xerces.internal.dom.ElementImpl.getNodeName(ElementImpl.java:122) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:152) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:230) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:230) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:230) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:230) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:230) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:136) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.DOM2TO.parse(DOM2TO.java:98) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transformIdentity(TransformerImpl.java:699) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transform(TransformerImpl.java:743) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_40-internal&amp;#93;&lt;/span&gt;&lt;br/&gt;
        ... 30 common frames omitted&lt;/p&gt;</description>
                <environment></environment>
        <key id="67640">SWS-947</key>
            <summary>race-condition breaks dynamic WSDL </summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://jira.spring.io/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Complete</resolution>
                                        <assignee username="gregturn">Greg Turnquist</assignee>
                                    <reporter username="johannesb">JohannesB</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Feb 2016 15:20:09 +0000</created>
                <updated>Tue, 23 Aug 2016 16:28:54 +0000</updated>
                            <resolved>Tue, 23 Aug 2016 16:28:54 +0000</resolved>
                                    <version>2.2.0.RELEASE</version>
                                    <fixVersion>2.3.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="131063" author="johannesb" created="Mon, 8 Aug 2016 08:39:43 +0000"  >&lt;p&gt;CAUSE:&lt;br/&gt;
WsdlDefinitionHandlerAdapter uses an instance of the Source interface named definitionSource.&lt;br/&gt;
According to my debugger this is a javax.xml.transform.dom.DOMSource with its node attribute set to an instance of:&lt;br/&gt;
com.sun.org.apache.xerces.internal.dom.DeferredDocumentImpl (from Oracle JDK8).&lt;/p&gt;

&lt;p&gt;This DeferredDocumentImpl is the root of a tree of DeferredNode&apos;s (DeferredElementNSImpl, DeferredTextImpl) which are not thread safe, not even for read access, as the whole idea is that these are lazyily initialised. (See for example the FAQ from Xerces: &lt;a href=&quot;https://xerces.apache.org/xerces2-j/faq-dom.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://xerces.apache.org/xerces2-j/faq-dom.html&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;This object is created by Wsdl4jDefinition.getSource() which is (partially) synchronized but caches the result of wsdlWriter.getDocument(definition) that causes the problem.&lt;/p&gt;

&lt;p&gt;SOLUTION:&lt;br/&gt;
My (succesfully tested) proposal would be to remove the caching of the DOM version of the definition in Wsdl4jDefinition.java&lt;/p&gt;

&lt;p&gt;ALTERNATIVES:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In theory there are other DOM implementations like the original Xerces that can be configured to disable this deferred feature. See:  &lt;a href=&quot;https://xerces.apache.org/xerces-j/features.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://xerces.apache.org/xerces-j/features.html&lt;/a&gt; but we cannot be sure which dom implementation is used and we cannot configure DOM parser features through the JSR-110 WSDLFactory and WSDLWriter.&lt;/li&gt;
	&lt;li&gt;The original race condition only affects parallel initialization of deferred elements. It might be possible to somehow solve the original code by iterating once over all the elements in the DOM tree within the synchronized block in order to initialise all the deferred elements.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Reproduction and testing the solution was done with a JMeter loadtest with 8 threads that was started before starting the application.&lt;/p&gt;</comment>
                            <comment id="131116" author="johannesb" created="Tue, 9 Aug 2016 13:28:03 +0000"  >&lt;p&gt;Today discovered that this bug not only can cause NullPointerException during WSDL retrieval but sometimes corrupts the WSDL:&lt;/p&gt;

&lt;p&gt;We have the same identical Docker container on both servers but this returns different results on different servers:&lt;/p&gt;

&lt;p&gt;curl &lt;a href=&quot;http://localhost:xxx/app/v1/App.wsdl&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:xxx/app/v1/App.wsdl&lt;/a&gt;|egrep -o &apos;xs:complexType name=&quot;MediumIdCollection.&lt;/p&gt;
{50}
&lt;p&gt;&apos;&lt;/p&gt;

&lt;p&gt;Server 1 returns:&lt;br/&gt;
xs:complexType name=&quot;MediumIdCollection&quot;&amp;gt;&amp;lt;xs:sequence&amp;gt;&amp;lt;xs:element maxOccurs=&quot;&quot; minOccurs=&lt;/p&gt;

&lt;p&gt;Server 2 returns:&lt;br/&gt;
xs:complexType name=&quot;MediumIdCollection&quot;&amp;gt;&amp;lt;xs:sequence&amp;gt;&amp;lt;xs:element maxOccurs=&quot;unbounded&quot; m&lt;/p&gt;

&lt;p&gt;In this case the race condition made the maxOccurs attribute value disappear, which makes this even more unpredictable.&lt;/p&gt;</comment>
                            <comment id="131493" author="gregturn" created="Tue, 23 Aug 2016 16:28:54 +0000"  >&lt;p&gt;The cached version of Document has been removed from Wsdl4jDefinition so it should return a clean copy. Code is available on 2.3.1.BUILD-SNAPSHOT if you want to try it out.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 23 Aug 2016 16:28:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10280" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09227:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10381" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Ranking</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>