<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 19:26:46 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SPR-2314/SPR-2314.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SPR-2314] Transaction synchronization error with PROPAGATION_REQUIRES_NEW and error obtaining new connection</title>
                <link>https://jira.spring.io/browse/SPR-2314</link>
                <project id="10000" key="SPR">Spring Framework</project>
                    <description>&lt;p&gt;AbstractPlatformTransactionManager can get itself in an unrecoverable state when it suspends one transaction and gets an error trying to create a new connection in the same thread of execution. Details and fix follow.&lt;/p&gt;

&lt;p&gt;The symptom is the exception:&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: Cannot deactivate transaction synchronization - not active&lt;br/&gt;
  at org.springframework.transaction.support.TransactionSynchronizationManager.clearSynchronization(TransactionSynchronizationManager.java:263)&lt;br/&gt;
  at org.springframework.transaction.support.AbstractPlatformTransactionManager.cleanupAfterCompletion(AbstractPlatformTransactionManager.java:746)&lt;br/&gt;
  at org.springframework.transaction.support.AbstractPlatformTransactionManager.processRollback(AbstractPlatformTransactionManager.java:615)&lt;br/&gt;
  at org.springframework.transaction.support.AbstractPlatformTransactionManager.rollback(AbstractPlatformTransactionManager.java:560)&lt;br/&gt;
  at org.springframework.transaction.interceptor.TransactionAspectSupport.doCloseTransactionAfterThrowing(TransactionAspectSupport.java:285)&lt;br/&gt;
  at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:100)&lt;br/&gt;
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:170)&lt;br/&gt;
  at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:176)&lt;br/&gt;
  ...&lt;/p&gt;

&lt;p&gt;When this exception happens the first connection is never closed resulting in abandoned connections in the connection pool. Ouch.&lt;/p&gt;

&lt;p&gt;To reproduce this error, we have a connection pool with only one connection available. We are using declarative transactions with AOP TransactionInterceptor. methodA() is configured with PROPAGATION_REQUIRED and calls methodB() which is configured with PROPAGATION_REQUIRES_NEW.&lt;/p&gt;

&lt;p&gt;Calling methodA() results in:&lt;/p&gt;

&lt;p&gt;1. New connection and transaction for methodA() execution&lt;br/&gt;
2. methodA() calls methodB() resulting in:&lt;br/&gt;
3. AbstractPlatformTransactionManager calls suspend(transaction) at line 321&lt;br/&gt;
4. AbstractPlatformTransactionManager calls doBegin() at line 322 and gets a timeout exception waiting for a new connection&lt;br/&gt;
5. Exception bubbles up causing a rollback but the original transaction is not in place to be rolled back&lt;br/&gt;
6. An exception is thrown in rollback (IllegalStateException) so connection is never closed&lt;/p&gt;

&lt;p&gt;It appears that the fix would be to catch the exception in doBegin() and to resume the original transaction before rethrowing the exception.&lt;/p&gt;

&lt;p&gt;This patch appears to do it for this specific case. I&apos;m not sure if doBegin() should have the same handling elsewhere:&lt;/p&gt;

&lt;p&gt;AbstractPlatformTransactionManager.java&lt;/p&gt;

&lt;p&gt;322c322,330&lt;br/&gt;
&amp;lt;                       doBegin(transaction, definition);&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;                       try&lt;br/&gt;
&amp;gt;                       &lt;/p&gt;
{
&amp;gt;                               doBegin(transaction, definition);
&amp;gt;                       }
&lt;p&gt;&amp;gt;                       catch (RuntimeException e)&lt;br/&gt;
&amp;gt;                       &lt;/p&gt;
{
&amp;gt;                               resume(transaction, (SuspendedResourcesHolder) suspendedResources);
&amp;gt;                               throw e;
&amp;gt;                       }

&lt;p&gt;With this fix, the connection pool timeout exception bubbles all the way up and causes a rollback for the first transaction.&lt;/p&gt;

&lt;p&gt;Alon&lt;/p&gt;</description>
            <key id="14549">SPR-2314</key>
            <summary>Transaction synchronization error with PROPAGATION_REQUIRES_NEW and error obtaining new connection</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="juergen.hoeller">Juergen Hoeller</assignee>
                                    <reporter username="asalant">Alon Salant</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Jul 2006 08:21:55 +0000</created>
                <updated>Tue, 19 Jun 2012 03:52:33 +0000</updated>
                            <resolved>Thu, 26 Oct 2006 21:45:09 +0000</resolved>
                                    <version>1.2.8</version>
                    <version>2.0 final</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>1.2.9</fixVersion>
                                    <component>Transaction</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="20481" author="juergen.hoeller" created="Thu, 26 Oct 2006 21:40:47 +0000"  >&lt;p&gt;Thanks for the report! I&apos;m surprised that this hasn&apos;t been discovered earlier... That&apos;s probably an indication that suspend and nested begin hardly ever fails, or at least hardly ever in combination with thread-bound resources (dependent on the concrete transaction manager).&lt;/p&gt;

&lt;p&gt;This has finally been fixed for both Spring 2.0.1 and Spring 1.2.9, to be released within the coming two weeks. In the meantime, feel free to give one of the next nightly snapshots (&lt;a href=&quot;http://www.springframework.org/snapshots&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/snapshots&lt;/a&gt;) a try...&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                            <comment id="20980" author="dhinckle" created="Mon, 20 Nov 2006 02:09:54 +0000"  >&lt;p&gt;I have an application in production that is getting this problem. I checked the 2.0.1 snapshot and it fixed my problem. I do not want to upgrade to Spring 2.x, yet. When will 1.2.9 be released? Or if it will not be released soon, how do I modify the Spring source code to incorporate the fix. Thanks.&lt;/p&gt;</comment>
                            <comment id="21002" author="juergen.hoeller" created="Mon, 20 Nov 2006 20:35:28 +0000"  >&lt;p&gt;1.2.9 is supposed to be released ASAP after Spring 2.0.1. We might publish a 1.2.9 snapshot this week already, alongside our 2.0.x snapshots. I&apos;ll keep you informed.&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                            <comment id="21018" author="dhinckle" created="Tue, 21 Nov 2006 20:25:25 +0000"  >&lt;p&gt;The 1.2.9 from CVS on 2006-10-21 does not seem to fix this problem. As commented earlier, the 2.0.1 snapshot on 2006-10-20 does fix the problem.&lt;/p&gt;</comment>
                            <comment id="21019" author="juergen.hoeller" created="Tue, 21 Nov 2006 20:33:37 +0000"  >&lt;p&gt;I have finished the backports to 1.2.9 last night. So the current developer CVS should contain this fix in mbranch-1-2, which is hopefully reflected in SourceForge&apos;s public CVS as well.&lt;/p&gt;

&lt;p&gt;I can send you a corresponding spring.jar, if you&apos;d like... In any case, I would appreciate if you test the current 1.2.9 release candidate (which it effectively is) and let me know whether it works for you!&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                            <comment id="21177" author="dhinckle" created="Mon, 4 Dec 2006 05:20:26 +0000"  >&lt;p&gt;I noticed that 2.0.1 has been released. How soon until 1.2.9 will be released?&lt;/p&gt;</comment>
                            <comment id="21214" author="juergen.hoeller" created="Tue, 5 Dec 2006 15:17:14 +0000"  >&lt;p&gt;Spring 1.2.9 is now scheduled for Dec 20, with an early access snapshot planned to be published this week. I&apos;ll keep you up to date.&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                            <comment id="21422" author="dhinckle" created="Fri, 22 Dec 2006 03:07:52 +0000"  >&lt;p&gt;When is the current release schedule for 1.2.9? or is there a URL that I can view the release schedule?&lt;/p&gt;</comment>
                            <comment id="21428" author="juergen.hoeller" created="Fri, 22 Dec 2006 05:27:10 +0000"  >&lt;p&gt;1.2.9 is scheduled to be released on December 30th now, alongside the 2.0.2 release. Sorry for the delay...&lt;/p&gt;

&lt;p&gt;A sort of release candidate is available in the form of the 1.2.9-20061222 snapshot from&lt;/p&gt;

&lt;p&gt;  &lt;a href=&quot;http://static.springframework.org/downloads/nightly&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://static.springframework.org/downloads/nightly&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please give this a try and let me know whether it works for you... This will help us to ensure the quality of the actual 1.2.9 release.&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                            <comment id="21549" author="dhinckle" created="Mon, 1 Jan 2007 22:02:09 +0000"  >&lt;p&gt;The 20061231 snapshot fixed my problem. I did not try the 20061222.&lt;/p&gt;</comment>
                            <comment id="22034" author="juergen.hoeller" created="Mon, 5 Feb 2007 09:39:28 +0000"  >&lt;p&gt;FYI, I&apos;ve made (another) Spring 1.2.9 release candidate snapshot available at:&lt;br/&gt;
&lt;a href=&quot;http://static.springframework.org/downloads/nightly&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://static.springframework.org/downloads/nightly&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The current candidate is the 20070205 snapshot, which is finally scheduled for release this Friday unless any issues are found.&lt;br/&gt;
Please give this final snapshot a sanity check in your 1.2.8-based applications, and let me know whether it works for you!&lt;/p&gt;

&lt;p&gt;Thanks for your efforts, and sorry for the even longer delay...&lt;/p&gt;

&lt;p&gt;Juergen&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="15526">SPR-2854</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10180" key="com.atlassian.jira.toolkit:dayslastcommented">
                        <customfieldname>Days since last comment</customfieldname>
                        <customfieldvalues>
                                        9 years, 47 weeks, 3 days ago
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Oct 2006 21:40:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10181" key="com.atlassian.jira.toolkit:lastusercommented">
                        <customfieldname>Last commented by a User</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>false</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10182" key="com.atlassian.jira.toolkit:lastupdaterorcommenter">
                        <customfieldname>Last updater</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tmarshall</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i011z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6197</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>