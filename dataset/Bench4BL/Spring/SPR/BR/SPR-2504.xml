<!-- 
RSS generated by JIRA (6.4.11#64026-sha1:78f6ec473a3f058bd5d6c30e9319c7ab376bdb9c) at Thu Dec 22 20:32:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://jira.spring.io/si/jira.issueviews:issue-xml/SPR-2504/SPR-2504.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>Spring JIRA</title>
    <link>https://jira.spring.io</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.4.11</version>
        <build-number>64026</build-number>
        <build-date>25-08-2015</build-date>
    </build-info>

<item>
            <title>[SPR-2504] Problems with @Transactional attribute processing if mix of Spring-managed beans and load-time weaved object exists</title>
                <link>https://jira.spring.io/browse/SPR-2504</link>
                <project id="10000" key="SPR">Spring Framework</project>
                    <description>&lt;p&gt;I have met subtle, but unpleasant bug (or rather bug family) in the transaction processing under following conditions:&lt;/p&gt;

&lt;p&gt;I have a class annotated by @Configurable with one of methods annotated by @Transactional (import ommited for brevity).&lt;/p&gt;

&lt;p&gt;@Configurable&lt;br/&gt;
public class TestAnnotations {&lt;br/&gt;
    PlatformTransactionManager fManager;&lt;br/&gt;
    public void setTransactionManager(PlatformTransactionManager manager) &lt;/p&gt;
{
        fManager= manager;
    }
&lt;p&gt;    @Transactional(propagation = Propagation.REQUIRED)&lt;br/&gt;
    public Object getTransaction() &lt;/p&gt;
{
          System.out.println(&quot;Transaction activity &quot;+
            TransactionSynchronizationManager.isActualTransactionActive());
        return fManager.getTransaction(
            new DefaultTransactionAttribute(
               TransactionDefinition.PROPAGATION_MANDATORY
       ));
    }
&lt;p&gt;;&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;Objects of this class are not Spring beans but are created by &quot;new&quot;. AspectJ load time weaving is enabled and following aop.xml is present&lt;br/&gt;
&amp;lt;!DOCTYPE aspectj PUBLIC&lt;br/&gt;
&quot;-//AspectJ//DTD//EN&quot; &quot;http://www.eclipse.org/aspectj/dtd/aspectj.dtd&quot;&amp;gt;&lt;br/&gt;
&amp;lt;aspectj&amp;gt;&lt;br/&gt;
   &amp;lt;weaver options=&quot;-showWeaveInfo -XmessageHandlerClass:org.springframework.aop.aspectj.AspectJWeaverMessageHandler&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;include within=&quot;de.ntec.feasibility.configurable.TestAnnotations&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/weaver&amp;gt;&lt;br/&gt;
&amp;lt;/aspectj&amp;gt;&lt;br/&gt;
Context.xml is as follows&lt;/p&gt;

&lt;p&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
&amp;lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;&lt;br/&gt;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;br/&gt;
  xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;&lt;br/&gt;
  xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;&lt;br/&gt;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans &lt;a href=&quot;http://www.springframework.org/schema/beans/spring-beans.xsd&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/schema/beans/spring-beans.xsd&lt;/a&gt; &lt;a href=&quot;http://www.springframework.org/schema/aop&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/schema/aop&lt;/a&gt; &lt;a href=&quot;http://www.springframework.org/schema/aop/spring-aop.xsd&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/schema/aop/spring-aop.xsd&lt;/a&gt; &lt;a href=&quot;http://www.springframework.org/schema/tx&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/schema/tx&lt;/a&gt; &lt;a href=&quot;http://www.springframework.org/schema/tx/spring-tx.xsd&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.springframework.org/schema/tx/spring-tx.xsd&lt;/a&gt;&quot;&lt;br/&gt;
&amp;gt;&lt;br/&gt;
    &amp;lt;aop:spring-configured/&amp;gt;       &lt;br/&gt;
&amp;lt;!--    &amp;lt;tx:annotation-driven transaction-manager=&quot;txManager&quot;/&amp;gt;  --&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.transaction.CallCountingTransactionManager&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;/bean&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;bean class=&quot;de.ntec.feasibility.configurable.TestAnnotations&quot;&lt;br/&gt;
        singleton=&quot;false&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;property name=&quot;transactionManager&quot; ref=&quot;txManager&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/bean&amp;gt;&lt;br/&gt;
&amp;lt;/beans&amp;gt;&lt;/p&gt;

&lt;p&gt;(note that &amp;lt;tx:aspect-driven ...&amp;gt; is commented out, but if comments are removed, result is the same).&lt;/p&gt;

&lt;p&gt;Java (1.5.0_08) is started with -javaagent:aspectjweaver.jar (latter resides in current directory). Weaving take place&lt;br/&gt;
&quot;INFO - &lt;span class=&quot;error&quot;&gt;&amp;#91;AspectJ&amp;#93;&lt;/span&gt; weaving &apos;de/ntec/feasibility/configurable/Configurabl&apos;&quot;&lt;/p&gt;

&lt;p&gt;Call &lt;/p&gt;

&lt;p&gt;TransactionSynchronizationManager.isActualTransactionActive()); &lt;/p&gt;

&lt;p&gt;returns &quot;true&quot;, but &lt;/p&gt;

&lt;p&gt;fManager.getTransaction(new DefaultTransactionAttribute(TransactionDefinition.PROPAGATION_MANDATORY));&lt;/p&gt;

&lt;p&gt;fails with exception &lt;br/&gt;
org.springframework.transaction.IllegalTransactionStateException: Transaction propagation &apos;mandatory&apos; but no existing transaction found&lt;br/&gt;
        at org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(AbstractPlatformTransactionManager.java:306)&lt;br/&gt;
        at de.ntec.feasibility.configurable.TestAnnotations.getTransaction(Configurabl.java:29)&lt;br/&gt;
        at de.ntec.feasibility.configurable.Main.main(Main.java:22)&lt;/p&gt;

&lt;p&gt;So TransactionSynchronizationManager reports that transaction exists but TransactionManager is unable to found it - clear contradiction.&lt;/p&gt;

&lt;p&gt;To finis a picture main method initializes transaction aspect in the following way&lt;/p&gt;

&lt;p&gt;      AnnotationTransactionAspect.aspectOf().setTransactionManager( (PlatformTransactionManager)(fContext.getBean(&quot;txManager&quot;)));&lt;/p&gt;

&lt;p&gt;If I try to create as Sring-managed bean some object of a another class that has &quot;@Transactional&quot; annotation on one of its methods it fails as well (in different manner depending on presence of &amp;lt;tx:annotation-driven/&amp;gt;, presence of this class in &quot;include&quot; clause of aop.xml and even is this bean singleton or not.  I was unable to find combination that works in presence of load-time weaving (even if wweaved classes has only @Configurable)&lt;/p&gt;</description>
            <key id="14865">SPR-2504</key>
            <summary>Problems with @Transactional attribute processing if mix of Spring-managed beans and load-time weaved object exists</summary>
                <type id="1" iconUrl="https://jira.spring.io/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://jira.spring.io/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://jira.spring.io/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adrian.colyer">Adrian Colyer</assignee>
                                    <reporter username="al0">Oleksandr Alesinskyy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Aug 2006 09:18:02 +0000</created>
                <updated>Tue, 19 Jun 2012 03:50:11 +0000</updated>
                            <resolved>Mon, 11 Sep 2006 00:37:47 +0000</resolved>
                                    <version>2.0 RC3</version>
                                    <fixVersion>2.0 RC4</fixVersion>
                                    <component>[Documentation]</component>
                    <component>Core:AOP</component>
                    <component>Transaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="19281" author="al0" created="Tue, 29 Aug 2006 22:00:21 +0000"  >&lt;p&gt;Issue is really very subtle and very minor - error occurs if and only if some class meets ALL following conditions &lt;/p&gt;

&lt;p&gt;1. Does not implement interface (i.e. proxied by CGLIB2-proxies) &lt;br/&gt;
2.  Is annotated with  @configurable &lt;br/&gt;
3. Has methods annotated with @Transactional&lt;br/&gt;
4. Context contains 2 bean definitions  based on this class - one to be used for configuration objects of this class created by &quot;new&quot; operator and one to create bean by Spring (as singleton or from prototype - outcome is the same, the only differece that singleton fails on startup, and prototype on getBean call; I have not tested a case when single bean definition serves both purposes, as it is not possible with singleton). &lt;br/&gt;
5. AspectJ load-time weaving is enabled for this class&lt;br/&gt;
6. &amp;lt;tx:annotation-driven&amp;gt; is present&lt;/p&gt;

&lt;p&gt;Error is as follows:&lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
INFO - Destroying singletons in &lt;/p&gt;
{org.springframework.beans.factory.support.DefaultListableBeanFactory defining beans [org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect,org.springframework.aop.config.internalAutoProxyCreator,org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor,txManager,dataSource,sessionFactory,de.ntec.feasibility.configurable.TestAspects,load]; root of BeanFactory hierarchy}
&lt;p&gt;INFO - Closing Hibernate SessionFactory&lt;br/&gt;
INFO - closing&lt;br/&gt;
Exception in thread &quot;main&quot; org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;load&apos; defined in class path resource &lt;span class=&quot;error&quot;&gt;&amp;#91;context2.xml&amp;#93;&lt;/span&gt;: Initialization of bean failed; nested exception is null&lt;br/&gt;
Caused by: &lt;br/&gt;
-------------------------------&lt;/p&gt;

&lt;p&gt;&quot;Caused by&quot; IS empty.&lt;/p&gt;

&lt;p&gt;Sample classes, context and aop.xml are attached&lt;/p&gt;


</comment>
                            <comment id="19284" author="al0" created="Tue, 29 Aug 2006 22:04:40 +0000"  >&lt;p&gt;Files mentioned in the previous comment&lt;/p&gt;</comment>
                            <comment id="19524" author="adrian.colyer" created="Mon, 11 Sep 2006 00:24:58 +0000"  >&lt;p&gt;This turned out to be an interaction between two bugs:&lt;/p&gt;

&lt;p&gt;1) When using Spring-AOP in conjunction with AspectJ LTW, the class name seen by the @Configurable support is the CGLIB proxy classname : ....$$EnhancerByCGLIB$$...&lt;br/&gt;
Since you used @Configurable with no bean name, we use the class name as the bean name, and fail to find a bean with the EnhancerByCGLIB suffix on the end. This causes &lt;br/&gt;
an exception during initialization, which is reported as an AOP alliance AspectException&lt;/p&gt;

&lt;p&gt;2) The AOPAlliance AspectException has a bug that throws an NPE when you ask for its message after constructing it with (String,Throwable). This causes us to lose the next cause &lt;br/&gt;
message that Spring puts out.&lt;/p&gt;

&lt;p&gt;I&apos;ve changed the AnnotationBeanWiringInfoResolver to cope with CGLIB enhanced proxies by recognizing them as such and returning the real user type name (the superclass). This makes&lt;br/&gt;
your test case work again.&lt;/p&gt;

&lt;p&gt;We should also consider patching the AOP alliance exception class to not NPE as we&apos;ll lose a lot of potential error messages otherwise... (it doesn&apos;t set the message &lt;br/&gt;
field that is subsequently used in getMessage()). I&apos;ll raise a separate issue for that.&lt;/p&gt;</comment>
                            <comment id="19525" author="adrian.colyer" created="Mon, 11 Sep 2006 00:37:47 +0000"  >&lt;p&gt;Issue 2571 raised to cover AOPAlliance bug. This issue can now be considered fixed.&lt;/p&gt;</comment>
                            <comment id="19532" author="al0" created="Mon, 11 Sep 2006 07:12:23 +0000"  >&lt;p&gt;Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="11918" name="SPR-2504.zip" size="13905" author="al0" created="Tue, 29 Aug 2006 22:04:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10180" key="com.atlassian.jira.toolkit:dayslastcommented">
                        <customfieldname>Days since last comment</customfieldname>
                        <customfieldvalues>
                                        10 years, 16 weeks, 3 days ago
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10170" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>First Response Date</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Sep 2006 00:24:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10181" key="com.atlassian.jira.toolkit:lastusercommented">
                        <customfieldname>Last commented by a User</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>true</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10182" key="com.atlassian.jira.toolkit:lastupdaterorcommenter">
                        <customfieldname>Last updater</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tmarshall</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10880" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00vzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10380" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5228</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10171" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>