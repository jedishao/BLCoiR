<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 02:48:35 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-9048/CAMEL-9048.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-9048] camel-core causes restart of karaf console if it is refreshed</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9048</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Start karaf 4.0.0&lt;/p&gt;

&lt;p&gt;feature:repo-add mvn:org.apache.cxf.karaf/apache-cxf/3.1.1/xml/features&lt;br/&gt;
feature:repo-add mvn:org.apache.camel.karaf/apache-camel/2.15.2/xml/features&lt;br/&gt;
feature:install camel-core&lt;br/&gt;
feature:install -v wss4j&lt;/p&gt;

&lt;p&gt;The last feature install causes the karaf shell to restart. The refreshed bundles list shows this:&lt;br/&gt;
    jline/2.12.1 (Wired to org.apache.camel.camel-core/2.15.2 which is being refreshed)&lt;br/&gt;
    org.apache.camel.camel-core/2.15.2 (Should be wired to: org.apache.servicemix.bundles.xalan/2.7.1.7 (through &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.camel.camel-core/2.15.2&amp;#93;&lt;/span&gt; osgi.wiring.package; filter:=&quot;(osgi.wiring.package=org.apache.xalan.xsltc.trax)&quot;; resolution:=optional))&lt;/p&gt;

&lt;p&gt;So this shows that the immediate reason is that jline was refreshed. As jline is used by the shell it also restarts.&lt;/p&gt;

&lt;p&gt;Now it might seem strange that jline depends on camel-core. I had a similar issue in activemq-core Activator. It probed the classloaders of all bundles for well known interfaces to find extensions. I think camel-core does the same. The problem here is that jline has a dynamic import package: *. So the bundle classloader of jline is able to find any camel interface and will then have a wire to camel-core. So if then there is a refresh of camel-core it also will be refreshed.&lt;/p&gt;

&lt;p&gt;This issue can hit all bundles that have a dynamic import package *. &lt;/p&gt;

&lt;p&gt;the solution is to not actually load interface classes but rather check the bundle wiring if there is a wiring to an interface package. This will then not change the wirings and so not cause these problems.&lt;/p&gt;

&lt;p&gt;I will try to provide a fix for the problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12851087">CAMEL-9048</key>
            <summary>camel-core causes restart of karaf console if it is refreshed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chris@die-schneider.net">Christian Schneider</assignee>
                                    <reporter username="chris@die-schneider.net">Christian Schneider</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Aug 2015 12:27:58 +0000</created>
                <updated>Sat, 3 Oct 2015 07:46:19 +0000</updated>
                            <resolved>Wed, 5 Aug 2015 16:01:54 +0000</resolved>
                                    <version>2.15.2</version>
                                    <fixVersion>2.15.3</fixVersion>
                    <fixVersion>2.16.0</fixVersion>
                                    <component>camel-osgi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14653387" author="chris@die-schneider.net" created="Tue, 4 Aug 2015 10:01:58 +0000"  >&lt;p&gt;I have found a workaround at least in combination with jline. The newest snapshot of jline does not do a dynamic import anymore. So the console refresh does not happen. Still we should look into the problem in camel but it is less urgent.&lt;/p&gt;</comment>
                            <comment id="14654954" author="davsclaus" created="Wed, 5 Aug 2015 07:39:28 +0000"  >&lt;p&gt;I wonder if the entries added to packageCapabilities should not be removed when the bundle is stopped? &lt;/p&gt;</comment>
                            <comment id="14654982" author="chris@die-schneider.net" created="Wed, 5 Aug 2015 08:06:12 +0000"  >&lt;p&gt;That makes sense. I just add a clear in the stop method.&lt;/p&gt;</comment>
                            <comment id="14655263" author="davsclaus" created="Wed, 5 Aug 2015 12:15:22 +0000"  >&lt;p&gt;I suspect this caused everything to fail on Karaf 2.4.3.&lt;/p&gt;

&lt;p&gt;Installing camel-example-osgi fails with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
araf@root&amp;gt; Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;SpringOsgiExtenderThread-2&quot;&lt;/span&gt; org.apache.camel.RuntimeCamelException: org.apache.camel.FailedToCreateRouteException: Failed to create route route1: Route(route1)[[From[timer:&lt;span class=&quot;code-comment&quot;&gt;//myTimer?fixedRate=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;period=20... because of Failed to resolve endpoint: timer://myTimer?fixedRate=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;period=2000 due to: No component found with scheme: timer
&lt;/span&gt;	at org.apache.camel.util.ObjectHelper.wrapRuntimeCamelException(ObjectHelper.java:1642)
	at org.apache.camel.spring.SpringCamelContext.onApplicationEvent(SpringCamelContext.java:123)
	at org.apache.camel.spring.CamelContextFactoryBean.onApplicationEvent(CamelContextFactoryBean.java:334)
	at org.springframework.context.event.SimpleApplicationEventMulticaster.multicastEvent(SimpleApplicationEventMulticaster.java:96)
	at org.springframework.context.support.AbstractApplicationContext.publishEvent(AbstractApplicationContext.java:334)
	at org.springframework.context.support.AbstractApplicationContext.finishRefresh(AbstractApplicationContext.java:950)
	at org.springframework.osgi.context.support.AbstractOsgiBundleApplicationContext.finishRefresh(AbstractOsgiBundleApplicationContext.java:235)
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext$4.run(AbstractDelegatedExecutionApplicationContext.java:358)
	at org.springframework.osgi.util.internal.PrivilegedUtils.executeWithCustomTCCL(PrivilegedUtils.java:85)
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.completeRefresh(AbstractDelegatedExecutionApplicationContext.java:320)
	at org.springframework.osgi.extender.internal.dependencies.startup.DependencyWaiterApplicationContextExecutor$CompleteRefreshTask.run(DependencyWaiterApplicationContextExecutor.java:132)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
Caused by: org.apache.camel.FailedToCreateRouteExcepti
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14655276" author="davsclaus" created="Wed, 5 Aug 2015 12:29:35 +0000"  >&lt;p&gt;Yes that is the problem. I am preparing a single squash commit that revert this so we can have it working again - especially for the 2.15.x branch as that is a patch branch.&lt;/p&gt;

&lt;p&gt;Christian can you work on a solution that does not break Camel on Karaf. And please give it a test spin on more versions of Karaf.&lt;/p&gt;

&lt;p&gt;Here is a quick way to test&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
karaf@root&amp;gt; features:chooseurl camel 2.16-SNAPSHOT
Adding feature url mvn:org.apache.camel.karaf/apache-camel/2.16-SNAPSHOT/xml/features
karaf@root&amp;gt; features:addUrl mvn:org.apache.camel/camel-example-osgi/2.16-SNAPSHOT/xml/features
karaf@root&amp;gt; features:install camel-example-osgi
karaf@root&amp;gt; log:tail -n 10
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14655278" author="davsclaus" created="Wed, 5 Aug 2015 12:33:47 +0000"  >&lt;p&gt;And for 2.15.x use 2.15.3-SNAPSHOT as version&lt;/p&gt;</comment>
                            <comment id="14655287" author="chris@die-schneider.net" created="Wed, 5 Aug 2015 12:36:32 +0000"  >&lt;p&gt;I tested on karaf 3 and it worked fine. Please wait a bit with a revert. I will try to get it working on Karaf 2.4 too&lt;/p&gt;</comment>
                            <comment id="14658309" author="chris@die-schneider.net" created="Wed, 5 Aug 2015 14:42:29 +0000"  >&lt;p&gt;Found one issue. It was the broken import for org.osgi.framework.* defined in camel parent again.&lt;br/&gt;
It tries to import a version of &amp;gt;= 1.5 for a ll packages. The packages there all have individual versions though. For org.osgi.framework.wiring we just need the 1.0 version and there is no 1.5 version at all.&lt;br/&gt;
Will change like in camel 2.16. &lt;/p&gt;

&lt;p&gt;This only makes camel start though .. Then I still see the issue you reported. Looking into it.&lt;/p&gt;</comment>
                            <comment id="14658416" author="chris@die-schneider.net" created="Wed, 5 Aug 2015 15:50:21 +0000"  >&lt;p&gt;Also found the problem you reported now. Camel-core does not import the API so I missed it. As I only checked with the stream component that is external to camel-core I missed that.&lt;/p&gt;</comment>
                            <comment id="14658437" author="chris@die-schneider.net" created="Wed, 5 Aug 2015 16:01:54 +0000"  >&lt;p&gt;I tested with your instructions on karaf 2.4.3 using camel 2.16-SNAPSHOT and 2.15.3-SNAPSHOT. Both should work fine now.&lt;/p&gt;</comment>
                            <comment id="14659662" author="davsclaus" created="Thu, 6 Aug 2015 08:04:15 +0000"  >&lt;p&gt;Thanks for the quick fix.&lt;/p&gt;

&lt;p&gt;I do wonder if that clear is correct? Eg if a bundle is stopped, then it clears all of them, also entries that was added by other bundles that was started before hand? Should it not only remove the entries from the bundle that stopped, and not all of them ?&lt;/p&gt;</comment>
                            <comment id="14659668" author="chris@die-schneider.net" created="Thu, 6 Aug 2015 08:14:29 +0000"  >&lt;p&gt;The Map&amp;lt;String, BundleCapability&amp;gt; packageCapabilities only contains the capabilties representing the packages that camel core exports. The map is only changed in cachePackageCapabilities and this is called only when camel core starts. &lt;/p&gt;

&lt;p&gt;When a bundle we track starts we just look up the capability for the package of the interface we check. So we do not store any data about the individual bundles. &lt;/p&gt;

&lt;p&gt;The clear on packageCapabilities is not even strictly necessary as we would just put the same capabilities on the next start but it is better to cleanup on stop.&lt;/p&gt;</comment>
                            <comment id="14659741" author="davsclaus" created="Thu, 6 Aug 2015 09:31:44 +0000"  >&lt;p&gt;Thanks for the explanation&lt;/p&gt;</comment>
                            <comment id="14659746" author="davsclaus" created="Thu, 6 Aug 2015 09:34:35 +0000"  >&lt;p&gt;Have you tried with cxf as a component?&lt;/p&gt;

&lt;p&gt;All the tests in tests/camel-blueprint-cxf-test fails. Though not sure if its this recent change or the pojosr -&amp;gt; felix-connect&lt;/p&gt;</comment>
                            <comment id="14942168" author="davsclaus" created="Sat, 3 Oct 2015 07:46:19 +0000"  >&lt;p&gt;Okay the tests in camel-blueprint-cxf-tests is now passing again with the recent fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9144&quot; title=&quot;Regression with camel-jackson 2.15.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9144&quot;&gt;&lt;del&gt;CAMEL-9144&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tests run: 13, Failures: 0, Errors: 0, Skipped: 0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12849350">KARAF-3888</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12873237">CAMEL-9144</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Aug 2015 07:39:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i9iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>