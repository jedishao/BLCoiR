<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 01:48:39 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-7565/CAMEL-7565.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-7565] SFTP using PollEnrich with &quot;disconnect=true&quot; and &quot;delete=true&quot; does NOT delete the file</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-7565</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Attached are two test cases - one with a &quot;non-pollEnrich&quot; test (which works fine) and one with a &quot;pollEnrich&quot; test (which fails).&lt;/p&gt;

&lt;p&gt;In stepping through some of the code, it appears that the &quot;disconnect&quot; and &quot;delete&quot; are on two different threads (true for both scenarios).  However, for the &quot;non-pollEnrich&quot; test, there seems to be a cycle that allows the timing of the two threads to NOT be an issue.  For the &quot;pollEnrich&quot; test, that cycle doesn&apos;t seem to occur.  &lt;/p&gt;

&lt;p&gt;My uneducated guess is that both tests (code executions) are checking to see if the &quot;from&quot; has completed (including performing the delete) before disconnecting.  This makes sense for the &quot;non-pollEnrich&quot; test, but for the &quot;pollEnrich&quot; it should be checking to see if the &quot;pollEnrich&quot; is done, not the &quot;from&quot;.&lt;/p&gt;

&lt;p&gt;Please note that if you do not indicate &quot;disconnect=true&quot;, file deletion occurs as expected.  This seems to be broken in 2.12.x through 2.13.1 (not sure if it goes back further or not).&lt;/p&gt;

&lt;p&gt;I have attached two different test cases to show the different behaviors (&quot;non-pollEnrich&quot; vs &quot;pollEnrich&quot;).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Occurs on both Windows 7 and CentOS 6.4 against multiple SFTP servers.&lt;/p&gt;</environment>
        <key id="12724784">CAMEL-7565</key>
            <summary>SFTP using PollEnrich with &quot;disconnect=true&quot; and &quot;delete=true&quot; does NOT delete the file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="yarddog">Steve Ardis</reporter>
                        <labels>
                            <label>delete</label>
                            <label>disconnection</label>
                            <label>pollenrich</label>
                            <label>sftp</label>
                    </labels>
                <created>Tue, 1 Jul 2014 18:18:39 +0000</created>
                <updated>Sat, 21 Mar 2015 11:11:37 +0000</updated>
                            <resolved>Sat, 21 Mar 2015 11:11:37 +0000</resolved>
                                    <version>2.13.1</version>
                                    <fixVersion>2.15.1</fixVersion>
                    <fixVersion>2.16.0</fixVersion>
                                    <component>camel-ftp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14049703" author="davsclaus" created="Wed, 2 Jul 2014 07:39:46 +0000"  >&lt;p&gt;Sounds like disconnect is executed before the file is deleted, which happens with the UoW is done. Likely need to move the logic to disconnect in the UoW after file is deleted.&lt;/p&gt;</comment>
                            <comment id="14050389" author="yarddog" created="Wed, 2 Jul 2014 17:41:23 +0000"  >&lt;p&gt;Claus - &lt;/p&gt;

&lt;p&gt;I either have to come up with some hack using a bean and ConsumerTemplate, or given I can get my head around the fix you are suggesting, I can look into trying to create a patch for this issue.  I have breakpoints in the code at SftpConsumer.postPollCheck() (which does the disconnect and is NOT in the UOW) and GenericFileDeleteProcessStrategy.commit() (which does the delete and is in the UOW).  If it was easy enough to point me towards the piece of code(s) that I might be able to move from A to B, I can test it and submit a patch.&lt;/p&gt;</comment>
                            <comment id="14051322" author="davsclaus" created="Thu, 3 Jul 2014 11:05:14 +0000"  >&lt;p&gt;Yeah the disconnect logic should be moved to an UoW instead of post poll check. Though the trick is to only disconnect on the last Exchange, eg in case the consumer polled 5 files, then the disconnect should only happen on the last UoW. And that gets more complicated if the exchanges is processed in parallel and asynchronous. Then you could have that even the last file polled was not last processed, but maybe it was the 3rd file etc.&lt;/p&gt;

&lt;p&gt;But for a single file, such as you may use with pollEnrich then there is only 1 exchange and therefore a bit easier.&lt;/p&gt;
</comment>
                            <comment id="14051410" author="yarddog" created="Thu, 3 Jul 2014 12:57:41 +0000"  >&lt;p&gt;Something has to know when all the UoW(s) are done, right?  Would it be possible to put the disconnect logic in the &quot;supervisor&quot; (if there is such a thing) of the UoW(s), after they have all completed?&lt;/p&gt;</comment>
                            <comment id="14053724" author="yarddog" created="Mon, 7 Jul 2014 14:58:18 +0000"  >&lt;p&gt;I&apos;m not sure I explicitly said this, but the &quot;non-pollEnrich&quot; test also throws an &quot;java.io.IOException: An established connection was aborted by the software in your host machine&quot;, although the test case itself still completes successfully (and has the file deleted).&lt;/p&gt;</comment>
                            <comment id="14372680" author="davsclaus" created="Sat, 21 Mar 2015 11:11:37 +0000"  >&lt;p&gt;Thanks for the test case and reporting.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12653435" name="SftpPollEnrichConsumeWithDisconnectAndDeleteTest.java" size="2536" author="yarddog" created="Tue, 1 Jul 2014 18:20:08 +0000"/>
                            <attachment id="12653436" name="SftpSimpleConsumeWithDisconnectAndDeleteTest.java" size="2097" author="yarddog" created="Tue, 1 Jul 2014 18:20:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 Jul 2014 07:39:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402967</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xcvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403027</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10092"><![CDATA[Unit Test Broken]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>