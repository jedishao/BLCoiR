<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:24:22 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-642/CAMEL-642.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-642] jms aggregation does not work</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-642</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I found this issue when I test  Camel 1.4.0 RC2 kit, I just add a test case to show the error.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/repos/asf/activemq/camel/trunk/components/camel-jms/src/test/java/org/apache/camel/component/jms/AggregratedJmsRouteTest.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/activemq/camel/trunk/components/camel-jms/src/test/java/org/apache/camel/component/jms/AggregratedJmsRouteTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can reproduce the error if you remove the x character from xtestJmsMulticastAndAggregration() method.&lt;/p&gt;

&lt;p&gt;BTW the test case works with the Camel 1.4.0 RC1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12485552">CAMEL-642</key>
            <summary>jms aggregation does not work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                            <parent id="12486175">CAMEL-1037</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="njiang">Willem Jiang</assignee>
                                    <reporter username="njiang">Willem Jiang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Jun 2008 12:51:28 +0000</created>
                <updated>Fri, 31 Oct 2008 12:52:04 +0000</updated>
                            <resolved>Fri, 4 Jul 2008 08:32:51 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12947754" author="marat" created="Fri, 27 Jun 2008 22:44:11 +0000"  >&lt;p&gt;I&apos;m a little bit surprised how this test could have worked at all...&lt;/p&gt;

&lt;p&gt;Looking at the route that this test is testing: &lt;/p&gt;

&lt;p&gt;from(&quot;jms:queue:reply&quot;).aggregator(header(&quot;cheese&quot;).....&lt;/p&gt;

&lt;p&gt;and then debugging through it show that this portion of the route &apos;from(&quot;jms:queue:reply)&apos;  creates an event driven JMS consumer, and then the &apos;aggregator&apos; bit creates a JMS polling consumer on the &lt;b&gt;same&lt;/b&gt; destination.&lt;/p&gt;

&lt;p&gt;This is clearly a race, as we now have two consumers competing for messages off the same destination.&lt;/p&gt;

&lt;p&gt;It seems a possible fix for this type of construct would be having the &apos;from&apos; type realize that its followed by an aggregator and then disable creation of its even driven consumer and letting the aggregator get the messages and then deliver them to their ultimate destinations&lt;/p&gt;

&lt;p&gt;Comments?&lt;/p&gt;</comment>
                            <comment id="12947744" author="wtam@iona.com" created="Wed, 2 Jul 2008 04:23:56 +0000"  >&lt;p&gt;I&apos;m looking into ti.&lt;/p&gt;</comment>
                            <comment id="12947614" author="wtam@iona.com" created="Wed, 2 Jul 2008 08:19:30 +0000"  >&lt;p&gt;The problem is we shouldn&apos;t create eventdrivenroute if it is an aggregator.  Otherwise, we see the race condition that marat mentioned.   If we don&apos;t wrap aggregator with an interceptor, it normally invokes the &quot;addRoutes&quot; method in AggregatorType and EventDrienRoute will not be added.   But if we do wrap with an interceptor, the interceptor becomes the first node and it will create an event drive route.   Attached a patch that sets a flag in the routecontext.  if a route has been added, it won&apos;t try to add an event driven route.&lt;/p&gt;</comment>
                            <comment id="12947584" author="wtam@iona.com" created="Wed, 2 Jul 2008 08:52:46 +0000"  >&lt;p&gt;also, need the second patch  to fix a NPE where routes can be uninitialized.&lt;/p&gt;</comment>
                            <comment id="12947760" author="davsclaus" created="Wed, 2 Jul 2008 19:54:32 +0000"  >&lt;p&gt;Willem Jiang has commited the patch. However unit test fails on my local laptop:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-------------------------------------------------------------------------------
Test set: org.apache.camel.component.jms.AggregratedJmsRouteTest
-------------------------------------------------------------------------------
Tests run: 2, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 28.204 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testJmsMulticastAndAggregration(org.apache.camel.component.jms.AggregratedJmsRouteTest)  Time elapsed: 21.625 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.AssertionError: mock:reply Received message count. Expected: &amp;lt;2&amp;gt; but was: &amp;lt;0&amp;gt;
            at org.apache.camel.component.mock.MockEndpoint.fail(MockEndpoint.java:662)
            at org.apache.camel.component.mock.MockEndpoint.assertEquals(MockEndpoint.java:644)
            at org.apache.camel.component.mock.MockEndpoint.assertIsSatisfied(MockEndpoint.java:223)
            at org.apache.camel.component.mock.MockEndpoint.assertIsSatisfied(MockEndpoint.java:199)
            at org.apache.camel.component.jms.AggregratedJmsRouteTest.testJmsMulticastAndAggregration(AggregratedJmsRouteTest.java:66)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12947748" author="wtam@iona.com" created="Wed, 2 Jul 2008 21:10:48 +0000"  >&lt;p&gt;Claus, could you enable debug and attached the camel-test.log from the camel-jms/target?  Will have a look.&lt;/p&gt;</comment>
                            <comment id="12947742" author="wtam@iona.com" created="Wed, 2 Jul 2008 21:40:07 +0000"  >&lt;p&gt;when debug logging is enabled, i sometimes get this failure (but i at least get one message delivered).  please see my patch that add a wait in the test.&lt;/p&gt;</comment>
                            <comment id="12947854" author="davsclaus" created="Fri, 4 Jul 2008 06:34:01 +0000"  >&lt;p&gt;If JMX is disable then it runs on my laptop&lt;/p&gt;</comment>
                            <comment id="12947711" author="wtam@iona.com" created="Fri, 4 Jul 2008 07:30:31 +0000"  >&lt;p&gt;Claus, turn on debug log and run the test, search the log for &quot;Routing Rules are&quot;.   See if you find something like:&lt;/p&gt;

&lt;p&gt;2008-07-02 17:44:37,698 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; DEBUG AggregratedJmsRouteTest        - Routing Rules are: [AggregatorRoute[Endpoint&lt;span class=&quot;error&quot;&gt;&amp;#91;jms:queue:test.b&amp;#93;&lt;/span&gt; -&amp;gt; sendTo(Endpoint&lt;span class=&quot;error&quot;&gt;&amp;#91;mock:result&amp;#93;&lt;/span&gt;)],  ....&lt;/p&gt;

&lt;p&gt;If you see &quot;EventDrivenRoute&quot; instead, that means you haven&apos;t picked up the fix.  Let me know.&lt;/p&gt;
</comment>
                            <comment id="12947759" author="wtam@iona.com" created="Fri, 4 Jul 2008 07:43:03 +0000"  >&lt;p&gt;Claus, more specifically, look for the endpoint &quot;jms:queue:reply&quot; and verify it is a &quot;AggregatorRoute[Endpoint&lt;span class=&quot;error&quot;&gt;&amp;#91;jms:queue:reply&amp;#93;&lt;/span&gt; -&amp;gt; sendTo(Endpoint&lt;span class=&quot;error&quot;&gt;&amp;#91;mock:reply&amp;#93;&lt;/span&gt;)]&quot;.  There are some EventDrivenConsumerRoute for other endpoints and they are fine.&lt;/p&gt;</comment>
                            <comment id="12947789" author="davsclaus" created="Fri, 4 Jul 2008 08:32:38 +0000"  >&lt;p&gt;Yes it works now out-of-the-box with no svn diffs.&lt;/p&gt;

&lt;p&gt;Thanks William for your hard work on this one.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462533" name="AggregatedJmsRouteTest.patch.txt" size="681" author="wtam@iona.com" created="Wed, 2 Jul 2008 21:40:07 +0000"/>
                            <attachment id="12462648" name="defaultcamelcontext_patch.txt" size="713" author="wtam@iona.com" created="Wed, 2 Jul 2008 08:52:46 +0000"/>
                            <attachment id="12462593" name="patch.txt" size="5987" author="wtam@iona.com" created="Wed, 2 Jul 2008 08:19:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 27 Jun 2008 22:44:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>83336</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01dhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5956</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>