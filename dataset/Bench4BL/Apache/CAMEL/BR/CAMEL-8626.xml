<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 03:21:29 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-8626/CAMEL-8626.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-8626] Leaking exchangesInFlightKeys in ManagedRoute</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8626</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Having a camel context with a single route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        onException(Throwable.class)
                .handled(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
                .process(handleException()); &lt;span class=&quot;code-comment&quot;&gt;// essentially  doing exchange.setException(someConvertedException);
&lt;/span&gt;
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:generalFlow&quot;&lt;/span&gt;)
                .routingSlip(property(GeneralFlowRoute.class.getName()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;started from Spring:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &amp;lt;camelContext id=&lt;span class=&quot;code-quote&quot;&gt;&quot;flows&quot;&lt;/span&gt; xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;        &amp;lt;template id=&lt;span class=&quot;code-quote&quot;&gt;&quot;template&quot;&lt;/span&gt; defaultEndpoint=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:generalFlow&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;routeBuilder ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;generalFlow&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;/camelContext&amp;gt;

    &amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;generalFlow&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.blabla.GeneralFlowRoute&quot;&lt;/span&gt;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;During performance test both exchangesInFlightKeys  and exchangesInFlightStartTimestamps are accumulating over time.&lt;/p&gt;

&lt;p&gt;But if the test is run in one thread with debug - nothing is accumulated.&lt;/p&gt;

&lt;p&gt;Issue found after migration from 2.14.1 to 2.15.1&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 8 u 40 64 bit, Linux&lt;/p&gt;</environment>
        <key id="12820555">CAMEL-8626</key>
            <summary>Leaking exchangesInFlightKeys in ManagedRoute</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="matihost">Mateusz Nowakowski</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Apr 2015 15:15:31 +0000</created>
                <updated>Mon, 20 Apr 2015 09:17:08 +0000</updated>
                            <resolved>Sun, 19 Apr 2015 07:03:08 +0000</resolved>
                                    <version>2.15.1</version>
                                    <fixVersion>2.15.2</fixVersion>
                    <fixVersion>2.16.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14492533" author="matihost" created="Mon, 13 Apr 2015 15:45:32 +0000"  >&lt;p&gt;Output from Eclipse Memory Analizer Tool&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; Name                                                                                                              | Shallow Heap | Retained Heap
-------------------------------------------------------------------------------------------------------------------------------------------------------
org.apache.camel.management.mbean.ManagedSuspendableRoute @ 0xa8ac4cf0                                                  |          128 |    33&#160;939&#160;752
|- &amp;lt;class&amp;gt; class org.apache.camel.management.mbean.ManagedSuspendableRoute @ 0xa8ecfd20                                 |            0 |             0
|- lastExchangeFailureExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x8b01cb68  ID-plabq10-dev-sabre-com-21992-1428925014784-0-9822762  |           24 |           152
|- lastExchangeCompletedExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x9b134df8  ID-plabq10-dev-sabre-com-21992-1428925014784-0-9823226|           24 |           152
|- context org.apache.camel.spring.SpringCamelContext @ 0xa8272878                                                      |          384 |        60&#160;760
|- exchangesInFlightKeys java.util.concurrent.ConcurrentHashMap @ 0xa87d7358                                            |           64 |     4&#160;977&#160;264
|- exchangesTotal org.apache.camel.management.mbean.Statistic @ 0xa8aad000                                              |           40 |            40
|- resetTimestamp org.apache.camel.management.mbean.Statistic @ 0xa8aad028                                              |           40 |            40
|- exchangesCompleted org.apache.camel.management.mbean.Statistic @ 0xa8aad050                                          |           40 |            40
|- exchangesFailed org.apache.camel.management.mbean.Statistic @ 0xa8aad078                                             |           40 |            40
|- exchangesInflight org.apache.camel.management.mbean.Statistic @ 0xa8aad0a0                                           |           40 |            40
|- failuresHandled org.apache.camel.management.mbean.Statistic @ 0xa8aad0c8                                             |           40 |            40
|- redeliveries org.apache.camel.management.mbean.Statistic @ 0xa8aad0f0                                                |           40 |            40
|- externalRedeliveries org.apache.camel.management.mbean.Statistic @ 0xa8aad118                                        |           40 |            40
|- minProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad140                                           |           40 |            40
|- maxProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad168                                           |           40 |            40
|- totalProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad190                                         |           40 |            40
|- lastProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad1b8                                          |           40 |            40
|- deltaProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad1e0                                         |           40 |            40
|- meanProcessingTime org.apache.camel.management.mbean.Statistic @ 0xa8aad208                                          |           40 |            40
|- firstExchangeCompletedTimestamp org.apache.camel.management.mbean.Statistic @ 0xa8aad230                             |           40 |            40
|- firstExchangeFailureTimestamp org.apache.camel.management.mbean.Statistic @ 0xa8aad258                               |           40 |            40
|- lastExchangeCompletedTimestamp org.apache.camel.management.mbean.Statistic @ 0xa8aad280                              |           40 |            40
|- lastExchangeFailureTimestamp org.apache.camel.management.mbean.Statistic @ 0xa8aad2a8                                |           40 |            40
|- load org.apache.camel.management.mbean.LoadTriplet @ 0xa8aad2d0                                                      |           40 |            40
|- exchangesInFlightStartTimestamps java.util.concurrent.ConcurrentSkipListMap @ 0xa8ab4850                             |           48 |     4&#160;421&#160;800
-------------------------------------------------------------------------------------------------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And some statistics values:&lt;/p&gt;

&lt;p&gt;exchangesInFlightKeys  -&amp;gt; 98175 non-empty entries&lt;br/&gt;
exchangesTotal.value 4911592&lt;br/&gt;
exchangesCompleted.value 4788850&lt;br/&gt;
exchangesFailed.value 122742&lt;br/&gt;
exchangesInFlight.value  27&lt;br/&gt;
failuresHandled.value 0&lt;br/&gt;
failuresHandled.updateCount 0&lt;br/&gt;
redeliveries.value 0&lt;br/&gt;
externalRedeliveries.value 0&lt;/p&gt;</comment>
                            <comment id="14493644" author="davsclaus" created="Tue, 14 Apr 2015 06:15:07 +0000"  >&lt;p&gt;Thanks for reporting, its when an exchange had failed the leak happens. Not for succesfull exchanges.&lt;/p&gt;</comment>
                            <comment id="14493692" author="davsclaus" created="Tue, 14 Apr 2015 06:58:59 +0000"  >&lt;p&gt;attached fixed camel-core JAR&lt;/p&gt;</comment>
                            <comment id="14493694" author="davsclaus" created="Tue, 14 Apr 2015 06:59:29 +0000"  >&lt;p&gt;I have build a JAR with the fix, you are welcome to give a test. &lt;/p&gt;

&lt;p&gt;You can also build from source yourself&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/building.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.apache.org/building.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14493828" author="matihost" created="Tue, 14 Apr 2015 09:13:08 +0000"  >&lt;p&gt;Thanks for a fast fix.&lt;/p&gt;

&lt;p&gt;WIll run a test again and will have report tomorrow after 6 AM CDT.&lt;/p&gt;</comment>
                            <comment id="14495933" author="matihost" created="Wed, 15 Apr 2015 09:38:50 +0000"  >&lt;p&gt;Still exchangesInFlightStartTimestamps  leaking  (see MAT dump below)&lt;/p&gt;

&lt;p&gt;However it is a case of one of ManagedSuspendableRoute object out of existing 214 in the system.&lt;/p&gt;

&lt;p&gt;It is for a route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:loopV300&quot;&lt;/span&gt;)
                .choice().when(property(WHILE_COUNTER).isGreaterThan(0))
                    &lt;span class=&quot;code-comment&quot;&gt;// some procesing
&lt;/span&gt;                    .setProperty(WHILE_COUNTER, decrementProperty(WHILE_COUNTER))
                    .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:loopV300&quot;&lt;/span&gt;)
                .end();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;MAT dump:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; Name                                                                                                              | Shallow Heap | Retained Heap
-------------------------------------------------------------------------------------------------------------------------------------------------------
org.apache.camel.management.mbean.ManagedSuspendableRoute @ 0x78b76a5e8                                                 |          128 |   153 059 616
|- &amp;lt;class&amp;gt; class org.apache.camel.management.mbean.ManagedSuspendableRoute @ 0x789ef31b0                                |            0 |             0
|- lastExchangeCompletedExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x782074c98  ID-plabq10-dev-sabre-com-30368-1429011401321-0-934556|           24 |           152
|- context org.apache.camel.spring.SpringCamelContext @ 0x788396c88                                                     |          384 |        83 344
|- exchangesInFlightStartTimestamps java.util.concurrent.ConcurrentSkipListMap @ 0x789fb5760                            |           48 |   153 056 936
|- exchangesInFlightKeys java.util.concurrent.ConcurrentHashMap @ 0x789fb5790                                           |           48 |         1 792
|- route org.apache.camel.impl.EventDrivenConsumerRoute @ 0x78a7b88d8                                                   |           72 |           592
|- exchangesTotal org.apache.camel.management.mbean.Statistic @ 0x78bb01220                                             |           40 |            40
|- resetTimestamp org.apache.camel.management.mbean.Statistic @ 0x78bb01248                                             |           40 |            40
|- exchangesCompleted org.apache.camel.management.mbean.Statistic @ 0x78bb01270                                         |           40 |            40
|- exchangesFailed org.apache.camel.management.mbean.Statistic @ 0x78bb01298                                            |           40 |            40
|- exchangesInflight org.apache.camel.management.mbean.Statistic @ 0x78bb012c0                                          |           40 |            40
|- failuresHandled org.apache.camel.management.mbean.Statistic @ 0x78bb012e8                                            |           40 |            40
|- redeliveries org.apache.camel.management.mbean.Statistic @ 0x78bb01310                                               |           40 |            40
|- externalRedeliveries org.apache.camel.management.mbean.Statistic @ 0x78bb01338                                       |           40 |            40
|- minProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb01360                                          |           40 |            40
|- maxProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb01388                                          |           40 |            40
|- totalProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb013b0                                        |           40 |            40
|- lastProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb013d8                                         |           40 |            40
|- deltaProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb01400                                        |           40 |            40
|- meanProcessingTime org.apache.camel.management.mbean.Statistic @ 0x78bb01428                                         |           40 |            40
|- firstExchangeCompletedTimestamp org.apache.camel.management.mbean.Statistic @ 0x78bb01450                            |           40 |            40
|- firstExchangeFailureTimestamp org.apache.camel.management.mbean.Statistic @ 0x78bb01478                              |           40 |            40
|- lastExchangeCompletedTimestamp org.apache.camel.management.mbean.Statistic @ 0x78bb014a0                             |           40 |            40
|- lastExchangeFailureTimestamp org.apache.camel.management.mbean.Statistic @ 0x78bb014c8                               |           40 |            40
|- load org.apache.camel.management.mbean.LoadTriplet @ 0x78bb014f0                                                     |           40 |            40
|- firstExchangeCompletedExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x790515100  ID-plabq10-dev-sabre-com-30368-1429011401321-0-2    |           24 |           136
|- firstExchangeFailureExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x7928bb518  ID-plabq10-dev-sabre-com-30368-1429011401321-0-223200 |           24 |           152
|- lastExchangeFailureExchangeId java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; @ 0x79931b290  ID-plabq10-dev-sabre-com-30368-1429011401321-0-834588  |           24 |           152
-------------------------------------------------------------------------------------------------------------------------------------------------------


route.endpoint direct:&lt;span class=&quot;code-comment&quot;&gt;//loopV300
&lt;/span&gt;exchangesInFlightKeys size = 0
exchangesInFlightStartTimestamps  size = 1 401 792
exchangeInFlight.value 0
exchangesTotal.value 1 869 106
exchangedFailed.value 10
exchangesCompleted.value 1 869 096

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="14499367" author="davsclaus" created="Fri, 17 Apr 2015 07:04:31 +0000"  >&lt;p&gt;Ah you may do something bad/odd with your &quot;while loop trick&quot;. There is a loop eip you should favor to use&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/loop&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.apache.org/loop&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14499368" author="davsclaus" created="Fri, 17 Apr 2015 07:05:20 +0000"  >&lt;p&gt;If you look using jconsole / jvisualvm there is a inflight repository mbean under services. What does it say?&lt;/p&gt;</comment>
                            <comment id="14499433" author="davsclaus" created="Fri, 17 Apr 2015 07:57:28 +0000"  >&lt;p&gt;Okay found the leak when you call the same route recursive which you do in your &quot;while loop&quot;. I will commit a fix and attach a new JAR for you to test&lt;/p&gt;</comment>
                            <comment id="14499446" author="davsclaus" created="Fri, 17 Apr 2015 08:12:27 +0000"  >&lt;p&gt;Attached the updated JAR with a new fix.&lt;/p&gt;</comment>
                            <comment id="14501470" author="matihost" created="Sat, 18 Apr 2015 16:55:44 +0000"  >&lt;p&gt;Thanks for the second patch.&lt;/p&gt;

&lt;p&gt;First tests and dumps shows that the leak is gone. I will have full result tests tomorrow.&lt;/p&gt;

&lt;p&gt;When is 1.15.2 going to be released?&lt;/p&gt;

</comment>
                            <comment id="14501720" author="davsclaus" created="Sun, 19 Apr 2015 07:03:08 +0000"  >&lt;p&gt;Thanks for testing.&lt;/p&gt;

&lt;p&gt;Follow this talk about the 2.15.2 release&lt;br/&gt;
&lt;a href=&quot;http://camel.465427.n5.nabble.com/Apache-Camel-2-15-2-Patch-Release-td5765747.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.465427.n5.nabble.com/Apache-Camel-2-15-2-Patch-Release-td5765747.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14502554" author="matihost" created="Mon, 20 Apr 2015 09:17:08 +0000"  >&lt;p&gt;Finally confirming that the issues are gone.&lt;br/&gt;
Thanks&lt;br/&gt;
Looking forward the patched release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12726101" name="camel-core-2.15.2-SNAPSHOT.jar" size="3132151" author="davsclaus" created="Fri, 17 Apr 2015 08:12:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Apr 2015 06:15:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2d6mv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>