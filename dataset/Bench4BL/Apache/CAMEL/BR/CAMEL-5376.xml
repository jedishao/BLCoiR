<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun Dec 04 01:05:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-5376/CAMEL-5376.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-5376] Mail component does not work as expected (Email Deletion is partially broken et Disconnect does not work well)</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-5376</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The way disconnect is implemented causes issues with some other options of the consumer. For instance &quot;disconnect&quot; option is not compatible with &quot;delete&quot; option.&lt;/p&gt;

&lt;p&gt;The delete action is done in completion action (processCommit: line 185). On line 305, processCommit method checks if folder is open, but &quot;disconnect&quot; option force folder at null value at the end of poll method (Line 149).&lt;/p&gt;

&lt;p&gt;I guess disconnect method should be called on completion after any other completion actions occured: It is not possible to make completion actions if connection to mail server is closed.&lt;/p&gt;

&lt;p&gt;The result of the usage of disconnect option and delete option is a NullPointerException on test: &quot;if (!folder.isOpen())&quot; statement on line 308.&lt;/p&gt;

&lt;p&gt;Issue should be always reproductible.&lt;/p&gt;

&lt;p&gt;I let you fix the priority of the issue, but it is an annoying issue even if there is a workaround by disabling disconnect option ...&lt;/p&gt;</description>
                <environment>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Exchange, but should happen with any mail server, since it is not directly related to (See above)&lt;/li&gt;
	&lt;li&gt;Apache James Server 3.X&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="12594930">CAMEL-5376</key>
            <summary>Mail component does not work as expected (Email Deletion is partially broken et Disconnect does not work well)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="alexiskinsella">Alexis Kinsella</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jun 2012 12:38:35 +0000</created>
                <updated>Wed, 4 Sep 2013 09:05:09 +0000</updated>
                            <resolved>Mon, 26 Aug 2013 18:02:36 +0000</resolved>
                                    <version>2.9.5</version>
                    <version>2.10.3</version>
                                    <fixVersion>2.11.2</fixVersion>
                    <fixVersion>2.12.0</fixVersion>
                                    <component>camel-mail</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13396521" author="davsclaus" created="Tue, 19 Jun 2012 05:15:04 +0000"  >&lt;p&gt;Can you post more details, such as the route you use? And the stacktrace as well.&lt;/p&gt;</comment>
                            <comment id="13400123" author="davsclaus" created="Sun, 24 Jun 2012 10:06:48 +0000"  >&lt;p&gt;Alexis, any update on this, so we can help you?&lt;/p&gt;</comment>
                            <comment id="13400131" author="alexiskinsella" created="Sun, 24 Jun 2012 11:01:26 +0000"  >&lt;p&gt;Hello, I will have some time this week to provide some basic example for this issue. In the meantime, I found some workaround by avoiding disconnection from mail server.&lt;/p&gt;</comment>
                            <comment id="13532354" author="alexiskinsella" created="Fri, 14 Dec 2012 14:59:21 +0000"  >&lt;p&gt;Hi, here are some news about this issue.&lt;/p&gt;

&lt;p&gt;Let me restart some explanations about some issues on mail consumer.&lt;/p&gt;

&lt;p&gt;First problem:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When you consume mails with delete option enabled, mails consumed will be marked with DELETED flag on completion callback. Not sure, but I guess completion is async since it happens at the end of exchange processing. Anyway, mail deletion is effective on folder close.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Folder close action is triggered in method &lt;em&gt;poll&lt;/em&gt;, just after &lt;em&gt;processBatch&lt;/em&gt; method call which is in charge of processing mails. Therefore message completion, which mark messages as deleted, may happen after folder close which is in charge of sending deleted information back to the mail server.&lt;/p&gt;

&lt;p&gt;As a consequence some messages may remain deleted in inflight messages, but instruction is never sent back to mail server. &lt;/p&gt;

&lt;p&gt;Folder close (and deletion of messages) should happen after completion of last message. If you try to stop a route with inflight messages, you get a gracefull shutdown with 300 seconds to wait.&lt;/p&gt;

&lt;p&gt;Do you think process of mail deletion can be improved ? -&amp;gt; Is it possible to safely close folder after completion of messages ?&lt;/p&gt;

&lt;p&gt;Or can you let open folder as long as connection is open or something like that ?&lt;/p&gt;

&lt;p&gt;In case you want to ease your tests, I developped some tooling to bootstrap an in memory pop3 server based on Apache James Server. You can easily check behaviors of each sides. Source code is here: &lt;a href=&quot;https://github.com/akinsella/mock-servers&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/akinsella/mock-servers&lt;/a&gt; (pop3 and imap4 mock servers are stable, others are experimental)&lt;/p&gt;

&lt;p&gt;My testing protocol is the following : &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start pop3 mock server with 100 mails injected in mail box:&lt;/li&gt;
	&lt;li&gt;Start a Camel context that consume 5 mails at a time, mail is sent on some simple route forwarding message to some ActiveMQ JMS queue.&lt;br/&gt;
 from(&quot;pop3://jode@localhost:9110?debugMode=true&amp;amp;fetchSize=5&amp;amp;delete=true&amp;amp;consumer.delay=1000&amp;amp;connectionTimeout=20000&amp;amp;mapMailMessage=false&quot;)&lt;br/&gt;
   .to(&quot;activemq:queue:someQueue&quot;);&lt;/li&gt;
	&lt;li&gt;On first poll, you can check with debug of MailConsumer that usualy at least one message is not deleted on server (Server receives 4 delete commands instead of 5 expected), and therefore one message stay inflight&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;disconnect=true option is also broken due to the sync close of folder and connection  and async process of message deletion.&lt;/p&gt;

&lt;p&gt;You can mail me if you have any question.&lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;Alexis&lt;/p&gt;</comment>
                            <comment id="13533951" author="alexiskinsella" created="Mon, 17 Dec 2012 14:33:53 +0000"  >&lt;p&gt;Hi, I tried to find some nice workaround, but it is a little bit tricky due to the way pop3 messages are deleted through close of the folder.&lt;/p&gt;

&lt;p&gt;I ended by fixing the issue with a CountDownLatch on the number of exchanges to process before closing resources. CountDownLatch is decremented on completion of exchange&lt;br/&gt;
At the end of poll the countdownlatch timeouts if await time is not over, and therefore never locks the consumer. &lt;br/&gt;
I added a timeout having for duration the delay of the timer, maybe there should be a new configuration property dedicated to this new value.&lt;/p&gt;

&lt;p&gt;By the way, all messages are correctly deleted on each poll, and the fix rely mainly on the fact that release of resources is done after completion of the process of last message.&lt;/p&gt;

&lt;p&gt;I added some guarding on countdownlatch to avoid poll if countdownlatch is not null, it should not happen since countdownlatch is nulled on finally clause.&lt;/p&gt;

&lt;p&gt;I hope it will help to improve mail components. &lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;Aleixs&lt;/p&gt;</comment>
                            <comment id="13559620" author="davsclaus" created="Tue, 22 Jan 2013 13:21:45 +0000"  >&lt;p&gt;Please do &lt;b&gt;not&lt;/b&gt; change priority level. &lt;/p&gt;</comment>
                            <comment id="13559637" author="alexiskinsella" created="Tue, 22 Jan 2013 13:52:16 +0000"  >&lt;p&gt;Ok, my mistake.&lt;/p&gt;</comment>
                            <comment id="13559638" author="alexiskinsella" created="Tue, 22 Jan 2013 13:54:27 +0000"  >&lt;p&gt;By the way, is there a change to fix this issue in 2.9.X or 2.10.X versions ?&lt;/p&gt;</comment>
                            <comment id="13559890" author="muellerc" created="Tue, 22 Jan 2013 19:03:37 +0000"  >&lt;p&gt;Yes, both branches are still supported. It depends when we fix this issue.&lt;/p&gt;</comment>
                            <comment id="13615101" author="muellerc" created="Wed, 27 Mar 2013 10:43:40 +0000"  >&lt;p&gt;Alexis, can you attach a patch instead of the new implementation. This makes it much more easier for us to review what you changed (&lt;a href=&quot;http://camel.apache.org/contributing.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.apache.org/contributing.html&lt;/a&gt;).&lt;br/&gt;
And we also have to have a unit test which show the issue which is resolved after applying the patch. Do you also consider to provide an unit test?&lt;br/&gt;
This all will speed up applying your proposed change...&lt;/p&gt;</comment>
                            <comment id="13635027" author="alexiskinsella" created="Thu, 18 Apr 2013 09:35:35 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I provided the change as a patch based on git diff command between the patched source code and original 2.9.4 version.&lt;/p&gt;

&lt;p&gt;Sorry, there is no test to validate the change.&lt;/p&gt;</comment>
                            <comment id="13750329" author="davsclaus" created="Mon, 26 Aug 2013 18:02:36 +0000"  >&lt;p&gt;mail consumer commit/rollback logc do not allow handover to ensure running on same thread as polling to use the same mail session.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12666688">CAMEL-6703</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12579297" name="MailConsumer.diff" size="11580" author="alexiskinsella" created="Thu, 18 Apr 2013 09:33:45 +0000"/>
                            <attachment id="12561291" name="MailConsumer.java" size="18170" author="alexiskinsella" created="Mon, 17 Dec 2012 14:33:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 19 Jun 2012 05:15:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241249</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i026pj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10688</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>