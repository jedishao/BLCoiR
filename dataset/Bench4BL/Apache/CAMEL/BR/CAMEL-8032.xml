<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 02:14:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-8032/CAMEL-8032.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-8032] FileUtil leaks FileInputStream when renameFile fails due to permission issue</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8032</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have a simple camel route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;camelContext xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;    &amp;lt;route&amp;gt;
        &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;file:C:/tmp/data/in?include=.*$&amp;amp;amp;move=C:/tmp/data/done/${file:onlyname}-${exchangeId}&quot;&lt;/span&gt; /&amp;gt;
        &amp;lt;setHeader headerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;CamelFileName&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;simple&amp;gt;${file:onlyname}-${exchangeId}&amp;lt;/simple&amp;gt;
        &amp;lt;/setHeader&amp;gt;
        &amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;file:C:/tmp/data/out&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/route&amp;gt;
&amp;lt;/camelContext&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the destination folder &quot;C:/tmp/data/done/&quot; for the move operation does not allow writing, then the file dropped to the &quot;C:/tmp/data/in/&quot; folder will be repeatedly polled, processed and rolled back due to &quot;Access is denied&quot; exception.&lt;/p&gt;

&lt;p&gt;Even if we fix the permission issue on the folder &quot;C:/tmp/data/done/&quot; to allow writing, the problem still persists and above endless cycle continues. However the reason for the issue will be a bit different now. It is caused by deletion failure to the file from &quot;C:/tmp/data/in/&quot; folder after successful FileUtil.renameFile() operation due to fact that something is still holding the file handle. &lt;/p&gt;

&lt;p&gt;The root cause is in the function FileUtil.copyFile():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void copyFile(File from, File to) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        FileChannel in = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(from).getChannel();
        FileChannel out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(to).getChannel();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isTraceEnabled()) {
                LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Using FileChannel to copy from: &quot;&lt;/span&gt; + in + &lt;span class=&quot;code-quote&quot;&gt;&quot; to: &quot;&lt;/span&gt; + out);
            }

            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size = in.size();
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; position = 0;
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (position &amp;lt; size) {
                position += in.transferTo(position, BUFFER_SIZE, out);
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            IOHelper.close(in, from.getName(), LOG);
            IOHelper.close(out, to.getName(), LOG);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the destination folder &quot;C:/tmp/data/done/&quot; for move operation is not allowed for writing, the creation of the FileOutputStream will throw an exception straight away. However, because both FileInputStream and FileOutputStream are created outside the try{}...finally{} block, the FileInputStream is never closed. It still holds handle to the file and caused FileSystem unable to delete it. Therefore caused the whole route to fail. &lt;/p&gt;

&lt;p&gt;The solution is quite simple, we just need to create the Input/Output streams inside try{}...finally{} loop to make sure that the Input/Output streams get closed if something happens during creating of these objects.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12754432">CAMEL-8032</key>
            <summary>FileUtil leaks FileInputStream when renameFile fails due to permission issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="joeluo">Joe Luo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Nov 2014 10:24:18 +0000</created>
                <updated>Tue, 11 Nov 2014 13:13:04 +0000</updated>
                            <resolved>Tue, 11 Nov 2014 13:13:04 +0000</resolved>
                                    <version>2.12.3</version>
                                    <fixVersion>2.13.4</fixVersion>
                    <fixVersion>2.14.1</fixVersion>
                    <fixVersion>2.15.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14206404" author="davsclaus" created="Tue, 11 Nov 2014 13:13:04 +0000"  >&lt;p&gt;Thanks for the detailed report and the patch Joe.&lt;/p&gt;

&lt;p&gt;Applied that to the branches.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12680775" name="patch.txt" size="904" author="joeluo" created="Tue, 11 Nov 2014 10:25:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 11 Nov 2014 13:13:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 3 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2288v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>