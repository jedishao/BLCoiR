<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:50:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-3442/CAMEL-3442.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-3442] JBI ClassLoading issue in SMX 4.x in OsgiPackageScanClassResolver</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-3442</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-3302&quot; title=&quot;OsgiPackageScanClassResolver should have Non-OSGi classloader check fallback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-3302&quot;&gt;&lt;del&gt;CAMEL-3302&lt;/del&gt;&lt;/a&gt; introduced a fallback when using JBI in Apache ServiceMix 4.x.&lt;/p&gt;

&lt;p&gt;However it may lead to an issue with ConcurrentModificationException when traversing the list of classloaders.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader : &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.getClassLoaders()) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isOsgiClassloader(classLoader)) {
                    find(test, packageName, classLoader, classes);
                }
            }  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The for loop is line 62 which causes the exception.&lt;/p&gt;

&lt;p&gt;Issue reported here&lt;br/&gt;
&lt;a href=&quot;http://camel.465427.n5.nabble.com/ServiceMix-4-Fuse-4-3-0-fuse-03-00-Problems-running-JBI-example-examples-camel-td3309088.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.465427.n5.nabble.com/ServiceMix-4-Fuse-4-3-0-fuse-03-00-Problems-running-JBI-example-examples-camel-td3309088.html&lt;/a&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12493603">CAMEL-3442</key>
            <summary>JBI ClassLoading issue in SMX 4.x in OsgiPackageScanClassResolver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="davsclaus">Claus Ibsen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Dec 2010 18:56:40 +0000</created>
                <updated>Sun, 24 Apr 2011 09:57:08 +0000</updated>
                            <resolved>Sun, 19 Dec 2010 09:18:54 +0000</resolved>
                                    <version>2.5.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>osgi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12972888" author="ffang" created="Sun, 19 Dec 2010 02:23:15 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;I just checked the patch which I appended with &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-3302&quot; title=&quot;OsgiPackageScanClassResolver should have Non-OSGi classloader check fallback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-3302&quot;&gt;&lt;del&gt;CAMEL-3302&lt;/del&gt;&lt;/a&gt;, my original patch about the concern code is like&lt;/p&gt;

&lt;p&gt;+           Set&amp;lt;ClassLoader&amp;gt; set = getClassLoaders();&lt;br/&gt;
+            for (ClassLoader classLoader : set.toArray(new ClassLoader&lt;span class=&quot;error&quot;&gt;&amp;#91;set.size()&amp;#93;&lt;/span&gt;)) {&lt;br/&gt;
+                if (!isOsgiClassloader(classLoader)) &lt;/p&gt;
{
+                    find(test, packageName, classLoader, classes);
+                }
&lt;p&gt;+            }&lt;/p&gt;

&lt;p&gt;With this patch, there should be no ConcurrentModificationException on the Iterator.  Willem revised my patch probably for better performance but introduce potential ConcurrentModificationException.&lt;/p&gt;

&lt;p&gt;@Willem&lt;br/&gt;
Would you please re-check  my patch,  as classloaders set size isn&apos;t big, so change it to an array isn&apos;t a big deal IMHO, but this can avoid concurrent problem(such as ConcurrentModificationException).&lt;br/&gt;
Another solution I can come up with is change getClassLoaders() in DefaultPackageScanClassResolver&lt;/p&gt;

&lt;p&gt;use&lt;br/&gt;
classLoaders = Collections.synchronizedSet(new HashSet&amp;lt;ClassLoader&amp;gt;()); &lt;/p&gt;

&lt;p&gt;instead of&lt;br/&gt;
classLoaders = new HashSet&amp;lt;ClassLoader&amp;gt;();&lt;/p&gt;

&lt;p&gt;But this also bring in performance impact, I still prefer the way in my original patch.&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;



</comment>
                            <comment id="12972929" author="davsclaus" created="Sun, 19 Dec 2010 07:27:01 +0000"  >&lt;p&gt;Thanks Freeman&lt;/p&gt;

&lt;p&gt;I think we should fix this in the core, so it returns a new set when invoking &lt;tt&gt;getClassLoaders&lt;/tt&gt;, that will fix this issue for other custom package scan resolvers that may encounter similar issue.&lt;/p&gt;

&lt;p&gt;Something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;&amp;gt; getClassLoaders() {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; set to avoid any concurrency issues in other runtimes such as OSGi
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.unmodifiableSet(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LinkedHashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;&amp;gt;(classLoaders));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12972939" author="davsclaus" created="Sun, 19 Dec 2010 09:18:54 +0000"  >&lt;p&gt;trunk: 1050776.&lt;/p&gt;</comment>
                            <comment id="12973138" author="davsclaus" created="Mon, 20 Dec 2010 08:37:39 +0000"  >&lt;p&gt;trunk: 1051019.&lt;/p&gt;

&lt;p&gt;Fixed unit test failure&lt;/p&gt;</comment>
                            <comment id="13023681" author="davsclaus" created="Sun, 24 Apr 2011 09:57:08 +0000"  >&lt;p&gt;Closing all resolved tickets from 2010 or older&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12487851">CAMEL-3302</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 19 Dec 2010 02:23:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76250</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01urr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8754</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>