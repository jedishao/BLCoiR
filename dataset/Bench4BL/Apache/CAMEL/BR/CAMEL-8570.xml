<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 01:36:11 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-8570/CAMEL-8570.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-8570] NullPointerException when using CXF-component in a spring-boot application with loglevel &gt;= INFO</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8570</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I get a NullPointerException when using log-level INFO or finer in a spring-boot application with CXF. &lt;/p&gt;

&lt;p&gt;The exception is thrown from DefaultCamelContext.java:2449, where it tries to log how many routes have been started.&lt;/p&gt;

&lt;p&gt;I have made an example project to reproduce it, it&apos;s available here: &lt;br/&gt;
&lt;a href=&quot;https://github.com/jakobthun/spring-boot-camel-cxf-logging-bug&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/jakobthun/spring-boot-camel-cxf-logging-bug&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have tried with camel version: 2.15.0 &amp;amp; 2.15-SNAPSHOT. Both have the same behaviour.&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Andrew Block started som analysis:&lt;/ins&gt;&lt;br/&gt;
It is running into issues in this code block which is executed at logging level &amp;gt;= INFO &lt;/p&gt;

&lt;p&gt;        if (log.isInfoEnabled()) { &lt;br/&gt;
            // count how many routes are actually started &lt;br/&gt;
            int started = 0; &lt;br/&gt;
            for (Route route : getRoutes()) { &lt;br/&gt;
                if (getRouteStatus(route.getId()).isStarted()) &lt;/p&gt;
{ 
                    started++; 
                }
&lt;p&gt; &lt;br/&gt;
            } &lt;br/&gt;
            log.info(&quot;Total &quot; + getRoutes().size() + &quot; routes, of which &quot; + started + &quot; is started.&quot;); &lt;br/&gt;
            log.info(&quot;Apache Camel &quot; + getVersion() + &quot; (CamelContext: &quot; + getName() + &quot;) started in &quot; + TimeUtils.printDuration(stopWatch.taken())); &lt;br/&gt;
        } &lt;/p&gt;

&lt;p&gt;The exception occurs when the status for the route is pulled from the route service. It is null and the exception is thrown. The route is initially spun up but then refreshes when the CXF consumer is initialized. &lt;/p&gt;

&lt;p&gt;Swapping it to test with a direct consumer does not result in a similar situation and startup succeeds at all logging level. &lt;/p&gt;

&lt;p&gt;It appears the route is not being registered with the route service&lt;/p&gt;</description>
                <environment></environment>
        <key id="12786620">CAMEL-8570</key>
            <summary>NullPointerException when using CXF-component in a spring-boot application with loglevel &gt;= INFO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hekonsek">Henryk Konsek</assignee>
                                    <reporter username="jakob.thun">Jakob Thun</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Mar 2015 07:24:09 +0000</created>
                <updated>Mon, 7 Sep 2015 09:55:01 +0000</updated>
                            <resolved>Mon, 7 Sep 2015 09:55:01 +0000</resolved>
                                    <version>2.15.0</version>
                    <version>2.15.1</version>
                                    <fixVersion>2.16.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-cxf</component>
                    <component>camel-spring-boot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14387531" author="sabre1041" created="Mon, 30 Mar 2015 22:34:48 +0000"  >&lt;p&gt;Part of the issue is due to the CXF bus not being registered to the Camel endpoint. When the endpoint spins up, it finds that the bus is null and instantiates it. By doing so, the BusApplicationContext refreshes the Spring context which causes the Camel Spring Boot RoutesCollector to recreate the routes in the context (routes that are spun up are shut down and reinitialized). By doing so, the route which was registered in the routeservice is no longer present which causes the nullpointerexception. To mitigate, we can define the CXFEndpoint and specify the bus as follows within the PingPongRoute class&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Autowired
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Bus bus;
	
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		....
		CxfEndpoint endpoint = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CxfEndpoint();
		endpoint.setAddress(&lt;span class=&quot;code-quote&quot;&gt;&quot;/PingPong&quot;&lt;/span&gt;);
		endpoint.setBus(bus);
		endpoint.setServiceClass(PingPongService.class);

		&lt;span class=&quot;code-comment&quot;&gt;// @formatter:off
&lt;/span&gt;		from(endpoint)	
               ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14388323" author="jakob.thun" created="Tue, 31 Mar 2015 09:47:42 +0000"  >&lt;p&gt;Glad to hear. Tried it, and it is working fine. Then there is a fully functional workaround.&lt;/p&gt;

&lt;p&gt;Is there something wrong with my way of configuring the Bus? &lt;br/&gt;
Should it be done in a different way in my code, or is it still to be considered a defect?&lt;/p&gt;</comment>
                            <comment id="14388444" author="jakob.thun" created="Tue, 31 Mar 2015 12:15:38 +0000"  >&lt;p&gt;I was a bit too quick in respoding with my previous comment. The workaround described above got successful startup of routes, but the service itself did not execute as expected.&lt;/p&gt;

&lt;p&gt;Instead I got a NullPointer in: &lt;em&gt;DefaultConsumer.java:88&lt;/em&gt;&lt;br/&gt;
UnitOfWork uow = &lt;b&gt;endpoint.getCamelContext()&lt;/b&gt;.getUnitOfWorkFactory().createUnitOfWork(exchange);&lt;/p&gt;

&lt;p&gt;getCamelContext returns null, that is solved by getting the camelContext instance and setting it on the endpoint, as below:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Autowired
Bus bus;
@Autowired
CamelContext camelContext;

@Override
public void configure() throws Exception {

	CxfEndpoint cxfPingPongEndpoint = new CxfEndpoint();
	cxfPingPongEndpoint.setAddress(&quot;/PingPong&quot;);
	cxfPingPongEndpoint.setBus(bus);
	cxfPingPongEndpoint.setCamelContext(camelContext);
	cxfPingPongEndpoint.setServiceClass(PingPongService.class);

	// @formatter:off
	from(cxfPingPongEndpoint)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14389746" author="jakob.thun" created="Wed, 1 Apr 2015 00:24:23 +0000"  >&lt;p&gt;Tried with camel 2.16-SNAPSHOT and the defect shown by my example works with that version.&lt;br/&gt;
I also noticed that it was enough to set &lt;em&gt;camel-spring-boot&lt;/em&gt; to &lt;em&gt;2.16-SNAPSHOT&lt;/em&gt;, so I guess the fix is somewhere in that component.&lt;/p&gt;

&lt;p&gt;While looking for a solution I saw this &lt;a href=&quot;https://github.com/apache/camel/commit/84aab93c00c3521f59b7523a551c9f53da273aac&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;commit discussion&lt;/a&gt; in camel-spring-boot where Henryk seems to be spot on and says he will try to find a solution for bus-creation to work better with Spring 4: &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You need to refer your custom bus (cxf) in the endpoint URI:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;from(&quot;cxf:/incident?serviceClass=&quot; + IncidentService.class.getName() + &quot;&amp;amp;bus=#cxf&quot;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise Camel will try to create the bus for you. Unfortunately Camel refreshes Spring context while creating default bus, what collides a little bit with the Spring 4 application lifecycle.&lt;/p&gt;

&lt;p&gt;Please try it and let me know how it works. BTW I will use your example as a base for Camel+CXF tests. &lt;b&gt;I will also try to make camel-spring-boot and camel-cxf a bit smarter to handle bus registration nicely.&lt;/b&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It seems like he has already solved it in 2.16-SNAPSHOT. So this defect will be fixed in a future version, but I&apos;m not sure how we should handle it, should Henryk label it with correct fix versions or something, or should it just be closed?&lt;/p&gt;</comment>
                            <comment id="14392390" author="davsclaus" created="Thu, 2 Apr 2015 08:46:12 +0000"  >&lt;p&gt;Can you build and try with latest 2.15-SNAPSHOT ?&lt;/p&gt;</comment>
                            <comment id="14392559" author="jakob.thun" created="Thu, 2 Apr 2015 10:55:55 +0000"  >&lt;p&gt;Tried it again with 2.15-SNAPSHOT. Error is still there.&lt;/p&gt;

&lt;p&gt;I forced gradle to download the dependencies again to make sure I was not using some locally cached version. &lt;/p&gt;

&lt;p&gt;This is the version it downloaded with 2.15-SNAPSHOT:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-core/2.15-SNAPSHOT/camel-core-2.15-20150307.023702-161.jar
https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-spring-boot/2.15-SNAPSHOT/camel-spring-boot-2.15-20150307.024139-100.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I tried 2.15.1-SNAPSHOT. Error is there. Deps with timestamp:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-core/2.15.1-SNAPSHOT/camel-core-2.15.1-20150328.025219-17.jar
https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-spring-boot/2.15.1-SNAPSHOT/camel-spring-boot-2.15.1-20150328.025553-15.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I tried 2.15.2-SNAPSHOT: Error is there. Deps. with timestamp:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-core/2.15.2-SNAPSHOT/camel-core-2.15.2-20150402.024619-5.jar
https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-spring-boot/2.15.2-SNAPSHOT/camel-spring-boot-2.15.2-20150401.025036-4.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For full verification I tried 2.16-SNAPSHOT again. Success.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-core/2.16-SNAPSHOT/camel-core-2.16-20150402.024543-26-sources.jar
https://repository.apache.org/content/repositories/snapshots/org/apache/camel/camel-spring-boot/2.16-SNAPSHOT/camel-spring-boot-2.16-20150402.025258-24-sources.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also noticed that 2.16 might use a different version of spring (I saw these spring-jars being downloaded in the last test). Not sure if this means anything in relation to this issue:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;https://repo1.maven.org/maven2/org/springframework/spring-context/4.1.6.RELEASE/spring-context-4.1.6.RELEASE.jar
https://repo1.maven.org/maven2/org/springframework/spring-tx/4.1.6.RELEASE/spring-tx-4.1.6.RELEASE.jar
https://repo1.maven.org/maven2/org/springframework/spring-core/4.1.6.RELEASE/spring-core-4.1.6.RELEASE.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14487150" author="hekonsek" created="Thu, 9 Apr 2015 11:05:39 +0000"  >&lt;p&gt;I will take a look at this.&lt;/p&gt;</comment>
                            <comment id="14620275" author="davsclaus" created="Thu, 9 Jul 2015 10:24:00 +0000"  >&lt;p&gt;Jakub can you try with latest 2.15.2 release.&lt;/p&gt;</comment>
                            <comment id="14623310" author="jakob.thun" created="Sat, 11 Jul 2015 08:34:33 +0000"  >&lt;p&gt;Issue is still there in 2.15.2.&lt;br/&gt;
And it still works fine with 2.16-snapshot. (tried it again to verify)&lt;/p&gt;</comment>
                            <comment id="14733490" author="davsclaus" created="Mon, 7 Sep 2015 09:55:01 +0000"  >&lt;p&gt;Okay it works from next release onwards.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 30 Mar 2015 22:34:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27iuf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>