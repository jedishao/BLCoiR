<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 03:12:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-634/CAMEL-634.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-634] DeadLetterChannel default redelivery policy eclipsed expected transactional behaviour in a transacted route</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-634</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel routes get a DLC processor with a redelivery policy, which defaults to redeliverying a message to a destination processor up to 6 times.  In case of a transacted route it is preferable that DLC&apos;s delivery policy be reset to a single attempt, so that a fan-out transacted route would not hold tx locks on destinations for too long. &lt;/p&gt;

&lt;p&gt;The DLC&apos;s default redelivery policy has also made transactional tests not really testing tx behavior of Camel Components backed runtimes (jms brokers, etc), rather DLC would catch the exception and try to redeliver the message to destination processor and not letting the components to rollback native transactions initiated by components backed runtimes (jms, db)&lt;/p&gt;

&lt;p&gt;The attached patch installs a property into Camel Exchange that indicates weather a route is transacted. This is done in org.apache.camel.spring.spi.TransactionInterceptor.java&lt;/p&gt;

&lt;p&gt;DLC then checks if the flow is transacted and sets its redelivery policy to 1&lt;/p&gt;

&lt;p&gt;With this change JMS transactions are actually rolled back and messages are put back into the queue and then consumed again, verifying that brokers support transactions and can redeliver messages into Camel routes that were previously rolled back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12484978">CAMEL-634</key>
            <summary>DeadLetterChannel default redelivery policy eclipsed expected transactional behaviour in a transacted route</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="marat">Marat Bedretdinov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Jun 2008 22:09:21 +0000</created>
                <updated>Sun, 6 Jul 2008 06:30:56 +0000</updated>
                            <resolved>Tue, 1 Jul 2008 14:29:54 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                            <comments>
                            <comment id="12947582" author="davsclaus" created="Thu, 26 Jun 2008 04:09:05 +0000"  >&lt;p&gt;Marat thanks a lot for the patch, we appreciate all the hard work you do to report and fix the problems. Great work.&lt;/p&gt;

&lt;p&gt;As the 1.4 release is just about to get cut I would like to schedule this patch for 1.5. I am hoping that you don&apos;t mind this.&lt;/p&gt;</comment>
                            <comment id="12947725" author="marat" created="Thu, 26 Jun 2008 18:58:41 +0000"  >&lt;p&gt;Claus,&lt;/p&gt;

&lt;p&gt;I don&apos;t mind that as long as the patch can be applied to trunk and the sooner the better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12947765" author="davsclaus" created="Fri, 27 Jun 2008 04:57:02 +0000"  >&lt;p&gt;Marat we appreciate all your great patches for the more hardcore JMS related stuff.&lt;/p&gt;

&lt;p&gt;I am sure this patch will be accepted and submitted to the trunk. &lt;br/&gt;
The 1.4 should just be voted released before we will apply this patch to the trunk that is for the 1.5 release.&lt;/p&gt;

&lt;p&gt;The vote for 1.4 release is in progress as I write this.&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/-VOTE--Release-apache-camel-1.4-td18146965s22882.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/-VOTE--Release-apache-camel-1.4-td18146965s22882.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12947738" author="davsclaus" created="Sun, 29 Jun 2008 15:33:26 +0000"  >&lt;p&gt;Marat.&lt;/p&gt;

&lt;p&gt;Could you provide a unit test for the new class ExchangeProperty also?&lt;/p&gt;</comment>
                            <comment id="12947766" author="davsclaus" created="Sun, 29 Jun 2008 15:38:38 +0000"  >&lt;p&gt;And I am wondering if we should introduce an method on Exchange interface that returns whether this exchange is in transacted mode or not?&lt;/p&gt;
</comment>
                            <comment id="12947694" author="davsclaus" created="Sun, 29 Jun 2008 15:48:08 +0000"  >&lt;p&gt;According to the spring transaction programmatic stuff you can set the rollback only status.&lt;/p&gt;

&lt;p&gt;I am wondering if we should do this also when we do the rollback by throwing the wrapped exception?&lt;/p&gt;</comment>
                            <comment id="12947737" author="davsclaus" created="Sun, 29 Jun 2008 16:36:07 +0000"  >&lt;p&gt;I do think I got a failing exception on my local system with the patch.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-------------------------------------------------------------------------------
Test set: org.apache.camel.component.jms.tx.QueueToQueueRequestReplyTransactionTest
-------------------------------------------------------------------------------
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 23.047 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testRollbackUsingXmlQueueToQueueRequestReplyUsingDynamicMessageSelector(org.apache.camel.component.jms.tx.QueueToQueueRequestReplyTransactionTest)  Time elapsed: 22.875 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
junit.framework.AssertionFailedError: Received unexpeced reply
	at junit.framework.Assert.fail(Assert.java:47)
	at junit.framework.Assert.assertTrue(Assert.java:20)
	at org.apache.camel.component.jms.tx.QueueToQueueRequestReplyTransactionTest.testRollbackUsingXmlQueueToQueueRequestReplyUsingDynamicMessageSelector(QueueToQueueRequestReplyTransactionTest.java:70)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12947697" author="davsclaus" created="Sun, 29 Jun 2008 16:58:27 +0000"  >&lt;p&gt;I am wondering if we should also cleanup? We are adding a TRANSACTED property on the Exchange that is never removed.&lt;/p&gt;</comment>
                            <comment id="12947723" author="davsclaus" created="Sun, 29 Jun 2008 17:05:57 +0000"  >&lt;p&gt;The unit tests now all &lt;b&gt;passes&lt;/b&gt; sorry my bad&lt;/p&gt;</comment>
                            <comment id="12947743" author="davsclaus" created="Sun, 29 Jun 2008 17:23:12 +0000"  >&lt;p&gt;Marat your ExchangeProperty is quite nice. As this class is in org.apache.camel package I do think it should have javadoc stating its purpose.&lt;/p&gt;

&lt;p&gt;Other components and end-users could start using it so it should be clearly documented and ... we should have an unit test for it also.&lt;/p&gt;</comment>
                            <comment id="12947796" author="marat" created="Mon, 30 Jun 2008 19:06:35 +0000"  >&lt;p&gt;Claus:&lt;/p&gt;

&lt;p&gt;&amp;gt; Could you provide a unit test for the new class ExchangeProperty also?&lt;/p&gt;

&lt;p&gt;Working on it.&lt;/p&gt;

&lt;p&gt;&amp;gt; I am wondering if we should introduce an method on Exchange interface that returns whether this exchange is in transacted mode or not?&lt;/p&gt;

&lt;p&gt;Sure. Will add that&lt;/p&gt;

&lt;p&gt;&amp;gt; According to the spring transaction programmatic stuff you can set the rollback only status. And I am wondering if we should do this also when we do the rollback by throwing the wrapped exception?&lt;/p&gt;

&lt;p&gt;I can add that, however it has no effect on JMS tx being rolled back as there is a bug in the way tx management is implemented in Spring&apos;s JMS DefaultListenerContainer&lt;/p&gt;

&lt;p&gt;&amp;gt; We are adding a TRANSACTED property on the Exchange that is never removed.&lt;/p&gt;

&lt;p&gt;That&apos;s not quite true I believe. As far as I can tell an Exchange lifespan is a single call flow. So if this call flow is transacted then this property is installed on it.  Once this Exchange instance is freed so are its properties.&lt;/p&gt;

&lt;p&gt;&amp;gt; As this class is in org.apache.camel package I do think it should have javadoc stating its purpose.&lt;/p&gt;

&lt;p&gt;Working on that as well.&lt;/p&gt;</comment>
                            <comment id="12947669" author="davsclaus" created="Mon, 30 Jun 2008 19:21:41 +0000"  >&lt;p&gt;We should get this in 1.4 before its release. To important to not include as the transaction client EIP pattern doesn&apos;t work otherwise.&lt;/p&gt;

&lt;p&gt;Marats patch is surely great. Just need it to be more polished that he is working on &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12947722" author="marat" created="Mon, 30 Jun 2008 23:19:52 +0000"  >&lt;p&gt;Claus:&lt;/p&gt;

&lt;p&gt;Updated patch is attached. Note, I&apos;ve added type safety check on DefaultExchange for well known set of Exchange Properties&lt;/p&gt;</comment>
                            <comment id="12947784" author="davsclaus" created="Tue, 1 Jul 2008 04:25:22 +0000"  >&lt;p&gt;Marat, do you mind documenting why you are looking as you do, for the active TX, in the code below?&lt;br/&gt;
You are first looking into the TSM if not found then on status, and then on the casting to DTS etc.&lt;br/&gt;
Is all this code really needed? You had to do it like this? I am asking because when someone else look at this code in 1-2 years he would be a little puzzled?&lt;/p&gt;

&lt;p&gt;So I do think we should add some code comments on the strategy below and why it needed to do it like this.&lt;br/&gt;
You can just comment here and I will add it to the code.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
activeTx = TransactionSynchronizationManager.isActualTransactionActive();
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!activeTx) {
+                        activeTx = status.isNewTransaction() &amp;amp;&amp;amp; !status.isCompleted();
+                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!activeTx) {
+                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (DefaultTransactionStatus.class.isAssignableFrom(status.getClass())) {
+                                DefaultTransactionStatus defStatus = DefaultTransactionStatus.class.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(status);
+                                activeTx = defStatus.hasTransaction() &amp;amp;&amp;amp; !status.isCompleted();
+                            }
+                        }
+                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12947692" author="davsclaus" created="Tue, 1 Jul 2008 06:33:13 +0000"  >&lt;p&gt;D:\project\camel&amp;gt;svn commit --message &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-634&quot; title=&quot;DeadLetterChannel default redelivery policy eclipsed expected transactional behaviour in a transacted route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-634&quot;&gt;&lt;del&gt;CAMEL-634&lt;/del&gt;&lt;/a&gt;: Applied patch with thanks to Marat. Added unit test for transactional DataSource.&quot;&lt;br/&gt;
Sending        camel-core\src\main\java\org\apache\camel\Exchange.java&lt;br/&gt;
Adding         camel-core\src\main\java\org\apache\camel\ExchangeProperty.java&lt;br/&gt;
Sending        camel-core\src\main\java\org\apache\camel\impl\DefaultExchange.java&lt;br/&gt;
Sending        camel-core\src\main\java\org\apache\camel\processor\DeadLetterChannel.java&lt;br/&gt;
Adding         camel-core\src\test\java\org\apache\camel\ExchangePropertyTest.java&lt;br/&gt;
Sending        components\camel-jms\src\main\java\org\apache\camel\component\jms\EndpointMessageListener.java&lt;br/&gt;
Sending        components\camel-jms\src\test\java\org\apache\camel\component\jms\tx\ConditionalExceptionProcessor.java&lt;br/&gt;
Sending        components\camel-jms\src\test\java\org\apache\camel\component\jms\tx\QueueToQueueRequestReplyTransactionTest.java&lt;br/&gt;
Sending        components\camel-spring\pom.xml&lt;br/&gt;
Sending        components\camel-spring\src\main\java\org\apache\camel\spring\spi\TransactionInterceptor.java&lt;br/&gt;
Adding         components\camel-spring\src\test\java\org\apache\camel\spring\interceptor\BookService.java&lt;br/&gt;
Adding         components\camel-spring\src\test\java\org\apache\camel\spring\interceptor\TransactionalClientDataSourceTest.java&lt;br/&gt;
Adding         components\camel-spring\src\test\resources\org\apache\camel\spring\interceptor\transactionalClientDataSource.xml&lt;br/&gt;
Transmitting file data .............&lt;br/&gt;
Committed revision 673008.&lt;/p&gt;</comment>
                            <comment id="12947615" author="hadrian" created="Tue, 1 Jul 2008 14:20:36 +0000"  >&lt;p&gt;Can this issue be closed?&lt;/p&gt;
</comment>
                            <comment id="12947651" author="davsclaus" created="Tue, 1 Jul 2008 14:29:54 +0000"  >&lt;p&gt;Yes it can.&lt;/p&gt;

&lt;p&gt;Marat should just document why he uses the code he does to retrieve if the exchange is transacted from the spring TM&lt;/p&gt;</comment>
                            <comment id="12947806" author="davsclaus" created="Sun, 6 Jul 2008 06:30:56 +0000"  >&lt;p&gt;Closing 1.4 issues&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462607" name="tx.fix.2008-06-24-16-54.patch" size="14195" author="marat" created="Tue, 24 Jun 2008 22:11:06 +0000"/>
                            <attachment id="12462609" name="tx.fix.2008-06-30-19-16.patch" size="25915" author="marat" created="Mon, 30 Jun 2008 23:18:22 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12485471">CAMEL-645</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Jun 2008 04:09:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>83339</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01dg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5948</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>