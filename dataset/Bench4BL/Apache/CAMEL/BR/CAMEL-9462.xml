<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 02:54:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-9462/CAMEL-9462.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-9462] HTTP 1.1 Host header be dealt wrongly in proxy &amp; load balancer</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9462</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have wrote code below make camel as a load balancer, but camel-http4(and the camel-http, etc) deal the http header Host wrongly, it replace the Host header with the host name of the backend of balancer, that make the backend generate the wrong link.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Main.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.impl.DefaultCamelContext;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.model.RouteDefinition;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class Main {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        DefaultCamelContext context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext();

        RouteDefinition route = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteDefinition();
        route.from(&lt;span class=&quot;code-quote&quot;&gt;&quot;jetty:http:&lt;span class=&quot;code-comment&quot;&gt;//0.0.0.0:8080/?matchOnUriPrefix=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
&lt;/span&gt;                .loadBalance().roundRobin()
                .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;http4:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:8081/?bridgeEndpoint=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;throwExceptionOnFailure=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
&lt;/span&gt;                .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;http4:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:8082/?bridgeEndpoint=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;throwExceptionOnFailure=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        context.addRouteDefinition(route);
        context.start();
    }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have view the code and found a fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-5757&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-5757&lt;/a&gt;(See the commit), it&apos;s commits simply removed the host header &lt;a href=&quot;https://fisheye6.atlassian.com/browse/camel-git/components/camel-http4/src/main/java/org/apache/camel/component/http4/HttpProducer.java?hb=true#to106&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://fisheye6.atlassian.com/browse/camel-git/components/camel-http4/src/main/java/org/apache/camel/component/http4/HttpProducer.java?hb=true#to106&lt;/a&gt;. and I really do not think it should be dealt like that.&lt;/p&gt;

&lt;p&gt;Some backend will use the Host header to generate link, and when the Host header removed and then it be set to the backend&apos;s host, the backend got the wrong Host, and generate the wrong link.&lt;/p&gt;

&lt;p&gt;I expect the link should be &lt;a href=&quot;http://localhost:8080/web&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/web&lt;/a&gt; but it generate &lt;a href=&quot;http://127.0.0.1:8081/web&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://127.0.0.1:8081/web&lt;/a&gt; or &lt;a href=&quot;http://127.0.0.1:8082/web&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://127.0.0.1:8082/web&lt;/a&gt; when I view the page with the url &lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12924909">CAMEL-9462</key>
            <summary>HTTP 1.1 Host header be dealt wrongly in proxy &amp; load balancer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ancosen">Andrea Cosentino</assignee>
                                    <reporter username="hu2008yinxiang">Ian Hu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Dec 2015 15:27:16 +0000</created>
                <updated>Fri, 8 Apr 2016 13:40:37 +0000</updated>
                            <resolved>Fri, 8 Apr 2016 07:44:37 +0000</resolved>
                                    <version>2.9.5</version>
                    <version>2.10.3</version>
                    <version>2.11.0</version>
                                    <fixVersion>2.17.1</fixVersion>
                    <fixVersion>2.18.0</fixVersion>
                                    <component>camel-http</component>
                    <component>camel-http4</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="15107154" author="davsclaus" created="Tue, 19 Jan 2016 18:34:54 +0000"  >&lt;p&gt;The host header is not returned in newer versions. &lt;/p&gt;

&lt;p&gt;However we could maybe introduce an option to allow to preserve it.&lt;/p&gt;</comment>
                            <comment id="15107176" author="davsclaus" created="Tue, 19 Jan 2016 18:49:22 +0000"  >&lt;p&gt;I started on an unit test&lt;br/&gt;
tests/camel-itest/src/test/java/org/apache/camel/itest/jetty/JettyBridgeHostHeaderIssueTest.java&lt;/p&gt;</comment>
                            <comment id="15228168" author="erwelch" created="Wed, 6 Apr 2016 12:14:03 +0000"  >&lt;p&gt;Is anyone working on this? I could take a look today.&lt;/p&gt;

&lt;p&gt;My thought would be similar to yours Claus, add a property to the HttpEndpoint &quot;preserveHostHeader&quot; (similar to apache&apos;s mod_proxy ProxyPreserveHost directive)&lt;/p&gt;

&lt;p&gt;Then in the HttpProducer&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getEndpoint().isBridgeEndpoint()) {
            exchange.setProperty(Exchange.SKIP_GZIP_ENCODING, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; queryString = exchange.getIn().getHeader(Exchange.HTTP_QUERY, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (queryString != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                skipRequestHeaders = URISupport.parseQuery(queryString, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            }
            &lt;span class=&quot;code-comment&quot;&gt;//Remove host header unless instructed not to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; so
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!getEndpoint().isPreserveHostHeader()){
                exchange.getIn().getHeaders().remove(&lt;span class=&quot;code-quote&quot;&gt;&quot;host&quot;&lt;/span&gt;);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The default would be &quot;false&quot; such that default functionality would be as things are today.  Then if you wanted to send the Host header to the destination, you would set preserveHostHeader=true&lt;/p&gt;</comment>
                            <comment id="15228206" author="davsclaus" created="Wed, 6 Apr 2016 13:00:21 +0000"  >&lt;p&gt;Edward nobody is currently working on it. &lt;/p&gt;

&lt;p&gt;So its good if you can step up and work on it. Your plan sounds good, and we love contributions. &lt;br/&gt;
You can do a .patch file or github PR. The latter is easier for us, and also makes it easier to track contributions and who did what. &lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.apache.org/contributing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15229089" author="erwelch" created="Wed, 6 Apr 2016 20:57:42 +0000"  >&lt;p&gt;I have a fix for this issue, however before submitting the PR I have a question.&lt;/p&gt;

&lt;p&gt;I tried to apply the fix to both the HTTP (http client 3) and HTTP4 (http client 4) components, however, it turned out to not really be feasible to make this fix on the HTTP component as it is very difficult to override the Host header which is auto set.  In 4 they made this much easier.&lt;/p&gt;

&lt;p&gt;Given that http client 3 is pretty much end of life, I decided to not spend any more time on trying to see if it was even possible to do this.&lt;/p&gt;

&lt;p&gt;Here&apos;s my question, I added my new parameter to the HttpCommonEndpoint which I believe to be used by both the HTTP and HTTP4 components.  Is this ok?  Should I add something in the description indicating it will only work for HTTP4?  Or should I move the parameter to the HTTP4 HttpEndpoint subclass?&lt;/p&gt;</comment>
                            <comment id="15229712" author="davsclaus" created="Thu, 7 Apr 2016 05:25:06 +0000"  >&lt;p&gt;The jetty producer also reuses the common http. So ideally you should add support for this new option in that producer as well.&lt;/p&gt;

&lt;p&gt;And yeah we can add in common and add a note it does not apply for the old http component.&lt;/p&gt;</comment>
                            <comment id="15230126" author="githubbot" created="Thu, 7 Apr 2016 11:50:28 +0000"  >&lt;p&gt;GitHub user erwelch opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/935&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/935&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9462&quot; title=&quot;HTTP 1.1 Host header be dealt wrongly in proxy &amp;amp; load balancer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9462&quot;&gt;&lt;del&gt;CAMEL-9462&lt;/del&gt;&lt;/a&gt; HTTP 1.1 Host header be dealt wrongly in proxy &amp;amp; load balancer&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/erwelch/camel&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/erwelch/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9462&quot; title=&quot;HTTP 1.1 Host header be dealt wrongly in proxy &amp;amp; load balancer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9462&quot;&gt;&lt;del&gt;CAMEL-9462&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/935.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/935.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #935&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dfc6ee1098745518ca5db5aefef9f5b0f19b934d&lt;br/&gt;
Author: Edward Welch &amp;lt;ed@edjusted.com&amp;gt;&lt;br/&gt;
Date:   2016-04-07T11:48:16Z&lt;/p&gt;

&lt;p&gt;    Adding a new endpoint property to the HttpCommonEndpoint which allows preserving the Host header in reverse proxy applications, this class is ued by the Http, Http4, and Jetty producers.&lt;br/&gt;
    Updated the HttpProducer (Jetty/HTTP4) to set the Host header when this flag is enabled.  The older HTTP component does not readily let us override the Host header, this component will not support this parameter&lt;br/&gt;
    Updated the Integration Test to validate the behavior for both when the new parameter is set, and unset.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15230135" author="erwelch" created="Thu, 7 Apr 2016 11:56:55 +0000"  >&lt;p&gt;Hi Claus, please take a look at my pull request.&lt;/p&gt;

&lt;p&gt;A couple of notes for posterity:&lt;/p&gt;

&lt;p&gt;The original suspected culprit was not actually the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//Remove host header unless instructed not to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; so
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!getEndpoint().isPreserveHostHeader()){
                exchange.getIn().getHeaders().remove(&lt;span class=&quot;code-quote&quot;&gt;&quot;host&quot;&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I discovered this code was made redundant by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-6185&quot; title=&quot;http4 component should always filter &amp;#39;host&amp;#39; header&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-6185&quot;&gt;&lt;del&gt;CAMEL-6185&lt;/del&gt;&lt;/a&gt; so I removed this block of code from the HTTP4 and Jetty producers&lt;/p&gt;

&lt;p&gt;The Host header was still being removed by the changes introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-6185&quot; title=&quot;http4 component should always filter &amp;#39;host&amp;#39; header&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-6185&quot;&gt;&lt;del&gt;CAMEL-6185&lt;/del&gt;&lt;/a&gt;, so I added a block of code after the headers are filtered where the new parameter is checked, if set true, and Host header on the exchange is not null, then the Host header is added to the outgoing http request.&lt;/p&gt;

&lt;p&gt;I updated JettyBridgeHostHeaderIssueTest.java to validate the Host header as it isreceived by the downstream service for both when the new preserveHostHeader is true/false and for both the Jetty and HTTP4 producers&lt;/p&gt;</comment>
                            <comment id="15230214" author="davsclaus" created="Thu, 7 Apr 2016 13:17:37 +0000"  >&lt;p&gt;Andrea, after that other HTTP ticket can you take a look at merging this PR.&lt;/p&gt;</comment>
                            <comment id="15230215" author="davsclaus" created="Thu, 7 Apr 2016 13:17:54 +0000"  >&lt;p&gt;Thanks Edward for the PR. Lovely when it includes unit tests.&lt;/p&gt;</comment>
                            <comment id="15230221" author="ancosen" created="Thu, 7 Apr 2016 13:21:04 +0000"  >&lt;p&gt;Yes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I will take care of the PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15231796" author="ancosen" created="Fri, 8 Apr 2016 07:44:46 +0000"  >&lt;p&gt;Done.&lt;/p&gt;</comment>
                            <comment id="15232184" author="githubbot" created="Fri, 8 Apr 2016 13:40:37 +0000"  >&lt;p&gt;Github user erwelch closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/935&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/935&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 19 Jan 2016 18:34:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2qetb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>