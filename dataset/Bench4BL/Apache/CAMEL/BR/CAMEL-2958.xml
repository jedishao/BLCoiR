<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:14:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-2958/CAMEL-2958.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-2958] java.util.ConcurrentModificationException in Method org.apache.camel.util.CaseInsensitiveMap.putAll()</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-2958</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Every now and then I&apos;m facing the ConcurrentModificationException. It very hard to reproduce. This is my stack trace:&lt;/p&gt;

&lt;p&gt;Failed delivery for exchangeId: ba969718-9044-4261-bc57-ca10aafb0a03. Exhausted after delivery attempt: 1 caught: java.util.ConcurrentModificationException&lt;br/&gt;
java.util.ConcurrentModificationException: null&lt;br/&gt;
        at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.HashMap$KeyIterator.next(HashMap.java:828) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.CaseInsensitiveMap.putAll(CaseInsensitiveMap.java:86) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.impl.MessageSupport.copyFrom(MessageSupport.java:142) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.impl.DefaultMessage.copyFrom(DefaultMessage.java:52) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.ExchangeHelper.copyResults(ExchangeHelper.java:199) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:114) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateProcessor.processNext(DelegateProcessor.java:53) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.ChoiceProcessor.process(ChoiceProcessor.java:51) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:67) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateProcessor.processNext(DelegateProcessor.java:53) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateProcessor.proceed(DelegateProcessor.java:82) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.interceptor.TraceInterceptor.process(TraceInterceptor.java:97) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:67) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RedeliveryErrorHandler.processExchange(RedeliveryErrorHandler.java:185) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RedeliveryErrorHandler.processErrorHandler(RedeliveryErrorHandler.java:151) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:89) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DefaultErrorHandler.process(DefaultErrorHandler.java:49) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DefaultChannel.process(DefaultChannel.java:228) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:75) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.UnitOfWorkProcessor.processNext(UnitOfWorkProcessor.java:70) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateProcessor.process(DelegateProcessor.java:48) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:67) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.component.http.CamelServlet.service(CamelServlet.java:71) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-http-2.3.0.jar:2.3.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:831) &lt;span class=&quot;error&quot;&gt;&amp;#91;javaee.jar:9.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&lt;/p&gt;


&lt;p&gt;Looks like CaseInsensitiveMap isn&apos;t enough thread save. But I have no idea what other thread is modifies the map. Most of the time everything is ok.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu Linux 10.04 i386&lt;br/&gt;
Sun JDK 1.6.0_20-b02&lt;br/&gt;
Glassfish 2.1&lt;/p&gt;</environment>
        <key id="12485769">CAMEL-2958</key>
            <summary>java.util.ConcurrentModificationException in Method org.apache.camel.util.CaseInsensitiveMap.putAll()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="mouch">Christian Mouttet</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Jul 2010 10:25:01 +0000</created>
                <updated>Sun, 24 Apr 2011 09:58:03 +0000</updated>
                            <resolved>Sat, 17 Jul 2010 12:16:29 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12955597" author="mouch" created="Fri, 16 Jul 2010 12:23:45 +0000"  >&lt;p&gt;Suggestion for the fix&lt;/p&gt;</comment>
                            <comment id="12951096" author="davsclaus" created="Sat, 17 Jul 2010 10:05:52 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;

&lt;p&gt;The stacktrace looks as if the entry / map is empty. I wonder if that may have been the cause?&lt;/p&gt;

&lt;p&gt;And the double lock idiom is not thread safe either (see eg Brian Goetz book, Java concurrency in practice).&lt;/p&gt;

&lt;p&gt;I have modified the implementation a bit to be synchronized when using &lt;em&gt;write&lt;/em&gt; operations on the map.&lt;/p&gt;</comment>
                            <comment id="12951165" author="davsclaus" created="Sat, 17 Jul 2010 12:16:29 +0000"  >&lt;p&gt;trunk: 965065.&lt;/p&gt;

&lt;p&gt;Christian you are welcome to try out source from trunk to see if you have any luck reproducing the issue on your system.&lt;/p&gt;</comment>
                            <comment id="12950516" author="mouch" created="Tue, 20 Jul 2010 09:13:04 +0000"  >&lt;p&gt;Hi Claus, thank&apos;s a lot for fixing this issue. I just built a &quot;private&quot; JAR from tags/2.3.0 with your changes for using with our project. I&apos;m trying to find the code position that causes this problem.&lt;/p&gt;</comment>
                            <comment id="12950494" author="davsclaus" created="Tue, 20 Jul 2010 09:25:13 +0000"  >&lt;p&gt;Yeah cool Christian.&lt;/p&gt;

&lt;p&gt;Give the &quot;fix&quot; a throughly test on your system. And report back. Would be great to know if the bug has been eliminated.&lt;/p&gt;</comment>
                            <comment id="12952393" author="mouch" created="Tue, 20 Jul 2010 14:20:48 +0000"  >&lt;p&gt;Got it!&lt;br/&gt;
I found the bug.&lt;/p&gt;

&lt;p&gt;Has something to do with splitter &amp;amp; aggregator. In my route I receive from servlet do some splitting with xpath performing business methods from a bean and holding the aggregated responses (e.g. a List) in a claim check. Key is the original message-id before splitting. Outside the split the claim check is read again and is set as response for the servlet. (Without that tricky stuff I only got the last split element.)&lt;/p&gt;

&lt;p&gt;I don&apos;t understand what modifies the map.entrySet (CaseInsensitiveMap:90 &lt;span class=&quot;error&quot;&gt;&amp;#91;trunk&amp;#93;&lt;/span&gt;) out of the aggregation thread. Anyway with your synchronizes it works well.&lt;/p&gt;

&lt;p&gt;BTW. I read that volatile can fix the broken double check idiom: &lt;a href=&quot;http://jeremymanson.blogspot.com/2008/05/double-checked-locking.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://jeremymanson.blogspot.com/2008/05/double-checked-locking.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13024035" author="davsclaus" created="Sun, 24 Apr 2011 09:58:03 +0000"  >&lt;p&gt;Closing all resolved tickets from 2010 or older&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12463311" name="CaseInsensitiveMap.java" size="6023" author="mouch" created="Fri, 16 Jul 2010 12:23:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 17 Jul 2010 10:05:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76388</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01rs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>