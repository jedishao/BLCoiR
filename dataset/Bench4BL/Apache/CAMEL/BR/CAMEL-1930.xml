<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:47:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-1930/CAMEL-1930.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-1930] Synchronized access to XPathExpression resulting in contention for multiple consumers</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-1930</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m using Camel to do some JMS message routing. Messages are XML so xpath is a natural choice.&lt;/p&gt;

&lt;p&gt;However when using a choice with an xpath expression, the XPathBuilder creates one XPathExpression object. According to the specification, these objects are not thread safe so synchronizing looks natural. But then, using multiple jms consumers is totally useless since no concurrent evaluations can be made.&lt;/p&gt;

&lt;p&gt;XPathExpression objects would rather need to be stored in a ThreadLocal to avoid synchronization and contention.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Fabrice&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 1.6, Spring 2.5.6&lt;/p&gt;</environment>
        <key id="12487087">CAMEL-1930</key>
            <summary>Synchronized access to XPathExpression resulting in contention for multiple consumers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="fdelaporte">Fabrice Delaporte</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Aug 2009 09:15:20 +0000</created>
                <updated>Thu, 3 Jun 2010 07:23:52 +0000</updated>
                            <resolved>Tue, 13 Oct 2009 07:41:30 +0000</resolved>
                                    <version>2.0-M3</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12951605" author="davsclaus" created="Thu, 24 Sep 2009 08:29:56 +0000"  >&lt;p&gt;Fabrice&lt;/p&gt;

&lt;p&gt;If I attach a patch to this ticket do you want to try it for yourself on your environment by building the source from trunk and apply the patch?&lt;/p&gt;

&lt;p&gt;I would like it to be tested more thoroughly before committing to trunk.&lt;/p&gt;</comment>
                            <comment id="12951618" author="fdelaporte" created="Thu, 24 Sep 2009 08:46:23 +0000"  >&lt;p&gt;Sure, go ahead !&lt;/p&gt;</comment>
                            <comment id="12951700" author="davsclaus" created="Thu, 24 Sep 2009 09:38:35 +0000"  >&lt;p&gt;That was a fast reply. So I am attaching my current patch. It does still need more extensive unit testing but it does seem at first glance to work with concurrent evaluation.&lt;/p&gt;

&lt;p&gt;Yet again if you or other have more advanced xml documentations and xpath expressions to use for testing that would be appreciated. As the one in this test is simple and thus fast for the computer to evaluate at runtime.&lt;/p&gt;</comment>
                            <comment id="12951753" author="davsclaus" created="Thu, 24 Sep 2009 11:46:39 +0000"  >&lt;p&gt;Fabrice can you measure any performance degradation with and without the patch?&lt;/p&gt;</comment>
                            <comment id="12952162" author="fdelaporte" created="Thu, 24 Sep 2009 14:42:56 +0000"  >&lt;p&gt;Well, I guess this time you&apos;ll have to wait a little bit more for my next reply &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll try to test that in the coming days.&lt;/p&gt;

&lt;p&gt;As a side note, my personal experience with contention was also with simple XML/XPath, but at high concurrency (100 consumers or so). I was doing some profiling and noticed threads that were blocked on object monitors, so I started investigating and ended up on these XPath synchronized blocks.&lt;/p&gt;

&lt;p&gt;I&apos;ll bet back to you as soon as I can.&lt;/p&gt;</comment>
                            <comment id="12952171" author="davsclaus" created="Thu, 24 Sep 2009 16:19:37 +0000"  >&lt;p&gt;Ah okay I was only trying with at most 20 concurrent consumers.&lt;/p&gt;

&lt;p&gt;So maybe I give it a go with 100+ to see if I can notice any difference.&lt;/p&gt;
</comment>
                            <comment id="12953247" author="fdelaporte" created="Mon, 12 Oct 2009 16:01:48 +0000"  >&lt;p&gt;This capture shows ten consumers competing to evaluate an XPath expression&lt;/p&gt;</comment>
                            <comment id="12953246" author="fdelaporte" created="Mon, 12 Oct 2009 16:04:34 +0000"  >&lt;p&gt;This capture shows the seda consumers allowed to evaluate XPath expressions concurrently (with attached patch applied).&lt;/p&gt;</comment>
                            <comment id="12953245" author="fdelaporte" created="Mon, 12 Oct 2009 16:07:22 +0000"  >&lt;p&gt;Test case with bigger XML/XPath&lt;/p&gt;</comment>
                            <comment id="12953260" author="fdelaporte" created="Mon, 12 Oct 2009 16:07:47 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;Sorry for the delay, been quite busy these days but finally got some time to run some tests against your patch.&lt;/p&gt;

&lt;p&gt;Attached is my own version (heavily inspired by your own test case). By the way, why are you using an Executor to send your message to the SEDA queue ? Being an asynchronous endpoint I&apos;m not sure I see the point in using a thread pool.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;m sending 100 000 xml messages (a little bit bigger than yours) to the seda queue, and then awaits for the mock endpoints to reach their expected message count to measure actual processing time. The XPath expression is also closer from what we may have here in production (kind of a big switch on the message type, there may be more efficient ways to do that (especially get rid of the // wild card to put a true /message/messagetype) but that&apos;s not the point here, the point is that we get something heavier on the CPU side. And, actually, setting a low value for consumer count does not prevent contention from happening (10 in my test case).&lt;/p&gt;

&lt;p&gt;Results are pretty cool. On my computer it gives on average :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;around 150s without your patch&lt;/li&gt;
	&lt;li&gt;around 110s with the patch&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That&apos;s about 36% faster, so I think it&apos;s worth including the patch, although I have to admit that the performance difference is smaller than what I had expected (I guess that the more cores you have, the bigger the difference).&lt;/p&gt;

&lt;p&gt;In addition to that I also attached two screenshots of my instance of JVisualVM to show contention without the patch (red threads) and with the patch (yeah, that green is beautiful).&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Fabrice&lt;/p&gt;</comment>
                            <comment id="12945660" author="davsclaus" created="Tue, 13 Oct 2009 07:41:30 +0000"  >&lt;p&gt;Thanks Fabrice for testing it and providing screenshots (nice to see the before and after situation).&lt;/p&gt;

&lt;p&gt;I have applied the patch to trunk: 824627.&lt;/p&gt;</comment>
                            <comment id="12956440" author="davsclaus" created="Thu, 3 Jun 2010 07:23:52 +0000"  >&lt;p&gt;Closing old resolved issues&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462862" name="XPathRouteConcurrentBigTest.java" size="5191" author="fdelaporte" created="Mon, 12 Oct 2009 16:07:22 +0000"/>
                            <attachment id="12462707" name="camel_1930.patch" size="19376" author="davsclaus" created="Thu, 24 Sep 2009 09:38:34 +0000"/>
                            <attachment id="12462859" name="with-contention.jpg" size="388831" author="fdelaporte" created="Mon, 12 Oct 2009 16:01:48 +0000"/>
                            <attachment id="12462861" name="without-contention.jpg" size="412722" author="fdelaporte" created="Mon, 12 Oct 2009 16:04:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 24 Sep 2009 08:29:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76690</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01lg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7244</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>