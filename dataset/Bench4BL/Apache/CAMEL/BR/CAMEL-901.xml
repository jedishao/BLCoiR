<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:35:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-901/CAMEL-901.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-901] If using thread() processor followed by a pipeline Camel redelivers to the wrong processor</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-901</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Setup:&lt;/p&gt;

&lt;p&gt;Error handler is specified before the thread processor and there are 3 processor after the thread() call. Third processor fails. &lt;/p&gt;

&lt;p&gt;Bug #1:&lt;/p&gt;

&lt;p&gt;The exchange received by the failed processor (#3) gets redelivered to the first processor in the pipe.&lt;br/&gt;
It should be redeliver to #3 (this works without the thread processor).&lt;/p&gt;

&lt;p&gt;Bug #2:&lt;/p&gt;

&lt;p&gt;The specified errorHandler (log:testError) receives the exchange that entered processor #1 (first in the pipe).&lt;/p&gt;

&lt;p&gt;See details in the attached unit test. Also take a look at the log4j log (copy attached). The 3rd line from the bottom is the log by testError. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12485764">CAMEL-901</key>
            <summary>If using thread() processor followed by a pipeline Camel redelivers to the wrong processor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="magyardude">Bela Vizy</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Sep 2008 21:17:42 +0000</created>
                <updated>Thu, 23 Oct 2008 04:31:39 +0000</updated>
                            <resolved>Wed, 22 Oct 2008 04:51:57 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.1.0</version>
                    <version>1.2.0</version>
                    <version>1.3.0</version>
                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12948853" author="magyardude" created="Sun, 14 Sep 2008 21:18:48 +0000"  >&lt;p&gt;Unit Test&lt;/p&gt;</comment>
                            <comment id="12948843" author="magyardude" created="Sun, 14 Sep 2008 21:19:55 +0000"  >&lt;p&gt;Log messages for the unit test&lt;/p&gt;</comment>
                            <comment id="12949078" author="davsclaus" created="Fri, 10 Oct 2008 16:55:35 +0000"  >&lt;p&gt;Ad #1)&lt;br/&gt;
Not a bug. Your route is a pipeline (pipes and filters) &lt;a href=&quot;http://activemq.apache.org/camel/pipes-and-filters.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://activemq.apache.org/camel/pipes-and-filters.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So the routing is: from -&amp;gt; process1 -&amp;gt; process2 -&amp;gt; process3. So when the message is redelivered it starts all over again at the &lt;b&gt;from&lt;/b&gt; and this should be routed through the pipeline again&lt;/p&gt;</comment>
                            <comment id="12949158" author="davsclaus" created="Fri, 10 Oct 2008 16:58:17 +0000"  >&lt;p&gt;Ad #2)&lt;br/&gt;
Not a bug. Its the original exchange that is received, that is passed to the error handler.&lt;br/&gt;
E.g. so you can move the message to a JMS queue and later move the message back again to consume the &lt;b&gt;original&lt;/b&gt; exchange.&lt;/p&gt;</comment>
                            <comment id="12949145" author="magyardude" created="Fri, 10 Oct 2008 17:21:57 +0000"  >&lt;p&gt;#1&lt;br/&gt;
Well, not so fast. Take out the thread() and it will behave differently, they way I suggested it, that is it will re-deliver to the #3 processor where the failure occurred.&lt;/p&gt;

&lt;p&gt;I guess I mistook a feature for a bug &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The doc is not clear about the redelivery behavior (or I should RTFM). My $0.02 is that if we use the pipeline() then it should re-deliver to the pipe otherwise the failing processor. &lt;/p&gt;

&lt;p&gt;#2 That makes sense if it re-delivers to the pipe...&lt;/p&gt;</comment>
                            <comment id="12949131" author="davsclaus" created="Fri, 10 Oct 2008 17:54:30 +0000"  >&lt;p&gt;#1&lt;/p&gt;

&lt;p&gt;Camel is smart but &lt;b&gt;not&lt;/b&gt; that smart. When it do redelivery it does not know which route steps last time was successful, it always start &lt;b&gt;all over again&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;Okay so there might be a bug/issue if it works different depending if you have thread or no thread. I will look into it.&lt;/p&gt;</comment>
                            <comment id="12949157" author="davsclaus" created="Fri, 10 Oct 2008 18:41:45 +0000"  >&lt;p&gt;#2&lt;/p&gt;

&lt;p&gt;Ah each step with the processors are again wrapped in a DeadLetterChannel and thus Camel should retry at the processor that failed. And in this case at the last processor.&lt;/p&gt;
</comment>
                            <comment id="12949121" author="davsclaus" created="Tue, 14 Oct 2008 19:40:39 +0000"  >&lt;p&gt;Could be related to useing seda as the queue. We have seen some timing issues with high concurrency with seda queues.&lt;/p&gt;</comment>
                            <comment id="12949181" author="davsclaus" created="Tue, 14 Oct 2008 20:12:33 +0000"  >&lt;p&gt;Using the new handled(true) DSL and onException works.&lt;/p&gt;</comment>
                            <comment id="12949154" author="davsclaus" created="Wed, 15 Oct 2008 20:50:01 +0000"  >&lt;p&gt;Also test with direct queue instead of seda&lt;/p&gt;</comment>
                            <comment id="12949246" author="davsclaus" created="Mon, 20 Oct 2008 04:43:30 +0000"  >&lt;p&gt;#3&lt;br/&gt;
Thread adds a nested pipeline that yet again adds a DLC. Then when the exchange has been failure handled by the inner DLC then its &apos;thrown&apos; back to the outer DLC that yet again will try to handle it.&lt;/p&gt;

&lt;p&gt;ThreadType#createProcessor adds the nested Pipeline. Maybe we can avoid this.&lt;/p&gt;

&lt;p&gt;#4&lt;br/&gt;
Because of the nested Pipeline and it&apos;s copy result nature it creates a new exchange id that get&apos;s routed by the outer Pipeline, and thus by magic there is 2 messages being routed, and not only one.&lt;/p&gt;</comment>
                            <comment id="12949268" author="davsclaus" created="Mon, 20 Oct 2008 05:19:42 +0000"  >&lt;p&gt;#5&lt;br/&gt;
The inner processing in the Pipeline is missing the exception handled check that the outer processor has&lt;/p&gt;</comment>
                            <comment id="12949162" author="davsclaus" created="Mon, 20 Oct 2008 05:20:18 +0000"  >&lt;p&gt;#6&lt;br/&gt;
And the DLC should also have this exception handled check in it&apos;s processing code&lt;/p&gt;</comment>
                            <comment id="12949161" author="davsclaus" created="Mon, 20 Oct 2008 05:26:22 +0000"  >&lt;p&gt;TODO: Reminder to me. DefaultExchange when copy from parent - I think we should copy the exchange id as well&lt;/p&gt;

&lt;p&gt;I copy the exchange id in Pipeline so the same id is used.&lt;/p&gt;</comment>
                            <comment id="12949202" author="davsclaus" created="Mon, 20 Oct 2008 05:39:11 +0000"  >&lt;p&gt;TODO: exchangeId should not be lazy initialized I think, it should not depend on a DEBUG log or toString to init it&lt;/p&gt;</comment>
                            <comment id="12949213" author="davsclaus" created="Mon, 20 Oct 2008 09:32:26 +0000"  >&lt;p&gt;Issue #1 &lt;b&gt;fixed&lt;/b&gt;&lt;br/&gt;
Issue #2 &lt;b&gt;fixed&lt;/b&gt;&lt;br/&gt;
Issue #3 &lt;b&gt;working as designed&lt;/b&gt;&lt;br/&gt;
Issue #4 &lt;b&gt;fixed&lt;/b&gt;&lt;br/&gt;
Issue #5 &lt;b&gt;fixed&lt;/b&gt;&lt;br/&gt;
Issue #6 &lt;b&gt;fixed&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I got it working now, but it is a bit complicate with the thread as it adds a pipeline as well, so we get double pipelines.&lt;br/&gt;
I also added some TRACE logging to Pipleline.&lt;/p&gt;</comment>
                            <comment id="12949276" author="davsclaus" created="Mon, 20 Oct 2008 09:33:43 +0000"  >&lt;p&gt;My current patch if anyone wants to review as its a bit &lt;b&gt;long haired&lt;/b&gt; in the Pipeline&lt;/p&gt;</comment>
                            <comment id="12949347" author="hadrian" created="Mon, 20 Oct 2008 14:15:02 +0000"  >&lt;p&gt;Thanks Claus!&lt;/p&gt;

&lt;p&gt;I&apos;ll review this.  At first sight, log4j.properties should be restored to remove &lt;br/&gt;
+log4j.logger.org.apache.camel.processor.Pipeline=TRACE&lt;/p&gt;
</comment>
                            <comment id="12949245" author="davsclaus" created="Tue, 21 Oct 2008 14:38:32 +0000"  >&lt;p&gt;A better patch with the findings from hadrian and gertv&lt;/p&gt;</comment>
                            <comment id="12949355" author="davsclaus" created="Tue, 21 Oct 2008 17:37:22 +0000"  >&lt;p&gt;Gertv had a review as well. He spotted that the reuse of exchange id should be better documented. I have improved the code comments (alot)&lt;/p&gt;</comment>
                            <comment id="12949377" author="davsclaus" created="Wed, 22 Oct 2008 04:51:57 +0000"  >&lt;p&gt;Hadrian have reviewed and committed the patch&lt;/p&gt;</comment>
                            <comment id="12949352" author="magyardude" created="Thu, 23 Oct 2008 01:50:14 +0000"  >&lt;p&gt;I just wanted to say that I plugged in the latest build into my app and everything works as expected. Thanks guys!&lt;/p&gt;</comment>
                            <comment id="12949333" author="davsclaus" created="Thu, 23 Oct 2008 04:31:38 +0000"  >&lt;p&gt;Thanks for reporting, and being persistent. It was a hard one to crack as it took some debugging efforts to find the culprit.&lt;/p&gt;

&lt;p&gt;Glad it works now. So keep on providing hardball unit tests &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462708" name="BelasErrorHandlerLoggingTest.java" size="3265" author="magyardude" created="Sun, 14 Sep 2008 21:18:48 +0000"/>
                            <attachment id="12462710" name="CAMEL-901_2nd_patch.patch" size="10093" author="davsclaus" created="Tue, 21 Oct 2008 14:38:32 +0000"/>
                            <attachment id="12462535" name="camel-core-test.log" size="11256" author="magyardude" created="Sun, 14 Sep 2008 21:19:55 +0000"/>
                            <attachment id="12462627" name="camel_901_pipeline.patch" size="10653" author="davsclaus" created="Mon, 20 Oct 2008 09:33:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 10 Oct 2008 16:55:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>83111</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01f3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6215</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>