<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 03:11:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-1711/CAMEL-1711.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-1711] Routes are started twice with webapplication context</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-1711</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I&apos;ve a spring based web application that has 2 applicationContexts (the second has the first as parent). My problem is that the SpringCamelContext listens to the ContextRefreshedEvent and starts the camel context.&lt;/p&gt;

&lt;p&gt;This works fine if you have only 1 context but if the ContextRefreshedEvent of the second context is received the routes are started a second time.&lt;br/&gt;
The second start of the camel context is catched correctly (in ServiceSupport) but I think the the startRoutes() in the start()-method of DefaultCamelContext should also prevent to be called twice...  &lt;/p&gt;

&lt;p&gt;See discussion here &lt;a href=&quot;http://www.nabble.com/How-to-prevent-routes-from-started-twice--td23983653.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.nabble.com/How-to-prevent-routes-from-started-twice--td23983653.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attached is a test-project. The core project simply defines a service that is exported in the web project. The applicationContext-services.xml creates the camelContext and the DispatcherServlet is used to export the service as remoteService.&lt;/p&gt;

&lt;p&gt;Start the webapp with the jetty-run.cmd in the web project. The logfile is created in the web project.&lt;/p&gt;

&lt;p&gt;The root web application context is started:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2009-06-15 11:43:24.771 DEBUG [main][org.apache.camel.spring.SpringCamelContext] - Publishing spring-event: \
   org.springframework.context.event.ContextRefreshedEvent[source=org.springframework.web.context.support.XmlWebApplicationContext@1d4e49a: \
   display name [Root WebApplicationContext]; startup date [Mon Jun 15 11:43:22 CEST 2009]; root of context hierarchy]
2009-06-15 11:43:24.771 DEBUG [main][org.apache.camel.spring.SpringCamelContext] - Starting the CamelContext now that the ApplicationContext has started
2009-06-15 11:43:24.771 INFO  [main][org.apache.camel.impl.DefaultCamelContext] - Apache Camel 1.6.1 (CamelContext:camel-amq) is starting
....
2009-06-15 11:43:25.245 INFO  [main][org.apache.camel.impl.DefaultCamelContext] - Apache Camel 1.6.1 (CamelContext:camel-amq) started
....
2009-06-15 11:43:25.372 INFO  [main][org.springframework.web.context.ContextLoader] - Root WebApplicationContext: initialization completed in 2420 ms
2009-06-15 11:43:25.435 INFO  [main][/camel-spring-problem-web] - Initializing Spring FrameworkServlet &apos;CamelSpringProblem&apos;
2009-06-15 11:43:25.435 INFO  [main][org.springframework.web.servlet.DispatcherServlet] - FrameworkServlet &apos;CamelSpringProblem&apos;: initialization started
2009-06-15 11:43:25.435 INFO  [main][org.springframework.web.context.support.XmlWebApplicationContext] - Refreshing org.springframework.web.context.support.XmlWebApplicationContext@1ccbdf7: \
   display name [WebApplicationContext for namespace &apos;CamelSpringProblem-servlet&apos;]; startup date [Mon Jun 15 11:43:25 CEST 2009]; parent: \
   org.springframework.web.context.support.XmlWebApplicationContext@1d4e49a
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And now the web application context for the servlet is started:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2009-06-15 11:43:25.530 DEBUG [main][org.apache.camel.spring.SpringCamelContext] - Publishing spring-event: \
   org.springframework.context.event.ContextRefreshedEvent[source=org.springframework.web.context.support.XmlWebApplicationContext@1ccbdf7: \
   display name [WebApplicationContext for namespace &apos;CamelSpringProblem-servlet&apos;]; startup date [Mon Jun 15 11:43:25 CEST 2009]; \
   parent: org.springframework.web.context.support.XmlWebApplicationContext@1d4e49a]
2009-06-15 11:43:25.530 DEBUG [main][org.apache.camel.spring.SpringCamelContext] - Starting the CamelContext now that the ApplicationContext has started
2009-06-15 11:43:25.530 DEBUG [main][org.apache.camel.management.DefaultInstrumentationAgent] - Registered MBean with objectname: \
   org.apache.camel:context=chaw389c/camel-amq,type=consumers,name=JmsConsumer(0x14bcb5c)
2009-06-15 11:43:25.530 INFO  [main][org.apache.camel.impl.DefaultCamelContext] - Apache Camel 1.6.1 (CamelContext:camel-amq) started
2009-06-15 11:43:25.530 INFO  [main][org.springframework.web.servlet.DispatcherServlet] - FrameworkServlet &apos;CamelSpringProblem&apos;: initialization completed in 95 ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The ContextRefreshedEvent is published and causes the SpringCamelContext to handle the event and try to start the camel context again. But the start() in DefaultCamelContext calls super.start() and ServiceSupport detects correctly that the context is already started and does nothing but the call to startRoutes(...) is executed and this should no happen.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;DefaultCamelContext.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.start();
        
        &lt;span class=&quot;code-comment&quot;&gt;// the context is now considered started (i.e. isStarted() == &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// starting routes is done after, not during context startup
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
            startRoutes(routes);
        }

        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Apache Camel &quot;&lt;/span&gt; + getVersion() + &lt;span class=&quot;code-quote&quot;&gt;&quot; (CamelContext:&quot;&lt;/span&gt; + getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;) started&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;My favorite solution would be to add a flag that would prevent the camel context to be started from the ContextRefreshed event but allows to start the context manually from another user defined bean (possible by calling the start() method on SpringCamelContext. The shouldStartContext blocks both ways if set to false.&lt;/p&gt;</description>
                <environment>&lt;p&gt;WinXP&lt;/p&gt;</environment>
        <key id="12486343">CAMEL-1711</key>
            <summary>Routes are started twice with webapplication context</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="akuhtz">Andreas Kuhtz</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Jun 2009 11:16:27 +0000</created>
                <updated>Sat, 21 Nov 2009 11:59:10 +0000</updated>
                            <resolved>Wed, 17 Jun 2009 13:02:14 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>2.0-M2</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0-M3</fixVersion>
                                    <component>camel-spring</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12952657" author="akuhtz" created="Mon, 15 Jun 2009 11:17:03 +0000"  >&lt;p&gt;Sample project&lt;/p&gt;</comment>
                            <comment id="12952656" author="akuhtz" created="Mon, 15 Jun 2009 11:17:49 +0000"  >&lt;p&gt;The logfile that contains the messages that are referenced in the description&lt;/p&gt;</comment>
                            <comment id="12952689" author="davsclaus" created="Tue, 16 Jun 2009 16:27:51 +0000"  >&lt;p&gt;We had another Camel user report this on user forum.&lt;/p&gt;</comment>
                            <comment id="12952732" author="davsclaus" created="Wed, 17 Jun 2009 10:20:32 +0000"  >&lt;p&gt;Andreas are you using CXF with your project?&lt;/p&gt;</comment>
                            <comment id="12952733" author="akuhtz" created="Wed, 17 Jun 2009 10:31:57 +0000"  >&lt;p&gt;The sample project does not contain CXF and the problem exists (... in my real project I use CXF ...).&lt;/p&gt;</comment>
                            <comment id="12952710" author="davsclaus" created="Wed, 17 Jun 2009 11:55:13 +0000"  >&lt;p&gt;trunk: 785564.&lt;/p&gt;

&lt;p&gt;Andreas could you give it a test? You could grap the source and build yourself or wait for a SNAPSHOT to be deployed to the apache maven snapshot repo&lt;/p&gt;</comment>
                            <comment id="12952738" author="davsclaus" created="Wed, 17 Jun 2009 13:02:14 +0000"  >&lt;p&gt;1.x: 785578.&lt;/p&gt;</comment>
                            <comment id="12952739" author="akuhtz" created="Wed, 17 Jun 2009 13:07:52 +0000"  >&lt;p&gt;Currently building trunk ... &lt;/p&gt;

&lt;p&gt;But one thing that I&apos;ve already seen: The &lt;tt&gt;doStart()&lt;/tt&gt; calls &lt;tt&gt;maybeDoStart()&lt;/tt&gt; that checks &lt;tt&gt;getShouldStartContext()&lt;/tt&gt; and this prevents the camel context to &lt;br/&gt;
be started from another bean calling the &lt;tt&gt;start()&lt;/tt&gt; on the camel context (Our usecase: We use camel on a richclient and must wait for the user to login before the camel context can be started. Therefore we have a bean that listens on a special event to start the camel context) if the &lt;tt&gt;shouldStartContext&lt;/tt&gt; flag is set to false.&lt;br/&gt;
If &lt;tt&gt;doStart()&lt;/tt&gt; would just be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStart() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.doStart();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (eventEndpoint == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        eventEndpoint = createEventEndpoint();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this would work.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if this additional check in &lt;tt&gt;doStart()&lt;/tt&gt; is needed in other cases but I haven&apos;t seen any reason....&lt;/p&gt;</comment>
                            <comment id="12952745" author="akuhtz" created="Wed, 17 Jun 2009 20:25:07 +0000"  >&lt;p&gt;Claus, the fix works fine for me. However I think my comment (06:07 AM) about the &lt;tt&gt;doStart()&lt;/tt&gt; method above should be added.&lt;/p&gt;</comment>
                            <comment id="12953135" author="pledge" created="Fri, 10 Jul 2009 09:05:23 +0000"  >&lt;p&gt;We found this issue too.  Running against the latest CI build of 1.6.x does seem to fix the problem.&lt;/p&gt;</comment>
                            <comment id="12953134" author="davsclaus" created="Fri, 10 Jul 2009 09:09:15 +0000"  >&lt;p&gt;Martin can you download and build from the source locally. The Apache maven repo for SNAPSHOTS can get ***** and return old .jars.&lt;/p&gt;</comment>
                            <comment id="12953141" author="pledge" created="Fri, 10 Jul 2009 09:19:01 +0000"  >&lt;p&gt;Claus, we took a build from the Camel Hudson server (a problem with our corporate Maven proxy is preventing Camel building).  We&apos;ve been running off it for most of this week and it seems fine.&lt;/p&gt;</comment>
                            <comment id="12953774" author="davsclaus" created="Sat, 21 Nov 2009 11:59:10 +0000"  >&lt;p&gt;Closing all 2.0M3 tickets&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462975" name="camel-spring-problem.zip" size="20800" author="akuhtz" created="Mon, 15 Jun 2009 11:17:03 +0000"/>
                            <attachment id="12462978" name="camelspringproblem-server-web.log" size="41604" author="akuhtz" created="Mon, 15 Jun 2009 11:17:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Jun 2009 16:27:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76771</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01k3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>