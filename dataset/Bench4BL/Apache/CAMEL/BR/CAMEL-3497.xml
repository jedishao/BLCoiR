<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun Dec 04 00:56:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-3497/CAMEL-3497.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-3497] Splitter Component: Setting &apos;streaming=&quot;true&quot; parallelProcessing=&quot;true&quot;&apos; consumes large amounts &gt; of heap space for big original messages</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-3497</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Setting &apos;streaming=&quot;true&quot; parallelProcessing=&quot;true&quot;&apos; consumes large amounts of heap space for big original messages. E.g. 1024m of heap is not enough to process an 80Mb with 500&apos;000 lines, splitting it line by line.&lt;br/&gt;
The problem seems to be the ArrayList in MulticastProcessor line 224. It contains a Future&amp;lt;Exchange&amp;gt; object for every token delivered by the java.util.Scanner. The list is only cleared (going out of scope) after all Future objects have been completed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494696">CAMEL-3497</key>
            <summary>Splitter Component: Setting &apos;streaming=&quot;true&quot; parallelProcessing=&quot;true&quot;&apos; consumes large amounts &gt; of heap space for big original messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="rsteppac">Ralf Steppacher</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jan 2011 09:21:34 +0000</created>
                <updated>Tue, 25 Oct 2011 11:35:36 +0000</updated>
                            <resolved>Sat, 8 Jan 2011 17:29:57 +0000</resolved>
                                    <version>2.5.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12977725" author="davsclaus" created="Wed, 5 Jan 2011 10:44:18 +0000"  >&lt;p&gt;See nabble&lt;br/&gt;
&lt;a href=&quot;http://camel.465427.n5.nabble.com/2-Bugs-in-Splitter-Camel-2-5-0-tp3326727p3326727.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.465427.n5.nabble.com/2-Bugs-in-Splitter-Camel-2-5-0-tp3326727p3326727.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12977754" author="davsclaus" created="Wed, 5 Jan 2011 12:17:28 +0000"  >&lt;p&gt;Yeah the tasks list is only used for cancelling tasks which isn&apos;t needed to be processed anymore due we are done due timeout or stop on exception. So it should be possible to refactor the code to not use a task list for that. &lt;/p&gt;</comment>
                            <comment id="12977787" author="davsclaus" created="Wed, 5 Jan 2011 15:03:38 +0000"  >&lt;p&gt;The CompletionService holds a reference to the Future so there is no gain really.&lt;/p&gt;</comment>
                            <comment id="12977868" author="davsclaus" created="Wed, 5 Jan 2011 17:36:28 +0000"  >&lt;p&gt;The issue is the splitter copies the exchange for each splitted message. And the CompletionService keeps reference to all exchanges, which means we end up with a lot of Exchange at once in memory which eats up memory.&lt;/p&gt;

&lt;p&gt;Will have to come up with some way of discarding not needed exchanges during processing. Maybe even using something else than the CompletionService if its the culprint.&lt;br/&gt;
I added this to the known issues to Camel 2.5 release notes.&lt;/p&gt;</comment>
                            <comment id="12978242" author="davsclaus" created="Thu, 6 Jan 2011 09:35:36 +0000"  >&lt;p&gt;Camel 3.0 will have internal optimization which helps reducing memory footprint used during routing.&lt;/p&gt;</comment>
                            <comment id="12978785" author="davsclaus" created="Fri, 7 Jan 2011 14:07:28 +0000"  >&lt;p&gt;trunk on Camel 2.6 in rev 1056325:&lt;br/&gt;
Cancelling future tasks is now done using a running boolean instead of a keeping a big array list with the future references.&lt;/p&gt;</comment>
                            <comment id="12978855" author="davsclaus" created="Fri, 7 Jan 2011 16:43:31 +0000"  >&lt;p&gt;trunk on Camel 2.6 in rev 1056380:&lt;/p&gt;

&lt;p&gt;I have reduced memory consumption used, which should allow it to be a bit better. But the splitter still uses a bit additional memory due the splitting is based on a copy of the input message for each splitted message.&lt;/p&gt;

&lt;p&gt;Ralf you are welcome to test again and see if you can process a bit more than previously.&lt;/p&gt;</comment>
                            <comment id="12979113" author="davsclaus" created="Sat, 8 Jan 2011 10:49:33 +0000"  >&lt;p&gt;Okay good news. I refactored the logic so Camel now aggregates the parallel tasks on-the-fly.&lt;/p&gt;

&lt;p&gt;This makes a tremendous difference. Now I can split a file into 50.000 sub messages and process that in 7 sec, using at most 18mb.&lt;br/&gt;
Before I would hit an issue at about 25.000-30.000 message and hit OOME with 130mb.&lt;/p&gt;

&lt;p&gt;Since the logic is more complex because there is a separate tasks which aggregates on the fly, while the other task submit new tasks, there is logic to signal between the two tasks. They kinda need to agree when there are no more messages to split, and when it has aggregated all of those.&lt;/p&gt;</comment>
                            <comment id="12979158" author="davsclaus" created="Sat, 8 Jan 2011 17:27:05 +0000"  >&lt;p&gt;I ran a test with 1.000.000 rows in a file&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-08 18:25:44,216 [read #9 - Split] INFO  split                          - Received: 1000000 messages so far. Last group took: 50 millis which is: 20,000 messages per second. average: 17,775.566
2011-01-08 18:25:44,217 [main           ] INFO  SplitterParallelBigFileTest    - Took 57.423 seconds
2011-01-08 18:25:44,218 [:&lt;span class=&quot;code-comment&quot;&gt;//target/split] INFO  route1                         - Done splitting bigfile.txt&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the memory usage was at most 33mb at peak.&lt;/p&gt;</comment>
                            <comment id="12979159" author="davsclaus" created="Sat, 8 Jan 2011 17:29:57 +0000"  >&lt;p&gt;trunk: 1056744.&lt;/p&gt;

&lt;p&gt;Now it should run with low memory consumption and you should be able to process very big files.&lt;/p&gt;

&lt;p&gt;Ralf fell free to test with latest code on your system.&lt;/p&gt;</comment>
                            <comment id="12979521" author="davsclaus" created="Mon, 10 Jan 2011 09:59:46 +0000"  >&lt;p&gt;Fixed rare potential deadlock issue with aggregate task not being given time to run due thread pool overloaded when running in parallel mode on multicast/splitter.&lt;/p&gt;

&lt;p&gt;trunk: 1057139.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Jan 2011 10:44:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76238</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01v3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8809</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>