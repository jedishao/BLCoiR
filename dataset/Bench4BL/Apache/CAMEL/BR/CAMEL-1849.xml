<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 05:28:42 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-1849/CAMEL-1849.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-1849] CachedOutputStream not cleaning up tmp files when using file based caching</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-1849</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;A recent feature of Camel&apos;s CachedOutputStream is to serialize any messages over 64k to disk. In some cases the *tmp message files are not being cleaned up. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Camel 1.x branch. 2.0 branch also appears to have the same problem&lt;/p&gt;</environment>
        <key id="12487155">CAMEL-1849</key>
            <summary>CachedOutputStream not cleaning up tmp files when using file based caching</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="dave_stanley">Dave Stanley</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Jul 2009 18:26:52 +0000</created>
                <updated>Sun, 7 Feb 2010 09:56:20 +0000</updated>
                            <resolved>Sun, 26 Jul 2009 12:34:51 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-http</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12953353" author="dave_stanley" created="Thu, 23 Jul 2009 18:28:14 +0000"  >&lt;p&gt;Patch and testcase attached. &lt;/p&gt;

&lt;p&gt;Two changes were required, on in HttpProducer.java and the other in CachedOutputStream itself. &lt;/p&gt;</comment>
                            <comment id="12953352" author="hadrian" created="Thu, 23 Jul 2009 18:41:10 +0000"  >&lt;p&gt;@Dave, awesome!&lt;/p&gt;

&lt;p&gt;Is this fix required in 2.0 as well?&lt;/p&gt;</comment>
                            <comment id="12953351" author="janstey" created="Thu, 23 Jul 2009 18:45:48 +0000"  >&lt;p&gt;Yeah, thanks Dave!&lt;/p&gt;

&lt;p&gt;Hadrian, don&apos;t forget to add in a check for null in HttpProducer as well ala&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (is != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { 
+                    is.close();
+                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;HttpProducerSelectMethodTest fails without this mod.&lt;/p&gt;</comment>
                            <comment id="12953359" author="njiang" created="Fri, 24 Jul 2009 01:05:05 +0000"  >&lt;p&gt;Here is a thing, if you close the input stream of the HttpProducer, you will not get a readable InputStream from the message body of the exchange which will be processed after the HttpProducer.&lt;/p&gt;

&lt;p&gt;Please remember to call the close of the InputStream , If you want to make sure the temp file to be deleted.&lt;/p&gt;</comment>
                            <comment id="12953360" author="davsclaus" created="Fri, 24 Jul 2009 06:16:49 +0000"  >&lt;p&gt;Yes it should be patched in 2.0 as well.&lt;/p&gt;

&lt;p&gt;I wonder if the closing the input stream should be in a finally block to ensure its always closed?&lt;/p&gt;</comment>
                            <comment id="12953367" author="davsclaus" created="Fri, 24 Jul 2009 06:18:46 +0000"  >&lt;p&gt;PS: This stream cache is really becoming a pain, we got to many issues with it!&lt;/p&gt;

&lt;p&gt;I do think we should add an option to the CamelContext properties to let people turn it on/off and it should be off by default.&lt;/p&gt;</comment>
                            <comment id="12953361" author="njiang" created="Fri, 24 Jul 2009 14:47:24 +0000"  >&lt;p&gt;@Claus,&lt;/p&gt;

&lt;p&gt;But we don&apos;t know if there is another processor or endpoint after the HttpProducer, so we can&apos;t close the InputStream in the HttpProducer.&lt;/p&gt;
</comment>
                            <comment id="12953368" author="dave_stanley" created="Fri, 24 Jul 2009 16:09:23 +0000"  >&lt;p&gt;@Willem,&lt;/p&gt;

&lt;p&gt;If the stream is not closed in HttpProducer, wondering where is the right place to close the stream? I definitely think it should be automatically cleaned up. &lt;/p&gt;

&lt;p&gt;(I would be happy to try and tweak the patch if you can provide some suggestion on how it can be improved upon)&lt;/p&gt;</comment>
                            <comment id="12953369" author="dave_stanley" created="Fri, 24 Jul 2009 20:45:33 +0000"  >&lt;p&gt;Given this stream is only created to hold the body of of http exception&apos;s, another option might be to change the HttpOperationFailedException implementation to use a string for the body rather than an InputStream. &lt;/p&gt;

&lt;p&gt;This way the stream can be safely closed in HttpProducer. &lt;/p&gt;

&lt;p&gt;In terms of the exception body itself, if its a large exception body the entire body could be logged and then &lt;span class=&quot;error&quot;&gt;&amp;#91;optionally&amp;#93;&lt;/span&gt; truncated in the Exception object itself if needed?&lt;/p&gt;

</comment>
                            <comment id="12945591" author="davsclaus" created="Sun, 26 Jul 2009 07:03:52 +0000"  >&lt;p&gt;Dave, yeah a good idea to store the content as a String instead to detach it from the underlying stream.&lt;/p&gt;

&lt;p&gt;As it only occurs when an exception is to be thrown then the overhead is negligible.&lt;/p&gt;

&lt;p&gt;Maybe the stream should be closed as part of the exchange unit of work terminating?&lt;br/&gt;
We do that for instance with other components where they do house cleaning.&lt;/p&gt;

&lt;p&gt;And removing temporary work files would make sense to do in this part as well. And I do believe the code could use an overhaul as well since its a bit &lt;em&gt;tricky&lt;/em&gt; in places.&lt;br/&gt;
For instance generating the temporary filename should just use the exchange id as its unique and a much better name than a generated number. &lt;/p&gt;

&lt;p&gt;I would take a 2nd look and ping back ideas&lt;/p&gt;</comment>
                            <comment id="12945769" author="davsclaus" created="Sun, 26 Jul 2009 07:27:42 +0000"  >&lt;p&gt;&lt;b&gt;Some observations&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;1. &lt;br/&gt;
CachedOutputStream is build as if its holds multiple streams (i.e. it has a streamList) but its only used in Camel as wrapping a single stream.&lt;/p&gt;

&lt;p&gt;2.&lt;br/&gt;
It got an output locked option that is newer used, i.e. could be removed to reduce complexity&lt;/p&gt;

&lt;p&gt;3.&lt;br/&gt;
it lacks try .. finally to ensure proper house cleaning when working with streams&lt;/p&gt;

&lt;p&gt;4.&lt;br/&gt;
It silently ignore the output dir if provided with one and it cannot create the directory.&lt;br/&gt;
It should really throw an exception to indicate the temp output folder cannot be used&lt;/p&gt;

&lt;p&gt;5. Some methods is newer used and should be removed to reduce complexity&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;resetOut&lt;/li&gt;
	&lt;li&gt;lockOutputStream&lt;/li&gt;
	&lt;li&gt;getBytes&lt;/li&gt;
	&lt;li&gt;writeCacheTo (can be removed as its only used for toString that should just omit printing the stream content)&lt;/li&gt;
	&lt;li&gt;getOut&lt;/li&gt;
	&lt;li&gt;getTempFile&lt;/li&gt;
	&lt;li&gt;getInputStream&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;6. Duplicate code&lt;br/&gt;
The write methods has duplicate code that should be avoided and instead invoke a single method that does the actual writing&lt;/p&gt;

&lt;p&gt;7. Using java.io.File instead of NIO&lt;br/&gt;
The NIO library have features to support paging memory to disk. But yeah its a bit complex to work with the NIO but it is faster and it can leverage the OS memory paging to be faster. &lt;/p&gt;
</comment>
                            <comment id="12945772" author="davsclaus" created="Sun, 26 Jul 2009 10:53:12 +0000"  >&lt;p&gt;I am working on patching this for Camel 2.0 and cleaning up the code in CachedOutputStream&lt;/p&gt;</comment>
                            <comment id="12945771" author="davsclaus" created="Sun, 26 Jul 2009 11:30:19 +0000"  >&lt;p&gt;trunk: 797907.&lt;/p&gt;</comment>
                            <comment id="12945779" author="davsclaus" created="Sun, 26 Jul 2009 11:36:21 +0000"  >&lt;p&gt;1.x: 797911.&lt;/p&gt;

&lt;p&gt;unit test demonstrating the issue to help resolve the issue on 1.x branch&lt;/p&gt;</comment>
                            <comment id="12945787" author="davsclaus" created="Sun, 26 Jul 2009 11:59:39 +0000"  >&lt;p&gt;Setting the threshold to -1 or 0 should disable file based cache all together&lt;/p&gt;</comment>
                            <comment id="12945770" author="davsclaus" created="Sun, 26 Jul 2009 12:12:33 +0000"  >&lt;p&gt;1.x: 797918.&lt;/p&gt;

&lt;p&gt;A fix so the tmp files is also deleted in case of an http exception. And the http exception uses a copy of the stream so its detached.&lt;/p&gt;</comment>
                            <comment id="12945783" author="davsclaus" created="Sun, 26 Jul 2009 12:22:01 +0000"  >&lt;p&gt;1.x: 797920.&lt;/p&gt;

&lt;p&gt;You can now disable disk based cache by setting a threshold of 0 or negative&lt;/p&gt;

&lt;p&gt;Updated wiki as well:&lt;br/&gt;
&lt;a href=&quot;http://cwiki.apache.org/confluence/display/CAMEL/Stream+caching&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://cwiki.apache.org/confluence/display/CAMEL/Stream+caching&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12945782" author="davsclaus" created="Sun, 26 Jul 2009 12:34:51 +0000"  >&lt;p&gt;trunk: 797923.&lt;/p&gt;

&lt;p&gt;To disable the file based cache&lt;/p&gt;</comment>
                            <comment id="12945793" author="dave_stanley" created="Mon, 27 Jul 2009 01:55:43 +0000"  >&lt;p&gt;Thanks Claus! Really like the exchange.addOnCompletion(). Didn&apos;t know you could do that.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12463035" name="camel_1.x_patch.txt" size="5074" author="dave_stanley" created="Thu, 23 Jul 2009 18:28:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 23 Jul 2009 18:41:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01ky7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7163</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>