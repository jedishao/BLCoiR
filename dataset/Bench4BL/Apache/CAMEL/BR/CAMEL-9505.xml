<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 03:25:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-9505/CAMEL-9505.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-9505] RabbitMQConsumer don&apos;t use Camel ExceptionHandler BEFORE requeing message</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9505</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The use case is :&lt;/p&gt;

&lt;p&gt;onException(NotHandledException.class)&lt;br/&gt;
   .handled(false)&lt;br/&gt;
   .log(&quot;Exception not handled&quot;);&lt;/p&gt;

&lt;p&gt;onException(HandledException.class)&lt;br/&gt;
   .handled(true)&lt;br/&gt;
   .log(&quot;Exception handled&quot;);&lt;/p&gt;

&lt;p&gt;from(&quot;rabbitmq://...&amp;amp;autoAck=false&quot;)&lt;br/&gt;
   .setHeader(RabbitMQConstants.REQUEUE, constant(true))&lt;br/&gt;
   .to(...);&lt;/p&gt;

&lt;p&gt;If the route generate a NotHandledException, the message is requeue in RabbitMQ, it works fine.&lt;/p&gt;

&lt;p&gt;If the route generate a HandledException, the message is requeue in RabbitMQ before the execution of Camel ExceptionHandler wich should handle the exception and should not propagate it. &lt;/p&gt;

&lt;p&gt;The message handled by Camel ExceptionHandler should not be requeue in RabbitMQ since the exception is handled.&lt;/p&gt;

&lt;p&gt;The related code is in :&lt;/p&gt;

&lt;p&gt;org.apache.camel.component.rabbitmq.RabbitConsumer.handleDelivery&lt;/p&gt;

&lt;p&gt;Maybe this line :&lt;/p&gt;

&lt;p&gt;getExceptionHandler().handleException(&quot;Error processing exchange&quot;, exchange, exchange.getException());&lt;/p&gt;

&lt;p&gt;should be before :&lt;/p&gt;

&lt;p&gt;if (deliveryTag != 0 &amp;amp;&amp;amp; !consumer.endpoint.isAutoAck()) {&lt;br/&gt;
   log.trace(&quot;Rejecting receipt &lt;span class=&quot;error&quot;&gt;&amp;#91;delivery_tag={}&amp;#93;&lt;/span&gt; with requeue={}&quot;, deliveryTag, isRequeueHeaderSet);&lt;br/&gt;
   if (isRequeueHeaderSet) &lt;/p&gt;
{
      channel.basicReject(deliveryTag, true);
   }
&lt;p&gt; else &lt;/p&gt;
{
      channel.basicReject(deliveryTag, false);
   }
&lt;p&gt;}&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12929466">CAMEL-9505</key>
            <summary>RabbitMQConsumer don&apos;t use Camel ExceptionHandler BEFORE requeing message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ancosen">Andrea Cosentino</assignee>
                                    <reporter username="arnaudchotard">Arnaud CHOTARD</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Jan 2016 11:39:52 +0000</created>
                <updated>Wed, 13 Jan 2016 14:26:18 +0000</updated>
                            <resolved>Wed, 13 Jan 2016 13:15:12 +0000</resolved>
                                    <version>2.16.1</version>
                                    <fixVersion>2.15.6</fixVersion>
                    <fixVersion>2.16.2</fixVersion>
                    <fixVersion>2.17.0</fixVersion>
                                    <component>camel-rabbitmq</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15096162" author="arnaudchotard" created="Wed, 13 Jan 2016 13:15:30 +0000"  >&lt;p&gt;I think theses lines : &lt;/p&gt;

&lt;p&gt;if (exchange.getException() != null) &lt;/p&gt;
{
    getExceptionHandler().handleException(&quot;Error processing exchange&quot;, exchange, exchange.getException());
}

&lt;p&gt;could be move just after :&lt;/p&gt;

&lt;p&gt;Message msg;&lt;br/&gt;
if (exchange.hasOut()) &lt;/p&gt;
{
    msg = exchange.getOut();
}
&lt;p&gt; else &lt;/p&gt;
{
    msg = exchange.getIn();
}

&lt;p&gt;and before test :&lt;/p&gt;

&lt;p&gt;if (!exchange.isFailed())&lt;/p&gt;

&lt;p&gt;the getExceptionHandler().handleException could be in a try catch in order to send ack to RabbitMQ even if the onException block generate an exception&lt;/p&gt;</comment>
                            <comment id="15096168" author="ancosen" created="Wed, 13 Jan 2016 13:19:03 +0000"  >&lt;p&gt;With the latest commit it works correctly.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed two integration tests to test the behaviour.&lt;/p&gt;</comment>
                            <comment id="15096208" author="arnaudchotard" created="Wed, 13 Jan 2016 13:53:06 +0000"  >&lt;p&gt;Thank you. Perhaps the exception handler should be place before the test !exchange.isFailed() ?&lt;br/&gt;
Indeed, with the actual code, with an handled exception and autoAck=false, the RabbitMQ will still have a basiReject.&lt;br/&gt;
Should RabbitMQ have a basicAck is this case since the exception is handled ?&lt;/p&gt;</comment>
                            <comment id="15096226" author="ancosen" created="Wed, 13 Jan 2016 14:05:15 +0000"  >&lt;p&gt;It makes sense. You&apos;re right.&lt;/p&gt;

&lt;p&gt;I&apos;ll push this change.&lt;/p&gt;

&lt;p&gt;Anyway, if you want, we love contributions:&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://camel.apache.org/contributing.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15096252" author="ancosen" created="Wed, 13 Jan 2016 14:26:18 +0000"  >&lt;p&gt;Updated.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Jan 2016 13:19:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2r6in:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>