<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 01:48:12 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-9984/CAMEL-9984.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-9984] RabbitConsumer.stop() doesn&apos;t stop underlying AutorecoveringConnection obtained from supplied ConnectionFactory</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9984</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;If I have a ConnectionFactory defined as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ConnectionFactory connectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConnectionFactory();
connectionFactory.setAutomaticRecoveryEnabled(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
connectionFactory.setUsername(username);
connectionFactory.setPassword(password);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And a Camel route defined like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
rabbitmq:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672/MyExchange?connectionFactory=#connectionFactory&amp;amp;exchangeType=direct&amp;amp;queue=MyQueue&amp;amp;routingKey=MyRoutingKey&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Performing these steps:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Start my application and it connects to Rabbit and consumes messages&lt;/li&gt;
	&lt;li&gt;Shutdown the RabbbitMQ server&lt;/li&gt;
	&lt;li&gt;Shutdown my Camel application&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The application doesn&apos;t stop fully because the automatic recovery mechanism has background threads running. It carries on indefinately logging messages like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:106)
	at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:102)
	at com.rabbitmq.client.impl.AMQConnection.start(AMQConnection.java:350)
	at com.rabbitmq.client.impl.recovery.RecoveryAwareAMQConnectionFactory.newConnection(RecoveryAwareAMQConnectionFactory.java:37)
	at com.rabbitmq.client.impl.recovery.AutorecoveringConnection.recoverConnection(AutorecoveringConnection.java:476)
	at com.rabbitmq.client.impl.recovery.AutorecoveringConnection.beginAutomaticRecovery(AutorecoveringConnection.java:444)
	at com.rabbitmq.client.impl.recovery.AutorecoveringConnection.access$000(AutorecoveringConnection.java:53)
	at com.rabbitmq.client.impl.recovery.AutorecoveringConnection$1.shutdownCompleted(AutorecoveringConnection.java:383)
	at com.rabbitmq.client.impl.ShutdownNotifierComponent.notifyListeners(ShutdownNotifierComponent.java:75)
	at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:578)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looking at org.apache.camel.component.rabbitmq.RabbitConsumer.stop()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, TimeoutException {
        stopping = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (channel == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        channel.basicCancel(tag);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            channel.close();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TimeoutException e) {
            log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout occured&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The calls to channel.basicCancel(tag) and channel.close() both throw com.rabbitmq.client.AlreadyClosedException when the server has closed the connection which stops the automatic recovery thread from being halted. Checking whether the channel is open before the calls to channel.basicCancel(tag) and channel.close() seems to fix the issue.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, TimeoutException {
        stopping = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (channel == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tag != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; isChannelOpen()) {
            channel.basicCancel(tag);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isChannelOpen()) {
                channel.close();
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TimeoutException e) {
            log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout occured&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll submit a PR later&lt;/p&gt;</description>
                <environment></environment>
        <key id="12972051">CAMEL-9984</key>
            <summary>RabbitConsumer.stop() doesn&apos;t stop underlying AutorecoveringConnection obtained from supplied ConnectionFactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="daknin">Darrell King</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 May 2016 12:53:40 +0000</created>
                <updated>Thu, 26 May 2016 17:10:45 +0000</updated>
                            <resolved>Tue, 24 May 2016 09:53:48 +0000</resolved>
                                    <version>2.17.1</version>
                                    <fixVersion>2.17.2</fixVersion>
                    <fixVersion>2.18.0</fixVersion>
                                    <component>camel-rabbitmq</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15297797" author="davsclaus" created="Tue, 24 May 2016 07:03:36 +0000"  >&lt;p&gt;Thanks for reporting. Looking forward to the PR&lt;/p&gt;</comment>
                            <comment id="15297889" author="githubbot" created="Tue, 24 May 2016 08:27:55 +0000"  >&lt;p&gt;GitHub user daknin opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/996&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/996&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9984&quot; title=&quot;RabbitConsumer.stop() doesn&amp;#39;t stop underlying AutorecoveringConnection obtained from supplied ConnectionFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9984&quot;&gt;&lt;del&gt;CAMEL-9984&lt;/del&gt;&lt;/a&gt;: Rabbit MQ connection is not closed when channel has been closed by server.&lt;/p&gt;

&lt;p&gt;    This fixes closing Rabbit MQ connections when the server has already closed the channel / connection. I created an issue at &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9984&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-9984&lt;/a&gt; with full details.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/daknin/camel&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/daknin/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9984&quot; title=&quot;RabbitConsumer.stop() doesn&amp;#39;t stop underlying AutorecoveringConnection obtained from supplied ConnectionFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9984&quot;&gt;&lt;del&gt;CAMEL-9984&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/996.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/996.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #996&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 09613cb4c3be053195e1c9f68f3a485d0003d24d&lt;br/&gt;
Author: Darrell King &amp;lt;darrell.king@hermes-europe.co.uk&amp;gt;&lt;br/&gt;
Date:   2016-05-24T08:18:53Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9984&quot; title=&quot;RabbitConsumer.stop() doesn&amp;#39;t stop underlying AutorecoveringConnection obtained from supplied ConnectionFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9984&quot;&gt;&lt;del&gt;CAMEL-9984&lt;/del&gt;&lt;/a&gt;: Rabbit MQ connection is not closed when channel has been closed by server.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15298004" author="davsclaus" created="Tue, 24 May 2016 09:53:48 +0000"  >&lt;p&gt;Thanks for the PR&lt;/p&gt;</comment>
                            <comment id="15298059" author="daknin" created="Tue, 24 May 2016 11:18:56 +0000"  >&lt;p&gt;Closing now that PR is merged&lt;/p&gt;</comment>
                            <comment id="15302472" author="githubbot" created="Thu, 26 May 2016 17:10:45 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/996&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/996&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 24 May 2016 07:03:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yd7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>