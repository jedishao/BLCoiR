<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:11:35 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-10229/CAMEL-10229.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-10229] camel-rabbitmq - Race condition when stopping context with autoack=false</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10229</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Run the following code and hit enter while one message is in unacked state (see RabbitMQ console):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
	CamelContext context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext();

	context.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
			from(&lt;span class=&quot;code-quote&quot;&gt;&quot;rabbitmq:&lt;span class=&quot;code-comment&quot;&gt;//localhost/?queue=sourceQueue&amp;amp;skipExchangeDeclare=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;skipQueueDeclare=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;autoAck=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;prefetchEnabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;prefetchCount=1&quot;&lt;/span&gt;)
&lt;/span&gt;					.delayer(5000)
					.setHeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;rabbitmq.ROUTING_KEY&quot;&lt;/span&gt;, constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;destinationQueue&quot;&lt;/span&gt;))
					.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;rabbitmq:&lt;span class=&quot;code-comment&quot;&gt;//localhost/?skipExchangeDeclare=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;skipQueueDeclare=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;autoAck=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
&lt;/span&gt;					.routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;myRoute&quot;&lt;/span&gt;);
		}
	});
	context.start();
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedReader(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InputStreamReader(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.in)).readLine();
	context.stop();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;you get the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;com.rabbitmq.client.impl.DefaultExceptionHandler: Consumer org.apache.camel.component.rabbitmq.RabbitConsumer@4c57777e (amq.ctag-dWpQw46flmamv0dM_Fa_Qg) method handleDelivery for channel AMQChannel(amqp://rabbit_user@127.0.0.1:5672/,1) threw an exception for channel AMQChannel(amqp://rabbit_user@127.0.0.1:5672/,1):
com.rabbitmq.client.AlreadyClosedException: channel is already closed due to clean channel shutdown; protocol method: #method&amp;lt;channel.close&amp;gt;(reply-code=200, reply-text=OK, class-id=0, method-id=0)
	at com.rabbitmq.client.impl.AMQChannel.ensureIsOpen(AMQChannel.java:195)
	at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:309)
	at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:303)
	at com.rabbitmq.client.impl.ChannelN.basicAck(ChannelN.java:1043)
	at org.apache.camel.component.rabbitmq.RabbitConsumer.handleDelivery(RabbitConsumer.java:108)
	at com.rabbitmq.client.impl.ConsumerDispatcher$5.run(ConsumerDispatcher.java:144)
	at com.rabbitmq.client.impl.ConsumerWorkService$WorkPoolRunnable.run(ConsumerWorkService.java:99)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think that this is caused by a race condition between the main thread that runs channel.close() immediately after channel.basicCancel(tag) (see org.apache.camel.component.rabbitmq.RabbitConsumer) without waiting the channel.basicAck(deliveryTag, false) in handleDelivery().&lt;/p&gt;

&lt;p&gt;Another bad side effect is that &lt;b&gt;you&apos;ll find a duplicate of a message&lt;/b&gt; on the destinationQueue. For example if you have 10 initial messages in sourceQueue and you hit enter while it&apos;s processing the third one, you&apos;ll get 7 messages in sourceQueue and 4 messages in destinationQueue.&lt;/p&gt;

&lt;p&gt;The correct behaviour should be the following:&lt;br/&gt;
1) Stop consumer: channel.basicCancel(tag)&lt;br/&gt;
2) Wait if there is a running consumer&lt;br/&gt;
3) The consumer acks the previous message&lt;br/&gt;
4) Close the channel&lt;/p&gt;</description>
                <environment></environment>
        <key id="12995983">CAMEL-10229</key>
            <summary>camel-rabbitmq - Race condition when stopping context with autoack=false</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="pcan">Piero Cangianiello</reporter>
                        <labels>
                            <label>autoack</label>
                            <label>rabbitmq</label>
                            <label>stop</label>
                    </labels>
                <created>Tue, 9 Aug 2016 15:47:55 +0000</created>
                <updated>Tue, 16 Aug 2016 14:29:56 +0000</updated>
                            <resolved>Tue, 16 Aug 2016 14:29:56 +0000</resolved>
                                    <version>2.17.3</version>
                                    <fixVersion>2.17.4</fixVersion>
                    <fixVersion>2.18.0</fixVersion>
                                    <component>camel-rabbitmq</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15418945" author="githubbot" created="Fri, 12 Aug 2016 14:50:30 +0000"  >&lt;p&gt;GitHub user mpricope opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1119&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/1119&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10229&quot; title=&quot;camel-rabbitmq - Race condition when stopping context with autoack=false&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10229&quot;&gt;&lt;del&gt;CAMEL-10229&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Use a semaphore to wait for the message to be processed when&lt;br/&gt;
    autoAck=false&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mpricope/camel&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/mpricope/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1119.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/1119.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1119&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 52aed832f59f423c53b6426a0dd36dfd0eed699f&lt;br/&gt;
Author: miti &amp;lt;pricope@textkernel.nl&amp;gt;&lt;br/&gt;
Date:   2016-08-12T14:41:55Z&lt;/p&gt;

&lt;p&gt;    Fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10229&quot; title=&quot;camel-rabbitmq - Race condition when stopping context with autoack=false&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10229&quot;&gt;&lt;del&gt;CAMEL-10229&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Use a semaphore to wait for the message to be processed when&lt;br/&gt;
    autoAck=false&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15418948" author="mpricope" created="Fri, 12 Aug 2016 14:51:52 +0000"  >&lt;p&gt;Bumped in to this also while trying to implement some clean shutdown of our camel app.&lt;/p&gt;

&lt;p&gt;I&apos;ve put together a fix for this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/pull/1119&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/1119&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="15422792" author="githubbot" created="Tue, 16 Aug 2016 14:28:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1119&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/camel/pull/1119&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 12 Aug 2016 14:50:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i323f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>