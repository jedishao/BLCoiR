<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 04:38:05 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/CAMEL-2249/CAMEL-2249.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[CAMEL-2249] Wrong handling of useMessageIDAsCorrelationID</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-2249</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel jms seems to contain two bugs in correlation id handling.&lt;/p&gt;

&lt;p&gt;The first shows when you have a sender that has UseMessageIDAsCorrelationID=&quot;false&quot; and a server that has UseMessageIDAsCorrelationID=&quot;true&quot;. If you send a message with correlationId=&quot;a&quot; then the response message will contain correlationId=&quot;&amp;lt;request message id&amp;gt;&quot;. Even if this could be a valid behaviour as you wanted UseMessageIDAsCorrelationID=&quot;true&quot; I don&#180;t think it makes sense as the sender will not be able to correlate the message. So for this case I propose to only set the correlation id to the request message id on the server if the correlation id of the request was not set.&lt;/p&gt;

&lt;p&gt;The second bug seems to hide the first bug. Perhaps someone found a quick (and wrong way to make the tests work). It shows when you set UseMessageIDAsCorrelationID=&quot;true&quot; on both client and server. If you send a message with correlation id = &quot;a&quot; the client sends it out with this correlation id. The server then sets the correlation id to the request message id (first bug). Then on the client the reply is received. After that the correlation id is set back to &quot;a&quot; on the client. So the tests think all is well. This part of the code should be removed.&lt;/p&gt;

&lt;p&gt;I have marked both problems in the code with FIXME markers in my patch. I can also provide a patch with the solution but first I wanted to only show the problem and provide a failing test. &lt;/p&gt;

&lt;p&gt;Hope my explanations were not to confused &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12486934">CAMEL-2249</key>
            <summary>Wrong handling of useMessageIDAsCorrelationID</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="chris@die-schneider.net">Christian Schneider</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Dec 2009 22:54:20 +0000</created>
                <updated>Fri, 8 Jan 2010 15:24:09 +0000</updated>
                            <resolved>Fri, 8 Jan 2010 10:33:43 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12954050" author="chris@die-schneider.net" created="Wed, 2 Dec 2009 22:55:20 +0000"  >&lt;p&gt;Patch that shows where the problems are and that contains a currently failing unit test. &lt;/p&gt;</comment>
                            <comment id="12954057" author="maratb" created="Thu, 3 Dec 2009 01:24:57 +0000"  >&lt;p&gt;Hi Christian,&lt;/p&gt;

&lt;p&gt;I generally agree that JMS Message correlationID value should supersede the messageID value. Realize though that both configuration assertions and the statement I just made in the previous sentence are all out of band agreements. So one can argue either way.&lt;/p&gt;

&lt;p&gt;However, let me give you an example when this will break down. Certain brokers, namely IBM MQ will modify your correlationID value using their proprietary encoding. So what you&apos;re going to get back in the reply message will be very different from what you set on the request message on the producer side.&lt;/p&gt;

&lt;p&gt;So here the scenario: &lt;/p&gt;

&lt;p&gt;produce  -&amp;gt;       1     -&amp;gt; consume  - &amp;gt; produce -&amp;gt;      2       -&amp;gt; consume&lt;br/&gt;
---------------   ActiveMQ ------------------------------    IBM MQ&lt;br/&gt;
consume &amp;lt;-      4    &amp;lt;-  produce    &amp;lt;- consume &amp;lt;-     3     &amp;lt;- produce&lt;/p&gt;

&lt;p&gt;1. correlationID = C,  messageID = M&lt;br/&gt;
2. correlationID = C!,   messageID = M1&lt;br/&gt;
3. correlationID = M1,   messageID = M2&lt;br/&gt;
4. correlationID = C&lt;/p&gt;

&lt;p&gt;C! - is IBM mangled C value&lt;/p&gt;

&lt;p&gt;I&apos;d check with Suemas and ask him to review your changes and run against the tests suites as I suspect if your changes were to be applied certain tests that depend on Camel will fail.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Marat&lt;/p&gt;</comment>
                            <comment id="12954048" author="chris@die-schneider.net" created="Thu, 3 Dec 2009 07:27:55 +0000"  >&lt;p&gt;I was just browsing the net for some more info. One page is from oracle:&lt;br/&gt;
&lt;a href=&quot;http://download.oracle.com/docs/cd/E13171_01/alsb/docs25/interopjms/MsgIDPatternforJMS.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://download.oracle.com/docs/cd/E13171_01/alsb/docs25/interopjms/MsgIDPatternforJMS.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There they describe how IBM MQ uses the correlation id. So if the useMessageIdAsCorrelationId was meant in this way it could be correct. Still I would rather expect the client to not set a correaltion id if it wants this pattern. &lt;/p&gt;

&lt;p&gt;The following thread is also interesting: &lt;a href=&quot;http://www.theserverside.com/discussions/thread.tss?thread_id=44779&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.theserverside.com/discussions/thread.tss?thread_id=44779&lt;/a&gt;&lt;br/&gt;
It says that the message id of a message can change over it&#180;s lifetime. So if I understand this correctly it could mean that setting the correlation id to the message id could fail as this id could be different to the client&#180;s message id.&lt;/p&gt;

</comment>
                            <comment id="12954299" author="chris@die-schneider.net" created="Wed, 6 Jan 2010 00:18:24 +0000"  >&lt;p&gt;Are there any news about this issue? We still have the incompatibility between CXF / Camel and pure CXF. I can help some more by providing a complete patch with a solution. It would help me though if we could discuss how the &quot;useMessageIdAsCorrelationId&quot; feature should behave before I do the coding.&lt;/p&gt;

&lt;p&gt;Especially I need to know if the correlation id of the incoming message should be used as correlation id in the reply instead of the messageId if it is set.&lt;/p&gt;</comment>
                            <comment id="12954307" author="david@davidkarlsen.com" created="Wed, 6 Jan 2010 00:31:36 +0000"  >&lt;p&gt;How about making it configurable, but with Collection by MessageID as default.&lt;br/&gt;
(And act according to the &quot;spec&quot; in oracle link).&lt;br/&gt;
This is the pattern I&apos;ve seen most widespread and how I used it for JMS/MQ/zOS integration.&lt;/p&gt;

&lt;p&gt;&quot;Correlation by MessageID is commonly used by many IBM MQ applications as well as JMS applications and is the standard method to correlate request and response.&quot;&lt;/p&gt;</comment>
                            <comment id="12954301" author="chris@die-schneider.net" created="Wed, 6 Jan 2010 09:42:39 +0000"  >&lt;p&gt;I also like using the messageId for correaltion. The question is what to do when the sender already has set a correlation id. Currently camel will discard the correlation id and still set the message id as correaltion id of the response. I think this is wrong as the sender expresses that he expects to get the correlation id back that he set on the request message.  &lt;/p&gt;

&lt;p&gt;So I think we can do one of two things to correct this:&lt;br/&gt;
The first way is to always use the correlation id of the request if it was set.&lt;br/&gt;
The second way could be to add a config option that controls if the above behaviour should be actived.&lt;/p&gt;

&lt;p&gt;Which solution should be done? Are there other possible solutions?&lt;/p&gt;</comment>
                            <comment id="12954309" author="davsclaus" created="Wed, 6 Jan 2010 11:42:35 +0000"  >&lt;p&gt;SI is also discussing a similar issue at their forum&lt;br/&gt;
&lt;a href=&quot;http://forum.springsource.org/showthread.php?t=82368&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://forum.springsource.org/showthread.php?t=82368&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12954310" author="david@davidkarlsen.com" created="Wed, 6 Jan 2010 12:03:52 +0000"  >&lt;p&gt;I&apos;d say make it configurable - it shouldn&apos;t be a lot of work to support both &quot;protocols&quot;.&lt;br/&gt;
Log warnings if correlationId is set when not expected etc.&lt;/p&gt;</comment>
                            <comment id="12954322" author="davsclaus" created="Thu, 7 Jan 2010 11:33:19 +0000"  >&lt;p&gt;Yeah add an option to control the desired behavior.&lt;/p&gt;

&lt;p&gt;And remember we need unit tests to cover this as JMS is always tricky&lt;/p&gt;</comment>
                            <comment id="12954345" author="chris@die-schneider.net" created="Fri, 8 Jan 2010 08:06:39 +0000"  >&lt;p&gt;Added a fix and test. If useMessageId as correlationId is true then the correlationId is still forced to be the messageId. The difference now is that when useMessageIdasCorrelationId is false and the incoming correlationid is not set then the correlationId is set to the messageId (as a fallback).&lt;/p&gt;</comment>
                            <comment id="12954356" author="davsclaus" created="Fri, 8 Jan 2010 10:33:43 +0000"  >&lt;p&gt;trunk: 897159.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Christian.&lt;/p&gt;</comment>
                            <comment id="12954357" author="chris@die-schneider.net" created="Fri, 8 Jan 2010 15:20:03 +0000"  >&lt;p&gt;Did you have the chance to look into the code block I removed from the JmsProducer&lt;/p&gt;

&lt;p&gt;// FIXME remove: I think this does not make sense&lt;br/&gt;
+//                if (correlationId != null) &lt;/p&gt;
{
+//                    message.setJMSCorrelationID(correlationId);
+//                    exchange.getOut().setHeader(&quot;JMSCorrelationID&quot;, correlationId);
+//                }

&lt;p&gt;It looked wrong to me to set the incoming correlation id to something different but perhaps it has some reason I did not understand.&lt;/p&gt;</comment>
                            <comment id="12954349" author="chris@die-schneider.net" created="Fri, 8 Jan 2010 15:23:49 +0000"  >&lt;p&gt;I just looked into the code you committed and the comment explained what the code block was good for. So I guess my question is answered.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12463052" name="camel-jms-2010-01-08.patch" size="13270" author="chris@die-schneider.net" created="Fri, 8 Jan 2010 08:06:38 +0000"/>
                            <attachment id="12463048" name="camel-jms-correlation.patch" size="6403" author="chris@die-schneider.net" created="Wed, 2 Dec 2009 22:55:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 Dec 2009 01:24:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01nfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7565</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>