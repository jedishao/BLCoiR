<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 11:39:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-13809/HIVE-13809.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-13809] Hybrid Grace Hash Join memory usage estimation didn&apos;t take into account the bloom filter size</title>
                <link>https://issues.apache.org/jira/browse/HIVE-13809</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Memory estimation is important during hash table loading, because we need to make the decision of whether to load the next hash partition in memory or spill it. If the assumption is there&apos;s enough memory but it turns out not the case, we will run into OOM problem.&lt;/p&gt;

&lt;p&gt;Currently hybrid grace hash join memory usage estimation didn&apos;t take into account the bloom filter size. In large test cases (TB scale) the bloom filter grows as big as hundreds of MB, big enough to cause estimation error.&lt;/p&gt;

&lt;p&gt;The solution is to count in the bloom filter size into memory estimation.&lt;/p&gt;

&lt;p&gt;Another issue this patch will fix is possible NPE due to object cache reuse during hybrid grace hash join.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12971596">HIVE-13809</key>
            <summary>Hybrid Grace Hash Join memory usage estimation didn&apos;t take into account the bloom filter size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wzheng">Wei Zheng</assignee>
                                    <reporter username="wzheng">Wei Zheng</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 May 2016 17:55:44 +0000</created>
                <updated>Thu, 30 Jun 2016 01:01:30 +0000</updated>
                            <resolved>Mon, 20 Jun 2016 22:34:03 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Hive</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="15294166" author="gopalv" created="Fri, 20 May 2016 20:48:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wzheng&quot; class=&quot;user-hover&quot; rel=&quot;wzheng&quot;&gt;Wei Zheng&lt;/a&gt;: before we actually subtract such a large amount of memory from the join algorithms, maybe we should figure out the input parameters to the bloom filter creation.&lt;/p&gt;

&lt;p&gt;The reason it wasn&apos;t accounted for strictly was because of the relatively small size of bloom filters - a 4 million keyset with 0.5% false positive rate should result in a bloom filter which is approx ~6Mb.&lt;/p&gt;

&lt;p&gt;Would be a good idea to figure out the false positive rate + estimated key count of the bloom filter which grew to hundreds of Mbs and see if there&apos;s an implementation issue there.&lt;/p&gt;</comment>
                            <comment id="15294246" author="wzheng" created="Fri, 20 May 2016 21:22:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;Gopal V&lt;/a&gt; Sure, thanks for your input. Here&apos;s the snippet from application log. It can be seen in this case we got 266 million keys, thus 207 MB for bloom filter.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2016-05-20 11:29:56,600 [INFO] [pool-17-thread-2] |persistence.HybridHashTableContainer|: Total available memory: 2115483632
2016-05-20 11:29:56,601 [INFO] [pool-17-thread-2] |persistence.HybridHashTableContainer|: Estimated small table size: 1600000000
2016-05-20 11:29:56,601 [INFO] [pool-17-thread-2] |persistence.HybridHashTableContainer|: &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of hash partitions to be created: 16
2016-05-20 11:29:56,614 [INFO] [TezChild] |vector.VectorGroupByOperator|: VectorGroupByOperator is vector output &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2016-05-20 11:29:56,617 [INFO] [TezChild] |exec.ReduceSinkOperator|: Initializing &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; RS[44]
2016-05-20 11:29:56,620 [INFO] [TezChild] |exec.ReduceSinkOperator|: Using tag = -1
2016-05-20 11:29:56,780 [INFO] [pool-17-thread-2] |persistence.HybridHashTableContainer|: Using a bloom-1 filter 266666672 keys of size 207840816 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15294271" author="gopalv" created="Fri, 20 May 2016 21:30:56 +0000"  >&lt;p&gt;&lt;tt&gt;1,600,000,000&lt;/tt&gt; doesn&apos;t look like a good scenario to fix around for a map-join.&lt;/p&gt;

&lt;p&gt;Back of the envelope, 1.6 billion keys in a 2Gb hashtable comes down to &amp;lt;2 bytes per key, which is obvious going to OOM there, even divided by 16 (i.e 32 bytes per key+value).&lt;/p&gt;

&lt;p&gt;I suspect the root issue has more to do with the statistics involved here, which might be completely bogus. &lt;/p&gt;

&lt;p&gt;Ideally, we should be capping the bloom filter estimates at 4 million keys, which is nearly the probe limit of useful hashtables - any real data-set bigger than 4M, the total number of rehashes at 2Gb will also OOM the hashtables.&lt;/p&gt;

&lt;p&gt;So in this scenario, I&apos;m nearly convinced that the 1.6 billion number is bogus or bad planning.&lt;/p&gt;</comment>
                            <comment id="15294295" author="wzheng" created="Fri, 20 May 2016 21:40:36 +0000"  >&lt;p&gt;OK, agree. Btw,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Estimated small table size: 1600000000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is data size (in bytes), not number of keys. Estimated number of keys is 266666672 (still a big number).&lt;/p&gt;</comment>
                            <comment id="15308377" author="jcamachorodriguez" created="Tue, 31 May 2016 19:03:40 +0000"  >&lt;p&gt;Removing 2.1.0 target as issue is not tagged as Critical/Blocker and the RC will be created tomorrow. Please feel free to commit to branch-2.1 anyway and fix for 2.1.0 if this happens before the release.&lt;/p&gt;</comment>
                            <comment id="15314482" author="wzheng" created="Fri, 3 Jun 2016 17:51:25 +0000"  >&lt;p&gt;This ticket depends on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-13934&quot; title=&quot;Configure Tez to make nocondiional task size memory available for the Processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-13934&quot;&gt;&lt;del&gt;HIVE-13934&lt;/del&gt;&lt;/a&gt;&apos;s work&lt;/p&gt;</comment>
                            <comment id="15334255" author="wzheng" created="Thu, 16 Jun 2016 17:38:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;Gopal V&lt;/a&gt; Can you take a look?&lt;/p&gt;</comment>
                            <comment id="15335857" author="hiveqa" created="Fri, 17 Jun 2016 10:52:44 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12811158/HIVE-13809.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12811158/HIVE-13809.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 10 failed/errored test(s), 10233 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_repair
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_table_nonprintable
org.apache.hadoop.hive.ql.metadata.TestHiveMetaStoreChecker.testPartitionsCheck
org.apache.hadoop.hive.ql.metadata.TestHiveMetaStoreChecker.testTableCheck
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/148/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/148/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/148/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/148/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-148/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-148/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12811158 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15336360" author="wzheng" created="Fri, 17 Jun 2016 16:06:59 +0000"  >&lt;p&gt;list_bucket_dml_12 failure is irrelevant. It passes locally.&lt;/p&gt;</comment>
                            <comment id="15340503" author="gopalv" created="Mon, 20 Jun 2016 22:07:44 +0000"  >&lt;p&gt;LGTM - +1.&lt;/p&gt;

&lt;p&gt;The bloom filter sizing needs a revisit, since this is pre-allocated based on estimates, not on real row-counts - allowing more false positives at higher cardinalities, to keep the memory utilization under check.&lt;/p&gt;</comment>
                            <comment id="15340564" author="wzheng" created="Mon, 20 Jun 2016 22:34:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;Gopal V&lt;/a&gt; for the review. Committed to master and branch-2.1.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12975337">HIVE-13934</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12811158" name="HIVE-13809.1.patch" size="8942" author="wzheng" created="Thu, 16 Jun 2016 17:38:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 May 2016 20:48:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yaev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue>12332641</customfieldvalue>
    <customfieldvalue>12334255</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>