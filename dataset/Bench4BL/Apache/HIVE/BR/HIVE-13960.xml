<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 11:38:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-13960/HIVE-13960.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-13960] Session timeout may happen before HIVE_SERVER2_IDLE_SESSION_TIMEOUT for back-to-back synchronous operations.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-13960</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Session timeout may happen before HIVE_SERVER2_IDLE_SESSION_TIMEOUT(hive.server2.idle.session.timeout) for back-to-back synchronous operations.&lt;br/&gt;
This issue can happen with the following two operations op1 and op2: op2 is a synchronous long running operation, op2 is running right after op1 is closed.&lt;/p&gt;

&lt;p&gt;1. closeOperation(op1) is called:&lt;br/&gt;
this will set &lt;tt&gt;lastIdleTime&lt;/tt&gt; with value System.currentTimeMillis() because &lt;tt&gt;opHandleSet&lt;/tt&gt; becomes empty after &lt;tt&gt;closeOperation&lt;/tt&gt; remove op1 from &lt;tt&gt;opHandleSet&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;2. op2 is running for long time by calling &lt;tt&gt;executeStatement&lt;/tt&gt; right after closeOperation(op1) is called.&lt;br/&gt;
If op2 is running for more than HIVE_SERVER2_IDLE_SESSION_TIMEOUT, then the session will timeout even when op2 is still running.&lt;/p&gt;

&lt;p&gt;We hit this issue when we use PyHive to execute non-async operation &lt;br/&gt;
The following is the exception we see:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/dist-packages/pyhive/hive.py&quot;&lt;/span&gt;, line 126, in close
    _check_status(response)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/dist-packages/pyhive/hive.py&quot;&lt;/span&gt;, line 362, in _check_status
    raise OperationalError(response)
OperationalError: TCloseSessionResp(status=TStatus(errorCode=0, errorMessage=&apos;Session does not exist!&apos;, sqlState=None, infoMessages=[&apos;*org.apache.hive.service.cli.HiveSQLException:Session does not exist!:12:11&apos;, &apos;org.apache.hive.service.cli.session.SessionManager:closeSession:SessionManager.java:311&apos;, &apos;org.apache.hive.service.cli.CLIService:closeSession:CLIService.java:221&apos;, &apos;org.apache.hive.service.cli.thrift.ThriftCLIService:CloseSession:ThriftCLIService.java:471&apos;, &apos;org.apache.hive.service.cli.thrift.TCLIService$Processor$CloseSession:getResult:TCLIService.java:1273&apos;, &apos;org.apache.hive.service.cli.thrift.TCLIService$Processor$CloseSession:getResult:TCLIService.java:1258&apos;, &apos;org.apache.thrift.ProcessFunction:process:ProcessFunction.java:39&apos;, &apos;org.apache.thrift.TBaseProcessor:process:TBaseProcessor.java:39&apos;, &apos;org.apache.hive.service.auth.TSetIpAddressProcessor:process:TSetIpAddressProcessor.java:56&apos;, &apos;org.apache.thrift.server.TThreadPoolServer$WorkerProcess:run:TThreadPoolServer.java:285&apos;, &apos;java.util.concurrent.ThreadPoolExecutor:runWorker:ThreadPoolExecutor.java:1145&apos;, &apos;java.util.concurrent.ThreadPoolExecutor$Worker:run:ThreadPoolExecutor.java:615&apos;, &apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:run:&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745&apos;], statusCode=3))
TCloseSessionResp(status=TStatus(errorCode=0, errorMessage=&apos;Session does not exist!&apos;, sqlState=None, infoMessages=[&apos;*org.apache.hive.service.cli.HiveSQLException:Session does not exist!:12:11&apos;, &apos;org.apache.hive.service.cli.session.SessionManager:closeSession:SessionManager.java:311&apos;, &apos;org.apache.hive.service.cli.CLIService:closeSession:CLIService.java:221&apos;, &apos;org.apache.hive.service.cli.thrift.ThriftCLIService:CloseSession:ThriftCLIService.java:471&apos;, &apos;org.apache.hive.service.cli.thrift.TCLIService$Processor$CloseSession:getResult:TCLIService.java:1273&apos;, &apos;org.apache.hive.service.cli.thrift.TCLIService$Processor$CloseSession:getResult:TCLIService.java:1258&apos;, &apos;org.apache.thrift.ProcessFunction:process:ProcessFunction.java:39&apos;, &apos;org.apache.thrift.TBaseProcessor:process:TBaseProcessor.java:39&apos;, &apos;org.apache.hive.service.auth.TSetIpAddressProcessor:process:TSetIpAddressProcessor.java:56&apos;, &apos;org.apache.thrift.server.TThreadPoolServer$WorkerProcess:run:TThreadPoolServer.java:285&apos;, &apos;java.util.concurrent.ThreadPoolExecutor:runWorker:ThreadPoolExecutor.java:1145&apos;, &apos;java.util.concurrent.ThreadPoolExecutor$Worker:run:ThreadPoolExecutor.java:615&apos;, &apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:run:&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745&apos;], statusCode=3))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12976284">HIVE-13960</key>
            <summary>Session timeout may happen before HIVE_SERVER2_IDLE_SESSION_TIMEOUT for back-to-back synchronous operations.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zxu">zhihai xu</assignee>
                                    <reporter username="zxu">zhihai xu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Jun 2016 03:45:41 +0000</created>
                <updated>Tue, 21 Jun 2016 00:05:07 +0000</updated>
                            <resolved>Sat, 11 Jun 2016 16:15:56 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15317774" author="zxu" created="Tue, 7 Jun 2016 03:52:18 +0000"  >&lt;p&gt;I attached a patch &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-13960&quot; title=&quot;Session timeout may happen before HIVE_SERVER2_IDLE_SESSION_TIMEOUT for back-to-back synchronous operations.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-13960&quot;&gt;&lt;del&gt;HIVE-13960&lt;/del&gt;&lt;/a&gt;.000.patch which moved &lt;tt&gt;lastIdleTime = 0;&lt;/tt&gt; from &lt;tt&gt;release&lt;/tt&gt; to &lt;tt&gt;acquire&lt;/tt&gt; and also add a variable &lt;tt&gt;pendingCount&lt;/tt&gt; to make sure only the last &lt;tt&gt;release&lt;/tt&gt; can change &lt;tt&gt;lastIdleTime&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15318851" author="jxiang" created="Tue, 7 Jun 2016 16:48:09 +0000"  >&lt;p&gt;Good to set lastIdleTime to 0 at acquire(). Why do we need to check both  opHandleSet.isEmpty() and pendingCount = 0? When will these two don&apos;t match?&lt;/p&gt;</comment>
                            <comment id="15319063" author="zxu" created="Tue, 7 Jun 2016 18:24:49 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;! Checking opHandleSet.isEmpty() is to protect asynchronous operations because an operation is only removed in function closeOperation &lt;tt&gt;opHandleSet.remove(opHandle);&lt;/tt&gt;, but not in function release. After an asynchronous operation such as &lt;tt&gt;executeStatementAsync&lt;/tt&gt; is running, the pendingCount is zero and opHandleSet is not empty in function release called from &lt;tt&gt;executeStatementAsync&lt;/tt&gt;. So these two don&apos;t match in this case, if we don&apos;t check opHandleSet in release for asynchronous operation, the session may be expired when the asynchronous operation is still running (before closeOperation is called). Checking pendingCount in release is to prevent another race condition: if a long running synchronous operation is running in &lt;tt&gt;executeStatement&lt;/tt&gt; and another one is trying to call &lt;tt&gt;getInfo&lt;/tt&gt; to get the session information, then lastIdleTime will be changed to a non-zero value in function release called from &lt;tt&gt;getInfo&lt;/tt&gt; and the session may be expired when the synchronous operation is still running.&lt;/p&gt;</comment>
                            <comment id="15319671" author="jxiang" created="Tue, 7 Jun 2016 23:19:33 +0000"  >&lt;p&gt;Cool. +1.&lt;/p&gt;</comment>
                            <comment id="15325835" author="hiveqa" created="Sat, 11 Jun 2016 12:07:24 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12808547/HIVE-13960.000.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12808547/HIVE-13960.000.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 7 failed/errored test(s), 10223 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_constprog_partitioner
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/85/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/85/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/85/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/85/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-85/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-85/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12808547 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15325938" author="jxiang" created="Sat, 11 Jun 2016 16:15:56 +0000"  >&lt;p&gt;Integrated into trunk. Thanks Zhihai for the patch.&lt;/p&gt;</comment>
                            <comment id="15340617" author="thejas" created="Mon, 20 Jun 2016 22:59:58 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zxu&quot; class=&quot;user-hover&quot; rel=&quot;zxu&quot;&gt;zhihai xu&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;&lt;br/&gt;
From the variable name pendingCount, its hard to understand what it represents. Should we name it activeCalls (or something on that lines) instead ?&lt;br/&gt;
If you agree, the change can be done in a follow up jira.&lt;/p&gt;</comment>
                            <comment id="15340739" author="zxu" created="Tue, 21 Jun 2016 00:04:41 +0000"  >&lt;p&gt;Yes, renaming pendingCount to activeCalls sounds good to me. Will fix it in a follow up JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14067&quot; title=&quot;Rename pendingCount to activeCalls in HiveSessionImpl  for easier understanding.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14067&quot;&gt;&lt;del&gt;HIVE-14067&lt;/del&gt;&lt;/a&gt;. thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;Thejas M Nair&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12981149">HIVE-14067</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12808547" name="HIVE-13960.000.patch" size="1338" author="zxu" created="Tue, 7 Jun 2016 03:48:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Jun 2016 16:48:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z27r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>