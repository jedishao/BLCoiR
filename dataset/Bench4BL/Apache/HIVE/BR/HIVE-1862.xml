<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 00:05:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-1862/HIVE-1862.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-1862] Revive partition filtering in the Hive MetaStore</title>
                <link>https://issues.apache.org/jira/browse/HIVE-1862</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt; downgraded the JDO version. This makes the feature of partition filtering in the metastore unusable. This jira is to keep track of the lost feature and discussing approaches to bring it back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493928">HIVE-1862</key>
            <summary>Revive partition filtering in the Hive MetaStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="macyang">Mac Yang</assignee>
                                    <reporter username="devaraj">Devaraj Das</reporter>
                        <labels>
                            <label>JDO</label>
                            <label>PartitionPruner</label>
                    </labels>
                <created>Wed, 22 Dec 2010 21:46:38 +0000</created>
                <updated>Mon, 20 Aug 2012 22:57:05 +0000</updated>
                            <resolved>Thu, 20 Jan 2011 03:59:19 +0000</resolved>
                                    <version>0.7.0</version>
                                    <fixVersion>0.7.0</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12974404" author="ashutoshc" created="Wed, 22 Dec 2010 21:53:42 +0000"  >&lt;p&gt;I can see four possible routes going forward:&lt;/p&gt;

&lt;p&gt;1) Fish out exact issue by coming up with a test case and submit it to jdo community and ask for a fix in the library.&lt;br/&gt;
Assuming 1) may take longer and is unbounded, remaining on older stable jdo version presents following possibilities.&lt;/p&gt;

&lt;p&gt;2) Rewrite the jdo query to not make use of Collection.get() which only exists in newer jdo version and thereby required a jdo lib upgrade.&lt;/p&gt;

&lt;p&gt;3) Refactor the partition pruning code from ql to metastore so that metastore returns a filtered list of partition&lt;/p&gt;

&lt;p&gt;4) If 2) is not possible then, then push equality predicate to MySQL and do filtering for other predicates using 3) in Metastore.&lt;/p&gt;</comment>
                            <comment id="12974409" author="ashutoshc" created="Wed, 22 Dec 2010 21:56:22 +0000"  >&lt;p&gt;Namit,&lt;/p&gt;

&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt; is marked fixed and resolved can you attach the test scripts here and instructions on how to reproduce it.&lt;/p&gt;</comment>
                            <comment id="12977576" author="macyang" created="Wed, 5 Jan 2011 01:33:12 +0000"  >&lt;p&gt;Datanucleus 2.0.3 does not support the get() method on Collection, which the&lt;br/&gt;
partition filtering code depends on in order to retrieve the value for a&lt;br/&gt;
particular partition and use it for filtering.&lt;/p&gt;

&lt;p&gt;The submitted patch is a quick work around. It uses the substring() function&lt;br/&gt;
to extract the partition value out of the partitionName field, and thus&lt;br/&gt;
eliminates the need of the get() method.&lt;/p&gt;

&lt;p&gt;However, this approach does not work if the partition value contains special&lt;br/&gt;
characters. This is because the partitionName has the special characters&lt;br/&gt;
escaped. Hence the partition value generated using the substring() approach is&lt;br/&gt;
also in the escaped form. Here is the list of special characters for reference&lt;br/&gt;
purpose, &apos;&quot;&apos;, &apos;#&apos;, &apos;%&apos;, &apos;\&apos;&apos;, &apos;*&apos;, &apos;/&apos;, &apos;:&apos;, &apos;=&apos;, &apos;?&apos;, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;, &apos;\u007F&apos;, &apos;{&apos;,&lt;br/&gt;
&apos;]&apos;&lt;/p&gt;

&lt;p&gt;While this solution is incomplete, I am hoping this submission will trigger more &lt;br/&gt;
suggestions and ideas.&lt;/p&gt;</comment>
                            <comment id="12977583" author="macyang" created="Wed, 5 Jan 2011 01:44:32 +0000"  >&lt;p&gt;A quick note about the patch. The work around is implemented in ExpressionTree.java. The rest of the patch just added back old code that was removed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12977663" author="namit" created="Wed, 5 Jan 2011 07:50:08 +0000"  >&lt;p&gt;I have attached the test case which I was able to run to reproduce the problem with the higher jdo version.&lt;br/&gt;
Note that this is not deterministic, and may take some time to error out&lt;/p&gt;</comment>
                            <comment id="12978874" author="macyang" created="Fri, 7 Jan 2011 17:25:17 +0000"  >&lt;p&gt;Namit, thanks for posting the test.&lt;/p&gt;

&lt;p&gt;I have run the test with partial data (36k out of 302k partitions for the jdo2 table). With six concurrent processes, the test ran for more than a day without error. Will try again after finish loading the full data set.&lt;/p&gt;</comment>
                            <comment id="12979911" author="macyang" created="Tue, 11 Jan 2011 02:27:32 +0000"  >
&lt;p&gt;Ran the test again with the full dataset (~300k partitions in jdo2 table) and 10 concurrent processes. It ran for 30 hours without error.&lt;/p&gt;

&lt;p&gt;The test was run against a remote metastore server, with datanucleus 2.1.1 and the partition filtering code in place (pre &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt;). MySQL version is 5.1.46.&lt;/p&gt;
</comment>
                            <comment id="12979926" author="jvs" created="Tue, 11 Jan 2011 03:05:22 +0000"  >&lt;p&gt;I checked our server; it&apos;s MySQL 5.0.84.  Also, we set the following hive-site.xml properties:&lt;/p&gt;

&lt;p&gt;datanucleus.transactionIsolation=repeatable-read&lt;br/&gt;
datanucleus.valuegeneration.transactionIsolation=repeatable-read&lt;br/&gt;
datanucleus.connectionPoolingType=none&lt;/p&gt;</comment>
                            <comment id="12979936" author="macyang" created="Tue, 11 Jan 2011 03:58:57 +0000"  >&lt;p&gt;I did not set those parameters and just picked up from hive-default.xml,&lt;/p&gt;

&lt;p&gt;datanucleus.transactionIsolation=read-committed&lt;br/&gt;
datanucleus.connectionPoolingType=DBCP&lt;/p&gt;

&lt;p&gt;Will try the test with repeatable-read and no connection pooling and see if that makes a difference.&lt;/p&gt;

&lt;p&gt;I&apos;m curious why you run without connection pooling. Was it because the metadata server was running in local mode or was there some issue with DBCP?&lt;/p&gt;

</comment>
                            <comment id="12980202" author="jvs" created="Tue, 11 Jan 2011 17:36:42 +0000"  >&lt;p&gt;Many of our clients connect to the DB directly (not through the metastore Thrift server).  As far as I know, there are no issues with DBCP.&lt;/p&gt;</comment>
                            <comment id="12980572" author="macyang" created="Wed, 12 Jan 2011 05:59:51 +0000"  >&lt;p&gt;Bingo!&lt;/p&gt;

&lt;p&gt;Ran the test with metastore in local mode and was able to reproduce the table not found error. It appears that the bug gets tickled when metastore is running in local mode, but not (at least not easily) in thrift server mode.&lt;/p&gt;</comment>
                            <comment id="12980599" author="namit" created="Wed, 12 Jan 2011 07:01:55 +0000"  >&lt;p&gt;cool&lt;/p&gt;</comment>
                            <comment id="12980894" author="macyang" created="Wed, 12 Jan 2011 20:08:21 +0000"  >&lt;p&gt;Given that the issue does not seem to impact thrift server mode metastore server, I would like to propose the following approach,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Make datanucleus version configurable at build time (similar to hadoop.version). Use 2.0.3 as the default&lt;/li&gt;
	&lt;li&gt;Put back the code in listMPartitionsByFilter&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With those changes, the behavior of a default build will be what it is today, but people also has the option to use the partition filtering function.&lt;/p&gt;
</comment>
                            <comment id="12980946" author="namit" created="Wed, 12 Jan 2011 21:40:45 +0000"  >&lt;p&gt;I think the problem exists in the thrift server mode also, it is just more difficult to reproduce.&lt;/p&gt;

&lt;p&gt;Can you run 200 concurrent clients, and see if the problem appears ?&lt;/p&gt;</comment>
                            <comment id="12981087" author="macyang" created="Thu, 13 Jan 2011 02:18:41 +0000"  >&lt;p&gt;@Namit, certainly, but I don&apos;t have a set up ready to go for that scale, so it will take some time.&lt;/p&gt;

&lt;p&gt;In the mean time, it would be great to get some feedback on the patch to see if the approach looks reasonable.&lt;/p&gt;</comment>
                            <comment id="12981088" author="namit" created="Thu, 13 Jan 2011 02:22:45 +0000"  >&lt;p&gt;Can you generate the patch - I am getting some conflicts while applying the patch&lt;/p&gt;</comment>
                            <comment id="12981146" author="macyang" created="Thu, 13 Jan 2011 06:17:49 +0000"  >&lt;p&gt;Regenerate patch based on current trunk&lt;/p&gt;</comment>
                            <comment id="12981409" author="macyang" created="Thu, 13 Jan 2011 18:47:42 +0000"  >&lt;p&gt;&quot;A quick note about the patch. The work around is implemented in ExpressionTree.java. The rest of the patch just added back old code that was removed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt;.&quot;&lt;/p&gt;

&lt;p&gt;This was a comment I made on 4/Jan/11. It&apos;s still mostly true. However, I did make some additional minor changes due to other commits in the trunk since then.&lt;/p&gt;
</comment>
                            <comment id="12981887" author="devaraj" created="Fri, 14 Jan 2011 19:27:14 +0000"  >&lt;p&gt;Folks, any update on this one? Does it serve our purpose with the limitation that partition values can&apos;t have special characters. If so, could it be reviewed. Thanks!&lt;/p&gt;</comment>
                            <comment id="12981992" author="pauly" created="Sat, 15 Jan 2011 01:00:19 +0000"  >&lt;p&gt;I&apos;ll take a look..&lt;/p&gt;</comment>
                            <comment id="12983514" author="pauly" created="Wed, 19 Jan 2011 02:59:13 +0000"  >&lt;ul&gt;
	&lt;li&gt;There may be a potential bug with the string index logic:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
172	      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; keyEqual = FileUtils.escapePathName(keyName) + &lt;span class=&quot;code-quote&quot;&gt;&quot;=&quot;&lt;/span&gt;;
173	      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; keyEqualLength = keyEqual.length();
174	      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; valString;
175	      &lt;span class=&quot;code-comment&quot;&gt;// partitionname ==&amp;gt;  (key=value/)*(key=value)
&lt;/span&gt;176	      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partitionColumnCount == 1) {
177	        valString = &lt;span class=&quot;code-quote&quot;&gt;&quot;partitionName.substring(partitionName.indexOf(\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + keyEqual + &quot;&lt;/span&gt;\&lt;span class=&quot;code-quote&quot;&gt;&quot;)+&quot;&lt;/span&gt; + keyEqualLength + &lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;;
178	      }
179	      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
180	        valString = &lt;span class=&quot;code-quote&quot;&gt;&quot;partitionName.substring(partitionName.indexOf(\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + keyEqual + &quot;&lt;/span&gt;\&lt;span class=&quot;code-quote&quot;&gt;&quot;)+&quot;&lt;/span&gt; + keyEqualLength + &lt;span class=&quot;code-quote&quot;&gt;&quot;).substring(0, partitionName.substring(partitionName.indexOf(\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + keyEqual + &quot;&lt;/span&gt;\&lt;span class=&quot;code-quote&quot;&gt;&quot;)+&quot;&lt;/span&gt; + keyEqualLength + &lt;span class=&quot;code-quote&quot;&gt;&quot;).indexOf(\&quot;&lt;/span&gt;/\&lt;span class=&quot;code-quote&quot;&gt;&quot;))&quot;&lt;/span&gt;;
181	      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Say the partition name was ds=1/hr=2 and we want to extract the value of hr. Since there is no tailing &apos;/&apos;, what will .indexOf(\&quot;/\&quot;))&quot; return?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Can you elaborate further on why it can&apos;t handle escaped partition names? It seems that if we escape the value that we are searching for, instead of unescaping the partition name, we should be able to handle that case.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If escaped partition names can&apos;t be handled, can we revert the code inside get_partition_names_ps() / get_partitions_ps() to return the correct, but slow results?&lt;/p&gt;</comment>
                            <comment id="12983598" author="macyang" created="Wed, 19 Jan 2011 08:05:53 +0000"  >&lt;p&gt;Paul, thanks for the comment.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I will add a check to catch the case where it&apos;s the last element in the path&lt;/li&gt;
	&lt;li&gt;Escaping the value does not work for the &quot;like&quot; operator, for example, the pattern &quot;p.*3&quot; would match values like &quot;p13&quot;. However, it would also match value &quot;p1#&quot; since it got truned into &quot;p1%23&quot;&lt;/li&gt;
	&lt;li&gt;I will leave get_partition_names_ps()/get_partitions_ps() as the way they are in the trunk in the next patch&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12983842" author="macyang" created="Wed, 19 Jan 2011 19:03:22 +0000"  >&lt;p&gt;Incorporated Paul&apos;s feedback&lt;/p&gt;</comment>
                            <comment id="12983908" author="pauly" created="Wed, 19 Jan 2011 22:30:22 +0000"  >&lt;p&gt;+1 looks good. Will commit if tests pass.&lt;/p&gt;</comment>
                            <comment id="12984015" author="pauly" created="Thu, 20 Jan 2011 03:59:19 +0000"  >&lt;p&gt;Committed. Thanks Mac! Cool use of string manipulation. Hopefully, we&apos;ll find a workaround for those escaped partition names soon..&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12501190">HIVE-2048</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12471563">HIVE-1539</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12493399">HIVE-1853</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12472999">HIVE-1609</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12467501" name="HIVE-1862.1.patch.txt" size="16986" author="macyang" created="Wed, 5 Jan 2011 01:33:12 +0000"/>
                            <attachment id="12468227" name="HIVE-1862.2.patch.txt" size="16215" author="macyang" created="Thu, 13 Jan 2011 06:17:49 +0000"/>
                            <attachment id="12468777" name="HIVE-1862.3.patch.txt" size="17092" author="macyang" created="Wed, 19 Jan 2011 19:03:22 +0000"/>
                            <attachment id="12467527" name="invoke_runqry.sh" size="130" author="namit" created="Wed, 5 Jan 2011 07:48:36 +0000"/>
                            <attachment id="12467528" name="qry" size="613" author="namit" created="Wed, 5 Jan 2011 07:48:36 +0000"/>
                            <attachment id="12467530" name="qry-sch.Z" size="2308637" author="namit" created="Wed, 5 Jan 2011 07:49:09 +0000"/>
                            <attachment id="12467529" name="runqry" size="712" author="namit" created="Wed, 5 Jan 2011 07:48:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 22 Dec 2010 21:53:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63978</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lhcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>123461</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>