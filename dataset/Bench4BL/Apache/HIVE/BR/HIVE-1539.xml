<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 23:35:19 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-1539/HIVE-1539.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-1539] Concurrent metastore threading problem </title>
                <link>https://issues.apache.org/jira/browse/HIVE-1539</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When running hive as a service and running a high number of queries concurrently I end up with multiple threads running at 100% cpu without any progress.&lt;/p&gt;

&lt;p&gt;Looking at these threads I notice this thread(484e):&lt;br/&gt;
at org.apache.hadoop.hive.metastore.ObjectStore.getMTable(ObjectStore.java:598)&lt;/p&gt;

&lt;p&gt;But on a different thread(63a2):&lt;br/&gt;
at org.apache.hadoop.hive.metastore.model.MStorageDescriptor.jdoReplaceField(MStorageDescriptor.java)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12471563">HIVE-1539</key>
            <summary>Concurrent metastore threading problem </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bennies">Bennie Schut</assignee>
                                    <reporter username="bennies">Bennie Schut</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Aug 2010 15:36:00 +0000</created>
                <updated>Wed, 28 Sep 2016 18:58:10 +0000</updated>
                            <resolved>Thu, 5 Jun 2014 07:55:11 +0000</resolved>
                                    <version>0.7.0</version>
                                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="12898279" author="bennies" created="Fri, 13 Aug 2010 15:38:26 +0000"  >&lt;p&gt;Thread dump.&lt;/p&gt;</comment>
                            <comment id="12898808" author="bennies" created="Mon, 16 Aug 2010 07:01:40 +0000"  >&lt;p&gt;This is starting to look more and more like a similar problem we have on the jdbc driver (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1428&quot; title=&quot;ALTER TABLE ADD PARTITION fails with a remote Thrift metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1428&quot;&gt;&lt;del&gt;HIVE-1428&lt;/del&gt;&lt;/a&gt;). the HiveMetatStoreClient is doing calls on the thrift client but the thrift client isn&apos;t threadsafe (probably by design). So when the HiveMetaStoreClient is used it should be synchronized or a new HiveMetaStoreClient object should be created for each thread.&lt;/p&gt;

&lt;p&gt;From the &quot;Hive&quot; class:&lt;/p&gt;

&lt;p&gt;  private IMetaStoreClient getMSC() throws MetaException {&lt;br/&gt;
    if (metaStoreClient == null) &lt;/p&gt;
{
      metaStoreClient = createMetaStoreClient();
    }
&lt;p&gt;    return metaStoreClient;&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;I could make the sync factory we use on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1428&quot; title=&quot;ALTER TABLE ADD PARTITION fails with a remote Thrift metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1428&quot;&gt;&lt;del&gt;HIVE-1428&lt;/del&gt;&lt;/a&gt; a common thing and reuse it here. Any objections?&lt;/p&gt;</comment>
                            <comment id="12898810" author="bennies" created="Mon, 16 Aug 2010 07:07:57 +0000"  >&lt;p&gt;That would be &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1482&quot; title=&quot;Not all jdbc calls are threadsafe.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1482&quot;&gt;HIVE-1482&lt;/a&gt; not 28 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12899157" author="pauly" created="Mon, 16 Aug 2010 22:46:16 +0000"  >&lt;p&gt;From looking at the Hive class, we are creating a ThreadLocal instance of Hive when we call get(). Since the HiveMetaStoreClient is a member of Hive, shouldn&apos;t the client be accessed by only 1 thread at a time?&lt;/p&gt;</comment>
                            <comment id="12901356" author="bennies" created="Mon, 23 Aug 2010 11:36:24 +0000"  >&lt;p&gt;thanks Paul, I didn&apos;t notice that yet so in theory it shouldn&apos;t be the cause. However after synchronizing the metastore client I never saw this problem again where I used to see this problem every day.&lt;br/&gt;
Strange issue. I&apos;ll see if I can create something reproducible but that might be tricky for this type of problem.&lt;/p&gt;</comment>
                            <comment id="12904093" author="bennies" created="Mon, 30 Aug 2010 07:09:49 +0000"  >&lt;p&gt;Ok, I just had another few instances of hanging threads. Last time I used a SynchronizedFactory to eliminate any threading issues in the metastore client but that doesn&apos;t solve it like Paul correctly saw.&lt;/p&gt;

&lt;p&gt;&quot;pool-1-thread-224&quot; prio=10 tid=0x00007f717d62c800 nid=0x7b4d runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000004557c000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
        at java.util.HashMap.get(HashMap.java:303)&lt;br/&gt;
        at org.datanucleus.util.ReferenceValueMap.get(ReferenceValueMap.java:186)&lt;br/&gt;
        at org.datanucleus.JDOClassLoaderResolver.classForName(JDOClassLoaderResolver.java:185)&lt;br/&gt;
        at org.datanucleus.JDOClassLoaderResolver.classForName(JDOClassLoaderResolver.java:415)&lt;br/&gt;
        at org.datanucleus.store.mapped.MappedTypeManager.isSupportedMappedType(MappedTypeManager.java:84)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.AbstractIteratorStatement.&amp;lt;init&amp;gt;(AbstractIteratorStatement.java:83)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.UnionIteratorStatement.&amp;lt;init&amp;gt;(UnionIteratorStatement.java:147)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.ClassTableExtent.newQueryStatement(ClassTableExtent.java:204)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.QueryCompiler.executionCompile(QueryCompiler.java:323)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.JDOQLQueryCompiler.compile(JDOQLQueryCompiler.java:225)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.JDOQLQuery.compileInternal(JDOQLQuery.java:175)&lt;br/&gt;
        at org.datanucleus.store.query.Query.executeQuery(Query.java:1628)&lt;br/&gt;
        at org.datanucleus.store.rdbms.query.legacy.JDOQLQuery.executeQuery(JDOQLQuery.java:245)&lt;br/&gt;
        at org.datanucleus.store.query.Query.executeWithArray(Query.java:1499)&lt;br/&gt;
        at org.datanucleus.jdo.JDOQuery.execute(JDOQuery.java:243)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.ObjectStore.getMDatabase(ObjectStore.java:323)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.ObjectStore.convertToMTable(ObjectStore.java:640)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.ObjectStore.alterTable(ObjectStore.java:946)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveAlterHandler.alterTable(HiveAlterHandler.java:177)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler$23.run(HiveMetaStore.java:1329)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler$23.run(HiveMetaStore.java:1326)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.executeWithRetry(HiveMetaStore.java:229)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.alter_table(HiveMetaStore.java:1326)&lt;br/&gt;
        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.alter_table(HiveMetaStoreClient.java:143)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.hadoop.hive.common.SynchronizedFactory$Handler.invoke(SynchronizedFactory.java:46)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00000007ffc6fd00&amp;gt; (a org.apache.hadoop.hive.metastore.HiveMetaStoreClient)&lt;br/&gt;
        at $Proxy8.alter_table(Unknown Source)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.metadata.Hive.alterTable(Hive.java:267)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.metadata.Hive.loadTable(Hive.java:875)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.MoveTask.execute(MoveTask.java:174)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:108)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:55)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:609)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:478)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:356)&lt;br/&gt;
        at org.apache.hadoop.hive.service.HiveServer$HiveServerHandler.execute(HiveServer.java:114)&lt;br/&gt;
        at org.apache.hadoop.hive.service.ThriftHive$Processor$execute.process(ThriftHive.java:378)&lt;br/&gt;
        at org.apache.hadoop.hive.service.ThriftHive$Processor.process(ThriftHive.java:366)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:252)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12905455" author="bennies" created="Thu, 2 Sep 2010 08:58:37 +0000"  >&lt;p&gt;JDOClassLoaderResolver doesn&apos;t seem thread safe. That&apos;s a bit of a surprise. I filed a bug with datanucleus: &lt;br/&gt;
&lt;a href=&quot;http://www.datanucleus.org/servlet/jira/browse/NUCCORE-559&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.datanucleus.org/servlet/jira/browse/NUCCORE-559&lt;/a&gt;&lt;br/&gt;
I just made my own threadsafe version of the JDOClassLoaderResolver and am loading it to see if that fixes it. Will probably take a few days to be sure it got fixed.&lt;/p&gt;</comment>
                            <comment id="12905463" author="bennies" created="Thu, 2 Sep 2010 09:35:57 +0000"  >&lt;p&gt;Ok still testing it but this is a temporary fix we add our own sync. version of the classloader:&lt;/p&gt;

&lt;p&gt;Just make sure you add these properties and it should work:&lt;br/&gt;
&amp;lt;property&amp;gt;&lt;br/&gt;
  &amp;lt;name&amp;gt;datanucleus.classLoaderResolverName&amp;lt;/name&amp;gt;&lt;br/&gt;
  &amp;lt;value&amp;gt;syncloader&amp;lt;/value&amp;gt;&lt;br/&gt;
&amp;lt;/property&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="12908472" author="bennies" created="Sun, 12 Sep 2010 14:12:15 +0000"  >&lt;p&gt;Patch got comitted on datanucleus 2.2.0.m2&lt;br/&gt;
We could consider moving from 2.0 to 2.2&lt;br/&gt;
The temporary fix of loading your own classloader also wroked nicely.&lt;/p&gt;</comment>
                            <comment id="12930974" author="bennies" created="Thu, 11 Nov 2010 10:21:14 +0000"  >&lt;p&gt;2.2.0-m2 can now be found on maven so the previous patch can be discarded and you can simple update the ivy/libraries/properties file to use datanucleus 2.2.0-m2.&lt;/p&gt;

&lt;p&gt;since -m2 is a milestone release I&apos;m not sure if we would want to include this or wait for 2.2.0 release.&lt;/p&gt;</comment>
                            <comment id="12965515" author="jvs" created="Wed, 1 Dec 2010 01:01:43 +0000"  >&lt;p&gt;According to the datanucleus website, 2.2.0 is scheduled for 10-Dec, so let&apos;s wait for it.&lt;/p&gt;</comment>
                            <comment id="12978521" author="bennies" created="Thu, 6 Jan 2011 21:50:01 +0000"  >&lt;p&gt;patch to go from datanucleus 2.0 to 2.2.0-release. I had to make a small change to the Utilities class since some package names changed. I also had to add some extra excludes on the metastore/ivy.xml&lt;/p&gt;</comment>
                            <comment id="12978538" author="ashutoshc" created="Thu, 6 Jan 2011 22:17:02 +0000"  >&lt;p&gt;@Bennie,&lt;/p&gt;

&lt;p&gt;Since this bug was filed, we upgraded from 2.0.3 to 2.1.1 (in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1609&quot; title=&quot;Support partition filtering in metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1609&quot;&gt;&lt;del&gt;HIVE-1609&lt;/del&gt;&lt;/a&gt;) Some bugs then showed up which were attributed to that jdo lib upgrade (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1853&quot; title=&quot;downgrade JDO version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1853&quot;&gt;&lt;del&gt;HIVE-1853&lt;/del&gt;&lt;/a&gt;) so it was rolled back to 2.0.3 Investigation is still on for them in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1862&quot; title=&quot;Revive partition filtering in the Hive MetaStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1862&quot;&gt;&lt;del&gt;HIVE-1862&lt;/del&gt;&lt;/a&gt; So, before committing to still higher version of jdo 2.2.0 we need to make sure it doesn&apos;t result in test case failure listed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1862&quot; title=&quot;Revive partition filtering in the Hive MetaStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1862&quot;&gt;&lt;del&gt;HIVE-1862&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12978665" author="bennies" created="Fri, 7 Jan 2011 07:45:39 +0000"  >&lt;p&gt;Thanks Ashutosh, I was waiting for the test result and as you predicted just got a build failed. &lt;/p&gt;</comment>
                            <comment id="12978698" author="bennies" created="Fri, 7 Jan 2011 09:10:58 +0000"  >&lt;p&gt;Are we getting errors like these on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1862&quot; title=&quot;Revive partition filtering in the Hive MetaStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1862&quot;&gt;&lt;del&gt;HIVE-1862&lt;/del&gt;&lt;/a&gt; ? :&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Exception: java.lang.RuntimeException: The table default_&lt;em&gt;show_idx_full_idx_comment&lt;/em&gt;_ is an index table. Please do drop index instead.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.RuntimeException: The table default_&lt;em&gt;show_idx_full_idx_comment&lt;/em&gt;_ is an index table. Please do drop index instead.&lt;/p&gt;

&lt;p&gt;Or is this something else?&lt;/p&gt;</comment>
                            <comment id="15530543" author="sharathmk99" created="Wed, 28 Sep 2016 18:58:10 +0000"  >&lt;p&gt;I&apos;m facing the same problem. &lt;br/&gt;
I&apos;m not able to run concurrent query using JDBC java program.&lt;br/&gt;
If any one solved, please direct me to some example java program.&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12493928">HIVE-1862</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12494920">HIVE-1899</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12493399">HIVE-1853</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12472999">HIVE-1609</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12453671" name="ClassLoaderResolver.patch" size="26623" author="bennies" created="Thu, 2 Sep 2010 09:35:57 +0000"/>
                            <attachment id="12467673" name="HIVE-1539-1.patch" size="2952" author="bennies" created="Thu, 6 Jan 2011 21:50:01 +0000"/>
                            <attachment id="12459337" name="HIVE-1539.patch" size="563" author="bennies" created="Thu, 11 Nov 2010 10:21:14 +0000"/>
                            <attachment id="12452031" name="thread_dump_hanging.txt" size="30986" author="bennies" created="Fri, 13 Aug 2010 15:38:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 16 Aug 2010 22:46:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>42457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lflb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>123176</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>We switched to a datanucleus version &amp;gt;= 2.2 a long time ago so this is fixed.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>