<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 22:34:46 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-4501/HIVE-4501.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-4501] HS2 memory leak - FileSystem objects in FileSystem.CACHE</title>
                <link>https://issues.apache.org/jira/browse/HIVE-4501</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;org.apache.hadoop.fs.FileSystem objects are getting accumulated in FileSystem.CACHE, with HS2 in unsecure mode.&lt;/p&gt;

&lt;p&gt;As a workaround, it is possible to set fs.hdfs.impl.disable.cache and fs.file.impl.disable.cache to true.&lt;br/&gt;
Users should not have to bother with this extra configuration. &lt;/p&gt;

&lt;p&gt;As a workaround disable impersonation by setting hive.server2.enable.doAs to false.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646151">HIVE-4501</key>
            <summary>HS2 memory leak - FileSystem objects in FileSystem.CACHE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="vgumashta">Vaibhav Gumashta</assignee>
                                    <reporter username="thejas">Thejas M Nair</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2013 04:23:51 +0000</created>
                <updated>Tue, 30 Dec 2014 23:11:29 +0000</updated>
                            <resolved>Fri, 14 Mar 2014 18:17:31 +0000</resolved>
                                    <version>0.11.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>17</watches>
                                                                <comments>
                            <comment id="13649519" author="thejas" created="Mon, 6 May 2013 04:26:27 +0000"  >&lt;p&gt; It would better to call shim.closeAllForUGI to free up the FileSystem objects, like it is done for the kerberos mode  from HiveSessionImplwithUGI.close().&lt;/p&gt;

&lt;p&gt;Calling shim.closeAllForUGI at end of  TUGIContainingProcessor.process is too early and ends up returning empty results for the queries.&lt;/p&gt;</comment>
                            <comment id="13649528" author="clarkyzl" created="Mon, 6 May 2013 05:17:13 +0000"  >&lt;p&gt;Is this issue related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3098&quot; title=&quot;Memory leak from large number of FileSystem instances in FileSystem.CACHE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3098&quot;&gt;&lt;del&gt;HIVE-3098&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3155&quot; title=&quot;Memory leak in Hive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3155&quot;&gt;&lt;del&gt;HIVE-3155&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="13649529" author="clarkyzl" created="Mon, 6 May 2013 05:22:19 +0000"  >&lt;p&gt;I think HS1 has similar problems...&lt;/p&gt;</comment>
                            <comment id="13649542" author="thejas" created="Mon, 6 May 2013 06:36:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clarkyzl&quot; class=&quot;user-hover&quot; rel=&quot;clarkyzl&quot;&gt;Zhuoluo Yang&lt;/a&gt; Yes, &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3098&quot; title=&quot;Memory leak from large number of FileSystem instances in FileSystem.CACHE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3098&quot;&gt;&lt;del&gt;HIVE-3098&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3155&quot; title=&quot;Memory leak in Hive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3155&quot;&gt;&lt;del&gt;HIVE-3155&lt;/del&gt;&lt;/a&gt; are related, as it is same kind of leak is seen, but with metastore and hive server1 instead.&lt;/p&gt;</comment>
                            <comment id="13649543" author="thejas" created="Mon, 6 May 2013 06:38:04 +0000"  >&lt;p&gt;I have updated hiveserver2 setup instructions to disable the fs caches - &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/Setting+up+HiveServer2&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/Setting+up+HiveServer2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13652680" author="thejas" created="Thu, 9 May 2013 02:20:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4501&quot; title=&quot;HS2 memory leak - FileSystem objects in FileSystem.CACHE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4501&quot;&gt;&lt;del&gt;HIVE-4501&lt;/del&gt;&lt;/a&gt;.1.patch - disables fs cache by default, in non-kerberos mode with impersonation turned on. Makes hive work with default settings. &lt;/p&gt;</comment>
                            <comment id="13775756" author="apivovarov" created="Mon, 23 Sep 2013 23:00:34 +0000"  >&lt;p&gt;Thejas, I&apos;m confused&lt;br/&gt;
patch sets fs.hdfs.impl.disable.cache to false&lt;br/&gt;
but wiki says set it to true&lt;/p&gt;</comment>
                            <comment id="13775968" author="thejas" created="Tue, 24 Sep 2013 03:56:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apivovarov&quot; class=&quot;user-hover&quot; rel=&quot;apivovarov&quot;&gt;Alexander Pivovarov&lt;/a&gt;  Sorry about that, the patch should actually set it to true. (i wish we didn&apos;t use negative flags !) &lt;/p&gt;</comment>
                            <comment id="13776008" author="apivovarov" created="Tue, 24 Sep 2013 05:39:31 +0000"  >&lt;p&gt;After set them to false I see 4 Lease checker threads created on each query execution.&lt;/p&gt;</comment>
                            <comment id="13776963" author="sarutak" created="Wed, 25 Sep 2013 00:04:45 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;Thejas M Nair&lt;/a&gt;&lt;br/&gt;
Now, I try to address the issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5296&quot; title=&quot;Memory leak: OOM Error after multiple open/closed JDBC connections. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5296&quot;&gt;&lt;del&gt;HIVE-5296&lt;/del&gt;&lt;/a&gt;, which includes this issue.&lt;br/&gt;
I think, it&apos;s better to call FileSystem.closeAll at the end of the session than disable cache because a FileSystem object can be used more than 1 time in a statement.&lt;/p&gt;</comment>
                            <comment id="13777022" author="sarutak" created="Wed, 25 Sep 2013 01:02:52 +0000"  >&lt;p&gt;Sorry, I think that we use FileSystem.closeAll may be not good idea because a thread can block others threads by synchronizing. So, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;Thejas M Nair&lt;/a&gt; idea may be better.&lt;/p&gt;</comment>
                            <comment id="13777816" author="cos" created="Wed, 25 Sep 2013 18:01:25 +0000"  >&lt;p&gt;Provided patch doesn&apos;t solve the problem though, to my understanding. It makes it less pronounced for sure, but it doesn&apos;t go away.&lt;/p&gt;</comment>
                            <comment id="13777903" author="thejas" created="Wed, 25 Sep 2013 18:49:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cos&quot; class=&quot;user-hover&quot; rel=&quot;cos&quot;&gt;Konstantin Boudnik&lt;/a&gt; Can you please elaborate ? The problem is memory leak in HS2 caused by FileSystem objects being cached in FileSystem.CACHE. Why won&apos;t disabling the cache stop the leak ?&lt;/p&gt;</comment>
                            <comment id="13777991" author="apivovarov" created="Wed, 25 Sep 2013 19:48:54 +0000"  >&lt;p&gt;if cache is disabled then 4 lease checker threads are created for each query in hiveserver2 process.&lt;br/&gt;
These threads keep running even after client closes the connection.&lt;br/&gt;
I tested it in hive-0.11&lt;/p&gt;</comment>
                            <comment id="13778006" author="thejas" created="Wed, 25 Sep 2013 20:02:20 +0000"  >&lt;p&gt;I have corrected the description to say that these variables should be set to true to disable the cache.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apivovarov&quot; class=&quot;user-hover&quot; rel=&quot;apivovarov&quot;&gt;Alexander Pivovarov&lt;/a&gt;&lt;br/&gt;
I thought you saw lease checker threads when you set the variables to false (ie cache was not disabled). &lt;/p&gt;</comment>
                            <comment id="13778019" author="apivovarov" created="Wed, 25 Sep 2013 20:16:04 +0000"  >&lt;p&gt;if cache is enabled then only one FileSystem per query is not closed&lt;br/&gt;
But if cache is disabled then 4 FileSystems are not closed - as a result 4 lease checker threads leak per query&lt;/p&gt;

&lt;p&gt;How disabling FileSystem cache can help with closing FileSystem?&lt;br/&gt;
if we write smth to hdfs then Lease Checker thread is created. To stop the thread File System should be closed.&lt;br/&gt;
The only question is where.&lt;br/&gt;
As we already know calling close() at he end of TUGIContainingProcessor.process is too early.&lt;br/&gt;
So, where should it be called?&lt;/p&gt;</comment>
                            <comment id="13778060" author="sarutak" created="Wed, 25 Sep 2013 20:49:36 +0000"  >&lt;p&gt;I think we need to close FileSystem object properly, right?&lt;/p&gt;</comment>
                            <comment id="13778217" author="apivovarov" created="Wed, 25 Sep 2013 23:20:03 +0000"  >&lt;p&gt;Probably we can set ctx.setHDFSCleanup(false) in Driver   (lines 415, 1126)&lt;br/&gt;
after that the fix reverted here should work &lt;a href=&quot;https://github.com/apache/hive/commit/4de1b5acc0b0507787bc8e74259a15e414dcb49e&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hive/commit/4de1b5acc0b0507787bc8e74259a15e414dcb49e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;set HDFScleanup to false is ok because clean of tmp files on exit did not work because fs was never closed.&lt;/p&gt;</comment>
                            <comment id="13778247" author="henry.wang" created="Wed, 25 Sep 2013 23:50:29 +0000"  >&lt;p&gt;Setting hive.server2.enable.doAs to false is a workaround.&lt;/p&gt;</comment>
                            <comment id="13778256" author="cos" created="Thu, 26 Sep 2013 00:03:43 +0000"  >&lt;p&gt;But it essentially prevents auth mechanism for HS2, right?&lt;/p&gt;</comment>
                            <comment id="13779135" author="apivovarov" created="Thu, 26 Sep 2013 19:32:41 +0000"  >&lt;p&gt;I did the fix which solves the problem with open FileSystems. (in case hive.server2.enable.doAs is true (which is default))&lt;/p&gt;

&lt;p&gt;I remember all UGIs created during Statement execution/fetch and then close FSs for all these UGIs on Statement.close() event  (Filesystem CACHE should be enabled)&lt;br/&gt;
I tested it - it looks good. Can you review the fix?&lt;br/&gt;
&lt;a href=&quot;https://github.com/WANdisco/amplab-hive/commit/ef7b4f618323796e730a0a4025455fa3a8fc66d6&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/WANdisco/amplab-hive/commit/ef7b4f618323796e730a0a4025455fa3a8fc66d6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13779139" author="cos" created="Thu, 26 Sep 2013 19:37:26 +0000"  >&lt;p&gt;Posting the patch for his fix on JIRA.&lt;/p&gt;</comment>
                            <comment id="13780156" author="sarutak" created="Fri, 27 Sep 2013 17:52:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apivovarov&quot; class=&quot;user-hover&quot; rel=&quot;apivovarov&quot;&gt;Alexander Pivovarov&lt;/a&gt; I revased your patch and found that FileSystem.CACHE doesn&apos;t leak.&lt;/p&gt;</comment>
                            <comment id="13780343" author="cos" created="Fri, 27 Sep 2013 20:31:57 +0000"  >&lt;p&gt;So, shall we have committed it to the trunk and 0.12?&lt;/p&gt;</comment>
                            <comment id="13780368" author="thejas" created="Fri, 27 Sep 2013 20:52:22 +0000"  >&lt;p&gt;I will review it today.&lt;/p&gt;

&lt;p&gt;Closing the fs is certainly better than just disabling the cache. The benefit of explicitly closing the FS instead of just letting the GC collect it (by disabling the cache) seems to be that the deleteOnExit() calls will actually take effect. But I am not sure if hive code is relying on deleteOnExit() to happen on the client side. I haven&apos;t seen file/file handle leaks in long running HS2 . I believe the lease checker threads also go away when GC kicks in (based on my experience with long running HS2 with many queries).&lt;/p&gt;

</comment>
                            <comment id="13780369" author="thejas" created="Fri, 27 Sep 2013 20:52:43 +0000"  >&lt;p&gt;Making it patch available to kick off the tests.&lt;/p&gt;</comment>
                            <comment id="13780531" author="cos" created="Fri, 27 Sep 2013 22:51:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;I believe the lease checker threads also go away when GC kicks in&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We haven&apos;t observed that behavior in our tests, not with explicit GC at least.&lt;/p&gt;</comment>
                            <comment id="13780649" author="hiveqa" created="Sat, 28 Sep 2013 01:48:02 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 no tests executed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12605318/HIVE-4501.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12605318/HIVE-4501.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/942/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/942/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/942/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/942/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Tests failed with: NonZeroExitCodeException: Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n &apos;&apos; ]]
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-Build-942/source-prep.txt
+ mkdir -p maven ivy
+ [[ svn = \s\v\n ]]
+ [[ -n &apos;&apos; ]]
+ [[ -d apache-svn-trunk-source ]]
+ [[ ! -d apache-svn-trunk-source/.svn ]]
+ [[ ! -d apache-svn-trunk-source ]]
+ cd apache-svn-trunk-source
+ svn revert -R .
++ awk &apos;{print $2}&apos;
++ egrep -v &apos;^X|^Performing status on external&apos;
++ svn status --no-ignore
+ rm -rf
+ svn update

Fetching external item into &apos;hcatalog/src/test/e2e/harness&apos;
External at revision 1527140.

At revision 1527140.
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0 to p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13780676" author="cos" created="Sat, 28 Sep 2013 03:33:12 +0000"  >&lt;p&gt;Regenerating patch with -p0&lt;/p&gt;</comment>
                            <comment id="13780678" author="cos" created="Sat, 28 Sep 2013 03:33:52 +0000"  >&lt;p&gt;Wrong patch structure - needs to be regenerated with p0&lt;/p&gt;</comment>
                            <comment id="13780697" author="hiveqa" created="Sat, 28 Sep 2013 05:03:16 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 no tests executed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12605629/HIVE-4501.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12605629/HIVE-4501.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/947/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/947/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/947/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/947/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Tests failed with: NonZeroExitCodeException: Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n &apos;&apos; ]]
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-Build-947/source-prep.txt
+ mkdir -p maven ivy
+ [[ svn = \s\v\n ]]
+ [[ -n &apos;&apos; ]]
+ [[ -d apache-svn-trunk-source ]]
+ [[ ! -d apache-svn-trunk-source/.svn ]]
+ [[ ! -d apache-svn-trunk-source ]]
+ cd apache-svn-trunk-source
+ svn revert -R .
++ awk &apos;{print $2}&apos;
++ egrep -v &apos;^X|^Performing status on external&apos;
++ svn status --no-ignore
+ rm -rf
+ svn update

Fetching external item into &apos;hcatalog/src/test/e2e/harness&apos;
External at revision 1527150.

At revision 1527150.
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0 to p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13780914" author="cos" created="Sat, 28 Sep 2013 18:17:10 +0000"  >&lt;p&gt;Here&apos;s the trunk patch. The original one wasn&apos;t applicable for the trunk version and should have been clearly marked as such. Apologies.&lt;/p&gt;</comment>
                            <comment id="13782587" author="thejas" created="Tue, 1 Oct 2013 03:18:17 +0000"  >&lt;p&gt;I reviewed the patch. The patch seems to make an assumption that same thread is used for whole session. This is not the case, same thread can get used for another session, once the call for a session has been serviced. This will close FileSystems associated with other sessions as well.&lt;/p&gt;

&lt;p&gt;A clean way to deal with this would be to use same way as its done for impersonation in kerberos mode, ie using HiveSessionImplwithUGI .&lt;/p&gt;</comment>
                            <comment id="13782632" author="cos" created="Tue, 1 Oct 2013 04:58:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is not the case, same thread can get used for another session&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Are you saying that the same FS ref. can be used across UGIs? If so, It looks like a nice big hole to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The call for the close of FS is done at the point where the particular UGI&apos;s session is getting finished and all its resources are let go, e.g. operation handlers, metastore, etc. I am not sure if I follow your comment. Could you please elaborate?&lt;/p&gt;</comment>
                            <comment id="13782668" author="thejas" created="Tue, 1 Oct 2013 06:47:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are you saying that the same FS ref. can be used across UGIs? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, that is not happening in current code. But this patch will accumulate FS refs that belong to different sessions and when a session is closed it can end up closing FS objects that are associated with other sessions, and not closing the FS handles that belong to the session being closed. &lt;br/&gt;
The change in TUGIContainingProcessor will just accumulate FS handles to a thread local variable.  But that thread can be used by different hive sessions. There is no 1:1 mapping between hive server 2 threads and hive sessions. I hope this clarifies.&lt;/p&gt;
</comment>
                            <comment id="13782669" author="thejas" created="Tue, 1 Oct 2013 06:49:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;The change in TUGIContainingProcessor will just accumulate FS handles to a thread local variable.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Correction (i meant to say): The change in TUGIContainingProcessor will just accumulate UGI objects to a thread local variable. The UGI objects being accumulated in the thread local hashset can belong to different sessions.&lt;/p&gt;
</comment>
                            <comment id="13905687" author="ashahab" created="Wed, 19 Feb 2014 17:12:29 +0000"  >&lt;p&gt;What is the progress on this issue?&lt;/p&gt;</comment>
                            <comment id="13935377" author="thejas" created="Fri, 14 Mar 2014 18:17:03 +0000"  >&lt;p&gt;The changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6312&quot; title=&quot;doAs with plain sasl auth should be session aware&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-6312&quot;&gt;&lt;del&gt;HIVE-6312&lt;/del&gt;&lt;/a&gt; (in 0.13) should fix this issue, as the unsecure mode now follows same code path as secure mode, which calls closeAllForUGI .&lt;br/&gt;
I haven&apos;t verified with large number of requests and cache enabled, but if there is still any leak its going to have a different root cause.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12691303">HIVE-6312</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12746265">HIVE-8369</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12595088">HDFS-3545</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12696679">HIVE-6484</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12667990">HIVE-5268</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12559587">HIVE-3098</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12668772">HIVE-5296</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12764307">HIVE-9234</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12605629" name="HIVE-4501.1.patch" size="4009" author="cos" created="Sat, 28 Sep 2013 03:33:12 +0000"/>
                            <attachment id="12605318" name="HIVE-4501.1.patch" size="4203" author="cos" created="Thu, 26 Sep 2013 19:37:26 +0000"/>
                            <attachment id="12582416" name="HIVE-4501.1.patch" size="2222" author="thejas" created="Thu, 9 May 2013 02:20:19 +0000"/>
                            <attachment id="12605665" name="HIVE-4501.trunk.patch" size="3596" author="cos" created="Sat, 28 Sep 2013 18:16:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 May 2013 05:17:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326509</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kbv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326854</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>