<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 11:37:38 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-14263/HIVE-14263.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-14263] Log message when HS2 query is waiting on compile lock</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14263</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description></description>
                <environment></environment>
        <key id="12990243">HIVE-14263</key>
            <summary>Log message when HS2 query is waiting on compile lock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="taoli-hwx">Tao Li</assignee>
                                    <reporter username="thejas">Thejas M Nair</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jul 2016 03:40:12 +0000</created>
                <updated>Wed, 27 Jul 2016 05:59:00 +0000</updated>
                            <resolved>Sat, 23 Jul 2016 23:38:09 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15389034" author="thejas" created="Fri, 22 Jul 2016 06:46:18 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=taoli-hwx&quot; class=&quot;user-hover&quot; rel=&quot;taoli-hwx&quot;&gt;Tao Li&lt;/a&gt;!&lt;br/&gt;
Some comments on 1.patch -&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &apos;final string&apos; can be in the tryAcquireCompileLock method itself as they are not being referenced from anywhere else. Maybe we don&apos;t even need those variables, as they are just used once within the functions. Thats easier to read.&lt;/li&gt;
	&lt;li&gt;&quot;a call to tryLock() will immediately acquire the lock if it is available, whether or not other threads are currently waiting for the lock. &quot; &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/ReentrantLock.html#tryLock(&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/ReentrantLock.html#tryLock(&lt;/a&gt;). Looks like  tryLock(0, TimeUnit.SECONDS) is the better call to make&lt;/li&gt;
	&lt;li&gt;Use SessionState.getConsole().logInfo instead of ol.writeOperationLog. I see that ol.writeOperationLog is being used at few other places, that should be cleaned up. SessionState.getConsole().* methods are used in almost all places for information . We can cleanup the usage of ol.writeOperationLog in a separate patch.&lt;/li&gt;
	&lt;li&gt;LOG.debug(waitingForLockMsg + &quot;: &quot; + command)  can be removed once SessionState.getConsole().logInfo is used. It will print to the HS2 log as well.&lt;/li&gt;
	&lt;li&gt;If the &apos;waiting for lock&apos; is printed, its useful to also have the &apos;acquired lock&apos; message printed. How about replacing  LOG.debug(lockAcquiredMsg); with SessionState.getConsole().logInfo(lockAcquiredMsg) ?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15389812" author="taoli-hwx" created="Fri, 22 Jul 2016 16:46:02 +0000"  >&lt;p&gt;Thanks for your comments &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;Thejas M Nair&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Regarding #2, according to &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/ReentrantLock.html#tryLock()&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;doc&lt;/a&gt; about tryLock, &quot;If you want to honor the fairness setting for this lock, then use tryLock(0, TimeUnit.SECONDS) which is almost equivalent (it also detects interruption).&quot; The only difference between tryLock() and tryLock(0, TimeUnit.SECONDS) is that the latter throws a InterruptionException. I don&apos;t think we really need to use tryLock(0, TimeUnit.SECONDS) except there is a convention there.&lt;/p&gt;

&lt;p&gt;Regarding #5, I intentionally left out the &quot;lock acquired&quot; message to minimize the number of rows of messages before displaying the query result, since I think that&apos;s a little bit intrusive to the users. The original purpose of this change is to indicate the waiting status to the end users when the compilation task is waiting for the lock. So as long as we print out the waiting message, it should satisfy that purpose. In normal cases the query result should be displayed after lock is acquired, so I don&apos;t think the &quot;lock acquired&quot; message is really useful/necessary for the beeline users.&lt;/p&gt;

&lt;p&gt;I will make changes based on other comments. They are good points.   &lt;/p&gt;</comment>
                            <comment id="15389881" author="thejas" created="Fri, 22 Jul 2016 17:32:48 +0000"  >&lt;p&gt;Regarding tryLock. tryLock() doesn&apos;t honor the waiting queue, ie it jumps in middle of the queue. So even if there are 10 other threads blocked on the lock call, a newer query might get the lock. Giving priority to ones that have been waiting longer would result in more predictable behavior for user.&lt;/p&gt;

&lt;p&gt;Regagrding &quot;lock acquired&quot; message, for queries that don&apos;t immediately return results or print another message, the users (and hadoop admins) are likely to suspect that it is still stuck at waiting for lock. But it might be stuck somewhere else (maybe an issue with yarn for example).&lt;br/&gt;
Hopefully, the cases where query waits on the compile lock won&apos;t be that common.&lt;/p&gt;</comment>
                            <comment id="15389882" author="thejas" created="Fri, 22 Jul 2016 17:32:50 +0000"  >&lt;p&gt;Regarding tryLock. tryLock() doesn&apos;t honor the waiting queue, ie it jumps in middle of the queue. So even if there are 10 other threads blocked on the lock call, a newer query might get the lock. Giving priority to ones that have been waiting longer would result in more predictable behavior for user.&lt;/p&gt;

&lt;p&gt;Regagrding &quot;lock acquired&quot; message, for queries that don&apos;t immediately return results or print another message, the users (and hadoop admins) are likely to suspect that it is still stuck at waiting for lock. But it might be stuck somewhere else (maybe an issue with yarn for example).&lt;br/&gt;
Hopefully, the cases where query waits on the compile lock won&apos;t be that common.&lt;/p&gt;</comment>
                            <comment id="15389910" author="taoli-hwx" created="Fri, 22 Jul 2016 17:47:05 +0000"  >&lt;p&gt;That makes sense. I will make the changes. Thanks!&lt;/p&gt;</comment>
                            <comment id="15390318" author="taoli-hwx" created="Fri, 22 Jul 2016 22:38:59 +0000"  >&lt;p&gt;Looks like the message pipe from HS to beeline client is broken (for master branch) and thus calling SessionState.getConsole().logInfo() does not result in any messages on beeline. So I will stick with the operational log for now.&lt;/p&gt;</comment>
                            <comment id="15390581" author="hiveqa" created="Sat, 23 Jul 2016 06:45:35 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12819731/HIVE-14263.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12819731/HIVE-14263.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 9 failed/errored test(s), 10342 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hadoop.hive.metastore.txn.TestCompactionTxnHandler.testRevokeTimedOutWorkers
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/606/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/606/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/606/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/606/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-606/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-606/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12819731 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15390870" author="thejas" created="Sat, 23 Jul 2016 23:38:09 +0000"  >&lt;p&gt;The test failures are not related.&lt;br/&gt;
Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=taoli-hwx&quot; class=&quot;user-hover&quot; rel=&quot;taoli-hwx&quot;&gt;Tao Li&lt;/a&gt;!&lt;br/&gt;
Patch committed to master and branch-2.1&lt;/p&gt;</comment>
                            <comment id="15390942" author="taoli-hwx" created="Sun, 24 Jul 2016 05:04:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;Thejas M Nair&lt;/a&gt; for the help!&lt;/p&gt;</comment>
                            <comment id="15395100" author="thejas" created="Wed, 27 Jul 2016 05:59:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=taoli-hwx&quot; class=&quot;user-hover&quot; rel=&quot;taoli-hwx&quot;&gt;Tao Li&lt;/a&gt;&lt;br/&gt;
I think this would be useful for hive-1 as well. Can you please contribute a patch for hive1 ?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12819555" name="HIVE-14263.1.patch" size="2076" author="taoli-hwx" created="Fri, 22 Jul 2016 04:55:47 +0000"/>
                            <attachment id="12819731" name="HIVE-14263.2.patch" size="2082" author="taoli-hwx" created="Fri, 22 Jul 2016 22:25:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 22 Jul 2016 16:46:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31407:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>