<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 05:04:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-14690/HIVE-14690.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-14690] Query fail when hive.exec.parallel=true, with conflicting session dir</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14690</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;This happens when hive.scratchdir.lock=true. Error message:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/hive/scratch/343hdirdp/cab907fc-5e1d-4d69-aa72-d7b442495c7a/inuse.info (inode 19537): File does not exist. [Lease.  Holder: DFSClient_NONMAPREDUCE_1572639975_1, pendingcreates: 2]
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.checkLease(FSNamesystem.java:3430)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.analyzeFileState(FSNamesystem.java:3235)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getNewBlockTargets(FSNamesystem.java:3073)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock(FSNamesystem.java:3033)
	at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.addBlock(NameNodeRpcServer.java:725)
	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.addBlock(ClientNamenodeProtocolServerSideTranslatorPB.java:492)
	at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)
	at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:969)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2137)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2133)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1668)
	at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2131)

	at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:535)
	at org.apache.hadoop.hive.ql.exec.TaskRunner.run(TaskRunner.java:74)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13002188">HIVE-14690</key>
            <summary>Query fail when hive.exec.parallel=true, with conflicting session dir</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Sep 2016 22:39:35 +0000</created>
                <updated>Tue, 11 Oct 2016 23:33:53 +0000</updated>
                            <resolved>Tue, 11 Oct 2016 22:55:05 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>2.1.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15457607" author="thejas" created="Fri, 2 Sep 2016 05:48:44 +0000"  >&lt;p&gt;It seems like we shouldn&apos;t be doing what is done in SesssionState.start just once, except for the part that sets the thread local variable - setCurrentSessionState.&lt;/p&gt;

&lt;p&gt;Should we just add a isStarted boolean to SessionState and do the rest only once ?&lt;/p&gt;</comment>
                            <comment id="15457659" author="daijy" created="Fri, 2 Sep 2016 06:15:22 +0000"  >&lt;p&gt;Yes, seems to be. But that needs more test to verify everything is fine as the impact is bigger. I can put a patch to test.&lt;/p&gt;</comment>
                            <comment id="15469031" author="taoli-hwx" created="Wed, 7 Sep 2016 00:11:14 +0000"  >&lt;p&gt;Are we trying to avoid concurrent start() calls from multiple threads? If so, shall we make isStarted volatile?&lt;/p&gt;</comment>
                            <comment id="15469182" author="daijy" created="Wed, 7 Sep 2016 01:23:12 +0000"  >&lt;p&gt;I want to start the session only once. Yes start will be invoked from multiple threads. Look again and I think we need to make start synchronized to avoid race condition. However, I don&apos;t see a reason make isStarted volatile.&lt;/p&gt;</comment>
                            <comment id="15469314" author="hiveqa" created="Wed, 7 Sep 2016 02:47:29 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12827285/HIVE-14690.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12827285/HIVE-14690.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 7 failed/errored test(s), 10453 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestBeeLineWithArgs - did not produce a TEST-*.xml file
TestHiveCli - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1116/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1116/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1116/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1116/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1116/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1116/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12827285 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15469584" author="taoli-hwx" created="Wed, 7 Sep 2016 05:16:07 +0000"  >&lt;p&gt;I have 2 more comments:&lt;/p&gt;

&lt;p&gt;1. Should we set startSs.isStarted to true by the end of the method? If exceptions are thrown during the middle, we probably don&apos;t want to set it to true.&lt;/p&gt;

&lt;p&gt;2. I think we can add a synchronization block after the if (startSs.isStarted) check to improve performance (vs the synchronized method). We don&apos;t need to enter the monitor to check the flag. Inside the monitor, we can double check the flag (return if the isStarted has been set to true).&lt;/p&gt;</comment>
                            <comment id="15475261" author="daijy" created="Thu, 8 Sep 2016 22:50:30 +0000"  >&lt;p&gt;Tao,&lt;br/&gt;
1. The problem is there is multiple exits in the code and it would be hard to maintain going forward, though what you said is ideal&lt;br/&gt;
2. Do you mean:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    setCurrentSessionState(startSs);

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (startSs.isStarted) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
    ......
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The code outside the synchronization block will be trivial, right?&lt;/p&gt;</comment>
                            <comment id="15475480" author="taoli-hwx" created="Fri, 9 Sep 2016 00:46:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;The code outside the synchronization block will be trivial, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is just a perf optimization. Concurrent calls should be able to check the flag without waiting for the lock.&lt;/p&gt;</comment>
                            <comment id="15494772" author="daijy" created="Thu, 15 Sep 2016 22:55:36 +0000"  >&lt;p&gt;Agree, but seems it is a trivial savings, and I&apos;d like to trade in favor of code clarity in this case.&lt;/p&gt;

&lt;p&gt;In terms of unit test, I don&apos;t find a way to mimic the failure as even the MiniCluster use local fs which will not throw exception when file exists.&lt;/p&gt;</comment>
                            <comment id="15564081" author="thejas" created="Tue, 11 Oct 2016 01:09:50 +0000"  >&lt;p&gt;I think setting isStarted=true in beginning of function is fine. There are no retries we do in case of SessionStart failure, we consider that an error in starting the session. &lt;/p&gt;

&lt;p&gt;+1 to the patch.&lt;/p&gt;</comment>
                            <comment id="15566880" author="daijy" created="Tue, 11 Oct 2016 22:55:05 +0000"  >&lt;p&gt;Test failures are not related.&lt;/p&gt;

&lt;p&gt;Patch pushed to both master and branch-1.&lt;/p&gt;</comment>
                            <comment id="15566958" author="daijy" created="Tue, 11 Oct 2016 23:33:53 +0000"  >&lt;p&gt;Need to mention there is no way to add unit test. The exception only happens on hdfs. Even MiniCluster is using local filesystem which will not throw exception.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12956319">HIVE-13429</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12826722" name="HIVE-14690.1.patch" size="1712" author="daijy" created="Thu, 1 Sep 2016 22:51:14 +0000"/>
                            <attachment id="12826775" name="HIVE-14690.2.patch" size="1031" author="daijy" created="Fri, 2 Sep 2016 06:20:25 +0000"/>
                            <attachment id="12827285" name="HIVE-14690.3.patch" size="1180" author="daijy" created="Wed, 7 Sep 2016 01:23:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 2 Sep 2016 05:48:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i335o7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue>12332154</customfieldvalue>
    <customfieldvalue>12335837</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>