<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 23:17:08 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-1428/HIVE-1428.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-1428] ALTER TABLE ADD PARTITION fails with a remote Thrift metastore</title>
                <link>https://issues.apache.org/jira/browse/HIVE-1428</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;If the hive cli is configured to use a remote metastore, ALTER TABLE ... ADD PARTITION commands will fail with an error similar to the following:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;pradeepk@chargesize:~/dev/howl&amp;#93;&lt;/span&gt;hive --auxpath ult-serde.jar -e &quot;ALTER TABLE mytable add partition(datestamp = &apos;20091101&apos;, srcid = &apos;10&apos;,action) location &apos;/user/pradeepk/mytable/20091101/10&apos;;&quot;&lt;br/&gt;
10/06/16 17:08:59 WARN conf.Configuration: DEPRECATED: hadoop-site.xml found in the classpath. Usage of hadoop-site.xml is deprecated. Instead use core-site.xml, mapred-site.xml and hdfs-site.xml to override properties of core-default.xml, mapred-default.xml and hdfs-default.xml respectively&lt;br/&gt;
Hive history file=/tmp/pradeepk/hive_job_log_pradeepk_201006161709_1934304805.txt&lt;br/&gt;
FAILED: Error in metadata: org.apache.thrift.TApplicationException: get_partition failed: unknown result&lt;br/&gt;
FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;pradeepk@chargesize:~/dev/howl&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This is due to a check that tries to retrieve the partition to see if it exists. If it does not, an attempt is made to pass a null value from the metastore. Since thrift does not support null return values, an exception is thrown.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12467649">HIVE-1428</key>
            <summary>ALTER TABLE ADD PARTITION fails with a remote Thrift metastore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pradeepkth">Pradeep Kamath</assignee>
                                    <reporter username="pauly">Paul Yang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jun 2010 01:02:22 +0000</created>
                <updated>Sat, 17 Dec 2011 00:03:42 +0000</updated>
                            <resolved>Sat, 14 Aug 2010 01:06:59 +0000</resolved>
                                    <version>0.5.0</version>
                                    <fixVersion>0.6.0</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12882445" author="pradeepkth" created="Fri, 25 Jun 2010 05:06:36 +0000"  >&lt;p&gt;Attached patch addresses the issue by throwing a NoSuchObjectException in ObjectStore for get_partition() method when there are no partitions matching the arguments. This requires a change in the thrift idl for hive_metastore. Hence the patch also has the compiler generated files. I have tested that the &quot;ALTER TABLE ADD pARTITION..&quot; works when hive client uses thrift and connects to a thrift server and also in the case it connects directly to the db - not sure how to test this in a unit test framework - would need some guidance in that area.&lt;/p&gt;</comment>
                            <comment id="12882718" author="pauly" created="Fri, 25 Jun 2010 21:17:19 +0000"  >&lt;p&gt;The unit tests that we have for the metastore run locally, so I don&apos;t think there&apos;s a way to use the existing framework for the thrift command - take a look at TestHiveMetastore.java. To test this, you would have to create a new JUnit test (or modify the existing one) to sets up a metastore server and issues commands (create table, drop table, etc) to it. Does that seem doable?&lt;/p&gt;</comment>
                            <comment id="12883614" author="pradeepkth" created="Tue, 29 Jun 2010 16:59:28 +0000"  >&lt;p&gt;I have tried writing a unit test based on the existing one in TestHiveMetastore which starts off a thrift server. Unfortunately I have hit issues since some if the ant properties like build.dir do not get expanded in the conf seen by the server leading to error. I am attaching the Test file - can someone suggest how I can resolve this and if there is any other test which has attempted something similar.&lt;/p&gt;

&lt;p&gt;Here is the exception I see:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2Codec, fs.checkpoint.size=67108864}
    [junit] MetaException(message:Got exception: java.io.FileNotFoundException File file:/test/data/warehouse/compdb.db does not exist.)
    [junit]     at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$create_database_result.read(ThriftHiveMetastore.java:2751)
    [junit]     at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.recv_create_database(ThriftHiveMetastore.java:127)
    [junit]     at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.create_database(ThriftHiveMetastore.java:104)
    [junit]     at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.createDatabase(HiveMetaStoreClient.java:270)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the value in the conf as seen by the server:&lt;br/&gt;
 hive.metastore.warehouse.dir=&lt;a href=&quot;file://$&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;file://$&lt;/a&gt;&lt;/p&gt;
{build.dir}
&lt;p&gt;/test/data/warehouse/&lt;/p&gt;</comment>
                            <comment id="12884383" author="pauly" created="Thu, 1 Jul 2010 19:03:59 +0000"  >&lt;p&gt;Can you try using a thread to create a HiveMetaStore instance?&lt;/p&gt;

&lt;p&gt;e.g.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; class RunMS &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Running metastore!&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [] args = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [0];
      HiveMetaStore.main(args);
    }

  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setUp();

    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RunMS());
    t.start();

    &lt;span class=&quot;code-comment&quot;&gt;// Wait a little bit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the metastore to start. Should probably have
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// a better way of detecting &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the metastore has started?
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);

    &lt;span class=&quot;code-comment&quot;&gt;// Set conf to connect to the local metastore.
&lt;/span&gt;    HiveConf hiveConf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveConf(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass());
    &lt;span class=&quot;code-comment&quot;&gt;// hive.metastore.local should be defined in HiveConf
&lt;/span&gt;    hiveConf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.metastore.local&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
    hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS, &lt;span class=&quot;code-quote&quot;&gt;&quot;thrift:&lt;span class=&quot;code-comment&quot;&gt;//localhost:9083&quot;&lt;/span&gt;);
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// There&apos;s a bug in HiveConf that needs to be fixed before &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; next line 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// will work
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Change METATORETHRIFTRETRIES(&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.metastore.connect.retries&quot;&lt;/span&gt;, &quot;&quot;),
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// To METATORETHRIFTRETRIES(&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.metastore.connect.retries&quot;&lt;/span&gt;, 3),
&lt;/span&gt;    hiveConf.setIntVar(HiveConf.ConfVars.METATORETHRIFTRETRIES, 3);

    client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveMetaStoreClient(hiveConf);
    &lt;span class=&quot;code-comment&quot;&gt;// Now you have the client - run necessary tests.
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12884401" author="athusoo" created="Thu, 1 Jul 2010 20:20:15 +0000"  >&lt;p&gt;Is your question the fact that build.dir is an empty string? build.dir gets defined in build-common.xml which inturn picks properties from build.properties. The build.xml in the metastore directory includes build-common.xml so it should be getting build.dir. How are you running this test?&lt;/p&gt;</comment>
                            <comment id="12884437" author="pauly" created="Thu, 1 Jul 2010 21:45:00 +0000"  >&lt;p&gt;Meant to add - By using a thread, you can avoid having to set up an environment, classpath, etc. An important line is  &quot;HiveConf hiveConf = new HiveConf(this.getClass());&quot;, which allows you to load the configuration files that are in the classpath defined for testing.&lt;/p&gt;

&lt;p&gt;And the command to run the test should be &apos;ant test -Dtestcase=TestHiveMetastoreRemote&apos;&lt;/p&gt;</comment>
                            <comment id="12886349" author="pradeepkth" created="Thu, 8 Jul 2010 15:59:51 +0000"  >&lt;p&gt;New patch with unit tests included. Thanks for the suggestion of using threads Paul, have used that in the unit test. I have made a change in HiveConf to enable the unit test. The remaining changes in the patch are as in the first version - to throw NoSuchObjectException in getPartition() when no partition exists. This mainly changes the generated thrift code (to add throws in the method signature) and in other code which interacts with it to catch the exception and set the partition object to null.&lt;/p&gt;</comment>
                            <comment id="12886350" author="pradeepkth" created="Thu, 8 Jul 2010 16:00:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1428&quot; title=&quot;ALTER TABLE ADD PARTITION fails with a remote Thrift metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1428&quot;&gt;&lt;del&gt;HIVE-1428&lt;/del&gt;&lt;/a&gt;-2.patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="12886468" author="jvs" created="Thu, 8 Jul 2010 20:48:23 +0000"  >&lt;p&gt;Setting assignee to Pradeep.&lt;/p&gt;

&lt;p&gt;(Pradeep, I just added you as a contributor on Hive, so you should be able to assign issues to yourself going forward.)&lt;/p&gt;</comment>
                            <comment id="12886559" author="pauly" created="Thu, 8 Jul 2010 23:51:08 +0000"  >&lt;p&gt;Fix looks pretty good - two things though:&lt;/p&gt;

&lt;p&gt;1. The field identifiers for NoSuchObjectException and MetaException in hive_metastore.thrift should be swapped - this is because thrift uses those identifiers for versioning and we want to be consistent.&lt;/p&gt;

&lt;p&gt;2. TestHiveMetaStoreRemote and TestHiveMetaStore share quite a bit of code. Can you extract this out to a separate class? Or maybe roll the remote metastore client into TestHiveMetastore.&lt;/p&gt;</comment>
                            <comment id="12887477" author="pradeepkth" created="Mon, 12 Jul 2010 19:33:18 +0000"  >&lt;p&gt;New patch incorporating Paul&apos;s review comments attached.&lt;/p&gt;</comment>
                            <comment id="12887478" author="pradeepkth" created="Mon, 12 Jul 2010 19:33:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1428&quot; title=&quot;ALTER TABLE ADD PARTITION fails with a remote Thrift metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1428&quot;&gt;&lt;del&gt;HIVE-1428&lt;/del&gt;&lt;/a&gt;-3.patch is ready to be reviewed.&lt;/p&gt;</comment>
                            <comment id="12888011" author="pauly" created="Tue, 13 Jul 2010 21:12:19 +0000"  >&lt;p&gt;&quot;hive.metastore.local&quot; should be made into a HiveConf, but that can be done in a separate JIRA since it&apos;s probably used elsewhere as well. Looks good +1. &lt;/p&gt;</comment>
                            <comment id="12888018" author="pkamath" created="Tue, 13 Jul 2010 21:19:17 +0000"  >&lt;p&gt;Paul - thanks for the review - I presume you mean it should be part of HiveConf.ConfVars enum - I was wondering why it wasn&apos;t too but did not go to make that change since it is not pertinent to the issue. I think we should address that in a separate jira. Can this patch be committed now? Any other steps needed from me?&lt;/p&gt;</comment>
                            <comment id="12888020" author="jvs" created="Tue, 13 Jul 2010 21:26:32 +0000"  >&lt;p&gt;+1.  Will commit when tests pass.&lt;/p&gt;</comment>
                            <comment id="12888643" author="jvs" created="Thu, 15 Jul 2010 00:46:07 +0000"  >&lt;p&gt;Committed.  Thanks Pradeep!&lt;/p&gt;</comment>
                            <comment id="12898047" author="cwsteinbach" created="Fri, 13 Aug 2010 02:26:23 +0000"  >&lt;p&gt;We need to backport this fix to 0.6.0&lt;/p&gt;</comment>
                            <comment id="12898384" author="jvs" created="Fri, 13 Aug 2010 19:32:21 +0000"  >&lt;p&gt;I&apos;ll work on the 0.6 commit.&lt;/p&gt;</comment>
                            <comment id="12898491" author="jvs" created="Sat, 14 Aug 2010 01:06:59 +0000"  >&lt;p&gt;Committed to 0.6.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12451981" name="HIVE-1428-0.6.0-patch.txt" size="32311" author="cwsteinbach" created="Fri, 13 Aug 2010 02:26:56 +0000"/>
                            <attachment id="12448984" name="HIVE-1428-2.patch" size="37574" author="pradeepkth" created="Thu, 8 Jul 2010 15:59:51 +0000"/>
                            <attachment id="12449276" name="HIVE-1428-3.patch" size="29786" author="pradeepkth" created="Mon, 12 Jul 2010 19:33:18 +0000"/>
                            <attachment id="12448018" name="HIVE-1428.patch" size="23769" author="pradeepkth" created="Fri, 25 Jun 2010 05:06:36 +0000"/>
                            <attachment id="12448325" name="TestHiveMetaStoreRemote.java" size="13061" author="pradeepkth" created="Tue, 29 Jun 2010 16:59:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 25 Jun 2010 05:06:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>72904</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lf27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>123090</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>