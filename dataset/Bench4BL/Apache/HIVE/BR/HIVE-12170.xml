<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun Dec 04 00:33:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-12170/HIVE-12170.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-12170] normalize HBase metastore connection configuration</title>
                <link>https://issues.apache.org/jira/browse/HIVE-12170</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Right now there are two ways to get HBaseReadWrite instance in metastore. Both get a threadlocal instance (is there a good reason for that?).&lt;br/&gt;
1) One is w/o conf and only works if someone called the (2) before, from any thread.&lt;br/&gt;
2) The other blindly sets a static conf and then gets an instance with that conf, or if someone already happened to call (1) or (2) from this thread, it returns the existing instance with whatever conf was set before (but still resets the current conf to new conf).&lt;/p&gt;

&lt;p&gt;This doesn&apos;t make sense even in an already-thread-safe case (like linear CLI-based tests), and can easily lead to bugs as described; the config propagation logic is not good (example - &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12167&quot; title=&quot;HBase metastore causes massive number of ZK exceptions in MiniTez tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12167&quot;&gt;&lt;del&gt;HIVE-12167&lt;/del&gt;&lt;/a&gt;); some calls just reset config blindly, so there&apos;s no point in setting staticConf, other than for the callers of method (1) above who don&apos;t have a conf and would rely on the static (which is bad design).&lt;br/&gt;
Having connections with different configs reliably in not possible, and multi-threaded cases would also break - you could even set conf, have it reset and get instance with somebody else&apos;s conf. &lt;/p&gt;

&lt;p&gt;Static should definitely be removed, maybe threadlocal too (HConnection is thread-safe).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12904727">HIVE-12170</key>
            <summary>normalize HBase metastore connection configuration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alangates">Alan Gates</assignee>
                                    <reporter username="sershe">Sergey Shelukhin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Oct 2015 02:29:44 +0000</created>
                <updated>Tue, 16 Feb 2016 23:52:08 +0000</updated>
                            <resolved>Wed, 21 Oct 2015 23:57:04 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14956157" author="sershe" created="Wed, 14 Oct 2015 02:31:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alangates&quot; class=&quot;user-hover&quot; rel=&quot;alangates&quot;&gt;Alan Gates&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;Daniel Dai&lt;/a&gt; fyi&lt;/p&gt;</comment>
                            <comment id="14959447" author="alangates" created="Thu, 15 Oct 2015 19:11:34 +0000"  >&lt;p&gt;Here&apos;s the motivation and what I was trying to achieve:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Each thread in HiveMetaStore will have an instance of RawStore, hence of HBaseStore and HBaseReadWrite&lt;/li&gt;
	&lt;li&gt;Each instance needs a copy of the config file, but they should all have the same copy.  Thus the attempt to set it up front with a static call.&lt;/li&gt;
	&lt;li&gt;Not all places that need an instance of HBaseReadWrite will have a reference on hand nor will they have the proper config file.  Thus they need to be able to get the instance without the config file, and they need to get the right instance for the thread they are running in.  Hence the calls to getInstance with no config and the reference being threadlocal.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; So first, a question.  Why are we seeing different threads have different config files?  I certainly didn&apos;t expect that.  Is there a valid reason for it?&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a proposed patch that deals with this by moving getInstance(conf) to setConf(conf) and only having getInstance().  Does this look reasonable?&lt;/p&gt;</comment>
                            <comment id="14959478" author="sershe" created="Thu, 15 Oct 2015 19:29:24 +0000"  >&lt;p&gt;Will look at the patch after lunch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
The problems arise only with embedded metastore (including embedded in HS2). For the test, it appears that the different configs might have been caused by the issue fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12062&quot; title=&quot;enable HBase metastore file metadata cache for tez tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12062&quot;&gt;&lt;del&gt;HIVE-12062&lt;/del&gt;&lt;/a&gt;, where config in testing util is reset after HBase minicluster config is set, so all subsequent code uses a different config.&lt;br/&gt;
Another scenario is for embedded metastore usage for any service that gets different configs, like Tez AM. Tez AM should not rely on default config to create metastore and should instead rely on config of the query; I had problems with that before due to some static call to metastore where Tez AM would create ObjectStore even though it was configured later to connect to remote metastore via a query config. &lt;br/&gt;
For HS2, I don&apos;t know if we support connecting to multiple metastores. However, accessing embedded metastore from multiple threads may cause a thread safety problem.&lt;br/&gt;
Also a static like that seems pretty brittle in an abstract sense, and the API get(conf) is misleading, because it will return the instance with potentially different conf, and only set up the conf for the next call. &lt;/p&gt;

&lt;p&gt;If we assume the same conf perhaps we should not reset staticConf if already set, and should throw if it&apos;s a different conf&lt;/p&gt;</comment>
                            <comment id="14959785" author="sershe" created="Thu, 15 Oct 2015 22:50:02 +0000"  >&lt;p&gt;Patch looks good. One question - if the semantics are that we setConf once and then always use it, should it detect cases when setConf is called with different conf and fail?&lt;/p&gt;</comment>
                            <comment id="14960970" author="alangates" created="Fri, 16 Oct 2015 16:29:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;if the semantics are that we setConf once and then always use it, should it detect cases when setConf is called with different conf and fail?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Probably, but I was worried about the cost of comparing configs.  I was also wondering if there was a single place we could set it so that any subsequent call to setConf was an error, but I couldn&apos;t think of such a place.&lt;/p&gt;</comment>
                            <comment id="14961171" author="sershe" created="Fri, 16 Oct 2015 18:37:45 +0000"  >&lt;p&gt;Well right now it&apos;s just ignored, perhaps it should at least emit a log warning&lt;/p&gt;</comment>
                            <comment id="14963967" author="sershe" created="Mon, 19 Oct 2015 20:07:15 +0000"  >&lt;p&gt;Other than that, +1&lt;/p&gt;</comment>
                            <comment id="14967640" author="alangates" created="Wed, 21 Oct 2015 18:47:21 +0000"  >&lt;p&gt;Second version of the patch, it adds an info message if the config has already been set.  I chose info instead of warning because each thread in the metastore or HS2 will end up calling this, so that would be a lot of warnings for nothing.&lt;/p&gt;</comment>
                            <comment id="14967763" author="sershe" created="Wed, 21 Oct 2015 19:59:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14968077" author="hiveqa" created="Wed, 21 Oct 2015 22:19:40 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12767843/HIVE-12170.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12767843/HIVE-12170.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 4 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 9697 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.jdbc.TestSSL.testSSLFetchHttp
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5726/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5726/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5726/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5726/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5726/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5726/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12767843 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14968200" author="alangates" created="Wed, 21 Oct 2015 23:57:04 +0000"  >&lt;p&gt;Patch 2 committed.  Thanks Sergey for the review.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12904719">HIVE-12167</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12904719">HIVE-12167</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12767843" name="HIVE-12170.2.patch" size="16559" author="alangates" created="Wed, 21 Oct 2015 18:47:21 +0000"/>
                            <attachment id="12766855" name="HIVE-12170.patch" size="16261" author="alangates" created="Thu, 15 Oct 2015 19:11:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 Oct 2015 19:11:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 6 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mzbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>