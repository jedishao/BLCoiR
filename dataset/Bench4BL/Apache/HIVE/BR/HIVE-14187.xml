<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 05:17:59 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-14187/HIVE-14187.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-14187] JDOPersistenceManager objects remain cached if MetaStoreClient#close is not called</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14187</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;JDOPersistenceManager objects are cached in JDOPersistenceManagerFactory by DataNuclues.&lt;/p&gt;

&lt;p&gt;A new JDOPersistenceManager object gets created for every HMS thread since ObjectStore is a thread local.&lt;/p&gt;

&lt;p&gt;In non-embedded metastore mode, JDOPersistenceManager associated with a thread only gets cleaned up if IMetaStoreClient#close is called by the client (which calls ObjectStore#shutdown which calls JDOPersistenceManager#close which in turn removes the object from cache in JDOPersistenceManagerFactory#releasePersistenceManager&lt;br/&gt;
&lt;a href=&quot;https://github.com/datanucleus/datanucleus-api-jdo/blob/master/src/main/java/org/datanucleus/api/jdo/JDOPersistenceManagerFactory.java#L1271&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/datanucleus/datanucleus-api-jdo/blob/master/src/main/java/org/datanucleus/api/jdo/JDOPersistenceManagerFactory.java#L1271&lt;/a&gt;), i.e. the object will remain cached if client does not call close.&lt;/p&gt;

&lt;p&gt;For example: If one interrupts out of hive CLI shell (instead of using &apos;exit;&apos; command), SessionState#close does not get called, and hence IMetaStoreClient#close does not get called.&lt;/p&gt;

&lt;p&gt;Instead of relying the client to call close, it&apos;s cleaner to automatically perform RawStore related cleanup at the server end via deleteContext() which gets called when the server detects a lost/closed connection.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12987569">HIVE-14187</key>
            <summary>JDOPersistenceManager objects remain cached if MetaStoreClient#close is not called</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mohitsabharwal">Mohit Sabharwal</assignee>
                                    <reporter username="mohitsabharwal">Mohit Sabharwal</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jul 2016 18:27:38 +0000</created>
                <updated>Wed, 28 Sep 2016 21:19:10 +0000</updated>
                            <resolved>Fri, 15 Jul 2016 21:47:32 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15366575" author="vgumashta" created="Thu, 7 Jul 2016 18:40:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mohitsabharwal&quot; class=&quot;user-hover&quot; rel=&quot;mohitsabharwal&quot;&gt;Mohit Sabharwal&lt;/a&gt; Thanks for the patch. However, this will still not completely fix the issue as the the JDOPersistenceManager is cached in thread locals and threads in a threadpool can die randomly causing the objects to get accumulated. This was fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-7353&quot; title=&quot;HiveServer2 using embedded MetaStore leaks JDOPersistanceManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-7353&quot;&gt;&lt;del&gt;HIVE-7353&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9831&quot; title=&quot;HiveServer2 should use ConcurrentHashMap in ThreadFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9831&quot;&gt;&lt;del&gt;HIVE-9831&lt;/del&gt;&lt;/a&gt; for HS2. Maybe we can take a similar approach here?&lt;/p&gt;</comment>
                            <comment id="15366713" author="mohitsabharwal" created="Thu, 7 Jul 2016 20:26:32 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;Vaibhav Gumashta&lt;/a&gt;. I took a quick look at &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-7353&quot; title=&quot;HiveServer2 using embedded MetaStore leaks JDOPersistanceManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-7353&quot;&gt;&lt;del&gt;HIVE-7353&lt;/del&gt;&lt;/a&gt; and had a question. Regarding the comment &quot;the threadpools keep a certain number of threads live and kill excess threads after a configurable keepAliveTime expires ... ideally this is where we&apos;d plug in code to close the JDOPersistanceManager&quot; &amp;#8211; this applies only to those threads where JDOPersistanceManager#close was not already called, correct ? &lt;/p&gt;

&lt;p&gt;In the remote metastore case, deleteContext() will get executed when the underling transport gets closed for that thread (in WorkerProcess Runnable run() method). &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/server/TThreadPoolServer.java#L300&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/server/TThreadPoolServer.java#L300&lt;/a&gt;&lt;br/&gt;
In this patch, we call cleanupRawStore inside deleteContext() (which calls JDOPersistanceManager#close)&lt;br/&gt;
(If the client explicitly already called IMetaStoreClient#close on that connection, then the deleteContext() triggered cleanup will be a no-op.) &lt;/p&gt;

&lt;p&gt;I haven&apos;t looked at ThreadPoolExecutor code, but docs say &quot;even core threads are initially created and started only when new tasks arrive&quot;, &lt;br/&gt;
i.e. threads won&apos;t get pre-created (only to be killed later after keepalive timeout), but will get created when request arrives (which means&lt;br/&gt;
there will be a transport associated with it, which will trigger deleteContext() upon connection break). IOW, thread goes back to the pool&lt;br/&gt;
only after the deleteContext is called. And subsequently may get killed after keepalive timeout.&lt;/p&gt;

&lt;p&gt;So, unless someone manually kills the thread, it seems to me that deleteContext() covers the cleanup. (deleteContext() call is in the finally&lt;br/&gt;
block so that covers errors/exceptions). What do you think ? &lt;/p&gt;</comment>
                            <comment id="15372939" author="mohitsabharwal" created="Tue, 12 Jul 2016 14:14:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;Vaibhav Gumashta&lt;/a&gt;, do you have more input on the patch ? thanks. &lt;/p&gt;

</comment>
                            <comment id="15373316" author="mohitsabharwal" created="Tue, 12 Jul 2016 17:39:54 +0000"  >&lt;p&gt;Re-attaching patch, looks like didn&apos;t get triggered due to ptest issues.&lt;/p&gt;</comment>
                            <comment id="15374507" author="hiveqa" created="Wed, 13 Jul 2016 07:19:31 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12817473/HIVE-14187.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12817473/HIVE-14187.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to build exiting with an error&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-491/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-491/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n /usr/java/jdk1.8.0_25 ]]
+ export JAVA_HOME=/usr/java/jdk1.8.0_25
+ JAVA_HOME=/usr/java/jdk1.8.0_25
+ export PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m &apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m &apos;
+ export &apos;M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ M2_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-MASTER-Build-491/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
From https://github.com/apache/hive
   deeddf4..82e1551  master     -&amp;gt; origin/master
   a349f56..1072c3a  branch-2.1 -&amp;gt; origin/branch-2.1
+ git reset --hard HEAD
HEAD is now at deeddf4 HIVE-14139: NPE dropping permanent function (Rui reviewed by Sergey Shelukhin)
+ git clean -f -d
+ git checkout master
Already on &apos;master&apos;
Your branch is behind &apos;origin/master&apos; by 1 commit, and can be fast-forwarded.
  (use &quot;git pull&quot; to update your local branch)
+ git reset --hard origin/master
HEAD is now at 82e1551 HIVE-14158: Support masking and filtering of rows/columns: deal with derived column names (Pengcheng Xiong, reviewed by Ashutosh Chauhan) (addendum)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12817473 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15375396" author="vgumashta" created="Wed, 13 Jul 2016 17:28:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mohitsabharwal&quot; class=&quot;user-hover&quot; rel=&quot;mohitsabharwal&quot;&gt;Mohit Sabharwal&lt;/a&gt; Thanks for the details. Makes sense, I&apos;m +1 on the patch (might need rebase for QA run).&lt;/p&gt;</comment>
                            <comment id="15376053" author="mohitsabharwal" created="Thu, 14 Jul 2016 00:23:33 +0000"  >&lt;p&gt;Thanks for review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;Vaibhav Gumashta&lt;/a&gt;.  Attaching patch after rebase.&lt;/p&gt;</comment>
                            <comment id="15376088" author="mohitsabharwal" created="Thu, 14 Jul 2016 00:44:36 +0000"  >&lt;p&gt;Attaching patch after correct rebase this time.&lt;/p&gt;</comment>
                            <comment id="15378587" author="hiveqa" created="Thu, 14 Jul 2016 23:22:59 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12817853/HIVE-14187.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12817853/HIVE-14187.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 4 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 11 failed/errored test(s), 10324 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMinimrCliDriver.org.apache.hadoop.hive.cli.TestMinimrCliDriver
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-514/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-514/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12817853 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15378684" author="mohitsabharwal" created="Fri, 15 Jul 2016 00:59:44 +0000"  >&lt;p&gt;Confirmed that test failures are unrelated.  TestMetaStoreMetrics#testConnections appeared related, but is failing locally for me without this patch as well.&lt;/p&gt;</comment>
                            <comment id="15380165" author="spena" created="Fri, 15 Jul 2016 21:39:14 +0000"  >&lt;p&gt;Thanks,&lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="15380179" author="spena" created="Fri, 15 Jul 2016 21:47:49 +0000"  >&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mohitsabharwal&quot; class=&quot;user-hover&quot; rel=&quot;mohitsabharwal&quot;&gt;Mohit Sabharwal&lt;/a&gt; I committed this to 2.2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12817844" name="HIVE-14187.1.patch" size="10512" author="mohitsabharwal" created="Thu, 14 Jul 2016 00:22:47 +0000"/>
                            <attachment id="12817853" name="HIVE-14187.2.patch" size="10523" author="mohitsabharwal" created="Thu, 14 Jul 2016 00:43:24 +0000"/>
                            <attachment id="12817473" name="HIVE-14187.patch" size="10440" author="mohitsabharwal" created="Tue, 12 Jul 2016 17:39:22 +0000"/>
                            <attachment id="12816680" name="HIVE-14187.patch" size="10440" author="mohitsabharwal" created="Thu, 7 Jul 2016 18:35:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Jul 2016 18:40:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30o13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>