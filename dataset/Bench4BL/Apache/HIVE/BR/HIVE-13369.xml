<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 05:14:42 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-13369/HIVE-13369.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-13369] AcidUtils.getAcidState() is not paying attention toValidTxnList when choosing the &quot;best&quot; base file</title>
                <link>https://issues.apache.org/jira/browse/HIVE-13369</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The JavaDoc on getAcidState() reads, in part:&lt;/p&gt;

&lt;p&gt;&quot;Note that because major compactions don&apos;t&lt;br/&gt;
   preserve the history, we can&apos;t use a base directory that includes a&lt;br/&gt;
   transaction id that we must exclude.&quot;&lt;/p&gt;

&lt;p&gt;which is correct but there is nothing in the code that does this.&lt;/p&gt;

&lt;p&gt;And if we detect a situation where txn X must be excluded but and there are deltas that contain X, we&apos;ll have to abort the txn.  This can&apos;t (reasonably) happen with auto commit mode, but with multi statement txns it&apos;s possible.&lt;br/&gt;
Suppose some long running txn starts and lock in snapshot at 17 (HWM).  An hour later it decides to access some partition for which all txns &amp;lt; 20 (for example) have already been compacted (i.e. GC&apos;d).  &lt;/p&gt;

&lt;p&gt;==========================================================&lt;br/&gt;
Here is a more concrete example.  Let&apos;s say the file for table A are as follows and created in the order listed.&lt;br/&gt;
delta_4_4&lt;br/&gt;
delta_5_5&lt;br/&gt;
delta_4_5&lt;br/&gt;
base_5&lt;br/&gt;
delta_16_16&lt;br/&gt;
delta_17_17&lt;br/&gt;
base_17  (for example user ran major compaction)&lt;/p&gt;

&lt;p&gt;let&apos;s say getAcidState() is called with ValidTxnList(20:16), i.e. with HWM=20 and ExceptionList=&amp;lt;16&amp;gt;&lt;br/&gt;
Assume that all txns &amp;lt;= 20 commit.&lt;/p&gt;

&lt;p&gt;Reader can&apos;t use base_17 because it has result of txn16.  So it should chose base_5 &quot;TxnBase bestBase&quot; in &lt;em&gt;getChildState()&lt;/em&gt;.&lt;br/&gt;
Then the reset of the logic in &lt;em&gt;getAcidState()&lt;/em&gt; should choose delta_16_16 and delta_17_17 in &lt;em&gt;Directory&lt;/em&gt; object.  This would represent acceptable snapshot for such reader.&lt;/p&gt;

&lt;p&gt;The issue is if at the same time the Cleaner process is running.  It will see everything with txnid&amp;lt;17 as obsolete.  Then it will check lock manger state and decide to delete (as there may not be any locks in LM for table A).  The order in which the files are deleted is undefined right now.  It may delete delta_16_16 and delta_17_17 first and right at this moment the read request with ValidTxnList(20:16) arrives (such snapshot may have bee locked in by some multi-stmt txn that started some time ago.  It acquires locks after the Cleaner checks LM state and calls getAcidState(). This request will choose base_5 but it won&apos;t see delta_16_16 and delta_17_17 and thus return the snapshot w/o modifications made by those txns.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;This is not possible currently since we only support autoCommit=true.  The reason is the a query (0) opens txn (if appropriate), (1) acquires locks, (2) locks in the snapshot.  The cleaner won&amp;#39;t delete anything for a given compaction (partition) if there are locks on it.  Thus for duration of the transaction, nothing will be deleted so it&amp;#39;s safe to use base_5&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;This is a subtle race condition but possible.&lt;/p&gt;

&lt;p&gt;1. So the safest thing to do to ensure correctness is to use the latest base_x as the &quot;best&quot; and check against exceptions in ValidTxnList and throw an exception if there is an exception &amp;lt;=x.&lt;/p&gt;

&lt;p&gt;2. A better option is to keep 2 exception lists: aborted and open and only throw if there is an open txn &amp;lt;=x.  Compaction throws away data from aborted txns and thus there is no harm using base with aborted txns in its range.&lt;/p&gt;

&lt;p&gt;3. You could make each txn record the lowest open txn id at its start and prevent the cleaner from cleaning anything delta with id range that includes this open txn id for any txn that is still running.  This has a drawback of potentially delaying GC of old files for arbitrarily long periods.  So this should be a user config choice.   The implementation is not trivial.&lt;/p&gt;

&lt;p&gt;I would go with 1 now and do 2/3 together with multi-statement txn work.&lt;/p&gt;



&lt;p&gt;Side note:  if 2 deltas have overlapping ID range, then 1 must be a subset of the other&lt;/p&gt;


&lt;p&gt;A more concrete example (autoCommit=true)  (given 2.1 codebase)&lt;br/&gt;
Suppose base_2 exists.&lt;br/&gt;
1. lock table T&lt;br/&gt;
2. Lock in the snapshot, txnid 3 open, hwm 5.&lt;br/&gt;
3. a long GC pause or more practically the query is submitted but there are no resources to start App Master which is where getAcidState() is called from.&lt;br/&gt;
4. getAcidState() is called&lt;/p&gt;

&lt;p&gt;It&apos;s not unreasonable that during #3 txnid 3 commits and base_5 is produced and is seen in #4.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12954069">HIVE-13369</key>
            <summary>AcidUtils.getAcidState() is not paying attention toValidTxnList when choosing the &quot;best&quot; base file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekoifman">Eugene Koifman</assignee>
                                    <reporter username="ekoifman">Eugene Koifman</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Mar 2016 19:56:49 +0000</created>
                <updated>Thu, 1 Sep 2016 18:07:04 +0000</updated>
                            <resolved>Mon, 18 Jul 2016 21:55:16 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15308468" author="jcamachorodriguez" created="Tue, 31 May 2016 19:50:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wzheng&quot; class=&quot;user-hover&quot; rel=&quot;wzheng&quot;&gt;Wei Zheng&lt;/a&gt;, I am removing 2.1.0 as target because the RC will be created tomorrow. Please feel free to commit to branch-2.1 anyway and fix for 2.1.0 if this happens before the release, or let me know if this is a Blocker. Thanks&lt;/p&gt;</comment>
                            <comment id="15352050" author="wzheng" created="Mon, 27 Jun 2016 23:31:02 +0000"  >&lt;p&gt;Patch 1 is about the first part in the problem description. It also reduce the frequency of AcidOpenTxnsCounterService logging.&lt;/p&gt;</comment>
                            <comment id="15352535" author="hiveqa" created="Tue, 28 Jun 2016 07:44:35 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12813981/HIVE-13369.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12813981/HIVE-13369.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 10273 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/284/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/284/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/284/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/284/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-284/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-284/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12813981 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15359403" author="wzheng" created="Fri, 1 Jul 2016 18:18:27 +0000"  >&lt;p&gt;patch 2 contains logic handling invalid txn for delta&lt;/p&gt;</comment>
                            <comment id="15360131" author="hiveqa" created="Sat, 2 Jul 2016 11:13:26 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12815793/HIVE-13369.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12815793/HIVE-13369.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 20 failed/errored test(s), 10287 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.ql.TestTxnCommands2.testNonAcidToAcidConversion3
org.apache.hadoop.hive.ql.io.TestAcidUtils.testBaseDeltas
org.apache.hadoop.hive.ql.io.TestAcidUtils.testOriginalDeltas
org.apache.hadoop.hive.ql.io.TestAcidUtils.testOverlapingDelta
org.apache.hadoop.hive.ql.io.TestAcidUtils.testOverlapingDelta2
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner.cleanupAfterMajorPartitionCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner.cleanupAfterMajorPartitionCompactionNoBase
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner.cleanupAfterMajorTableCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner.cleanupAfterMinorPartitionCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner.cleanupAfterMinorTableCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner2.cleanupAfterMajorPartitionCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner2.cleanupAfterMajorPartitionCompactionNoBase
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner2.cleanupAfterMajorTableCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner2.cleanupAfterMinorPartitionCompaction
org.apache.hadoop.hive.ql.txn.compactor.TestCleaner2.cleanupAfterMinorTableCompaction
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/347/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/347/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/347/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/347/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-347/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-347/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 20 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12815793 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15374022" author="ekoifman" created="Wed, 13 Jul 2016 00:06:13 +0000"  >&lt;p&gt;The attached patch checks &quot;base_n&quot; files against ValidTxnList to see there are any open txns with id &amp;lt; n.&lt;br/&gt;
If so, it looks for a different base_n file.&lt;br/&gt;
If it runs out of base files, it checks if there are delta files still present that contain all the requisite history.&lt;br/&gt;
If not, it raises an error.&lt;br/&gt;
This is suitable to ensure correctness for current autoCommit=true mode.&lt;br/&gt;
Strictly speaking this analysis should only care about &apos;open&apos; txns but ValidTxnList doesn&apos;t distinguish between open and aborted, so this may generate a false positive error. (In practice it&apos;s very unlikely).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=owen.omalley&quot; class=&quot;user-hover&quot; rel=&quot;owen.omalley&quot;&gt;Owen O&apos;Malley&lt;/a&gt; could you review please?&lt;/p&gt;</comment>
                            <comment id="15375794" author="hiveqa" created="Wed, 13 Jul 2016 21:29:35 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12817558/HIVE-13369.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12817558/HIVE-13369.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 12 failed/errored test(s), 10316 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_auto_sortmerge_join_2
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMinimrCliDriver.org.apache.hadoop.hive.cli.TestMinimrCliDriver
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/501/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/501/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/501/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/501/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-501/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-501/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12817558 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15375820" author="ekoifman" created="Wed, 13 Jul 2016 21:46:13 +0000"  >&lt;p&gt;failed tests have age &amp;gt; 2 except:&lt;/p&gt;

&lt;p&gt;list_bucket_dml_12 fails on and off (e.g. &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/499/testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/499/testReport/&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;reran auto_sortmerge_join_2 - passes&lt;/p&gt;</comment>
                            <comment id="15379834" author="owen.omalley" created="Fri, 15 Jul 2016 18:22:24 +0000"  >&lt;p&gt;Ok, I&apos;m missing something fundamental.&lt;/p&gt;

&lt;p&gt;It looks like AcidUtils.getChildState is checking AcidUtils.isValidBase, which should reject any bases that have an open transaction included. Why is the problematic base making it through the isValidBase check?&lt;/p&gt;</comment>
                            <comment id="15379865" author="ekoifman" created="Fri, 15 Jul 2016 18:34:01 +0000"  >&lt;p&gt;What do you mean &quot;making it through&quot;?  getChildState() only sets &quot;bestBase.status&quot; if isValidBase() is true...&lt;/p&gt;</comment>
                            <comment id="15380216" author="owen.omalley" created="Fri, 15 Jul 2016 22:14:43 +0000"  >&lt;p&gt;Sorry, I was looking at the code with your patch instead of prior to your patch.&lt;/p&gt;

&lt;p&gt;When the major compaction runs, does it  ensure that there are no open transactions in the range it is compacting?&lt;/p&gt;</comment>
                            <comment id="15380220" author="ekoifman" created="Fri, 15 Jul 2016 22:17:53 +0000"  >&lt;p&gt;yes&lt;/p&gt;</comment>
                            <comment id="15380230" author="alangates" created="Fri, 15 Jul 2016 22:25:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;When the major compaction runs, does it ensure that there are no open transactions in the range it is compacting?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not quite.  It assures there are no locks for a partition/table to be cleaned before cleaning up after a compaction.  This won&apos;t work going forward when we move to multi-statement transaction, but it should be ok now in the auto-commit world.&lt;/p&gt;</comment>
                            <comment id="15380239" author="ekoifman" created="Fri, 15 Jul 2016 22:32:56 +0000"  >&lt;p&gt;uhm, that&apos;s not true.  ValidCompactorTxnList ensures there are no open txns in the range being compacted.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-8966&quot; title=&quot;Delta files created by hive hcatalog streaming cannot be compacted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-8966&quot;&gt;&lt;del&gt;HIVE-8966&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15380280" author="owen.omalley" created="Fri, 15 Jul 2016 23:04:28 +0000"  >&lt;p&gt;Comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Your lines are way too long. Please limit them to 100 chars (80 is better!).&lt;/li&gt;
	&lt;li&gt;You have some trailing spaces that should be removed&lt;/li&gt;
	&lt;li&gt;You removed the line breaks from:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (txnList.isTxnRangeValid(delta.minTransaction,
          delta.maxTransaction) !=
          ValidTxnList.RangeResponse.NONE) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;I think that if you are in the case were none of the bases are sufficient and there were compacted bases that include too much, it should always be an exception. Basically, you are almost never going to get complete coverage of all deltas.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other than that, it looks good.&lt;/p&gt;</comment>
                            <comment id="15380324" author="ekoifman" created="Fri, 15 Jul 2016 23:57:19 +0000"  >&lt;p&gt;patch 4 addressing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=owen.omalley&quot; class=&quot;user-hover&quot; rel=&quot;owen.omalley&quot;&gt;Owen O&apos;Malley&lt;/a&gt;&apos;s comments&lt;/p&gt;</comment>
                            <comment id="15381045" author="hiveqa" created="Sun, 17 Jul 2016 02:20:20 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12818264/HIVE-13369.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12818264/HIVE-13369.4.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 10 failed/errored test(s), 10330 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hadoop.hive.ql.io.TestAcidUtils.testBestBase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/546/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/546/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/546/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/546/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-546/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-546/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12818264 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15381554" author="ekoifman" created="Sun, 17 Jul 2016 22:22:57 +0000"  >&lt;p&gt;patch 5 fixes test failure caused by patch 4&lt;/p&gt;</comment>
                            <comment id="15381659" author="hiveqa" created="Mon, 18 Jul 2016 03:23:56 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12818480/HIVE-13369.6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12818480/HIVE-13369.6.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 8 failed/errored test(s), 10333 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/560/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/560/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/560/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/560/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-560/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-560/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12818480 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15381688" author="ekoifman" created="Mon, 18 Jul 2016 04:09:05 +0000"  >&lt;p&gt;all test failures have age &amp;gt; 1&lt;/p&gt;</comment>
                            <comment id="15382697" author="owen.omalley" created="Mon, 18 Jul 2016 17:46:15 +0000"  >&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-13369&quot; title=&quot;AcidUtils.getAcidState() is not paying attention toValidTxnList when choosing the &amp;quot;best&amp;quot; base file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-13369&quot;&gt;&lt;del&gt;HIVE-13369&lt;/del&gt;&lt;/a&gt;.6.patch&lt;/p&gt;</comment>
                            <comment id="15383152" author="ekoifman" created="Mon, 18 Jul 2016 21:55:17 +0000"  >&lt;p&gt;committed to branch-1,branch2.1 and master&lt;/p&gt;

&lt;p&gt;thanks Owen for the review&lt;/p&gt;</comment>
                            <comment id="15396064" author="ekoifman" created="Wed, 27 Jul 2016 17:57:07 +0000"  >&lt;p&gt;The fix here is incomplete - see &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14350&quot; title=&quot;Aborted txns cause false positive &amp;quot;Not enough history available...&amp;quot; msgs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14350&quot;&gt;&lt;del&gt;HIVE-14350&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12988486">HIVE-14211</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12992784">HIVE-14350</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12813981" name="HIVE-13369.1.patch" size="6092" author="wzheng" created="Mon, 27 Jun 2016 23:31:02 +0000"/>
                            <attachment id="12815793" name="HIVE-13369.2.patch" size="5904" author="wzheng" created="Fri, 1 Jul 2016 18:17:55 +0000"/>
                            <attachment id="12817558" name="HIVE-13369.3.patch" size="16600" author="ekoifman" created="Tue, 12 Jul 2016 23:54:53 +0000"/>
                            <attachment id="12818264" name="HIVE-13369.4.patch" size="15008" author="ekoifman" created="Fri, 15 Jul 2016 23:57:19 +0000"/>
                            <attachment id="12818479" name="HIVE-13369.5.patch" size="14135" author="ekoifman" created="Sun, 17 Jul 2016 22:22:57 +0000"/>
                            <attachment id="12818480" name="HIVE-13369.6.patch" size="14135" author="ekoifman" created="Sun, 17 Jul 2016 22:32:44 +0000"/>
                            <attachment id="12818630" name="HIVE-13369.branch-1.patch" size="14675" author="ekoifman" created="Mon, 18 Jul 2016 19:47:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 31 May 2016 19:50:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vb0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue>12332154</customfieldvalue>
    <customfieldvalue>12335837</customfieldvalue>
    <customfieldvalue>12335838</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>