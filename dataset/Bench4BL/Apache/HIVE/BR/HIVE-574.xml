<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 01:10:44 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-574/HIVE-574.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-574] Hive should use ClassLoader from hadoop Configuration</title>
                <link>https://issues.apache.org/jira/browse/HIVE-574</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-338&quot; title=&quot;Executing cli commands into thrift server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-338&quot;&gt;&lt;del&gt;HIVE-338&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Hive should always use the getClassByName method from hadoop Configuration, so that we choose the correct ClassLoader. Examples include all plug-in interfaces, including UDF/GenericUDF/UDAF, SerDe, and FileFormats. Basically the following code snippet shows the idea:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.hadoop.conf;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class Configuration &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Iterable&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; {
   ...
  /**
   * Load a class by name.
   * 
   * @param name the class name.
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the class object.
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the class is not found.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; getClassByName(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(name, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, classLoader);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12428732">HIVE-574</key>
            <summary>Hive should use ClassLoader from hadoop Configuration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zshao">Zheng Shao</assignee>
                                    <reporter username="zshao">Zheng Shao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jun 2009 04:15:31 +0000</created>
                <updated>Sat, 17 Dec 2011 00:07:17 +0000</updated>
                            <resolved>Tue, 30 Jun 2009 18:09:28 +0000</resolved>
                                    <version>0.3.0</version>
                                    <fixVersion>0.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12723429" author="he yongqiang" created="Wed, 24 Jun 2009 04:29:36 +0000"  >&lt;p&gt;For adding EnumSet support in Hadoop, i added a method loadClass(Configuration conf, String className) in ObjectWritable. &lt;br/&gt;
&amp;lt;noformat&amp;gt;&lt;br/&gt;
  /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Find and load the class with given name &amp;lt;tt&amp;gt;className&amp;lt;/tt&amp;gt; by first finding&lt;/li&gt;
	&lt;li&gt;it in the specified &amp;lt;tt&amp;gt;conf&amp;lt;/tt&amp;gt;. If the specified &amp;lt;tt&amp;gt;conf&amp;lt;/tt&amp;gt; is null,&lt;/li&gt;
	&lt;li&gt;try load it directly.&lt;br/&gt;
   */&lt;br/&gt;
  public static Class&amp;lt;?&amp;gt; loadClass(Configuration conf, String className) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    Class&amp;lt;?&amp;gt; declaredClass = null;    try {
      if (conf != null)
        declaredClass = conf.getClassByName(className);
      else
        declaredClass = Class.forName(className);
    } catch (ClassNotFoundException e) {
      throw new RuntimeException(&quot;readObject can&apos;t find class &quot; + className,
          e);
    }    return declaredClass;  }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;&amp;lt;/noformat&amp;gt;&lt;br/&gt;
I donot know if it can be used here.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12723463" author="zshao" created="Wed, 24 Jun 2009 06:14:20 +0000"  >&lt;p&gt;This patch uses the ClassLoader from all paths sets the class loader in most cases.&lt;br/&gt;
It also adds the &quot;addedJars&quot; to HIVEADDEDJARS so that ExecDriver can add it into the ClassLoader for both the ClassLoader in the conf and the thread contextClassLoader.&lt;/p&gt;</comment>
                            <comment id="12723472" author="jsensarma" created="Wed, 24 Jun 2009 06:59:18 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;there&apos;s a bunch of places where JavaUtils.getClassLoader() is called - all of these need to use the conf classloader instead.&lt;/li&gt;
	&lt;li&gt;where are we invoking conf.setClassLoader? (addToClassPath should be calling this it seems)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;if conf.set/getClassLoader is supported in all versions 17 onwards - then we can just remove the -libjars business - since that doesn&apos;t help us any bit now (ExecDriver is not a Tool - so it doesn&apos;t even get the conf with the classpath set that a Tool would normally get by specifying the -libjars option).&lt;/p&gt;</comment>
                            <comment id="12723493" author="zshao" created="Wed, 24 Jun 2009 08:35:12 +0000"  >&lt;p&gt;This patch fixed a bug in ExecDriver.initialize where we were setting &quot;tmpjars&quot;, which were overwritten by ExecDriver.execute().&lt;/p&gt;

&lt;p&gt;&amp;gt; there&apos;s a bunch of places where JavaUtils.getClassLoader() is called - all of these need to use the conf classloader instead.&lt;br/&gt;
I tried to change all of these to use conf classloader, but in lots of places there are no shared conf objects, so I will leave it for now. I changed the comment so it&apos;s clear that in hive (outside hadoop map-reduce jobs) we are using thread classloader, while in hadoop map-reduce jobs we are using conf classloaders.&lt;/p&gt;

&lt;p&gt;&amp;gt; where are we invoking conf.setClassLoader? (addToClassPath should be calling this it seems)&lt;br/&gt;
I moved that logic outside of the addToClassPath function. All callers will do that set.&lt;/p&gt;

&lt;p&gt;&amp;gt; if conf.set/getClassLoader is supported in all versions 17 onwards - then we can just remove the -libjars business - since that doesn&apos;t help us any bit now (ExecDriver is not a Tool - so it doesn&apos;t even get the conf with the classpath set that a Tool would normally get by specifying the -libjars option).&lt;/p&gt;

&lt;p&gt;Maybe in the future we should move ExecDriver to a tool? I think we should rely more on hadoop to set the classpath for us, so maybe in the future we should remove the special &quot;if (local)&quot; block in ExecDriver where we set the classpath ourselves.&lt;/p&gt;</comment>
                            <comment id="12723503" author="zshao" created="Wed, 24 Jun 2009 08:59:07 +0000"  >&lt;p&gt;Make ExecMapper and ExecReducer print out class path with l4j.info(), to ease debugging of classpaths in the future.&lt;/p&gt;</comment>
                            <comment id="12723606" author="jsensarma" created="Wed, 24 Jun 2009 15:57:01 +0000"  >&lt;p&gt;we should always be able to get a Conf from our session (SessionState.get()) from any part of the code. the same conf would be used throughout a session.&lt;/p&gt;</comment>
                            <comment id="12723874" author="coderplay" created="Thu, 25 Jun 2009 02:07:24 +0000"  >&lt;p&gt;+1 for Zheng, thanks&lt;br/&gt;
It worked fine here, nothing abnormal.&lt;/p&gt;</comment>
                            <comment id="12724351" author="jsensarma" created="Fri, 26 Jun 2009 00:11:41 +0000"  >&lt;p&gt;hi zheng - i would prefer to add a getClassByName to JavaUtils (replace getClassLoader) and then use the Session Configuration object&apos;s getclassbyname (SessionState.get().getConf())  if it&apos;s available - or else default to thread classloader or else finally default to current classloader.&lt;/p&gt;

&lt;p&gt;i feel very uncomfortable that right now we are sometimes using the conf classloader and sometimes using the thread classloader. it&apos;s sheer chance that all the uses of JavaUtils.getClassLoader() are happening within the same thread as the thread that adds jar files (or the main thread of the ExecDriver). This can change anytime tomorrow.&lt;/p&gt;</comment>
                            <comment id="12724356" author="zshao" created="Fri, 26 Jun 2009 00:39:46 +0000"  >&lt;p&gt;@Joydeep,&lt;/p&gt;

&lt;p&gt;I will use SessionState.get().getConf().getClassLoader() for all compilation time code and ExecDriver (JobClient side) code. For execution time code (Mapper and Reducer) I will use the conf from Mapper/Reducer.configure() method.&lt;/p&gt;

&lt;p&gt;Is that good?&lt;/p&gt;</comment>
                            <comment id="12724358" author="jsensarma" created="Fri, 26 Jun 2009 00:50:14 +0000"  >&lt;p&gt;yes - makes total sense.&lt;/p&gt;</comment>
                            <comment id="12724372" author="zshao" created="Fri, 26 Jun 2009 03:22:17 +0000"  >&lt;p&gt;I was trying to make the changes and found some other problems.&lt;/p&gt;

&lt;p&gt;The SessionState is only available in ql, while JavaUtils is in common right now. SessionState depends on a bunch of Hive ql classes so I cannot move it to common, and JavaUtils is called from serde, metastore, and ql.&lt;/p&gt;

&lt;p&gt;I will change both serde and metastore methods to require hadoop configuration, so that they can get the classloader from it.&lt;/p&gt;

&lt;p&gt;I will also move JavaUtils to ql.&lt;/p&gt;</comment>
                            <comment id="12724480" author="zshao" created="Fri, 26 Jun 2009 11:30:55 +0000"  >&lt;p&gt;I couldn&apos;t figure out how to do the job cleanly after 6 hours of debugging. I would suggest to commit the current patch and open a jira for follow-up.&lt;/p&gt;

&lt;p&gt;We need a major refactoring of the use of HiveConf in the code.&lt;/p&gt;</comment>
                            <comment id="12725004" author="zshao" created="Sun, 28 Jun 2009 22:32:17 +0000"  >&lt;p&gt;Let&apos;s get this in first since it fixes the bug.&lt;/p&gt;

&lt;p&gt;The follow-up JIRA is &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-584&quot; title=&quot;Clean up global and ThreadLocal variables in Hive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-584&quot;&gt;&lt;del&gt;HIVE-584&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12725441" author="jsensarma" created="Tue, 30 Jun 2009 02:39:25 +0000"  >&lt;p&gt;changes look good! will commit after tests.&lt;/p&gt;
</comment>
                            <comment id="12725733" author="jsensarma" created="Tue, 30 Jun 2009 18:09:28 +0000"  >&lt;p&gt;committed - thanks Zheng!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12428950">HIVE-584</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12416601">HIVE-338</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12411607" name="HIVE-574.1.patch" size="9348" author="zshao" created="Wed, 24 Jun 2009 06:14:20 +0000"/>
                            <attachment id="12411623" name="HIVE-574.2.patch" size="18863" author="zshao" created="Wed, 24 Jun 2009 08:35:12 +0000"/>
                            <attachment id="12411625" name="HIVE-574.3.patch" size="20859" author="zshao" created="Wed, 24 Jun 2009 08:59:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 24 Jun 2009 04:29:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>73436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lakv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>122364</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>