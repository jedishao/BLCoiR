<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 11:39:33 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-14292/HIVE-14292.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-14292] ACID table creation fails on mysql with MySQLIntegrityConstraintViolationException</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14292</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;While creating a ACID table ran into the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;&amp;gt;&amp;gt;  create table acidcount1 (id int) 
clustered by (id) into 2 buckets 
stored as orc 
tblproperties(&apos;transactional&apos;=&apos;true&apos;);
INFO  : Compiling command(queryId=hive_20160719105944_bfe65377-59fa-4e17-941e-1f86b8daca15): create table acidcount1 (id int) 
clustered by (id) into 2 buckets 
stored as orc 
tblproperties(&apos;transactional&apos;=&apos;true&apos;)
INFO  : Semantic Analysis Completed
INFO  : Returning Hive schema: Schema(fieldSchemas:null, properties:null)
INFO  : Completed compiling command(queryId=hive_20160719105944_bfe65377-59fa-4e17-941e-1f86b8daca15); Time taken: 0.111 seconds
Error: Error running query: java.lang.RuntimeException: Unable to lock &apos;CheckLock&apos; due to: Duplicate entry &apos;CheckLock-0&apos; for key &apos;PRIMARY&apos; (SQLState=23000, ErrorCode=1062) (state=,code=0)
Aborting command set because &quot;force&quot; is false and command failed: &quot;create table acidcount1 (id int) 
clustered by (id) into 2 buckets 
stored as orc 
tblproperties(&apos;transactional&apos;=&apos;true&apos;);&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Saw the following detailed stack in the server log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-07-19T10:59:46,213 ERROR [HiveServer2-Background-Pool: Thread-463]: metastore.RetryingHMSHandler (RetryingHMSHandler.java:invokeInternal(196)) - java.lang.RuntimeException: Unable to lock &apos;CheckLock&apos; due to: Duplicate entry &apos;CheckLock-0&apos; for key &apos;PRIMARY&apos; (SQLState=23000, ErrorCode=1062)
        at org.apache.hadoop.hive.metastore.txn.TxnHandler.acquireLock(TxnHandler.java:3235)
        at org.apache.hadoop.hive.metastore.txn.TxnHandler.checkLock(TxnHandler.java:2309)
        at org.apache.hadoop.hive.metastore.txn.TxnHandler.checkLockWithRetry(TxnHandler.java:1012)
        at org.apache.hadoop.hive.metastore.txn.TxnHandler.lock(TxnHandler.java:784)
        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.lock(HiveMetaStore.java:5941)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:606)
        at org.apache.hadoop.hive.metastore.RetryingHMSHandler.invokeInternal(RetryingHMSHandler.java:140)
        at org.apache.hadoop.hive.metastore.RetryingHMSHandler.invoke(RetryingHMSHandler.java:99)
        at com.sun.proxy.$Proxy26.lock(Unknown Source)
        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.lock(HiveMetaStoreClient.java:2109)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:606)
        at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.invoke(RetryingMetaStoreClient.java:154)
        at com.sun.proxy.$Proxy28.lock(Unknown Source)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:606)
        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient$SynchronizedHandler.invoke(HiveMetaStoreClient.java:2259)
        at com.sun.proxy.$Proxy28.lock(Unknown Source)
        at org.apache.hadoop.hive.ql.lockmgr.DbTxnManager$SynchronizedMetaStoreClient.lock(DbTxnManager.java:740)
        at org.apache.hadoop.hive.ql.lockmgr.DbLockManager.lock(DbLockManager.java:103)
        at org.apache.hadoop.hive.ql.lockmgr.DbTxnManager.acquireLocks(DbTxnManager.java:341)
        at org.apache.hadoop.hive.ql.lockmgr.DbTxnManager.acquireLocksWithHeartbeatDelay(DbTxnManager.java:357)
        at org.apache.hadoop.hive.ql.lockmgr.DbTxnManager.acquireLocks(DbTxnManager.java:167)
        at org.apache.hadoop.hive.ql.Driver.acquireLocksAndOpenTxn(Driver.java:980)
        at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1316)
        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1090)
        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1083)
        at org.apache.hive.service.cli.operation.SQLOperation.runQuery(SQLOperation.java:242)
        at org.apache.hive.service.cli.operation.SQLOperation.access$800(SQLOperation.java:91)
        at org.apache.hive.service.cli.operation.SQLOperation$BackgroundWork$1.run(SQLOperation.java:334)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:415)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1724)
        at org.apache.hive.service.cli.operation.SQLOperation$BackgroundWork.run(SQLOperation.java:347)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Duplicate entry &apos;CheckLock-0&apos; for key &apos;PRIMARY&apos;
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:526)
        at com.mysql.jdbc.Util.handleNewInstance(Util.java:377)
        at com.mysql.jdbc.Util.getInstance(Util.java:360)
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:971)
        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3887)
        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3823)
        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2435)
        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2582)
        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2526)
        at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl.java:1618)
        at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl.java:1549)
        at com.jolbox.bonecp.StatementHandle.executeUpdate(StatementHandle.java:497)
        at org.apache.hadoop.hive.metastore.txn.TxnHandler.acquireLock(TxnHandler.java:3231)
        ... 47 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;MySQL&lt;/p&gt;</environment>
        <key id="12990956">HIVE-14292</key>
            <summary>ACID table creation fails on mysql with MySQLIntegrityConstraintViolationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekoifman">Eugene Koifman</assignee>
                                    <reporter username="deepesh">Deepesh Khandelwal</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Jul 2016 23:54:43 +0000</created>
                <updated>Fri, 22 Jul 2016 17:15:47 +0000</updated>
                            <resolved>Fri, 22 Jul 2016 17:15:46 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>2.1.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15385189" author="ekoifman" created="Wed, 20 Jul 2016 02:04:47 +0000"  >&lt;p&gt;TxnHandler.isDuplicateKey() method is checking wrong SQL code&lt;br/&gt;
&lt;a href=&quot;https://dev.mysql.com/doc/refman/5.5/en/error-messages-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://dev.mysql.com/doc/refman/5.5/en/error-messages-server.html&lt;/a&gt;&lt;br/&gt;
MySql has &amp;gt; 1 with ideantical msg&lt;br/&gt;
it&apos;s currently checking 1022 which has msg &quot;Can&apos;t write; duplicate key in table &apos;%s&apos;&quot;&lt;br/&gt;
but the one MySql comes back with is 1062 &quot;Duplicate entry &apos;%s&apos; for key %d&quot;&lt;br/&gt;
there is also 1586 with &quot;Duplicate entry &apos;%s&apos; for key &apos;%s&apos;&quot;&lt;br/&gt;
I don&apos;t see anything that explains which is produced when...&lt;/p&gt;</comment>
                            <comment id="15385190" author="ekoifman" created="Wed, 20 Jul 2016 02:05:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wzheng&quot; class=&quot;user-hover&quot; rel=&quot;wzheng&quot;&gt;Wei Zheng&lt;/a&gt; could you review please&lt;/p&gt;</comment>
                            <comment id="15385354" author="wzheng" created="Wed, 20 Jul 2016 05:17:05 +0000"  >&lt;p&gt;I see we&apos;re relaxing the !isDuplicateKeyError logic. Just want to understand why we don&apos;t throw exception for duplicate key errors? There are a dozen errors with &quot;duplicate something&quot; in the link above..&lt;/p&gt;</comment>
                            <comment id="15385357" author="ekoifman" created="Wed, 20 Jul 2016 05:21:35 +0000"  >&lt;p&gt;if you look at the logic where isDuplicateKey() is used, the idea is to lock a record with specific value and if it&apos;s not there, then insert it and then lock it.  Since you cannot be certain 2 entities are not going through this same process, the logic catches the &quot;duplicate key&quot; and proceeds but raises an error if it&apos;s any other error.&lt;/p&gt;</comment>
                            <comment id="15385417" author="wzheng" created="Wed, 20 Jul 2016 06:07:09 +0000"  >&lt;p&gt;I see. Since MySQL document is as messed as Hive&apos;s, this is our best effort to capture &quot;duplicate key/entry&quot; type of errors.&lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="15386380" author="ekoifman" created="Wed, 20 Jul 2016 18:24:53 +0000"  >&lt;p&gt;patch 2 is the same - previous one disappeared form build queue&lt;/p&gt;</comment>
                            <comment id="15388979" author="hiveqa" created="Fri, 22 Jul 2016 06:12:32 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12819481/HIVE-14292.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12819481/HIVE-14292.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 9 failed/errored test(s), 10341 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/595/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/595/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/595/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/595/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-595/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-595/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12819481 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15389766" author="ekoifman" created="Fri, 22 Jul 2016 16:22:45 +0000"  >&lt;p&gt;failures not related&lt;/p&gt;</comment>
                            <comment id="15389856" author="ekoifman" created="Fri, 22 Jul 2016 17:15:46 +0000"  >&lt;p&gt;Committed to branch-1,branch-2.1, master&lt;br/&gt;
thanks Wei for the review&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12819171" name="HIVE-14292.2.patch" size="814" author="ekoifman" created="Wed, 20 Jul 2016 18:24:53 +0000"/>
                            <attachment id="12819481" name="HIVE-14292.3.patch" size="814" author="ekoifman" created="Thu, 21 Jul 2016 22:15:51 +0000"/>
                            <attachment id="12819001" name="HIVE-14292.patch" size="814" author="ekoifman" created="Wed, 20 Jul 2016 01:58:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 20 Jul 2016 02:04:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i318ef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue>12332154</customfieldvalue>
    <customfieldvalue>12335837</customfieldvalue>
    <customfieldvalue>12335838</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>