<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 22:35:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-12352/HIVE-12352.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-12352] CompactionTxnHandler.markCleaned() may delete too much</title>
                <link>https://issues.apache.org/jira/browse/HIVE-12352</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;   Worker will start with DB in state X (wrt this partition).&lt;br/&gt;
   while it&apos;s working more txns will happen, against partition it&apos;s compacting.&lt;br/&gt;
   then this will delete state up to X and since then.  There may be new delta files created&lt;br/&gt;
   between compaction starting and cleaning.  These will not be compacted until more&lt;br/&gt;
   transactions happen.  So this ideally should only delete&lt;br/&gt;
   up to TXN_ID that was compacted (i.e. HWM in Worker?)  Then this can also run&lt;br/&gt;
   at READ_COMMITTED.  So this means we&apos;d want to store HWM in COMPACTION_QUEUE when&lt;br/&gt;
   Worker picks up the job.&lt;/p&gt;

&lt;p&gt;Actually the problem is even worse (but also solved using HWM as above):&lt;br/&gt;
Suppose some transactions (against same partition) have started and aborted since the time Worker ran compaction job.&lt;br/&gt;
That means there are never-compacted delta files with data that belongs to these aborted txns.&lt;/p&gt;

&lt;p&gt;Following will pick up these aborted txns.&lt;br/&gt;
s = &quot;select txn_id from TXNS, TXN_COMPONENTS where txn_id = tc_txnid and txn_state = &apos;&quot; +&lt;br/&gt;
          TXN_ABORTED + &quot;&apos; and tc_database = &apos;&quot; + info.dbname + &quot;&apos; and tc_table = &apos;&quot; +&lt;br/&gt;
          info.tableName + &quot;&apos;&quot;;&lt;br/&gt;
        if (info.partName != null) s += &quot; and tc_partition = &apos;&quot; + info.partName + &quot;&apos;&quot;;&lt;/p&gt;

&lt;p&gt;The logic after that will delete relevant data from TXN_COMPONENTS and if one of these txns becomes empty, it will be picked up by cleanEmptyAbortedTxns().  At that point any metadata about an Aborted txn is gone and the system will think it&apos;s committed.&lt;/p&gt;

&lt;p&gt;HWM in this case would be (in ValidCompactorTxnList)&lt;br/&gt;
if(minOpenTxn &amp;gt; 0)&lt;br/&gt;
min(highWaterMark, minOpenTxn) &lt;br/&gt;
else &lt;br/&gt;
highWaterMark&lt;/p&gt;</description>
                <environment></environment>
        <key id="12910847">HIVE-12352</key>
            <summary>CompactionTxnHandler.markCleaned() may delete too much</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekoifman">Eugene Koifman</assignee>
                                    <reporter username="ekoifman">Eugene Koifman</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Nov 2015 21:09:55 +0000</created>
                <updated>Tue, 16 Feb 2016 23:51:28 +0000</updated>
                            <resolved>Fri, 15 Jan 2016 03:06:24 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                            <comments>
                            <comment id="15090341" author="ekoifman" created="Sat, 9 Jan 2016 02:10:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alangates&quot; class=&quot;user-hover&quot; rel=&quot;alangates&quot;&gt;Alan Gates&lt;/a&gt; could you review please&lt;/p&gt;</comment>
                            <comment id="15092706" author="sershe" created="Mon, 11 Jan 2016 21:25:13 +0000"  >&lt;p&gt;Why are thrift and DB changes done in separate JIRA? &lt;/p&gt;</comment>
                            <comment id="15092709" author="sershe" created="Mon, 11 Jan 2016 21:26:28 +0000"  >&lt;p&gt;Can you post it on RB?&lt;/p&gt;</comment>
                            <comment id="15092869" author="alangates" created="Mon, 11 Jan 2016 22:51:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why are thrift and DB changes done in separate JIRA?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To make it easier for Eugene and I to collaborate without stomping on each other&apos;s toes.&lt;/p&gt;</comment>
                            <comment id="15092913" author="alangates" created="Mon, 11 Jan 2016 23:11:12 +0000"  >&lt;p&gt;CompactionTxnHandler, line 347:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (info.partName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  s += &lt;span class=&quot;code-quote&quot;&gt;&quot; and ctc_partition = &apos;&quot;&lt;/span&gt; + info.partName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&quot;&lt;/span&gt; +
  (info.highestTxnId == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; : &quot;&lt;/span&gt; and ctc_txnid &amp;lt;= &quot; + info.highestTxnId);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Shouldn&apos;t that &quot;and ctc_txnid &amp;lt;=... go outside this if?  Don&apos;t you want it to apply for tables and partitions?&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;I don&apos;t understand this code, also in CompactionTxnHandler&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
638	    highWater = minOpenTxn == &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE ? highWater : minOpenTxn - 1;
639	    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValidCompactorTxnList(exceptions, -1, highWater);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Why is this change necessary?&lt;/p&gt;</comment>
                            <comment id="15092933" author="ekoifman" created="Mon, 11 Jan 2016 23:24:49 +0000"  >&lt;p&gt;yes, you are right, the HWM should apply to all tables&lt;/p&gt;

&lt;p&gt;wrt 2nd comment:&lt;br/&gt;
Compactions find the smallest open txn in the working set and make sure to only compact up to that txn (exclusive). so if there are any files that include txn ids between minOpenTxn and ValidCompactorTxnList.highWatermark they would be ignored.  This txn ID is also the HWM mark for the issue in this bug.  (Longer term ValidCompactorTxnList can be refactored w/o minOpenTxn but in the short run this is the simplest way to pass compaction HWM to Worker)&lt;/p&gt;
</comment>
                            <comment id="15096720" author="alangates" created="Wed, 13 Jan 2016 18:18:25 +0000"  >&lt;p&gt;+1 for patch 2.&lt;/p&gt;</comment>
                            <comment id="15098651" author="sershe" created="Thu, 14 Jan 2016 19:04:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekoifman&quot; class=&quot;user-hover&quot; rel=&quot;ekoifman&quot;&gt;Eugene Koifman&lt;/a&gt; can you make a combined patch with thrift changes and attach it for HiveQA to run? This is the last blocker for Hive 2.0 so it would be nice to commit it quickly&lt;/p&gt;</comment>
                            <comment id="15098733" author="ekoifman" created="Thu, 14 Jan 2016 19:50:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;Sergey Shelukhin&lt;/a&gt; Alan will commit &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12832&quot; title=&quot;RDBMS schema changes for HIVE-11388&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12832&quot;&gt;&lt;del&gt;HIVE-12832&lt;/del&gt;&lt;/a&gt; later today and I can commit this right after.&lt;br/&gt;
I would really like to get &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12353&quot; title=&quot;When Compactor fails it calls CompactionTxnHandler.markedCleaned().  it should not.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12353&quot;&gt;&lt;del&gt;HIVE-12353&lt;/del&gt;&lt;/a&gt; into 2.0 as well - I should have a patch tomorrow&lt;/p&gt;</comment>
                            <comment id="15098741" author="sershe" created="Thu, 14 Jan 2016 19:52:17 +0000"  >&lt;p&gt;How about a HiveQA run for this?&lt;/p&gt;</comment>
                            <comment id="15098747" author="ekoifman" created="Thu, 14 Jan 2016 19:55:36 +0000"  >&lt;p&gt;I&apos;ll rebase and and get it going&lt;/p&gt;</comment>
                            <comment id="15099182" author="hiveqa" created="Fri, 15 Jan 2016 00:19:08 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12782361/HIVE-12352.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12782361/HIVE-12352.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 6 failed/errored test(s), 10019 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestHWISessionManager - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_union
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.ql.exec.spark.session.TestSparkSessionManagerImpl.testMultiSessionMultipleUse
org.apache.hadoop.hive.ql.exec.spark.session.TestSparkSessionManagerImpl.testSingleSessionMultipleUse
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6627/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6627/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6627/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6627/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6627/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6627/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12782361 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15099205" author="ekoifman" created="Fri, 15 Jan 2016 00:40:02 +0000"  >&lt;p&gt;committed to master &lt;a href=&quot;https://github.com/apache/hive/commit/4935cfda78577bd63f1c4ae04a26dc307e640b6f&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hive/commit/4935cfda78577bd63f1c4ae04a26dc307e640b6f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15101122" author="ekoifman" created="Fri, 15 Jan 2016 03:05:59 +0000"  >&lt;p&gt;committed to 1.3 and 2.0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12910849">HIVE-12353</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12928881">HIVE-12832</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12910849">HIVE-12353</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12896197">HIVE-11948</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12781937" name="HIVE-12352.2.patch" size="17558" author="ekoifman" created="Tue, 12 Jan 2016 22:40:23 +0000"/>
                            <attachment id="12782361" name="HIVE-12352.3.patch" size="17558" author="ekoifman" created="Thu, 14 Jan 2016 20:30:01 +0000"/>
                            <attachment id="12781355" name="HIVE-12352.patch" size="16524" author="ekoifman" created="Sat, 9 Jan 2016 02:10:35 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12928503">HIVE-12807</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Jan 2016 21:25:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2o0wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue>12332154</customfieldvalue>
    <customfieldvalue>12332641</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>