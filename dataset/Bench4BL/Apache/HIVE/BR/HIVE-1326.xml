<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 23:36:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-1326/HIVE-1326.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-1326] RowContainer uses hard-coded &apos;/tmp/&apos; path for temporary files</title>
                <link>https://issues.apache.org/jira/browse/HIVE-1326</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;In our production hadoop environment, the &quot;/tmp/&quot; is actually pretty small, and we encountered a problem when a query used the RowContainer class and filled up the /tmp/ partition.  I tracked down the cause to the RowContainer class putting temporary files in the &apos;/tmp/&apos; path instead of using the configured Hadoop temporary path.  I&apos;ve attached a patch to fix this.&lt;/p&gt;

&lt;p&gt;Here&apos;s the traceback:&lt;/p&gt;

&lt;p&gt;2010-04-25 12:05:05,120 INFO org.apache.hadoop.hive.ql.exec.persistence.RowContainer: RowContainer created temp file /tmp/hive-rowcontainer-1244151903/RowContainer7816.tmp&lt;br/&gt;
2010-04-25 12:05:06,326 INFO ExecReducer: ExecReducer: processing 10000000 rows: used memory = 385520312&lt;br/&gt;
2010-04-25 12:05:08,513 INFO ExecReducer: ExecReducer: processing 11000000 rows: used memory = 341780472&lt;br/&gt;
2010-04-25 12:05:10,697 INFO ExecReducer: ExecReducer: processing 12000000 rows: used memory = 301446768&lt;br/&gt;
2010-04-25 12:05:12,837 INFO ExecReducer: ExecReducer: processing 13000000 rows: used memory = 399208768&lt;br/&gt;
2010-04-25 12:05:15,085 INFO ExecReducer: ExecReducer: processing 14000000 rows: used memory = 364507216&lt;br/&gt;
2010-04-25 12:05:17,260 INFO ExecReducer: ExecReducer: processing 15000000 rows: used memory = 332907280&lt;br/&gt;
2010-04-25 12:05:19,580 INFO ExecReducer: ExecReducer: processing 16000000 rows: used memory = 298774096&lt;br/&gt;
2010-04-25 12:05:21,629 INFO ExecReducer: ExecReducer: processing 17000000 rows: used memory = 396505408&lt;br/&gt;
2010-04-25 12:05:23,830 INFO ExecReducer: ExecReducer: processing 18000000 rows: used memory = 362477288&lt;br/&gt;
2010-04-25 12:05:25,914 INFO ExecReducer: ExecReducer: processing 19000000 rows: used memory = 327229744&lt;br/&gt;
2010-04-25 12:05:27,978 INFO ExecReducer: ExecReducer: processing 20000000 rows: used memory = 296051904&lt;br/&gt;
2010-04-25 12:05:28,155 FATAL ExecReducer: org.apache.hadoop.fs.FSError: java.io.IOException: No space left on device&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem$LocalFSFileOutputStream.write(RawLocalFileSystem.java:199)&lt;br/&gt;
	at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)&lt;br/&gt;
	at java.io.BufferedOutputStream.write(BufferedOutputStream.java:109)&lt;br/&gt;
	at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.write(FSDataOutputStream.java:49)&lt;br/&gt;
	at java.io.DataOutputStream.write(DataOutputStream.java:90)&lt;br/&gt;
	at org.apache.hadoop.fs.ChecksumFileSystem$ChecksumFSOutputSummer.writeChunk(ChecksumFileSystem.java:346)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.writeChecksumChunk(FSOutputSummer.java:150)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.flushBuffer(FSOutputSummer.java:132)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.flushBuffer(FSOutputSummer.java:121)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.write1(FSOutputSummer.java:112)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.write(FSOutputSummer.java:86)&lt;br/&gt;
	at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.write(FSDataOutputStream.java:49)&lt;br/&gt;
	at java.io.DataOutputStream.write(DataOutputStream.java:90)&lt;br/&gt;
	at org.apache.hadoop.io.SequenceFile$Writer.append(SequenceFile.java:1013)&lt;br/&gt;
	at org.apache.hadoop.io.SequenceFile$Writer.append(SequenceFile.java:977)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat$1.write(HiveSequenceFileOutputFormat.java:70)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.exec.persistence.RowContainer.spillBlock(RowContainer.java:343)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.exec.persistence.RowContainer.add(RowContainer.java:163)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.exec.JoinOperator.processOp(JoinOperator.java:118)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:456)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.exec.ExecReducer.reduce(ExecReducer.java:244)&lt;br/&gt;
	at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:436)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:158)&lt;br/&gt;
Caused by: java.io.IOException: No space left on device&lt;br/&gt;
	at java.io.FileOutputStream.writeBytes(Native Method)&lt;br/&gt;
	at java.io.FileOutputStream.write(FileOutputStream.java:260)&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem$LocalFSFileOutputStream.write(RawLocalFileSystem.java:197)&lt;br/&gt;
	... 22 more&lt;/p&gt;</description>
                <environment>&lt;p&gt;Hadoop 0.19.2 with Hive trunk.  We&apos;re using FreeBSD 7.0, but that doesn&apos;t seem relevant.&lt;/p&gt;</environment>
        <key id="12462969">HIVE-1326</key>
            <summary>RowContainer uses hard-coded &apos;/tmp/&apos; path for temporary files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="michaelklatt">Michael Klatt</assignee>
                                    <reporter username="michaelklatt">Michael Klatt</reporter>
                        <labels>
                    </labels>
                <created>Sun, 25 Apr 2010 20:50:54 +0000</created>
                <updated>Sat, 17 Dec 2011 00:03:30 +0000</updated>
                            <resolved>Tue, 27 Apr 2010 22:53:39 +0000</resolved>
                                                    <fixVersion>0.6.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12860929" author="appodictic" created="Mon, 26 Apr 2010 14:12:10 +0000"  >&lt;p&gt;I am +1 on the concept.   Many times /tmp can be a ramdisk or mounted with some size restrictions. This type of bug an be very painful to track down when it happens.&lt;/p&gt;</comment>
                            <comment id="12861054" author="nzhang" created="Mon, 26 Apr 2010 19:08:31 +0000"  >&lt;p&gt;The general idea of why we put temp files and directories under /tmp is two fold:&lt;br/&gt;
 1) it allows easy clean up in case of any unexpected interruptions to the JVM. In the regular exits, these temp files/directories should be removed by JVM by deleteOnExit(), but if the JVM was killed/interrupted unexpected, these temp files could eventually take up all disk spaces and make the whole cluster hard to recover (imagine finding these temp files in thousands of machines). By putting it in /tmp, all these will be automatically removed whenever the machine is restarted, or cleaned up manually by just removing all files in /tmp. That&apos;s much easier in terms of Hadoop administration. &lt;br/&gt;
 2) /tmp seems to be a universally writable mounted point on all unix-based systems. So it should be a safe place to put the temporary files. But I agree that it would a good idea to introduce a new Hive parameter to let the user choose a customizable tmp directory, which should address Edward&apos;s point. &lt;/p&gt;

&lt;p&gt;I think we use File.createTempFile() previously and Yongqiang added another directory structure (parentFile). I think we can use File.createTempFile to create this directory as well (Yongqiang, please correct me if I&apos;m wrong), there there are several questions about the patch:&lt;/p&gt;

&lt;p&gt;1) File.createTempFile() will by default create temp files in java.io.tmpdir (/tmp or /var/tmp) according to JDK. I suspect most of the case JVM on Linux will use /tmp as the java.io.tmpdir, so in that caes your change won&apos;t achieve your purpose in most cases. &lt;br/&gt;
2) the random number generator is not needed if you can use File.createTempFile to create parentFile, because File.createTempFile guarantees its uniqueness for this JVM. The only case you need to prevent is the collision between different JVMs. This is why there is a check for parentFile.mkdir(). It actually acts like a write lock to the directory so that other JVM won&apos;t overwrite it. So parentFile.delete() should not be added because it may delete the directory created by another JVM who is still running.&lt;/p&gt;</comment>
                            <comment id="12861080" author="michaelklatt" created="Mon, 26 Apr 2010 20:17:49 +0000"  >
&lt;p&gt;In my brief experiments, I found that File.createTempFile() used the work/tmp path for the individual task (in Hadoop).  I suspect that the java.io.tmpdir is being set by the TaskTracker.  This has the advantage of letting Hadoop do the temporary file cleanup when the task cleanup happens.  I think it would be great if this was the default behavior, but admins could override that with a hive specific parameter.&lt;/p&gt;

&lt;p&gt;I don&apos;t have any attachment to the actual implementation.  I can spend more time to produce a different patch if needed, but I suspected someone would want to implement it differently.&lt;/p&gt;</comment>
                            <comment id="12861188" author="nzhang" created="Tue, 27 Apr 2010 00:38:06 +0000"  >&lt;p&gt;I guess this is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-2735&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HADOOP-2735&lt;/a&gt; which set java.io.tmpdir to be dependent on mapred.tmp.dir. In that case the change of using createTempFile looks fine with me. Also can you remove the parentFile.delete() in your patch? If we set java.io.tmpdir to work/tmp then we don&apos;t have file name conflicts, But if the user choose to use shared /tmp then it may remove files created by other tasks. &lt;/p&gt;

&lt;p&gt;Yongqiang, any further comments?&lt;/p&gt;</comment>
                            <comment id="12861370" author="he yongqiang" created="Tue, 27 Apr 2010 11:24:46 +0000"  >&lt;p&gt;Agreed with Ning, looks fine to me.&lt;/p&gt;</comment>
                            <comment id="12861444" author="michaelklatt" created="Tue, 27 Apr 2010 16:16:06 +0000"  >
&lt;p&gt;The reason the parentFile.delete() call is there is because the File.createTempFile method actually creates a file. The code, as it currently is, creates a temporary directory to hold the rowcontainer file and I made the smallest change possible to continue to support this behavior.&lt;/p&gt;

&lt;p&gt;Looking at the code, it appears that the createTempFile mechanism is used several lines down to actually create the temporary file (within the new temporary directory). I&apos;m not sure why a temporary directory is created first, but I&apos;ll submit a new patch which doesn&apos;t try to create a temporary directory at all.&lt;/p&gt;</comment>
                            <comment id="12861449" author="michaelklatt" created="Tue, 27 Apr 2010 16:43:52 +0000"  >
&lt;p&gt;Hmm, on second thought, the parentFile (directory) is referenced in several places.  I&apos;m not familiar enough with Hive to know what these lines do:&lt;/p&gt;

&lt;p&gt;          HiveConf.setVar(jobCloneUsingLocalFs,&lt;br/&gt;
              HiveConf.ConfVars.HADOOPMAPREDINPUTDIR,&lt;br/&gt;
              org.apache.hadoop.util.StringUtils.escapeString(parentFile&lt;br/&gt;
              .getAbsolutePath()));&lt;/p&gt;

&lt;p&gt;If it weren&apos;t for these lines I could remove the parentFile variable all together.&lt;/p&gt;
</comment>
                            <comment id="12861467" author="nzhang" created="Tue, 27 Apr 2010 17:42:06 +0000"  >&lt;p&gt;Michael, the temporary directory is needed for a conditional task to handle skewed joins (that&apos;s why the JobConf is cloned but with a different path). The idea here is that whenever there many too many rows for a particular job key to be held in memory, they will be first write to local disk via RowContainer. If there are still too many rows to local disk, they will be write to a DFS location and a contitional task will be triggered to handle this skewed key. So if we create a temp directory in local disk and let all mappers write their temp files in that directory, then later when we want to move the data to HDFS, we just move the whole directory instead of moving individual files.&lt;/p&gt;

&lt;p&gt;+1 on v2. Will commit if tests pass. &lt;/p&gt;</comment>
                            <comment id="12861608" author="nzhang" created="Tue, 27 Apr 2010 22:53:39 +0000"  >&lt;p&gt;Committed. Thanks Michael!&lt;/p&gt;</comment>
                            <comment id="12973466" author="hammer" created="Tue, 21 Dec 2010 04:28:02 +0000"  >&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;Could a Hive committer assign this issue to Michael in order to keep the JIRA metadata up to date?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Jeff&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12442794" name="rowcontainer.patch" size="1035" author="michaelklatt" created="Sun, 25 Apr 2010 20:52:44 +0000"/>
                            <attachment id="12442971" name="rowcontainer_v2.patch" size="776" author="michaelklatt" created="Tue, 27 Apr 2010 16:44:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 26 Apr 2010 14:12:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>72967</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 50 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lejz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>123008</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>