<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 05:38:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-14138/HIVE-14138.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-14138] CBO failed for select current_database()</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14138</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When issuing the following query, with hive.cbo.enable set to true:&lt;br/&gt;
select current_database();&lt;/p&gt;

&lt;p&gt;The following exception is printed to the Hiveserver2 logs:&lt;/p&gt;

&lt;p&gt;2016-06-30T09:58:24,146 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HiveServer2-Handler-Pool: Thread-33&amp;#93;&lt;/span&gt; parse.CalcitePlanner: CBO failed, skipping CBO. &lt;br/&gt;
org.apache.hadoop.hive.ql.optimizer.calcite.CalciteSemanticException: Unsupported&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.genLogicalPlan(CalcitePlanner.java:3136)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.apply(CalcitePlanner.java:940)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.apply(CalcitePlanner.java:894)&lt;br/&gt;
	at org.apache.calcite.tools.Frameworks$1.apply(Frameworks.java:113)&lt;br/&gt;
	at org.apache.calcite.prepare.CalcitePrepareImpl.perform(CalcitePrepareImpl.java:969)&lt;br/&gt;
	at org.apache.calcite.tools.Frameworks.withPrepare(Frameworks.java:149)&lt;br/&gt;
	at org.apache.calcite.tools.Frameworks.withPlanner(Frameworks.java:106)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.getOptimizedAST(CalcitePlanner.java:712)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.genOPTree(CalcitePlanner.java:280)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:10795)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:239)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:250)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:438)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:329)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1159)&lt;br/&gt;
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1146)&lt;br/&gt;
	at org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:191)&lt;br/&gt;
	at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:276)&lt;br/&gt;
	at org.apache.hive.service.cli.operation.Operation.run(Operation.java:324)&lt;br/&gt;
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:464)&lt;br/&gt;
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:451)&lt;br/&gt;
	at org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:295)&lt;br/&gt;
	at org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:509)&lt;br/&gt;
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1437)&lt;br/&gt;
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1422)&lt;br/&gt;
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)&lt;br/&gt;
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)&lt;br/&gt;
	at org.apache.hive.service.auth.TSetIpAddressProcessor.process(TSetIpAddressProcessor.java:56)&lt;br/&gt;
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:286)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12985671">HIVE-14138</key>
            <summary>CBO failed for select current_database()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pvary">Peter Vary</assignee>
                                    <reporter username="pvary">Peter Vary</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jun 2016 08:08:57 +0000</created>
                <updated>Wed, 6 Jul 2016 22:18:51 +0000</updated>
                            <resolved>Wed, 6 Jul 2016 22:18:51 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>CBO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="15356710" author="pvary" created="Thu, 30 Jun 2016 08:10:49 +0000"  >&lt;p&gt;The patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14123&quot; title=&quot;Add beeline configuration option to show database in the prompt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14123&quot;&gt;&lt;del&gt;HIVE-14123&lt;/del&gt;&lt;/a&gt; uses this select, and the error log might confuse users&lt;/p&gt;</comment>
                            <comment id="15357226" author="pvary" created="Thu, 30 Jun 2016 15:07:09 +0000"  >&lt;p&gt;The same error gets logged with the following selects:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;select current_user();&lt;/li&gt;
	&lt;li&gt;select 1 + 1;&lt;/li&gt;
	&lt;li&gt;select * from dual union all select current_user();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think the problem here is, that the CBO is not able to handle queries, where there is no source table.&lt;/p&gt;</comment>
                            <comment id="15357309" author="pvary" created="Thu, 30 Jun 2016 15:48:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;Jesus Camacho Rodriguez&lt;/a&gt; Could you please take a look at this? Every time one of the above queries is run, the error is logged, and the execution falls back to the normal mode without CBO. I was able to come up a patch which turns of the CBO for every query where there is no source table, but not sure that this is the right solution, or even the problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;===================================================================
--- ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java	(revision de3d86cdd3db174d6bc5d8c65796a1e981171124)
+++ ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java	(revision )
@@ -387,8 +387,9 @@
     boolean needToLogMessage = STATIC_LOG.isInfoEnabled();
     boolean isSupportedRoot = root == HiveParser.TOK_QUERY || root == HiveParser.TOK_EXPLAIN
         || qb.isCTAS();
-    boolean isSupportedType = qb.getIsQuery() || qb.isCTAS()
-        || cboCtx.type == PreCboCtx.Type.INSERT;
+    // Queries without a source table currently are not supported by CBO
+    boolean isSupportedType = (qb.getIsQuery() &amp;amp;&amp;amp; !qb.containsQueryWithoutSourceTable())
+        || qb.isCTAS() || cboCtx.type == PreCboCtx.Type.INSERT;
     boolean noBadTokens = HiveCalciteUtil.validateASTForUnsupportedTokens(ast);
     boolean result = isSupportedRoot &amp;amp;&amp;amp; isSupportedType &amp;amp;&amp;amp; getCreateViewDesc() == null
         &amp;amp;&amp;amp; noBadTokens;
@@ -400,7 +401,7 @@
           msg += &quot;doesn&apos;t have QUERY or EXPLAIN as root and not a CTAS; &quot;;
         }
         if (!isSupportedType) {
-          msg += &quot;is not a query, CTAS, or insert; &quot;;
+          msg += &quot;is not a query with at least one source table os subquery, CTAS, or insert; &quot;;
         }
         if (getCreateViewDesc() != null) {
           msg += &quot;has create view; &quot;;
===================================================================
--- ql/src/java/org/apache/hadoop/hive/ql/parse/QBExpr.java	(revision de3d86cdd3db174d6bc5d8c65796a1e981171124)
+++ ql/src/java/org/apache/hadoop/hive/ql/parse/QBExpr.java	(revision )
@@ -120,4 +120,17 @@
     }
     return qbexpr1.isSimpleSelectQuery() &amp;amp;&amp;amp; qbexpr2.isSimpleSelectQuery();
   }
+
+  /**
+   * returns true, if the query block contains any query, or subquery without a source table
+   * Like select current_user(), select current_database()
+   * @return true, if the query block contains any query without a source table
+   */
+  public boolean containsQueryWithoutSourceTable() {
+    if (qb != null) {
+      return qb.containsQueryWithoutSourceTable();
+    } else {
+      return qbexpr1.containsQueryWithoutSourceTable() || qbexpr2.containsQueryWithoutSourceTable();
+    }
+  }
 }
===================================================================
--- ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java	(revision de3d86cdd3db174d6bc5d8c65796a1e981171124)
+++ ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java	(revision )
@@ -437,4 +437,17 @@
     return aliasInsideView;
   }
 
+  /**
+   * returns true, if the query block contains any query, or subquery without a source table
+   * Like select current_user(), select current_database()
+   * @return true, if the query block contains any query without a source table
+   */
+  public boolean containsQueryWithoutSourceTable() {
+    for (QBExpr qbexpr : aliasToSubq.values()) {
+      if (qbexpr.containsQueryWithoutSourceTable()) {
+        return true;
+      }
+    }
+    return aliasToTabs.size()==0 &amp;amp;&amp;amp; aliasToSubq.size()==0;
+  }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15359560" author="jcamachorodriguez" created="Fri, 1 Jul 2016 20:12:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;Peter Vary&lt;/a&gt;, fix looks good. It is good we catch it before instead of failing while parsing the query. Could you upload a patch and trigger QA? Thanks!&lt;/p&gt;</comment>
                            <comment id="15362181" author="pvary" created="Tue, 5 Jul 2016 08:10:02 +0000"  >&lt;p&gt;Patch for not using CBO if there is no source table in any of the queries, or subqueries &lt;/p&gt;</comment>
                            <comment id="15362185" author="pvary" created="Tue, 5 Jul 2016 08:11:19 +0000"  >&lt;p&gt;Submitting the patch, to see if it breaks anything&lt;/p&gt;</comment>
                            <comment id="15362740" author="hiveqa" created="Tue, 5 Jul 2016 16:41:43 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12816147/HIVE-14138.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12816147/HIVE-14138.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 7 failed/errored test(s), 10294 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/369/testReport&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/369/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/369/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/369/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-369/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-369/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12816147 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15363060" author="jcamachorodriguez" created="Tue, 5 Jul 2016 19:21:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;Peter Vary&lt;/a&gt;, could you regenerate q file for &lt;tt&gt;explainuser_1&lt;/tt&gt;?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt; Plan not optimized by CBO.
---
&amp;gt; Plan not optimized by CBO due to missing feature [Others].
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rest looks good, +1.&lt;/p&gt;</comment>
                            <comment id="15364146" author="pvary" created="Wed, 6 Jul 2016 11:12:57 +0000"  >&lt;p&gt;Addressing the unit test issue&lt;/p&gt;</comment>
                            <comment id="15365229" author="jcamachorodriguez" created="Wed, 6 Jul 2016 22:18:51 +0000"  >&lt;p&gt;Pushed to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;Peter Vary&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12984956">HIVE-14123</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12816412" name="HIVE-14138.2.patch" size="4007" author="pvary" created="Wed, 6 Jul 2016 11:12:57 +0000"/>
                            <attachment id="12816147" name="HIVE-14138.patch" size="3362" author="pvary" created="Tue, 5 Jul 2016 08:10:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Jul 2016 20:12:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30ct3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>