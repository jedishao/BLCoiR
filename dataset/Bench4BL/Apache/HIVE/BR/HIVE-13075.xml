<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 11:29:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HIVE-13075/HIVE-13075.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HIVE-13075] Metastore shuts down when no delegation token is found in ZooKeeper</title>
                <link>https://issues.apache.org/jira/browse/HIVE-13075</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;tt&gt;ZooKeeperTokenStore&lt;/tt&gt; looks &lt;a href=&quot;https://github.com/apache/hive/blob/branch-1.2/shims/common/src/main/java/org/apache/hadoop/hive/thrift/ZooKeeperTokenStore.java#L397&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;as follows&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DelegationTokenInformation getToken(DelegationTokenIdentifier tokenIdentifier) {
  &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] tokenBytes = zkGetData(getTokenPath(tokenIdentifier));
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; HiveDelegationTokenSupport.decodeDelegationTokenInformation(tokenBytes);
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TokenStoreException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to decode token&quot;&lt;/span&gt;, ex);
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is slightly different from &lt;a href=&quot;https://github.com/apache/hive/blob/branch-1.2/shims/common/src/main/java/org/apache/hadoop/hive/thrift/DBTokenStore.java#L85&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;DBTokenStore implementation&lt;/a&gt; that is protected against &lt;tt&gt;tokenBytes==null&lt;/tt&gt; because nullable &lt;tt&gt;tokenBytes&lt;/tt&gt; causes NPE to be thrown in &lt;a href=&quot;https://github.com/apache/hive/blob/branch-1.2/shims/common/src/main/java/org/apache/hadoop/security/token/delegation/HiveDelegationTokenSupport.java#L51&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HiveDelegationTokenSupport#decodeDelegationTokenInformation&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Furthermore, NPE thrown here causes &lt;a href=&quot;https://github.com/apache/hive/blob/branch-1.2/shims/common/src/main/java/org/apache/hadoop/hive/thrift/TokenStoreDelegationTokenSecretManager.java#L333&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;TokenStoreDelegationTokenSecretManager.ExpiredTokenRemover&lt;/a&gt; to catch it and exits MetaStore.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;null&lt;/tt&gt; from &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/branch-1.2/shims/common/src/main/java/org/apache/hadoop/hive/thrift/ZooKeeperTokenStore.java#L284&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;zkGetData()&lt;/a&gt;&lt;/tt&gt; is possible during ZooKeeper failure or (and that was our case) when another metastore instance removes tokens during &lt;tt&gt;ExpiredTokenRemover&lt;/tt&gt; run. There were two solutions of this problem:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;distributed lock in ZooKeeper acquired during one metastore instance&apos;s ExpiredTokenRemover run,&lt;/li&gt;
	&lt;li&gt;simple null check&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think null check is sufficient if it is in &lt;tt&gt;DBTokenStore&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Patch will be attached.&lt;/p&gt;

&lt;p&gt;Sorry for an edit but I think worth mentioning is a fact that possible workaround for this issue is setting &lt;tt&gt;hive.cluster.delegation.key.update-interval&lt;/tt&gt;, &lt;tt&gt;hive.cluster.delegation.token.renew-interval&lt;/tt&gt; and &lt;tt&gt;hive.cluster.delegation.token.max-lifetime&lt;/tt&gt; to one year as described &lt;a href=&quot;https://community.cloudera.com/t5/Web-UI-Hue-Beeswax/Potential-misconfiguration-detected-Hue-Hive-Editor-HiveServer2/m-p/26117/highlight/true#M763&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;. But in my opinion it is not an engineer-way of doing things &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12939846">HIVE-13075</key>
            <summary>Metastore shuts down when no delegation token is found in ZooKeeper</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="wikp">Piotr Wikie&#322;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Feb 2016 15:12:52 +0000</created>
                <updated>Tue, 23 Feb 2016 09:08:42 +0000</updated>
                            <resolved>Fri, 19 Feb 2016 03:03:17 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.2.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15153626" author="thejas" created="Fri, 19 Feb 2016 03:02:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wikp&quot; class=&quot;user-hover&quot; rel=&quot;wikp&quot;&gt;Piotr Wikie&#322;&lt;/a&gt; Thanks for reporting this and the diagnosis!&lt;br/&gt;
I should have checked for this first. Lets track it in the new jira with the patch. &lt;/p&gt;</comment>
                            <comment id="15153900" author="wikp" created="Fri, 19 Feb 2016 08:30:48 +0000"  >&lt;p&gt;I&apos;ve put patch in the review board first because I understand &quot;How to contribute&quot; section of the documentation that patch should be reviewed first. &lt;/p&gt;</comment>
                            <comment id="15157298" author="thejas" created="Mon, 22 Feb 2016 17:11:25 +0000"  >&lt;p&gt;Please note that it is customary to also put the link to reviewboard in the jira.&lt;/p&gt;</comment>
                            <comment id="15157355" author="wikp" created="Mon, 22 Feb 2016 17:34:55 +0000"  >&lt;p&gt;Thank you, I&apos;ll remember that. &lt;/p&gt;

&lt;p&gt;My comment was about need of small improvements in &quot;How to contribute&quot; document. For non-english speakers, like me, a to-do list from &quot;I&apos;ve got some code&quot; to &quot;see my code after git pull on master&quot; would be invaluable &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15158589" author="lefty@hortonworks.com" created="Tue, 23 Feb 2016 09:08:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wikp&quot; class=&quot;user-hover&quot; rel=&quot;wikp&quot;&gt;Piotr Wikie&#322;&lt;/a&gt;, if you would like to improve &quot;How to Contribute&quot; just obtain wiki edit privileges as described here:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/AboutThisWiki#AboutThisWiki-Howtogetpermissiontoedit&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;How to get permission to edit &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/HowToContribute&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;How to Contribute &lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;&lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/HowToContribute#HowToContribute-CreatingaPatch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Creating a Patch &lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Or you could open a new JIRA issue with your doc improvement ideas, and we&apos;ll try to find time to do it for you.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12940299">HIVE-13090</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 19 Feb 2016 03:02:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2sy7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>