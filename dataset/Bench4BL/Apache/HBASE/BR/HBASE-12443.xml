<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:16:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12443/HBASE-12443.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12443] After increasing the TTL value of a Hbase Table , table gets inaccessible. Scan table not working.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12443</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>
&lt;p&gt;After increasing the TTL value of a Hbase Table , table gets inaccessible. Scan table not working.&lt;/p&gt;

&lt;p&gt;Scan in hbase shell throws&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: Block index not loaded&lt;br/&gt;
at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
at org.apache.hadoop.hbase.io.hfile.HFileReaderV1.blockContainingKey(HFileReaderV1.java:181)&lt;br/&gt;
at org.apache.hadoop.hbase.io.hfile.HFileReaderV1$AbstractScannerV1.seekTo(HFileReaderV1.java:426)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.StoreFileScanner.seekAtOrAfter(StoreFileScanner.java:226)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.StoreFileScanner.seek(StoreFileScanner.java:145)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.StoreScanner.&amp;lt;init&amp;gt;(StoreScanner.java:131)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.Store.getScanner(Store.java:2015)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion$RegionScannerImpl.&amp;lt;init&amp;gt;(HRegion.java:3706)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.instantiateRegionScanner(HRegion.java:1761)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.getScanner(HRegion.java:1753)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.getScanner(HRegion.java:1730)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegionServer.openScanner(HRegionServer.java:2409)&lt;br/&gt;
at sun.reflect.GeneratedMethodAccessor56.invoke(Unknown Source)&lt;br/&gt;
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.java:320)&lt;br/&gt;
at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:1426)&lt;/p&gt;




&lt;p&gt;STEPS to Reproduce:&lt;/p&gt;

&lt;p&gt; create &apos;debugger&apos;,&lt;/p&gt;
{NAME =&amp;gt; &apos;d&apos;,TTL =&amp;gt; 15552000}
&lt;p&gt; put &apos;debugger&apos;,&apos;jdb&apos;,&apos;d:desc&apos;,&apos;Java debugger&apos;,1399699792000&lt;br/&gt;
 disable &apos;debugger&apos;&lt;br/&gt;
alter &apos;debugger&apos;,&lt;/p&gt;
{NAME =&amp;gt; &apos;d&apos;,TTL =&amp;gt; 69120000}
&lt;p&gt;enable &apos;debugger&apos;&lt;br/&gt;
scan &apos;debugger&apos;&lt;/p&gt;



&lt;p&gt;Reason for the issue:&lt;/p&gt;

&lt;p&gt;   When inserting already expired data in debugger table, hbase creates a hfile with empty data &lt;br/&gt;
block and index block. On scanning table, StoreFile.Reader checks whether the TimeRangeTracker&apos;s maximum timestamp is greater than ttl value, so it skips the empty file.&lt;/p&gt;

&lt;p&gt;  But when ttl is changed, the maximum timestamp will be lesser than ttl value, so StoreFile.Reader tries to read index block from HFile leading to java.lang.IllegalStateException: Block index not loaded.&lt;/p&gt;

&lt;p&gt;SOLUTION:&lt;/p&gt;

&lt;p&gt;StoreFile.java &lt;/p&gt;

&lt;p&gt;       boolean passesTimerangeFilter(Scan scan, long oldestUnexpiredTS) {&lt;br/&gt;
      if (timeRangeTracker == null) &lt;/p&gt;
{
        return true;
      } else {
        return timeRangeTracker.includesTimeRange(scan.getTimeRange()) &amp;amp;&amp;amp;
            timeRangeTracker.getMaximumTimestamp() &amp;gt;= oldestUnexpiredTS;
      }&lt;br/&gt;
    }&lt;br/&gt;
&lt;br/&gt;
In the above method, by checking whether there are entries in the hfile by using FixedFileTrailer&lt;br/&gt;
block we can skip scanning the empty hfile.&lt;br/&gt;
&lt;br/&gt;
// changed code will solve the issue&lt;br/&gt;
&lt;br/&gt;
     boolean passesTimerangeFilter(Scan scan, long oldestUnexpiredTS) {&lt;br/&gt;
      if (timeRangeTracker == null) {
        return true;
      }
&lt;p&gt; else &lt;/p&gt;
{
        return timeRangeTracker.includesTimeRange(scan.getTimeRange()) &amp;amp;&amp;amp;
            timeRangeTracker.getMaximumTimestamp() &amp;gt;= oldestUnexpiredTS &amp;amp;&amp;amp; reader.getEntries()&amp;gt;0;
      }
&lt;p&gt;    }&lt;/p&gt;



</description>
                <environment></environment>
        <key id="12753620">HBASE-12443</key>
            <summary>After increasing the TTL value of a Hbase Table , table gets inaccessible. Scan table not working.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Prabhu Joseph">Prabhu Joseph</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Nov 2014 05:23:06 +0000</created>
                <updated>Sun, 28 Dec 2014 03:11:23 +0000</updated>
                            <resolved>Fri, 7 Nov 2014 05:47:00 +0000</resolved>
                                                                    <component>HFile</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14201645" author="lhofhansl" created="Fri, 7 Nov 2014 05:47:00 +0000"  >&lt;p&gt;Dup of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11419&quot; title=&quot;After increasing TTL value of a hbase table having pre-split regions and decreasing TTL value, table becomes inaccessible.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11419&quot;&gt;&lt;del&gt;HBASE-11419&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Please do not file the same issue again. In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11419&quot; title=&quot;After increasing TTL value of a hbase table having pre-split regions and decreasing TTL value, table becomes inaccessible.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11419&quot;&gt;&lt;del&gt;HBASE-11419&lt;/del&gt;&lt;/a&gt; you mention 0.94.6 being your version. Can you try with a later version of 0.94?&lt;br/&gt;
You can upgrade from 0.94.6 directly to 0.94.24 with a rolling restart.&lt;/p&gt;</comment>
                            <comment id="14201655" author="prabhu joseph" created="Fri, 7 Nov 2014 05:54:01 +0000"  >&lt;p&gt;Hi Lars,&lt;/p&gt;

&lt;p&gt;The issue is identified and solution is ready. Can i submit patch for the issue.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
J Prabhu&lt;/p&gt;</comment>
                            <comment id="14201661" author="ram_krish" created="Fri, 7 Nov 2014 05:57:40 +0000"  >&lt;p&gt;Will try checking this in trunk.&lt;/p&gt;</comment>
                            <comment id="14202175" author="lhofhansl" created="Fri, 7 Nov 2014 15:48:33 +0000"  >&lt;p&gt;If this is not the same issue, feel free to reopen of course.&lt;/p&gt;</comment>
                            <comment id="14202508" author="lhofhansl" created="Fri, 7 Nov 2014 19:25:06 +0000"  >&lt;p&gt;And if you have a patch please post it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12724076">HBASE-11419</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 7 Nov 2014 05:47:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i223dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>