<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:27:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5504/HBASE-5504.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5504] Online Merge</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5504</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;As discussed, please refer the discussion at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4991&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-4991&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Design suggestion from Stack:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I suggest a design below. It has some prerequisites, some general function that this feature could use (and others). The prereqs if you think them good, could be done outside of this JIRA.&lt;/p&gt;

&lt;p&gt;Here&apos;s a suggested rough outline of how I think this feature should run. The feature I&apos;m describing below is merge and deleteRegion for I see them as in essence the same thing.&lt;/p&gt;

&lt;p&gt;(C) Client, (M) Master, RS (Region server), ZK (ZooKeeper)&lt;/p&gt;

&lt;p&gt;1. Client calls merge or deleteRegion API. API is a range of rows. (C)&lt;br/&gt;
2. Master gets call. (M)&lt;br/&gt;
3. Master obtains a write lock on table so it can&apos;t be disabled from under us. The write lock will also disable splitting. This is one of the prereqs I think. Its &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5494&quot; title=&quot;Introduce a zk hosted table-wide read/write lock so only one table operation at a time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5494&quot;&gt;&lt;del&gt;HBASE-5494&lt;/del&gt;&lt;/a&gt; (Or we could just do something simpler where we have a flag up in zk that splitRegion checks but thats less useful I think; OR we do the dynamic configs issue and set splits to off via a config. change). There&apos;d be a timer for how long we wait on the table lock. (M -&amp;gt; ZK)&lt;br/&gt;
4. If we get the lock, write intent to merge a range up into zk. It also hoists into zk if its a pure merge or a merge that drops the region data (a deleteRegion call) (M)&lt;br/&gt;
5. Return to the client either our failed attempt at locking the table or an id of some sort used identifying this running operation; can use it querying status. (M -&amp;gt; C)&lt;br/&gt;
6. Turn off balancer. TODO/prereq: Do it in a way that is persisted. Balancer switch currently in memory only so if master crashes, new master will come up in balancing mode # (If we had dynamic config. could hoist up to zk a config. that disables the balancer rather than have a balancer-specific flag/znode OR if a write lock outstanding on a table, then the balancer does not balance regions in the locked table - this latter might be the easiest to do) (M)&lt;br/&gt;
7. Write into zk that just turned off the balancer (If it was on) (M -&amp;gt; ZK)&lt;br/&gt;
8. Get regions that are involved in the span (M)&lt;br/&gt;
9. Hoist the list up into zk. (M -&amp;gt; ZK)&lt;br/&gt;
10. Create region to span the range. (M)&lt;br/&gt;
11. Write that we did this up into zk. (M -&amp;gt; ZK)&lt;br/&gt;
12. Close regions in parallel. Confirm close in parallel. (M -&amp;gt; RS)&lt;br/&gt;
13. Write up into zk regions closed (This might not be necessary since can ask if region is open). (M -&amp;gt; ZK)&lt;br/&gt;
14. If a merge and not a delete region, move files under new region. Might multithread this (moves should go pretty fast). If a deleteregion, we skip this step. (M)&lt;br/&gt;
15. On completion mark zk (though may not be necessary since its easy to look in fs to see state of move). (M -&amp;gt; ZK)&lt;br/&gt;
16. Edit .META. (M)&lt;br/&gt;
17. Confirm edits went in. (M)&lt;br/&gt;
18. Move old regions to hbase trash folder TODO: There is no trash folder under /hbase currently. We should add one. (M)&lt;br/&gt;
19. Enable balancer (if it was off) (M)&lt;br/&gt;
20. Unlock table (M)&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12544858">HBASE-5504</key>
            <summary>Online Merge</summary>
                <type id="13" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/genericissue.png">Brainstorming</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mubarakseyed">Mubarak Seyed</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Mar 2012 23:28:10 +0000</created>
                <updated>Thu, 2 May 2013 02:30:56 +0000</updated>
                            <resolved>Tue, 29 Jan 2013 03:41:59 +0000</resolved>
                                    <version>0.94.0</version>
                                                    <component>Client</component>
                    <component>master</component>
                    <component>shell</component>
                    <component>Zookeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                <comments>
                            <comment id="13220483" author="mubarakseyed" created="Thu, 1 Mar 2012 23:30:03 +0000"  >&lt;p&gt;Design will be evolved.&lt;/p&gt;</comment>
                            <comment id="13220558" author="zhihyu@ebaysf.com" created="Fri, 2 Mar 2012 01:01:40 +0000"  >&lt;p&gt;Since region splitting is disabled after step 3, how do we deal with the case where the start of row range lies in the middle of a region ?&lt;br/&gt;
For step 6:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;if a write lock outstanding on a table, then the balancer does not balance regions in the locked table&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I like the above approach. We can create a sub-task which is to be done after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5494&quot; title=&quot;Introduce a zk hosted table-wide read/write lock so only one table operation at a time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5494&quot;&gt;&lt;del&gt;HBASE-5494&lt;/del&gt;&lt;/a&gt; goes in.&lt;br/&gt;
For step 14, we still need to move data for delete region request because we should have chosen one of the neighbor regions to cover the hole in .META.&lt;/p&gt;

&lt;p&gt;What if the master crashes anywhere between step 6 and step 19 ? How would the new master deal with the outstanding table lock ?&lt;/p&gt;</comment>
                            <comment id="13220572" author="mubarakseyed" created="Fri, 2 Mar 2012 01:18:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;What if the master crashes anywhere between step 6 and step 19 ? How would the new master deal with the outstanding table lock ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think new active master (after failover) should resume executing task (provided state is maintained in table lock znode)&lt;/p&gt;</comment>
                            <comment id="13220596" author="mubarakseyed" created="Fri, 2 Mar 2012 01:53:04 +0000"  >&lt;p&gt;How do we get around if merge/delete-range get stuck (it should not but if it happens???), can we provide a tool to fail or delete? (something like admin operation). User can delete the lock znode in ZK (thats the worst case)? Can we make use of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5459&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-5459&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13220601" author="zhihyu@ebaysf.com" created="Fri, 2 Mar 2012 01:58:03 +0000"  >&lt;p&gt;w.r.t. the comment @ 02/Mar/12 01:18,&lt;br/&gt;
Is it possible that there would be more than one master-coordinated task for the same table running at the same time ?&lt;/p&gt;

&lt;p&gt;If so, what should the state store ?&lt;/p&gt;

&lt;p&gt;I think we should remove the noob label for this JIRA.&lt;/p&gt;</comment>
                            <comment id="13220615" author="mubarakseyed" created="Fri, 2 Mar 2012 02:23:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is it possible that there would be more than one master-coordinated task for the same table running at the same time ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If we store like /hbase/lock/&amp;lt;table_name&amp;gt; then we can&apos;t. How about&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 /hbase/lock/&amp;lt;table_name&amp;gt;/lockNode1
                        /lockNode1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;lockNode1 for task1 and be W, lockNode2 for task2 and be R&lt;/p&gt;</comment>
                            <comment id="13220622" author="mubarakseyed" created="Fri, 2 Mar 2012 02:35:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5494&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-5494&lt;/a&gt; says only one table operation at a time.&lt;/p&gt;

&lt;p&gt;@Stack&lt;br/&gt;
What happens if task (which held the lock) get stuck? &lt;/p&gt;</comment>
                            <comment id="13220661" author="mubarakseyed" created="Fri, 2 Mar 2012 04:19:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since region splitting is disabled after step 3, how do we deal with the case where the start of row range lies in the middle of a region ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we were discussing about start/end key should match with region boundary (single or multiple), isn&apos;t? Are we planning to do arbitrary start/end key?&lt;/p&gt;</comment>
                            <comment id="13220669" author="zhihyu@ebaysf.com" created="Fri, 2 Mar 2012 04:48:11 +0000"  >&lt;p&gt;So there is validation at step 2 for region boundary check. That&apos;s fine.&lt;br/&gt;
In first version, we can disable region splitting.&lt;/p&gt;</comment>
                            <comment id="13220689" author="stack" created="Fri, 2 Mar 2012 05:47:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since region splitting is disabled after step 3, how do we deal with the case where the start of row range lies in the middle of a region ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good question.  How about, if a merge, we include the hosting region in the merge.  If a delete region, we throw an exception saying you need to specify region edges.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For step 14, we still need to move data for delete region request because we should have chosen one of the neighbor regions to cover the hole in .META.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this comes of a misunderstanding that you might have Ted.  You can&apos;t alter region edges once created.  For example, the directory in hdfs is the hash of regionname which includes at least the startkey and should one day include the endkey... If you change the delimiting keys, you have to make a new region.  Were you thinking we could change the delimiting keys on an existing region?&lt;/p&gt;

&lt;p&gt;On &apos;What if the master crashes anywhere between step 6 and step 19 ?&apos;, its what Mubarak says; the new master comes up and after initializing, tries to pick up merge/delete from where the previous master left off... Or simpler, it could just undo it all?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;How do we get around if merge/delete-range get stuck (it should not but if it happens???)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we need to make the operation cancelable?  In shell/api, there&apos;d be a cancel operation on table!  (Since you need a write lock to do one of these operations, this would mean one operation at a time per table only..... maybe no need of there being a lock transaction id because only one happening at a time?)&lt;/p&gt;

&lt;p&gt;Later we can do something better where if an operation does not complete, the master operation runner would do the cancel.. but that we could do later?&lt;/p&gt;


</comment>
                            <comment id="13220734" author="lhofhansl" created="Fri, 2 Mar 2012 06:43:15 +0000"  >&lt;p&gt;.bq 18. Move old regions to hbase trash folder TODO: There is no trash folder under /hbase currently. We should add one. (M)&lt;/p&gt;

&lt;p&gt;That&apos;s would be awesome for a variety of other reason. For example snapshots.&lt;/p&gt;</comment>
                            <comment id="13220743" author="zhihyu@ebaysf.com" created="Fri, 2 Mar 2012 07:09:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;You can&apos;t alter region edges once created.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Understood.&lt;br/&gt;
I meant that data for the neighbor region we choose should be copied. The neighbor region would have new delimiting key.&lt;/p&gt;</comment>
                            <comment id="13221023" author="stack" created="Fri, 2 Mar 2012 16:19:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;I meant that data for the neighbor region we choose should be copied. The neighbor region would have new delimiting key.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I&apos;m not following Ted.  You need to bring me a long.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13221082" author="zhihyu@ebaysf.com" created="Fri, 2 Mar 2012 17:41:41 +0000"  >&lt;p&gt;Cycling old bits:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4991?focusedCommentId=13195136&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13195136&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4991?focusedCommentId=13195136&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13195136&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13221179" author="stack" created="Fri, 2 Mar 2012 19:14:57 +0000"  >&lt;p&gt;@Ted that takes me to a comment I made.  I still am without understanding.&lt;/p&gt;</comment>
                            <comment id="13246885" author="ecn" created="Thu, 5 Apr 2012 00:32:02 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I work on Accumulo, and I implemented the merge/deleteRange feature.&lt;/p&gt;

&lt;p&gt;Our primary use-case was a time-based row, in which data was being deleted as it aged.  Over time, this created splits that were empty and resulted in poor balancing. The same goes for deleteRange.  It is now very efficient to tell Accumulo: delete all rows that fall before &quot;20111231&quot;.&lt;/p&gt;

&lt;p&gt;I know that stack and Keith Turner have commented on other tickets and referenced the FATE architecture.  It really simplified the many steps in merge (see the outline in this ticket).  FATE is not very big and would be easy to borrow/emulate.&lt;/p&gt;

&lt;p&gt;We also added the concept of read and write locks on tables.  Merge grabs a write lock on a table, and so does bulk import.  This reduces the number of assumptions each of the processes has to understand.&lt;/p&gt;

&lt;p&gt;Accumulo has a file garbage collector, so files can survive many splits. But this makes merge more complex because files containing data for an unused section of a file in a split might be re-used in a merge, and that data might have been deleted.  A merge would inadvertently bring that data back. We had at least two implementation options:&lt;/p&gt;

&lt;p&gt; 1. keep range information with files in the metadata tablet&lt;br/&gt;
 2. &quot;chop&quot; files, or compact a file down to the tablet&apos;s range before the merge&lt;/p&gt;

&lt;p&gt;We chose option 2.  This might appeal to the HBase community, too, since it avoids double-indirection and file-deletion issues.  But I regret not using option 1 because it would have made merge as fast as split.&lt;/p&gt;

&lt;p&gt;Our merge works on a range. But we have tools that allow a user to merge based on their tablet size.  But this only works with one range at a time.  It also requires the tablet to go online to perform the chop operation. If a user decides to change their tablet size from 256M to 1G, and their table size is 1P, they will wait a very long time.  In the future we will recognize this case and chop the tablets in parallel and take the table offline to re-write the metadata table.&lt;/p&gt;

&lt;p&gt;I know we found a lot of places in Accumulo where we assumed that tablets would only split.  It took a lot of testing to discover these assumptions.  Fortunately merge/split are isomorphic and can be used to test the each other.  DeleteRange, while very similar to merge, does not have this property and is harder to test at scale.&lt;/p&gt;</comment>
                            <comment id="13247307" author="stack" created="Thu, 5 Apr 2012 15:47:50 +0000"  >&lt;p&gt;Hey Eric.  Thanks for the help. Looking at FATE it didn&apos;t look like we could pull it over easily (maybe I should look again) but for sure we need to emulate something like it.  First up would be table read/write lock and have actions like split (or bulk import) take out at a read lock before progressing.  Can I have a pointer for your file GCer, on why delayed cleanup?  So you&apos;d keep up in meta the list of files for a range and this would be the region/tablets&apos; &quot;list&quot; even though the files might not sit physically under a particular region/tablet (What about compactions?  Would it have to update the list in the meta table when it moved the compacted file into place?).  On point 1., isn&apos;t it possible a file might still over-span a range?&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;</comment>
                            <comment id="13257523" author="ecn" created="Thu, 19 Apr 2012 14:53:58 +0000"  >&lt;p&gt;We implemented delayed file cleanup because that is what was described in the BigTable paper.  A tablet will have files in multiple directories, including directories under different tables, as is the case just after a table copy.  The file information is stored in the metadata table.  Splits, bulk import and table copying all create references to files, which remain shared.  Data will exist in the file, but outside the tablet&apos;s range, which is why we chop them during merge.  The tablet server keeps the list up-to-date in the metadata table as files are bulk loaded and compacted.  We also keep the list of files that are candidates for deletion in the metadata table, so we aren&apos;t asking the NameNode for information about files during GC.  Bulk import, compaction, and gc must all be coordinated such that the file isn&apos;t inadvertently deleted while still being imported into other tablets.&lt;/p&gt;</comment>
                            <comment id="13564618" author="jmspaggi" created="Mon, 28 Jan 2013 20:02:47 +0000"  >&lt;p&gt;Seems there is no activities on this JIRA for almost a year now, and 7403 seems to be close to be released.&lt;/p&gt;

&lt;p&gt;Should we close thise one?&lt;/p&gt;</comment>
                            <comment id="13565045" author="jmhsieh" created="Tue, 29 Jan 2013 03:41:59 +0000"  >&lt;p&gt;Resolved as duplicate since work has moved to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7403&quot; title=&quot;Online Merge&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7403&quot;&gt;&lt;del&gt;HBASE-7403&lt;/del&gt;&lt;/a&gt;.  Thanks for pointing this out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmspaggi&quot; class=&quot;user-hover&quot; rel=&quot;jmspaggi&quot;&gt;Jean-Marc Spaggiari&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12507259">HBASE-3887</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12429691">HBASE-1621</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12624812">HBASE-7403</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12543771">HBASE-5459</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12544674">HBASE-5494</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 2 Mar 2012 01:01:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230044</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02b7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11418</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>