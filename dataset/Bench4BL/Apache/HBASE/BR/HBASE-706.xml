<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 18:51:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-706/HBASE-706.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-706] On OOME, regionserver sticks around and doesn&apos;t go down with cluster</title>
                <link>https://issues.apache.org/jira/browse/HBASE-706</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;On John Gray cluster, an errant, massive, store file caused us OOME.  Shutdown of cluster left this regionserver in place. A thread dump failed with OOME.  Here is last thing in log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-06-25 03:21:55,111 INFO org.apache.hadoop.hbase.HRegionServer: worker thread exiting
2008-06-25 03:24:26,923 FATAL org.apache.hadoop.hbase.HRegionServer: Set stop flag in regionserver/0:0:0:0:0:0:0:0:60020.cacheFlusher
java.lang.OutOfMemoryError: Java heap space
        at java.util.HashMap.&amp;lt;init&amp;gt;(HashMap.java:226)
        at java.util.HashSet.&amp;lt;init&amp;gt;(HashSet.java:103)
        at org.apache.hadoop.hbase.HRegionServer.getRegionsToCheck(HRegionServer.java:1789)
        at org.apache.hadoop.hbase.HRegionServer$Flusher.enqueueOptionalFlushRegions(HRegionServer.java:479)
        at org.apache.hadoop.hbase.HRegionServer$Flusher.run(HRegionServer.java:385)
2008-06-25 03:24:26,923 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 60020, call batchUpdate(items,,1214272763124, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@67d6b1e2) from 192.168.249.230:38278: error: java.io.IOException: Server not running
java.io.IOException: Server not running
        at org.apache.hadoop.hbase.HRegionServer.checkOpen(HRegionServer.java:1758)
        at org.apache.hadoop.hbase.HRegionServer.batchUpdate(HRegionServer.java:1547)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:616)
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:413)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:901)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I get an OOME just trying to threaddump, would seem to indicate we need to start keeping a little memory resevoir around for emergencies such as this just so we can shutdown clean.&lt;/p&gt;

&lt;p&gt;Moving this into 0.2.  Seems important to fix if robustness is name of the game.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12399013">HBASE-706</key>
            <summary>On OOME, regionserver sticks around and doesn&apos;t go down with cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jun 2008 17:33:13 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:19 +0000</updated>
                            <resolved>Tue, 8 Jul 2008 21:10:57 +0000</resolved>
                                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12611290" author="stack" created="Mon, 7 Jul 2008 18:56:13 +0000"  >&lt;p&gt;In a previous application, we&apos;d set aside a bit of memory to release when application hit an OOME.  The reservation was done on startup.  It was a linked list of sizeable blocks rather than one big monolithic block, probably so allocation would still work in a fragmented heap.  In that apps&apos; case, default was a single block of 5M.  Maybe in hbase, set aside more?  20M?  In 4 blocks?  Make it configurable?  What you think? Default hbase heap is 1G I believe (See the bin/hbase script)&lt;/p&gt;

&lt;p&gt;Main loop in the application was wrapped in a try/catch.  On &apos;serious error&apos;, we&apos;d first release the memory resevoir &amp;#8211; the release could be run by more than one thread so some times it&apos;d be a noop &amp;#8211; and then run code to set the application into a safe &apos;park&apos; so could be analyzed later by operator.  In our case, things would be a little trickier because there is more than just the one loop.    The OOME could bubble out in the main master/regionserver loops or in one of the service thread loops.  You&apos;d have to plug in the OOME processing into all places (some inherit from Chore so you could add processing there).  We also want our regionserver to go all the ways down if it hit an OOME to minimize damage done. &lt;/p&gt;

&lt;p&gt;I&apos;d imagine that all you&apos;d do is if OOME, release the memory and then let the shutdown proceed normally.  Hopefully, the very release of the resevoir should be sufficient to making a successful shutdown.&lt;/p&gt;

&lt;p&gt;Tests will be hard.   There is an OOMERegionServer.  You might play with that.  You probably won&apos;t be able to inline it as unit test.  Thats OK, I think.  Also, I don&apos;t think its possible to write a handler that will work in all cases, just most: e.g. there may be a pathological case where the just-release resevoir gets eaten up immediately but a rampant thread.   I think we&apos;ll just have to make up a patch that does the above, commit it and then watch how well it does out in the field.&lt;/p&gt;
</comment>
                            <comment id="12611548" author="jdcryans" created="Tue, 8 Jul 2008 12:24:55 +0000"  >&lt;p&gt;I added a reservation linked list that takes a number of blocks of 5M defined by configuration and by default of 4. Using a HRegionServer that works like OOMERegionServer (was easier I thought), the loader.jsp in attachment and the reservation list, here is a trace of a OOME that is correctly handled :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2008-07-07 17:51:42,853 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Completed compaction of 1705462391/contents store size is 23.7m
2008-07-07 17:51:42,868 INFO org.apache.hadoop.hbase.regionserver.HRegion: compaction completed on region loading,53841,1215463619617 in 6sec
2008-07-07 17:52:23,425 WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Ran out of memory
java.lang.OutOfMemoryError: Java heap space
        at java.util.Arrays.copyOf(Arrays.java:2760)
        at java.util.Arrays.copyOf(Arrays.java:2734)
        at java.util.ArrayList.ensureCapacity(ArrayList.java:167)
        at java.util.ArrayList.add(ArrayList.java:351)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.batchUpdate(HRegionServer.java:1152)
...
2008-07-07 17:52:23,587 DEBUG org.apache.hadoop.hbase.RegionHistorian: Offlined
2008-07-07 17:52:23,588 INFO org.apache.hadoop.ipc.Server: Stopping server on 60020
2008-07-07 17:52:23,588 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 60020: exiting
2008-07-07 17:52:23,588 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 60020: exiting
2008-07-07 17:52:23,588 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 60020: exiting
2008-07-07 17:52:23,588 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 60020: exiting
...
2008-07-07 17:52:33,431 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: worker thread exiting
2008-07-07 17:52:33,432 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: regionserver/0:0:0:0:0:0:0:0:60020 exiting
2008-07-07 17:52:33,432 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Starting shutdown thread.
2008-07-07 17:52:33,432 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Shutdown thread complete
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12611562" author="jdcryans" created="Tue, 8 Jul 2008 12:43:58 +0000"  >&lt;p&gt;Please review. I added 2 OOME catch, maybe more is needed.&lt;/p&gt;</comment>
                            <comment id="12611800" author="stack" created="Tue, 8 Jul 2008 21:10:57 +0000"  >&lt;p&gt;Committed.  Thanks for the patch J-D.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12399016">HBASE-707</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12385493" name="hbase-706-v1.patch" size="3637" author="jdcryans" created="Tue, 8 Jul 2008 12:51:37 +0000"/>
                            <attachment id="12385489" name="loader.jsp" size="3006" author="jdcryans" created="Tue, 8 Jul 2008 12:25:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Jul 2008 12:24:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25349</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 22 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h8y7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98712</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>