<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:01:07 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1311/HBASE-1311.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1311] ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1311</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;After about 12 hours of operation, this repeats over and over in the regionserver log:&lt;/p&gt;

&lt;p&gt;2009-04-05 19:44:38,445 WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master&lt;br/&gt;
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired&lt;br/&gt;
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:118)&lt;br/&gt;
	at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)&lt;br/&gt;
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:343)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:339)&lt;br/&gt;
	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:366)&lt;br/&gt;
2009-04-05 19:44:38,445 WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Unable to set watcher on ZooKeeper master address. Retrying.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12422075">HBASE-1311</key>
            <summary>ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nitay">Nitay Joffe</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Apr 2009 19:45:20 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:31 +0000</updated>
                            <resolved>Mon, 11 May 2009 20:23:01 +0000</resolved>
                                                    <fixVersion>0.20.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12695903" author="nitay" created="Sun, 5 Apr 2009 19:49:35 +0000"  >&lt;p&gt;OK, the dreaded session expired event on the regionserver. Seen this before on client side. Will look into it. Thanks.&lt;/p&gt;</comment>
                            <comment id="12695917" author="apurtell" created="Sun, 5 Apr 2009 21:05:12 +0000"  >&lt;p&gt;Thanks Nitay. I can run long duration tests when you have something. &lt;/p&gt;</comment>
                            <comment id="12696631" author="apurtell" created="Tue, 7 Apr 2009 17:22:28 +0000"  >&lt;p&gt;See attached hack of ZooKeeperWrapper to reinitialize the zookeeper handle and recreate ephemeral nodes. This works to address &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1311&quot; title=&quot;ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1311&quot;&gt;&lt;del&gt;HBASE-1311&lt;/del&gt;&lt;/a&gt; but the actions that run from watchers when they see the ephemeral znodes go away because of session expiration (as opposed to real process/node failures) lead to problems like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1314&quot; title=&quot;master sees HRS znode expire and splits log while the HRS is still running and accepting edits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1314&quot;&gt;&lt;del&gt;HBASE-1314&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1315&quot; title=&quot;when HRS znode expires while HRS is still running, HRS enters infinite loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1315&quot;&gt;&lt;del&gt;HBASE-1315&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="12696730" author="nitay" created="Tue, 7 Apr 2009 20:32:16 +0000"  >&lt;p&gt;Hi Andrew,&lt;/p&gt;

&lt;p&gt;I like the idea of the reinit() with the ephemeral node map.&lt;/p&gt;

&lt;p&gt;However this patch fundamentally changes a lot of things in&#160;the design of ZooKeeperWrapper. The initial idea was not to have any retries in ZooKeeperWrapper so that each user of it can handle it differently. Each ZooKeeper operation was supposed to either succeed or fail simply and the code calling it would do what it needs.&lt;/p&gt;

&lt;p&gt;Take a look at how I handled SessionExpired in the client, TableServers. I think it is much cleaner to have each ZooKeeper user (TableServers, HRegionServer, and HMaster) register itself as a watcher and handle SessionExpired for itself. SessionExpired is not something that is particular to a single operation, so littering every ZooKeeper call with it seems a bit much?&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="12696763" author="apurtell" created="Tue, 7 Apr 2009 21:21:09 +0000"  >&lt;p&gt;Hi Nitay. I did try to indicate my patch was a dumb hack. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Just for illustration to show what worked for me for 1311 while tinkering around....&lt;/p&gt;</comment>
                            <comment id="12696784" author="nitay" created="Tue, 7 Apr 2009 22:11:56 +0000"  >&lt;p&gt;Fair enough, I&apos;ll wait for a Submit Patch or something next time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Thanks anyways, it always helps to look at how others think about problems.&lt;/p&gt;</comment>
                            <comment id="12707002" author="stack" created="Thu, 7 May 2009 17:14:30 +0000"  >&lt;p&gt;Had same thing happen to me last night:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-05-07 07:39:29,348 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:29,368 [regionserver/0:0:0:0:0:0:0:0:60021.worker-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:33,249 [regionserver/0:0:0:0:0:0:0:0:60021.worker-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: SyncConnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:33,250 [main-EventThread] DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Set watcher on master address ZNode /hbase/master
2009-05-07 07:39:33,250 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: SyncConnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:33,251 [main-EventThread] DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Set watcher on master address ZNode /hbase/master
2009-05-07 07:39:49,858 [regionserver/0:0:0:0:0:0:0:0:60021.worker-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:50,048 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:39:55,318 [main-EventThread] WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:350)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:346)
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:366)
2009-05-07 07:39:55,319 [main-EventThread] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Unable to set watcher on ZooKeeper master address. Retrying.
2009-05-07 07:40:00,479 [main-EventThread] WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:350)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:346)
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:366)
2009-05-07 07:40:00,480 [main-EventThread] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Unable to set watcher on ZooKeeper master address. Retrying.
2009-05-07 07:40:05,643 [main-EventThread] DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Set watcher on master address ZNode /hbase/master
2009-05-07 07:40:05,643 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: SyncConnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:40:05,644 [main-EventThread] DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Set watcher on master address ZNode /hbase/master
2009-05-07 07:40:05,721 [regionserver/0:0:0:0:0:0:0:0:60021.worker-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: SyncConnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:40:19,108 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:40:19,188 [regionserver/0:0:0:0:0:0:0:0:60021.worker-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: Disconnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:40:24,218 [main-EventThread] WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:350)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:346)
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:366)
2009-05-07 07:40:24,218 [main-EventThread] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Unable to set watcher on ZooKeeper master address. Retrying.
2009-05-07 07:40:29,328 [main-EventThread] WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:350)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:346)
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12707004" author="stack" created="Thu, 7 May 2009 17:15:48 +0000"  >&lt;p&gt;Then it started to do this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-05-07 07:40:57,771 [regionserver/0:0:0:0:0:0:0:0:60021.compactor] DEBUG org.apache.hadoop.hbase.regionserver.Store: Started compaction of 1 file(s), hasReferences=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, into /hbasetrunk2/TestTable/compaction.dir/807729785793552806
2009-05-07 07:40:59,738 [main-EventThread] WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to set watcher on ZNode /hbase/master
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:118)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:709)
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.watchMasterAddress(ZooKeeperWrapper.java:235)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.watchMasterAddress(HRegionServer.java:350)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.process(HRegionServer.java:346)
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:366)
2009-05-07 07:40:59,739 [main-EventThread] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Unable to set watcher on ZooKeeper master address. Retrying.
2009-05-07 07:41:00,553 [regionserver/0:0:0:0:0:0:0:0:60021] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Processing message (Retry: 0)
org.apache.hadoop.hbase.Leases$LeaseStillHeldException
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:513)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.decodeRemoteException(RemoteExceptionHandler.java:94)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.checkThrowable(RemoteExceptionHandler.java:48)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.checkIOException(RemoteExceptionHandler.java:66)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:500)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
2009-05-07 07:41:00,569 [regionserver/0:0:0:0:0:0:0:0:60021] WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Processing message (Retry: 1)
org.apache.hadoop.hbase.Leases$LeaseStillHeldException
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:513)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.decodeRemoteException(RemoteExceptionHandler.java:94)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.checkThrowable(RemoteExceptionHandler.java:48)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.checkIOException(RemoteExceptionHandler.java:66)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:500)
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12707012" author="stack" created="Thu, 7 May 2009 17:24:05 +0000"  >&lt;p&gt;Here is what I saw on master side:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-05-07 07:40:05,597 [RegionManager.rootScanner-EventThread] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Got ZooKeeper event, state: SyncConnected, type: None, path: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2009-05-07 07:40:07,555 [RegionManager.rootScanner] INFO org.apache.hadoop.hbase.master.BaseScanner: RegionManager.rootScanner scan of 1 row(s) of meta region {regionname: -ROOT-,,0, startKey: &amp;lt;&amp;gt;, server: 208.76.44.142:60021} complete
2009-05-07 07:40:19,983 [IPC Server handler 6 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Total Load: 1399, Num Servers: 3, Avg Load: 467.0
2009-05-07 07:40:27,089 [main-EventThread] INFO org.apache.hadoop.hbase.master.ServerManager: aa0-000-15.u.powerset.com_1241637114572_60021 znode expired
2009-05-07 07:40:27,120 [HMaster] DEBUG org.apache.hadoop.hbase.master.HMaster: Processing todo: ProcessServerShutdown of aa0-000-15.u.powerset.com_1241637114572_60021
2009-05-07 07:40:27,120 [HMaster] INFO org.apache.hadoop.hbase.master.RegionServerOperation: process shutdown of server aa0-000-15.u.powerset.com_1241637114572_60021: logSplit: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, rootRescanned: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, numberOfMetaRegions: 1, onlineMetaRegions.size(): 1
2009-05-07 07:40:27,125 [HMaster] INFO org.apache.hadoop.hbase.regionserver.HLog: Splitting 3 log(s) in hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/@LOGS@/aa0-000-15.u.powerset.com_1241637114572_60021
&lt;/span&gt;2009-05-07 07:40:27,126 [HMaster] DEBUG org.apache.hadoop.hbase.regionserver.HLog: Splitting 1 of 3: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/@LOGS@/aa0-000-15.u.powerset.com_1241637114572_60021/hlog.dat.1241676102482
&lt;/span&gt;2009-05-07 07:40:30,022 [main-EventThread] INFO org.apache.hadoop.hbase.master.ServerManager: aa0-000-14.u.powerset.com_1241637114470_60021 znode expired
2009-05-07 07:40:34,779 [IPC Server handler 7 on 60000] INFO org.apache.hadoop.ipc.HBaseServer: IPC Server handler 7 on 60000, call regionServerReport(address: 208.76.44.141:60021, startcode: 1241637114470, load: (requests=0, regions=466, usedHeap=861, maxHeap=1255), [Lorg.apache.hadoop.hbase.HMsg;@191ea7e5, [Lorg.apache.hadoop.hbase.HRegionInfo;@2ba0b845) from 208.76.44.141:5009
4: error: org.apache.hadoop.hbase.Leases$LeaseStillHeldException
org.apache.hadoop.hbase.Leases$LeaseStillHeldException
        at org.apache.hadoop.hbase.master.ServerManager.regionServerReport(ServerManager.java:201)
        at org.apache.hadoop.hbase.master.HMaster.regionServerReport(HMaster.java:604)
        at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:642)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:911)
2009-05-07 07:40:34,792 [IPC Server handler 4 on 60000] INFO org.apache.hadoop.ipc.HBaseServer: IPC Server handler 4 on 60000, call regionServerReport(address: 208.76.44.141:60021, startcode: 1241637114470, load: (requests=0, regions=466, usedHeap=861, maxHeap=1255), [Lorg.apache.hadoop.hbase.HMsg;@5b7836c8, [Lorg.apache.hadoop.hbase.HRegionInfo;@3154b362) from 208.76.44.141:5019
7: error: org.apache.hadoop.hbase.Leases$LeaseStillHeldException
org.apache.hadoop.hbase.Leases$LeaseStillHeldException
        at org.apache.hadoop.hbase.master.ServerManager.regionServerReport(ServerManager.java:201)
        at org.apache.hadoop.hbase.master.HMaster.regionServerReport(HMaster.java:604)
        at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:642)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:911)
2009-05-07 07:40:34,801 [IPC Server handler 9 on 60000] INFO org.apache.hadoop.ipc.HBaseServer: IPC Server handler 9 on 60000, call regionServerReport(address: 208.76.44.141:60021, startcode: 1241637114470, load: (requests=0, regions=466, usedHeap=862, maxHeap=1255), [Lorg.apache.hadoop.hbase.HMsg;@2fcd003b, [Lorg.apache.hadoop.hbase.HRegionInfo;@3bca3a01) from 208.76.44.141:5019
7: error: org.apache.hadoop.hbase.Leases$LeaseStillHeldException
org.apache.hadoop.hbase.Leases$LeaseStillHeldException
        at org.apache.hadoop.hbase.master.ServerManager.regionServerReport(ServerManager.java:201)
        at org.apache.hadoop.hbase.master.HMaster.regionServerReport(HMaster.java:604)
        at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:642)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:911)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Above repeats over and over.&lt;/p&gt;</comment>
                            <comment id="12707103" author="ryanobjc" created="Thu, 7 May 2009 21:01:35 +0000"  >&lt;p&gt;I see this as well, once my cluster gets under load this can happen on a regular basis.&lt;/p&gt;
</comment>
                            <comment id="12707482" author="nitay" created="Fri, 8 May 2009 19:22:03 +0000"  >&lt;p&gt;Here&apos;s what I&apos;ve got so far.&lt;/p&gt;

&lt;p&gt;In this patch:&lt;/p&gt;

&lt;p&gt;ZooKeeper is the ground state of truth, so if we lose our connection to it,&lt;br/&gt;
then everyone thinks we&apos;re gone. So, we should act as such, which means&lt;br/&gt;
aborting and restarting.&lt;/p&gt;

&lt;p&gt;I moved all of the state that has to be reinitialized into a new reinitialize()&lt;br/&gt;
method that is called by the constructor and my retart() method. It&apos;s rather&lt;br/&gt;
unfortunate that most of the things ended up moving into here (you can&apos;t call&lt;br/&gt;
run() on threads twice), so a lot of stuff is not final anymore.&lt;/p&gt;

&lt;p&gt;I was seeing a problem with shutting down HDFS and starting it back up again,&lt;br/&gt;
so I added an AtomicBoolean to prevent the HDFS shutdown hook from running when&lt;br/&gt;
I restart.&lt;/p&gt;


&lt;p&gt;I think I am now seeing the problem reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1362&quot; title=&quot;.META. may not come back if regionserver crashes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1362&quot;&gt;&lt;del&gt;HBASE-1362&lt;/del&gt;&lt;/a&gt; when running the test in this patch.&lt;/p&gt;</comment>
                            <comment id="12707483" author="nitay" created="Fri, 8 May 2009 19:24:33 +0000"  >&lt;p&gt;Here&apos;s a dump of running the test.&lt;/p&gt;</comment>
                            <comment id="12707826" author="apurtell" created="Sun, 10 May 2009 18:45:11 +0000"  >&lt;p&gt;This and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1315&quot; title=&quot;when HRS znode expires while HRS is still running, HRS enters infinite loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1315&quot;&gt;&lt;del&gt;HBASE-1315&lt;/del&gt;&lt;/a&gt; are the only evident cause of instability on my test cluster. Raising priority to blocker.&lt;/p&gt;</comment>
                            <comment id="12707853" author="nitay" created="Sun, 10 May 2009 23:06:14 +0000"  >&lt;p&gt;Andrew, can you try the patch I posted? The test fails, because of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1362&quot; title=&quot;.META. may not come back if regionserver crashes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1362&quot;&gt;&lt;del&gt;HBASE-1362&lt;/del&gt;&lt;/a&gt;, as I mentioned. It should work otherwise though. It&apos;d be nice to have some real cluster testing of it.&lt;/p&gt;</comment>
                            <comment id="12707859" author="apurtell" created="Mon, 11 May 2009 00:54:04 +0000"  >&lt;p&gt;Testing now.&lt;/p&gt;</comment>
                            <comment id="12707902" author="nitay" created="Mon, 11 May 2009 06:25:48 +0000"  >&lt;p&gt;Updated patch with working test. I think this should fix &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1362&quot; title=&quot;.META. may not come back if regionserver crashes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1362&quot;&gt;&lt;del&gt;HBASE-1362&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;

&lt;p&gt;Here is a snippet from Stack describing the proposed fix to the problem:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It looks like RootScanner notices that server is null on the .META. row because it says that .META. region is not valid.  This should mean this is called:&lt;/p&gt;

&lt;p&gt;        this.master.regionManager.setUnassigned(info, true);&lt;/p&gt;

&lt;p&gt;Line 391 of BaseScanner (run by RootScanner)&lt;/p&gt;

&lt;p&gt;That should get it reassigned.... sometime.... in fact from your log, it does get assigned later...&lt;/p&gt;

&lt;p&gt; 2009-05-09 15:22:19,261 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;IPC Server handler 1 on 60000&amp;#93;&lt;/span&gt; master.RegionManager(319): Assigning region .META.,,1 to localhost_1241907737069_52172&lt;/p&gt;


&lt;p&gt;So, I think you need to get the metaTableAvailable thing to trigger.  Perhaps do the compare of the numbers but also check if the region is in transition... regionIsInTransition in RegionManager.  You can get the param to pass by doing Bytes.toString on the MetaRegion name. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In my new RegionManager.metaRegionsInTransition method:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does onlineMetaRegions need to be synchronized?&lt;/li&gt;
	&lt;li&gt;Does regionIsInTransition need to be synchronized?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I was following what I saw in other places that use those data structures, but I&apos;m not clear on why one is synchronized yet not the other.&lt;/p&gt;</comment>
                            <comment id="12707909" author="stack" created="Mon, 11 May 2009 06:47:00 +0000"  >&lt;p&gt;Nitay, should HRS host a thread that does all the work?  Then when it dies or when you need to restart, we just wait on old one to die then create a new one?&lt;/p&gt;</comment>
                            <comment id="12708118" author="nitay" created="Mon, 11 May 2009 17:26:30 +0000"  >&lt;p&gt;Yes, that&apos;s probably a good idea as we can then keep all the final modifiers. I&apos;ll work on this in a third version of the patch. Folks are welcome to test this patch out on their clusters though &amp;#8211; it should have all the logic necessary for the fix.&lt;/p&gt;</comment>
                            <comment id="12708161" author="stack" created="Mon, 11 May 2009 19:21:52 +0000"  >&lt;p&gt;See RegionServerThread in LocalHBaseCluster.  Might be of help (This wraps HRS in a Thread whereas you want to put thread inside HRS &amp;#8211; but might help some)?&lt;/p&gt;</comment>
                            <comment id="12708164" author="stack" created="Mon, 11 May 2009 19:25:38 +0000"  >&lt;p&gt;Current patch looks good.&lt;/p&gt;</comment>
                            <comment id="12708197" author="stack" created="Mon, 11 May 2009 20:23:01 +0000"  >&lt;p&gt;Committed.  Nitay opening separate issue to refactor HRS.  Thanks for the patch Nitay.&lt;/p&gt;</comment>
                            <comment id="12708200" author="nitay" created="Mon, 11 May 2009 20:27:36 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1406&quot; title=&quot;Refactor HRS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1406&quot;&gt;&lt;del&gt;HBASE-1406&lt;/del&gt;&lt;/a&gt; for refactoring HRS issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12422270">HBASE-1315</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12404852" name="dumb-wrapper-hack.patch" size="12486" author="apurtell" created="Tue, 7 Apr 2009 17:22:28 +0000"/>
                            <attachment id="12407652" name="dump.txt" size="755084" author="nitay" created="Fri, 8 May 2009 19:24:33 +0000"/>
                            <attachment id="12407746" name="hbase-1311-v2.patch" size="16243" author="nitay" created="Mon, 11 May 2009 06:25:48 +0000"/>
                            <attachment id="12407651" name="hbase-1311.patch" size="13322" author="nitay" created="Fri, 8 May 2009 19:22:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 5 Apr 2009 19:49:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25680</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hciv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99291</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>