<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:01:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-644/HBASE-644.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-644] DroppedSnapshotException but RegionServer doesn&apos;t restart</title>
                <link>https://issues.apache.org/jira/browse/HBASE-644</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;RegionServer was carrying &lt;del&gt;ROOT&lt;/del&gt; and having trouble writing HDFS.  RegionServer judged that a flush failed and reported a DroppedSnapshotException.  Usually, the filesystem check would fail and set all the abort flags but it in this case filesystem somehow returned healthy and the flags were not set.  The code path shutdown the RPC only and exited then we exited the Flusher.  All the rest of the RegionServer stayed up and kept reporting the master.  The master thought it alive and kept trying to scan the unreachable &lt;del&gt;ROOT&lt;/del&gt;.  Cluster was hosed until manual intervention 20 minutes later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12396783">HBASE-644</key>
            <summary>DroppedSnapshotException but RegionServer doesn&apos;t restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Sun, 25 May 2008 20:13:46 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:16 +0000</updated>
                            <resolved>Tue, 27 May 2008 04:18:23 +0000</resolved>
                                                    <fixVersion>0.1.3</fixVersion>
                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12599715" author="stack" created="Sun, 25 May 2008 20:33:48 +0000"  >&lt;p&gt;Fixed javadoc on flushRegion (returning false, we actually exit the Flusher thread).&lt;/p&gt;

&lt;p&gt;Changed the logic in the DroppedSnapshotException  Depended on the filesystem check coming back bad.   If it didn&apos;t, then, we only shutdown the RPC server, not the region server.&lt;/p&gt;

&lt;p&gt;Then removed duplicated code that set the abort and stop flag and called abort instead (Is there a reason we don&apos;t do this?).&lt;/p&gt;</comment>
                            <comment id="12599717" author="stack" created="Sun, 25 May 2008 20:39:15 +0000"  >&lt;p&gt;Here is illustration of the hang from Daniel&apos;s logs up on EC2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-05-19 15:26:17,985 INFO org.apache.hadoop.hbase.HRegion: Blocking updates &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &apos;IPC Server handler 8 on 60020&apos;: Memcache size 64.0m is &amp;gt;= than blocking 64.0m size
2008-05-19 15:26:34,556 INFO org.apache.hadoop.dfs.DFSClient: Exception in createBlockOutputStream java.net.SocketTimeoutException: Read timed out
2008-05-19 15:26:34,558 INFO org.apache.hadoop.dfs.DFSClient: Abandoning block blk_4812312891610152736
2008-05-19 15:26:34,562 INFO org.apache.hadoop.dfs.DFSClient: Waiting to find target node: 10.254.26.31:50010
2008-05-19 15:26:40,567 WARN org.apache.hadoop.dfs.DFSClient: DataStreamer Exception: java.io.IOException: Unable to create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; block.
2008-05-19 15:26:40,567 WARN org.apache.hadoop.dfs.DFSClient: Error Recovery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; block blk_4812312891610152736 bad datanode[0]
2008-05-19 15:26:40,567 FATAL org.apache.hadoop.hbase.HRegionServer: Replay of hlog required. Forcing server restart
org.apache.hadoop.hbase.DroppedSnapshotException: Could not get block locations. Aborting...
    at org.apache.hadoop.hbase.HRegion.internalFlushcache(HRegion.java:1115)
    at org.apache.hadoop.hbase.HRegion.flushcache(HRegion.java:1020)
    at org.apache.hadoop.hbase.HRegionServer$Flusher.flushRegion(HRegionServer.java:447)
    at org.apache.hadoop.hbase.HRegionServer$Flusher.run(HRegionServer.java:390)
2008-05-19 15:26:40,573 INFO org.apache.hadoop.ipc.Server: Stopping server on 60020
2008-05-19 15:26:40,573 INFO org.apache.hadoop.ipc.Server: Stopping IPC Server listener on 60020
2008-05-19 15:26:40,574 INFO org.apache.hadoop.ipc.Server: Stopping IPC Server Responder
2008-05-19 15:26:40,574 INFO org.apache.hadoop.hbase.HRegionServer: regionserver/0.0.0.0:60020.cacheFlusher exiting
..
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Above, we see the decision in Flusher to restart but notice that there is no (&quot;Shutting down HRegionServer: file system not available&quot; message from checkFilesystem.  There is the shutdown of the RPC.&lt;/p&gt;

&lt;p&gt;The regionserver stays like until there is human intervention 20 minutes later.  We even try a compaction while we&apos;re in this state.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-05-19 15:28:11,609 ERROR org.apache.hadoop.hbase.HRegionServer: Compaction failed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region categories,,1210801647493
java.io.IOException: Could not get block locations. Aborting...
    at org.apache.hadoop.dfs.DFSClient$DFSOutputStream.processDatanodeError(DFSClient.java:1832)
    at org.apache.hadoop.dfs.DFSClient$DFSOutputStream.access$1100(DFSClient.java:1487)
    at org.apache.hadoop.dfs.DFSClient$DFSOutputStream$DataStreamer.run(DFSClient.java:1579)
2008-05-19 15:28:11,614 INFO org.apache.hadoop.hbase.HRegion: checking compaction on region categories,2864153,1211005494348
2008-05-19 15:28:11,619 DEBUG org.apache.hadoop.hbase.HStore: started compaction of 26 files [1060231198/parent_categories/598305439430938634, 1060231198/parent_categories/4425107540345282973, 1060231198/parent_categories/1614092432458686638, 1060231198/parent_categories/2207075305093635923, 1060231198/parent_categories/4896580642418276150, 1060231198/parent_categories/3771164238635045810, 1060231198/parent_categories/8367575636975706877, 1060231198/parent_categories/563936161407142553, 1060231198/parent_categories/7201129332580659551, 1060231198/parent_categories/6504265075252363889, 1060231198/parent_categories/6507030234222769907, 1060231198/parent_categories/681881762013309210, 1060231198/parent_categories/178568648155148325, 1060231198/parent_categories/4045949900443465272, 1060231198/parent_categories/3620331467236868822, 1060231198/parent_categories/1171065084128878397, 1060231198/parent_categories/5412012975309666204, 1060231198/parent_categories/3257536290236063841, 1060231198/parent_categories/8332496624429761938, 1060231198/parent_categories/4487341413361548197, 1060231198/parent_categories/3927839157823465388, 1060231198/parent_categories/3727860104887831904, 1060231198/parent_categories/4427275327985154943, 1060231198/parent_categories/6572980649594273108, 1060231198/parent_categories/3726725692879501830, 1060231198/parent_categories/7261722476991845495] into /hbase/categories/compaction.dir/1060231198/parent_categories/mapfiles/5850576708252468402
2008-05-19 15:47:30,471 INFO org.apache.hadoop.hbase.HRegionServer: Got quiesce server message
..
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12599719" author="stack" created="Sun, 25 May 2008 20:40:43 +0000"  >&lt;p&gt;Renamed patch to make it obvious that its for the 0.1 branch (If a 0.1.3, this should be in it).&lt;/p&gt;</comment>
                            <comment id="12599720" author="stack" created="Sun, 25 May 2008 20:41:07 +0000"  >&lt;p&gt;Looking for review...&lt;/p&gt;</comment>
                            <comment id="12599744" author="jimk" created="Mon, 26 May 2008 02:39:45 +0000"  >&lt;p&gt;hbase-env.sh : should JAVA_HOME really default to /usr ?&lt;/p&gt;

&lt;p&gt;HRegionServer: &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;checkFileSystem does call abort() if the file system is not available&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;why Flusher called server.stop instead of abort is kinda strange though&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;sometimes I think abort() is not called because it is synchronized and there might be a possibility of deadlock in the shutdown process.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the case of trunk, server.stop() refers to the HRegionServer and not the RPC server, so this is ok. Definately not ok for 0.1 branch.&lt;/p&gt;</comment>
                            <comment id="12599909" author="stack" created="Mon, 26 May 2008 20:00:15 +0000"  >&lt;p&gt;Thanks for review from vacation Jim.&lt;/p&gt;

&lt;p&gt;(hbase-env.sh edit was not supposed to be included.  Thanks)&lt;/p&gt;

&lt;p&gt;This patch adds checkFileSystem calling abort.  Previous it just set the abort and stop flags.&lt;/p&gt;

&lt;p&gt;You point out that the server.stop in trunk refers to a different &apos;server&apos;.  You think this issue was introduced by a backport then (Blame says was added in revision 651067, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-572&quot; title=&quot;Backport HBASE-512 to 0.1 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-572&quot;&gt;&lt;del&gt;HBASE-572&lt;/del&gt;&lt;/a&gt;)?&lt;/p&gt;

&lt;p&gt;Yeah, I think we thought that there could be possibility of deadlock but on review, seems like only lock on the HRS Thread is in the sleeper so it can call Thread.sleep so seems safe to call abort from anywhere (Unless you can remember or point to a deadlock).  Version two narrows the synchronizes (don&apos;t need to sync abort for instance).&lt;/p&gt;

&lt;p&gt;Let me know if I can commit.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12599921" author="jimk" created="Mon, 26 May 2008 21:09:54 +0000"  >&lt;p&gt;New patch looks good. +1&lt;/p&gt;</comment>
                            <comment id="12599956" author="stack" created="Tue, 27 May 2008 04:18:23 +0000"  >&lt;p&gt;Resolving.  Committed branch and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12382740" name="644-0.1-v1.patch" size="3103" author="stack" created="Sun, 25 May 2008 20:40:43 +0000"/>
                            <attachment id="12382800" name="644-0.1-v2.patch" size="3173" author="stack" created="Mon, 26 May 2008 20:00:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 26 May 2008 02:39:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25309</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h8kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>