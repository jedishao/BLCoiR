<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 18:39:22 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-627/HBASE-627.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-627] Disable table doesn&apos;t work reliably</title>
                <link>https://issues.apache.org/jira/browse/HBASE-627</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When creating a couple of tables like this:&lt;br/&gt;
1) create an empty table&lt;br/&gt;
2) disable table, add new column family, enable table&lt;br/&gt;
3) put 100 small documents into newly created column&lt;br/&gt;
around once in 10 tries the disable doesn&apos;t happen.&lt;/p&gt;

&lt;p&gt;I have no clue as to why the table isn&apos;t disabled in the first place, but if this occurs, two things in HBaseAdmin.disableTable() strike me as odd:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;after numRetries tries to wait for disabling we exit the loop; there is no exception or error message:&lt;br/&gt;
...&lt;br/&gt;
2008-05-14 16:19:47,903 INFO org.apache.hadoop.hbase.client.HBaseAdmin: Disabled table table31&lt;br/&gt;
2008-05-14 16:19:47,910 INFO org.apache.hadoop.ipc.Server: IPC Server handler 3 on 60000, call addColumn(table31, 
{name: document, max versions: 3, compression: NONE, in memory: false, block cache enabled: false, max length: 2147483647, time to live: FOREVER, bloom filter: none}
&lt;p&gt;) from XXX.XX.40.36:47116: error: org.apache.hadoop.hbase.TableNotDisabledException: table31&lt;br/&gt;
...&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the scanner iterates over HRegionInfos of several tables. If any one of those is disabled, we also leave the loop as if the requested table had been disabled.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve had this disabling problem occur quite reliably over the last days - today I couldn&apos;t reproduce it, though HBase version hasn&apos;t changed. ???&lt;/p&gt;</description>
                <environment>&lt;p&gt;Hadoop/HBase on two nodes&lt;/p&gt;</environment>
        <key id="12396088">HBASE-627</key>
            <summary>Disable table doesn&apos;t work reliably</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jimk">Jim Kellerman</assignee>
                                    <reporter username="mbu">Michaela Buergle</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 May 2008 09:58:56 +0000</created>
                <updated>Tue, 29 Nov 2011 19:50:10 +0000</updated>
                            <resolved>Sat, 28 Jun 2008 02:45:43 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12597081" author="mbu" created="Thu, 15 May 2008 10:42:17 +0000"  >&lt;p&gt;This is the log output for table31, one of the tables for which disable didn&apos;t work.&lt;br/&gt;
I&apos;ve noticed that this table&apos;s region was added to the kill list of node2, but had previously been reassigned to node1 and was opened there shortly afterwards. This does look like a timing problem with load balancing.&lt;/p&gt;</comment>
                            <comment id="12597129" author="mbu" created="Thu, 15 May 2008 13:19:33 +0000"  >&lt;p&gt;I&apos;ve attached another case. Here table5 is being reassigned to the same server (see disableTable5.log). In the log I find:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RegionManager: Going to close region table5,,1210232134304&lt;/li&gt;
	&lt;li&gt;ServerManager: Received MSG_REPORT_CLOSE : table5&lt;/li&gt;
	&lt;li&gt;TableOperation: adding region table5,,1210232134304 to kill list&lt;/li&gt;
	&lt;li&gt;ServerManager: Received MSG_REPORT_OPEN : table5&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From now on the RegionManager says: &quot;Skipping region table5,,1210232134304 because it is already closing.&quot; when selecting regions for reassignment.&lt;br/&gt;
And in HBaseAdmin.disableTable, we are &quot;Waiting for first region to be disabled from table5&quot;.&lt;/p&gt;</comment>
                            <comment id="12597201" author="jimk" created="Thu, 15 May 2008 17:16:03 +0000"  >&lt;p&gt;Are you sure you have updated trunk past the patch for this issue? The same patch was applied to both trunk and branch, so it should work &lt;b&gt;provided&lt;/b&gt; region assignment is not oscillating. If region assignment is oscillating, enable/disable do not work reliably, and probably won&apos;t until we fix that problem.&lt;/p&gt;</comment>
                            <comment id="12597911" author="mbu" created="Mon, 19 May 2008 10:07:26 +0000"  >&lt;p&gt;Yes, I am sure I&apos;ve updated. I can still observe the behaviour described above.&lt;/p&gt;

&lt;p&gt;I did read in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-615&quot; title=&quot;Region balancer oscillates during cluster startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-615&quot;&gt;&lt;del&gt;HBASE-615&lt;/del&gt;&lt;/a&gt; that there might be some oscillation due to balancing but the fact that this oscillation affects enabling/disabling of tables has not been mentioned to my knowledge.&lt;br/&gt;
In my case, I wouldn&apos;t speak of oscillation though. Often it is just one region being assigned to the other one of my two nodes, which is certainly not unusual after having created a table. After all this is what the balancing is about. Still this reassignment and the more or less simultaneous disabling don&apos;t seem to go together well.&lt;/p&gt;</comment>
                            <comment id="12597984" author="mbu" created="Mon, 19 May 2008 15:49:56 +0000"  >&lt;p&gt;Some debugging later I now have a clearer idea of what&apos;s happening after ServerManager, in his load balancing activities, receives MSG_REPORT_CLOSE for region xy from node1:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RegionManager assigns region xy to node2 and sets it to &quot;unassigned&quot; (towards the end of assignRegionsToMultipleServers())&lt;/li&gt;
	&lt;li&gt;At this point, HBaseAdmin.disableTable is called; in .META., region xy still has info:server node1, region xy is marked as beingServed by node1 in ProcessTableOperation.call() and thus added to the local kill list of node1&lt;/li&gt;
	&lt;li&gt;Now we wait for region xy to go offline. But in the meantime, region xy opens on node2. .META. changes, region xy now has info:server node2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So there is a short period during which the information in .META. is not consistent with the actual state of regions. But disableTable() relies on the information found in .META. How could this best be solved? It looks like quite a fundamental problem to me.&lt;/p&gt;</comment>
                            <comment id="12597999" author="stack" created="Mon, 19 May 2008 16:54:19 +0000"  >&lt;p&gt;Thanks for digging in Michaela.&lt;/p&gt;

&lt;p&gt;Yeah, its a fundamental issue somewhat recognized in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt;.  I think &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt; needs to do more than make state changes atomic; it should also add logic that would prevent or intercept nonsensical transitions (e.g., from above, allowing an offlined table go online).&lt;/p&gt;</comment>
                            <comment id="12606845" author="jimk" created="Fri, 20 Jun 2008 18:03:30 +0000"  >&lt;p&gt;Now that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-615&quot; title=&quot;Region balancer oscillates during cluster startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-615&quot;&gt;&lt;del&gt;HBASE-615&lt;/del&gt;&lt;/a&gt; has been fixed and the master stabilizes on region assignments, disable table and enable table appear to work reliably.&lt;/p&gt;

&lt;p&gt;Remember that both enable and disable table run asychronously in the master so if you immediately follow either operation with with another, you may get table is not disabled or table is not enabled exceptions. &lt;/p&gt;

&lt;p&gt;In the shell, if you do enable table and immediately follow that with a disable table, some regions may still be on-line because they were in transition during the disable operation. Issuing a second disable table should disable the remaining on-line regions.&lt;/p&gt;

&lt;p&gt;From the API you can use HTable.isTableOnline or HTable.isTableOffline to determine a table&apos;s state. You can then wait in a loop for the operation to finish.&lt;/p&gt;

&lt;p&gt;We believe that these operations are now reliable.  Can you confirm?&lt;/p&gt;</comment>
                            <comment id="12607244" author="mbu" created="Mon, 23 Jun 2008 14:34:13 +0000"  >&lt;p&gt;In my setting, the disabling-problem described above doesn&apos;t seem to happen now as there is hardly any reassignment of regions anymore. So this measure certainly decreases the probability that the error will arise. I&apos;m not sure however that it really solves the issue, since the underlying problem was outdated information in .META., while &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-615&quot; title=&quot;Region balancer oscillates during cluster startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-615&quot;&gt;&lt;del&gt;HBASE-615&lt;/del&gt;&lt;/a&gt; affects only the conditions under which the problem occurrs. There might be other line-ups leading to this situation.&lt;/p&gt;

&lt;p&gt;Using HTable.isTableOnline/Offline in a loop is probably a good way to avoid the problem. A few remarks on that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The &quot;// Wait until first region is disabled&quot; - section in HBaseAdmin.disableTable() looks very similar. Wouldn&apos;t it make sense to use isTableOffline() here instead?&lt;/li&gt;
	&lt;li&gt;In both disableTable() and isTableOn-/Offline(), regions of other tables than the requested one are checked for being on-/offline (see Description of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-627&quot; title=&quot;Disable table doesn&amp;#39;t work reliably&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-627&quot;&gt;&lt;del&gt;HBASE-627&lt;/del&gt;&lt;/a&gt;). That doesn&apos;t seem right to me. If any one of those other regions is on-/offline by chance, there will be a wrong result.&lt;/li&gt;
	&lt;li&gt;Shouldn&apos;t a table be either online or offline? In that case, why are there two different functions for determining the table&apos;s state instead of using e.g. !isTableOnline().&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="12608326" author="jimk" created="Thu, 26 Jun 2008 08:01:07 +0000"  >&lt;p&gt;HConnection&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tableExists now throws MasterNotRunningException if instance is not on-line&lt;/li&gt;
	&lt;li&gt;added method isTableEnabled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;HConnectionManager&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tableExists, getRegionLocation, listTables, locateRegion, relocateRegion, getHRegionConnection, getRegionServerWithRetries now check to see if master is running&lt;/li&gt;
	&lt;li&gt;added method isTableEnabled&lt;/li&gt;
	&lt;li&gt;getHTableDescriptor now checks if table exists, uses ScannerCallable instead of HTable.getScanner&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;HBaseAdmin&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enableTable, disableTable are now synchronous and wait until entire table is enabled/disabled and use HConnection.isTableEnabled to make the check&lt;/li&gt;
	&lt;li&gt;added methods isTableEnabled(Text), isTableEnabled(String), isTableEnabled(byte[]). They use HConnection.isTableEnabled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;HTable&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;renamed isTableOnline methods to isTableEnabled, now use HConnection.isTableEnabled&lt;/li&gt;
	&lt;li&gt;removed isTableOffline methods since they are redundant&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12608327" author="jimk" created="Thu, 26 Jun 2008 08:02:22 +0000"  >&lt;p&gt;patch.txt should address remaining issues. All tests pass locally. Please review.&lt;/p&gt;</comment>
                            <comment id="12608803" author="stack" created="Fri, 27 Jun 2008 15:18:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-713&quot; title=&quot;Offlining/onlining table not reliable on branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-713&quot;&gt;&lt;del&gt;HBASE-713&lt;/del&gt;&lt;/a&gt; is about offliining/onlining not being reliiable on branch.  I got around the issue by writing a script that went through the regions that wouldn&apos;t offline individually offlining them.  I was then able to add my new column.  But I just noticed that the add column didn&apos;t apply to all regions, just to most.  Would suggest that this issue also cover this case; i.e. not just enabling/disabling but also guarantee that add/edit/delete of columns works too.&lt;/p&gt;</comment>
                            <comment id="12608864" author="jimk" created="Fri, 27 Jun 2008 17:54:41 +0000"  >&lt;p&gt;&amp;gt; stack - 27/Jun/08 08:18 AM&lt;br/&gt;
&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-713&quot; title=&quot;Offlining/onlining table not reliable on branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-713&quot;&gt;&lt;del&gt;HBASE-713&lt;/del&gt;&lt;/a&gt; is about offliining/onlining not being reliiable on branch. I got around the&lt;br/&gt;
&amp;gt; issue by writing a script that went through the regions that wouldn&apos;t offline individually&lt;br/&gt;
&amp;gt; offlining them. I was then able to add my new column. But I just noticed that the add&lt;br/&gt;
&amp;gt; column didn&apos;t apply to all regions, just to most. Would suggest that this issue also&lt;br/&gt;
&amp;gt; cover this case; i.e. not just enabling/disabling but also guarantee that&lt;br/&gt;
&amp;gt; add/edit/delete of columns works too. &lt;/p&gt;

&lt;p&gt;This is a bug in both column operations and table deletion.&lt;/p&gt;

&lt;p&gt;If they think a region is being served that region is not added to the list of regions to process.&lt;br/&gt;
Unfortunately, determination of whether a region is being served is imprecise, because it&lt;br/&gt;
is based on info:server and info:startcode matching a server that the master knows about.&lt;/p&gt;

&lt;p&gt;When a region is offlined, it should delete the server and startcode fields. Apparently sometimes, these fields are not deleted and those regions never get processed, even though the region info indicates the region is disabled.&lt;/p&gt;</comment>
                            <comment id="12608866" author="jimk" created="Fri, 27 Jun 2008 17:59:47 +0000"  >&lt;p&gt;Modifying TableOperation$ProcessTableOperation.call to insert the region into the unservedRegions list if it is not being served or is not enabled will fix this problem.&lt;/p&gt;</comment>
                            <comment id="12608867" author="jimk" created="Fri, 27 Jun 2008 18:00:31 +0000"  >&lt;p&gt;Make column operations and table deletion reliable&lt;/p&gt;</comment>
                            <comment id="12608871" author="jimk" created="Fri, 27 Jun 2008 18:07:50 +0000"  >&lt;p&gt;Added fix for reliable column operations and table deletion&lt;/p&gt;</comment>
                            <comment id="12608872" author="jimk" created="Fri, 27 Jun 2008 18:08:24 +0000"  >&lt;p&gt;New patch. Please review.&lt;/p&gt;</comment>
                            <comment id="12608904" author="jdcryans" created="Fri, 27 Jun 2008 20:14:12 +0000"  >&lt;p&gt;Passes test that it should. +1&lt;/p&gt;</comment>
                            <comment id="12608924" author="stack" created="Fri, 27 Jun 2008 21:47:23 +0000"  >&lt;p&gt;J-D: Did you review Jim&apos;s patch also?  If you have the time, do so.  Give it +/- 1 so Jim can (or cannot) commit.  Good stuff.&lt;/p&gt;</comment>
                            <comment id="12608926" author="jdcryans" created="Fri, 27 Jun 2008 21:52:54 +0000"  >&lt;p&gt;Yes, patch was reviewed. +1&lt;/p&gt;</comment>
                            <comment id="12608931" author="stack" created="Fri, 27 Jun 2008 21:58:56 +0000"  >&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="12608968" author="jimk" created="Sat, 28 Jun 2008 02:45:43 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13157516" author="erwin00776" created="Sat, 26 Nov 2011 15:15:11 +0000"  >&lt;p&gt;why this bug not fixed for deleteTable(...)?&lt;/p&gt;</comment>
                            <comment id="13159489" author="jdcryans" created="Tue, 29 Nov 2011 19:50:10 +0000"  >&lt;p&gt;@Erwin&lt;/p&gt;

&lt;p&gt;This jira was resolved 3 years ago, if you have an issue would you mind opening a new jira?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12395373">HBASE-615</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12389927">HBASE-478</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12399058">HBASE-713</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12382099" name="disableTable31.log" size="30633" author="mbu" created="Thu, 15 May 2008 10:42:17 +0000"/>
                            <attachment id="12382110" name="disableTable5.log" size="23854" author="mbu" created="Thu, 15 May 2008 13:19:33 +0000"/>
                            <attachment id="12384852" name="patch.txt" size="24100" author="jimk" created="Fri, 27 Jun 2008 18:07:50 +0000"/>
                            <attachment id="12384747" name="patch.txt" size="23485" author="jimk" created="Thu, 26 Jun 2008 08:01:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 May 2008 17:16:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25302</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h8gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>