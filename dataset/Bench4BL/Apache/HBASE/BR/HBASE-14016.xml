<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:05:46 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14016/HBASE-14016.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14016] Procedure V2: NPE in a delete table follow by create table closely</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14016</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In our internal test for HBASE 1.1, we found a race condition that delete table followed by create table closely would leak zk lock due to NPE in ProcedureFairRunQueues&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;ProcedureExecutorThread-0&quot; java.lang.NullPointerException
	at org.apache.hadoop.hbase.master.procedure.MasterProcedureQueue.releaseTableWrite(MasterProcedureQueue.java:279)
	at org.apache.hadoop.hbase.master.procedure.CreateTableProcedure.releaseLock(CreateTableProcedure.java:280)
	at org.apache.hadoop.hbase.master.procedure.CreateTableProcedure.releaseLock(CreateTableProcedure.java:58)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor.execLoop(ProcedureExecutor.java:674)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the code that cause the race condition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; markTableAsDeleted(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TableName table) {
    TableRunQueue queue = getRunQueue(table);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (queue != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        ...
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (queue.isEmpty() &amp;amp;&amp;amp; !queue.isLocked()) {
          fairq.remove(table);
    ...
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; tryWrite(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TableLockManager lockManager,
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TableName tableName, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; purpose) {
        ...
        tableLock = lockManager.writeLock(tableName, purpose);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          tableLock.acquire();
      ...
        wlock = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root cause is: wlock is set too late and not protect the queue be deleted.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Thread 1: create table is running; queue is empty - tryWrite() acquire the lock (now wlock is still false)&lt;/li&gt;
	&lt;li&gt;Thread 2: markTableAsDeleted see the queue empty and wlock= false&lt;/li&gt;
	&lt;li&gt;Thread 1: set wlock=true - too late&lt;/li&gt;
	&lt;li&gt;Thread 2: delete the queue&lt;/li&gt;
	&lt;li&gt;Thread 1: never able to release the lock - NPE trying to get queue&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12842476">HBASE-14016</key>
            <summary>Procedure V2: NPE in a delete table follow by create table closely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="syuanjiang">Stephen Yuan Jiang</assignee>
                                    <reporter username="syuanjiang">Stephen Yuan Jiang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Jul 2015 00:36:34 +0000</created>
                <updated>Fri, 3 Jul 2015 00:45:47 +0000</updated>
                            <resolved>Fri, 3 Jul 2015 00:45:47 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.2.0</version>
                    <version>1.1.1</version>
                    <version>1.3.0</version>
                                                    <component>proc-v2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14612715" author="syuanjiang" created="Fri, 3 Jul 2015 00:43:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt;  I think we should do something like the following: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; tryAcquireTableWrite(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TableName table, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; purpose) {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; lockAcquired = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    lock.lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    	lockAcquired = getRunQueueOrCreate(table).tryWrite(lockManager, table, purpose);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        lock.unlock();
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; lockAcquired;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14612718" author="mbertozzi" created="Fri, 3 Jul 2015 00:45:47 +0000"  >&lt;p&gt;sorry closing as duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14017&quot; title=&quot;Procedure v2 - MasterProcedureQueue fix concurrency issue on table queue deletion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14017&quot;&gt;&lt;del&gt;HBASE-14017&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
(we don&apos;t need a full lock)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Jul 2015 00:45:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gtgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>