<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:32:05 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14476/HBASE-14476.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14476] ReplicationQueuesZKImpl#copyQueuesFromRSUsingMulti will fail if there are orphaned queues under dead region server</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14476</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;ReplicationQueuesZKImpl#copyQueuesFromRSUsingMulti won&apos;t move the orphaned queues under dead region server(&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12769&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-12769&lt;/a&gt; describes situations orphaned queues tend to happen):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!peerExists(replicationQueueInfo.getPeerId())) {
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Peer &quot;&lt;/span&gt; + peerId + &lt;span class=&quot;code-quote&quot;&gt;&quot; didn&apos;t exist, skipping the replay&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-comment&quot;&gt;// Protection against moving orphaned queues
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After processing all the queues, the rsNode of dead region server will also be deleted:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// add delete op &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; dead rs, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will update the cversion of the parent.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// The reader will make optimistic locking with &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to get a consistent
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// snapshot
&lt;/span&gt;      listOfOps.add(ZKUtilOp.deleteNodeFailSilent(deadRSZnodePath));
      ...
      ZKUtil.multiOrSequential(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zookeeper, listOfOps, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;If there are orphaned queues, the rsNode of dead region server is not empty, so that the whole multi zookeeper operation will fail:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-09-23 20:17:55,170 WARN  [ReplicationExecutor-0] replication.ReplicationQueuesZKImpl: Got exception in copyQueuesFromRSUsingMulti:
org.apache.zookeeper.KeeperException$NotEmptyException: KeeperErrorCode = Directory not empty
  at org.apache.zookeeper.KeeperException.create(KeeperException.java:125)
  at org.apache.zookeeper.ZooKeeper.multiInternal(ZooKeeper.java:949)
  at org.apache.zookeeper.ZooKeeper.multi(ZooKeeper.java:915)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This fail will make the normal queues under the dead region server can not be transferred if any orphaned queue exist. &lt;br/&gt;
In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12865&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-12865&lt;/a&gt;, ReplicationLogCleaner will depend the cversion change of rsNode parent to clean the WALs. Therefore, a possible solution is also transferring orphaned queues from dead region server. These orphaned queues will be skipped in ReplicationSourceManager$NodeFailoverWorker#run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            peerConfig = replicationPeers.getReplicationPeerConfig(actualPeerId);
          } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ReplicationException ex) {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; getting replication peer config, skipping replay&quot;&lt;/span&gt;
                + ex);
          }
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (peer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || peerConfig == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Skipping failover &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; peer:&quot;&lt;/span&gt; + actualPeerId + &lt;span class=&quot;code-quote&quot;&gt;&quot; of node&quot;&lt;/span&gt; + rsZnode);
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will make the orphaned queues also be kept in zookeeper with the queue name containing the transfer histories(waiting for manual operation), and the normal queues under the dead region server can also be processed. Suggestion and discussion are welcomed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12895990">HBASE-14476</key>
            <summary>ReplicationQueuesZKImpl#copyQueuesFromRSUsingMulti will fail if there are orphaned queues under dead region server</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cuijianwei">Jianwei Cui</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Sep 2015 02:28:02 +0000</created>
                <updated>Fri, 22 Jul 2016 05:50:38 +0000</updated>
                            <resolved>Fri, 22 Jul 2016 05:50:38 +0000</resolved>
                                    <version>2.0.0</version>
                                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="14971948" author="apurtell" created="Fri, 23 Oct 2015 21:59:15 +0000"  >&lt;p&gt;I think you can take the lack of comment as initial agreement and interest in seeing a patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cuijianwei&quot; class=&quot;user-hover&quot; rel=&quot;cuijianwei&quot;&gt;Jianwei Cui&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14975979" author="cuijianwei" created="Tue, 27 Oct 2015 08:24:33 +0000"  >&lt;p&gt;Thanks for your remind &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15388964" author="apache9" created="Fri, 22 Jul 2016 05:50:38 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16135&quot; title=&quot;PeerClusterZnode under rs of removed peer may never be deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16135&quot;&gt;&lt;del&gt;HBASE-16135&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12984318">HBASE-16135</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12768928" name="HBASE-14476-trunk-v1.patch" size="1352" author="cuijianwei" created="Tue, 27 Oct 2015 08:23:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 23 Oct 2015 21:59:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2lhtb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>