<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:57:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1928/HBASE-1928.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1928] ROOT and META tables stay in transition state (making the system not usable) if the designated regionServer dies before the assignment is complete</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1928</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During a ROOT or META table re-assignment if the designated regionServer dies before the assignment is complete then the whole cluster becomes unavailble since the ROOT or META tables cannot be accessed (and never recover since they are kept in a transition state).&lt;/p&gt;

&lt;p&gt;These are the 4 steps to replicate this issue (this is the easiest way to replicate. You can imagine that the following can occur in any real system).&lt;/p&gt;

&lt;p&gt;Pre condition&lt;br/&gt;
============&lt;br/&gt;
1. a cluster of 3 nodes (cache01, cache02, search01).&lt;br/&gt;
2. start the system (start-hbase)&lt;br/&gt;
3. cache02 has META, search01 has ROOT, cache01 has regionServer and Master.&lt;/p&gt;

&lt;p&gt;Case 1:&lt;br/&gt;
=======&lt;br/&gt;
1. kill cache01&lt;br/&gt;
2. kill cache02&lt;br/&gt;
3. now search01 has both ROOT and META.&lt;br/&gt;
4. re-start RegionServers on cache01 and cache02&lt;br/&gt;
5. Tail the master logs and grep for &quot;Assigning region &lt;del&gt;ROOT&lt;/del&gt;&quot; and also &quot;Assigning region .META.&quot; (need to windows for easiness)&lt;br/&gt;
6. kill search01&lt;br/&gt;
7. wait to see to which server the ROOT will be assigned (from the tail)&lt;br/&gt;
8. quickly kill that server&lt;br/&gt;
9. you should notice that the ROOT server never gets re-assigned (because it is stuck in the regionsInTransitions)&lt;/p&gt;

&lt;p&gt;The termination occurs through the ServerManager::removeServerInfo since the regionServer sends back to the master in a report that it is shutting down.&lt;/p&gt;

&lt;p&gt;Case 2:&lt;br/&gt;
========&lt;br/&gt;
Repeat Case1 and in step 7 and 8 kill the server that has the META region assigned to it. Again the cluster becomes unavailble because the META region stays in the regionsInTransitions.&lt;br/&gt;
The termination occurs through the ServerManager::removeServerInfo since the regionServer sends back to the master in a report that it is shutting down.&lt;/p&gt;

&lt;p&gt;Case 3:&lt;br/&gt;
========&lt;br/&gt;
Repeat Case1 and in step 7 and 8 kill the server with kill -9 instead of kill. This will not give the opportunity to the regionServer to send back the master in the report that it is terminating. The master will realize this because the znode will expire (but it is a different code path from before - it goes to the ProcessServerShutdown).&lt;/p&gt;

&lt;p&gt;Case 4:&lt;br/&gt;
========&lt;br/&gt;
Repeat Case3 and in step 7 and 8 kill the server with kill -9 instead of kill. This will not give the opportunity to the regionServer to send back the master in the report that it is terminating. The master will realize this because the znode will expire (but it is a different code path from before - it goes to the ProcessServerShutdown).&lt;/p&gt;

&lt;p&gt;The solution would be to check the in the ServerManager:removeServerInfo and in  ProcessServerShutdown::closeMetaRegions whether the server that has been terminated has been assigned either the ROOT or META table. And if they have make sure we make those table ready to be re-assigned again.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12438825">HBASE-1928</key>
            <summary>ROOT and META tables stay in transition state (making the system not usable) if the designated regionServer dies before the assignment is complete</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ypavlidis">Yannis Pavlidis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Oct 2009 17:32:22 +0000</created>
                <updated>Fri, 12 Oct 2012 06:13:23 +0000</updated>
                            <resolved>Sat, 7 Nov 2009 23:43:24 +0000</resolved>
                                    <version>0.20.0</version>
                    <version>0.20.1</version>
                                    <fixVersion>0.20.2</fixVersion>
                    <fixVersion>0.90.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12768773" author="ypavlidis" created="Thu, 22 Oct 2009 17:37:01 +0000"  >&lt;p&gt;The above situation occurred in our environment when:&lt;/p&gt;

&lt;p&gt;pre condition&lt;br/&gt;
===============&lt;br/&gt;
cache01 (is the backup master, runs a region server has the ROOT and META assigned to it)&lt;br/&gt;
cache02 (runs a region server)&lt;br/&gt;
search01 (runs the master and the region server)&lt;/p&gt;

&lt;p&gt;scenario&lt;br/&gt;
=========&lt;br/&gt;
kill the master on search01&lt;br/&gt;
the master on cache01 resumes master duties&lt;br/&gt;
cache01 encounters a fatal error (FATAL org.apache.hadoop.hbase.regionserver.LogRoller: Log rolling failed with ioe) and has to exit&lt;br/&gt;
The ROOT is getting re-assigned to the region server on search01 and the META is getting re-assigned to the region server on cache02.&lt;/p&gt;

&lt;p&gt;Now cache02 encounters the same fatal error (FATAL org.apache.hadoop.hbase.regionserver.LogRoller: Log rolling failed with ioe) and has to exit before it accepts the assignment for servicing the META region&lt;/p&gt;

&lt;p&gt;post condition&lt;br/&gt;
===============&lt;br/&gt;
While the root is assigned to search01 the meta appears to have been left in limbo state (still in regionsInTransitions map of the RegionManager). The issue I believe is because of a race condition.&lt;br/&gt;
The region server in cache02 never gets the chance to complete the assignment of the meta region. When cache01 realizes that cache02 has died in the ProcessServerShutdown it never checks to see whether the server that died had a meta region assigned to it in transition (isMetaServer method in the RegionManager checks for that). The result of this is that when my client connects it gets the cache02 address for the meta server and of course it keeps failing to connect.&lt;/p&gt;

&lt;p&gt;I have attached the logs for this scenario. Because of course it is difficult to replicate the above case please follow the steps on the first comment to simulate this problem with ROOT / META.&lt;/p&gt;</comment>
                            <comment id="12768775" author="ypavlidis" created="Thu, 22 Oct 2009 17:39:30 +0000"  >&lt;p&gt;Master indicates that is not assigned to any server&lt;br/&gt;
Cache01 terminates&lt;br/&gt;
Cache02 gets the assignment for the META region but never completes it.&lt;/p&gt;</comment>
                            <comment id="12768799" author="ypavlidis" created="Thu, 22 Oct 2009 18:16:01 +0000"  >&lt;p&gt;stack.&lt;/p&gt;

&lt;p&gt;I am re-assigning this too for further testing and approval. &lt;/p&gt;

&lt;p&gt;I performed all the tests described in the first comments without the patches to replicate the issue and then performed the same steps with the patches and everything worked as expected (at the end ROOT and META were assigned to a regionServer).&lt;/p&gt;

&lt;p&gt;Thanks in advance,&lt;/p&gt;

&lt;p&gt;Yannis.&lt;/p&gt;</comment>
                            <comment id="12769005" author="stack" created="Fri, 23 Oct 2009 00:50:19 +0000"  >&lt;p&gt;Thanks Yannis for all the digging in.  Will include in 0.20.2.  Will apply soon.&lt;/p&gt;</comment>
                            <comment id="12772738" author="jdcryans" created="Mon, 2 Nov 2009 22:58:28 +0000"  >&lt;p&gt;Yannis,&lt;/p&gt;

&lt;p&gt;Could you rebase your patches on the latest trunk? &lt;/p&gt;

&lt;p&gt;Also you could make a single patch for all 3 files? Simply issue a &quot;svn diff src/ &amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1928&quot; title=&quot;ROOT and META tables stay in transition state (making the system not usable) if the designated regionServer dies before the assignment is complete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1928&quot;&gt;&lt;del&gt;HBASE-1928&lt;/del&gt;&lt;/a&gt;.patch&quot; from HBase&apos;s base folder. &lt;/p&gt;

&lt;p&gt;Finally please make sure that your lines aren&apos;t longer than 80 chars. &lt;/p&gt;

&lt;p&gt;Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="12774389" author="ypavlidis" created="Fri, 6 Nov 2009 20:00:31 +0000"  >&lt;p&gt;Hey Jean-Daniel,&lt;/p&gt;

&lt;p&gt;I just posted the info you requested. Let me know if you have any questions.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Yannis.&lt;/p&gt;</comment>
                            <comment id="12774464" author="stack" created="Fri, 6 Nov 2009 22:43:12 +0000"  >&lt;p&gt;Version of patch that works for 0.20.  I&apos;m running all tests now.&lt;/p&gt;</comment>
                            <comment id="12774687" author="stack" created="Sat, 7 Nov 2009 23:43:24 +0000"  >&lt;p&gt;Committed branch and trunk.  Thank you for the patch Yannis (Passes all tests locally).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12424235" name="1928-branch.patch" size="4405" author="stack" created="Fri, 6 Nov 2009 22:43:12 +0000"/>
                            <attachment id="12424222" name="HBASE-1928.patch" size="4676" author="ypavlidis" created="Fri, 6 Nov 2009 20:00:31 +0000"/>
                            <attachment id="12422923" name="diff_ProcessServerShutdown.txt" size="621" author="ypavlidis" created="Thu, 22 Oct 2009 18:14:16 +0000"/>
                            <attachment id="12422924" name="diff_RegionManager.txt" size="1392" author="ypavlidis" created="Thu, 22 Oct 2009 18:14:16 +0000"/>
                            <attachment id="12422925" name="diff_ServerManager.txt" size="602" author="ypavlidis" created="Thu, 22 Oct 2009 18:14:16 +0000"/>
                            <attachment id="12422911" name="master_cache01.txt" size="28940" author="ypavlidis" created="Thu, 22 Oct 2009 17:39:30 +0000"/>
                            <attachment id="12422912" name="region_cache01.txt" size="22930" author="ypavlidis" created="Thu, 22 Oct 2009 17:39:30 +0000"/>
                            <attachment id="12422913" name="region_cache02.txt" size="19635" author="ypavlidis" created="Thu, 22 Oct 2009 17:39:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 23 Oct 2009 00:50:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26068</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08s5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49163</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>