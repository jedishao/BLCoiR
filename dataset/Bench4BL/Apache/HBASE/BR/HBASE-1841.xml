<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:28:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1841/HBASE-1841.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1841] If multiple of same key in an hfile and they span blocks, may miss the earlier keys on a lookup</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1841</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1818&quot; title=&quot;HFile code review and refinement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1818&quot;&gt;&lt;del&gt;HBASE-1818&lt;/del&gt;&lt;/a&gt; for description by Schubert Zhang &amp;#8211; discovered by him doing a code review of hfile.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12435761">HBASE-1841</key>
            <summary>If multiple of same key in an hfile and they span blocks, may miss the earlier keys on a lookup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="schubertzhang">Schubert Zhang</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Sep 2009 20:54:44 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:17 +0000</updated>
                            <resolved>Fri, 13 Nov 2009 06:40:39 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12756912" author="schubertzhang" created="Fri, 18 Sep 2009 02:26:41 +0000"  >&lt;p&gt;The previous jira should be &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1818&quot; title=&quot;HFile code review and refinement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1818&quot;&gt;&lt;del&gt;HBASE-1818&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12776530" author="schubertzhang" created="Wed, 11 Nov 2009 17:35:05 +0000"  >&lt;p&gt;I am considering following two steps to fix this issue.&lt;/p&gt;

&lt;p&gt;Step-1: Light fix&lt;/p&gt;

&lt;p&gt;Modify the HFile.Writer to prevent generating a problem HFile which include duplicated keys which straddle block boundary.&lt;br/&gt;
This light fix can avoid read missing issue when there are just a small quantity of duplication.&lt;br/&gt;
This should be a temporary fix.&lt;br/&gt;
I will provide this patch soon.&lt;/p&gt;


&lt;p&gt;Step-2: Complete fix&lt;/p&gt;

&lt;p&gt;(1) Modify the block index to point to the last key. &lt;br/&gt;
(2) Modify the binary search to return the first item when duplicating.&lt;/p&gt;

&lt;p&gt;In fact, we can refer to the section 5.1 of the Google Bigtable paper.&lt;/p&gt;

&lt;p&gt;&quot;The METADATA table stores the location of a tablet under a row key that is an encoding of the tablet&apos;s table identifer and its end row.&quot;&lt;/p&gt;

&lt;p&gt;The theory of Bigtable&apos;s METADATA is same as the BlockIndex in a SSTable, so we should use EndKey in HFile&apos;s BlockIndex.&lt;/p&gt;

&lt;p&gt;In my experiences of Hypertable (I had detailedly researched the METADATA structure of Hypertable in year 2008), the METADATA is also &quot;tableID:endRow&quot;. &lt;/p&gt;

&lt;p&gt;This fix shall be complete and have many code changes, I will try to provide patch if I have time.&lt;/p&gt;</comment>
                            <comment id="12776535" author="stack" created="Wed, 11 Nov 2009 17:49:14 +0000"  >&lt;p&gt;Fix 2. sounds good Schubert.  We&apos;ve been toying with making such a change but shied from it near 0.20 release as too big a change.  It would require a rewrite of the .META. table and of the indices in all store files.  Don&apos;t worry about this part.  We can help w/ that.&lt;/p&gt;</comment>
                            <comment id="12776560" author="schubertzhang" created="Wed, 11 Nov 2009 18:20:20 +0000"  >&lt;p&gt;This patch is for setp-1 fix.&lt;br/&gt;
It allow some a small quantity of duplication (not bigger then one block size).&lt;/p&gt;</comment>
                            <comment id="12776664" author="schubertzhang" created="Wed, 11 Nov 2009 21:19:45 +0000"  >&lt;p&gt;This is the step2 patch.&lt;/p&gt;

&lt;p&gt;@stack, &lt;br/&gt;
Could you please have a review of this patch?&lt;br/&gt;
I just have a simple verfication of it, I don&apos;t know if it is ok for the .META. usage.&lt;/p&gt;</comment>
                            <comment id="12776671" author="schubertzhang" created="Wed, 11 Nov 2009 21:33:03 +0000"  >&lt;p&gt;I think maybe the range boundary schema would be changed with this new patch.&lt;/p&gt;

&lt;p&gt;old: [row10, row20) [row20, row30) [row30, ...)&lt;/p&gt;

&lt;p&gt;changed to:&lt;/p&gt;

&lt;p&gt;new:  (..., row20] (row20, row30] (row30, row40]&lt;/p&gt;</comment>
                            <comment id="12776679" author="stack" created="Wed, 11 Nov 2009 21:47:24 +0000"  >&lt;p&gt;Thanks for working on this Schubert.&lt;/p&gt;

&lt;p&gt;On the first patch, step 1, if key is same as last, do not make a new block.  AND if we keep getting the same key and current block is 2*blocksize, throw an exception?&lt;/p&gt;

&lt;p&gt;If so, I think you should just let the block run rather than throw an exception... let it grow.&lt;/p&gt;

&lt;p&gt;Also, does the keyComp have to be a data  member?  Can it be scoped within the key append perhaps passed into checkBlockBoundary?&lt;/p&gt;

&lt;p&gt;Review of second patch coming up....&lt;/p&gt;</comment>
                            <comment id="12776697" author="ryanobjc" created="Wed, 11 Nov 2009 22:36:00 +0000"  >&lt;p&gt;I dont think we want to be throwing exceptions like that during writing, we&apos;d be preventing flushing and compactions, the former potentially causing data loss in pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-265&quot; title=&quot;Revisit append&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-265&quot;&gt;&lt;del&gt;HDFS-265&lt;/del&gt;&lt;/a&gt;, and the latter wedging up a hbase install.&lt;/p&gt;

&lt;p&gt;As for the key order in the index, there were some calls that depended on the choice of the first key in the block to work, specifically &apos;seekBefore&apos;. By changing the block index, this call won&apos;t work anymore in all cases.  I should know, I started out with a &apos;last key&apos; block index, but had to switch to &apos;first key&apos; to make seekBefore work.&lt;/p&gt;</comment>
                            <comment id="12776699" author="ryanobjc" created="Wed, 11 Nov 2009 22:40:39 +0000"  >&lt;p&gt;My review of step1:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;dont throw that exception for reasons stated above. We are opening ourselves up to a hbase cluster that is unfixable.&lt;/li&gt;
	&lt;li&gt;using a member variable for keyComp isn&apos;t really ideal - the state doesn&apos;t last the length of the object (which is what that implies), and it very temporary. A boolean to the checkBlockBoundary(boolean sameKey) would be better.  Or why even call checkBlockBoundary if the key is the same?&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12776819" author="schubertzhang" created="Thu, 12 Nov 2009 03:39:41 +0000"  >&lt;p&gt;For step1: &lt;/p&gt;

&lt;p&gt;The patch is updated according to the comments.&lt;br/&gt;
I know there is a potential risk of Out-Of-Memory, when there are too many duplications of a key. This scenario will generate too big block and need many memory. But I know it is rare in HBase.&lt;/p&gt;</comment>
                            <comment id="12776828" author="stack" created="Thu, 12 Nov 2009 04:18:29 +0000"  >&lt;p&gt;+1 on patch.  Ryan, do you want to review?  Otherwise, I&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="12777184" author="schubertzhang" created="Thu, 12 Nov 2009 21:00:02 +0000"  >&lt;p&gt;new patch &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1841&quot; title=&quot;If multiple of same key in an hfile and they span blocks, may miss the earlier keys on a lookup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1841&quot;&gt;&lt;del&gt;HBASE-1841&lt;/del&gt;&lt;/a&gt;-step2-v2.patch for step2.&lt;/p&gt;

&lt;p&gt;Consider seekTo and seekBefore.&lt;/p&gt;</comment>
                            <comment id="12777189" author="stack" created="Thu, 12 Nov 2009 21:10:17 +0000"  >&lt;p&gt;Schubert:  I&apos;d suggest that you open a new issue for step2 since step1 patch addresses the immediate issue.  Good on you.&lt;/p&gt;</comment>
                            <comment id="12777391" author="stack" created="Fri, 13 Nov 2009 06:40:39 +0000"  >&lt;p&gt;Committed step1 to TRUNK.  Please open new issue for step2 Schubert (Thanks for the step1 patch).&lt;/p&gt;</comment>
                            <comment id="12777440" author="schubertzhang" created="Fri, 13 Nov 2009 10:42:44 +0000"  >&lt;p&gt;@ stack&lt;/p&gt;

&lt;p&gt;Thanks stack. A new issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1978&quot; title=&quot;Change the range/block index scheme from [start,end) to (start, end], and index range/block by endKey, specially in HFile&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1978&quot;&gt;HBASE-1978&lt;/a&gt; for the future patch.&lt;/p&gt;

&lt;p&gt;@ ryan and stack&lt;/p&gt;

&lt;p&gt;I think the &quot;seekBefore&quot; should not be reason to change lastKey indexing to firstKey indexing. &lt;br/&gt;
I my opinion, our major use cases are &quot;seek to a point, and scan next....&quot;, these use cases need lastKey indexing, i.e. (startKey, endKey] range/block scheme.&lt;br/&gt;
But the other scheme, i.e.  [startKey, endKey) range/block is more suited to &quot;seek to a point, and scan prev....&quot;.&lt;/p&gt;

&lt;p&gt;I think the Bigtable paper&apos;s describe is a good choice.&lt;/p&gt;</comment>
                            <comment id="12777819" author="schubertzhang" created="Sat, 14 Nov 2009 04:44:42 +0000"  >&lt;p&gt;Oh, I may be wrong, scan prev and scan next is not the reason.&lt;/p&gt;</comment>
                            <comment id="12778055" author="ryanobjc" created="Sun, 15 Nov 2009 05:44:46 +0000"  >&lt;p&gt;seekBefore() exists to implement &quot;getClosestRowBefore&quot; which is how the .META. lookup works.  This is how clients find which regionserver hosts which region.  Needless to say we want this to keep on working.&lt;/p&gt;

&lt;p&gt;It might be possible to change how META works, to use first key of the region, but that requires a huge patch to touch nearly every part of hbase in one go, including all the tests. In fact you might have to accentuate the tests substantially, since what we have works now, and the change might do who knows what.&lt;/p&gt;

&lt;p&gt;Bigtable paper aside, what we have now works, and doesn&apos;t present any specific problems other than the ideologically purity of adhering to exactly what Google did.&lt;/p&gt;</comment>
                            <comment id="13232632" author="schubertzhang" created="Mon, 19 Mar 2012 14:26:29 +0000"  >&lt;p&gt;Thank you ryan, I think it is a open talk for tech.&lt;br/&gt;
It seems it&apos;s really a big work to refine &lt;span class=&quot;error&quot;&gt;&amp;#91;) to (&amp;#93;&lt;/span&gt;. &lt;/p&gt;</comment>
                            <comment id="13232699" author="lhofhansl" created="Mon, 19 Mar 2012 16:11:38 +0000"  >&lt;p&gt;One more reason to finish &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2600&quot; title=&quot;Change how we do meta tables; from tablename+STARTROW+randomid to instead, tablename+ENDROW+randomid&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2600&quot;&gt;HBASE-2600&lt;/a&gt; to rid ourselves from getCLosestRowBefore.&lt;/p&gt;</comment>
                            <comment id="15017764" author="lars_francke" created="Fri, 20 Nov 2015 13:01:17 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12465201">HBASE-2600</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12440605">HBASE-1978</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12424696" name="HBASE-1841-step1-v2.patch" size="2220" author="schubertzhang" created="Thu, 12 Nov 2009 03:39:41 +0000"/>
                            <attachment id="12424770" name="HBASE-1841-step2-v2.patch" size="14176" author="schubertzhang" created="Thu, 12 Nov 2009 21:00:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Sep 2009 02:26:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26011</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hfkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99784</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>HFile</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>