<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:07:49 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1104/HBASE-1104.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1104] Doubly-assigned regions redux</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1104</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Testing, I see doubly assigned regions.  Below is from master log for TestTable,0000135598,1230761605500.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-12-31 22:13:35,528 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_SPLIT: TestTable,0000116170,1230761152219: TestTable,0000116170,1230761152219 split; daughters: TestTable,0000116170,1230761605500, TestTable,0000135598,1230761605500 from XX.XX.XX.142:60020
2008-12-31 22:13:35,528 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000135598,1230761605500 to server XX.XX.XX.142:60020
2008-12-31 22:13:38,561 [IPC Server handler 6 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: TestTable,0000135598,1230761605500 from XX.XX.XX.142:60020
2008-12-31 22:13:38,562 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: TestTable,0000135598,1230761605500 open on XX.XX.XX.142:60020
2008-12-31 22:13:38,562 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: updating row TestTable,0000135598,1230761605500 in region .META.,,1 with startcode 1230759988953 and server XX.XX.XX.142:60020
2008-12-31 22:13:44,640 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region TestTable,0000135598,1230761605500
2008-12-31 22:13:50,441 [IPC Server handler 9 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000135598,1230761605500 to server XX.XX.XX.139:60020
2008-12-31 22:13:53,457 [IPC Server handler 5 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_PROCESS_OPEN: TestTable,0000135598,1230761605500 from XX.XX.XX.139:60020
2008-12-31 22:13:53,458 [IPC Server handler 5 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: TestTable,0000135598,1230761605500 from XX.XX.XX.139:60020
2008-12-31 22:13:53,458 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: TestTable,0000135598,1230761605500 open on XX.XX.XX.139:60020
2008-12-31 22:13:53,458 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: updating row TestTable,0000135598,1230761605500 in region .META.,,1 with startcode 1230759988788 and server XX.XX.XX.139:60020
2008-12-31 22:13:53,688 [IPC Server handler 6 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_CLOSE: TestTable,0000135598,1230761605500 from XX.XX.XX.142:60020
2008-12-31 22:13:53,688 [HMaster] DEBUG org.apache.hadoop.hbase.master.HMaster: Processing todo: ProcessRegionClose of TestTable,0000135598,1230761605500, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2008-12-31 22:13:54,263 [IPC Server handler 7 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000135598,1230761605500 to server XX.XX.XX.141:60020
2008-12-31 22:13:57,273 [IPC Server handler 9 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_PROCESS_OPEN: TestTable,0000135598,1230761605500 from XX.XX.XX.141:60020
2008-12-31 22:14:03,917 [IPC Server handler 0 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: TestTable,0000135598,1230761605500 from XX.XX.XX.141:60020
2008-12-31 22:14:03,917 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: TestTable,0000135598,1230761605500 open on XX.XX.XX.141:60020
2008-12-31 22:14:03,918 [HMaster] INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: updating row TestTable,0000135598,1230761605500 in region .META.,,1 with startcode 1230759989031 and server XX.XX.XX.141:60020
2008-12-31 22:14:29,350 [RegionManager.metaScanner] DEBUG org.apache.hadoop.hbase.master.BaseScanner: TestTable,0000135598,1230761605500 no longer has references to TestTable,0000116170,1230761152219
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See how we choose to assign before we get the close back from the regionserver.&lt;/p&gt;</description>
                <environment>&lt;p&gt;pset cluster with TRUNK.&lt;/p&gt;</environment>
        <key id="12411545">HBASE-1104</key>
            <summary>Doubly-assigned regions redux</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jimk">Jim Kellerman</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Dec 2008 23:07:32 +0000</created>
                <updated>Sun, 13 Sep 2009 22:26:36 +0000</updated>
                            <resolved>Fri, 9 Jan 2009 01:50:14 +0000</resolved>
                                                    <fixVersion>0.19.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="12660161" author="stack" created="Wed, 31 Dec 2008 23:22:03 +0000"  >&lt;p&gt;This part from above log extract is where we&apos;ve gone wrong:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-12-31 22:13:44,640 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region TestTable,0000135598,1230761605500
2008-12-31 22:13:50,441 [IPC Server handler 9 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000135598,1230761605500 to server XX.XX.XX.139:60020
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We&apos;ve set regionstate to &apos;closing&apos; but then six seconds later we give out the region.   Looking at code, if its state is &apos;closing&apos;, we shouldn&apos;t be giving it out.&lt;/p&gt;</comment>
                            <comment id="12660163" author="apurtell" created="Wed, 31 Dec 2008 23:28:12 +0000"  >&lt;p&gt;I was going to work up an issue but I think this covers something I&apos;ve been seeing: Trying to disable a table, the master will give out the regions again as soon as they are closed.&lt;/p&gt;</comment>
                            <comment id="12660165" author="stack" created="Wed, 31 Dec 2008 23:47:20 +0000"  >&lt;p&gt;Seems pretty easy to reproduce here on my end.  I don&apos;t see any change in the new state transition code other than improved logging and addition of setting closing to false inside in setClose.&lt;/p&gt;</comment>
                            <comment id="12660177" author="stack" created="Thu, 1 Jan 2009 03:32:28 +0000"  >&lt;p&gt;We set region as &apos;closed&apos; when master sends over the CLOSE message to the regionserver.  My adding the clearing of the &apos;closing&apos; when state goes to &apos;close&apos; unearthed this &apos;hole&apos; (least seems like a hole that region could be &apos;closing&apos; and &apos;closed&apos; at same time).  I think state should be set to &apos;closing&apos; when master sends message out to regionserver and then on receipt of the close confirmation, then it should move region to &apos;closed&apos; and &apos;unassigned&apos;.&lt;/p&gt;</comment>
                            <comment id="12660255" author="apurtell" created="Fri, 2 Jan 2009 01:18:04 +0000"  >&lt;p&gt;Got this on the JP cluster today:&lt;/p&gt;

&lt;p&gt;From master log:&lt;/p&gt;

&lt;p&gt;2009-01-02 00:05:09,671 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region content,b1d86dfc01925c3b891285b12d3bf452,1230853204947&lt;br/&gt;
2009-01-02 00:05:12,765 INFO org.apache.hadoop.hbase.master.RegionManager: assigning region content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 to server 10.3.134.207:60020&lt;br/&gt;
2009-01-02 00:05:15,778 INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_PROCESS_OPEN: content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 from 10.3.134.207:60020&lt;br/&gt;
2009-01-02 00:05:15,779 INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 open on 10.3.134.207:60020&lt;br/&gt;
2009-01-02 00:05:27,699 INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_CLOSE: content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 from 10.3.134.221:60020&lt;br/&gt;
2009-01-02 00:05:28,688 INFO org.apache.hadoop.hbase.master.RegionManager: assigning region content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 to server 10.3.134.222:60020&lt;br/&gt;
2009-01-02 00:05:31,697 INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 from 10.3.134.222:60020&lt;br/&gt;
2009-01-02 00:05:31,697 INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 open on 10.3.134.222:60020&lt;br/&gt;
2009-01-02 00:05:31,698 INFO org.apache.hadoop.hbase.master.ProcessRegionOpen$1: updating row content,b1d86dfc01925c3b891285b12d3bf452,1230853204947 in region .META.,,1 with startcode 1230848433306 and server 10.3.134.222:60020&lt;/p&gt;

&lt;p&gt;There are three HRS involved here.&lt;/p&gt;

&lt;p&gt;This leads to file system trouble:&lt;/p&gt;

&lt;p&gt;org.apache.hadoop.hbase.client.RetriesExhaustedException: Trying to contact region server 10.3.134.225:60020 for region content,b1d86dfc01925c3b891285b12d3bf452,1230853204947, row &apos;b1d86dfc01925c3b891285b12d3bf452&apos;, but failed after 10 attempts.&lt;br/&gt;
Exceptions:&lt;br/&gt;
java.io.IOException: java.io.IOException: HStoreScanner failed construction&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFileScanner.(StoreFileScanner.java:70)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HStoreScanner.(HStoreScanner.java:84)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HStore.getScanner(HStore.java:2119)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion$HScanner.(HRegion.java:1878)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.getScanner(HRegion.java:1162)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.openScanner(HRegionServer.java:1673)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor16.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:632)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:894)&lt;br/&gt;
Caused by: java.io.FileNotFoundException: File does not exist: hdfs://jdc2-atr-dc-1.atr.trendmicro.com:50000/data/hbase/content/485774435/info/mapfiles/1743031531971685847/data&lt;br/&gt;
	at org.apache.hadoop.hdfs.DistributedFileSystem.getFileStatus(DistributedFileSystem.java:394)&lt;br/&gt;
	at org.apache.hadoop.fs.FileSystem.getLength(FileSystem.java:679)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.SequenceFile$Reader.(SequenceFile.java:1431)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.SequenceFile$Reader.(SequenceFile.java:1426)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.MapFile$Reader.createDataFileReader(MapFile.java:310)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.HBaseMapFile$HBaseReader.createDataFileReader(HBaseMapFile.java:96)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.MapFile$Reader.open(MapFile.java:292)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.HBaseMapFile$HBaseReader.(HBaseMapFile.java:79)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.BloomFilterMapFile$Reader.(BloomFilterMapFile.java:65)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HStoreFile.getReader(HStoreFile.java:443)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFileScanner.openReaders(StoreFileScanner.java:96)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFileScanner.(StoreFileScanner.java:67)&lt;br/&gt;
	... 10 more&lt;/p&gt;</comment>
                            <comment id="12660521" author="jimk" created="Sun, 4 Jan 2009 02:32:32 +0000"  >&lt;p&gt;Closing used to mean &quot;marked to close&quot;.&lt;br/&gt;
Closed was set when the master told the region server to close the region.&lt;br/&gt;
When the master received the confirmation from the region server, &lt;br/&gt;
ProcessRegionClose either set the state to unassigned (if it was to be reassigned)&lt;br/&gt;
or removed it from the map if it was being offlined.&lt;/p&gt;</comment>
                            <comment id="12660537" author="stack" created="Sun, 4 Jan 2009 07:04:16 +0000"  >&lt;p&gt;Thanks Jim.  So, how would you fix the &apos;hole&apos; where we set region to &apos;closed&apos; state when we return to the regionserver the CLOSE message but if we clear the &apos;closing&apos; flag &amp;#8211; because surely a region can&apos;t be &apos;closed&apos; and &apos;closing&apos; &amp;#8211; then the region becomes assignable though it hasn&apos;t been closed on the regionserver?&lt;/p&gt;</comment>
                            <comment id="12661000" author="jimk" created="Tue, 6 Jan 2009 00:24:33 +0000"  >&lt;p&gt;Ok, I can see where this could be confusing. In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt;, a newly discovered region would be&lt;br/&gt;
set to &apos;unassigned&apos;. &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if a region is &apos;unassigned&apos; it is a candidate to be opened by the next region server that checks in.&lt;/li&gt;
	&lt;li&gt;if the region is assigned to a region server, it is marked as assigned.&lt;/li&gt;
	&lt;li&gt;when the region server reports that it has opened the region, it is marked as pending&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Once ProcessRegionOpen runs and the HRS is has been stored in the META table, it is removed&lt;br/&gt;
from the Map of regionsInTransition&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When it is determined that a region should be closed, the region is marked as &apos;closing&apos;&lt;/li&gt;
	&lt;li&gt;When the master sends the close message to the HRS, the region&apos;s status is set as&lt;br/&gt;
  closing + closed (and if the region is being off-lined in the process, the status is: closing +&lt;br/&gt;
  closed + offlined)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Once the HRS reports that a region is closed, ProcessRegionClose is called. If the region &lt;br/&gt;
should be reassigned (i.e., offlined == false), then the region status is set to unassigned&lt;br/&gt;
so that it will get picked up and assigned to the first region server that reports in that is not&lt;br/&gt;
overloaded.&lt;/p&gt;

&lt;p&gt;If the region has been offlined, ProcessRegionClose will remove the region from the&lt;br/&gt;
regionsInTransition Map. &lt;/p&gt;

&lt;p&gt;Ok, so what does this boil down to? There are three states for getting a region served: &lt;br/&gt;
1) unassigned &lt;br/&gt;
2) assigned &lt;br/&gt;
3) pending&lt;/p&gt;

&lt;p&gt;However, for regions being closed it is more complex:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;closing means the region is in the process of being closed&lt;/li&gt;
	&lt;li&gt;closing + closed means that the master has told the HRS to close the region.&lt;/li&gt;
	&lt;li&gt;closing + offline means that the master wants to close the region and have it offlined&lt;/li&gt;
	&lt;li&gt;closing + closed + offline means that the master has told the HRS to close the region,&lt;br/&gt;
  and that it will be offlined once the HRS reports that it has closed the region.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason for this approach was that if a region was closing, it could not be marked&lt;br/&gt;
as unassigned. Only ProcessRegionClose would know if the region should be reassigned,&lt;br/&gt;
and if not, it would remove the region from the regionsInTransition Map. If the region was&lt;br/&gt;
to be reassigned, it would stay in the map and its status would be changed to &quot;unassigned&quot;&lt;/p&gt;

&lt;p&gt;As opening a region requires three states (unassigned, assigned, pending), closing a region&lt;br/&gt;
should be similar:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;close &amp;#8211; region server should be told that region is to be closed when the HRS reports in&lt;/li&gt;
	&lt;li&gt;closing &amp;#8211; the HRS has been told to close the region&lt;/li&gt;
	&lt;li&gt;closed - HRS reports that the region is closed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When a region has a status of closing, it also has a substatus of closing and/or offlined.&lt;br/&gt;
If offlined, and the status == closed, then the master should remove the region from the &lt;br/&gt;
regionsInTransition Map. If not offlined, the region should have its status set to unassigned.&lt;/p&gt;

&lt;p&gt;So that is how it should work, but because starting up a region requires three state transitions&lt;br/&gt;
and closing one down currently only requires two, it is confusing.&lt;/p&gt;

&lt;p&gt;Changing region close to be symmetrical with region open should clarify (and simplify) how&lt;br/&gt;
regions get reassigned.&lt;/p&gt;
</comment>
                            <comment id="12661828" author="jimk" created="Thu, 8 Jan 2009 02:37:24 +0000"  >&lt;p&gt;This patch should address &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1104&quot; title=&quot;Doubly-assigned regions redux&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1104&quot;&gt;&lt;del&gt;HBASE-1104&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1098&quot; title=&quot;IllegalStateException: Cannot set a region to be closed it it was not already marked as closing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1098&quot;&gt;&lt;del&gt;HBASE-1098&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1096&quot; title=&quot;Does not recover if HRS carrying -ROOT- goes down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1096&quot;&gt;&lt;del&gt;HBASE-1096&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Please try it out, and review it.&lt;/p&gt;</comment>
                            <comment id="12661832" author="apurtell" created="Thu, 8 Jan 2009 03:06:10 +0000"  >&lt;p&gt;Thanks Jim. I&apos;ll give it a shot right now. After restart my cluster should split like crazy. Want the master log for anything, please ask stack. He can show you how to get it.&lt;/p&gt;</comment>
                            <comment id="12661833" author="jimk" created="Thu, 8 Jan 2009 03:06:59 +0000"  >&lt;p&gt;This one has no &amp;lt;cr&amp;gt;&amp;lt;lf&amp;gt;&apos;s&lt;/p&gt;</comment>
                            <comment id="12661840" author="stack" created="Thu, 8 Jan 2009 04:42:49 +0000"  >&lt;p&gt;Did you mean to add in changes to Index: src/webapps/master/WEB-INF/web.xml?&lt;/p&gt;

&lt;p&gt;Want to add more javadoc to the @return in below (Not important...)&lt;/p&gt;

&lt;p&gt;Index: src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java  (revision 732591)&lt;br/&gt;
+++ src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java  (working copy)&lt;br/&gt;
@@ -126,6 +126,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param regionName name of the region to update&lt;/li&gt;
	&lt;li&gt;@param b BatchUpdate&lt;/li&gt;
	&lt;li&gt;@param expectedValues map of column names to expected data values.&lt;br/&gt;
+   * @return true if &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Tell me about this change:&lt;/p&gt;

&lt;p&gt;         storedInfo = this.master.serverManager.getServerInfo(serverName);&lt;br/&gt;
         deadServer = this.master.serverManager.isDead(serverName);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;deadServerAndLogsSplit =&lt;/li&gt;
	&lt;li&gt;this.master.serverManager.isDeadServerLogsSplit(serverName);&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;and...&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if ((deadServerAndLogsSplit ||&lt;/li&gt;
	&lt;li&gt;(!deadServer &amp;amp;&amp;amp; (storedInfo == null ||&lt;/li&gt;
	&lt;li&gt;(storedInfo.getStartCode() != startCode)))) &amp;amp;&amp;amp;&lt;/li&gt;
	&lt;li&gt;this.regionManager.assignable(info)) {&lt;br/&gt;
+      if ((deadServer ||&lt;br/&gt;
+          (storedInfo == null || storedInfo.getStartCode() != startCode))) {&lt;br/&gt;
+&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It don&apos;t look right.  Changes I made for 1099 were &quot;allow assigning if its a dead server and its commit logs HAVE been split&quot; or &quot;if NOT a dead server....because if a dead server and didn&apos;t pass first test, then its logs are being split..&quot;  ... We don&apos;t want BaseScanner assigning to servers on dead list.  If regions are assigned to server on dead list, when dead server runs its scan in shutdown handler, we&apos;ll reassign these regions as though they&apos;d been on crashed server; makes for double assignment and a mess.&lt;/p&gt;

&lt;p&gt;You also remove the new method assignable.  Don&apos;t we want to check if region is &apos;assignable&apos; before dropping into this assigning code block? (Not sure... so asking).&lt;/p&gt;

&lt;p&gt;Your patch does this which as discussed on IRC is not whats wanted:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -1088,12 +1088,8 @@
       &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] closestKey = store.getRowKeyAtOrBefore(row);
       &lt;span class=&quot;code-comment&quot;&gt;// If it happens to be an exact match, we can stop looping.
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Otherwise, we need to check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s the max and move to the next
&lt;/span&gt;-      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (HStoreKey.equalsTwoRowKeys(regionInfo, row, closestKey)) {
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (closestKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
-      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (closestKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp;
-          (key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || HStoreKey.compareTwoRowKeys(
-              regionInfo,closestKey, key.getRow()) &amp;gt; 0) ) {
-        key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you think this safe Jim in below?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -564,9 +566,10 @@
       &lt;span class=&quot;code-comment&quot;&gt;//       the messages we&apos;ve received. In &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, a close could be
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;//       processed before an open resulting in the master not agreeing on
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;//       the region&apos;s state.
&lt;/span&gt;+      master.regionManager.setClosed(region.getRegionName());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will we have the problem where state changes are processed out of order?  Thinking on it, it doesn&apos;t seem so but asking just to check.&lt;/p&gt;

&lt;p&gt;I&apos;ll hold on testing the patch until answer on above.&lt;/p&gt;</comment>
                            <comment id="12661844" author="stack" created="Thu, 8 Jan 2009 05:23:05 +0000"  >&lt;p&gt;Other comments, I like the clean up of state namings.  Much clearer now whats going on (Was super confusing before &amp;#8211; now I&apos;ll have a chance at grokking whats going on).  Also, I liked removal of passing RegionManager when its accessible off the Master.  Good cleanup.&lt;/p&gt;</comment>
                            <comment id="12662144" author="jimk" created="Thu, 8 Jan 2009 22:19:51 +0000"  >&lt;p&gt;Addressing Stack&apos;s issues&lt;/p&gt;</comment>
                            <comment id="12662147" author="jimk" created="Thu, 8 Jan 2009 22:21:06 +0000"  >&lt;p&gt;&amp;gt; stack - 07/Jan/09 08:42 PM&lt;br/&gt;
&amp;gt; Did you mean to add in changes to Index: src/webapps/master/WEB-INF/web.xml?&lt;/p&gt;

&lt;p&gt;No, and I&apos;m not sure how it got changed. Reverted.&lt;/p&gt;

&lt;p&gt;&amp;gt; Want to add more javadoc to the @return in below (Not important...)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java
===================================================================
--- src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java (revision 732591)
+++ src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java (working copy)
@@ -126,6 +126,7 @@

    * @param regionName name of the region to update
    * @param b BatchUpdate
    * @param expectedValues map of column names to expected data values.
      + * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Done. It was missing the @return altogether, and I just forgot to finish the&lt;br/&gt;
comment.&lt;/p&gt;

&lt;p&gt;Tell me about this change:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
storedInfo = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.serverManager.getServerInfo(serverName);
deadServer = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.serverManager.isDead(serverName);

    * deadServerAndLogsSplit =
    * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.serverManager.isDeadServerLogsSplit(serverName);

and...

    * &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((deadServerAndLogsSplit ||
    * (!deadServer &amp;amp;&amp;amp; (storedInfo == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ||
    * (storedInfo.getStartCode() != startCode)))) &amp;amp;&amp;amp;
    * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionManager.assignable(info)) {
      + &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((deadServer ||
      + (storedInfo == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || storedInfo.getStartCode() != startCode))) {
      +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;gt; It don&apos;t look right. Changes I made for 1099 were &quot;allow assigning if&lt;br/&gt;
&amp;gt; its a dead server and its commit logs HAVE been split&quot; or &quot;if NOT a&lt;br/&gt;
&amp;gt; dead server....because if a dead server and didn&apos;t pass first test,&lt;br/&gt;
&amp;gt; then its logs are being split..&quot; ... We don&apos;t want BaseScanner&lt;br/&gt;
&amp;gt; assigning to servers on dead list. If regions are assigned to server&lt;br/&gt;
&amp;gt; on dead list, when dead server runs its scan in shutdown handler,&lt;br/&gt;
&amp;gt; we&apos;ll reassign these regions as though they&apos;d been on crashed server;&lt;br/&gt;
&amp;gt; makes for double assignment and a mess.&lt;/p&gt;

&lt;p&gt;You&apos;re right. It was a half finished change. What I meant to do was&lt;br/&gt;
not assign regions that are offline, in transition or were assigned to&lt;br/&gt;
a dead server since ProcessServerShutdown does that.&lt;/p&gt;

&lt;p&gt;&amp;gt; You also remove the new method assignable. Don&apos;t we want to check if&lt;br/&gt;
&amp;gt; region is &apos;assignable&apos; before dropping into this assigning code block?&lt;br/&gt;
&amp;gt; (Not sure... so asking).&lt;/p&gt;

&lt;p&gt;If we get this far, we know the region is assignable because of the&lt;br/&gt;
test above.&lt;/p&gt;

&lt;p&gt;&amp;gt; Your patch does this which as discussed on IRC is not whats wanted:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -1088,12 +1088,8 @@
       &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] closestKey = store.getRowKeyAtOrBefore(row);
       &lt;span class=&quot;code-comment&quot;&gt;// If it happens to be an exact match, we can stop looping.
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Otherwise, we need to check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s the max and move to the next
&lt;/span&gt;-      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (HStoreKey.equalsTwoRowKeys(regionInfo, row, closestKey)) {
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (closestKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
-      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (closestKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp;
-          (key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || HStoreKey.compareTwoRowKeys(
-              regionInfo,closestKey, key.getRow()) &amp;gt; 0) ) {
-        key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After some discussion with Stack, we determined that neither&lt;br/&gt;
implementation was correct. The new code is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// get the closest key. (HStore.getRowKeyAtOrBefore can &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] closestKey = store.getRowKeyAtOrBefore(row);
      &lt;span class=&quot;code-comment&quot;&gt;// If it happens to be an exact match, we can stop.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// Otherwise, we need to check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s the max and move to the next
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (closestKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (HStoreKey.equalsTwoRowKeys(regionInfo, row, closestKey)) {
          key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(closestKey, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo);
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;gt; Do you think this safe Jim in below?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -564,9 +566,10 @@
       &lt;span class=&quot;code-comment&quot;&gt;//       the messages we&apos;ve received. In &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, a close could be
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;//       processed before an open resulting in the master not agreeing on
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;//       the region&apos;s state.
&lt;/span&gt;+      master.regionManager.setClosed(region.getRegionName());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;gt; Will we have the problem where state changes are processed out of&lt;br/&gt;
&amp;gt; order? Thinking on it, it doesn&apos;t seem so but asking just to check.&lt;/p&gt;

&lt;p&gt;No, I don&apos;t think it is a problem, because the region is still in&lt;br/&gt;
transition and cannot be reassigned until the RegionState is removed&lt;br/&gt;
from the map.&lt;/p&gt;
</comment>
                            <comment id="12662148" author="jimk" created="Thu, 8 Jan 2009 22:21:36 +0000"  >&lt;p&gt;Running tests now.&lt;/p&gt;</comment>
                            <comment id="12662161" author="apurtell" created="Thu, 8 Jan 2009 23:14:41 +0000"  >&lt;p&gt;Testing with the latest patch now.&lt;/p&gt;</comment>
                            <comment id="12662192" author="stack" created="Fri, 9 Jan 2009 00:31:11 +0000"  >&lt;p&gt;+1 on patch and my testing fails to lose data or reproduce doubly-assign regions, at least to date.  It used to be easy to do.  Thats at least changed.  Will open new issue if I come across a problem.  Also tested killing the server carrying &lt;del&gt;ROOT&lt;/del&gt;.  It took too long to come up &amp;#8211; another issue hbase-1111 &amp;#8211; but it came up.  How&apos;s your testing going apurtell?&lt;/p&gt;</comment>
                            <comment id="12662211" author="apurtell" created="Fri, 9 Jan 2009 01:25:18 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Looking good here. I shut down some HRS to provoke, but everything recovered. I was especially pleased that manual close_region invocations were not needed, unlike before. Recovery is a little slow as mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1111&quot; title=&quot;[performance] Crash recovery takes way too long&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1111&quot;&gt;&lt;del&gt;HBASE-1111&lt;/del&gt;&lt;/a&gt;, but prior situation often was no recovery (missing regions) or permanent failure (region corruption). &lt;/p&gt;</comment>
                            <comment id="12662219" author="jimk" created="Fri, 9 Jan 2009 01:50:14 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12397376" name="1104.patch" size="40540" author="jimk" created="Thu, 8 Jan 2009 03:06:59 +0000"/>
                            <attachment id="12397451" name="1104.patch.1" size="42765" author="jimk" created="Thu, 8 Jan 2009 22:21:06 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12411446">HBASE-1098</subtask>
                            <subtask id="12411424">HBASE-1096</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 31 Dec 2008 23:28:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25575</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hbcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99102</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>