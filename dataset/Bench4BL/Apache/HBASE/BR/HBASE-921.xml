<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 18:07:25 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-921/HBASE-921.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-921] region close and open processed out of order; makes for disagreement between master and regionserver on region state</title>
                <link>https://issues.apache.org/jira/browse/HBASE-921</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Master assigns region X successfully.  It then decides to close it because it wants it opened elsewhere as part of region rebalancing.  Both the open and close operations are reported back to the master.  Both have operation processing components that are added to the todo list to be processed in another thread outside of the master&apos;s main loop.&lt;/p&gt;

&lt;p&gt;The close operation does the bulk of its work inline with the master main processing loop.  Its todo component does some work if the region is offlined but otherwise nothing of consequence whereas the open in its todo does the important meta catalog table update with the new location information.&lt;/p&gt;

&lt;p&gt;Its been fairly common here on our cluster where the master todo queue is occupied processing the shutdown of a regionserver.  It takes a long time to process the shutdown of a regionserver when thousands of regions   This latter delays the processing of the open and close todos.  In effect the open is running after the close.  The region goes into limbo.  Only a restart of the &apos;hosting&apos; regionserver &apos;fixes&apos; this state.&lt;/p&gt;

&lt;p&gt;This is a particular case of the general &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt; issue.  Its happening alot here on our cluster so will hack up a fix for this and get it into TRUNK and backport it to 0.18.1.&lt;/p&gt;

&lt;p&gt;Jim Firby here had a good idea for conditions like this.  Clients should be able to say &quot;I&apos;ve asked for a regions location 10 times now and Mr. Master, you&apos;ve given me the same response ten times in a row and each time, the answer was wrong.  Revisit any notion that said region is at said location&quot;.  Mr. Master would then go off and do something drastic like close and reassign the region.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12406231">HBASE-921</key>
            <summary>region close and open processed out of order; makes for disagreement between master and regionserver on region state</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12397996">HBASE-678</parent>
                                    <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Oct 2008 06:48:37 +0000</created>
                <updated>Tue, 30 Dec 2008 22:16:36 +0000</updated>
                            <resolved>Tue, 30 Dec 2008 22:16:36 +0000</resolved>
                                    <version>0.18.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12638753" author="jdcryans" created="Sat, 11 Oct 2008 14:47:17 +0000"  >&lt;p&gt;This issue seems very much like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-851&quot; title=&quot;Region is left unassigned after a split/rebalancing, throws NSRE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-851&quot;&gt;&lt;del&gt;HBASE-851&lt;/del&gt;&lt;/a&gt; and Firby&apos;s idea is like the bandaid I proposed there.&lt;/p&gt;</comment>
                            <comment id="12638762" author="stack" created="Sat, 11 Oct 2008 15:38:38 +0000"  >&lt;p&gt;Thanks for making the link J-D.  Yeah, looks like duplicate.  Let me keep going on this one for moment since I have logs to work from.  Will then go back to hbase-851 and verify they are same.&lt;/p&gt;</comment>
                            <comment id="12639110" author="jimk" created="Mon, 13 Oct 2008 16:56:45 +0000"  >&lt;p&gt;In HBase-0.1.x, all region closes in HMaster went through the toDo queue to preserve ordering. Later, an &quot;optimization&quot; was introduced, so that simple closes were processed immediately, effectively allowing normal closes to jump ahead of the queue. Here is a snipped from HMaster.processMsgs circa HBase-0.1.0:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; HMsg.MSG_REPORT_CLOSE:
        ... (code irrelevant to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; issue not shown)

          &lt;span class=&quot;code-comment&quot;&gt;// NOTE: we cannot put the region into unassignedRegions as that
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;//       could create a race with the pending close &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it gets 
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;//       reassigned before the close is processed.
&lt;/span&gt;          unassignedRegions.remove(region);
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            toDoQueue.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProcessRegionClose(region, reassignRegion,
                deleteRegion));
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12639293" author="stack" created="Tue, 14 Oct 2008 04:15:02 +0000"  >&lt;p&gt;Patch looks good to me (its a bit hard to follow whats going on, but thats not the patches fault).  If unit tests pass, commit I&apos;d say.&lt;/p&gt;</comment>
                            <comment id="12639375" author="jimk" created="Tue, 14 Oct 2008 10:41:06 +0000"  >&lt;p&gt;Committed to branch and trunk.&lt;/p&gt;</comment>
                            <comment id="12639471" author="stack" created="Tue, 14 Oct 2008 16:19:39 +0000"  >&lt;p&gt;Rong-en up on IRC:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[23:33]	&amp;lt;rafan&amp;gt;	btw, jim&apos;s 921 passes unit test here
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12650732" author="apurtell" created="Tue, 25 Nov 2008 20:57:43 +0000"  >&lt;p&gt;I believe I saw an instance of this issue again today. &lt;/p&gt;

&lt;p&gt;What about Jim Firby&apos;s original suggestion: &quot;Clients should be able to say &quot;I&apos;ve asked for a regions location 10 times now and Mr. Master, you&apos;ve given me the same response ten times in a row and each time, the answer was wrong. Revisit any notion that said region is at said location&quot;. Mr. Master would then go off and do something drastic like close and reassign the region.&quot;&lt;/p&gt;

&lt;p&gt;Or the Master can sanity check on its own. If my latest patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1018&quot; title=&quot;Regionservers should report detailed health to master; master should flag troubled regionservers in UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1018&quot;&gt;&lt;del&gt;HBASE-1018&lt;/del&gt;&lt;/a&gt; goes in, the master can look at the HServerLoad and note that not all expected regions are found there. &lt;/p&gt;</comment>
                            <comment id="12650738" author="jimk" created="Tue, 25 Nov 2008 21:19:20 +0000"  >&lt;p&gt;The problem is that the master does not know where any regions are located except for root and meta regions. It is up to the client to figure out that a region isn&apos;t where it&apos;s supposed to be, and at that point the client should rescan the meta to find the region.&lt;/p&gt;</comment>
                            <comment id="12650747" author="apurtell" created="Tue, 25 Nov 2008 21:40:27 +0000"  >&lt;p&gt;The problem is that META has out of date information on where the region is located, due to the master leaving server location information in META in an incorrect state for whatever reason. This is a problem with region (re)assignment. The master is not adequately testing its view of region assignments against the reality. &lt;/p&gt;

&lt;p&gt;I think either Jim Firby&apos;s suggestion should be implemented or the additional information in HSL if that patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1018&quot; title=&quot;Regionservers should report detailed health to master; master should flag troubled regionservers in UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1018&quot;&gt;&lt;del&gt;HBASE-1018&lt;/del&gt;&lt;/a&gt; should be used. Either option allows the master to get feedback on region assignment state from the regionservers.&lt;/p&gt;</comment>
                            <comment id="12651729" author="stack" created="Sat, 29 Nov 2008 17:03:22 +0000"  >&lt;p&gt;Andrew: Were you sure the issue you saw was processing of messages out of order?  To do the jim firby suggestion, should we open a new issue and close this one.  Should it be in 0.19?&lt;/p&gt;</comment>
                            <comment id="12651736" author="apurtell" created="Sat, 29 Nov 2008 18:02:33 +0000"  >&lt;p&gt;What I saw was a CLOSE on the region server and nothing in the master log. &lt;/p&gt;

&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1038&quot; title=&quot;Master should accept client feedback about inconsistencies in META&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1038&quot;&gt;&lt;del&gt;HBASE-1038&lt;/del&gt;&lt;/a&gt;  for Jim&apos;s suggestion.&lt;/p&gt;</comment>
                            <comment id="12652502" author="stack" created="Tue, 2 Dec 2008 20:32:33 +0000"  >&lt;p&gt;Did regionserver say why it was closing?  An exception or OOME?  Or was it a request from master?  Should we keep this issue in 0.19.0 Andrew?  If so, how to replicate or log from the problem-time would help.&lt;/p&gt;</comment>
                            <comment id="12659965" author="apurtell" created="Tue, 30 Dec 2008 22:16:36 +0000"  >&lt;p&gt;The regionserver sent the CLOSE because a DFS error prevented deployment. Master state races are being addressed elsewhere. For example &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1098&quot; title=&quot;IllegalStateException: Cannot set a region to be closed it it was not already marked as closing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1098&quot;&gt;&lt;del&gt;HBASE-1098&lt;/del&gt;&lt;/a&gt; provides a workaround. In addition &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1038&quot; title=&quot;Master should accept client feedback about inconsistencies in META&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1038&quot;&gt;&lt;del&gt;HBASE-1038&lt;/del&gt;&lt;/a&gt; and ZK work will impact this area.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12403270">HBASE-851</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12392050" name="921-0.18.0.patch" size="4861" author="jimk" created="Tue, 14 Oct 2008 00:45:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 11 Oct 2008 14:47:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31906</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ha9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98925</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>