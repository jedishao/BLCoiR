<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:02:12 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11036/HBASE-11036.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11036] Online schema change with region merge may cause data loss </title>
                <link>https://issues.apache.org/jira/browse/HBASE-11036</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We have found out that online schema change and region merges may still cause issues about merged regions coming back online, and thus causing data loss. &lt;/p&gt;

&lt;p&gt;Recently ITBLL failed reporting 800K missing rows out of 720M. We&apos;ve been running this test for some extended period of time, and this is the first we are seeing it, meaning that it is more rare. But it is still concerning. &lt;/p&gt;

&lt;p&gt;From master&apos;s log:&lt;br/&gt;
The merge has happened:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:26:37,247 INFO  [AM.ZK.Worker-pool2-t73] master.AssignmentManager: Handled MERGED event; merged=IntegrationTestBigLinkedList,\xB2\xFE\x03s,1397672795119.80159738a0167e20a2e29fb2c46702f2., 	
	region_a=IntegrationTestBigLinkedList,\xB2\xFE\x03s,1397670978959.0ac116e4d7da87922d3a8f218ca21079., 
	region_b=IntegrationTestBigLinkedList,\xB8\x03\x94\x15,1397672587456.1265d06478082ced65dd9a0c1c2b63c2., on hor13n03.gq1.ygridcore.net,60020,1397672668647
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The region server shows the merge is complete: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:26:37,352 INFO  [regionserver60020-merges-1397672794972] regionserver.RegionMergeRequest: Regions merged, hbase:meta updated, and report to master. region_a=IntegrationTestBigLinkedList,\xB2\xFE\x03s,1397670978959.0ac116e4d7da87922d3a8f218ca21079., region_b=IntegrationTestBigLinkedList,\xB8\x03\x94\x15,1397672587456.1265d06478082ced65dd9a0c1c2b63c2.. Region merge took 2sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The new region was online on the region server for some time: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:31:22,858 DEBUG [RS_OPEN_REGION-hor13n03:60020-1] handler.OpenRegionHandler: Opened IntegrationTestBigLinkedList,\xB2\xFE\x03s,1397672795119.80159738a0167e20a2e29fb2c46702f2. on hor13n03.gq1.ygridcore.net,60020,1397672668647
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then the region server was killed around 2014-04-16 18:31:26,254. &lt;/p&gt;

&lt;p&gt;The master started log splitting etc for the dead RS:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:31:28,942 INFO  [MASTER_SERVER_OPERATIONS-hor13n02:60000-3] handler.ServerShutdownHandler: Splitting logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hor13n03.gq1.ygridcore.net,60020,1397672668647 before assignment.
..
2014-04-16 18:31:40,887 INFO  [MASTER_SERVER_OPERATIONS-hor13n02:60000-3] master.RegionStates: Transitioned {80159738a0167e20a2e29fb2c46702f2 state=OPEN, ts=1397673082874, server=hor13n03.gq1.ygridcore.net,60020,1397672668647} to {80159738a0167e20a2e29fb
2014-04-16 18:31:40,887 INFO  [MASTER_SERVER_OPERATIONS-hor13n02:60000-3] master.RegionStates: Offlined 80159738a0167e20a2e29fb2c46702f2 from hor13n03.gq1.ygridcore.net,60020,1397672668647
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this region was not assigned again at all. Instead, the master restarted shortly after, and reassigned the regions that were merged already: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:34:02,569 INFO  [master:hor13n02:60000] master.ActiveMasterManager: Registered Active Master=hor13n02.gq1.ygridcore.net,60000,1397673241215
...
2014-04-16 18:34:10,412 INFO  [master:hor13n02:60000] master.AssignmentManager: Found regions out on cluster or in RIT; presuming failover
2014-04-16 18:34:10,412 WARN  [master:hor13n02:60000] master.ServerManager: Expiration of hor13n03.gq1.ygridcore.net,60020,1397671753021 but server not online
..
2014-04-16 18:34:10,880 INFO  [MASTER_SERVER_OPERATIONS-hor13n02:60000-3] master.AssignmentManager: Bulk assigning 28 region(s) across 4 server(s), round-robin=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
..
2014-04-16 18:34:10,882 DEBUG [hor13n02.gq1.ygridcore.net,60000,1397673241215-GeneralBulkAssigner-1] zookeeper.ZKAssign: master:60000-0x2456a4863640255, quorum=hor13n04.gq1.ygridcore.net:2181,hor13n03.gq1.ygridcore.net:2181,hor13n20.gq1.ygridcore.net:2181, baseZNode=/hbase Async create of unassigned node 0ac116e4d7da8792..
..
2014-04-16 18:34:13,077 INFO  [AM.ZK.Worker-pool2-t7] master.RegionStates: Onlined 0ac116e4d7da87922d3a8f218ca21079 on hor13n04.gq1.ygridcore.net,60020,1397672685370
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Before the master went down, there were other logs that indicate something funky: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:32:42,113 DEBUG [hor13n02.gq1.ygridcore.net,60000,1397672191204-org.apache.hadoop.hbase.master.BulkReOpen-0] master.AssignmentManager: Starting unassign of IntegrationTestBigLinkedList,\xB2\xFE\x03s,1397670978959.0ac116e4d7da87922d3a8f218ca
2014-04-16 18:32:42,113 INFO  [hor13n02.gq1.ygridcore.net,60000,1397672191204-org.apache.hadoop.hbase.master.BulkReOpen-0] master.AssignmentManager: Attempting to unassign {0ac116e4d7da87922d3a8f218ca21079 state=MERGED, ts=1397672797223, server=hor13n03.gq1.ygridcore.net,60020,1397672668647}, ignored
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This above log is due to bulk reopening because of online schema change: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-04-16 18:32:32,081 DEBUG [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Ignoring table not disabled exception &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; supporting online schema changes.
2014-04-16 18:32:32,082 INFO  [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Handling table operation C_M_MODIFY_TABLE on table IntegrationTestBigLinkedList
2014-04-16 18:32:32,150 DEBUG [FifoRpcScheduler.handler1-thread-27] util.FSTableDescriptors: Wrote descriptor into: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hor13n01.gq1.ygridcore.net:8020/apps/hbase/data/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList/.tabledesc/.tableinfo.0000000051
&lt;/span&gt;2014-04-16 18:32:32,159 DEBUG [FifoRpcScheduler.handler1-thread-27] util.FSTableDescriptors: Deleted table descriptor at hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hor13n01.gq1.ygridcore.net:8020/apps/hbase/data/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList/.tabledesc/.tableinfo.0000000050
&lt;/span&gt;2014-04-16 18:32:32,159 INFO  [FifoRpcScheduler.handler1-thread-27] util.FSTableDescriptors: Updated tableinfo=hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hor13n01.gq1.ygridcore.net:8020/apps/hbase/data/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList/.tabledesc/.tableinfo.0000000051
&lt;/span&gt;2014-04-16 18:32:32,160 INFO  [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Bucketing regions by region server...
2014-04-16 18:32:32,191 INFO  [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Skip {ENCODED =&amp;gt; e81668b7b64a9c92dd3689db96a3adb0, NAME =&amp;gt; &apos;IntegrationTestBigLinkedList,\xC0\x03O,1397669732121.e81668b7b64a9c92dd3689db96a3adb0.&apos;, STARTKEY =
2014-04-16 18:32:32,191 INFO  [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Skip {ENCODED =&amp;gt; a51376af5b2aaef5bde980d48b05d75d, NAME =&amp;gt; &apos;IntegrationTestBigLinkedList,\xE8\x01\x99,,1397671676090.a51376af5b2aaef5bde980d48b05d75d.&apos;, STARTK
2014-04-16 18:32:32,191 INFO  [FifoRpcScheduler.handler1-thread-27] handler.TableEventHandler: Reopening 51 regions on 5 region servers.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My theory is that this may have left the regions in RIT state, and when the master was restarted it saw those in RIT and assigned. &lt;/p&gt;

&lt;p&gt;Also notice that this is not an issue about a concurrent merge and online schema change that can be prevented with table locks. The merge happened minutes ago, however the online schema change still wanted to reassign the merged regions. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12709371">HBASE-11036</key>
            <summary>Online schema change with region merge may cause data loss </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Apr 2014 23:21:23 +0000</created>
                <updated>Sat, 21 Feb 2015 23:31:25 +0000</updated>
                            <resolved>Wed, 21 May 2014 02:03:46 +0000</resolved>
                                                    <fixVersion>0.99.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                <comments>
                            <comment id="13974780" author="zjushch" created="Sat, 19 Apr 2014 08:37:01 +0000"  >&lt;p&gt;Once region merge completed, the old regions are removed from meta table. (Completed on 2014-04-16 18:26:37,352)&lt;br/&gt;
Why Schema-Change thread will get the regions that were merged from meta? (Happen on 2014-04-16 18:32:42,113)&lt;br/&gt;
I doubt that data loss on META table or table lock is not effective at that time.&lt;/p&gt;</comment>
                            <comment id="13978401" author="jxiang" created="Wed, 23 Apr 2014 16:34:19 +0000"  >&lt;p&gt;For online schema change, we load the regions of the table from meta, then do the change, then re-assign them all.  In the middle, if two regions are merged, we don&apos;t know, so we will try to re-assign them. However, since the regions are already merged so the re-assign will be ignored as shown in the log. So they should not be in transition. When the master restarts, these regions are not in the meta any more, so they should not be assigned either, unless they are in ZK in transition, which should not happen.&lt;/p&gt;

&lt;p&gt;A quick question, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;, are you running the latest trunk/0.98 code? Do you have &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9052&quot; title=&quot;Prevent split/merged region from assigning again&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9052&quot;&gt;&lt;del&gt;HBASE-9052&lt;/del&gt;&lt;/a&gt; in the build?&lt;/p&gt;</comment>
                            <comment id="13978422" author="jxiang" created="Wed, 23 Apr 2014 16:42:46 +0000"  >&lt;p&gt;How about &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9514&quot; title=&quot;Prevent region from assigning before log splitting is done&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9514&quot;&gt;&lt;del&gt;HBASE-9514&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13980320" author="enis" created="Thu, 24 Apr 2014 21:32:20 +0000"  >&lt;p&gt;Thanks for looking. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt; this is 0.98.0 codebase with some more patches. It contains 9052 and 9514. &lt;br/&gt;
Because of the time gap between the merge and the (now merged region) coming back, I still think that the region was left in RIT because of online schema change still saw that region, and wanted to reopen it, thus leaving it in RIT state (just a theory though). &lt;br/&gt;
BTW, this exact same symptom also happened at another time, to another set of regions, but this time after split not merge. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I doubt that data loss on META table or table lock is not effective at that time.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Though about META loss, but I could not find anything that indicates that. Table lock is not relevant since by this time, the locks are released. &lt;/p&gt;</comment>
                            <comment id="13994525" author="apurtell" created="Sun, 11 May 2014 11:19:26 +0000"  >&lt;p&gt;Unscheduling from 0.98 until there&apos;s a patch&lt;/p&gt;</comment>
                            <comment id="14004221" author="enis" created="Wed, 21 May 2014 02:03:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Though about META loss, but I could not find anything that indicates that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Upon further inspection, this seems a data loss on the meta region. I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11217&quot; title=&quot;Race between SplitLogManager task creation + TimeoutMonitor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11217&quot;&gt;&lt;del&gt;HBASE-11217&lt;/del&gt;&lt;/a&gt; to track that because the logs in this issue is not that relevant for that root cause. &lt;/p&gt;</comment>
                            <comment id="14004222" author="enis" created="Wed, 21 May 2014 02:03:47 +0000"  >&lt;p&gt;The issue moved to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11217&quot; title=&quot;Race between SplitLogManager task creation + TimeoutMonitor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11217&quot;&gt;&lt;del&gt;HBASE-11217&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="14330822" author="enis" created="Sat, 21 Feb 2015 23:31:25 +0000"  >&lt;p&gt;Closing this issue after 0.99.0 release. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12715657">HBASE-11217</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 19 Apr 2014 08:37:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1usbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387954</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>