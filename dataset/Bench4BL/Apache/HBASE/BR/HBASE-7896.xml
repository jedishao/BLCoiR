<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 18:04:37 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7896/HBASE-7896.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7896] make rename_table working in 92/94</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7896</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The rename_table function is very useful for our customers. However, rename_table.rb does not work for 92/94. It has several bugs. It will be useful to fix them so that users can solve their problems. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12633449">HBASE-7896</key>
            <summary>make rename_table working in 92/94</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="tychang">Tianying Chang</assignee>
                                    <reporter username="tychang">Tianying Chang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Feb 2013 18:44:38 +0000</created>
                <updated>Thu, 23 May 2013 17:35:48 +0000</updated>
                                            <version>0.92.2</version>
                    <version>0.94.5</version>
                                    <fixVersion>0.92.3</fixVersion>
                                    <component>scripts</component>
                        <due>Thu, 28 Feb 2013 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13583540" author="mbertozzi" created="Thu, 21 Feb 2013 20:48:47 +0000"  >&lt;p&gt;on trunk/96 renaming a table means breaking snapshots (data loss)&lt;br/&gt;
since the snapshots relies on the data being in the &quot;table name&quot;&lt;/p&gt;

&lt;p&gt;but a rename can be simulated as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
disable &apos;tableName&apos;
snapshot &apos;tableName&apos;, &apos;tableSnapshot&apos;
clone &apos;tableSnapshot&apos;, &apos;newTableName&apos;
delete_snapshot &apos;tableSnapshot&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tychang&quot; class=&quot;user-hover&quot; rel=&quot;tychang&quot;&gt;Tianying Chang&lt;/a&gt; Can you explain the use case?&lt;/p&gt;</comment>
                            <comment id="13583646" author="tychang" created="Thu, 21 Feb 2013 23:00:30 +0000"  >&lt;p&gt;Here is what happened that required us to do renaming for our customers:&lt;/p&gt;

&lt;p&gt;There are two production cluster X and Y. Both have table A, but with different data. Now the customers want to copy the table A from Cluster X into cluster Y, and still use table name A for some testing in cluster Y. But they don&apos;t want to lose data in original table A of cluster Y either. So they want us to rename table A in cluster Y to be A-Y, and then copy table A from cluster X into cluster Y. &lt;/p&gt;

&lt;p&gt;BTW, Our production cluster is 0.92/0.94. When we found the rename_table.rb does not work for 0.92/0.94, we decided to fix that to unblock our customers.  &lt;/p&gt;</comment>
                            <comment id="13584460" author="tychang" created="Fri, 22 Feb 2013 17:22:27 +0000"  >&lt;p&gt;1. disable original table &apos;origin_name&apos;&lt;br/&gt;
2. run the script: hbase org.jruby.Main rename_Table.rb origin_name new_name&lt;br/&gt;
3. disable table &apos;new_name&apos;&lt;br/&gt;
4. enable table &apos;new_name&apos;&lt;/p&gt;</comment>
                            <comment id="13584558" author="tychang" created="Fri, 22 Feb 2013 19:09:48 +0000"  >&lt;p&gt;The high level summary of renaming a table is like this: create hdfs dir for the new table; rename the Hfile from old table dir into new table dir; delete the entry for old table from META; insert the entry for the new table into META; manipulate zookeeper to create a znode for the new table. Because this is an un-conventional way of &quot;creating&quot; a new table, the master is not aware of the new table. That is why I manipulate the zookeeper by explicitly inserting a znode for the new table. But master still does not read in the full information of the new table, so it is not REALLY enabled. By inserting the znode with enable state, we can make it officially enabled by calling disable/enable sequence on this new table without needing to restart master, because it invoked the master to learn of the new table.  &lt;/p&gt;

&lt;p&gt;This is just my quick way to make rename_table.rb work for our production cluster. My next step plan is 1. make master aware of the newly renamed table immediately without explicit znode manipulation and table disable/enable. This will probably need to expose some API from Master 2. make rename_table as 2pc with roll back capability. &lt;/p&gt;</comment>
                            <comment id="13584570" author="jmspaggi" created="Fri, 22 Feb 2013 19:21:25 +0000"  >&lt;p&gt;Is there anyone working on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-643&quot; title=&quot;Rename tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-643&quot;&gt;&lt;del&gt;HBASE-643&lt;/del&gt;&lt;/a&gt; to implement a table id &amp;lt;-&amp;gt; table name link? Because that will definitively fix/simplify the rename logic.&lt;/p&gt;</comment>
                            <comment id="13584642" author="mbertozzi" created="Fri, 22 Feb 2013 20:28:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmspaggi&quot; class=&quot;user-hover&quot; rel=&quot;jmspaggi&quot;&gt;Jean-Marc Spaggiari&lt;/a&gt; having an id can be a quick a dirty fix, but is more painful than what you think. Also this fs layout with the table names &quot;hardcoded&quot; limits the new features that we can do like deduplication, handling blocks to have a proper compaction without rewriting the whole file &amp;amp; co, already snapshot are more like a workaround due to the current fs layout. Anway &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7806&quot; title=&quot;Isolate the FileSystem calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7806&quot;&gt;HBASE-7806&lt;/a&gt; is the beginning of what you&apos;re looking for.&lt;/p&gt;</comment>
                            <comment id="13584648" author="jmspaggi" created="Fri, 22 Feb 2013 20:34:09 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt;. I will look at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7806&quot; title=&quot;Isolate the FileSystem calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7806&quot;&gt;HBASE-7806&lt;/a&gt;. If you need some hands for it, just let me know.&lt;/p&gt;</comment>
                            <comment id="13585718" author="mbertozzi" created="Mon, 25 Feb 2013 08:28:28 +0000"  >&lt;p&gt;Looking at the code and trying it out... a couple of notes, aside from the discussion above.&lt;/p&gt;

&lt;p&gt;The concept, of scanning META and for each region recreate the folder with the new name&lt;br/&gt;
and move the files in is ok, and it&apos;s also used by the clone snapshot.&lt;/p&gt;

&lt;p&gt;This script doesn&apos;t consider ACL. This means that if you rename the table, &lt;br/&gt;
the ACL from the old table name are not moved to the new table, &lt;br/&gt;
and they are not even removed.&lt;/p&gt;

&lt;p&gt;The .regioninfo file doesn&apos;t seems to be created in the proper way...&lt;br/&gt;
by comparing the HRegion code with the rename_table script&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// HRegion.java code HRegion.checkRegioninfoOnFilesystem()
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo.write(out);
out.write(&apos;\n&apos;);
out.write(&apos;\n&apos;);
out.write(Bytes.toBytes(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo.toString()));

# rename_table.rb
out = fs.create(regioninfofile)
newR.getRegionInfo().write(out)
newHtd.write(out)
out.close()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At the end of the script you create the zknode for the new table but you don&apos;t delete the old one...&lt;br/&gt;
also the node is created in the enabled state. This means that if I do, is_enabled it returns true but the scan or other operations doesn&apos;t work since the table is not really enabled (regions assgned), and if you don&apos;t call enable you&apos;re in a weird state that can break monitoring tools or similar.&lt;/p&gt;</comment>
                            <comment id="13586364" author="devaraj" created="Mon, 25 Feb 2013 22:14:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tychang&quot; class=&quot;user-hover&quot; rel=&quot;tychang&quot;&gt;Tianying Chang&lt;/a&gt;, mind responding to Matteo&apos;s comments. Thanks!&lt;/p&gt;</comment>
                            <comment id="13586416" author="tychang" created="Mon, 25 Feb 2013 22:57:05 +0000"  >&lt;p&gt;1. Our cluster was not having secure feature, so I did not consider the ACL part, I will add that part into this rename script.&lt;br/&gt;
2. Matteo is right. I think the regionInfo file format was for older version (0.90x). I have made the corresponding changes to make the regionInfo format match the current java code this morning after reading the comments.  &lt;br/&gt;
3. I have added code to delete the znode for the old table this morning after reading the comments. So now the znode for old table is cleaned up.&lt;/p&gt;

&lt;p&gt;I did not respond the comments immediately because I am still working on the patch to try to address Matteo&apos;s comments. Those are good comments. Sorry for the delay. I will post an updated patch later after I addressed all Matteo&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="13586741" author="lhofhansl" created="Tue, 26 Feb 2013 04:37:34 +0000"  >&lt;p&gt;Thanks for working on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tychang&quot; class=&quot;user-hover&quot; rel=&quot;tychang&quot;&gt;Tianying Chang&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Since we&apos;re still discussing, I&apos;ll move this into 0.94.7 (which will be out about 4-6 six weeks after 0.94.6).&lt;/p&gt;</comment>
                            <comment id="13592421" author="tychang" created="Mon, 4 Mar 2013 18:07:32 +0000"  >&lt;p&gt;While I am working on addressing the comments, I start to think maybe it is better to make rename_table part of the functions of HBase Admin in Java code. The reason is that being ruby and no unit test associated, we have to update this script whenever there is API break change in the HBase java code(and we don&apos;t even notice it until we run the script again). I fixed the script to work for 92 in our production, and then found have to fix more things when we start to use 94. It is a pain to keep updating this ruby script. I think it is probably better idea to make it part of the HBase admin and with unit test. &lt;/p&gt;

&lt;p&gt;Anyone think it is better to stay in Ruby or better to integrate as part of HBase Admin? If people agree that Java version is better, I can start to work on java version. &lt;/p&gt;</comment>
                            <comment id="13592688" author="yuzhihong@gmail.com" created="Mon, 4 Mar 2013 21:56:21 +0000"  >&lt;p&gt;Is your target release 0.94.x ?&lt;/p&gt;

&lt;p&gt;If so, do you need to handle compatibility issue ?&lt;/p&gt;</comment>
                            <comment id="13592696" author="lhofhansl" created="Mon, 4 Mar 2013 22:02:19 +0000"  >&lt;p&gt;Probably better as new functionality in HBaseAdmin.&lt;/p&gt;</comment>
                            <comment id="13592739" author="tychang" created="Mon, 4 Mar 2013 22:25:30 +0000"  >&lt;p&gt;@Ted, this version is working against 94. The first version I made it working is 92 mid last year, and found it break again when we change to 94 this year. That is why I am thinking it is better idea to put it in HBaseAdmin. &lt;/p&gt;

&lt;p&gt;@Lars. Thanks, I will start to work on the HBaseAdmin version then.&lt;/p&gt;</comment>
                            <comment id="13592773" author="devaraj" created="Mon, 4 Mar 2013 22:56:38 +0000"  >&lt;p&gt;+1 on having the facility in HBA.&lt;/p&gt;</comment>
                            <comment id="13618225" author="lhofhansl" created="Sun, 31 Mar 2013 03:57:26 +0000"  >&lt;p&gt;+1 on this in HBA. Alternatively we could maybe add a shell test to ensure that it won&apos;t break.&lt;/p&gt;</comment>
                            <comment id="13618228" author="lhofhansl" created="Sun, 31 Mar 2013 03:58:42 +0000"  >&lt;p&gt;In the meanwhile, should we add the rename_table.rb script, or punt on it?&lt;/p&gt;</comment>
                            <comment id="13618888" author="tychang" created="Mon, 1 Apr 2013 16:33:22 +0000"  >&lt;p&gt;I feel no need for the ruby script if we have the function exposed through HBase shell. &lt;/p&gt;</comment>
                            <comment id="13618890" author="tychang" created="Mon, 1 Apr 2013 16:34:40 +0000"  >&lt;p&gt;I am almost done for the HBA version, with one unit test added with it. I will post the patch in couple days. &lt;/p&gt;</comment>
                            <comment id="13618902" author="mbertozzi" created="Mon, 1 Apr 2013 16:47:55 +0000"  >&lt;p&gt;as I&apos;ve said in the beginning, if we implement the rename as the current rb script...&lt;br/&gt;
a rename will cause a data loss for snapshots and clones on the renamed table.&lt;/p&gt;

&lt;p&gt;A simple implementation of rename in 0.94 is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
rename(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; oldTableName, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newTableName) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; snapshotName = randomName();
    snapshot(snapshotName, oldTableName);
    cloneSnapshot(snapshotName, newTableName);
    deleteSnapshot(snapshotName);
    deleteTable(oldTableName)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13621765" author="lhofhansl" created="Thu, 4 Apr 2013 04:35:32 +0000"  >&lt;p&gt;Moving to 0.94.8. Please move back if you feel otherwise.&lt;/p&gt;</comment>
                            <comment id="13660371" author="lhofhansl" created="Fri, 17 May 2013 06:03:33 +0000"  >&lt;p&gt;Moving to 0.94.9.&lt;br/&gt;
Can we just add Matteo&apos;s workaround to the book?&lt;/p&gt;</comment>
                            <comment id="13661177" author="stack" created="Sat, 18 May 2013 00:16:18 +0000"  >&lt;p&gt;I added it here: &lt;a href=&quot;http://hbase.apache.org/book.html#table.rename&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#table.rename&lt;/a&gt;  Works for 0.94 but not for 0.92.  Is that enough?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12396782">HBASE-643</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12584530" name="rename_table.rb" size="8209" author="mbertozzi" created="Thu, 23 May 2013 17:35:32 +0000"/>
                            <attachment id="12570499" name="rename_table.rb" size="8319" author="tychang" created="Fri, 22 Feb 2013 17:22:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Feb 2013 20:48:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313944</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i6cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314289</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>