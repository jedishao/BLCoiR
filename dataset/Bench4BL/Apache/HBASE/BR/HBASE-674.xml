<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:08:36 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-674/HBASE-674.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-674] memcache size unreliable</title>
                <link>https://issues.apache.org/jira/browse/HBASE-674</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Multiple updates against same row/column/ts will be seen as increments to cache size on insert but when we then play the memcache at flush time, we&apos;ll only see the most recent entry and decrement the memcache size by whatever its size; memcache will be off.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12397840">HBASE-674</key>
            <summary>memcache size unreliable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jimk">Jim Kellerman</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Jun 2008 20:54:33 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:17 +0000</updated>
                            <resolved>Fri, 4 Jul 2008 19:16:56 +0000</resolved>
                                    <version>0.1.2</version>
                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12603691" author="stack" created="Mon, 9 Jun 2008 21:18:51 +0000"  >&lt;p&gt;For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSizeCount() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    HStoreKey hsk = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Text(getName()),
      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Text(getName()), &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis());
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 3; i++) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hmemcache.add(hsk, HStoreKey.getBytes(hsk));
    }
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hmemcache.snapshot();
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hmemcache.getSnapshot().size());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The out.println in above says only one entry in the memcache though adding we added 3 items to the memcache size.&lt;/p&gt;

&lt;p&gt;Other issues here are that exceptions adding/deleting, etc., items can cause count to be off.  We add to stuff to the memcache size before successful add of item.&lt;/p&gt;</comment>
                            <comment id="12603695" author="stack" created="Mon, 9 Jun 2008 21:30:17 +0000"  >&lt;p&gt;Issue is a regionserver that is stuck with the block gate down.  I can see it flushing over time but the memcache size continues to crawl until its at maximum and then never goes down in spite of fact we&apos;ve been regularly flushing.  Our math is obviously off... See here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-06-05 23:29:54,872 DEBUG org.apache.hadoop.hbase.HRegion: Started memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region enwiki_meta,4xm9tOa_JLlpDI7EFNz4OF==,1212282770124. Current region memcache size 10.7m
2008-06-05 23:29:56,246 DEBUG org.apache.hadoop.hbase.HStore: Added /hbase/aa0-005-2.u.powerset.com/enwiki_meta/1966274647/alternate_title/mapfiles/7141575363599707225 with 4 entries, sequence id 1109246475, data size 290.0
2008-06-05 23:29:56,444 DEBUG org.apache.hadoop.hbase.HStore: Added /hbase/aa0-005-2.u.powerset.com/enwiki_meta/1966274647/misc/mapfiles/8160270909949078904 with 39 entries, sequence id 1109246475, data size 2.3k
2008-06-05 23:29:56,661 DEBUG org.apache.hadoop.hbase.HStore: Added /hbase/aa0-005-2.u.powerset.com/enwiki_meta/1966274647/alternate_url/mapfiles/3974349317844214611 with 4 entries, sequence id 1109246475, data size 398.0
2008-06-05 23:29:56,889 DEBUG org.apache.hadoop.hbase.HStore: Added /hbase/aa0-005-2.u.powerset.com/enwiki_meta/1966274647/page/mapfiles/5684117091377129929 with 117 entries, sequence id 1109246475, data size 87.0k
2008-06-05 23:29:56,890 DEBUG org.apache.hadoop.hbase.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region enwiki_meta,4xm9tOa_JLlpDI7EFNz4OF==,1212282770124 in 2019ms, sequence id=1109246475
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See how we are at 10.7M when flush starts but how if you count up all that was flushed, we flushed 90k odd.&lt;/p&gt;</comment>
                            <comment id="12603699" author="jimk" created="Mon, 9 Jun 2008 21:36:14 +0000"  >&lt;p&gt;Good catch! &lt;/p&gt;

&lt;p&gt;We should probably update the memcache size with each update, and if we are overwriting a previous update we need to take that into account.&lt;/p&gt;</comment>
                            <comment id="12603704" author="ningli" created="Mon, 9 Jun 2008 21:42:27 +0000"  >&lt;p&gt;Would it be better if HStore&apos;s mem cache computes/maintains its own memory size/usage? When a region needs its memory size, it sums from all its stores instead increasing a count during update and subtracting after flush.&lt;/p&gt;</comment>
                            <comment id="12603708" author="stack" created="Mon, 9 Jun 2008 21:52:11 +0000"  >&lt;p&gt;Ning: Agree.&lt;/p&gt;

&lt;p&gt;I think for 0.1 branch, I&apos;ll just set memcache size to zero after successful flush. Will do better fix for 0.2.&lt;/p&gt;</comment>
                            <comment id="12603710" author="stack" created="Mon, 9 Jun 2008 22:09:47 +0000"  >&lt;p&gt;Here&apos;s a crude patch for 0.1; just zeros memcache size on successful flush (needed internally).  Lets do something better in TRUNK.&lt;/p&gt;</comment>
                            <comment id="12603718" author="stack" created="Mon, 9 Jun 2008 22:33:09 +0000"  >&lt;p&gt;Committed patch to branch.&lt;/p&gt;</comment>
                            <comment id="12603721" author="stack" created="Mon, 9 Jun 2008 22:49:48 +0000"  >&lt;p&gt;I applied to branch something that had fewer changes after tesitng on cluster to make sure flushing worked as it used to.&lt;/p&gt;</comment>
                            <comment id="12609341" author="jimk" created="Mon, 30 Jun 2008 19:51:29 +0000"  >&lt;p&gt;While this is an important issue, it is not a blocker for 0.2.0&lt;/p&gt;</comment>
                            <comment id="12609705" author="viper799" created="Tue, 1 Jul 2008 20:54:35 +0000"  >&lt;p&gt;I thank this should be a blocker for 2.0 as it causes problems on long running jobs and region server that have been online for a while.&lt;/p&gt;

&lt;p&gt;What I am seeing is the last line of the flush like the below log lines has the memcache size on the end after the flush. this grows with every flush that has data in it. &lt;/p&gt;

&lt;p&gt;The problem comes up with the region server thanks the memcache is &amp;gt; then hbase.hregion.memcache.flush.size then it starts flushing back to back with little or nothing &lt;br/&gt;
to flush when it starts doing this on my servers the region server hangs and is needed to be restarted after killing it with a kill -9 pid.&lt;/p&gt;

&lt;p&gt;Also a side note I do see flushes back to back on region server that only have one or two regions I see a memcache flush then 1-3 more of the same region back to back then its ok but this seams to go away after the region server host more then 4 region.&lt;/p&gt;

&lt;p&gt;Logs from a few days ago:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-06-25 21:02:20,632 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 10604ms, sequence id=1973821, 17.0m
2008-06-25 21:02:20,633 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 1ms, sequence id=1973822, 17.0m
2008-06-25 21:02:21,478 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 842ms, sequence id=1973832, 17.4m
2008-06-25 21:02:22,896 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 1408ms, sequence id=1976711, 17.8m
2008-06-25 21:11:20,979 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 16988ms, sequence id=3827578, 52.0m
hbase restarted
2008-06-25 21:16:18,004 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 10336ms, sequence id=4817365, 17.0m
2008-06-25 21:16:18,408 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 404ms, sequence id=4817378, 17.0m
2008-06-25 21:16:19,838 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 1421ms, sequence id=4817952, 17.7m
2008-06-25 21:19:01,512 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 9692ms, sequence id=5661153, 32.8m
2008-06-25 21:19:01,821 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 308ms, sequence id=5661169, 32.8m
2008-06-25 21:19:04,261 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 2439ms, sequence id=5661523, 33.4m
2008-06-25 21:19:05,317 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 1052ms, sequence id=5666391, 33.5m
2008-06-25 21:49:21,616 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 14214ms, sequence id=7415697, 64.7m
2008-06-25 21:49:22,369 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 738ms, sequence id=7415798, 64.7m
2008-06-25 21:49:22,373 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214427652459 in 4ms, sequence id=7415800, 64.7m
hbase restarted
2008-06-25 22:54:33,665 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 11168ms, sequence id=9238125, 19.5m
2008-06-25 22:54:34,248 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 582ms, sequence id=9241589, 19.7m
2008-06-25 22:54:34,989 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 740ms, sequence id=9242882, 19.8m
2008-06-25 22:54:35,749 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 759ms, sequence id=9244773, 19.8m
2008-06-25 22:54:36,619 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 869ms, sequence id=9247214, 19.8m
2008-06-25 22:54:37,657 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 1031ms, sequence id=9249946, 20.0m
2008-06-25 23:14:29,857 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 13549ms, sequence id=12776517, 53.0m
hbase restart
2008-06-25 23:21:25,013 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 13706ms, sequence id=14457037, 20.2m
2008-06-25 23:21:25,508 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 494ms, sequence id=14474826, 20.2m
2008-06-25 23:21:26,353 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 844ms, sequence id=14475821, 20.3m
2008-06-25 23:21:27,208 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 854ms, sequence id=14478027, 20.3m
2008-06-25 23:21:27,816 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 607ms, sequence id=14481138, 20.3m
2008-06-25 23:21:28,609 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 791ms, sequence id=14483523, 20.3m
2008-06-25 23:21:29,234 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 623ms, sequence id=14485701, 20.3m
2008-06-25 23:21:31,459 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 2223ms, sequence id=14487619, 20.6m
2008-06-25 23:21:32,546 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 1079ms, sequence id=14496978, 20.8m
2008-06-25 23:24:36,701 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 3432ms, sequence id=15103902, 27.4m
hbase restarted
2008-06-25 23:28:18,288 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214448561806 in 1ms, sequence id=15103936, 0.0
2008-06-25 23:28:19,151 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 0ms, sequence id=15103937, 0.0
2008-06-25 23:45:43,021 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 14039ms, sequence id=19210706, 23.6m
2008-06-25 23:45:43,285 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 264ms, sequence id=19226471, 23.6m
2008-06-25 23:45:44,016 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 730ms, sequence id=19227141, 23.6m
2008-06-25 23:45:45,481 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 1464ms, sequence id=19229633, 23.7m
2008-06-25 23:45:46,474 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 990ms, sequence id=19234660, 23.8m
2008-06-25 23:47:56,208 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,com.wallbuilders.www%2FLIBissuesArticles.asp%3Fid%3D45%3Ahttp467123 in 759ms, sequence id=19961148, 21.7m
2008-06-25 23:55:07,552 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214454498285 in 5795ms, sequence id=22333011, 41.4m
hbase restarted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12609707" author="viper799" created="Tue, 1 Jul 2008 20:56:51 +0000"  >&lt;p&gt;I currently run jobs in smaller batches and restart hbase after abotu 20 small jobs inserting about 500K cells per job on one region server.&lt;/p&gt;

&lt;p&gt;If we want to get 2.0 out then this should be a blocker in 2.1&lt;/p&gt;</comment>
                            <comment id="12609804" author="stack" created="Wed, 2 Jul 2008 06:03:14 +0000"  >&lt;p&gt;Bringing this back into 0.2 because of the Billy comments.  Should be easy enough to reproduce.&lt;/p&gt;</comment>
                            <comment id="12610088" author="jimk" created="Wed, 2 Jul 2008 23:46:01 +0000"  >&lt;p&gt;There are a number of issues here:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;multiple inserts or deletes for the same row/colum/timestamp are counted and can inflate the memcache size some. This may not be a big issue because it is unlikely that someone is using the same row/column/timestamp especially if they do not specify a timestamp for puts or deletes.&lt;/li&gt;
	&lt;li&gt;because of the inaccuracies of the above, subtracting the actual number of flushed bytes from the memcache size leads to the potential of the memcache size growing over time if fewer bytes are flushed than what HRegion thinks is is the memcache. What we really need to do is keep track of both updates and memcache size, so that during a flush, we accumulate the size of updates that are taken after the snapshot. When the flush is completed, we can set the size of the memcache to the number of bytes submitted as updates during the flush.&lt;/li&gt;
	&lt;li&gt;why the memcache size seems to be going negative more frequently recently is somewhat of a mystery. It is pretty easy to understand why we might flush less than what we think is in the cache, but how would we flush more than what we think is in the cache.&lt;/li&gt;
	&lt;li&gt;Finally I don&apos;t particularly like the finished memcache flush message in HRegion. It reports what it thinks is the current memcache size after the flush, but doesn&apos;t say that. It would lead the casual observer to think that the size reported by HRegion after the flush is the number of bytes flushed from the cache.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12610437" author="jimk" created="Fri, 4 Jul 2008 03:13:37 +0000"  >&lt;p&gt;Memcache.add now computes the delta size of the memcache (so if multiple updates are made to the same row/column/timestamp, they are correctly accounted for)&lt;/p&gt;

&lt;p&gt;HStore.add returns the value from Memcache.add&lt;/p&gt;

&lt;p&gt;HRegion.internalFlushCache now zeros the memcache size while it has updates locked out. Because of this, the memcache size will reflect the size of the updates that happened since the flush started. Additionally, at the end of a cache flush it reports the number of bytes flushed and not the number of bytes currently in the memcache.&lt;/p&gt;

&lt;p&gt;memcache size is now updated based on the value returned from HStore.add (which is computed by Memcache.add&lt;/p&gt;
</comment>
                            <comment id="12610440" author="jimk" created="Fri, 4 Jul 2008 03:14:11 +0000"  >&lt;p&gt;patch available. Please review.&lt;/p&gt;</comment>
                            <comment id="12610482" author="viper799" created="Fri, 4 Jul 2008 08:27:50 +0000"  >&lt;p&gt;I changed my flush size to 16MB from my default 128MB and run a large job here is some lines from the logs&lt;br/&gt;
also I added back StringUtils.humanReadableInt(this.memcacheSize.get()) on the end so I could see if the size was growing after every flush&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-07-04 03:09:46,684 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214968800601 in 5595ms, sequence id=237700684, 12.9m, 351.2k
2008-07-04 03:15:02,169 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214968800601 in 5741ms, sequence id=239128833, 13.4m, 188.1k
2008-07-04 03:15:04,145 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214968800601 in 1975ms, sequence id=239155758, 167.6k, 222.8k
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so the above looks good now the last number is the memcacheSize.get() and its moveing down and up so thats good to see I thank this patch solved my problem of the flushes.&lt;br/&gt;
I run the job for quite a while and flushes seams to happen normal in place of less time between flushes.&lt;/p&gt;

&lt;p&gt;The only other thing I see on this issue is the size before flush of the memcache is still off like the logs stack posted above&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-07-04 03:09:41,089 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Started memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214968800601. Current region memcache size 16.0m
2008-07-04 03:09:42,587 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Added /hbase/webdata/1748955538/anchor/mapfiles/5595070426400799233 with 29142 entries, sequence id 237700684, data size 3.7m, file size 507.2k
2008-07-04 03:09:43,719 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Added /hbase/webdata/1748955538/stime/mapfiles/4943615301545296809 with 2872 entries, sequence id 237700684, data size 154.9k, file size 24.3k
2008-07-04 03:09:45,197 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Added /hbase/webdata/1748955538/in_rank/mapfiles/367761225010760821 with 36409 entries, sequence id 237700684, data size 4.5m, file size 415.8k
2008-07-04 03:09:45,470 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Added /hbase/webdata/1748955538/size/mapfiles/6451240725630689572 with 2872 entries, sequence id 237700684, data size 135.9k, file size 28.4k
2008-07-04 03:09:46,683 DEBUG org.apache.hadoop.hbase.regionserver.HStore: Added /hbase/webdata/1748955538/last_seen/mapfiles/3472123077784461203 with 36410 entries, sequence id 237700684, data size 4.4m, file size 409.3k
2008-07-04 03:09:46,684 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region webdata,,1214968800601 in 5595ms, sequence id=237700684, 12.9m, 351.2k
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;16m is whats reported as the size before the flush and the total data flushed was 12.9m&lt;/p&gt;</comment>
                            <comment id="12610642" author="jimk" created="Fri, 4 Jul 2008 19:12:24 +0000"  >&lt;p&gt;Computing the memcache size is an approximation at best. If the memcache size is not growing over time, and causing OutOfMemoryExceptions, then I think this the best we can do for 0.2.0. If you think the accounting should be more accurate, please open an issue for 0.3.0.&lt;/p&gt;</comment>
                            <comment id="12610644" author="jimk" created="Fri, 4 Jul 2008 19:16:56 +0000"  >&lt;p&gt;Committed patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12383720" name="674-v2.patch" size="1465" author="stack" created="Mon, 9 Jun 2008 22:49:48 +0000"/>
                            <attachment id="12383716" name="674.patch" size="2800" author="stack" created="Mon, 9 Jun 2008 22:09:47 +0000"/>
                            <attachment id="12385266" name="patch.txt" size="6908" author="jimk" created="Fri, 4 Jul 2008 03:13:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 9 Jun 2008 21:36:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h8r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98680</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>