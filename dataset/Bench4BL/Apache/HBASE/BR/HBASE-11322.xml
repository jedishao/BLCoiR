<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 17:05:19 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11322/HBASE-11322.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11322] SnapshotHFileCleaner makes the wrong check for lastModified time thus causing too many cache refreshes</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11322</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The SnapshotHFileCleaner calls the SnapshotFileCache if a particular HFile in question is part of a snapshot.&lt;br/&gt;
If the HFile is not in the cache, we then refresh the cache and check again.&lt;/p&gt;

&lt;p&gt;But the cache refresh checks to see if anything has been modified since the last cache refresh but this logic is incorrect in certain scenarios.&lt;/p&gt;

&lt;p&gt;The last modified time is done via this operation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lastModifiedTime = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(dirStatus.getModificationTime(),
                                     tempStatus.getModificationTime());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the check to see if the snapshot directories have been modified:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the snapshot directory wasn&apos;t modified since we last check, we are done
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dirStatus.getModificationTime() &amp;lt;= lastModifiedTime &amp;amp;&amp;amp;
        tempStatus.getModificationTime() &amp;lt;= lastModifiedTime) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Suppose the following happens:&lt;br/&gt;
dirStatus modified 6-1-2014&lt;br/&gt;
tempStatus modified 6-2-2014&lt;/p&gt;

&lt;p&gt;lastModifiedTime = 6-1-2014&lt;/p&gt;

&lt;p&gt;provided these two directories don&apos;t get modified again all subsequent checks wont exit early, like they should.&lt;/p&gt;

&lt;p&gt;In our cluster, this was a huge performance hit.  The cleaner chain fell behind, thus almost filling up dfs and our namenode heap.&lt;/p&gt;

&lt;p&gt;Its a simple fix, instead of Math.min we use Math.max for the lastModified, I believe that will be correct.&lt;/p&gt;

&lt;p&gt;I&apos;ll apply a patch for you guys.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12720469">HBASE-11322</key>
            <summary>SnapshotHFileCleaner makes the wrong check for lastModified time thus causing too many cache refreshes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="churromorales">churro morales</assignee>
                                    <reporter username="churromorales">churro morales</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jun 2014 22:36:56 +0000</created>
                <updated>Mon, 28 Jul 2014 17:40:19 +0000</updated>
                            <resolved>Mon, 28 Jul 2014 17:39:48 +0000</resolved>
                                    <version>0.94.19</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="14027168" author="yuzhihong@gmail.com" created="Tue, 10 Jun 2014 22:46:33 +0000"  >&lt;p&gt;Can you provide patch for trunk ?&lt;/p&gt;

&lt;p&gt;refreshCache() in trunk is a bit different from that of 0.94&lt;/p&gt;</comment>
                            <comment id="14031460" author="lhofhansl" created="Sat, 14 Jun 2014 04:45:48 +0000"  >&lt;p&gt;Having a look now. Let&apos;s get this included.&lt;/p&gt;</comment>
                            <comment id="14031472" author="lhofhansl" created="Sat, 14 Jun 2014 05:12:02 +0000"  >&lt;p&gt;That doesn&apos;t seem right, though. I think to be correct we need to keep track of both timestamp and refresh if either has changed.&lt;/p&gt;</comment>
                            <comment id="14031480" author="lhofhansl" created="Sat, 14 Jun 2014 05:54:55 +0000"  >&lt;p&gt;Something like this.&lt;/p&gt;</comment>
                            <comment id="14031482" author="lhofhansl" created="Sat, 14 Jun 2014 06:06:16 +0000"  >&lt;p&gt;This is quite different in trunk. Not sure offhand whether it&apos;s correct there or not.&lt;/p&gt;</comment>
                            <comment id="14031486" author="churromorales" created="Sat, 14 Jun 2014 06:25:35 +0000"  >&lt;p&gt;Hi Lars, &lt;/p&gt;

&lt;p&gt;That is correct, but maybe I&apos;m missing something with the Math.max solution.&lt;/p&gt;

&lt;p&gt;Provided that if we say lastModifiedTime is the greater of the two modified times for the directories in question.  &lt;br/&gt;
And we say that when doing any given check, the maximum value that lastModifiedTime can have is the current timestamp.  &lt;br/&gt;
Then, if any of the directories is modified between the current check and the next subsequent check in the future.  Their respective modified times must be larger than the previous lastModifiedTime variable as long as the next check happens in the future.&lt;/p&gt;

&lt;p&gt;On the other hand maybe its late and I&apos;m not thinking of a condition where this could be incorrect.  &lt;br/&gt;
We applied the patch in production today and the cleaner could finally keep up without us having to manually step in and delete files manually from the archive directory.  Our namenode was finally happy and we stopped running out of dfs disk space.&lt;/p&gt;</comment>
                            <comment id="14031487" author="churromorales" created="Sat, 14 Jun 2014 06:27:11 +0000"  >&lt;p&gt;I believe if you can take the Math.max instead of the Math.min in trunk and it would work as well.  I looked over it quickly but I think that will work too&lt;/p&gt;</comment>
                            <comment id="14031729" author="lhofhansl" created="Sat, 14 Jun 2014 23:00:48 +0000"  >&lt;p&gt;Hmm... True, assuming no races and or clock skew in any way you are correct.&lt;br/&gt;
I agree Math.max is fine too. Either way is fine with me. Keeping both times is more explicit and easier to reason about. Math.max on the other hand is simpler.&lt;/p&gt;

&lt;p&gt;+1 on Math.max if you like that better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14032664" author="churromorales" created="Mon, 16 Jun 2014 17:29:16 +0000"  >&lt;p&gt;Hi Lars, &lt;/p&gt;

&lt;p&gt;Just noticed this issue:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11360&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-11360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Might affect how we deal with our solution here.  Would love to hear what you think.&lt;/p&gt;</comment>
                            <comment id="14036492" author="lhofhansl" created="Wed, 18 Jun 2014 22:05:53 +0000"  >&lt;p&gt;Let&apos;s fix these two independently. You convinced that your suggested change here is correct. &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11360&quot; title=&quot;SnapshotFileCache causes too many cache refreshes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11360&quot;&gt;&lt;del&gt;HBASE-11360&lt;/del&gt;&lt;/a&gt; is an issue either way.&lt;/p&gt;</comment>
                            <comment id="14036525" author="churromorales" created="Wed, 18 Jun 2014 22:15:44 +0000"  >&lt;p&gt;Hi Lars, &lt;/p&gt;

&lt;p&gt;The fix is correct, but the fix revealed the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11360&quot; title=&quot;SnapshotFileCache causes too many cache refreshes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11360&quot;&gt;&lt;del&gt;HBASE-11360&lt;/del&gt;&lt;/a&gt; bug.&lt;/p&gt;

&lt;p&gt;Suppose the following happens:&lt;br/&gt;
1. We take a snapshot&lt;br/&gt;
2. It creates /hbase/.hbase-snapshot/.tmp/&amp;lt;someSnapshot&amp;gt; directory and starts populating files&lt;br/&gt;
3. We have a cleaner run the cache refreshes notices the .tmp directory has changed and changes the lastModified to that value&lt;br/&gt;
4. A region server is snapshotting and right after it finishes it finishes compacting some store files too.&lt;br/&gt;
5. Next time the cleaner runs it will not refresh the cache as the timestamp for the .tmp directory has not changed but files have been added since the last run.&lt;br/&gt;
6. Cleaner deletes the archived HFile in question and snapshot fails. &lt;/p&gt;

&lt;p&gt;With the old code, this probably wasn&apos;t noticed as much as the snapshot and the .tmp directories had different timestamps and the logic was incorrect in lastModified and thus a cache refresh always happened.&lt;/p&gt;

&lt;p&gt;We have been running with the cleaner logic for about a week and its fine (its no longer slow), but to get around this issue after snapshotting: &lt;br/&gt;
We touched a file and removed from the .tmp directory to force the cache refresh.   &lt;br/&gt;
5. &lt;/p&gt;</comment>
                            <comment id="14036528" author="lhofhansl" created="Wed, 18 Jun 2014 22:17:58 +0000"  >&lt;p&gt;Let&apos;s change min to max in all branches to get this into 0.94.21.&lt;/p&gt;

&lt;p&gt;Edit: Just saw the last comment... OK, we need to fix these together.&lt;/p&gt;</comment>
                            <comment id="14036539" author="churromorales" created="Wed, 18 Jun 2014 22:20:53 +0000"  >&lt;p&gt;I agree, &lt;/p&gt;

&lt;p&gt;If we only fix this one only then we give people a new bug to enjoy &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I feel both are necessary&lt;/p&gt;</comment>
                            <comment id="14036542" author="lhofhansl" created="Wed, 18 Jun 2014 22:21:13 +0000"  >&lt;p&gt;Now... Would this be fixed if we kept the separate timestamps for snapshot and tmp directories as in my first suggestion?&lt;br/&gt;
(I&apos;m actually not really familiar with how this works and bit pressed for time, hence the question instead of just checking it out myself... Sorry)&lt;/p&gt;</comment>
                            <comment id="14036545" author="churromorales" created="Wed, 18 Jun 2014 22:23:04 +0000"  >&lt;p&gt;No worries, &lt;/p&gt;

&lt;p&gt;If you have 2 different timestamps &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11360&quot; title=&quot;SnapshotFileCache causes too many cache refreshes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11360&quot;&gt;&lt;del&gt;HBASE-11360&lt;/del&gt;&lt;/a&gt; is still a problem.  The cache refresh works but the modified timestamp is still incorrect as it will only get the TS of the time the snapshot was started not the time it completed (I believe)&lt;/p&gt;</comment>
                            <comment id="14037841" author="lhofhansl" created="Thu, 19 Jun 2014 20:40:12 +0000"  >&lt;p&gt;Let&apos;s push this to 0.94.22 as we&apos;re still discussing.&lt;/p&gt;</comment>
                            <comment id="14076444" author="lhofhansl" created="Mon, 28 Jul 2014 17:39:48 +0000"  >&lt;p&gt;Marking as dup of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11360&quot; title=&quot;SnapshotFileCache causes too many cache refreshes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11360&quot;&gt;&lt;del&gt;HBASE-11360&lt;/del&gt;&lt;/a&gt;, which would this issue as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12721459">HBASE-11360</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12650440" name="11322.94.txt" size="1767" author="lhofhansl" created="Sat, 14 Jun 2014 05:54:55 +0000"/>
                            <attachment id="12649685" name="HBASE-11322.patch" size="1105" author="churromorales" created="Tue, 10 Jun 2014 22:37:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 10 Jun 2014 22:46:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398668</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wmvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398792</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>