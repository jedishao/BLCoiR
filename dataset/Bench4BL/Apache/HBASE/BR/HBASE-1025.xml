<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:29:06 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1025/HBASE-1025.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1025] Reconstruction log playback has no bounds on memory used</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1025</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Makes a TreeMap and just keeps adding edits without regard for size of edits applied; could cause OOME (I&apos;ve not seen a definitive case though have seen an OOME around time of a reconstructionlog replay &amp;#8211; perhaps this the straw that broke the fleas antlers?)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12409097">HBASE-1025</key>
            <summary>Reconstruction log playback has no bounds on memory used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                            <label>moved_from_0_20_5</label>
                    </labels>
                <created>Sun, 23 Nov 2008 22:52:56 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:38 +0000</updated>
                            <resolved>Fri, 16 Jul 2010 23:01:15 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12866819" author="stack" created="Wed, 12 May 2010 23:48:34 +0000"  >&lt;p&gt;Bulk move of 0.20.5 issues into 0.21.0 after vote that we merge branch into TRUNK up on list.&lt;/p&gt;</comment>
                            <comment id="12877843" author="stack" created="Fri, 11 Jun 2010 16:09:44 +0000"  >&lt;p&gt;This might not be too bad.  How replay of edits is done was changed a while back by Clint (IIRC).  He inserts straight into memstore where before we made a special instance of a memstore to put recovered edits into and we flushed that.  The flusher is running at time of log replay so it should trigger if memstores exceed configured sizes.&lt;/p&gt;

&lt;p&gt;While in here, I changed the way we do replay of edits so its done once at the region level rather than once per column family.  It makes things cleaner and easier to think about.&lt;/p&gt;

&lt;p&gt;This patch does not have the tests needed:&lt;/p&gt;

&lt;p&gt;1. Verification that indeed the flusher will run if exceed memstore configured flush size&lt;br/&gt;
2. Verfication that edits are recovered particularly in multi family case&lt;/p&gt;

&lt;p&gt;There is already an issue to test that deletes are recovered properly.  Can verify deletes over in that issue.&lt;/p&gt;</comment>
                            <comment id="12878362" author="stack" created="Sun, 13 Jun 2010 08:17:18 +0000"  >&lt;p&gt;So, replaying edits previously, we were not writing the WAL, we were not filling in the new consistency ts, we were not keeping account of size so we knew when to flag flush, etc.&lt;/p&gt;

&lt;p&gt;This patch calls HRegion#put and HRegion#delete adding the edits from the replay log rather than add edits direct to memstore (w/o an accounting in WAL so that is we successfully played all edits but crashed before we flushed, we&apos;d lose the edits permanently).  Calling HRegion#put and delete is profligate in object creation but it&apos;ll be more &apos;correct&apos;.  It also triggers flush if memstore grows too large.&lt;/p&gt;

&lt;p&gt;I added to test assertion flushes are happening and that deletes make it across splits.&lt;/p&gt;

&lt;p&gt;We are losing edits though, even when number is small.  Its probably some timestamping issue.  Will figure it out.&lt;/p&gt;

&lt;p&gt;Also need to figure what to do if we crash mid-replay AFTER a flush has happened.  Might worry about this in separate issue.&lt;/p&gt;
</comment>
                            <comment id="12878423" author="stack" created="Sun, 13 Jun 2010 19:10:45 +0000"  >&lt;p&gt;Lost edits was actually in interesting issue having to do w/ sequenceids (I love unit tests!)  Here is v3.  Let me give it one more review.. then will post to review.hbase.org.&lt;/p&gt;</comment>
                            <comment id="12878690" author="stack" created="Mon, 14 Jun 2010 18:41:16 +0000"  >&lt;p&gt;Here is patch to add to review board:&lt;/p&gt;

&lt;p&gt;+ Moved replay of edits up from Store up into Region.   This means we play the edits once only rather than once per Store.&lt;br/&gt;
+ Lots of cleanup in the replay of edits code.  Uses the new flag introduced by cosmin &amp;#8211; hbase.skip.errors.   If set, and exception processing edits, we&apos;ll fail.  If false, we&apos;ll move the broke edits file aside and keep going.  Renamed the method from doReconstructionLog to replayRecoveredEdits (reconstruction?).&lt;br/&gt;
+ The main change in this patch is that recovering edits, we now go in via the HRegion main API doing put and delete so that only one code path, so replayed edits are added to the WAL, and so a flush will be triggered if we fill memory.&lt;br/&gt;
+ In HStore, lots of removed code and comments since no longer does log replay.  Cleanup of maximum seqid.  Calculate it instead rather than save as a data member.  Its only used once on HRegion startup.&lt;br/&gt;
+ Change the HRegion#initialize.  It used to take &apos;initial files&apos; which is a notion never used (it was a means of putting files in place after a split but split is done internal to HRegion so can do things in HRegions guts w/o need of exposing notion of initial files).  I removed it and added overload that takes no args which is the usual way this method is invoked.&lt;br/&gt;
+ Rename the product of splits, &apos;recovered.edits&apos; instead of &apos;oldlogfile.log&apos;&lt;br/&gt;
+ Added small facility to HBaseTestingUtility for creating different user in a Configuration so can have more than one Filesystem instance the easier.&lt;br/&gt;
+ Redid the test TestStoreReconstruction as TestWALReplay.&lt;/p&gt;</comment>
                            <comment id="12878695" author="hbasereviewboard" created="Mon, 14 Jun 2010 18:46:13 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;+ Moved replay of edits up from Store up into Region. This means we play the edits once only rather than once per Store.&lt;br/&gt;
+ Lots of cleanup in the replay of edits code. Uses the new flag introduced by cosmin &#8211; hbase.skip.errors. If set, and exception processing edits, we&apos;ll fail. If false, we&apos;ll move the broke edits file aside and keep going. Renamed the method from doReconstructionLog to replayRecoveredEdits (reconstruction?).&lt;br/&gt;
+ The main change in this patch is that recovering edits, we now go in via the HRegion main API doing put and delete so that only one code path, so replayed edits are added to the WAL, and so a flush will be triggered if we fill memory.&lt;br/&gt;
+ In HStore, lots of removed code and comments since no longer does log replay. Cleanup of maximum seqid. Calculate it instead rather than save as a data member. Its only used once on HRegion startup.&lt;br/&gt;
+ Change the HRegion#initialize. It used to take &apos;initial files&apos; which is a notion never used (it was a means of putting files in place after a split but split is done internal to HRegion so can do things in HRegions guts w/o need of exposing notion of initial files). I removed it and added overload that takes no args which is the usual way this method is invoked.&lt;br/&gt;
+ Rename the product of splits, &apos;recovered.edits&apos; instead of &apos;oldlogfile.log&apos;&lt;br/&gt;
+ Added small facility to HBaseTestingUtility for creating different user in a Configuration so can have more than one Filesystem instance the easier.&lt;br/&gt;
+ Redid the test TestStoreReconstruction as TestWALReplay.&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-1025.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/hbase-1025&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/hbase-1025&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/HConstants.java f5d3e94 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/HMerge.java 62f3561 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 06e022c &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java bca819e &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 2a0dcee &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java 05cf17f &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestCase.java dbb21d4 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java 479c661 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java 43a8a28 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreReconstruction.java 4f0417d &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestHLogSplit.java 86cf4ea &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestWALReplay.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.hbase.org/r/179/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;stack&lt;/p&gt;

</comment>
                            <comment id="12878700" author="stack" created="Mon, 14 Jun 2010 19:01:30 +0000"  >&lt;p&gt;Talked to Kannan about comment in the replay log method around next:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
I think the comment I added is not valid considering that logReader.next() is working on split files. I think we should assume here that the split happens successfully at the master, and that the split files should be clean at the end.

The &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; that I am not very certain about is what happens &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; master dies in the middle of the split. Is the oldfile.log in a potentially invalid state? How &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; we cleanly restart the split-- without the RS starting to work on a half-done file?

In any &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, in logReader.next() (in Store.java:doReconstructionLog()) I think it is the right model to assume we have clean/valid log files; and the burden of detecting partial files should be pushed to splitLog().
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll remove the comment on commit but will open new issue to see if we can add tests for case where splitter fails mid-write of files (new master should clean up old stuff and restart splitting).&lt;/p&gt;</comment>
                            <comment id="12878749" author="hbasereviewboard" created="Mon, 14 Jun 2010 21:18:39 +0000"  >&lt;p&gt;Message from: &quot;Todd Lipcon&quot; &amp;lt;todd@cloudera.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review216&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review216&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Regarding rewriting recovered edits back to the WAL, I&apos;m afraid we may have an issue with the following situation:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RS A writes edits 1-100 to log&lt;/li&gt;
	&lt;li&gt;RS A fails&lt;/li&gt;
	&lt;li&gt;RS B starts recovering log, rewrites edits 1-50&lt;/li&gt;
	&lt;li&gt;RS B fails while recovering&lt;/li&gt;
	&lt;li&gt;RS C starts up. It &lt;b&gt;should&lt;/b&gt; replay 1-100. Instead I fear it might only replay 1-50, or replay 1-100 followed by 1-50, either of which would be incorrect.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We should add a test case where the RS fails in the middle of recovering a prior failure.&lt;/p&gt;


&lt;p&gt;Also, replayRecoveredEdits returns the highest seqid from the logs. Is it possible for storeFiles to have a higher seqid than what&apos;s in the log in any situation? We should add some kind of assert perhaps.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment973&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment973&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    this returns -1 if there is nothing to replay. Shouldn&apos;t it return the maxSeqId + 1 perhaps?&lt;/p&gt;

&lt;p&gt;    Do we have a test which makes a region, writes some data, closes the region, opens the region, writes some data, then recovers logs?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment972&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment972&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    we used to print the sequence ID after the increment, now we print before the increment. Maybe change log to &quot;sequenceid for next edit will be NNN&quot;&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment975&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment975&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    add some javadoc - I think important to note that minSeqId is &lt;b&gt;exclusive&lt;/b&gt; - it&apos;s a little unintuitive. Perhaps makes more sense to pass in maxSeqIdFromStoreFiles+1 here, and make minSeqId be &quot;minimum sequence id, inclusive, to apply&quot;&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment976&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment976&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    should probably use LOG.error for these&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment974&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I agree, i don&apos;t think the splitter would ever write a partial one. We should treat an IOE here as a real error&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment977&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment977&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    when would this happen? deserves a comment I think&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment978&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment978&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    can we rename maxSeqIdInLog to currentEditSeqId or something? since that&apos;s what we&apos;re really talking about here. Also reversing this inequality to: if (currentEditSeqId &amp;lt; storeMaxSeqId&amp;gt;) I think it would read more clearly&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment979&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment979&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think this will crash when the region contains stores that were the result of an HFOF bulk load (they have no sequence id)&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment980&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment980&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    maybe rename to restoreEdit() or something to be clear that this is during restoration only?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment981&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment981&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    possibly more efficient:&lt;br/&gt;
    Collections.singletonMap(kv.getFamily(), Collections.singletonList(kv))&lt;/p&gt;

&lt;p&gt;    though there may be a comparator issue?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment970&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment970&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    comment is now out of date, right?&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment971&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment971&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    maybe just Preconditions.checkArgument here so it throws if you try to pass a non-DFS?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Todd&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12878781" author="hbasereviewboard" created="Mon, 14 Jun 2010 22:34:20 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Regarding rewriting recovered edits back to the WAL, I&apos;m afraid we may have an issue with the following situation:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; - RS A writes edits 1-100 to log&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; - RS A fails&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; - RS B starts recovering log, rewrites edits 1-50&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; - RS B fails while recovering&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; - RS C starts up. It &lt;b&gt;should&lt;/b&gt; replay 1-100. Instead I fear it might only replay 1-50, or replay 1-100 followed by 1-50, either of which would be incorrect.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; We should add a test case where the RS fails in the middle of recovering a prior failure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Also, replayRecoveredEdits returns the highest seqid from the logs. Is it possible for storeFiles to have a higher seqid than what&apos;s in the log in any situation? We should add some kind of assert perhaps.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;On your scenario, yes, there is a hole.  Sorry, meant to point it out.  Was going to file issue after this went in (Previous to this patch we&apos;d have lost all 1-100 so this is at least an improvement).  Currently, there is no means for C to startup and replay 1-100.  It has no access to the recovered edits that B was processing.  As is, it&apos;ll replay 1-50 from the split of B&apos;s WAL log.  The splitter needs to look for recovered.edits files and merge them in for C on startup.&lt;/p&gt;


&lt;p&gt;&quot;Is it possible for storeFiles to have a higher seqid than what&apos;s in the log in any situation?&quot;&lt;/p&gt;

&lt;p&gt;Should not happen but going to add check for it and use the max from store files if its larger than whats in logs.  Let me add test for this too.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 359&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line359&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line359&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     this returns -1 if there is nothing to replay. Shouldn&apos;t it return the maxSeqId + 1 perhaps?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Do we have a test which makes a region, writes some data, closes the region, opens the region, writes some data, then recovers logs?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it should return the largest of maxSeqId and replayRecoveredEdits.  Let me add test.&lt;/p&gt;

&lt;p&gt;No test that writes edits into a (multifamily region), then opens it again and recovers (I made comment in test that we need such a thing).  Let me add a test to do this.  It&apos;ll likely flush out more sequenceid issues.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 378&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line378&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line378&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     we used to print the sequence ID after the increment, now we print before the increment. Maybe change log to &quot;sequenceid for next edit will be NNN&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1904&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1904&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1904&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     should probably use LOG.error for these&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1952&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1952&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1952&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I agree, i don&apos;t think the splitter would ever write a partial one. We should treat an IOE here as a real error&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1978&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1978&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1978&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     when would this happen? deserves a comment I think&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done (should never happen &amp;#8211; maybe schema gets changed between crash and replay?  I added this because in original j-d test he had some messing adding edit for family not in schema... I kept that messing and added a handler here.  If it goes into HRegion#put/#delete, it&apos;ll cause dirty exception).&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1985&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1985&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line1985&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     can we rename maxSeqIdInLog to currentEditSeqId or something? since that&apos;s what we&apos;re really talking about here. Also reversing this inequality to: if (currentEditSeqId &amp;lt; storeMaxSeqId&amp;gt;) I think it would read more clearly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2017&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2017&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2017&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think this will crash when the region contains stores that were the result of an HFOF bulk load (they have no sequence id)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You mean it will throw: throw new IllegalAccessError(&quot;Has not been initialized&quot;);?  Lets fix this.  Is this your bug from today?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2026&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2026&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2026&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     maybe rename to restoreEdit() or something to be clear that this is during restoration only?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2032&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2032&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2032&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     possibly more efficient:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Collections.singletonMap(kv.getFamily(), Collections.singletonList(kv))&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     though there may be a comparator issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, comparator issue for Map (used your singletonList suggestion though).&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 241&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1337#file1337line241&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1337#file1337line241&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     comment is now out of date, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java, line 850&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1340#file1340line850&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1340#file1340line850&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     maybe just Preconditions.checkArgument here so it throws if you try to pass a non-DFS?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review216&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review216&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12878787" author="hbasereviewboard" created="Mon, 14 Jun 2010 22:53:13 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-14 14:14:55, Todd Lipcon wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2017&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2017&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/1/?file=1335#file1335line2017&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think this will crash when the region contains stores that were the result of an HFOF bulk load (they have no sequence id)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;You mean it will throw: throw new IllegalAccessError(&quot;Has not been initialized&quot;);?  Lets fix this.  Is this your bug from today?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How will it crash?  If all storefiles are product of HFOF, then for the Store, the maxid will be 0 so all edits will go in.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review216&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review216&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12878790" author="hbasereviewboard" created="Mon, 14 Jun 2010 23:01:13 +0000"  >&lt;p&gt;Message from: &quot;Todd Lipcon&quot; &amp;lt;todd@cloudera.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review221&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review221&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1002&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1002&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    as discussed on IRC, HFOF in the new world order post-1923 will now throw an error if you ask for its sequence number. Need to check StoreFile.isBulkLoad() or whatever before calling maxsequenceid - if it&apos;s a bulk load it shouldn&apos;t take part in calculations for seqid recovery&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Todd&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12878804" author="hbasereviewboard" created="Mon, 14 Jun 2010 23:46:48 +0000"  >&lt;p&gt;Message from: &quot;Ryan Rawson&quot; &amp;lt;ryanobjc@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review223&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review223&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;generally speaking i like it.  The question is, how do we roll it up with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2727&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-2727&lt;/a&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ryan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12879123" author="hbasereviewboard" created="Tue, 15 Jun 2010 21:24:55 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-06-15 14:20:05.992588)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Main changes are:&lt;/p&gt;

&lt;p&gt;+ Implement all of Todds suggestions including adding a test to &apos;...which makes a region, writes some data, closes the region, opens the region, writes some data, then recovers logs?&apos; (see &apos;testReplayEditsWrittenViaHRegion&apos;) and adding a test that shows that the following will NOT happen: &apos;I think this will crash when the region contains stores that were the result of an HFOF bulk load (they have no sequence id)&apos; (see &apos;testRegionMadeOfBulkLoadedFilesOnly&apos;).&lt;/p&gt;

&lt;p&gt;+ Also some more cleanup around replayRecoveredEdits.  Should be easier to follow now.&lt;/p&gt;

&lt;p&gt;After this goes in, I&apos;ll start in on the work to address the scenario Todd outlines below.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;+ Moved replay of edits up from Store up into Region. This means we play the edits once only rather than once per Store.&lt;br/&gt;
+ Lots of cleanup in the replay of edits code. Uses the new flag introduced by cosmin &#8211; hbase.skip.errors. If set, and exception processing edits, we&apos;ll fail. If false, we&apos;ll move the broke edits file aside and keep going. Renamed the method from doReconstructionLog to replayRecoveredEdits (reconstruction?).&lt;br/&gt;
+ The main change in this patch is that recovering edits, we now go in via the HRegion main API doing put and delete so that only one code path, so replayed edits are added to the WAL, and so a flush will be triggered if we fill memory.&lt;br/&gt;
+ In HStore, lots of removed code and comments since no longer does log replay. Cleanup of maximum seqid. Calculate it instead rather than save as a data member. Its only used once on HRegion startup.&lt;br/&gt;
+ Change the HRegion#initialize. It used to take &apos;initial files&apos; which is a notion never used (it was a means of putting files in place after a split but split is done internal to HRegion so can do things in HRegions guts w/o need of exposing notion of initial files). I removed it and added overload that takes no args which is the usual way this method is invoked.&lt;br/&gt;
+ Rename the product of splits, &apos;recovered.edits&apos; instead of &apos;oldlogfile.log&apos;&lt;br/&gt;
+ Added small facility to HBaseTestingUtility for creating different user in a Configuration so can have more than one Filesystem instance the easier.&lt;br/&gt;
+ Redid the test TestStoreReconstruction as TestWALReplay.&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-1025.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/hbase-1025&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/hbase-1025&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/HConstants.java f5d3e94 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/HMerge.java 62f3561 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 06e022c &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java fe9aa8a &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 2a0dcee &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/StoreFile.java 05826f5 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java 05cf17f &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestCase.java dbb21d4 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java 479c661 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java 43a8a28 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreReconstruction.java 4f0417d &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestHLogSplit.java 86cf4ea &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestWALReplay.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.hbase.org/r/179/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;stack&lt;/p&gt;

</comment>
                            <comment id="12879668" author="hbasereviewboard" created="Thu, 17 Jun 2010 05:21:28 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review252&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review252&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Any chance of my getting a review on this one?  Its building block for subsequent fixes that need to go in.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12880981" author="stack" created="Tue, 22 Jun 2010 00:40:32 +0000"  >&lt;p&gt;Here is what I applied (copied over from review.hbase.org).&lt;/p&gt;</comment>
                            <comment id="12881441" author="hbasereviewboard" created="Tue, 22 Jun 2010 23:12:07 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review269&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;couple questions after reviewing.  didn&apos;t look at previous reviews first, so sorry if I duplicated commentary&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1131&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1131&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    don&apos;t you still want to keep around code to read oldlogfile.log &amp;amp; just remove write path?  We&apos;re not changing Log file format between 0.20=&amp;gt;0.21, so a customer should be able to cleanly upgrade.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1127&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    technically, it&apos;s -1 if no outstanding log edits exist.  you store the max sequence ID even if you skip all the edits.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1125&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1125&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    is there a use case for putting HDFS in safe mode, then running HBase with hbase.skip.errors do see the state of the cluster?  If so, fs.delete + fs.rename will both assert when this is played on cluster restart.  Maybe you want to catch both and print errors?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1128&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1128&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    do you want to update the currentEditSeqId even if it&apos;s from the wrong family?  just making sure.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1129&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1129&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    do we want the option to store this HLog for post-mortem in this case?  we&apos;re talking about CF-level, so this couldn&apos;t happen because of region splitting, right?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/#comment1130&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#comment1130&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    would it make more sense to have the interval be in seconds instead of count, then have the update give the edit count?  Or is the difference in restoring large edits (~50k) versus small ones inconsequential?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12882060" author="stack" created="Thu, 24 Jun 2010 06:09:42 +0000"  >&lt;p&gt;I made &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2784&quot; title=&quot;Address review of hbase-1025 comments that came in after the commit.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2784&quot;&gt;&lt;del&gt;HBASE-2784&lt;/del&gt;&lt;/a&gt; to address items raised above by Nicolas (Thanks for the review N).&lt;/p&gt;</comment>
                            <comment id="12882061" author="hbasereviewboard" created="Thu, 24 Jun 2010 06:12:51 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; couple questions after reviewing.  didn&apos;t look at previous reviews first, so sorry if I duplicated commentary&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for reviewing Nicolas.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/HConstants.java, line 143&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1356#file1356line143&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1356#file1356line143&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     don&apos;t you still want to keep around code to read oldlogfile.log &amp;amp; just remove write path?  We&apos;re not changing Log file format between 0.20=&amp;gt;0.21, so a customer should be able to cleanly upgrade.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the format has changed between 0.20 and 0.21, no? (we envelope all edits on a row now, for example, whereas in 0.20 we just did edits as they came in).&lt;/p&gt;

&lt;p&gt;So, to read in old WAL logs, we&apos;re talking migration &amp;#8211; reading w/ a class that understands old format and converting to the new.   But, at least in the past, the first requirement migrating has been a clean shutdown of old hbase cluster.  On clean shutdown, there should be no WAL present.   In other words we&apos;ve always gone out of our way for need migrating WALs across &lt;b&gt;major&lt;/b&gt; versions.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1897&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1897&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1897&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     technically, it&apos;s -1 if no outstanding log edits exist.  you store the max sequence ID even if you skip all the edits.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1921&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1921&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1921&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     is there a use case for putting HDFS in safe mode, then running HBase with hbase.skip.errors do see the state of the cluster?  If so, fs.delete + fs.rename will both assert when this is played on cluster restart.  Maybe you want to catch both and print errors?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let me add the suggested print.&lt;/p&gt;

&lt;p&gt;Regards what hbase does when FS under it flips out, there is &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2183&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-2183&lt;/a&gt; that is for looking into this.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1981&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1981&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line1981&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     do you want to update the currentEditSeqId even if it&apos;s from the wrong family?  just making sure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.  I think thats right thing to do.  As we move through the log the seqid is increasing regardless.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2002&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2002&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2002&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     do we want the option to store this HLog for post-mortem in this case?  we&apos;re talking about CF-level, so this couldn&apos;t happen because of region splitting, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This condition should never happen.  Only reason it might would be if schema was edited between log creation and new deploy.   It&apos;d be cumbersome adding a keep log at this stage of the processing.  Should I open an issue? &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2018&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2018&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2018&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     would it make more sense to have the interval be in seconds instead of count, then have the update give the edit count?  Or is the difference in restoring large edits (~50k) versus small ones inconsequential?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review269&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12882076" author="hbasereviewboard" created="Thu, 24 Jun 2010 07:17:11 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/HConstants.java, line 143&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1356#file1356line143&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1356#file1356line143&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     don&apos;t you still want to keep around code to read oldlogfile.log &amp;amp; just remove write path?  We&apos;re not changing Log file format between 0.20=&amp;gt;0.21, so a customer should be able to cleanly upgrade.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I think the format has changed between 0.20 and 0.21, no? (we envelope all edits on a row now, for example, whereas in 0.20 we just did edits as they came in).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;So, to read in old WAL logs, we&apos;re talking migration &amp;#8211; reading w/ a class that understands old format and converting to the new.   But, at least in the past, the first requirement migrating has been a clean shutdown of old hbase cluster.  On clean shutdown, there should be no WAL present.   In other words we&apos;ve always gone out of our way for need migrating WALs across &lt;b&gt;major&lt;/b&gt; versions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m assuming the batch edit for SequenceFile you&apos;re talking about is the jira kannan/aravind worked on?  I remember they made that patch backwards compatible.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review269&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12882079" author="hbasereviewboard" created="Thu, 24 Jun 2010 07:39:48 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 16:07:23, Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2002&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2002&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/diff/2/?file=1358#file1358line2002&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     do we want the option to store this HLog for post-mortem in this case?  we&apos;re talking about CF-level, so this couldn&apos;t happen because of region splitting, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This condition should never happen.  Only reason it might would be if schema was edited between log creation and new deploy.   It&apos;d be cumbersome adding a keep log at this stage of the processing.  Should I open an issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I definitely want to minimize code complexity for rare cases, but I&apos;ve applied too many patches that delete the phrase &apos;should never happen&apos; that it makes me want to have at least a half-baked plan to keep around the data for later analysis. Doing something like Log.error and then placing the entire log in a &apos;should_never_happen&apos; directory would be fine.  Maybe I&apos;m being overly-paranoid?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/179/#review269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/179/#review269&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12889386" author="stack" created="Fri, 16 Jul 2010 23:01:15 +0000"  >&lt;p&gt;This was committed a while back and just redone over in hbase-2727.&lt;/p&gt;</comment>
                            <comment id="15017856" author="lars_francke" created="Fri, 20 Nov 2015 13:01:38 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12467773">HBASE-2784</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12446970" name="1025-v2.txt" size="56894" author="stack" created="Sun, 13 Jun 2010 08:17:18 +0000"/>
                            <attachment id="12446987" name="1025-v3.txt" size="61181" author="stack" created="Sun, 13 Jun 2010 19:10:45 +0000"/>
                            <attachment id="12447051" name="1025-v5.patch" size="60926" author="stack" created="Mon, 14 Jun 2010 18:41:15 +0000"/>
                            <attachment id="12447640" name="1025-v8.txt" size="72513" author="stack" created="Tue, 22 Jun 2010 00:40:32 +0000"/>
                            <attachment id="12446875" name="1025.txt" size="32084" author="stack" created="Fri, 11 Jun 2010 16:09:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 14 Jun 2010 18:46:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25528</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0havr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>