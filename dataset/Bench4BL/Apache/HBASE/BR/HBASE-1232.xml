<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:36:58 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1232/HBASE-1232.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1232] zookeeper client wont reconnect if there is a problem</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1232</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;my regionserver got wedged:&lt;br/&gt;
2009-03-02 15:43:30,938 WARN org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Failed to create /hbase:&lt;br/&gt;
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /hbase&lt;br/&gt;
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:87)&lt;br/&gt;
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:35)&lt;br/&gt;
        at org.apache.zookeeper.ZooKeeper.create(ZooKeeper.java:482)&lt;br/&gt;
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.ensureExists(ZooKeeperWrapper.java:219)&lt;br/&gt;
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.ensureParentExists(ZooKeeperWrapper.java:240)&lt;br/&gt;
        at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.checkOutOfSafeMode(ZooKeeperWrapper.java:328)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRootRegion(HConnectionManager.java:783)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegion(HConnectionManager.java:468)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegion(HConnectionManager.java:443)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegionInMeta(HConnectionManager.java:518)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegion(HConnectionManager.java:477)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.relocateRegion(HConnectionManager.java:450)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.getRegionLocation(HConnectionManager.java:295)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.getRegionLocationForRowWithRetries(HConnectionManager.java:919)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.processBatchOfRows(HConnectionManager.java:950)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HTable.flushCommits(HTable.java:1370)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HTable.commit(HTable.java:1314)&lt;br/&gt;
        at org.apache.hadoop.hbase.client.HTable.commit(HTable.java:1294)&lt;br/&gt;
        at org.apache.hadoop.hbase.RegionHistorian.add(RegionHistorian.java:237)&lt;br/&gt;
        at org.apache.hadoop.hbase.RegionHistorian.add(RegionHistorian.java:216)&lt;br/&gt;
        at org.apache.hadoop.hbase.RegionHistorian.addRegionSplit(RegionHistorian.java:174)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegion.splitRegion(HRegion.java:607)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.CompactSplitThread.split(CompactSplitThread.java:174)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.CompactSplitThread.run(CompactSplitThread.java:107)&lt;/p&gt;


&lt;p&gt;this message repeats over and over.  &lt;/p&gt;

&lt;p&gt;Looking at the code in question:&lt;br/&gt;
  private boolean ensureExists(final String znode) {&lt;br/&gt;
    try &lt;/p&gt;
{
      zooKeeper.create(znode, new byte[0],
                       Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
      LOG.debug(&quot;Created ZNode &quot; + znode);
      return true;
    }
&lt;p&gt; catch (KeeperException.NodeExistsException e) &lt;/p&gt;
{
      return true;      // ok, move on.
    }
&lt;p&gt; catch (KeeperException.NoNodeException e) &lt;/p&gt;
{
      return ensureParentExists(znode) &amp;amp;&amp;amp; ensureExists(znode);
    }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
      LOG.warn(&quot;Failed to create &quot; + znode + &quot;:&quot;, e);
    }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
      LOG.warn(&quot;Failed to create &quot; + znode + &quot;:&quot;, e);
    }
&lt;p&gt;    return false;&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;We need to catch this exception specifically and reopen the ZK connection.&lt;/p&gt;</description>
                <environment>&lt;p&gt;java 1.7, zookeeper 3.0.1&lt;/p&gt;</environment>
        <key id="12415968">HBASE-1232</key>
            <summary>zookeeper client wont reconnect if there is a problem</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nitay">Nitay Joffe</assignee>
                                    <reporter username="ryanobjc">ryan rawson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Mar 2009 23:46:39 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:26 +0000</updated>
                            <resolved>Mon, 30 Mar 2009 01:15:20 +0000</resolved>
                                                    <fixVersion>0.20.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12682598" author="nitay" created="Tue, 17 Mar 2009 08:45:30 +0000"  >&lt;p&gt;Ryan, any hints on how to reproduce and cause this SessionExpired?&lt;/p&gt;</comment>
                            <comment id="12682643" author="tomstrummer" created="Tue, 17 Mar 2009 11:37:19 +0000"  >&lt;p&gt;I had this issue (not using HBase) and asked the ZK user list.  Apparently &quot;session expired&quot; occurs occasionally and it is fatal to that ZK client instance - you have to recover by creating a new ZK client instance.  &lt;/p&gt;

&lt;p&gt;See my thread here:&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/hadoop-zookeeper-user/200902.mbox/%3Cd8cb87ee0902121058u54d77780p47c7cd6f72878a02@mail.gmail.com%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/hadoop-zookeeper-user/200902.mbox/%3Cd8cb87ee0902121058u54d77780p47c7cd6f72878a02@mail.gmail.com%3E&lt;/a&gt;&lt;br/&gt;
(Unfortunately there&apos;s no good view to see the entire thread, use the &quot;thread&quot; links at the top right of the page.)&lt;/p&gt;</comment>
                            <comment id="12682801" author="nitay" created="Tue, 17 Mar 2009 21:00:11 +0000"  >&lt;p&gt;Thanks for the info Tom, that helps clear up a lot. I&apos;ll see if there&apos;s a way to deterministically recreate this case in a unit test.&lt;/p&gt;</comment>
                            <comment id="12683114" author="nitay" created="Wed, 18 Mar 2009 17:58:35 +0000"  >&lt;p&gt;Found a way to recreate it in the tests thanks to help of folks in #zookeeper:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/hadoop/ZooKeeper/FAQ#4&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/hadoop/ZooKeeper/FAQ#4&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12683764" author="nitay" created="Fri, 20 Mar 2009 06:27:06 +0000"  >&lt;p&gt;Ryan getting this even in tests.&lt;/p&gt;</comment>
                            <comment id="12688578" author="nitay" created="Tue, 24 Mar 2009 06:01:35 +0000"  >&lt;p&gt;When a SessionExpired occurs we will lose our ephemeral nodes. This means everyone else in the cluster will think that node is down. To fix this we need to restart the node completely.&lt;/p&gt;

&lt;p&gt;For example, if the master&apos;s connection to ZooKeeper throws SessionExpired it loses its ephemeral address node in ZooKeeper and everyone will think the master has died. In fact, another master may come up now that we have the HA master lock.&lt;/p&gt;</comment>
                            <comment id="12689750" author="nitay" created="Thu, 26 Mar 2009 23:56:45 +0000"  >&lt;p&gt;The idea in this patch is to have the client HConnection, that is TableServers, watch for the SessionExpired event and do the right thing. After looking over the code a bit, I think the right thing to do is to clear out the ZooKeeperWrapper being used (that handle is now dead anyways) so that the next time getZooKeeperWrapper() is called it will instantiate a new handle.&lt;/p&gt;

&lt;p&gt;Please particularly check if this introduces any concurrency issues. I think it&apos;s safe, but it&apos;d be nice to get some validation.&lt;/p&gt;

&lt;p&gt;In detail:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add getZooKeeperWrapper() to HConnection&lt;/li&gt;
	&lt;li&gt;TableServers now implements Watcher.&lt;/li&gt;
	&lt;li&gt;Add getSessionID() and getSessionPassword() to ZooKeeperWrapper to test SessionExpired.&lt;/li&gt;
	&lt;li&gt;Add getQuorumPeers() to MiniZooKeeperCluster to get ZooKeeper quorum in tests.&lt;/li&gt;
	&lt;li&gt;Added test that causes client&apos;s ZooKeeper session to expire.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12689765" author="nitay" created="Fri, 27 Mar 2009 00:43:37 +0000"  >&lt;p&gt;Bumping down &quot;zookeeper.session.timeout&quot; to 2 seconds from 10 broke some other tests. This patch undoes that part. Will open another JIRA to investigate why that change breaks things.&lt;/p&gt;</comment>
                            <comment id="12693627" author="apurtell" created="Mon, 30 Mar 2009 00:13:06 +0000"  >&lt;p&gt;I tried out the v2 patch and encountered no problems or test failures. Commit?&lt;/p&gt;</comment>
                            <comment id="12693629" author="nitay" created="Mon, 30 Mar 2009 00:28:48 +0000"  >&lt;p&gt;Sounds good to me. Thanks for trying it out.&lt;/p&gt;</comment>
                            <comment id="12693632" author="apurtell" created="Mon, 30 Mar 2009 01:15:20 +0000"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12403764" name="hbase-1232-v2.patch" size="12680" author="nitay" created="Fri, 27 Mar 2009 00:43:37 +0000"/>
                            <attachment id="12403759" name="hbase-1232.patch" size="12580" author="nitay" created="Thu, 26 Mar 2009 23:56:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 17 Mar 2009 08:45:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hc3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>