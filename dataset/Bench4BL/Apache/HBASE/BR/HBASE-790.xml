<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 18:55:04 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-790/HBASE-790.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-790] During import, single region blocks requests for &gt;10 minutes, thread dumps, throws out pending requests, and continues</title>
                <link>https://issues.apache.org/jira/browse/HBASE-790</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During a batch import, I have two processes importing into a single region.&lt;/p&gt;

&lt;p&gt;The behavior I saw was a regionserver with 2 regions of the table in question on it.  The first region split, and the new regions were reassigned to another regionserver.&lt;/p&gt;

&lt;p&gt;Following that, inserting into the region that was left over began to block client requests.  I am attaching the regionserver log; below is the specific problem area:&lt;/p&gt;

&lt;p&gt;2008-07-31 15:38:24,190 DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit in table locations for row &amp;lt;&amp;gt; and tableName .META.: location server 72.34.249.217:60020, location region name .META.,,1&lt;br/&gt;
2008-07-31 15:38:24,194 INFO org.apache.hadoop.hbase.regionserver.CompactSplitThread: region split, META updated, and report to master all successful. Old region=REGION =&amp;gt; {NAME =&amp;gt; &apos;items,01beddd6-813b-4f2b-ac48-a0cef395cb7e,12175434512&lt;br/&gt;
2008-07-31 15:38:34,052 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates for &apos;IPC Server handler 7 on 60020&apos; on region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296: Memcache size 64.0m is &amp;gt;= than blocking&lt;br/&gt;
2008-07-31 15:39:00,270 INFO org.apache.hadoop.ipc.Server: IPC Server handler 8 on 60020, call batchUpdate([B@17b4239f, row =&amp;gt; 02c241b4-9d32-452d-8dab-247f4af693eb, {column =&amp;gt; content:title, value =&amp;gt; &apos;...&apos;, column =&amp;gt; content:content, va&lt;br/&gt;
org.apache.hadoop.hbase.NotServingRegionException: items,01beddd6-813b-4f2b-ac48-a0cef395cb7e,1217543451296&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionServer.java:1436)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegionServer.batchUpdate(HRegionServer.java:1147)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor12.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:616)&lt;br/&gt;
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:473)&lt;br/&gt;
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:896)&lt;br/&gt;
2008-07-31 15:39:09,547 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates for &apos;IPC Server handler 8 on 60020&apos; on region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296: Memcache size 64.0m is &amp;gt;= than blocking&lt;br/&gt;
2008-07-31 15:39:44,079 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates for &apos;IPC Server handler 9 on 60020&apos; on region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296: Memcache size 64.0m is &amp;gt;= than blocking&lt;br/&gt;
2008-07-31 15:40:19,574 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates for &apos;IPC Server handler 1 on 60020&apos; on region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296: Memcache size 64.0m is &amp;gt;= than blocking&lt;br/&gt;
2008-07-31 15:49:09,130 INFO org.apache.hadoop.hbase.regionserver.LogRoller: Rolling hlog. Number of entries: 1&lt;br/&gt;
2008-07-31 15:49:09,144 DEBUG org.apache.hadoop.hbase.regionserver.HLog: Closing current log writer /hbase/log_72.34.249.212_1217535541159_60020/hlog.dat.1217543884691&lt;br/&gt;
2008-07-31 15:49:09,146 INFO org.apache.hadoop.hbase.regionserver.HLog: New log writer created at /hbase/log_72.34.249.212_1217535541159_60020/hlog.dat.1217544549145&lt;br/&gt;
2008-07-31 16:03:09,060 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Started memcache flush for region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296. Current region memcache size 64.0m&lt;br/&gt;
2008-07-31 16:03:09,467 INFO org.apache.hadoop.hbase.regionserver.HRegion: Unblocking updates for region items,8001eb31-98bb-4087-bd8d-e4b42805addb,1217543451296 &apos;IPC Server handler 5 on 60020&apos;&lt;br/&gt;
2008-07-31 16:03:09,478 INFO org.apache.hadoop.ipc.Server: Process Thread Dump: Discarding call batchUpdate([B@4e727e0e, row =&amp;gt; c08408b4-b68c-433c-ba3f-d46d3ba73288, {column =&amp;gt; content:title, value =&amp;gt; &apos;...&apos;, column =&amp;gt; content:content, v&lt;/p&gt;


&lt;p&gt;As you can see there was a 14 minute delay between updates being blocked, and the unblocking occurring.&lt;/p&gt;

&lt;p&gt;All the pending batchUpdates were thrown out (too old) and then importing proceeded normally.&lt;/p&gt;

&lt;p&gt;The same behavior repeated itself later on a different regionserver, and again after a while it unfroze, kicked out pending updates, and continued.&lt;/p&gt;</description>
                <environment>&lt;p&gt;11 node cluster.  1 master w/ namenodes and hmaster.  10 slaves w/ datanodes and regionservers.  All are 2GHz quad core xeons, 4gb ram, raid 0.&lt;/p&gt;</environment>
        <key id="12401450">HBASE-790</key>
            <summary>During import, single region blocks requests for &gt;10 minutes, thread dumps, throws out pending requests, and continues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurtell">Andrew Purtell</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Aug 2008 00:38:11 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:21 +0000</updated>
                            <resolved>Tue, 5 Aug 2008 19:06:05 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12618911" author="streamy" created="Fri, 1 Aug 2008 00:39:30 +0000"  >&lt;p&gt;Full regionserver log&lt;/p&gt;</comment>
                            <comment id="12618918" author="stack" created="Fri, 1 Aug 2008 02:28:28 +0000"  >&lt;p&gt;Rong-en has been running a version hbase from around the same vintage as jgray&apos;s above and also sees the 20 minute blocks.&lt;/p&gt;</comment>
                            <comment id="12619114" author="stack" created="Fri, 1 Aug 2008 20:07:09 +0000"  >&lt;p&gt;If we&apos;re going to block, make sure a flush has been requested.  Also adding logging of flush request.  The log has us just sitting around doing nothing; don&apos;t know if a flush request has come in.&lt;/p&gt;</comment>
                            <comment id="12619132" author="stack" created="Fri, 1 Aug 2008 21:02:43 +0000"  >&lt;p&gt;Committed the 790 above to see if it helps with this issue (Trying to reproduce).  Also adds logging.&lt;/p&gt;</comment>
                            <comment id="12619170" author="stack" created="Sat, 2 Aug 2008 00:10:12 +0000"  >&lt;p&gt;Patch for jon gray to test.&lt;/p&gt;

&lt;p&gt;Usually block/unblock runs fine but then it hangs.  Logging added by earlier patch shows no flush has been queued.  Our mechanism for queuing flushes and subsequent clear of flush flag is faulty.  This patch is a bit of a hack that does check before we go into HRegion synchronized method.&lt;/p&gt;</comment>
                            <comment id="12619200" author="rafan" created="Sat, 2 Aug 2008 07:32:31 +0000"  >&lt;p&gt;In my env, I have multiplier of 2 (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-779&quot; title=&quot;Test changing hbase.hregion.memcache.block.multiplier to 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-779&quot;&gt;&lt;del&gt;HBASE-779&lt;/del&gt;&lt;/a&gt;) and see this blocking.&lt;/p&gt;</comment>
                            <comment id="12619201" author="rafan" created="Sat, 2 Aug 2008 08:03:38 +0000"  >&lt;p&gt;hmm.. look at the original description again. Not sure if I&apos;m seeing the same issue as I did not see &quot;Discarding update in my region server logs&quot;.&lt;/p&gt;

&lt;p&gt;What I saw is that during the bulk (MR or not), something the client just sits idle, and all region servers are also idle. thread dump shows client is waiting in the locationRegionInMeta method. After 10~20 mins later, the client continues without any exceptions. For MR load, I have to increase the task.timeout from 10m to 30m to prevent task tracker to kill the tasks...&lt;/p&gt;</comment>
                            <comment id="12619263" author="stack" created="Sat, 2 Aug 2008 17:43:48 +0000"  >&lt;p&gt;Just tried reproducing the &apos;hanging blocking&apos; on cluster here.  Tried various loading combinations &amp;#8211; many column families, loading all of them concurrently and then just some &amp;#8211; but to no avail.&lt;/p&gt;

&lt;p&gt;Jon: Want to retry with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-779&quot; title=&quot;Test changing hbase.hregion.memcache.block.multiplier to 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-779&quot;&gt;&lt;del&gt;HBASE-779&lt;/del&gt;&lt;/a&gt; enabled?  With the edit to your hbase-default.xml?   In other words, raw TRUNK.  If it still hangs, try with the above v2 patch?  It adds extra signalling flush is needed just before we go into sync block.&lt;/p&gt;</comment>
                            <comment id="12619298" author="clint.morgan" created="Sun, 3 Aug 2008 04:15:43 +0000"  >&lt;p&gt;+1 I had an upload task that was timing out on trunk, and this latest patch fixed it. &lt;/p&gt;</comment>
                            <comment id="12619668" author="jimk" created="Mon, 4 Aug 2008 20:06:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-790&quot; title=&quot;During import, single region blocks requests for &amp;gt;10 minutes, thread dumps, throws out pending requests, and continues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-790&quot;&gt;&lt;del&gt;HBASE-790&lt;/del&gt;&lt;/a&gt; is the only blocker for hbase-0.2.0 at this point&lt;/p&gt;</comment>
                            <comment id="12619673" author="streamy" created="Mon, 4 Aug 2008 20:09:35 +0000"  >&lt;p&gt;-1 on trunk.  Got same behavior with latest trunk, applying 790 patch v2 and testing again right now&lt;/p&gt;</comment>
                            <comment id="12619724" author="stack" created="Mon, 4 Aug 2008 22:14:13 +0000"  >&lt;p&gt;Looks like patch don&apos;t work.&lt;/p&gt;

&lt;p&gt;Looking in Jon&apos;s logs with the patch applied I see this when we hang up on items,06fcb4d2-b751-4584-8278-3f65f923e1f0,1217884873435:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-08-04 14:22:31,828 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Started memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region items,06fcb4d2-b751-4584-8278-3f65f923e1f0,1217884873435. Current region memcache size 64.0m
2008-08-04 14:22:31,828 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Flush requested on items,06fcb4d2-b751-4584-8278-3f65f923e1f0,1217884873435
2008-08-04 14:22:34,447 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished memcache flush &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region items,06fcb4d2-b751-4584-8278-3f65f923e1f0,1217884873435 in 2619ms, sequence id=40529298, compaction requested=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Last week we added the logging of when flushes are registered.&lt;/p&gt;

&lt;p&gt;Above see how we have &apos;Flush requested on...&apos; in the midst of a flush start/finish.&lt;/p&gt;

&lt;p&gt;My guess is that some sequence of registering flushes and clearing flush flags is making it so we go into a block without a flush being registered.&lt;/p&gt;</comment>
                            <comment id="12619740" author="streamy" created="Mon, 4 Aug 2008 23:25:58 +0000"  >&lt;p&gt;-1 on patch v2... same behavior as before&lt;/p&gt;</comment>
                            <comment id="12619745" author="clint.morgan" created="Mon, 4 Aug 2008 23:57:49 +0000"  >&lt;p&gt;Disregard my previous vote. My problems were related to another issue. Sorry for the noise.&lt;/p&gt;</comment>
                            <comment id="12619969" author="streamy" created="Tue, 5 Aug 2008 17:43:24 +0000"  >&lt;p&gt;After spending quite a bit of time running different load tests on v2 patch, it appears the problem did still exist.&lt;/p&gt;

&lt;p&gt;Stack pointed me towards looking into the possibility of distributed state.  I dug in and it seemed that state was being spread across two different locations.&lt;/p&gt;

&lt;p&gt;To fix this, I moved the flushRequested boolean into the WriteState class.  This allowed me to make it so its state can only be changed when WriteState was synchronized on.&lt;/p&gt;

&lt;p&gt;Upon further testing it seems that this does work and I&apos;m no longer seeing this issue.&lt;/p&gt;

&lt;p&gt;I am +1 on 790 with this patch, and +1 on rolling 0.2.0 RC2&lt;/p&gt;</comment>
                            <comment id="12619970" author="stack" created="Tue, 5 Aug 2008 17:55:45 +0000"  >&lt;p&gt;Patch looks good.  Does it really fix the issue?  Why&apos;d you remove &apos;-        r.setLastFlushTime(now);&apos; in Flusher?&lt;/p&gt;

&lt;p&gt;Let me try this patch up on our cluster.&lt;/p&gt;</comment>
                            <comment id="12619971" author="jimk" created="Tue, 5 Aug 2008 17:57:32 +0000"  >&lt;p&gt;Reviewed patch. +1&lt;/p&gt;</comment>
                            <comment id="12619972" author="apurtell" created="Tue, 5 Aug 2008 17:58:29 +0000"  >&lt;p&gt;I&apos;m also testing this right now.&lt;/p&gt;</comment>
                            <comment id="12619974" author="jimk" created="Tue, 5 Aug 2008 18:00:38 +0000"  >&lt;p&gt;Wait. Stack&apos;s right. Without setting the last flush time, the optional cache flush won&apos;t work.&lt;/p&gt;</comment>
                            <comment id="12619978" author="jimk" created="Tue, 5 Aug 2008 18:09:15 +0000"  >&lt;p&gt;Ah, ok. lastFlushTime is set in internalFlushCache so is not needed in Flusher. +1&lt;/p&gt;</comment>
                            <comment id="12619979" author="streamy" created="Tue, 5 Aug 2008 18:10:48 +0000"  >&lt;p&gt;The patch does appear to fix the issue.  I have run an identical load test probably 15 times in the past week and last night it ran past 400 total regions without any issues.  Previously it had been breaking at either 20 or 80 total regions.&lt;/p&gt;

&lt;p&gt;I will continue testing and also run a full test on production once we get the RC.&lt;/p&gt;

&lt;p&gt;I removed the setLastFlushTime in Flusher because it didn&apos;t make sense to be doing it twice.&lt;/p&gt;</comment>
                            <comment id="12619993" author="apurtell" created="Tue, 5 Aug 2008 18:32:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12620005" author="stack" created="Tue, 5 Aug 2008 19:03:36 +0000"  >&lt;p&gt;I ran a little test on cluster.  Ran slightly faster with patch applied.  Going to commit it.&lt;/p&gt;</comment>
                            <comment id="12620007" author="stack" created="Tue, 5 Aug 2008 19:06:05 +0000"  >&lt;p&gt;Committed.  Thanks for patch Jon.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387382" name="790-v2.patch" size="1117" author="stack" created="Sat, 2 Aug 2008 00:10:12 +0000"/>
                            <attachment id="12387579" name="790-v3.patch" size="3989" author="streamy" created="Tue, 5 Aug 2008 17:43:57 +0000"/>
                            <attachment id="12387368" name="790.patch" size="3303" author="stack" created="Fri, 1 Aug 2008 20:07:09 +0000"/>
                            <attachment id="12387320" name="regionserver-lockup.log" size="170061" author="streamy" created="Fri, 1 Aug 2008 00:39:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Aug 2008 02:28:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25400</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 18 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h9gn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98795</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>