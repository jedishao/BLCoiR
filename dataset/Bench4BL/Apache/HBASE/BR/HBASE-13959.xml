<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Thu Dec 01 22:27:58 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13959/HBASE-13959.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13959] Region splitting uses a single thread in most common cases</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13959</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When storefiles need to be split as part of a region split, the current logic uses a threadpool with the size set to the size of the number of stores. Since most common table setup involves only a single column family, this translates to having a single store and so the threadpool is run with a single thread. However, in a write heavy workload, there could be several tens of storefiles in a store at the time of splitting, and with a threadpool size of one, these files end up getting split sequentially.&lt;/p&gt;

&lt;p&gt;With a bit of tracing, I noticed that it takes on an average of 350ms to create a single reference file, and splitting each storefile involves creating two of these, so with a storefile count of 20, it takes about 14s just to get through this phase alone (2 reference files for each storefile), pushing the total time the region is offline to 18s or more. For environments that are setup to fail fast, this makes the client exhaust all retries and fail with NotServingRegionException.&lt;/p&gt;

&lt;p&gt;The fix should increase the concurrency of this operation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12840027">HBASE-13959</key>
            <summary>Region splitting uses a single thread in most common cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="haridsv">Hari Krishna Dara</assignee>
                                    <reporter username="haridsv">Hari Krishna Dara</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jun 2015 04:04:47 +0000</created>
                <updated>Mon, 31 Aug 2015 22:39:53 +0000</updated>
                            <resolved>Tue, 30 Jun 2015 01:25:54 +0000</resolved>
                                    <version>0.98.12</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>0.98.14</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="14598919" author="anoop.hbase" created="Wed, 24 Jun 2015 06:11:15 +0000"  >&lt;p&gt;So now each thread is handling one CF.  We need change the threading model and its work assignment.  The model should be based on store file count (across stores)  and each thread handling a group of store files.  You will provide a patch?&lt;/p&gt;</comment>
                            <comment id="14599092" author="haridsv" created="Wed, 24 Jun 2015 08:31:21 +0000"  >&lt;p&gt;The storefiles can be handled in any order, as the splits are independent. A quickfix is to increase the pool size with a configurable upper limit. I made a patch and in the process of testing and doing some analysis. I will submit it soon.&lt;/p&gt;</comment>
                            <comment id="14599792" author="apurtell" created="Wed, 24 Jun 2015 17:32:59 +0000"  >&lt;p&gt;Nice spotting &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haridsv&quot; class=&quot;user-hover&quot; rel=&quot;haridsv&quot;&gt;Hari Krishna Dara&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="14599906" author="yuzhihong@gmail.com" created="Wed, 24 Jun 2015 18:26:02 +0000"  >&lt;p&gt;Pardon me, where is the patch ?&lt;/p&gt;</comment>
                            <comment id="14600030" author="ndimiduk" created="Wed, 24 Jun 2015 19:52:11 +0000"  >&lt;p&gt;How about defaulting the pool size to the number of cores or the number of datanode directory entries?&lt;/p&gt;</comment>
                            <comment id="14600619" author="haridsv" created="Thu, 25 Jun 2015 03:34:02 +0000"  >&lt;p&gt;Apologies Ted, I thought I already attached it.&lt;/p&gt;</comment>
                            <comment id="14600629" author="haridsv" created="Thu, 25 Jun 2015 03:46:37 +0000"  >&lt;p&gt;Can&apos;t there be other regions splits that could go on in parallel? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; have suggestions on using shared executor pools with larger scope, which would scale and perform better than sizing this thread pool proportional to some metric related to the current region.&lt;/p&gt;</comment>
                            <comment id="14600634" author="hadoopqa" created="Thu, 25 Jun 2015 03:49:22 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12741776/HBASE-13959.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12741776/HBASE-13959.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 2df3236a4eee48bf723213a7c4ff3d29c832c8cf.&lt;br/&gt;
  ATTACHMENT ID: 12741776&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14559//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14559//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14600654" author="haridsv" created="Thu, 25 Jun 2015 04:11:34 +0000"  >&lt;p&gt;I am able to apply patch (created with `git format-patch`) with -p1, not sure what is wrong. I will attach again generated with `git diff`.&lt;/p&gt;</comment>
                            <comment id="14600668" author="hadoopqa" created="Thu, 25 Jun 2015 04:28:40 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12741781/HBASE-13959-2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12741781/HBASE-13959-2.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 2df3236a4eee48bf723213a7c4ff3d29c832c8cf.&lt;br/&gt;
  ATTACHMENT ID: 12741781&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14561//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14561//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14600670" author="yuzhihong@gmail.com" created="Thu, 25 Jun 2015 04:29:30 +0000"  >&lt;p&gt;Using Reply button can easily lead to multiple identical posts.&lt;/p&gt;

&lt;p&gt;SplitTransaction has become an interface. Please make changes in SplitTransactionImpl.java&lt;br/&gt;
Your patch is based on 0.98&lt;br/&gt;
You can name it 13959-0.98-v1.txt, e.g.&lt;/p&gt;</comment>
                            <comment id="14600768" author="haridsv" created="Thu, 25 Jun 2015 06:19:31 +0000"  >&lt;p&gt;Patch against master branch.&lt;/p&gt;</comment>
                            <comment id="14600894" author="hadoopqa" created="Thu, 25 Jun 2015 08:51:54 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12741801/HBASE-13959-3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12741801/HBASE-13959-3.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 2df3236a4eee48bf723213a7c4ff3d29c832c8cf.&lt;br/&gt;
  ATTACHMENT ID: 12741801&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;                &lt;font color=&quot;red&quot;&gt;-1 checkstyle&lt;/font&gt;.  The applied patch generated 1909 checkstyle errors (more than the master&apos;s current 1907 errors).&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 lineLengths&lt;/font&gt;.  The patch introduces the following lines longer than 100:&lt;br/&gt;
    +        LOG.debug(&quot;Splitting started for store file: &quot; + sf.getPath() + &quot; for region: &quot; + this.parent);&lt;br/&gt;
+        LOG.debug(&quot;Splitting complete for store file: &quot; + sf.getPath() + &quot; for region: &quot; + this.parent);&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn post-site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;/p&gt;


&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;                Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14565//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14600933" author="haridsv" created="Thu, 25 Jun 2015 09:41:21 +0000"  >&lt;p&gt;Fix for checkstyle errors. The unit test org.apache.hadoop.hbase.master.TestDistributedLogSplitting passed on my local box, so hoping it is just flaky.&lt;/p&gt;</comment>
                            <comment id="14600973" author="yuzhihong@gmail.com" created="Thu, 25 Jun 2015 10:31:39 +0000"  >&lt;p&gt;Is it possible to measure performance gain with your patch ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14601035" author="haridsv" created="Thu, 25 Jun 2015 11:33:36 +0000"  >&lt;p&gt;I just attached region-split-durations-compared.png.&lt;/p&gt;

&lt;p&gt;I have done a basic comparison of split times with one thread vs 8 threads on a table. The table had no presplits and had a single column family. Starting from an empty table, I loaded 400M rows (about 570 bytes/row). The run with 1 thread encountered NSRE exceptions a few times that coincides with a long running split. The run with 8 threads had no NSRE&apos;s. Here are some numbers:&lt;/p&gt;

&lt;p&gt;Thread pool size = 1&lt;br/&gt;
Number of splits: 27&lt;br/&gt;
Average split duration: 8.44s&lt;br/&gt;
Min split duration: 3&lt;br/&gt;
Max split duration: 16&lt;br/&gt;
p99 split duration: 16&lt;/p&gt;

&lt;p&gt;Thread pool size = 8&lt;br/&gt;
Number of splits: 25&lt;br/&gt;
Average split duration: 3.4s&lt;br/&gt;
Min split duration: 2&lt;br/&gt;
Max split duration: 6&lt;br/&gt;
p99 split duration: 5.76&lt;/p&gt;


&lt;p&gt;I will attach an histogram showing the durations side by side.&lt;/p&gt;</comment>
                            <comment id="14601087" author="hadoopqa" created="Thu, 25 Jun 2015 12:04:30 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12741822/HBASE-13959-4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12741822/HBASE-13959-4.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 2df3236a4eee48bf723213a7c4ff3d29c832c8cf.&lt;br/&gt;
  ATTACHMENT ID: 12741822&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn post-site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.util.TestHBaseFsck&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core zombie tests&lt;/font&gt;.  There are 3 zombie test(s): &lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14567//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14601382" author="yuzhihong@gmail.com" created="Thu, 25 Jun 2015 15:39:24 +0000"  >&lt;p&gt;Nice results in performance improvement.&lt;/p&gt;

&lt;p&gt;Should the new constants be defined in SplitTransactionImpl.java ? They&apos;re only referenced by SplitTransactionImpl.java&lt;/p&gt;</comment>
                            <comment id="14601685" author="lhofhansl" created="Thu, 25 Jun 2015 18:32:36 +0000"  >&lt;p&gt;Nice find and patch. The 8 seems to come out of nowhere.&lt;br/&gt;
Do you have numbers for different numbers of threads?&lt;br/&gt;
Maybe default it to 1/2 of blocking store file count...?&lt;/p&gt;</comment>
                            <comment id="14601785" author="lhofhansl" created="Thu, 25 Jun 2015 19:30:13 +0000"  >&lt;p&gt;Specifically we can set the default maximum to the 1/2 #blockingStoreFiles (or maybe just #blockingStoreFiles)&lt;br/&gt;
That way we have a good default, and folks can override and (a) decrease if they set blockStoreFiles to a large value or (b) increase if they have many column families.&lt;/p&gt;</comment>
                            <comment id="14601929" author="lhofhansl" created="Thu, 25 Jun 2015 20:57:36 +0000"  >&lt;p&gt;Something like this for example.&lt;br/&gt;
(This does leak HStore references into SplitTransactionImpl, though)&lt;/p&gt;

&lt;p&gt;I&apos;m just trying to a good default, rather than something else that everyone will have to configure.&lt;/p&gt;</comment>
                            <comment id="14602046" author="lhofhansl" created="Thu, 25 Jun 2015 22:13:43 +0000"  >&lt;p&gt;Upping to critical, because the code completely misses to do what it wanted to do and as a result we split with one thread per column family, and that means that in many case we serialize creation of all reference files which can take 200-400ms, each.&lt;br/&gt;
So with 20 storefiles this can easily take 8-16s (needs to create 40 reference files).&lt;/p&gt;</comment>
                            <comment id="14602146" author="hadoopqa" created="Thu, 25 Jun 2015 23:45:29 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12741944/13959-suggest.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12741944/13959-suggest.txt&lt;/a&gt;&lt;br/&gt;
  against master branch at commit e6ed79219966ce0dac3bc748261fce9478aa7550.&lt;br/&gt;
  ATTACHMENT ID: 12741944&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn post-site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.TestRegionRebalancing&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14578//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14602700" author="haridsv" created="Fri, 26 Jun 2015 11:02:19 +0000"  >&lt;p&gt;Lars, Is something missing in your comment? &lt;/p&gt;

&lt;p&gt;The current number of 8 threads is just something I thought would keep the max split duration acceptable. With 20 storefiles and about 700ms overhead from the reference file creation alone, 8 threads can keep the total split time to around 5 to 6 seconds. If we have a sense of the max number of storefiles, and have a specific target for the split time, then we can set the thread count to meet that goal. In our case, the client times out in 11 seconds, so keeping the max split time well under that is the goal. Instead of having a fixed thread count that is configurable, one alternative is to have configurable goal in seconds and then choose the number of threads based to meet it (using heuristics).&lt;/p&gt;

&lt;p&gt;If minimizing the split time is to be our goal, we could have one thread for each reference file creation (i.e., 40 threads in case of 20 storefiles) and then the split time will always stay low at about 2 to 4 seconds. &lt;/p&gt;

&lt;p&gt;I also traced the reference file creation and found that the final FSDataOutputStream.close() takes almost all the time that goes into the reference file creation, which is between 300 to 400ms. In the same environment (using NNBenchWithoutMR), I sometime back found that small file creations take a minimum of 200ms and peak to about 378ms under load (200+ clients), so the timings I am seeing with the reference file creation seems about right.&lt;/p&gt;</comment>
                            <comment id="14603999" author="lhofhansl" created="Sat, 27 Jun 2015 06:01:00 +0000"  >&lt;p&gt;Heh... See 13959-suggest.txt that I attached with same comment. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Basically your patch, but defaults the max to the max # of storefiles. So in typically setups one does not have to worry about this setting.&lt;/p&gt;</comment>
                            <comment id="14605305" author="haridsv" created="Mon, 29 Jun 2015 08:57:20 +0000"  >&lt;p&gt;Yes, I think I understand your proposal better now. Since the max storefile count should be around the blocking store file count, it makes sense to use it as the max. However, I came across blogs in which folks used unusually large blocking store file count (e.g., 200) to optimize their write performance (at the cost of read performance, of course) which could translate to having too many threads and causing resource availability and performance issues, so perhaps we should also enforce an upper limit to the number of logical cores (as returned by Runtime.getRuntime().availableProcessors()) ?&lt;/p&gt;

&lt;p&gt;As a follow up change, we could also create the two references on each storefile in parallel and shave off another 300 to 400ms in most scenarios. I can create a separate jira for this and work on it separately once this is merged.&lt;/p&gt;</comment>
                            <comment id="14605342" author="haridsv" created="Mon, 29 Jun 2015 09:25:14 +0000"  >&lt;p&gt;Based on latest comments from Lars.&lt;/p&gt;</comment>
                            <comment id="14605522" author="hadoopqa" created="Mon, 29 Jun 2015 12:00:24 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12742484/HBASE-13959-5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12742484/HBASE-13959-5.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 7b92d8c06a9eced95c4390f0dae02ebb98aa3ef7.&lt;br/&gt;
  ATTACHMENT ID: 12742484&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn post-site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14599//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14606102" author="apurtell" created="Mon, 29 Jun 2015 18:44:13 +0000"  >&lt;p&gt;Updated fix versions.&lt;/p&gt;</comment>
                            <comment id="14606408" author="lhofhansl" created="Mon, 29 Jun 2015 21:09:46 +0000"  >&lt;p&gt;+1 on v5.&lt;/p&gt;

&lt;p&gt;Unless I hear otherwise I&apos;ll commit this today. Thanks for the detective work and the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haridsv&quot; class=&quot;user-hover&quot; rel=&quot;haridsv&quot;&gt;Hari Krishna Dara&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14606429" author="lhofhansl" created="Mon, 29 Jun 2015 21:21:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, I came across blogs in which folks used unusually large blocking store file count (e.g., 200)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True. And that is why we need the new config option. Folks who increase # blocking store files that dramatically better know what they&apos;re doing. Either they&apos;d presplit everything, or they&apos;d want a large number of threads doing the splitting.&lt;br/&gt;
With this, we mostly keep the spirit of the original code: one thread per file. I think we can do that here, and then fix it in a better way.&lt;/p&gt;

&lt;p&gt;This is just to come up with a good proxy that will work in most situations. Another good proxy would be the number of a handler threads configured for the NameNode (and then allow a split to use maybe a 1/4 of that by default).&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; and I pointed out elsewhere, on demand thread pools are smelly beasts and should be avoided. Once we fixed this issue, we should revisit that. The tricky part with a central pool - presumably - would be making sure that all tasks terminate; right now this is enforced by shutting down the pool.&lt;/p&gt;</comment>
                            <comment id="14606508" author="apurtell" created="Mon, 29 Jun 2015 22:06:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14606772" author="lhofhansl" created="Tue, 30 Jun 2015 01:06:41 +0000"  >&lt;p&gt;Sorry. Don&apos;t know why this got assigned to me. Assigned back to Hari.&lt;/p&gt;</comment>
                            <comment id="14606780" author="lhofhansl" created="Tue, 30 Jun 2015 01:12:30 +0000"  >&lt;p&gt;Committed to 2.0.0, 1.3.0, 1.2.0, 1.1.2.&lt;br/&gt;
I&apos;m making a 1.0 and 0.98 patch now.&lt;/p&gt;</comment>
                            <comment id="14606796" author="lhofhansl" created="Tue, 30 Jun 2015 01:22:17 +0000"  >&lt;p&gt;0.98 patch.&lt;/p&gt;</comment>
                            <comment id="14606799" author="lhofhansl" created="Tue, 30 Jun 2015 01:25:54 +0000"  >&lt;p&gt;And committed to 0.98 and 1.0.x as well.&lt;/p&gt;</comment>
                            <comment id="14606899" author="hudson" created="Tue, 30 Jun 2015 03:02:05 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.0 #980 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/980/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/980/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev c343776a6a21b58c1971514cb996621825d63039)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14606902" author="hudson" created="Tue, 30 Jun 2015 03:04:47 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.1 #566 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.1/566/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.1/566/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 0548da62d11934a204ac1697e6c655e417f371ed)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14606918" author="hudson" created="Tue, 30 Jun 2015 03:20:48 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.3 #26 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3/26/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3/26/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 163ddbf03cb94e4823cbc694ccba92366ec35917)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14606957" author="haridsv" created="Tue, 30 Jun 2015 04:08:42 +0000"  >&lt;p&gt;Thank you very much, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; for creating the patch for 0.98 and 1.0 as well. Do we need to update any documentation or add a note somewhere?&lt;/p&gt;

&lt;p&gt;Couple of more questions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Is there an existing jira to capture the requirements for central execution pool? If not, I can work on it. Good point about ensuring the termination, it could be tricky without having to shutdown the pool.&lt;/li&gt;
	&lt;li&gt;Meanwhile, is it OK to work on a follow up patch to increase the concurrency further by creating both reference files in parallel? This work will not go waste when a central pool is introduced.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607140" author="hudson" created="Tue, 30 Jun 2015 04:39:45 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #6615 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/6615/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/6615/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev f8bd578b80b4e656d799c82ca1b6191e35bb0ae4)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607147" author="vrodionov" created="Tue, 30 Jun 2015 04:44:17 +0000"  >&lt;p&gt;This should battle tested. I do remember constant failures with # of split threads &amp;gt; 1 in my test runs a while ago (that was on a master branch ~ 9-10 months ago). &lt;/p&gt;

&lt;p&gt;Why does creation of reference files take so long? &lt;/p&gt;</comment>
                            <comment id="14607491" author="haridsv" created="Tue, 30 Jun 2015 04:54:01 +0000"  >&lt;p&gt;What kind of failures were they? Failure on hbase side or hdfs side?&lt;/p&gt;

&lt;p&gt;I didn&apos;t trace the creation of the reference files very deep, but as I indicated in an earlier comment, the entire time is spent in the FSDataOutputStream.close(). The time also matches independent test done in the same environment using NNBenchWithoutMR. I glanced through the hdfs settings and didn&apos;t find anything that could help speed up the writes, but perhaps I missed something. One issue here is that reference files are very small and HDFS is optimized for large files, so it is hard to find any references for optimizing writes of small files.&lt;/p&gt;</comment>
                            <comment id="14607513" author="hudson" created="Tue, 30 Jun 2015 05:20:31 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.2-IT #29 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2-IT/29/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2-IT/29/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 38f43acc4ca1a1f57793ae906c911e40904b6249)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607519" author="hudson" created="Tue, 30 Jun 2015 05:23:59 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98 #1043 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/1043/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/1043/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 1ee69096878927979a43ffb744870d44398f7c35)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607530" author="hudson" created="Tue, 30 Jun 2015 05:31:57 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.3-IT #13 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3-IT/13/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3-IT/13/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 163ddbf03cb94e4823cbc694ccba92366ec35917)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607536" author="hudson" created="Tue, 30 Jun 2015 05:36:46 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.2 #40 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2/40/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2/40/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 38f43acc4ca1a1f57793ae906c911e40904b6249)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransactionImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607542" author="lhofhansl" created="Tue, 30 Jun 2015 05:43:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there an existing jira to capture the requirements for central execution pool? If not, I can work on it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t think so. Let&apos;s create a new one.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Meanwhile, is it OK to work on a follow up patch to increase the concurrency further by creating both reference files in parallel? This work will not go waste when a central pool is introduced&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure. Be very careful, though, for correctness it is essential that the daughter come online in the correct order (daughter B first). Or at least are made visible in META in that order.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This should battle tested. I do remember constant failures with # of split threads &amp;gt; 1 in my test runs a while ago (that was on a master branch ~ 9-10 months ago).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s the number of parallel splits executed. This is different. Clearly the intention of the code was to do this. As it is we make a new ThreadPool with exactly one thread in it in the vast majority of the cases.&lt;br/&gt;
I don&apos;t see how making multile references in parallel can cause harm unless we&apos;re overloading the system somewhere (maybe too many threads on the RS or not enough handler threads at the NN).&lt;/p&gt;

&lt;p&gt;If I remember right you run with # blocking store files set to 200, right? You may have to dial down the max threads introduced here.&lt;/p&gt;

&lt;p&gt;I have no problem running this in our production systems (of course we&apos;ll do our usual acceptance testing in any case).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why does creation of reference files take so long?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Each is creating a new file, which takes a while as the NN has to persist its state. (the Namenode can handle 10000 operation/sec, but each individual one takes a bit to finish). 1/5s-1/3s is about what I had measured in the past.&lt;/p&gt;</comment>
                            <comment id="14607974" author="hudson" created="Tue, 30 Jun 2015 08:58:25 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #996 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/996/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/996/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13959&quot; title=&quot;Region splitting uses a single thread in most common cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13959&quot;&gt;&lt;del&gt;HBASE-13959&lt;/del&gt;&lt;/a&gt; Region splitting uses a single thread in most common cases. (Hari Krishna Dara) (larsh: rev 1ee69096878927979a43ffb744870d44398f7c35)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
	&lt;li&gt;hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14608198" author="haridsv" created="Tue, 30 Jun 2015 12:14:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Let&apos;s create a new one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will create a &quot;Brainstorming&quot; issue to start a discussion on this and capture requirements.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Be very careful, though, for correctness it is essential that the daughter come online in the correct order (daughter B first). Or at least are made visible in META in that order.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is actually a very local operation and so should be safe (bringing the daughters online comes outside this scope). I just created &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13999&quot; title=&quot;Improve storefile split performance by creating daughter reference files concurrently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13999&quot;&gt;HBASE-13999&lt;/a&gt; for this.&lt;/p&gt;</comment>
                            <comment id="14700464" author="ndimiduk" created="Mon, 17 Aug 2015 23:53:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haridsv&quot; class=&quot;user-hover&quot; rel=&quot;haridsv&quot;&gt;Hari Krishna Dara&lt;/a&gt; mind adding a release note summarizing this change and pointing out your new config? Thanks.&lt;/p&gt;</comment>
                            <comment id="14716128" author="haridsv" created="Thu, 27 Aug 2015 05:58:35 +0000"  >&lt;p&gt;Apologies for the late response, but I just added a release note. Please take a look and let me know if it needs to be more or less verbose than this and I can make adjustments.&lt;/p&gt;</comment>
                            <comment id="14724302" author="enis" created="Mon, 31 Aug 2015 22:39:53 +0000"  >&lt;p&gt;Closing this issue after 1.0.2 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12742674" name="13959-0.98.txt" size="4143" author="lhofhansl" created="Tue, 30 Jun 2015 01:22:17 +0000"/>
                            <attachment id="12741944" name="13959-suggest.txt" size="4258" author="lhofhansl" created="Thu, 25 Jun 2015 20:57:36 +0000"/>
                            <attachment id="12741781" name="HBASE-13959-2.patch" size="4201" author="haridsv" created="Thu, 25 Jun 2015 04:12:08 +0000"/>
                            <attachment id="12741801" name="HBASE-13959-3.patch" size="4320" author="haridsv" created="Thu, 25 Jun 2015 06:19:31 +0000"/>
                            <attachment id="12741822" name="HBASE-13959-4.patch" size="4359" author="haridsv" created="Thu, 25 Jun 2015 09:41:21 +0000"/>
                            <attachment id="12742484" name="HBASE-13959-5.patch" size="4522" author="haridsv" created="Mon, 29 Jun 2015 09:26:53 +0000"/>
                            <attachment id="12741776" name="HBASE-13959.patch" size="4721" author="haridsv" created="Thu, 25 Jun 2015 03:33:28 +0000"/>
                            <attachment id="12741836" name="region-split-durations-compared.png" size="20056" author="haridsv" created="Thu, 25 Jun 2015 11:32:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 24 Jun 2015 06:11:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 13 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gezr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The performance of region splitting has been improved by using a thread pool to split the store files concurrently. Prior to this change, the store files were always split sequentially in a single thread, so a region with multiple store files ended up taking several seconds. The thread pool is sized dynamically with the aim of getting maximum concurrency, without exceeding the number of cores available for HBase Java process. A lower limit for the thread pool can be explicitly set using the property hbase.regionserver.region.split.threads.max.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>region, split</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>