<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:49:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2593/HBASE-2593.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2593] Race Between Log Splitting and Log Writing</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2593</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The current method for recovering the lease in HLog.splitLog() is flawed.  Between the time that the regionserver is marked as dead and fs.append is issued, the regionserver could exit a GC pause and maintain the lease.  In this case, fs.append() would continually fail.  The master needs to not only recover the lease in splitLog but also break the lease so regionserver writes will no longer pass.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12465160">HBASE-2593</key>
            <summary>Race Between Log Splitting and Log Writing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="nspiegelberg">Nicolas Spiegelberg</assignee>
                                    <reporter username="nspiegelberg">Nicolas Spiegelberg</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 May 2010 20:47:18 +0000</created>
                <updated>Fri, 20 Nov 2015 12:41:47 +0000</updated>
                            <resolved>Fri, 21 May 2010 22:07:10 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>master</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12870154" author="tlipcon" created="Fri, 21 May 2010 20:51:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;Between the time that the regionserver is marked as dead and fs.append is issued, the regionserver could exit a GC pause and maintain the lease&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How can this happen? If it loses its ZK session, then the regionserver will notice this and shut itself down. So we&apos;ll only spin in recoverLog if the regionserver is stuck unable to shut down, for some reason.&lt;/p&gt;</comment>
                            <comment id="12870160" author="nspiegelberg" created="Fri, 21 May 2010 21:02:05 +0000"  >&lt;p&gt;See the previous discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-1142&quot; title=&quot;Lease recovery doesn&amp;#39;t reassign lease when triggered by append()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-1142&quot;&gt;&lt;del&gt;HDFS-1142&lt;/del&gt;&lt;/a&gt;.  After talking with Dhruba, the proper way for splitLog() to handle this seems to be:&lt;/p&gt;

&lt;p&gt;1. Open Regionserver.HLog.next for write&lt;br/&gt;
2. fs.rename(HLog.current, HLog.old.current)&lt;br/&gt;
3. append(HLog.old.current)&lt;/p&gt;

&lt;p&gt;Note that this algorithm utilizes HDFS subtleties.  #1 is ensuring that the rogue regionserver can&apos;t create a new HLog when a write to his current log fails.  The rename in #2 is acting like a touch(): it modifies the file&apos;s generation stamp in namenode, which then propagates this change to the replicas.  If a fs.write() is being issued at the time, it will either succeed on every node in the pipeline &lt;span class=&quot;error&quot;&gt;&amp;#91;that&amp;#39;s fine&amp;#93;&lt;/span&gt; or some of DNs will get the new generation stamp and send an error.  The first DN sees the error and requests a new generation stamp from the NN, which responds false and causes the client to fail.&lt;/p&gt;</comment>
                            <comment id="12870167" author="tlipcon" created="Fri, 21 May 2010 21:16:43 +0000"  >&lt;p&gt;I disagree with the above - rename() does not increment generation stamps, it simply updates the FS metadata. What it will do is prevent the original writer from allocating additional blocks or performing pipeline recovery, since further checkLease() calls with the old filename will fail. But normal fs.write/fs.flush calls to the existing pipeline will continue to succeed.&lt;/p&gt;

&lt;p&gt;In order to actually break the lease, the old writer needs to reach the HDFS soft limit period (which is similar to the ZK timeout period)&lt;/p&gt;</comment>
                            <comment id="12870187" author="nspiegelberg" created="Fri, 21 May 2010 22:07:10 +0000"  >&lt;p&gt;IIRC &lt;/p&gt;

&lt;p&gt;tlipcon: you can&apos;t append after you rename, cuz the lease follows through the rename&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2:40pm&amp;#93;&lt;/span&gt; tlipcon: it still holds the lease&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2:40pm&amp;#93;&lt;/span&gt; tlipcon:       changeLease(src, dst, dinfo);    // update lease with new filename&lt;br/&gt;
nspiegelberg: hmm.  I think &lt;span class=&quot;error&quot;&gt;&amp;#91;we were&amp;#93;&lt;/span&gt; of the opinion that this caused a kill lease rpc.  looks like that&apos;s wrong&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2:46pm&amp;#93;&lt;/span&gt; nspiegelberg: or rather, that the rename didn&apos;t persist the lease and append would then cause a kill lease&lt;br/&gt;
tlipcon: I think most importantly, it means that on a restart or lease expiry, the NN side will have the correct record to find that thing in the directory and finalize it, etc&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2:52pm&amp;#93;&lt;/span&gt; nspiegelberg: I think that was &lt;span class=&quot;error&quot;&gt;&amp;#91;the&amp;#93;&lt;/span&gt; intention.  Hlog.new = no new files, rename() = no new block, append() = wait for RS to give up&lt;br/&gt;
tlipcon: nspiegelberg: what was proposed before was: list files, find last file, open for append. when that succeeds, list again, see if there any new ones&lt;br/&gt;
tlipcon: (this relies on writer not closing the prior file until the next one has been created)&lt;br/&gt;
tlipcon: but I think we should collapse the two tickets - seems like the same fix will fix all the problems&lt;br/&gt;
nspiegelberg: I think they&apos;re solving the same problem.  Just trying to think if we can make an active lease takeover vs current passive approaches&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3:02pm&amp;#93;&lt;/span&gt; tlipcon: nspiegelberg: yea, I don&apos;t know that there is any active lease takeover opportunity really&lt;/p&gt;</comment>
                            <comment id="15017072" author="lars_francke" created="Fri, 20 Nov 2015 12:41:47 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12464190">HDFS-1142</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12458882">HBASE-2312</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 21 May 2010 20:51:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26380</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hiev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100245</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>