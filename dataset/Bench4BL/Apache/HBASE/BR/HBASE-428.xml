<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:16:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-428/HBASE-428.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-428] Under continuous upload of rows, WrongRegionExceptions are thrown that reach the client even after retries</title>
                <link>https://issues.apache.org/jira/browse/HBASE-428</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I have installed 0.16.0 rc 1 which I believe contains a fix for similar issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-138&quot; title=&quot;[hbase] Under load, regions become extremely large and eventually cause region servers to become unresponsive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-138&quot;&gt;&lt;del&gt;HBASE-138&lt;/del&gt;&lt;/a&gt;,  but I still see the same problem.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I am using a single node.&lt;/li&gt;
	&lt;li&gt;The client application runs in a single thread, loading data into a single table.&lt;/li&gt;
	&lt;li&gt;I get good throughput of about 200 rows/sec to start with, with occasional significant drops due to NotServingRegionException&apos;s that are recoverable on client retry (internal to hbase).&lt;/li&gt;
	&lt;li&gt;After 54 minutes, and about 500,000 rows I start to see WrongRegionException&apos;s in the client application, i.e. real failures. (Note that this compares to 0.15.3 which would being to throw NotServingRegionExceptions after a few tens of thousands of rows).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My data consists of a single table with 5 column families. The data written is as follows:&amp;gt;&amp;gt;&lt;br/&gt;
key: a URL&lt;br/&gt;
family 1: a small string, often emty, 2 longs, 1 int&lt;br/&gt;
family 2: a byte averaging averaging between 1k and 10k, a small string&lt;br/&gt;
family 3: several columns with different names per row, values of small strings&lt;br/&gt;
family 4: most rows have zero columns, some rows have 1 or more columns with a UL value&lt;br/&gt;
The URLs are typically &quot;long-ish&quot; URL as seen when crawling a site, not short home page URLs  &lt;/p&gt;

&lt;p&gt;I am assuming the data is stored in files of the form &amp;lt;hbaseroot&amp;gt;//&amp;lt;tablename&amp;gt;/&amp;lt;9digitnum&amp;gt;/data/mapfiles/&amp;lt;19digitnum&amp;gt;/data. I have attached a csv file showing the distribution of size of these files. Average size is 19Mb, but the sizes are not evenly distributed at all&lt;/p&gt;


&lt;p&gt;Here are two sample exceptions thrown, copied from the region server log:&lt;/p&gt;

&lt;p&gt;2008-02-08 02:08:22,495 INFO org.apache.hadoop.ipc.Server: IPC Server handler 4 on 60020, call batchUpdate(pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@feb215) from 66.135.42.137:38484: error: org.apache.hadoop.hbase.WrongRegionException: Requested row out of range for HRegion pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, startKey=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, getEndKey()=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, row=&apos;http://go2purdue.com/Redeemer_University.cfm?pt=2&amp;amp;sp=2&amp;amp;vid=1199243289_3X02X1468757255&amp;amp;rpt=2&amp;amp;kt=4&amp;amp;kp=1 wap2 20080102081237&apos;&lt;br/&gt;
org.apache.hadoop.hbase.WrongRegionException: Requested row out of range for HRegion pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, startKey=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, getEndKey()=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, row=&apos;http://go2purdue.com/Redeemer_University.cfm?pt=2&amp;amp;sp=2&amp;amp;vid=1199243289_3X02X1468757255&amp;amp;rpt=2&amp;amp;kt=4&amp;amp;kp=1 wap2 20080102081237&apos;&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.checkRow(HRegion.java:1486)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.obtainRowLock(HRegion.java:1531)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.batchUpdate(HRegion.java:1226)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegionServer.batchUpdate(HRegionServer.java:1433)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor10.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:413)&lt;br/&gt;
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)&lt;br/&gt;
2008-02-08 02:08:22,696 INFO org.apache.hadoop.ipc.Server: IPC Server handler 6 on 60020, call batchUpdate(pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@15d9be1) from 66.135.42.137:38484: error: org.apache.hadoop.hbase.WrongRegionException: Requested row out of range for HRegion pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, startKey=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, getEndKey()=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, row=&apos;http://go2umass.com/Travel.cfm?pt=2&amp;amp;sp=2&amp;amp;vid=1199230721_3X04X1485302803&amp;amp;rpt=2&amp;amp;kt=5&amp;amp;kp=8 wap2 20080102081239&apos;&lt;br/&gt;
org.apache.hadoop.hbase.WrongRegionException: Requested row out of range for HRegion pagefetch,&lt;a href=&quot;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011&lt;/a&gt; wap2 20080102052924,1202401088077, startKey=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, getEndKey()=&apos;http://galsn1.mobilook.mobiwap.com/bm/listproducts;jsessionid=D2ED1EB898163CDB27135DC2CF6958B3.197B?rsi=78011 wap2 20080102052924&apos;, row=&apos;http://go2umass.com/Travel.cfm?pt=2&amp;amp;sp=2&amp;amp;vid=1199230721_3X04X1485302803&amp;amp;rpt=2&amp;amp;kt=5&amp;amp;kp=8 wap2 20080102081239&apos;&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.checkRow(HRegion.java:1486)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.obtainRowLock(HRegion.java:1531)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegion.batchUpdate(HRegion.java:1226)&lt;br/&gt;
        at org.apache.hadoop.hbase.HRegionServer.batchUpdate(HRegionServer.java:1433)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor10.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:413)&lt;br/&gt;
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux 2.6.9-67.0.1.ELsmp #1 SMP Wed Dec 19 16:01:12 EST 2007 i686 athlon i386 GNU/Linux&lt;/p&gt;</environment>
        <key id="12388196">HBASE-428</key>
            <summary>Under continuous upload of rows, WrongRegionExceptions are thrown that reach the client even after retries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="happyharris">Marc Harris</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Feb 2008 14:36:14 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:08 +0000</updated>
                            <resolved>Tue, 26 Feb 2008 05:10:32 +0000</resolved>
                                    <version>0.1.0</version>
                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12567052" author="happyharris" created="Fri, 8 Feb 2008 14:45:01 +0000"  >&lt;p&gt;Shows distribution of data file size&lt;/p&gt;</comment>
                            <comment id="12567766" author="stack" created="Mon, 11 Feb 2008 19:33:57 +0000"  >&lt;p&gt;Marc:&lt;/p&gt;

&lt;p&gt;On sizes, yeah, they&apos;ll vary.  In future, just do a ./bin/hadoop fs -lsr on your hbase.rootdir if you want to convey the varying sizes.  The lsr will also show better how the mapfiles are grouped (and we can see if compaction and splitting is keeping up w/ the upload rate).&lt;/p&gt;</comment>
                            <comment id="12567780" author="happyharris" created="Mon, 11 Feb 2008 19:49:47 +0000"  >&lt;p&gt;executed&lt;br/&gt;
   bin/hadoop -fs -lsr / &lt;br/&gt;
as suggested (hbase is the only thing in the hadoop instance)&lt;/p&gt;</comment>
                            <comment id="12567790" author="stack" created="Mon, 11 Feb 2008 20:09:58 +0000"  >&lt;p&gt;Thanks Marc.  That listing looks pretty good.  Says to me that hbase is not being overwhelmed, its just the WRE thats crippled the upload.  If we can figure that...&lt;/p&gt;</comment>
                            <comment id="12567902" author="happyharris" created="Tue, 12 Feb 2008 00:51:04 +0000"  >&lt;p&gt;The results for running select * from .META. in an HBASE shell. I notice that there some non-printable characters. I&apos;m not sure if those are a results of the terminal I was using, or something else. I couldn&apos;t figure out a way to redirect the output of the select command directly to a file.&lt;/p&gt;</comment>
                            <comment id="12569184" author="stack" created="Fri, 15 Feb 2008 06:14:11 +0000"  >&lt;p&gt;Thanks for posting the .META. select Marc.&lt;/p&gt;

&lt;p&gt;I&apos;ve noticed a few things.  Here&apos;s a region whose start and end key is same:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-02-10 16:18:15,134 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_OPEN : pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//fun.twilightwap.com/rate.asp?joke_id=183&amp;amp;rating=0 wap2 20080102055026,1202660291003 from 66.135.42.137:60020
&lt;/span&gt;2008-02-10 16:18:15,134 DEBUG org.apache.hadoop.hbase.HMaster: Main processing loop: PendingOpenOperation from 66.135.42.137:60020
2008-02-10 16:18:15,134 INFO org.apache.hadoop.hbase.HMaster: 66.135.42.137:60020 serving pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//fun.twilightwap.com/rate.asp?joke_id=183&amp;amp;rating=0 wap2 20080102055026,1202660291003
&lt;/span&gt;2008-02-10 16:18:15,134 INFO org.apache.hadoop.hbase.HMaster: regionname: pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620,1202660291003, startKey: &amp;lt;http://flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620&amp;gt;, endKey: &amp;lt;http://fun.twilightwap.com/rate.asp?joke_id=183&amp;amp;rating=0 wap2 20080102055026&amp;gt;, encodedName: 1636112728, tableDesc: {name: pagefetch, families: {changedata:={name: changedata, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, data:={name: data, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, headers:={name: headers, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, info:={name: info, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirects:={name: redirects, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}} open on 66.135.42.137:60020&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the region that was split that produced the above:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-02-10 16:17:54,112 INFO org.apache.hadoop.hbase.HMaster: regionname: pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620,1202660269165, startKey: &amp;lt;http://flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620&amp;gt;, endKey: &amp;lt;http://go2uwash.com/ wap2 20071222205139&amp;gt;, encodedName: 7645492, tableDesc: {name: pagefetch, families: {changedata:={name: changedata, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, data:={name: data, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, headers:={name: headers, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, info:={name: info, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirects:={name: redirects, max versions: 1, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}} open on 66.135.42.137:60020&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like it has go2uwash as end key.  Why doesn&apos;t fun.twilightwap.com region have go2wash as its end key?  The row we are trying to insert is &apos;http://go2purdue.com/Indiana_State_University_Terre_Haute.cfm?pt=2&amp;amp;sp=2&amp;amp;vid=1199235588_3X02X1468516268&amp;amp;rpt=2&amp;amp;kt=5&amp;amp;kp=8 wap2 20080102090745&apos; which would go into this region if go2wash was the end key.&lt;/p&gt;

&lt;p&gt;For good measure, here is the regionserver split report:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-02-10 16:18:12,053 INFO org.apache.hadoop.hbase.HRegionServer: region split, META updated, and report to master all successful. Old region=pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620,1202660269165, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; regions: pagefetch,http://flirtbox.mobi/&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.php?type=html&amp;amp;forum_id=95&amp;amp;topic_index=0 wap2 20071222232620,1202660291003, pagefetch,http://fun.twilightwap.com/rate.asp?joke_id=183&amp;amp;rating=0 wap2 20080102055026,1202660291003. Split took 1sec&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12569186" author="stack" created="Fri, 15 Feb 2008 06:15:06 +0000"  >&lt;p&gt;Marking blocker.  Assigning myself.  Fix needs to be backported.&lt;/p&gt;</comment>
                            <comment id="12569430" author="stack" created="Fri, 15 Feb 2008 21:56:58 +0000"  >&lt;p&gt;Patch to add more logging around split.  Adds consistency check to make sure start and end keys are not same on a split.  Logs split details.&lt;/p&gt;</comment>
                            <comment id="12569569" author="happyharris" created="Sat, 16 Feb 2008 14:33:11 +0000"  >&lt;p&gt;The patch seems to have got past this error, but now a new one (out of heap) occurs later. Possibly this bug should be considered fixed and a new one opened.&lt;/p&gt;

&lt;p&gt;Current results:&lt;br/&gt;
I no longer get WrongRegionException&apos;s&lt;br/&gt;
After approx 700,000 rows uploaded, the region server throws an OutOfMemoryError, followed by many &quot;Server not running&quot; exceptions (exception log below).&lt;br/&gt;
I am able to restart the hbase region and master servers (and the client app), and store another 800,000 rows before the same OutOfMemoryError.&lt;br/&gt;
After that, I can restart the hbase region and master servers (and the client app), but continuing the upload causes more OutOfMemoryError exceptions quickly.&lt;/p&gt;

&lt;p&gt;Full logs will be sent to stack by e-mail.&lt;/p&gt;

&lt;p&gt;008-02-16 02:24:38,884 INFO org.apache.hadoop.hbase.HLog: new log writer created at hdfs://server14:54310/hbase/log_66.135.42.137_1203123804816_60020/hlog.dat.322&lt;br/&gt;
2008-02-16 02:25:45,751 DEBUG org.apache.hadoop.hbase.HRegion: Started memcache flush for region pagefetch,&lt;a href=&quot;http://www.marketwatch.com/hdml&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.marketwatch.com/hdml&lt;/a&gt; wap2 20071222205256,1203126936284. Size 62.6m&lt;br/&gt;
2008-02-16 02:25:57,378 FATAL org.apache.hadoop.hbase.HRegionServer: Set stop flag in regionserver/0:0:0:0:0:0:0:0:60020.cacheFlusher&lt;br/&gt;
java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
	at java.nio.HeapByteBuffer.&amp;lt;init&amp;gt;(HeapByteBuffer.java:39)&lt;br/&gt;
	at java.nio.ByteBuffer.allocate(ByteBuffer.java:312)&lt;br/&gt;
	at org.apache.hadoop.dfs.DFSClient$DFSOutputStream$Packet.&amp;lt;init&amp;gt;(DFSClient.java:1518)&lt;br/&gt;
	at org.apache.hadoop.dfs.DFSClient$DFSOutputStream.writeChunk(DFSClient.java:2125)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.writeChecksumChunk(FSOutputSummer.java:141)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.write1(FSOutputSummer.java:100)&lt;br/&gt;
	at org.apache.hadoop.fs.FSOutputSummer.write(FSOutputSummer.java:86)&lt;br/&gt;
	at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.write(FSDataOutputStream.java:41)&lt;br/&gt;
	at java.io.DataOutputStream.write(DataOutputStream.java:90)&lt;br/&gt;
	at org.apache.hadoop.io.SequenceFile$Writer.append(SequenceFile.java:977)&lt;br/&gt;
	at org.apache.hadoop.io.MapFile$Writer.append(MapFile.java:188)&lt;br/&gt;
	at org.apache.hadoop.hbase.HStoreFile$BloomFilterMapFile$Writer.append(HStoreFile.java:721)&lt;br/&gt;
	at org.apache.hadoop.hbase.HStore.internalFlushCache(HStore.java:1113)&lt;br/&gt;
	at org.apache.hadoop.hbase.HStore.flushCache(HStore.java:1081)&lt;br/&gt;
	at org.apache.hadoop.hbase.HRegion.internalFlushcache(HRegion.java:954)&lt;br/&gt;
	at org.apache.hadoop.hbase.HRegion.flushcache(HRegion.java:852)&lt;br/&gt;
	at org.apache.hadoop.hbase.HRegionServer$Flusher.run(HRegionServer.java:417)&lt;br/&gt;
2008-02-16 02:25:57,405 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 60020, call batchUpdate(pagefetch,&lt;a href=&quot;http://mobility.mobi/showthread.php?goto=newpost&amp;amp;t=2677&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mobility.mobi/showthread.php?goto=newpost&amp;amp;t=2677&lt;/a&gt; wap2 20071223005632,1203126357490, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@9bad5a) from 66.135.42.137:56275: error: java.io.IOException: Server not running&lt;br/&gt;
java.io.IOException: Server not running&lt;br/&gt;
	at org.apache.hadoop.hbase.HRegionServer.checkOpen(HRegionServer.java:1626)&lt;br/&gt;
	at org.apache.hadoop.hbase.HRegionServer.batchUpdate(HRegionServer.java:1429)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor9.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:413)&lt;br/&gt;
	at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)&lt;br/&gt;
2008-02-16 02:25:57,406 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 60020, call getClosestRowBefore(.META.,,1, pagefetch,&lt;a href=&quot;http://pda.physorg.com/lofi-news-seafloor-fault-tsunami_114370203.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://pda.physorg.com/lofi-news-seafloor-fault-tsunami_114370203.html&lt;/a&gt; wap2 20080102111657,999999999999999, 9223372036854775807) from 66.135.42.137:56275: error: java.io.IOException: Server not running&lt;/p&gt;
</comment>
                            <comment id="12569620" author="stack" created="Sat, 16 Feb 2008 23:14:07 +0000"  >&lt;p&gt;Marc, see if #3 in the FAQ helps: &lt;a href=&quot;http://wiki.apache.org/hadoop/Hbase/FAQ#3&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://wiki.apache.org/hadoop/Hbase/FAQ#3&lt;/a&gt;.  Let us know how it goes.&lt;/p&gt;</comment>
                            <comment id="12569623" author="stack" created="Sat, 16 Feb 2008 23:44:10 +0000"  >&lt;p&gt;Cleaned up version of patch I sent to Marc&lt;/p&gt;</comment>
                            <comment id="12569626" author="stack" created="Sun, 17 Feb 2008 00:29:04 +0000"  >&lt;p&gt;Thanks for sending the logs Marc.  I took a look.  Things are messy &amp;#8211; lots of concurrent compactions going on &amp;#8211; but seemed to be holding up.&lt;/p&gt;

&lt;p&gt;The patch doesn&apos;t actually prevent the core problem.  The patch added extra logging and it added not splitting if it would result in a region that had same start and end key.  Here&apos;s what I see:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-02-16 02:03:05,324 DEBUG org.apache.hadoop.hbase.HRegion: Split details &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; pagefetch,http:&lt;span class=&quot;code-comment&quot;&gt;//www.marketwatch.com/hdml wap2 20071222205256,1203126936284: startKey http://www.marketwatch.com/hdml wap2 20071222205256, midkey: http://www.marketwatch.com/hdml wap2 20071222205256, endKey http://www.myarmoury.com/mobile wap2 20071222205348
&lt;/span&gt;2008-02-16 02:03:05,324 DEBUG org.apache.hadoop.hbase.HRegion: Startkey and midkey are same, not splitting
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In other words, no more WrongRegionExceptions because we notice ahead of time that the split will produce a region w/ same start and end key and we skip.  Watching the logs, the region continues to grow in size and further attempts at splitting also pass because it would result in region w/ same start and end key.  There is something up in our midkey calculation.&lt;/p&gt;
</comment>
                            <comment id="12569632" author="stack" created="Sun, 17 Feb 2008 01:10:49 +0000"  >&lt;p&gt;v3 has more cleanup.  Fixes rare case where if a store file had a single entry only, we were overwriting the calculated midKey for the region (could be whats wrong w/ our midkey calc. but wouldn&apos;t want to bet on it &amp;#8211; seems like too rare an occurance).&lt;/p&gt;

&lt;p&gt;M  src/java/org/apache/hadoop/hbase/HStoreFile.java&lt;br/&gt;
    (finalKey) Removed checkKey if trying to get finalKey on top-half&lt;br/&gt;
    of a HalfMapFile.  Was failing because it would compare the&lt;br/&gt;
    HalfMapFile midkey to the empty passed key into which we&apos;re to&lt;br/&gt;
    set the mapfile last key.&lt;br/&gt;
M src/java/org/apache/hadoop/hbase/HStore.java&lt;br/&gt;
    If a return is being done inside the &apos;if&apos; of an &apos;if/else&apos;, then&lt;br/&gt;
    the else is not needed.  Fixed two of these.  Removed commented&lt;br/&gt;
    out logging.  Rewrote a cumbersome if/else as a ?:.&lt;br/&gt;
    Removed unused rowKey assignment. Removed unnecessary casts.&lt;br/&gt;
    Renamed localvariable midkey as mk because it was too close&lt;br/&gt;
    to the passed in arg midKey.  Do NOT copy&lt;br/&gt;
    midkey/mk before test that it was equal to start/end keys. A&lt;br/&gt;
    store could have a midkey/mk that equaled region start/end keys&lt;br/&gt;
    and we were nonetheless overwriting midKey, the passed in&lt;br/&gt;
    arg.&lt;br/&gt;
M src/java/org/apache/hadoop/hbase/HRegionServer.java&lt;br/&gt;
    Removed commented out code.  Output full regioninfo when splitting&lt;br/&gt;
    so can see start and end keys, etc.&lt;br/&gt;
M  src/java/org/apache/hadoop/hbase/HRegion.java&lt;br/&gt;
    If end or start key matches mid key, don&apos;t split.&lt;/p&gt;</comment>
                            <comment id="12569633" author="stack" created="Sun, 17 Feb 2008 01:34:11 +0000"  >&lt;p&gt;Added test for splittability.  We were going ahead calculating midkey though store wasn&apos;t splittalble anways &apos;cos it still had references.&lt;/p&gt;</comment>
                            <comment id="12570363" author="bryanduxbury" created="Tue, 19 Feb 2008 18:42:44 +0000"  >&lt;p&gt;+1 the patch passes unit tests for me locally. &lt;/p&gt;</comment>
                            <comment id="12570373" author="stack" created="Tue, 19 Feb 2008 19:04:07 +0000"  >&lt;p&gt;Applied v4 to branch and trunk.  Will wait on feedback from Marc as to whether this addresses his issue.&lt;/p&gt;</comment>
                            <comment id="12572210" author="bryanduxbury" created="Mon, 25 Feb 2008 20:21:48 +0000"  >&lt;p&gt;This needs to get done before 0.2 can roll.&lt;/p&gt;</comment>
                            <comment id="12572282" author="happyharris" created="Mon, 25 Feb 2008 22:34:37 +0000"  >&lt;p&gt;Since applying 428-v4.patch and increasing my heap to 2G, I have not had a recurrence of this issue.&lt;/p&gt;</comment>
                            <comment id="12572359" author="stack" created="Tue, 26 Feb 2008 05:10:32 +0000"  >&lt;p&gt;Marc sent me logs of an uploading to review.  No more instances of WRE.  Splits, compactions, and flushes run fine.   Resolving.&lt;/p&gt;</comment>
                            <comment id="12573479" author="happyharris" created="Thu, 28 Feb 2008 22:01:57 +0000"  >&lt;p&gt;428-v4.patch was made against slightly the wrong version. v4 included the removal of some commented out code in HRegionServer.java that caused the patch to fail (the code was already removed in the official 0.16.0-rc1 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12375766" name="428-2.patch" size="2948" author="stack" created="Sat, 16 Feb 2008 23:44:10 +0000"/>
                            <attachment id="12375768" name="428-v3.patch" size="7401" author="stack" created="Sun, 17 Feb 2008 01:10:49 +0000"/>
                            <attachment id="12375769" name="428-v4.patch" size="10829" author="stack" created="Sun, 17 Feb 2008 01:34:11 +0000"/>
                            <attachment id="12376771" name="428-v5.patch" size="10395" author="happyharris" created="Thu, 28 Feb 2008 22:01:57 +0000"/>
                            <attachment id="12375719" name="428.patch" size="3124" author="stack" created="Fri, 15 Feb 2008 21:56:58 +0000"/>
                            <attachment id="12375075" name="filesbysize.csv" size="23759" author="happyharris" created="Fri, 8 Feb 2008 14:45:01 +0000"/>
                            <attachment id="12375263" name="lsr" size="148549" author="happyharris" created="Mon, 11 Feb 2008 19:49:47 +0000"/>
                            <attachment id="12375293" name="selectfrommeta.txt" size="124135" author="happyharris" created="Tue, 12 Feb 2008 00:51:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Feb 2008 19:33:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25193</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h793:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98437</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>