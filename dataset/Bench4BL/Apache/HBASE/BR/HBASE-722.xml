<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:28:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-722/HBASE-722.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-722] Shutdown and Compactions</title>
                <link>https://issues.apache.org/jira/browse/HBASE-722</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently I thank the region server closes the region spits in a set order this same order is used in the compaction/spit thread after a startup and all regions need compaction.&lt;br/&gt;
This causes the shutdown time to take a vary long time depending on what region the server is compacting.&lt;br/&gt;
I have seen my cluster take more then 60 mins to  shutdown waiting for several regions to finish compaction.&lt;/p&gt;

&lt;p&gt;The problem I am seeing is say the compaction thread is working on a on region 2 of 4 in the list.&lt;br/&gt;
When the region server get the  MSG_REGIONSERVER_QUIESCE from the master it closes in order from 1-4&lt;br/&gt;
So it closes region 1 and waits for region 2 to finish compaction before closing it.&lt;/p&gt;

&lt;p&gt;The problem is it never closes region split 3 or 4 while waiting for region 2 to complete the compaction.&lt;/p&gt;

&lt;p&gt;So example say 3 and 4 regions are waiting to be compacted also. When region 2 is done region 3 start compaction within milliseconds of 2&apos;s finished compaction.&lt;br/&gt;
This happens faster then the region server can close region 3 so the region server hangs around compacting regions until it run out of open regions needing compact.&lt;br/&gt;
With a lot of regions this could hang some region server a long time to Shutdown the cluster.&lt;/p&gt;

&lt;p&gt;Solutions 1 or 2 below will work I thank&lt;br/&gt;
1. Close all regions not currently getting compaction so when the compaction thread complete it has no other regions open to compact &lt;br/&gt;
2. Empty the compaction que so it has no other regions to compact when done with the current one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12399593">HBASE-722</key>
            <summary>Shutdown and Compactions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="viper799">Billy Pearson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Jul 2008 05:29:39 +0000</created>
                <updated>Sun, 13 Sep 2009 22:26:25 +0000</updated>
                            <resolved>Mon, 10 Nov 2008 18:56:22 +0000</resolved>
                                                    <fixVersion>0.19.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12611448" author="stack" created="Tue, 8 Jul 2008 04:19:58 +0000"  >&lt;p&gt;If a shutdown has been asked for, yeah, I think we should close rather than compact and close.&lt;/p&gt;

&lt;p&gt;We&apos;ll compact on open too if we find region needs it so open will be slow if we don&apos;t do it on close.&lt;/p&gt;

&lt;p&gt;We need to do it in one of the places else system can be overrun.&lt;/p&gt;

&lt;p&gt;What do you think more important; fast shutdown or deploy?&lt;/p&gt;</comment>
                            <comment id="12611459" author="viper799" created="Tue, 8 Jul 2008 05:39:28 +0000"  >&lt;p&gt;Sense we compact in the background if needed after loading the region on startup and  the compaction thread does not effect the loading of newly assigned region opens from the master. I thank shutdown should close all regions unless compacting and close the last one after the compaction is done. That will not always be a fast shutdown but it will be faster then if there is compaction on more then one region while shutting down.&lt;/p&gt;</comment>
                            <comment id="12611691" author="stack" created="Tue, 8 Jul 2008 17:07:50 +0000"  >&lt;p&gt;I think the compactions are inlined with region open at the moment but I do not think it would be much work to queue a compaction and proceed with the region deploy.&lt;/p&gt;</comment>
                            <comment id="12611828" author="viper799" created="Tue, 8 Jul 2008 22:15:59 +0000"  >&lt;p&gt;I thank we have always queue up the compaction&apos;s on start up. might check but I have always seen this when start with a lot of regions needing compaction. so I thank that part is fine.&lt;/p&gt;

&lt;p&gt;The part on shutdown the simplest solution above is the second one &lt;br/&gt;
Empty the compaction queue so it has no other regions to compact when done with the current one on shutdown message received.&lt;br/&gt;
I thank that would be a simple fix and should workout fine for stopping the compaction of more then the current compaction on shutdown.&lt;/p&gt;</comment>
                            <comment id="12645105" author="stack" created="Tue, 4 Nov 2008 23:26:21 +0000"  >&lt;p&gt;Add more checks for server stop to compactsplit thread.  Don&apos;t start split or even compaction if we&apos;ve been asked stop.  Don&apos;t queue requests for compaction if we&apos;ve been asked stop.  Threaded close of regions so all run in parallel.  Move static methods from head of HRegion to tail.  People expect constructors at top of classes, not utility methods.&lt;/p&gt;</comment>
                            <comment id="12645107" author="stack" created="Tue, 4 Nov 2008 23:32:43 +0000"  >&lt;p&gt;Billy, if you are around, see what you think of this patch.  I&apos;ll test it more but would appreciate an opinion.&lt;/p&gt;</comment>
                            <comment id="12646039" author="viper799" created="Sun, 9 Nov 2008 00:40:45 +0000"  >&lt;p&gt;If it still apply to trunk I will test tonight.&lt;/p&gt;</comment>
                            <comment id="12646139" author="viper799" created="Mon, 10 Nov 2008 01:21:50 +0000"  >&lt;p&gt;+1 looks good I only tested with 2 regions but looks like the regions are both getting closed in parallel.&lt;br/&gt;
that will solve the problem of multi regions compactions happening on the same server at shutdown&lt;/p&gt;</comment>
                            <comment id="12646324" author="stack" created="Mon, 10 Nov 2008 18:56:22 +0000"  >&lt;p&gt;Committed (Thanks for trying it Billy).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12393338" name="722.patch" size="19893" author="stack" created="Tue, 4 Nov 2008 23:26:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 8 Jul 2008 04:19:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25360</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h91r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98728</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>