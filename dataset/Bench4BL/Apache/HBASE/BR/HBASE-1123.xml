<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:33:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1123/HBASE-1123.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1123] Server never leaves the dead list though logs have all been processed if crashed server had -ROOT- (seemingly)</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1123</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Cluster is just hung after host that had &lt;del&gt;ROOT&lt;/del&gt; completed splitting its logs... old server is just stuck on the dead list and never comes off it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;..
2009-01-13 01:09:36,448 [HMaster] DEBUG org.apache.hadoop.hbase.regionserver.HLog: Splitting 6 of 6: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/log_XX.XX.XX.142_1231717984112_60020/hlog.dat.1231718928939
&lt;/span&gt;2009-01-13 01:09:37,396 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Waiting on XX.XX.XX142:60020 removal from dead list before processing report-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-duty request
2009-01-13 01:09:38,591 [HMaster] DEBUG org.apache.hadoop.hbase.regionserver.HLog: Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; log file writer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; path hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/TestTable/712889985/oldlogfile.log and region TestTable,0040922294,1231559109829
&lt;/span&gt;2009-01-13 01:09:38,670 [HMaster] DEBUG org.apache.hadoop.hbase.regionserver.HLog: Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; log file writer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; path hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/TestTable/484208094/oldlogfile.log and region TestTable,0042007133,1231628296909
&lt;/span&gt;2009-01-13 01:09:45,096 [HMaster] INFO org.apache.hadoop.hbase.regionserver.HLog: log file splitting completed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hdfs:&lt;span class=&quot;code-comment&quot;&gt;//aa0-000-12.u.powerset.com:9000/hbasetrunk2/log_XX.XX.XX.142_1231717984112_60020
&lt;/span&gt;2009-01-13 01:09:47,317 [SocketListener0-2] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &amp;lt;&amp;gt; in tableName .META.: location serverXX.XX.XX.142:60020, location region name .META.,,1
2009-01-13 01:09:47,416 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Waiting on XX.XX.XX142:60020 removal from dead list before processing report-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-duty request
2009-01-13 01:09:47,518 [IPC Server handler 3 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region -ROOT-,,0 to server XX.XX.XX141:60020
2009-01-13 01:09:49,007 [IPC Server handler 6 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Total Load: 430, Num Servers: 3, Avg Load: 144.0
2009-01-13 01:09:50,219 [SocketListener0-0] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &amp;lt;&amp;gt; in tableName .META.: location server XX.XX.XX.142:60020, location region name .META.,,1
2009-01-13 01:09:50,539 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_PROCESS_OPEN: -ROOT-,,0 from XX.XX.XX.141:60020
2009-01-13 01:09:50,539 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: -ROOT-,,0 from 208.76.44.141:60020
2009-01-13 01:09:50,719 [SocketListener0-3] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &amp;lt;&amp;gt; in tableName .META.: location server XX.XX.XX.142:60020, location region name .META.,,1
2009-01-13 01:09:50,967 [SocketListener0-4] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &amp;lt;&amp;gt; in tableName .META.: location serverXX.XX.XX.142:60020, location region name .META.,,1
2009-01-13 01:09:52,117 [SocketListener0-5] DEBUG org.apache.hadoop.hbase.client.HConnectionManager$TableServers: Cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &amp;lt;&amp;gt; in tableName .META.: location server XX.XX.XX.142:60020, location region name .META.,,1
....
2009-01-13 01:09:57,426 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Waiting on XX.XX.XX.142:60020 removal from dead list before processing report-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-duty request
....
2009-01-13 01:10:45,156 [HMaster] DEBUG org.apache.hadoop.hbase.master.HMaster: Processing todo: ProcessServerShutdown of XX.XX.XX142:60020
2009-01-13 01:10:45,156 [HMaster] INFO org.apache.hadoop.hbase.master.RegionServerOperation: process shutdown of server XX.XX.XX.142:60020: logSplit: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, rootRescanned: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, numberOfMetaRegions: 1, onlineMetaRegions.size(): 1
2009-01-13 01:10:45,156 [HMaster] DEBUG org.apache.hadoop.hbase.master.ProcessServerShutdown$ScanRootRegion: process server shutdown scanning root region on XX.XX.XX.141
2009-01-13 01:10:45,182 [HMaster] DEBUG org.apache.hadoop.hbase.master.RegionServerOperation: process server shutdown scanning root region on XX.XX.XX.141 finished HMaster
2009-01-13 01:10:45,183 [HMaster] DEBUG org.apache.hadoop.hbase.master.ProcessServerShutdown$ScanMetaRegions: process server shutdown scanning .META.,,1 on XX.XX.XX.142:60020
2009-01-13 01:10:47,496 [IPC Server handler 4 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Waiting on XX.XX.XX.142:60020 removal from dead list before processing report-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-duty request
2009-01-13 01:10:49,320 [IPC Server handler 8 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Total Load: 431, Num Servers: 3, Avg Load: 144.0
.....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12412269">HBASE-1123</key>
            <summary>Server never leaves the dead list though logs have all been processed if crashed server had -ROOT- (seemingly)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Jan 2009 05:36:06 +0000</created>
                <updated>Wed, 17 Jun 2009 08:12:48 +0000</updated>
                            <resolved>Wed, 17 Jun 2009 08:12:48 +0000</resolved>
                                    <version>0.19.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12665177" author="jimk" created="Mon, 19 Jan 2009 18:20:26 +0000"  >&lt;p&gt;A dead server is not removed from the deadServer list until ProcessServerShutdown has split the logs and&lt;br/&gt;
scanned all the meta regions for regions that the dead server was serving.&lt;/p&gt;

&lt;p&gt;The root region will get reassigned immediately after the log is split (if the dead server was serving the&lt;br/&gt;
root region).&lt;/p&gt;

&lt;p&gt;If the dead server was serving other regions, ProcessServerShutdown is requeued to wait for the root&lt;br/&gt;
region to come back on-line.&lt;/p&gt;

&lt;p&gt;Once the root region is back on-line, it can be scanned for any meta regions that the dead server was&lt;br/&gt;
serving. If there are any, they are marked as unassigned and ProcessServerShutdown is requeued to&lt;br/&gt;
wait for all the meta regions to be on-line.&lt;/p&gt;

&lt;p&gt;Once all the meta regions are on-line, they can be scanned and any that were being served by the&lt;br/&gt;
dead server are marked as unassigned.&lt;/p&gt;

&lt;p&gt;At this point, the dead server is removed from the dead server list.&lt;/p&gt;</comment>
                            <comment id="12665184" author="jimk" created="Mon, 19 Jan 2009 18:31:07 +0000"  >&lt;p&gt;This patch changes deadServers from a Map back to a Set as logs split is not used.&lt;/p&gt;</comment>
                            <comment id="12665203" author="jimk" created="Mon, 19 Jan 2009 19:42:02 +0000"  >&lt;p&gt;Anticipating a different approach post ZooKeeper integration.&lt;/p&gt;</comment>
                            <comment id="12665212" author="stack" created="Mon, 19 Jan 2009 20:03:51 +0000"  >&lt;p&gt;Approach to what?&lt;/p&gt;</comment>
                            <comment id="12665214" author="jimk" created="Mon, 19 Jan 2009 20:08:40 +0000"  >&lt;p&gt;@stack: different approach to lease management&lt;/p&gt;</comment>
                            <comment id="12665216" author="jimk" created="Mon, 19 Jan 2009 20:11:21 +0000"  >&lt;p&gt;There are a number of problems here:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Leases should not only be identified by server name and port number&lt;br/&gt;
  but also by the server start code.  Since HLog directory names&lt;br/&gt;
  include the start code, if a server should crash and restart before&lt;br/&gt;
  the old lease expires, there is no danger of the new incarnation of&lt;br/&gt;
  the server overwriting the old instance&apos;s HLog. It can then be put&lt;br/&gt;
  back to work immediately.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If a server&apos;s lease does time out, (because it hasn&apos;t reported in)&lt;br/&gt;
  and the region server reports in, we should not wait in a region&lt;br/&gt;
  server report thread in the master because cleaning up after the&lt;br/&gt;
  server could take longer than IPC timeout.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The order in which events happen when a region server receives a&lt;br/&gt;
  MSG_CALL_SERVER_STARTUP is incorrect. The region server should call&lt;br/&gt;
  reportForDuty before creating a new HLog.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12665217" author="stack" created="Mon, 19 Jan 2009 20:13:30 +0000"  >&lt;p&gt;The above seem like good stuff but how do any of the above impinge on this issue?&lt;/p&gt;</comment>
                            <comment id="12665221" author="jimk" created="Mon, 19 Jan 2009 20:38:45 +0000"  >&lt;p&gt;&amp;gt; stack - 19/Jan/09 12:13 PM&lt;br/&gt;
&amp;gt; The above seem like good stuff but how do any of the above impinge&lt;br/&gt;
&amp;gt; on this issue? &lt;/p&gt;

&lt;p&gt;Here&apos;s what I think happened:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;region server crashed&lt;/li&gt;
	&lt;li&gt;lease timed out&lt;/li&gt;
	&lt;li&gt;master starts recovery (can take quite a while to complete)&lt;/li&gt;
	&lt;li&gt;region server restarts&lt;/li&gt;
	&lt;li&gt;region server sends region server startup message to master&lt;/li&gt;
	&lt;li&gt;master waits in rpc handler for old server cleanup (because it&lt;br/&gt;
  cannot differentiate the new instance from the old). &lt;/li&gt;
	&lt;li&gt;ipc from region server to master times out&lt;/li&gt;
	&lt;li&gt;region server sends a new startup message. The master thread starts&lt;br/&gt;
  waiting in the rpc handler for old server cleanup.&lt;/li&gt;
	&lt;li&gt;ipc from region server to master times out&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;This could easily result in all the master&apos;s region server rpc&lt;br/&gt;
handlers waiting for essentially the same event until&lt;br/&gt;
ProcessServerShutdown completes and removes the original dead server&lt;br/&gt;
from the dead servers list. (and if not all the master&apos;s region server&lt;br/&gt;
threads are tied up, it would severely impair the master&apos;s ability to&lt;br/&gt;
respond to other region server requests)&lt;/p&gt;
</comment>
                            <comment id="12665229" author="stack" created="Mon, 19 Jan 2009 21:01:09 +0000"  >&lt;p&gt;What would &apos;ipc from region server to master times out&apos; look like?&lt;/p&gt;</comment>
                            <comment id="12665291" author="jimk" created="Tue, 20 Jan 2009 00:27:27 +0000"  >&lt;p&gt;I would expect to see rpc retry messages in the region server log, followed by a LOG.error or LOG.warning with an exception.&lt;/p&gt;</comment>
                            <comment id="12665292" author="stack" created="Tue, 20 Jan 2009 00:35:44 +0000"  >&lt;p&gt;Why retry?  Its connected fine and no exceptions thrown out of the server.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a scenario so you are better than I in this respect.  Can you replicate what you describe (Just hold on to a HRS when it reports into master).  See if you can manufacture what you speculate?&lt;/p&gt;</comment>
                            <comment id="12665296" author="jimk" created="Tue, 20 Jan 2009 00:45:03 +0000"  >&lt;p&gt;I&apos;d expect it to be similar to what happens when a region server does not respond to a client because it is too busy.&lt;br/&gt;
Don&apos;t we get rpc retries in that case?&lt;/p&gt;

&lt;p&gt;I don&apos;t have the region server log, so I can&apos;t tell exactly what happened in this case. Is there a region server log still&lt;br/&gt;
available from when this happened?&lt;/p&gt;</comment>
                            <comment id="12665297" author="stack" created="Tue, 20 Jan 2009 00:49:55 +0000"  >&lt;p&gt;Its not similar.  We&apos;re already connected (Retries happen when we get exception or can&apos;t connect).  I don&apos;t have the log.   Suggest you try replicating.  Should be easy enough... just hold on to regionserver when it registers and not let go of it.&lt;/p&gt;</comment>
                            <comment id="12667384" author="jimk" created="Mon, 26 Jan 2009 20:12:09 +0000"  >&lt;p&gt;On hbase-0.19 branch, I could not reproduce this. I killed the server holding root while cluster was under load&lt;br/&gt;
and it exited the waiting state in 1:01 (min:secs):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-01-26 19:26:32,266 INFO org.apache.hadoop.hbase.master.RegionManager: assigning region -ROOT-,,0 to server 208.76.44.141:8020

2009-01-26 19:41:08,396 INFO org.apache.hadoop.hbase.master.ServerManager: 208.76.44.141:8020 lease expired
2009-01-26 19:42:10,757 DEBUG org.apache.hadoop.hbase.master.RegionServerOperation: Removed 208.76.44.141:8020 from deadservers Map
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I then waited for the cluster to rebalance, again put it under load, and killed the server holding the root region.&lt;br/&gt;
It took a little longer (2 min 19 sec) before the server was removed from the dead list.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-01-26 19:41:11,808 INFO org.apache.hadoop.hbase.master.RegionManager: assigning region -ROOT-,,0 to server 208.76.44.139:8020

2009-01-26 19:49:01,966 INFO org.apache.hadoop.hbase.master.ServerManager: 208.76.44.139:8020 lease expired
2009-01-26 19:51:20,354 DEBUG org.apache.hadoop.hbase.master.RegionServerOperation: Removed 208.76.44.139:8020 from deadservers Map
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, if leases included the start code, we could have put the restarted server back into service much sooner, as it&lt;br/&gt;
would not interfere with the splitting of logs (which include the start code in their name).&lt;/p&gt;
</comment>
                            <comment id="12667410" author="jimk" created="Mon, 26 Jan 2009 20:52:55 +0000"  >&lt;p&gt;Marking as trivial but leaving open as I was unable to reproduce the problem. If we don&apos;t see this again &lt;br/&gt;
after a while, we can then close the issue out.&lt;/p&gt;</comment>
                            <comment id="12720549" author="stack" created="Wed, 17 Jun 2009 08:12:48 +0000"  >&lt;p&gt;Marking as fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1457&quot; title=&quot;Taking down ROOT/META regionserver can result in cluster becoming in-operational&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1457&quot;&gt;&lt;del&gt;HBASE-1457&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12398250" name="1123.patch" size="1290" author="jimk" created="Mon, 19 Jan 2009 18:31:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 19 Jan 2009 18:20:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hbgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99119</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>