<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:39:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-501/HBASE-501.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-501] Empty region server address in info:server entry and a startcode of -1 in .META.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-501</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Manufactured a region empty server address and a startcode of -1 when a regionserver was slow to open a region and the alternative regionserver that had been asked open the region fails and reports CLOSE to the master.&lt;/p&gt;

&lt;p&gt;Here&apos;s long version of story:&lt;/p&gt;

&lt;p&gt;Region is enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==.  Was originally on XX.XX.XX.184:60020 but this node ran out of memory (though it had 2G).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-03-08 00:29:39,472 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 60020, call batchUpdate(enwiki_071018,6q_ORe3mPzBTOnenVGS6zk==,1204860472398, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@126d2380) from XX.XX.XX.233:54292: error: java.io.IOException: java.lang.OutOfMemoryError: Java heap space
java.io.IOException: java.lang.OutOfMemoryError: Java heap space
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.clone(Native Method)
        at java.lang.reflect.Method.getParameterTypes(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.searchMethods(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.getMethod0(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.getMethod(Unknown Source)
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:408)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)
2008-03-08 00:29:39,472 WARN org.apache.hadoop.ipc.Server: Out of Memory in server select
java.lang.OutOfMemoryError: Java heap space
        at java.util.HashMap.newKeyIterator(Unknown Source)
        at java.util.HashMap$KeySet.iterator(Unknown Source)
        at java.util.HashSet.iterator(Unknown Source)
        at sun.nio.ch.SelectorImpl.processDeregisterQueue(Unknown Source)
        at sun.nio.ch.PollSelectorImpl.doSelect(Unknown Source)
        at sun.nio.ch.SelectorImpl.lockAndDoSelect(Unknown Source)
        at sun.nio.ch.SelectorImpl.select(Unknown Source)
        at sun.nio.ch.SelectorImpl.select(Unknown Source)
        at org.apache.hadoop.ipc.Server$Listener.run(Server.java:323)
2008-03-08 00:31:15,300 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 60020, call batchUpdate(enwiki_080103_meta,,1204867086244, 9223372036854775807, org.apache.hadoop.hbase.io.BatchUpdate@2d13981b) from XX.XX.XX.233:54810: error: java.io.IOException: java.lang.OutOfMemoryError: Java heap space
java.io.IOException: java.lang.OutOfMemoryError: Java heap space
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.&amp;lt;init&amp;gt;(Unknown Source)
        at java.lang.StringBuilder.toString(Unknown Source)
        at org.apache.hadoop.hbase.ipc.HbaseRPC$Server.call(HbaseRPC.java:415)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Was given to XX.XX.XX.227 at 00:36:20 but this server is crazy replaying a bunch of edits (Need to stop emitting edits in HStore &amp;#8211; 496 removed outputting skipped edits).  It can&apos;t put the region up immediately.  Takes a long time. &lt;/p&gt;

&lt;p&gt;Then given to XX.XX.XX.183 at 00:37:26. It fails to open with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-03-08 00:37:29,827 INFO org.apache.hadoop.hbase.HRegion: compaction completed on region enwiki_071018,AYtsfKtThdIJkVLUSKipA-==,1204860383810. Took 5sec
2008-03-08 00:37:29,943 ERROR org.apache.hadoop.hbase.HRegionServer: error opening region enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
org.apache.hadoop.ipc.RemoteException: java.io.IOException: Could not complete write to file /hbase/aa0-005-2.u.powerset.com/enwiki_080103/1578810967/page/mapfiles/5679937491167886060/data by DFSClient_-540201177
        at org.apache.hadoop.dfs.NameNode.complete(NameNode.java:341)
        at sun.reflect.GeneratedMethodAccessor19.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
        at java.lang.reflect.Method.invoke(Unknown Source)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sends a CLOSE to the master.&lt;/p&gt;

&lt;p&gt;Then 227 says its successfully opened region.&lt;/p&gt;

&lt;p&gt;Master says region server XX.XX.XX.227:60020 should not have opened region enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985&lt;/p&gt;

&lt;p&gt;Now the server field in META is empty.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 59 2008-03-08 00:38:09,167 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985, startKey: &amp;lt;CzQ7UPCw-AoIn2JzSEN_pV==&amp;gt;, endKey: &amp;lt;DUwzKe-niVjzlXs1SvrvVk==&amp;gt;, encodedName: 1578810967, offline: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, tableDesc: {name: enwiki_080103,         families: {anchor:={name: anchor, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, misc:={name: misc, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, page:={name: page, max versions: 3, compression: NONE, i        n memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirect:={name: redirect, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: , startCode: -1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12390518">HBASE-501</key>
            <summary>Empty region server address in info:server entry and a startcode of -1 in .META.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Mar 2008 02:32:17 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:10 +0000</updated>
                            <resolved>Thu, 13 Mar 2008 19:37:24 +0000</resolved>
                                    <version>0.16.0</version>
                    <version>0.1.0</version>
                    <version>0.2.0</version>
                                    <fixVersion>0.1.0</fixVersion>
                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12576478" author="stack" created="Sat, 8 Mar 2008 02:34:01 +0000"  >&lt;p&gt;Edited master log showing sequence of events for pertinent region.&lt;/p&gt;</comment>
                            <comment id="12576494" author="stack" created="Sat, 8 Mar 2008 06:13:00 +0000"  >&lt;p&gt;Saw this sequence happen again.  Here is relevant master log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-03-08 00:37:32,349 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_CLOSE : enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985 from XX.XX.XX.183:60020
2008-03-08 00:37:32,349 INFO org.apache.hadoop.hbase.HMaster: XX.XX.XX.183:60020 no longer serving enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
2008-03-08 00:37:32,350 DEBUG org.apache.hadoop.hbase.HMaster: Main processing loop: ProcessRegionClose of enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
2008-03-08 00:37:32,350 INFO org.apache.hadoop.hbase.HMaster: region closed: enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
2008-03-08 00:37:32,350 DEBUG org.apache.hadoop.hbase.HMaster: numberOfMetaRegions: 1, onlineMetaRegions.size(): 1
2008-03-08 00:37:41,845 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_OPEN : enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985 from XX.XX.XX.227:60020
2008-03-08 00:37:41,845 DEBUG org.apache.hadoop.hbase.HMaster: region server XX.XX.XX.227:60020 should not have opened region enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This comment from HMaster is a little confusing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-comment&quot;&gt;// NOTE: we cannot put the region into unassignedRegions as that
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;//       could create a race with the pending close &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it gets 
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;//       reassigned before the close is processed.
&lt;/span&gt;
          unassignedRegions.remove(region);

          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            toDoQueue.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProcessRegionClose(region, reassignRegion,
                deleteRegion));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We add the region to the unassignedRegions in spite of the comment... I notice then that when the MSG_REPORT_OPEN comes in, the first thing we do is remove the region from unassigned regions.  Is this removal what is making it so the region never gets assigned again?  Jim?&lt;/p&gt;</comment>
                            <comment id="12576496" author="stack" created="Sat, 8 Mar 2008 06:13:52 +0000"  >&lt;p&gt;Making it a blocker because happened twice in one night and when it happens, table is horked.&lt;/p&gt;</comment>
                            <comment id="12576497" author="stack" created="Sat, 8 Mar 2008 06:27:38 +0000"  >&lt;p&gt;Regions when they get into this state are offline and client accesses get an ISA &apos;offline region&apos; exception.&lt;/p&gt;</comment>
                            <comment id="12576503" author="stack" created="Sat, 8 Mar 2008 07:09:27 +0000"  >&lt;p&gt;I understand the above comment now but I do not see this log from shutdown message so the reassignRegion flag is false for some reason and it shouldn&apos;t be:&lt;/p&gt;

&lt;p&gt;LOG.info(&quot;reassign region: &quot; + regionInfo.getRegionName());&lt;/p&gt;

&lt;p&gt;Attached is a small patch for 0.1 that cleans up some of the noise in logs and that adds better logging on whats happening here around this close.&lt;/p&gt;

&lt;p&gt;I seem to have &apos;fixed&apos; this broken region by running &apos;enable TABLE_NAME;&apos; even though this table is technically &apos;online&apos;.  Running this command changed the offline flag on this region.  It then picked up startcode and a server.&lt;/p&gt;</comment>
                            <comment id="12576614" author="jimk" created="Sat, 8 Mar 2008 21:13:39 +0000"  >&lt;p&gt;How is this different from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-27&quot; title=&quot;[hbase] hregioninfo cell empty in meta table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-27&quot;&gt;&lt;del&gt;HBASE-27&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="12576633" author="stack" created="Sat, 8 Mar 2008 22:28:57 +0000"  >&lt;p&gt;hbase-27 is just about some of the cells in meta being empty, usually the regioninfo, server, and startcode leaving split cell vestiges.  Nothings &apos;broken&apos;. &lt;/p&gt;

&lt;p&gt;This is about a scenario that manufactures an offlined region in an online table.   The region has a regioninfo in META but its offlined, there is no startcode or server (shows as -1 and empty in master log respectively) and we never get around to reassigning this region; it just sits there in the middle of the table breaking it.&lt;/p&gt;

&lt;p&gt;When we have one of these, we get ISAs in client &amp;#8211; seen by a few folks, Lars for one &amp;#8211; and the offlined regions have also been noticed by others.&lt;/p&gt;

&lt;p&gt;Looks like its the CLOSE that offlines the region.  Should it?  I suppose thats fair but we don&apos;t put it back on to the unassigned list.  We don&apos;t see the &apos;reassign region&apos; log message?  Its as though the region was on the kill or delete list when CLOSE is running but I can&apos;t see how it got there.&lt;/p&gt;

&lt;p&gt;Adding new noise patch.  Adds in logging around CLOSE.&lt;/p&gt;

&lt;p&gt;This is sample of &apos;noise&apos; patch cleans up in HLog (Log just keeps outputting this map everytime new element is added):&lt;/p&gt;

&lt;p&gt;2008-03-08 00:35:21,886 DEBUG org.apache.hadoop.hbase.HLog: Creating new log file writer for path hdfs://coral-dfs.cluster.powerset.com:10000/hbase/aa0-005-2.u.powerset.com/enwiki_080103/2055991669/oldlogfile.log; map content &lt;/p&gt;
{enwiki_080103_meta,dy9fcHV_BBQzozASgqoQdk==,1204867224716=org.apache.hadoop.io.SequenceFile$Writer@5e956133, enwiki_071018,65DdQqrq_BtbmFFhMTmyqF==,1199838155829=org.apache.hadoop.io.SequenceFile$Writer@66e9a2c4, enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985=org.apache.hadoop.io.SequenceFile$Writer@1c0fdfec, enwiki_071018,2ZRmAYSs97F__sLy5-ADMV==,1199837444576=org.apache.hadoop.io.SequenceFile$Writer@3456dafb, enwiki_080103,,1204865363666=org.apache.hadoop.io.SequenceFile$Writer@466668f9, enwiki_071018,AYtsfKtThdIJkVLUSKipA-==,1204860383810=org.apache.hadoop.io.SequenceFile$Writer@7bac9f86, enwiki_080103_meta,AyBTC9HXLLw5rxUy675O0-==,1204867122628=org.apache.hadoop.io.SequenceFile$Writer@5fb90875, enwiki_071018,CeAIzFFdqzhyiJQOseL_n-==,1204883192108=org.apache.hadoop.io.SequenceFile$Writer@3eb2492, enwiki_071018,avwxS5T7D4_OCPeI4F17Fk==,1199837870994=org.apache.hadoop.io.SequenceFile$Writer@381578fa, enwiki_080103_meta,4zByyv3_p2JHDADZdbXD4-==,1204867058338=org.apache.hadoop.io.SequenceFile$Writer@7780cea1, enwiki_071018,PperfeKM7-cS9psy-tzmSk==,1199837513465=org.apache.hadoop.io.SequenceFile$Writer@71fc1432, enwiki_071018,nBPrcMh5Sfi2H7KSrsSgkV==,1199838451040=org.apache.hadoop.io.SequenceFile$Writer@5c921914, enwiki_080103_meta,KyceV9ER2CAm3B-qYaoASF==,1204867238538=org.apache.hadoop.io.SequenceFile$Writer@6d75d78a, enwiki_080103,8-CxZA7pnVnBSrjlmICoq-==,1204863457723=org.apache.hadoop.io.SequenceFile$Writer@5399dd2a, enwiki_071018,y0WpQcE85bGuHBk5NbhDtV==,1197675580338=org.apache.hadoop.io.SequenceFile$Writer@48f093f8, enwiki_071018_meta,nxL_BrEZ6q2ooIo06-2g1F==,1199839770536=org.apache.hadoop.io.SequenceFile$Writer@1bd5211, enwiki_071018_meta,jx6p_Uek6ral-F0X3rZnoV==,1199839770535=org.apache.hadoop.io.SequenceFile$Writer@2e3414dc, enwiki_080103_meta,,1204867086244=org.apache.hadoop.io.SequenceFile$Writer@297de952, enwiki_071018,4b-F0-foVXo03XKFzZHeh-==,1204860659625=org.apache.hadoop.io.SequenceFile$Writer@3242af95, enwiki_080103,EWNE3bg-K_93e7xaUTGNmk==,1204863572529=org.apache.hadoop.io.SequenceFile$Writer@1a871b47, enwiki_071018,aR_SC5R5QuEDFSdmlRsk5V==,1199837870994=org.apache.hadoop.io.SequenceFile$Writer@74bd26a4, enwiki_071018,D4cfNPUvLY9KG8OEZOag0F==,1197675115854=org.apache.hadoop.io.SequenceFile$Writer@5d458f36, enwiki_080103_meta,Oz2-mF71uv4gsfgrX4-bZ-==,1204866969564=org.apache.hadoop.io.SequenceFile$Writer@9611bc6, enwiki_071018,6q_ORe3mPzBTOnenVGS6zk==,1204860472398=org.apache.hadoop.io.SequenceFile$Writer@26a3a6f4, enwiki_080103_meta,Ex3rZAu2sKFj2Bij8bVoZF==,1204867006209=org.apache.hadoop.io.SequenceFile$Writer@21208bc8, enwiki_071018_meta,Ey13Xkhj5QxDjHcAzaoEkk==,1197679241539=org.apache.hadoop.io.SequenceFile$Writer@4225f0fd}</comment>
                            <comment id="12576654" author="stack" created="Sat, 8 Mar 2008 23:28:13 +0000"  >&lt;p&gt;Ok.  Figured it out.  The exception on the regionserver side of the attached log that provokes the CLOSE is a HDFS error. Here it is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2008-03-08 00:37:28,096 DEBUG org.apache.hadoop.hbase.HStore: Applying edit &amp;lt;D496DdeK5YmdoXDJYKeCLF==/page:url/1204889856000=(page:url/1204889856000/http:&lt;span class=&quot;code-comment&quot;&gt;//en.wikipedia.org/wiki/Caesar_Takeshi)&amp;gt;
&lt;/span&gt;2008-03-08 00:37:28,096 DEBUG org.apache.hadoop.hbase.HStore: flushing reconstructionCache
2008-03-08 00:37:29,752 DEBUG org.apache.hadoop.hbase.HStore: moving 67943686/page/7182609840669926539 in hdfs:&lt;span class=&quot;code-comment&quot;&gt;//coral-dfs.cluster.powerset.com:10000/hbase/aa0-005-2.u.powerset.com/enwiki_071018/compaction.dir to 67943686/page/4327824140768830867 in hdfs://coral-dfs.cluster.powerset.com:10000/hbase/aa0-005-2.u.powerset.com/enwiki_071018 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 67943686/page
&lt;/span&gt;2008-03-08 00:37:29,827 INFO org.apache.hadoop.hbase.HRegion: compaction completed on region enwiki_071018,AYtsfKtThdIJkVLUSKipA-==,1204860383810. Took 5sec
2008-03-08 00:37:29,943 ERROR org.apache.hadoop.hbase.HRegionServer: error opening region enwiki_080103,CzQ7UPCw-AoIn2JzSEN_pV==,1204865434985
org.apache.hadoop.ipc.RemoteException: java.io.IOException: Could not complete write to file /hbase/aa0-005-2.u.powerset.com/enwiki_080103/1578810967/page/mapfiles/5679937491167886060/data by DFSClient_-540201177
        at org.apache.hadoop.dfs.NameNode.complete(NameNode.java:341)
        at sun.reflect.GeneratedMethodAccessor19.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
        at java.lang.reflect.Method.invoke(Unknown Source)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:409)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:910)

        at org.apache.hadoop.ipc.Client.call(Client.java:512)
        at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:198)
        at org.apache.hadoop.dfs.$Proxy1.complete(Unknown Source)
        at sun.reflect.GeneratedMethodAccessor9.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
        at java.lang.reflect.Method.invoke(Unknown Source)
        at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:82)
        at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:59)
        at org.apache.hadoop.dfs.$Proxy1.complete(Unknown Source)
        at org.apache.hadoop.dfs.DFSClient$DFSOutputStream.close(DFSClient.java:2292)
        at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:51)
        at org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:67)
        at org.apache.hadoop.io.SequenceFile$Writer.close(SequenceFile.java:932)
        at org.apache.hadoop.io.MapFile$Writer.close(MapFile.java:172)
        at org.apache.hadoop.hbase.HStore.internalFlushCache(HStore.java:1103)
        at org.apache.hadoop.hbase.HStore.doReconstructionLog(HStore.java:826)
        at org.apache.hadoop.hbase.HStore.&amp;lt;init&amp;gt;(HStore.java:720)
        at org.apache.hadoop.hbase.HRegion.&amp;lt;init&amp;gt;(HRegion.java:289)
        at org.apache.hadoop.hbase.HRegionServer.openRegion(HRegionServer.java:1154)
        at org.apache.hadoop.hbase.HRegionServer$Worker.run(HRegionServer.java:1100)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We&apos;re doing the reconstruction log replay.&lt;/p&gt;

&lt;p&gt;An exception in the HRegion constructor at this stage falls in here over on the HRS side:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: HRegionServer.java
===================================================================
--- HRegionServer.java  (revision 634789)
+++ HRegionServer.java  (working copy)
@@ -1168,12 +1168,9 @@
       } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
         LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;error opening region &quot;&lt;/span&gt; + regionInfo.getRegionName(), e);
         &lt;span class=&quot;code-comment&quot;&gt;// Mark the region offline.
&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// TODO: add an extra field in HRegionInfo to indicate that there is
&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// an error. We can&apos;t &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; that now because that would be an incompatible
&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// change that would require a migration        
&lt;/span&gt;         regionInfo.setOffline(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
         reportClose(regionInfo);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We&apos;re setting the HRegionInfo instance offline flag to true.  We send that over to the HMaster.   It, when processing the MSG_REPORT_CLOSE, if the passed HRegionInfo has an offline flag set, intentionally sets the do-not-reassign flag:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; reassignRegion = !region.isOffline();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, edits or compaction messes up on HRS side, it breaks our table.  Any ongoing uploads break to this region with ISEs.&lt;/p&gt;</comment>
                            <comment id="12576655" author="stack" created="Sat, 8 Mar 2008 23:31:06 +0000"  >&lt;p&gt;v3.  Removes marking region offline on HRS side if error opening region.  Means we&apos;ll attempt opening region on another server.  It&apos;ll probably fail for same reason.  So need to come up with something better.&lt;/p&gt;</comment>
                            <comment id="12576670" author="jimk" created="Sun, 9 Mar 2008 01:02:25 +0000"  >&lt;p&gt;The reason for offlining the region when the construction failed was that before, the master would keep trying to assign the region and it would fail again. The assumption is that the region is broken somehow. To do something more elegant would require HBase-fsck which I thought was targeted for 0.2 and not 0.1&lt;/p&gt;

&lt;p&gt;Yes it causes ISEs but without knowing more about the failure, it is hard to know where to look to fix the broken region.&lt;/p&gt;</comment>
                            <comment id="12576677" author="stack" created="Sun, 9 Mar 2008 02:28:33 +0000"  >&lt;p&gt;I&apos;m thinking that ruling that an IOE in HRegion init fatal may be an overreaction.  In this case at least, a manual onlining of the table brought this region back online  (so it must have deployed successfully elsewhere) and I was able to complete the full upload on restart.  Will look into it more.&lt;/p&gt;</comment>
                            <comment id="12577189" author="stack" created="Mon, 10 Mar 2008 21:07:51 +0000"  >&lt;p&gt;Chatting w/ Jim and looking more in logs, IOE in HRegion is probably an overreaction so should fix but the root cause would look to be two servers concurrently replaying edits and independently cleaning up edit files which makes one of the regionservers get an exception out of HDFS and fail its deploy.&lt;/p&gt;

&lt;p&gt;TODO: Confirm this is whats actually happening, then make it so just one regionserver replays edits at a time (Part of the problem is we were logging every edit so their replay were taking a long time).&lt;/p&gt;</comment>
                            <comment id="12577590" author="stack" created="Tue, 11 Mar 2008 20:28:34 +0000"  >&lt;p&gt;v4 was incomplete; region was being offlined on close regardless.  v5 adds one line fix (noticed by JimK).&lt;/p&gt;</comment>
                            <comment id="12578426" author="stack" created="Thu, 13 Mar 2008 18:06:21 +0000"  >&lt;p&gt;Here is v7.  Cleans up logs and stops our offlining of regions when an IOE on construction of HRegion.  Adds enhanced logging to help us figure some anomalies such as the &apos;hung regionserver&apos;.&lt;/p&gt;

&lt;p&gt;M  conf/hbase-default.xml&lt;br/&gt;
    Add hbase.hbasemaster.maxregionopen property.&lt;br/&gt;
M  src/java/org/apache/hadoop/hbase/HStore.java&lt;br/&gt;
    Change way we log.  Do way less.  Just emit sums of edits applied&lt;br/&gt;
    and skipped rather than individual edits.&lt;br/&gt;
M  src/java/org/apache/hadoop/hbase/HRegionServer.java&lt;br/&gt;
    Make sleeper instance a local rather than data member.&lt;br/&gt;
    (reportForDuty): Take a sleeper instance.&lt;br/&gt;
    (run): Removed redundant wrap of a &apos;for&apos; by a &apos;while&apos;.&lt;br/&gt;
    (constructor): If IOE, do not offline the region.  Seen to be&lt;br/&gt;
    an overreaction.&lt;br/&gt;
M  src/java/org/apache/hadoop/hbase/HLog.java&lt;br/&gt;
    Don&apos;t output map of all files being cleaned everytime a new&lt;br/&gt;
    entry is added; instead just log new entry.  Remove emission&lt;br/&gt;
    of every 10k edits.&lt;br/&gt;
M src/java/org/apache/hadoop/hbase/HMaster.java&lt;br/&gt;
    Up default for maxregionopen.  Was seeing that playing edits&lt;br/&gt;
    could take a long time (mostly because we used log every&lt;br/&gt;
    edit) but no harm in this being longer.  On REPORT_CLOSE,&lt;br/&gt;
    emit region info, not just region so can see the properties&lt;br/&gt;
    (W/o, made it hard to figure who was responsible for offlining).&lt;br/&gt;
    Add logging of attempt # in shutdown processing.&lt;br/&gt;
    Add logging of state flags passed to the close region.  Helps&lt;br/&gt;
    debugging.  Also in close offline ONLY if we are NOT reassigning&lt;br/&gt;
    the region (jimk find).&lt;br/&gt;
M  src/java/org/apache/hadoop/hbase/util/Sleeper.java&lt;br/&gt;
    Add logging of extraordinary sleeps or calculated periods &lt;br/&gt;
    (suspicion is that we&apos;re sleeping way longer on loaded machies&lt;br/&gt;
    and the regionserver appears hung).&lt;/p&gt;</comment>
                            <comment id="12578435" author="jimk" created="Thu, 13 Mar 2008 18:25:58 +0000"  >&lt;p&gt;Reviewed changes. +1&lt;/p&gt;</comment>
                            <comment id="12578462" author="stack" created="Thu, 13 Mar 2008 19:37:24 +0000"  >&lt;p&gt;Committed to TRUNK and BRANCH&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12377638" name="501-v5.patch" size="7681" author="stack" created="Tue, 11 Mar 2008 20:28:34 +0000"/>
                            <attachment id="12377816" name="501-v7.patch" size="23510" author="stack" created="Thu, 13 Mar 2008 18:06:20 +0000"/>
                            <attachment id="12377418" name="master.log" size="71548" author="stack" created="Sat, 8 Mar 2008 02:34:01 +0000"/>
                            <attachment id="12377459" name="noise-and-logging-0.1-v2.patch" size="3983" author="stack" created="Sat, 8 Mar 2008 22:28:57 +0000"/>
                            <attachment id="12377463" name="noise-and-logging-and-coarse-fix-0.1-v3.patch" size="5256" author="stack" created="Sat, 8 Mar 2008 23:31:06 +0000"/>
                            <attachment id="12377570" name="noise-and-logging-fix-0.1-v4.patch~" size="7832" author="stack" created="Tue, 11 Mar 2008 00:01:48 +0000"/>
                            <attachment id="12377424" name="noise.patch" size="1876" author="stack" created="Sat, 8 Mar 2008 07:09:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 8 Mar 2008 21:13:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25233</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h7on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98507</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>