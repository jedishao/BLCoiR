<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:11:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6695/HBASE-6695.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6695] [Replication] Data will lose if RegionServer down during transferqueue</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6695</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When we ware testing Replication failover feature we found if we kill a regionserver during it transferqueue ,we found only part of the hlog znode copy to the right path because failover process is interrupted. &lt;/p&gt;

&lt;p&gt;Log:&lt;/p&gt;

&lt;p&gt;2012-08-29 12:20:05,660 INFO org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceManager: Moving dw92.kgb.sqa.cm4,60020,1346210789716&apos;s hlogs to my queue&lt;/p&gt;

&lt;p&gt;2012-08-29 12:20:05,765 DEBUG org.apache.hadoop.hbase.replication.ReplicationZookeeper: Creating dw92.kgb.sqa.cm4%2C60020%2C13462107 89716.1346213720708 with data 210508162&lt;br/&gt;
2012-08-29 12:20:05,850 DEBUG org.apache.hadoop.hbase.replication.ReplicationZookeeper: Creating dw92.kgb.sqa.cm4%2C60020%2C13462107 89716.1346213886800 with data&lt;/p&gt;

&lt;p&gt;2012-08-29 12:20:05,938 DEBUG org.apache.hadoop.hbase.replication.ReplicationZookeeper: Creating dw92.kgb.sqa.cm4%2C60020%2C1346210789716.1346213830559 with data&lt;/p&gt;

&lt;p&gt;2012-08-29 12:20:06,055 DEBUG org.apache.hadoop.hbase.replication.ReplicationZookeeper: Creating dw92.kgb.sqa.cm4%2C60020%2C1346210789716.1346213775146 with data&lt;/p&gt;

&lt;p&gt;2012-08-29 12:20:06,277 WARN org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation: Failed all from region=.ME&lt;br/&gt;
TA.,,1.1028785192, hostname=dw93.kgb.sqa.cm4, port=60020&lt;br/&gt;
java.util.concurrent.ExecutionException: java.net.ConnectException: Connection refused&lt;br/&gt;
at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
at &lt;br/&gt;
......&lt;/p&gt;

&lt;p&gt;This server is down .....&lt;/p&gt;

&lt;p&gt;ZK node status:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;zk: 10.232.98.77:2181(CONNECTED) 6&amp;#93;&lt;/span&gt; ls /hbase-test3-repl/replication/rs/dw92.kgb.sqa.cm4,60020,1346210789716&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;lock, 1, 1-dw89.kgb.sqa.cm4,60020,1346202436268&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;dw92 is down , but Node dw92.kgb.sqa.cm4,60020,1346210789716 can&apos;t be deleted&lt;/p&gt;






</description>
                <environment></environment>
        <key id="12605474">HBASE-6695</key>
            <summary>[Replication] Data will lose if RegionServer down during transferqueue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="terry_zhang">terry zhang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Aug 2012 06:14:09 +0000</created>
                <updated>Wed, 19 Sep 2012 01:56:02 +0000</updated>
                            <resolved>Thu, 30 Aug 2012 23:05:55 +0000</resolved>
                                    <version>0.94.1</version>
                                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13444730" author="terry_zhang" created="Thu, 30 Aug 2012 06:21:14 +0000"  >&lt;p&gt;I think we can change lock node to Ephemeral Node. Other Rs will wait until the Rsznode is deleted. If lock node is expired one of the Rs will take over the transferqueue process and copy the rest of hlog znode.&lt;/p&gt;</comment>
                            <comment id="13444957" author="yuzhihong@gmail.com" created="Thu, 30 Aug 2012 13:48:44 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
+          LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed checking node:&quot;&lt;/span&gt;+rsZnode+&lt;span class=&quot;code-quote&quot;&gt;&quot; status.&quot;&lt;/span&gt;,e);
+          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Interrupt status should be restored.&lt;/p&gt;</comment>
                            <comment id="13445109" author="v.himanshu" created="Thu, 30 Aug 2012 17:12:13 +0000"  >&lt;p&gt;This is quite similar to HBase-2611? Ideally, moving of znodes should be done as an atomic process.&lt;/p&gt;</comment>
                            <comment id="13445133" author="lhofhansl" created="Thu, 30 Aug 2012 17:53:25 +0000"  >&lt;p&gt;@Himanshu: Yes, looks like the same issue.&lt;/p&gt;

&lt;p&gt;@Terry: I like the simplicity of this approach. Does it work in a real scenario?&lt;br/&gt;
Superficially it looks like it should work. In the worst case, we&apos;d copy the same the queue multiple times, but that is acceptable.&lt;/p&gt;

&lt;p&gt;Why this change?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
logQueue.add(hlog);
+ ZKUtil.deleteNodeRecursively(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zookeeper, z);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If this works - after all the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2611&quot; title=&quot;Handle RS that fails while processing the failure of another one&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2611&quot;&gt;&lt;del&gt;HBASE-2611&lt;/del&gt;&lt;/a&gt; - we&apos;ll be all looking like idiots &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  There must be a catch somewhere.&lt;/p&gt;</comment>
                            <comment id="13445135" author="lhofhansl" created="Thu, 30 Aug 2012 17:54:10 +0000"  >&lt;p&gt;Trying for the upcoming 0.94.2&lt;/p&gt;</comment>
                            <comment id="13445139" author="lhofhansl" created="Thu, 30 Aug 2012 17:55:48 +0000"  >&lt;p&gt;Terry, can you make a trunk patch?&lt;/p&gt;</comment>
                            <comment id="13445160" author="jdcryans" created="Thu, 30 Aug 2012 18:20:22 +0000"  >&lt;p&gt;Some comments on the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In the worst case (namenode died and whole cluster is restarted), each region server will have as many NodeFailoverWorker thread spinning as there are region servers while the queues are moved. The compounding effect doing all the writes and checks might be a lot.&lt;/li&gt;
	&lt;li&gt;Moving is still not atomic enough, you can still have 1 HLog replayed by 2 region servers and I&apos;m not sure what&apos;s going to happen there.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13445181" author="lhofhansl" created="Thu, 30 Aug 2012 18:40:37 +0000"  >&lt;p&gt;The first issue can addressed by increasing waittimes in the while loop (can do the same sleepWithRetries that we&apos;re doing in ReplicationSource, or maybe backoff a bit quicker). The number of thread by itself should not be a problem.&lt;/p&gt;

&lt;p&gt;Not sure about the 2nd issue.&lt;/p&gt;</comment>
                            <comment id="13445217" author="lhofhansl" created="Thu, 30 Aug 2012 19:24:42 +0000"  >&lt;p&gt;Was getting overly exited. 0.94.3 is more realistic.&lt;br/&gt;
Generally should we continue the discussion here or on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2611&quot; title=&quot;Handle RS that fails while processing the failure of another one&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2611&quot;&gt;&lt;del&gt;HBASE-2611&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13445239" author="ctrezzo" created="Thu, 30 Aug 2012 19:47:28 +0000"  >&lt;p&gt;Shouldn&apos;t the following line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ZKUtil.checkExists(zkHelper.getZookeeperWatcher(), rsZnode) != -1) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;be this instead:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ZKUtil.checkExists(zkHelper.getZookeeperWatcher(), rsZnode) == -1) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the node is gone, then we can stop trying to fail it over. If it still exists, we need to keep trying to fail it over.&lt;/p&gt;

&lt;p&gt;I say dup this and continue conversation in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2611&quot; title=&quot;Handle RS that fails while processing the failure of another one&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2611&quot;&gt;&lt;del&gt;HBASE-2611&lt;/del&gt;&lt;/a&gt; since they are addressing the exact same issue.&lt;/p&gt;</comment>
                            <comment id="13445398" author="stack" created="Thu, 30 Aug 2012 23:05:55 +0000"  >&lt;p&gt;Marking as duplicate of hbase-2611 as per Chris suggestion&lt;/p&gt;</comment>
                            <comment id="13445727" author="terry_zhang" created="Fri, 31 Aug 2012 06:45:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
logQueue.add(hlog);
+ ZKUtil.deleteNodeRecursively(this.zookeeper, z);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;If delete the hlog zk node after copy to new rs , Then 1 HLog won&apos;t be not replayed by 2 region server.&lt;/p&gt;</comment>
                            <comment id="13447096" author="terry_zhang" created="Mon, 3 Sep 2012 02:57:08 +0000"  >&lt;p&gt;add patch for trunk&lt;/p&gt;</comment>
                            <comment id="13447109" author="lhofhansl" created="Mon, 3 Sep 2012 04:13:26 +0000"  >&lt;p&gt;Thanks Terry. Let&apos;s continue on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2611&quot; title=&quot;Handle RS that fails while processing the failure of another one&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2611&quot;&gt;&lt;del&gt;HBASE-2611&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
@Chris: I think you&apos;re right. I had a assumed it&apos;d work this way, but didn&apos;t notice it is actually doing the opposite.&lt;/p&gt;</comment>
                            <comment id="13447174" author="terry_zhang" created="Mon, 3 Sep 2012 09:18:46 +0000"  >&lt;p&gt;Check regionserver stopper during loop&lt;/p&gt;</comment>
                            <comment id="13453754" author="terry_zhang" created="Wed, 12 Sep 2012 06:05:54 +0000"  >&lt;p&gt;trunk version createEphemeralNodeAndWatch didn&apos;t throw NodeExistsException when node exist. Add a new function createNoneExistEphemeralNodeAndWatch to throw NodeExistsException when create an existed node .&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12465318">HBASE-2611</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12543508" name="HBASE-6695-4trunk.patch" size="2870" author="terry_zhang" created="Mon, 3 Sep 2012 02:57:08 +0000"/>
                            <attachment id="12543523" name="HBASE-6695-4trunk_v2.patch" size="2938" author="terry_zhang" created="Mon, 3 Sep 2012 09:18:46 +0000"/>
                            <attachment id="12544777" name="HBASE-6695-4trunk_v3.patch" size="3901" author="terry_zhang" created="Wed, 12 Sep 2012 06:05:54 +0000"/>
                            <attachment id="12543043" name="HBASE-6695.patch" size="2648" author="terry_zhang" created="Thu, 30 Aug 2012 06:19:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 30 Aug 2012 13:48:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242419</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 12 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02ut3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14592</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>