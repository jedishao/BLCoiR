<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 19:00:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1815/HBASE-1815.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1815] HBaseClient can get stuck in an infinite loop while attempting to contact a failed regionserver</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1815</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;While using HBase Thrift server, if a regionserver goes down due to shutdown or failure clients will timeout because the thrift server cannot contact the dead regionserver.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu Linux (Linux &amp;lt;elided&amp;gt; 2.6.24-23-generic #1 SMP Wed Apr 1 21:43:24 UTC 2009 x86_64 GNU/Linux), java version &quot;1.6.0_06&quot;, Java(TM) SE Runtime Environment (build 1.6.0_06-b02), Java HotSpot(TM) 64-Bit Server VM (build 10.0-b22, mixed mode)&lt;/p&gt;</environment>
        <key id="12434787">HBASE-1815</key>
            <summary>HBaseClient can get stuck in an infinite loop while attempting to contact a failed regionserver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="justinlynn">Justin Lynn</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Sep 2009 22:25:49 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:49 +0000</updated>
                            <resolved>Tue, 22 Sep 2009 16:34:45 +0000</resolved>
                                    <version>0.20.0</version>
                                    <fixVersion>0.20.1</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12751198" author="justinlynn" created="Thu, 3 Sep 2009 22:30:13 +0000"  >&lt;p&gt;These are the thrift server threaddumps and log files from the time when the failure was noticed.&lt;/p&gt;</comment>
                            <comment id="12751203" author="justinlynn" created="Thu, 3 Sep 2009 22:39:30 +0000"  >&lt;p&gt;Another thread dump.&lt;/p&gt;</comment>
                            <comment id="12751208" author="stack" created="Thu, 3 Sep 2009 22:57:07 +0000"  >&lt;p&gt;Working w/ JSharp, looking in the thread dumps, it looks like each thread has to do ten retries sleeping a second between each retry.  When many threads, we get a lot of messages in the log about the failure to connect.  Need to recognize dead-remote-side and handle it promptly.&lt;/p&gt;</comment>
                            <comment id="12751212" author="apurtell" created="Thu, 3 Sep 2009 23:05:17 +0000"  >&lt;p&gt;Clients can monitor RS liveness via ZK and respond quickly via watches? &lt;/p&gt;</comment>
                            <comment id="12755760" author="stack" created="Tue, 15 Sep 2009 22:42:26 +0000"  >&lt;p&gt;HBaseClient also has this issue from list:&lt;/p&gt;

&lt;p&gt;Yeah, this is down in guts of the hadoop rpc we use.  Around connection setup it has its own config. that is not well aligned with ours (ours being the retries and pause settings)&lt;/p&gt;

&lt;p&gt;The maxretriies down in ipc is&lt;/p&gt;

&lt;p&gt;this.maxRetries = conf.getInt(&quot;ipc.client.connect.max.retries&quot;, 10);&lt;/p&gt;

&lt;p&gt;Thats for an IOE other than timeout.  For timeout, it does this:&lt;/p&gt;

&lt;p&gt;          } catch (SocketTimeoutException toe) {&lt;br/&gt;
            /* The max number of retries is 45,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;which amounts to 20s*45 = 15 minutes retries.&lt;br/&gt;
             */&lt;br/&gt;
            handleConnectionFailure(timeoutFailures++, 45, toe);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Let me file an issue to address the above.  The retries should be our retries... and in here it has a hardcoded 1000ms that instead should be our pause.... Not hard to fix.&lt;/p&gt;</comment>
                            <comment id="12756877" author="stack" created="Fri, 18 Sep 2009 00:13:47 +0000"  >&lt;p&gt;This patch might be a bit radical, but here it goes.&lt;/p&gt;

&lt;p&gt;High-level motivation is undo retrying and sleeps down in ipc; let retrying be done at a higher level up in the hbase client.&lt;/p&gt;

&lt;p&gt;In ipc, socket setup had a timeout of 20 seconds.  Ipc then retries the socket setup ten times with a 1 second sleep in between.  Thats 210seconds  or so before we timeout down in the guts of RPC.  We then go up to the retry logic in hbase (usually, not always), and then do ten retries with a 2 second retry in between (If a SocketTimeoutException exception setting up the connection, we&apos;d retry a hard-coded 45 times; i.e. 15 minutes).&lt;/p&gt;

&lt;p&gt;In Justin&apos;s case, I don&apos;t think we were doing SocketTimeoutException going by the stack trace.  It was more the 210 seconds per thread but my guess is  that his thrift client had probably timed out already.&lt;/p&gt;

&lt;p&gt;This patch turns off retry down in the ipc client (let the upper-layers do retry), changes hard-coded sleep times to be hbase.client.pause time (2 seconds), and removes the 45 hard-coding,   It also adds an hbase prefix to the ipc configuration parameters in case we want different values from hadoop.&lt;/p&gt;

&lt;p&gt;Let me try out this patch.  My guess is that there are places in hbase where we don&apos;t retry because we were dependent on ipc doing retry for us.  Let me find those.&lt;/p&gt;</comment>
                            <comment id="12757477" author="stack" created="Fri, 18 Sep 2009 22:04:54 +0000"  >&lt;p&gt;This version adds cleanup.&lt;/p&gt;

&lt;p&gt;In HRegionServer main run loop, wait before retrying rather than just run all retries without pause.&lt;/p&gt;

&lt;p&gt;Changed the HBaseRPC RetriesExhaustedException so its about failure to get proxy instead of a wonky message about unknown row.&lt;/p&gt;

&lt;p&gt;Move the get of a regionserver connection into the try/catch so if fails, its retried.&lt;/p&gt;

&lt;p&gt;This patch changes how our retrying from client and from servers works.  I tested up on a cluster and it seems more regular and &apos;live&apos; now than previous but I may have missed cases where we used to rely on the rpc retry.  I&apos;m not sure how to find those other than to commit and wait till someone complains.&lt;/p&gt;

&lt;p&gt;Review appreciated.&lt;/p&gt;</comment>
                            <comment id="12757671" author="stack" created="Sat, 19 Sep 2009 16:05:07 +0000"  >&lt;p&gt;I had this patch installed in my overnight loading.  The upload worked about same as usual so this patch doesn&apos;t seem to change basic workings.&lt;/p&gt;</comment>
                            <comment id="12757673" author="stack" created="Sat, 19 Sep 2009 16:15:54 +0000"  >&lt;p&gt;All unit tests pass.&lt;/p&gt;</comment>
                            <comment id="12758264" author="jdcryans" created="Tue, 22 Sep 2009 15:04:08 +0000"  >&lt;p&gt;+1 patch seems good. Apart from unit tests and loading, did you try killing some region servers?&lt;/p&gt;</comment>
                            <comment id="12758280" author="stack" created="Tue, 22 Sep 2009 15:53:20 +0000"  >&lt;p&gt;Yes.  I should have so.  I killed master and watched what regionservers did.  I also killed the cluster and watched client.   It all seems to run more regularly.    Less weird retrying.   &lt;/p&gt;


&lt;p&gt;Thanks for review. &lt;/p&gt;</comment>
                            <comment id="12758290" author="stack" created="Tue, 22 Sep 2009 16:34:45 +0000"  >&lt;p&gt;Committed branch and trunk.&lt;/p&gt;</comment>
                            <comment id="15017904" author="lars_francke" created="Fri, 20 Nov 2015 13:01:49 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12420087" name="hbaseclient-v3.patch" size="9205" author="stack" created="Fri, 18 Sep 2009 22:04:54 +0000"/>
                            <attachment id="12419948" name="ipctimeout.patch" size="3175" author="stack" created="Fri, 18 Sep 2009 00:13:47 +0000"/>
                            <attachment id="12418552" name="thrift_server_log_excerpt" size="187905" author="justinlynn" created="Thu, 3 Sep 2009 22:30:13 +0000"/>
                            <attachment id="12418551" name="thrift_server_threaddump" size="459730" author="justinlynn" created="Thu, 3 Sep 2009 22:30:13 +0000"/>
                            <attachment id="12418554" name="thrift_server_threaddump_1" size="688284" author="justinlynn" created="Thu, 3 Sep 2009 22:39:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 Sep 2009 22:57:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25999</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hfev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99759</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>