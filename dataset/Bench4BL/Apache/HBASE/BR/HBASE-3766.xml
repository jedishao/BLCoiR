<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sat Dec 03 16:53:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3766/HBASE-3766.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3766] Manage Connections Through Reference Counts</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3766</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;As of now, the onus is on the developer to explicitly close connections once they&apos;re done using them. Furthermore, since connections are managed based on the identity of the &lt;tt&gt;Configuration&lt;/tt&gt; object, one is forced to clone the configuration object in order to be able to clean it up safely (for a case in point, see &lt;tt&gt;HTablePool&apos;s&lt;/tt&gt; constructor). As a matter of fact, this issue has been well-documented in the HConnectionManager class:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;But sharing connections makes clean up of &lt;tt&gt;HConnection&lt;/tt&gt; instances a little awkward.  Currently, clients cleanup by calling &lt;tt&gt;#deleteConnection(Configuration, boolean)&lt;/tt&gt;.  This will shutdown the zookeeper connection the &lt;tt&gt;HConnection&lt;/tt&gt; was using and clean up all &lt;tt&gt;HConnection&lt;/tt&gt; resources as well as stopping proxies to servers out on the cluster. Not running the cleanup will not end the world; it&apos;ll just stall the closeup some and spew some zookeeper connection failed messages into the log.  Running the cleanup on a &lt;tt&gt;HConnection&lt;/tt&gt; that is subsequently used by another will cause breakage so be careful running cleanup. To create a &lt;tt&gt;HConnection&lt;/tt&gt; that is not shared by others, you can create a new &lt;tt&gt;Configuration&lt;/tt&gt; instance, pass this new instance to &lt;tt&gt;#getConnection(Configuration)&lt;/tt&gt;, and then when done, close it up by doing something like the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 Configuration newConfig = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration(originalConf);
 HConnection connection = HConnectionManager.getConnection(newConfig);
 &lt;span class=&quot;code-comment&quot;&gt;// Use the connection to your hearts&apos; delight and then when done...
&lt;/span&gt; HConnectionManager.deleteConnection(newConfig, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;

&lt;p&gt;Here, we propose a reference-count based mechanism for managing connections that will allow &lt;tt&gt;HTables&lt;/tt&gt; to clean up after themselves. In particular, we extend the &lt;tt&gt;HConnectionInterface&lt;/tt&gt; interface so as to facilitate reference counting, where, typically, a reference indicates that it is being used by a &lt;tt&gt;HTable&lt;/tt&gt;, although there could be other sources. &lt;/p&gt;

&lt;p&gt;To elaborate, when a HTable is constructed, it increments the reference count on the connection given to it. Similarly, when it is closed, that reference count is decremented. In the event there are no more references to that connection, &lt;tt&gt;HTable#close&lt;/tt&gt; takes it upon itself to delete the connection, thereby sparing the developer from doing so.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12503975">HBASE-3766</key>
            <summary>Manage Connections Through Reference Counts</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="karthick">Karthick Sankarachary</assignee>
                                    <reporter username="karthick">Karthick Sankarachary</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Apr 2011 20:04:46 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:14 +0000</updated>
                            <resolved>Mon, 25 Apr 2011 20:18:42 +0000</resolved>
                                    <version>0.90.2</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13018572" author="jdcryans" created="Mon, 11 Apr 2011 21:07:47 +0000"  >&lt;p&gt;First, thanks for starting this discussion.&lt;/p&gt;

&lt;p&gt;About the patch, I see you increment in HTable&apos;s constructor, but if the user is reusing a conf object then the counter becomes wrong right?&lt;/p&gt;

&lt;p&gt;Also the counter itself isn&apos;t accessed in a synchronize way (as multiple threads using different HTables would need) so this could pose a problem.&lt;/p&gt;</comment>
                            <comment id="13018582" author="karthick" created="Mon, 11 Apr 2011 21:34:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;About the patch, I see you increment in HTable&apos;s constructor, but if the user is reusing a conf object then the counter becomes wrong right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s say that a certain conf object is used to create 2 HTable instances. As a result, the reference count on the underlying connection object will be incremented twice, which is the desired behavior. Then, when you close one of the HTables, it will decrement the reference count on the connection, but not close it, since it is still in-use. Later, when you close the other HTable, the reference count will drop to zero, at which point, the underlying connection gets deleted. On the other hand, if you use different conf objects to create the HTables, they will end up having separate reference counts. Please correct me if I&apos;m misunderstood the question.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also the counter itself isn&apos;t accessed in a synchronize way (as multiple threads using different HTables would need) so this could pose a problem.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch. I revised the patch such that the reference count is accessed atomically.&lt;/p&gt;</comment>
                            <comment id="13018591" author="jdcryans" created="Mon, 11 Apr 2011 22:01:33 +0000"  >&lt;p&gt;Ah I see, sorry I thought you were adding the reference counting in HCM, but I see it&apos;s in HCI (which does make a lot more sense). That works yeah.&lt;/p&gt;

&lt;p&gt;So two other things:&lt;/p&gt;

&lt;p&gt;This is dangerous because you are closing the connections to all the regions servers and the master, you want to pass false:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;+        HConnectionManager.deleteConnection(this.configuration, true);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then I&apos;d like to see some unit testing.&lt;/p&gt;

&lt;p&gt;Also I&apos;m not sure we want this in 0.90.3, targeting 0.92 would be better.&lt;/p&gt;</comment>
                            <comment id="13018663" author="karthick" created="Tue, 12 Apr 2011 01:23:09 +0000"  >&lt;blockquote&gt;
&lt;p&gt; This is dangerous because you are closing the connections to all the regions servers and the master, you want to pass false:&lt;/p&gt;

&lt;p&gt;    + HConnectionManager.deleteConnection(this.configuration, true);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fair enough.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Then I&apos;d like to see some unit testing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added a test case in &lt;tt&gt;TestFromClientSide&lt;/tt&gt; called &lt;tt&gt;testConnectionReferenceCount&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Note that, I had to make an exception in the case of the meta table (viz., &lt;tt&gt;HConstants#META_TABLE_NAME&lt;/tt&gt;). Specifically, I do not increment the reference count in that case, because apparently the client (see &lt;tt&gt;MetaScanner&lt;/tt&gt;) doesn&apos;t bother closing that table. Furthermore, in order to keep tables already closed from decrementing the reference count, I had to make the &lt;tt&gt;HTable#close&lt;/tt&gt; method idempotent .&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Also I&apos;m not sure we want this in 0.90.3, targeting 0.92 would be better.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done.&lt;/p&gt;</comment>
                            <comment id="13024941" author="stack" created="Mon, 25 Apr 2011 20:16:09 +0000"  >&lt;p&gt;Is this issue still relevant after the addition of ref counting over in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13024945" author="karthick" created="Mon, 25 Apr 2011 20:23:15 +0000"  >&lt;p&gt;No, it&apos;s not relevant anymore, given that we ended up doing it as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt;. For the sake of completeness, I&apos;ll add a comment here later on how reference counting ended up being implemented.&lt;/p&gt;</comment>
                            <comment id="15017196" author="lars_francke" created="Fri, 20 Nov 2015 12:42:14 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12504210">HBASE-3777</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12476073" name="HBASE-3766.patch" size="7433" author="karthick" created="Tue, 12 Apr 2011 01:06:33 +0000"/>
                            <attachment id="12476060" name="HBASE-3766.patch" size="3965" author="karthick" created="Mon, 11 Apr 2011 21:35:03 +0000"/>
                            <attachment id="12476047" name="HBASE-3766.patch" size="3975" author="karthick" created="Mon, 11 Apr 2011 20:06:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 11 Apr 2011 21:07:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33194</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hnsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101116</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>