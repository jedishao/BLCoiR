<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Thu Dec 01 21:26:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13895/HBASE-13895.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13895] DATALOSS: Region assigned before WAL replay when abort</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13895</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Opening a place holder till finish analysis.&lt;/p&gt;

&lt;p&gt;I have dataloss running ITBLL at 3B (testing &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt;). Most obvious culprit is the double-assignment that I can see.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12837518">HBASE-13895</key>
            <summary>DATALOSS: Region assigned before WAL replay when abort</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jun 2015 21:37:57 +0000</created>
                <updated>Fri, 18 Mar 2016 22:30:23 +0000</updated>
                            <resolved>Thu, 2 Jul 2015 01:12:07 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                                    <component>Recovery</component>
                    <component>Region Assignment</component>
                    <component>wal</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                                                            <comments>
                            <comment id="14584954" author="enis" created="Sun, 14 Jun 2015 06:41:40 +0000"  >&lt;p&gt;The saga continues. &lt;/p&gt;

&lt;p&gt;We have &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; patch v1 running on our test gig which surfaces another problem with the assignment, and causes data loss. We are moving a region (unassign and assign) from one of the region servers who is aborting. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; Maybe this is the root cause of your ITBLL failure as well. It is not due to double assignment, but assignment happening before SSH finishes.  &lt;/p&gt;

&lt;p&gt;While the RS is aborting, master is trying to close the region. The region unassign incorrectly assumes that WAL replay is not needed, and thus leaves data behind. The region is opened before WAL split is finished.&lt;br/&gt;
I think this is an existing bug, not related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13605&quot; title=&quot;RegionStates should not keep its list of dead servers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13605&quot;&gt;HBASE-13605&lt;/a&gt; patches, but with the v1 patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; it surfaces in CM runs since, we started aborting the region server if a snapshot request aborts (note that v4 patch also handles the snapshot interruption as well as flush table interruption thus it does not surface this problem since RSs do not abort). CM never aborts a region server, so this existing condition was not tested much. It is not easy to trigger with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; v1 patch as well, since it needs a region move while the RS is aborting. &lt;/p&gt;

&lt;p&gt;Here are the logs: &lt;br/&gt;
The region server reports aborting because of DroppedSnapshotException coming from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; v1 (which does not fix snapshot flushes unlike v4) and thus causes RS abort correctly: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-13 03:43:41,706 ERROR [PriorityRpcServer.handler=15,queue=1,port=16000] master.MasterRpcServices: Region server ip-172-31-45-46.ec2.internal,16020,1434166589660 reported a fatal error:
ABORTING region server ip-172-31-45-46.ec2.internal,16020,1434166589660: Replay of WAL required. Forcing server shutdown
Cause:
org.apache.hadoop.hbase.DroppedSnapshotException: region: IntegrationTestLoadAndVerify,\xCA\x1A\xF2\x86\xBC\xA1\xAF\x0C,1434165321232.8667147ea6a13b3410715dbc90393642.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While the abort is going on, CM decides to move the region: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-13 03:43:44,186 INFO  [B.defaultRpcServer.handler=18,queue=0,port=16000] master.RegionStates: Transition {fca3c6621486f4de764601ecdcfec665 state=OPEN, ts=1434166908561, server=ip-172-31-45-46.ec2.internal,16020,1434166589660} to {fca3c6621486f4de764601ecdcfec665 state=PENDING_CLOSE, ts=1434167024186, server=ip-172-31-45-46.ec2.internal,16020,1434166589660}
2015-06-13 03:43:44,200 INFO  [B.defaultRpcServer.handler=18,queue=0,port=16000] master.RegionStates: Transition {fca3c6621486f4de764601ecdcfec665 state=PENDING_CLOSE, ts=1434167024186, server=ip-172-31-45-46.ec2.internal,16020,1434166589660} to {fca3c6621486f4de764601ecdcfec665 state=OFFLINE, ts=1434167024200, server=ip-172-31-45-46.ec2.internal,16020,1434166589660}
2015-06-13 03:43:44,208 INFO  [B.defaultRpcServer.handler=18,queue=0,port=16000] master.AssignmentManager: Assigning IntegrationTestLoadAndVerify,\x945\xE5\x0DyC^&amp;lt;,1434165321232.fca3c6621486f4de764601ecdcfec665. to ip-172-31-45-43.ec2.internal,16020,1434166192348
2015-06-13 03:43:44,778 INFO  [AM.ZK.Worker-pool2-t114] master.RegionStates: Transition {fca3c6621486f4de764601ecdcfec665 state=OPENING, ts=1434167024312, server=ip-172-31-45-43.ec2.internal,16020,1434166192348} to {fca3c6621486f4de764601ecdcfec665 state=OPEN, ts=1434167024778, server=ip-172-31-45-43.ec2.internal,16020,1434166192348}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see, the region went from OPEN -&amp;gt; PENDING_CLOSE -&amp;gt; OFFLINE -&amp;gt; PENDING_OPEN -&amp;gt; OPEN, but the region did not do a proper close and flush in the previous RS, since the RS was aborting (due to DSE from other region). &lt;/p&gt;

&lt;p&gt;The RS opened the region with a smaller seqId (21818), although previous RS has written up to 22334&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-13 03:43:44,310 INFO  [RS_OPEN_REGION-ip-172-31-45-43:16020-0] regionserver.HRegion: Onlined fca3c6621486f4de764601ecdcfec665; next sequenceid=21848
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The RS only got expired after the region have already opened elsewhere (notice it is 1 second later):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-13 03:43:45,704 INFO  [main-EventThread] zookeeper.RegionServerTracker: RegionServer ephemeral node deleted, processing expiration [ip-172-31-45-46.ec2.internal,16020,1434166589660]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We still do WAL splitting, but these are effectively lost because region is now open elsewhere with a smaller seqId: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-13 03:44:03,742 INFO  [MASTER_SERVER_OPERATIONS-ip-172-31-45-40:16000-4] master.SplitLogManager: finished splitting (more than or equal to) 429923436 bytes in 4 log files in [hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-172-31-45-41.ec2.internal:8020/apps/hbase/data/WALs/ip-172-31-45-46.ec2.internal,16020,1434166589660-splitting] in 17967ms
&lt;/span&gt;2015-06-13 03:44:12,826 INFO  [MASTER_SERVER_OPERATIONS-ip-172-31-45-40:16000-4] handler.ServerShutdownHandler: Finished processing of shutdown of ip-172-31-45-46.ec2.internal,16020,1434166589660

..
2015-06-13 03:43:50,006 INFO  [split-log-closeStream-3] wal.WALSplitter: Rename hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-172-31-45-41.ec2.internal:8020/apps/hbase/data/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestLoadAndVerify/fca3c6621486f4de764601ecdcfec665/recovered.edits/0000000000000022138.temp to hdfs://ip-172-31-45-41.ec2.internal:8020/apps/hbase/data/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestLoadAndVerify/fca3c6621486f4de764601ecdcfec665/recovered.edits/0000000000000022334
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</comment>
                            <comment id="14584956" author="enis" created="Sun, 14 Jun 2015 06:49:12 +0000"  >&lt;p&gt;Here is an attempt for a patch. &lt;/p&gt;

&lt;p&gt;We throw RegionServerAbortedException if RS is aborting, and handle this in AM differently in unasign() versus RegionServerStoppedException. &lt;/p&gt;

&lt;p&gt;It is not easy to reproduce the failure, but I&apos;ll run ITLAV with this patch overnight (BTW, we discovered this in ITLAV and ITIngest, but ITBLL should be similarly susceptible). &lt;/p&gt;</comment>
                            <comment id="14584999" author="hadoopqa" created="Sun, 14 Jun 2015 09:11:48 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12739473/hbase-13895_v1-branch-1.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12739473/hbase-13895_v1-branch-1.1.patch&lt;/a&gt;&lt;br/&gt;
  against branch-1.1 branch at commit 682b8ab8a542a903e5807053282693e3a96bad2d.&lt;br/&gt;
  ATTACHMENT ID: 12739473&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.1 2.5.2 2.6.0)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestAssignmentManagerOnCluster&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestZKLessAMOnCluster&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14402//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14588444" author="ndimiduk" created="Tue, 16 Jun 2015 17:44:51 +0000"  >&lt;p&gt;Adding a fixFor 1.1.1 so we can discuss the patch for this release as well.&lt;/p&gt;</comment>
                            <comment id="14589083" author="stack" created="Wed, 17 Jun 2015 00:27:59 +0000"  >&lt;p&gt;Pardon me &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; I missed this. Indeed I had v1 of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13877&quot; title=&quot;Interrupt to flush from TableFlushProcedure causes dataloss in ITBLL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13877&quot;&gt;&lt;del&gt;HBASE-13877&lt;/del&gt;&lt;/a&gt; in place.&lt;/p&gt;

&lt;p&gt;I look to have something else though. Master crashes and the new, active master assigns a region already happy out on the cluster. Feel free to take this issue Enis since you dumped in your sequel already. I&apos;ll go write my novel in a new JIRA.&lt;/p&gt;

&lt;p&gt;Here is the trailer:&lt;/p&gt;

&lt;p&gt;Region 6fbe22ff15c2e5f2b207f79eaf8f382a was successfully opened on c2025.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-09 20:05:37,661 DEBUG [AM.ZK.Worker-pool2-t27] master.RegionStates: Onlined 6fbe22ff15c2e5f2b207f79eaf8f382a on c2025.halxg.cloudera.com,16020,1433892619022
...
2015-06-09 20:05:37,962 DEBUG [c2020.halxg.cloudera.com,16000,1433905379975-GeneralBulkAssigner-2] master.AssignmentManager: Bulk assigning done &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; c2025.halxg.cloudera.com,16020,1433892619022
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Master crashes and is restarted a few seconds later... in comes c2025 and registers&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-06-09 20:06:01,864 INFO  [main] util.VersionInfo: HBase 1.2.0-SNAPSHOT
....
2015-06-09 20:06:16,677 INFO  [PriorityRpcServer.handler=10,queue=0,port=16000] master.ServerManager: Registering server=c2025.halxg.cloudera.com,16020,1433892619022
...
2015-06-09 20:06:20,026 INFO  [c2020:16000.activeMasterManager] master.MasterFileSystem: Log folder hdfs:&lt;span class=&quot;code-comment&quot;&gt;//c2020.halxg.cloudera.com:8020/hbase/WALs/c2025.halxg.cloudera.com,16020,1433892619022 belongs to an existing region server
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think it has something to do w/ the fact that c2025 is carrying meta.... still digging.&lt;/p&gt;


</comment>
                            <comment id="14589087" author="stack" created="Wed, 17 Jun 2015 00:31:14 +0000"  >&lt;p&gt;Patch looks reasonable. +1 (We need the new instance of Search or is it doing something different ?)&lt;/p&gt;</comment>
                            <comment id="14589124" author="enis" created="Wed, 17 Jun 2015 01:08:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Feel free to take this issue Enis since you dumped in your sequel already. I&apos;ll go write my novel in a new JIRA.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok. Sorry for the hijack. Thought that you may be seeing the same issue. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think it has something to do w/ the fact that c2025 is carrying meta.... still digging.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good luck!&lt;/p&gt;

&lt;p&gt;For the patch, I realized that we should also handle RegionServerStoppedException as well since while the region server is stopping, there is no guarantee that the region close have happened. So, if a region move comes in, there is still a window that the region may be opened on the other host before the region close is finished. &lt;/p&gt;

&lt;p&gt;I&apos;ll update the patch for handling the stopping case as well. I could not reproduce the UT failures, but they seem related. Let me spend some more time. &lt;/p&gt;</comment>
                            <comment id="14590361" author="enis" created="Wed, 17 Jun 2015 19:09:10 +0000"  >&lt;p&gt;Offline chat with Nick. Moving out of 1.1.1 for now until we get the UT issues fixed and get better testing with this patch. &lt;/p&gt;</comment>
                            <comment id="14590363" author="ndimiduk" created="Wed, 17 Jun 2015 19:09:37 +0000"  >&lt;p&gt;Dropping from 1.1.1 as this hasn&apos;t been vetted thoroughly enough yet. Hopefully 1.1.2.&lt;/p&gt;</comment>
                            <comment id="14610494" author="busbey" created="Wed, 1 Jul 2015 15:44:02 +0000"  >&lt;p&gt;bumping out of 1.2.0&lt;/p&gt;</comment>
                            <comment id="14610647" author="stack" created="Wed, 1 Jul 2015 17:06:03 +0000"  >&lt;p&gt;What you thinking on this one &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;? Thanks.&lt;/p&gt;</comment>
                            <comment id="14611157" author="enis" created="Wed, 1 Jul 2015 23:15:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;What you thinking on this one Enis Soztutar? Thanks.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Let&apos;s get this in. Let me update the patch because even in regular RS shutdown, it can happen that the master tries to close the region, does an RPC, and the RPC throws RegionServerStoppedException. AM continues to assign the region although there is no guarantee that the RS has actually closed the region (thus everything is flushed). We start throwing RSSE while region server is closing. There is no ordering guarantee for the regions to be actually closed. &lt;/p&gt;</comment>
                            <comment id="14611234" author="stack" created="Thu, 2 Jul 2015 00:23:52 +0000"  >&lt;p&gt;I looked at the patch again. +1. It is going to help.  Let me apply to 1.2. If you want it out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=busbey&quot; class=&quot;user-hover&quot; rel=&quot;busbey&quot;&gt;Sean Busbey&lt;/a&gt;, just say and I&apos;ll revert.&lt;/p&gt;</comment>
                            <comment id="14611283" author="stack" created="Thu, 2 Jul 2015 01:10:06 +0000"  >&lt;p&gt;What I applied to master. Does not have the TestAssignmentManager test additions (there is no TAM in master) and it also adds constructor that takes a Configuration to WALPlayer (needed by Search).&lt;/p&gt;

&lt;p&gt;Pushed because I want to start up some tests.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt; Added to branch-1.1 FYI.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=busbey&quot; class=&quot;user-hover&quot; rel=&quot;busbey&quot;&gt;Sean Busbey&lt;/a&gt; Applied to branch-1.2.&lt;/p&gt;</comment>
                            <comment id="14611284" author="hudson" created="Thu, 2 Jul 2015 01:11:42 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.3-IT #17 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3-IT/17/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3-IT/17/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) (stack: rev 0f17b76796523e24c353992d1d2fc7b4e306135f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611285" author="stack" created="Thu, 2 Jul 2015 01:12:07 +0000"  >&lt;p&gt;Pushed to master, branch-1, branch-1.1 and branch-1.2.&lt;/p&gt;</comment>
                            <comment id="14611305" author="hudson" created="Thu, 2 Jul 2015 01:28:18 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.2 #46 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2/46/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2/46/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) (stack: rev 7448fb3e1f64ad94079ca42bd85d200d687fbb18)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611319" author="hudson" created="Thu, 2 Jul 2015 01:52:16 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.1 #570 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.1/570/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.1/570/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) (stack: rev 4a15c2f0a810fa1776c766f71cdcc1f0abf4506e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611333" author="enis" created="Thu, 2 Jul 2015 02:09:55 +0000"  >&lt;p&gt;We may have broken compilation because of missing java class. &lt;/p&gt;

&lt;p&gt;How about this attached addendum. It handles RegionServerStopped and RegionServerNotYetRunning similarly and fixes the failing UT. &lt;/p&gt;</comment>
                            <comment id="14611349" author="enis" created="Thu, 2 Jul 2015 02:28:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;What I applied to master. Does not have the TestAssignmentManager test additions (there is no TAM in master) and it also adds constructor that takes a Configuration to WALPlayer (needed by Search).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;master patch also does not contain the actual fix? There are no changes in AM. Also did you push the changes? &lt;/p&gt;</comment>
                            <comment id="14611356" author="enis" created="Thu, 2 Jul 2015 02:38:16 +0000"  >&lt;p&gt;Here is an addendum for master on top of v1 master patch. &lt;/p&gt;</comment>
                            <comment id="14611366" author="hudson" created="Thu, 2 Jul 2015 02:44:45 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.3 #32 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3/32/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3/32/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) (stack: rev 0f17b76796523e24c353992d1d2fc7b4e306135f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611397" author="stack" created="Thu, 2 Jul 2015 03:21:03 +0000"  >&lt;p&gt;Sorry about that (was at dinner). Reverted. Let me start over.&lt;/p&gt;</comment>
                            <comment id="14611455" author="hudson" created="Thu, 2 Jul 2015 04:30:59 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.2-IT #34 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2-IT/34/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2-IT/34/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) (stack: rev 7448fb3e1f64ad94079ca42bd85d200d687fbb18)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611483" author="hudson" created="Thu, 2 Jul 2015 05:06:52 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.2 #47 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2/47/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2/47/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 895f5346831edb6165979ccd76a69e987734f479)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611541" author="hudson" created="Thu, 2 Jul 2015 06:16:43 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #6623 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/6623/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/6623/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis (stack: rev fca725a899984f57a6ad48ce9ae9cbc34e8ce752)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/mapreduce/TestWALPlayer.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/mapreduce/WALPlayer.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis&quot; (stack: rev f0e29c49a1f5f3773ba03b822805d863c149b443)&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/mapreduce/TestWALPlayer.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/mapreduce/WALPlayer.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611546" author="stack" created="Thu, 2 Jul 2015 06:24:59 +0000"  >&lt;p&gt;Ok. Added missing patch and the addendum that fixes failing TestAssignmentManagerOnCluster tests. Agree with fix for UT (I love unit tests).&lt;/p&gt;

&lt;p&gt;For branch-1+ I applied addendum and checked I got all patch this time.&lt;/p&gt;

&lt;p&gt;On branch-2, I applied the original patch plus version of master addendum. I made master same as branch-1s. The master addendum makes logic different. Why &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;? I&apos;ll addendum the master is intended. I am talking about this hunk in master addendum patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 14 @@ -891,12 +891,16 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class AssignmentManager {
 15          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Server &quot;&lt;/span&gt; + server + &lt;span class=&quot;code-quote&quot;&gt;&quot; region CLOSE RPC returned &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; +
 16            region.getRegionNameAsString());
 17        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
 18 +        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sleepTime = 0;
 19 +        Configuration conf = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.getConfiguration();
 20          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RemoteException) {
 21            t = ((RemoteException)t).unwrapRemoteException();
 22          }
 23 -        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NotServingRegionException
 24 +        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RegionServerAbortedException
 25              || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RegionServerStoppedException
 26              || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServerNotRunningYetException) {
 27 +
 28 +        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NotServingRegionException) {
 29            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Offline &quot;&lt;/span&gt; + region.getRegionNameAsString()
 30              + &lt;span class=&quot;code-quote&quot;&gt;&quot;, it&apos;s not any more on &quot;&lt;/span&gt; + server, t);
 31            regionStates.updateRegionState(region, State.OFFLINE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;whereas in original patch we have this (set a sleeptime...)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
411 @@ -1866,11 +1867,19 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class AssignmentManager &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ZooKeeperListener {
412          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Server &quot;&lt;/span&gt; + server + &lt;span class=&quot;code-quote&quot;&gt;&quot; region CLOSE RPC returned &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; +
413            region.getRegionNameAsString());
414        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
415 +        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sleepTime = 0;
416 +        Configuration conf = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.getConfiguration();
417          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RemoteException) {
418            t = ((RemoteException)t).unwrapRemoteException();
419          }
420          &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; logRetries = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
421 -        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NotServingRegionException
422 +        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RegionServerAbortedException) {
423 +          &lt;span class=&quot;code-comment&quot;&gt;// RS is aborting, we cannot offline the region since the region may need to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; WAL
&lt;/span&gt;424 +          &lt;span class=&quot;code-comment&quot;&gt;// recovery. Until we see  the RS expiration, we should retry.
&lt;/span&gt;425 +          sleepTime = 1 + conf.getInt(RpcClient.FAILED_SERVER_EXPIRY_KEY,
426 +            RpcClient.FAILED_SERVER_EXPIRY_DEFAULT);
427 +
428 +        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NotServingRegionException
429              || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RegionServerStoppedException
430              || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServerNotRunningYetException) {

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks for catching my misapply.&lt;/p&gt;</comment>
                            <comment id="14611576" author="stack" created="Thu, 2 Jul 2015 07:06:54 +0000"  >&lt;p&gt;branch-1.2 needed same change in TestAssignmentManager as branch-1. Applied this. Hopefully that is it.&lt;/p&gt;</comment>
                            <comment id="14611580" author="hudson" created="Thu, 2 Jul 2015 07:12:42 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #6624 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/6624/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/6624/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; REAPPLY (stack: rev 20e855f2824d3d39c13560fedabbd985f3ae5d13)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/mapreduce/WALPlayer.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java&lt;/li&gt;
	&lt;li&gt;hbase-it/src/test/java/org/apache/hadoop/hbase/test/IntegrationTestLoadAndVerify.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerStoppedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/mapreduce/TestWALPlayer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611592" author="hudson" created="Thu, 2 Jul 2015 07:20:33 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.1 #571 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.1/571/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.1/571/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev a9cecf32a99caed3fccd0b6b00aca6d42d7979d3)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14611628" author="stack" created="Thu, 2 Jul 2015 08:03:20 +0000"  >&lt;p&gt;A fix for master compile failure. So, on master, we did revert, then applied new patch... and then added his addendum.&lt;/p&gt;</comment>
                            <comment id="14612346" author="enis" created="Thu, 2 Jul 2015 18:39:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;whereas in original patch we have this (set a sleeptime...)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My b. We should have the sleepTime as well in master. Let compile a list of addendums. &lt;/p&gt;</comment>
                            <comment id="14612470" author="enis" created="Thu, 2 Jul 2015 20:28:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; do you mind checking these addendums as well. I think we should also handle RegionServerNotYetRunningException in case the old server was killed, and a new server came up without the zk notification for the old server was observed from the master. &lt;/p&gt;</comment>
                            <comment id="14612548" author="stack" created="Thu, 2 Jul 2015 21:22:38 +0000"  >&lt;p&gt;+1 I was thinking that a possible intent of yours in your master addendum. Makes sense... hang around till server dies for sure.&lt;/p&gt;

&lt;p&gt;Let me do in subissue. I&apos;ve made a mess of this issue.&lt;/p&gt;</comment>
                            <comment id="14612577" author="stack" created="Thu, 2 Jul 2015 21:42:21 +0000"  >&lt;p&gt;Applied last set of addendums in sub-issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14013&quot; title=&quot;Retry when RegionServerNotYetRunningException rather than go ahead with assign so for sure we don&amp;#39;t skip WAL replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14013&quot;&gt;&lt;del&gt;HBASE-14013&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14612649" author="enis" created="Thu, 2 Jul 2015 22:54:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Applied last set of addendums in sub-issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14013&quot; title=&quot;Retry when RegionServerNotYetRunningException rather than go ahead with assign so for sure we don&amp;#39;t skip WAL replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14013&quot;&gt;&lt;del&gt;HBASE-14013&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks a bunch. &lt;/p&gt;</comment>
                            <comment id="14613760" author="hudson" created="Sat, 4 Jul 2015 11:43:11 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.2-IT #36 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2-IT/36/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2-IT/36/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 895f5346831edb6165979ccd76a69e987734f479)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; NEW ADDENDUM TO FIX TestAssignmentManager (stack: rev 9446b99a5af3d710400b13dc4756d254ec203a41)&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14613768" author="hudson" created="Sat, 4 Jul 2015 11:53:01 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.3-IT #18 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3-IT/18/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3-IT/18/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 09846ff81a1af3cb68e19b7390df4424d45b5c42)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 7b4febbc2b32ac09189af8508d40872fea46ad98)&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14613781" author="hudson" created="Sat, 4 Jul 2015 12:06:38 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.2 #49 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.2/49/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.2/49/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; NEW ADDENDUM TO FIX TestAssignmentManager (stack: rev 9446b99a5af3d710400b13dc4756d254ec203a41)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14613796" author="hudson" created="Sat, 4 Jul 2015 13:09:57 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.3 #33 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.3/33/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.3/33/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 09846ff81a1af3cb68e19b7390df4424d45b5c42)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManagerOnCluster.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerAbortedException.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13895&quot; title=&quot;DATALOSS: Region assigned before WAL replay when abort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13895&quot;&gt;&lt;del&gt;HBASE-13895&lt;/del&gt;&lt;/a&gt; DATALOSS: Region assigned before WAL replay when abort (Enis Soztutar) &amp;#8211; ADDENDUM (stack: rev 7b4febbc2b32ac09189af8508d40872fea46ad98)&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12743246" name="13895.branch-1.2.txt" size="3229" author="stack" created="Thu, 2 Jul 2015 07:06:54 +0000"/>
                            <attachment id="12743253" name="13895.master.addendum2.txt" size="1767" author="stack" created="Thu, 2 Jul 2015 08:03:20 +0000"/>
                            <attachment id="12743204" name="13895.master.patch" size="21874" author="stack" created="Thu, 2 Jul 2015 01:10:06 +0000"/>
                            <attachment id="12743212" name="hbase-13895_addendum-master.patch" size="4921" author="enis" created="Thu, 2 Jul 2015 02:38:16 +0000"/>
                            <attachment id="12743210" name="hbase-13895_addendum.patch" size="6932" author="enis" created="Thu, 2 Jul 2015 02:09:55 +0000"/>
                            <attachment id="12743381" name="hbase-13895_addendum3-branch-1.1.patch" size="1385" author="enis" created="Thu, 2 Jul 2015 20:28:42 +0000"/>
                            <attachment id="12743382" name="hbase-13895_addendum3-branch-1.patch" size="1385" author="enis" created="Thu, 2 Jul 2015 20:28:42 +0000"/>
                            <attachment id="12743383" name="hbase-13895_addendum3-master.patch" size="1503" author="enis" created="Thu, 2 Jul 2015 20:28:42 +0000"/>
                            <attachment id="12739473" name="hbase-13895_v1-branch-1.1.patch" size="27318" author="enis" created="Sun, 14 Jun 2015 06:49:12 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12842451">HBASE-14013</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 14 Jun 2015 06:41:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fzs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>If the master went to assign a region concurrent with a RegionServer abort, the returned RegionServerAbortedException was being handled as though the region had been cleanly offlined so assign was allowed proceed. If the region was opened in its new location before WAL replay completion, the replayed edits were ignored, worst case, or were later played over the top of edits that had come in since open and so susceptible to overwrite. In either case, DATALOSS.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>