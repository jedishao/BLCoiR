<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 02 20:27:33 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1597/HBASE-1597.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1597] Prevent unnecessary caching of blocks during compactions</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1597</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When running any kind of compaction, we read every block of every storefile being compacted into the block cache.&lt;/p&gt;

&lt;p&gt;We would like to reuse any already cached blocks, if available, but otherwise we should not bog down the LRU with unnecessary blocks.&lt;/p&gt;

&lt;p&gt;This is not as bad as it was with the old LRU because the latest LRU implementation (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1460&quot; title=&quot;Concurrent LRU Block Cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1460&quot;&gt;&lt;del&gt;HBASE-1460&lt;/del&gt;&lt;/a&gt;) is scan-resistant.  This ensures that we are not causing massive eviction of the blocks that are being read multiple times or from in-memory tables.  However, this does add to the GC-woes of an import because each block gets further referenced, and for longer periods of time.  There is also overhead in running the LRU evictions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12429253">HBASE-1597</key>
            <summary>Prevent unnecessary caching of blocks during compactions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Jul 2009 05:01:28 +0000</created>
                <updated>Fri, 10 Jun 2011 00:37:06 +0000</updated>
                            <resolved>Fri, 3 Jul 2009 18:41:12 +0000</resolved>
                                    <version>0.20.0</version>
                                    <fixVersion>0.20.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12725923" author="streamy" created="Wed, 1 Jul 2009 05:04:39 +0000"  >&lt;p&gt;Currently tied to 0.20.0 until we investigate further.  Ryan, what say you?&lt;/p&gt;</comment>
                            <comment id="12726752" author="streamy" created="Fri, 3 Jul 2009 00:38:42 +0000"  >&lt;p&gt;Creates an additional HFile.Reader subclass called HFile.CompactionReader&lt;/p&gt;

&lt;p&gt;Overrides a single method:  ByteBuffer readBlock(int)&lt;/p&gt;

&lt;p&gt;Same code in that method except at the end it doesn&apos;t cache the block.&lt;/p&gt;

&lt;p&gt;Adds a method StoreFile.getCompactionReader() which instantiates a new CompactionReader, taking the normal Reader as input.&lt;/p&gt;

&lt;p&gt;Switched the necessary calls from getReader() to getCompactionReader().  There were about 6 of em.&lt;/p&gt;

&lt;p&gt;The nasty part of this now is that it has to instantiate a new CompactionReader rather than just casting or setting a flag.  Lots of other ways to implement this, probably more cleanly and more efficient... Just wanted to put something up so we can have a basis for continued discussion&lt;/p&gt;


&lt;p&gt;Compaction test passes.&lt;/p&gt;</comment>
                            <comment id="12726761" author="apurtell" created="Fri, 3 Jul 2009 01:16:25 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I think this is good enough to retire this issue and move on. Any chance that CompactionReader may acquire more function over time or be specialized? Having it as a separate reader class would not necessarily be bad in that case. &lt;/p&gt;</comment>
                            <comment id="12727000" author="streamy" created="Fri, 3 Jul 2009 15:06:07 +0000"  >&lt;p&gt;Good point, Andrew.  Somehow I forgot about an issue I actually filed, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1521&quot; title=&quot;Optimize codepath for minor compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1521&quot;&gt;&lt;del&gt;HBASE-1521&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Really what I didn&apos;t like in my patch was how I re-instantiate the Reader as a CompactionReader, since I can&apos;t cast up to it.  I did it in a way that just assigns all the internal variables so there&apos;s not much real overhead besides the instantiation.  Seems like there could be a prettier way but it works and performance impact should be negligible.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12727010" author="streamy" created="Fri, 3 Jul 2009 15:41:08 +0000"  >&lt;p&gt;I&apos;m +1 on committing this if others are cool with the design.  Planning to look further into what we can do with this specialization for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1521&quot; title=&quot;Optimize codepath for minor compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1521&quot;&gt;&lt;del&gt;HBASE-1521&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12727054" author="stack" created="Fri, 3 Jul 2009 17:16:29 +0000"  >&lt;p&gt;This seems odd:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CompactionReader(Reader reader) {
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(reader.istream, reader.fileSize, reader.cache);
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.blockIndex = reader.blockIndex;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.trailer = reader.trailer;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.lastkey = reader.lastkey;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.avgKeyLen = reader.avgKeyLen;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.avgValueLen = reader.avgValueLen;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.comparator = reader.comparator;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.metaIndex = reader.metaIndex;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.fileInfoLoaded = reader.fileInfoLoaded;
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.compressAlgo = reader.compressAlgo;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why not make a constructor that takes above args?&lt;/p&gt;

&lt;p&gt;Too much of readBlock is duplicated in CompactionReader.  Would suggest changing backing readBlock so it makes call to a new method that does the add-to-cache... then subclass this new method only.&lt;/p&gt;

&lt;p&gt;Otherwise, nice patch.&lt;/p&gt;</comment>
                            <comment id="12727065" author="streamy" created="Fri, 3 Jul 2009 17:47:19 +0000"  >&lt;p&gt;Adds a new method:  HFile.Reader.cacheBlock(String blockName, ByteBuffer buf)&lt;/p&gt;

&lt;p&gt;HFile.CompactionReader now just overrides that method and does nothing inside of it.&lt;/p&gt;</comment>
                            <comment id="12727089" author="stack" created="Fri, 3 Jul 2009 18:41:12 +0000"  >&lt;p&gt;Patch looks good. Tested it with upload. Logs look fine. Committing.... (Rolled up lrublockcache stats logging into one log message instead of 3 as part of commit). &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12509782">HBASE-3976</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12412442" name="HBASE-1597-v1.patch" size="10075" author="streamy" created="Fri, 3 Jul 2009 00:38:42 +0000"/>
                            <attachment id="12412513" name="HBASE-1597-v2.patch" size="9861" author="streamy" created="Fri, 3 Jul 2009 17:47:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Jul 2009 01:16:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0he7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99563</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>