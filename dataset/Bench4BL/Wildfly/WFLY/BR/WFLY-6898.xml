<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 12:23:36 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-6898/WFLY-6898.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-6898] ConcurrentModificationException when returning from JMS onMessage() MBean</title>
                <link>https://issues.jboss.org/browse/WFLY-6898</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;I receive the following stacktrace when an MBean&apos;s onMessage() returns. The transaction is rolled back and the message marked as undelivered. This started sometime after nightly #2280 which works fine for me.&lt;/p&gt;

&lt;p&gt;2016-07-30 21:51:49,273 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunListener&amp;#93;&lt;/span&gt; (Thread-0 (ActiveMQ-client-global-threads-556320704)) Finished processing run 16819&lt;br/&gt;
        at org.jboss.as.ejb3.tx.CMTTxInterceptor.handleInCallerTx(CMTTxInterceptor.java:159)&lt;br/&gt;
        at org.jboss.as.ejb3.tx.CMTTxInterceptor.invokeInCallerTx(CMTTxInterceptor.java:256)&lt;br/&gt;
        at org.jboss.as.ejb3.tx.CMTTxInterceptor.required(CMTTxInterceptor.java:329)&lt;br/&gt;
        at org.jboss.as.ejb3.tx.CMTTxInterceptor.processInvocation(CMTTxInterceptor.java:239)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.interceptors.CurrentInvocationContextInterceptor.processInvocation(CurrentInvocationContextInterceptor.java:41)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.invocationmetrics.WaitTimeInterceptor.processInvocation(WaitTimeInterceptor.java:47)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.security.SecurityContextInterceptor.processInvocation(SecurityContextInterceptor.java:100)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.deployment.processors.StartupAwaitInterceptor.processInvocation(StartupAwaitInterceptor.java:22)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.interceptors.ShutDownInterceptorFactory$1.processInvocation(ShutDownInterceptorFactory.java:64)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.deployment.processors.EjbSuspendInterceptor.processInvocation(EjbSuspendInterceptor.java:53)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.interceptors.LoggingInterceptor.processInvocation(LoggingInterceptor.java:67)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ee.component.NamespaceContextInterceptor.processInvocation(NamespaceContextInterceptor.java:50)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.interceptors.AdditionalSetupInterceptor.processInvocation(AdditionalSetupInterceptor.java:54)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ejb3.component.messagedriven.MessageDrivenComponentDescription$5$1.processInvocation(MessageDrivenComponentDescription.java:239)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.ContextClassLoaderInterceptor.processInvocation(ContextClassLoaderInterceptor.java:64)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:356)&lt;br/&gt;
        at org.wildfly.security.manager.WildFlySecurityManager.doChecked(WildFlySecurityManager.java:636)&lt;br/&gt;
        at org.jboss.invocation.AccessCheckingInterceptor.processInvocation(AccessCheckingInterceptor.java:61)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:356)&lt;br/&gt;
        at org.jboss.invocation.PrivilegedWithCombinerInterceptor.processInvocation(PrivilegedWithCombinerInterceptor.java:80)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
        at org.jboss.as.ee.component.ViewService$View.invoke(ViewService.java:198)&lt;br/&gt;
        at org.jboss.as.ee.component.ViewDescription$1.processInvocation(ViewDescription.java:185)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
        at org.jboss.as.ee.component.ProxyInvocationHandler.invoke(ProxyInvocationHandler.java:73)&lt;br/&gt;
        at com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunListener$$$view3.onMessage(Unknown Source)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:497)&lt;br/&gt;
        at org.jboss.as.ejb3.inflow.MessageEndpointInvocationHandler.doInvoke(MessageEndpointInvocationHandler.java:139)&lt;br/&gt;
        at org.jboss.as.ejb3.inflow.AbstractInvocationHandler.invoke(AbstractInvocationHandler.java:73)&lt;br/&gt;
        at com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunListener$$$endpoint1.onMessage(Unknown Source)&lt;br/&gt;
        at org.apache.activemq.artemis.ra.inflow.ActiveMQMessageHandler.onMessage(ActiveMQMessageHandler.java:310)&lt;br/&gt;
        at org.apache.activemq.artemis.core.client.impl.ClientConsumerImpl.callOnMessage(ClientConsumerImpl.java:1018)&lt;br/&gt;
        at org.apache.activemq.artemis.core.client.impl.ClientConsumerImpl.access$400(ClientConsumerImpl.java:48)&lt;br/&gt;
        at org.apache.activemq.artemis.core.client.impl.ClientConsumerImpl$Runner.run(ClientConsumerImpl.java:1145)&lt;br/&gt;
        at org.apache.activemq.artemis.utils.OrderedExecutorFactory$OrderedExecutor$ExecutorTask.run(OrderedExecutorFactory.java:103)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.HashMap$HashIterator.nextNode(HashMap.java:1429)&lt;br/&gt;
        at java.util.HashMap$KeyIterator.next(HashMap.java:1453)&lt;br/&gt;
        at org.jboss.weld.context.AbstractContext.destroy(AbstractContext.java:160)&lt;br/&gt;
        at org.jboss.weld.context.AbstractManagedContext.deactivate(AbstractManagedContext.java:58)&lt;br/&gt;
        at org.jboss.weld.context.AbstractBoundContext.deactivate(AbstractBoundContext.java:72)&lt;br/&gt;
        at org.jboss.weld.context.ejb.EjbRequestContextImpl.deactivate(EjbRequestContextImpl.java:47)&lt;br/&gt;
        at org.jboss.weld.ejb.AbstractEJBRequestScopeActivationInterceptor.aroundInvoke(AbstractEJBRequestScopeActivationInterceptor.java:76)&lt;br/&gt;
        at org.jboss.as.weld.ejb.EjbRequestScopeActivationInterceptor.processInvocation(EjbRequestScopeActivationInterceptor.java:83)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.as.ee.concurrent.ConcurrentContextInterceptor.processInvocation(ConcurrentContextInterceptor.java:45)&lt;br/&gt;
        at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:340)&lt;br/&gt;
        at org.jboss.invocation.InitialInterceptor.processInvocation(InitialInterceptor.java:21)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12641313">WFLY-6898</key>
            <summary>ConcurrentModificationException when returning from JMS onMessage() MBean</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.jboss.org/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.jboss.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="swd847">Stuart Douglas</assignee>
                                    <reporter username="traivor">Harold Campbell</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 Jul 2016 18:11:06 -0400</created>
                <updated>Sat, 20 Aug 2016 19:38:13 -0400</updated>
                            <resolved>Sat, 20 Aug 2016 19:38:13 -0400</resolved>
                                    <version>10.1.0.CR1</version>
                                    <fixVersion>10.1.0.Final</fixVersion>
                                    <component>CDI / Weld</component>
                    <component>JMS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13273194" author="traivor" created="Sat, 30 Jul 2016 18:14:21 -0400"  >&lt;p&gt;It may or may not be related, but I get the following warning during the REST request which sends that JMS message.&lt;/p&gt;

&lt;p&gt;2016-07-30 21:50:52,082 WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Servlet&amp;#93;&lt;/span&gt; (default task-2) WELD-000717: Unable to deactivate context org.jboss.weld.context.http.HttpRequestContextImpl@3ef46b37&lt;br/&gt;
when destroying request HttpServletRequestImpl [ POST /blah ]&lt;/p&gt;</comment>
                            <comment id="13273195" author="traivor" created="Sat, 30 Jul 2016 18:26:05 -0400"  >&lt;p&gt;The message listener calls into a RequestScoped CDI bean to do the real work. If I remove that call, the stacktrace goes away.&lt;/p&gt;</comment>
                            <comment id="13273279" author="tremes" created="Mon, 1 Aug 2016 03:53:14 -0400"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=traivor&quot; class=&quot;user-hover&quot; rel=&quot;traivor&quot;&gt;Harold Campbell&lt;/a&gt;&lt;br/&gt;
Do you have some reproducer please?&lt;/p&gt;</comment>
                            <comment id="13273699" author="swd847" created="Mon, 1 Aug 2016 22:45:21 -0400"  >&lt;p&gt;This happens when you use a new request scoped bean (that had not been used yet this request) in the @PreDestory method of a request scoped bean.&lt;/p&gt;

&lt;p&gt;When the request scoped bean is invoked in the @PreDestory it results in an addition to the backing map, which is in the process of being iterated over. Because the iterator does not support concurrent modification this blows up. &lt;/p&gt;

&lt;p&gt;The simplistic solution of Iterating over a copy of the map does not really work either, as this means the new bean that was created will never be destroyed, and there is also the possibility for endless loops if the two beans reference each other and use each other in the PreDestroy.&lt;/p&gt;</comment>
                            <comment id="13274198" author="traivor" created="Tue, 2 Aug 2016 15:52:03 -0400"  >&lt;p&gt;My attempt to create a test case has resulted in something which works just fine. :/ Could going from a multi-module ear to a war have anything to do with that?&lt;/p&gt;

&lt;p&gt;FWIW none of the methods are marked @PreDestroy.&lt;/p&gt;</comment>
                            <comment id="13274245" author="swd847" created="Tue, 2 Aug 2016 21:01:20 -0400"  >&lt;p&gt;I think something in your app must be using @PreDestroy, unless there is some other way that this can happen. The exception happens when beans are being destroyed, and I am pretty sure that the only way this could happen is if PreDestroy causes a request scoped bean to be created (unless you are somehow holding onto the original InvocationContext in an interceptor and then modifying it concurrently). &lt;/p&gt;</comment>
                            <comment id="13274246" author="swd847" created="Tue, 2 Aug 2016 21:01:56 -0400"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=mkouba&quot; class=&quot;user-hover&quot; rel=&quot;mkouba&quot;&gt;Martin Kouba&lt;/a&gt; do you have any idea what could be causing this?&lt;/p&gt;</comment>
                            <comment id="13274299" author="mkouba" created="Wed, 3 Aug 2016 03:15:02 -0400"  >&lt;p&gt;Stuart is right. It seems that the only way to get this exception is to create a new request scoped bean during &lt;tt&gt;@PreDestroy&lt;/tt&gt;. Even the modification to the original &lt;tt&gt;InvocationContext&lt;/tt&gt; should not matter at this point of deactivation.&lt;/p&gt;

&lt;p&gt;One way to get more info without reproducer is to enable TRACE logging for &lt;tt&gt;org.jboss.weld.Context&lt;/tt&gt; category (see also &lt;a href=&quot;http://weld.cdi-spec.org/documentation/#7):&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://weld.cdi-spec.org/documentation/#7):&lt;/a&gt;&lt;/p&gt;
&lt;p/&gt;
&lt;div id=&quot;syntaxplugin&quot; class=&quot;syntaxplugin&quot; style=&quot;border: 1px dashed #bbb; border-radius: 5px !important; overflow: auto; max-height: 30em;&quot;&gt;
&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot; style=&quot;font-size: 1em; line-height: 1.4em !important; font-weight: normal; font-style: normal; color: black;&quot;&gt;
		&lt;tbody &gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;  margin-top: 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;console&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;-handler &lt;/span&gt;&lt;span style=&quot;color: gray; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: blue; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&quot;CONSOLE&quot;&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;  &amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: gray; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: blue; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;/&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #008200; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;lt;!-- REMOVE THIS --&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;console&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;-handler&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;...&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;logger&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: gray; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;category&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: blue; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&quot;org.jboss.weld.Context&quot;&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;  &amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: gray; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: blue; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&quot;TRACE&quot;&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   margin-bottom: 10px;  width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span style=&quot;color: #006699; font-weight: bold; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;logger&lt;/span&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
			&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p/&gt;</comment>
                            <comment id="13274652" author="traivor" created="Wed, 3 Aug 2016 11:58:50 -0400"  >&lt;p&gt;The weld logging creates a lot of output, no suprise, so I&apos;ve concentrated on PreDestroy. Before both the warning during the REST request in my first comment and before the stacktrace I get this group of log messages. Note, both instances call into the same RequestScoped bean which does in fact inject some JMS resources:&lt;/p&gt;

&lt;p&gt;2016-08-03 15:44:00,957 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (default task-1) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-200&quot; title=&quot;getBaseType() is not used to obtain a field type from an alternative metadata source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-200&quot;&gt;&lt;del&gt;WELD-000200&lt;/del&gt;&lt;/a&gt;: Looked for WELD%ManagedBean%winthorpe-ear.ear|org.wildfly.extension.messaging-activemq:main.additionalClasses|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext&lt;span class=&quot;error&quot;&gt;&amp;#91;@javax.enterprise.context.RequestScoped()&amp;#93;&lt;/span&gt;&lt;/p&gt;
{org.wildfly.extension.messaging.activemq.deployment.injection.AbstractJMSContext.cleanUp[@javax.annotation.PreDestroy()]();}|false and got null in org.jboss.weld.context.beanstore.http.RequestBeanStore@1baf0df0&lt;br/&gt;
2016-08-03 15:44:00,957 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (default task-1) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-200&quot; title=&quot;getBaseType() is not used to obtain a field type from an alternative metadata source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-200&quot;&gt;&lt;del&gt;WELD-000200&lt;/del&gt;&lt;/a&gt;: Looked for WELD%ManagedBean%winthorpe-ear.ear|org.wildfly.extension.messaging-activemq:main.additionalClasses|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext&lt;span class=&quot;error&quot;&gt;&amp;#91;@javax.enterprise.context.RequestScoped()&amp;#93;&lt;/span&gt;{org.wildfly.extension.messaging.activemq.deployment.injection.AbstractJMSContext.cleanUp[@javax.annotation.PreDestroy()]();}
&lt;p&gt;|false and got null in org.jboss.weld.context.beanstore.http.RequestBeanStore@1baf0df0&lt;br/&gt;
2016-08-03 15:44:00,958 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (default task-1) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-200&quot; title=&quot;getBaseType() is not used to obtain a field type from an alternative metadata source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-200&quot;&gt;&lt;del&gt;WELD-000200&lt;/del&gt;&lt;/a&gt;: Looked for WELD%ManagedBean%winthorpe-ear.ear|org.wildfly.extension.messaging-activemq:main.additionalClasses|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext&lt;span class=&quot;error&quot;&gt;&amp;#91;@javax.enterprise.context.RequestScoped()&amp;#93;&lt;/span&gt;&lt;/p&gt;
{org.wildfly.extension.messaging.activemq.deployment.injection.AbstractJMSContext.cleanUp[@javax.annotation.PreDestroy()]();}|false and got null in org.jboss.weld.context.beanstore.http.RequestBeanStore@1baf0df0&lt;br/&gt;
2016-08-03 15:44:00,958 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (default task-1) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-202&quot; title=&quot;Push BeanManager for module into ServletContext on startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-202&quot;&gt;&lt;del&gt;WELD-000202&lt;/del&gt;&lt;/a&gt;: Added ForwardingBean null for Managed Bean &lt;span class=&quot;error&quot;&gt;&amp;#91;class org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext&amp;#93;&lt;/span&gt; with qualifiers &lt;span class=&quot;error&quot;&gt;&amp;#91;@Any @Default&amp;#93;&lt;/span&gt; with key WELD%ManagedBean%winthorpe-ear.ear|org.wildfly.extension.messaging-activemq:main.additionalClasses|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext|org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext&lt;span class=&quot;error&quot;&gt;&amp;#91;@javax.enterprise.context.RequestScoped()&amp;#93;&lt;/span&gt;{org.wildfly.extension.messaging.activemq.deployment.injection.AbstractJMSContext.cleanUp[@javax.annotation.PreDestroy()]();}
&lt;p&gt;|false to org.jboss.weld.context.beanstore.http.RequestBeanStore@1baf0df0&lt;/p&gt;

&lt;p&gt;In the REST case that these are followed by:&lt;/p&gt;

&lt;p&gt;2016-08-03 15:44:00,964 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (default task-1) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-203&quot; title=&quot;Hard dependency on jsr250-api exists in Beans.getPostConstruct() and possibly elsewhere&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-203&quot;&gt;&lt;del&gt;WELD-000203&lt;/del&gt;&lt;/a&gt;: Removed Bean: ForwardingBean null for Managed Bean &lt;span class=&quot;error&quot;&gt;&amp;#91;class com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunBean&amp;#93;&lt;/span&gt; with qualifiers &lt;span class=&quot;error&quot;&gt;&amp;#91;@Any @Default&amp;#93;&lt;/span&gt;; Instance: com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunBean$Proxy$_$$_WeldSubclass@3efebafc; CreationalContext: org.jboss.weld.context.CreationalContextImpl@41f85638 from org.jboss.weld.context.http.HttpRequestContextImpl@526de3a4&lt;br/&gt;
2016-08-03 15:44:00,965 WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Servlet&amp;#93;&lt;/span&gt; (default task-1) WELD-000717: Unable to deactivate context org.jboss.weld.context.http.HttpRequestContextImpl@526de3a4 when destroying request HttpServletRequestImpl [ POST /winthorpe-service/rest/accounts/oak:57336/optimizations ]&lt;/p&gt;

&lt;p&gt;And in the onMessage case:&lt;/p&gt;

&lt;p&gt;016-08-03 15:44:57,084 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.weld.Context&amp;#93;&lt;/span&gt; (Thread-0 (ActiveMQ-client-global-threads-1478604432)) &lt;a href=&quot;https://issues.jboss.org/browse/WELD-203&quot; title=&quot;Hard dependency on jsr250-api exists in Beans.getPostConstruct() and possibly elsewhere&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WELD-203&quot;&gt;&lt;del&gt;WELD-000203&lt;/del&gt;&lt;/a&gt;: Removed Bean: ForwardingBean null for Managed Bean &lt;span class=&quot;error&quot;&gt;&amp;#91;class com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunBean&amp;#93;&lt;/span&gt; with qualifiers &lt;span class=&quot;error&quot;&gt;&amp;#91;@Any @Default&amp;#93;&lt;/span&gt;; Instance: com.envestnet.ejb.winthorpe.optimizer.WinthorpeRunBean$Proxy$_$$_WeldSubclass@476149d1; CreationalContext: org.jboss.weld.context.CreationalContextImpl@63ef2e90 from org.jboss.weld.context.ejb.EjbRequestContextImpl@6b841795&lt;br/&gt;
2016-08-03 15:44:57,087 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.as.ejb3.invocation&amp;#93;&lt;/span&gt; (Thread-0 (ActiveMQ-client-global-threads-1478604432)) WFLYEJB0034: EJB Invocation failed on component...&lt;/p&gt;</comment>
                            <comment id="13274808" author="swd847" created="Wed, 3 Aug 2016 19:15:41 -0400"  >&lt;p&gt;I can see what is happening here, it is a bug in the JMS CDI extension. &lt;/p&gt;

&lt;p&gt;Basically there are two beans at play, org.wildfly.extension.messaging.activemq.deployment.injection.RequestedJMSContext and org.wildfly.extension.messaging.activemq.deployment.injection.InjectedJMSContext.&lt;/p&gt;

&lt;p&gt;InjectedJMSContext is @Dependent scoped, so if it is injected into a request scoped bean it will effectively be request scoped for the current invocation.&lt;/p&gt;

&lt;p&gt;Both beans have a PreDestroy method, RequestedJMSContext&apos;s method is fine, however InjectedJMSContext appears to try and call RequestedJMSContext.cleanUp() (even though there is no need, as CDI will take care of that for you). If RequestedJMSContext has not been used this request or was destroyed already then you get this exception.&lt;/p&gt;

&lt;p&gt;As far as I can see the fix is to delete the InjectedJMSContext @PreDestroy method, as all it does is call methods that should already by called by CDI.&lt;/p&gt;</comment>
                            <comment id="13274811" author="swd847" created="Wed, 3 Aug 2016 20:00:11 -0400"  >&lt;p&gt;To reproduce this you need:&lt;/p&gt;

&lt;p&gt;A request scoped bean (not the actual MDB itself) to inject the JMSContext. This JMSContext must then only be used from the scope of a transaction. &lt;/p&gt;

&lt;p&gt;This will result in the RequestedJMSContext not being created, until the JMSContext is being destroyed (triggered by the request scoped bean being destroyed), which causes the exception.&lt;/p&gt;</comment>
                            <comment id="13274838" author="mkouba" created="Thu, 4 Aug 2016 02:19:56 -0400"  >&lt;p&gt;I agree with Stuart - &lt;tt&gt;InjectedJMSContext&lt;/tt&gt; bean should not do any cleanup (neither &lt;tt&gt;RequestedJMSContext&lt;/tt&gt; nor &lt;tt&gt;TransactedJMSContext&lt;/tt&gt;). To be honest, the JMS 2.0 spec requirement WRT scope of injected &lt;tt&gt;JMSContext&lt;/tt&gt; looks odd to me (see also 12.4.4. Scope of injected JMSContext objects) - I&apos;m not sure it&apos;s legal from the CDI spec point of view.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=jmesnil&quot; class=&quot;user-hover&quot; rel=&quot;jmesnil&quot;&gt;Jeff Mesnil&lt;/a&gt; It seems this regression was introduced as a part of the fix for &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-3471&quot; title=&quot;Scope of JMSContextProducer should be either @Request or @Tx not default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-3471&quot;&gt;&lt;del&gt;WFLY-3471&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13281742" author="traivor" created="Sat, 20 Aug 2016 13:14:19 -0400"  >&lt;p&gt;Is there a workaround for this? I assume from the state of this bug that 10.1 was released without the fix.&lt;/p&gt;</comment>
                            <comment id="13281746" author="swd847" created="Sat, 20 Aug 2016 19:38:13 -0400"  >&lt;p&gt;I just forgot to mark it as closed, it was fixed in 10.1.Final&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310120">
                    <name>Cloners</name>
                                                                <inwardlinks description="cloned to">
                                        <issuelink>
            <issuekey id="12641834">JBEAP-5542</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|i07lhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>