<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 12:12:13 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-4657/WFLY-4657.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-4657] EJB timer blocked after trigger+suspend+activate operations and JDBC storage</title>
                <link>https://issues.jboss.org/browse/WFLY-4657</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;Scenario:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The AS is configured to use a JDBC storage for EJB timers (using the H2 ExampleDS is sufficient for reproduction)&lt;/li&gt;
	&lt;li&gt;There is a persistent calendar timer going off every few seconds&lt;/li&gt;
	&lt;li&gt;The &apos;trigger&apos; management operation is called on that timer&lt;/li&gt;
	&lt;li&gt;The timer goes off one time extra, as expected&lt;/li&gt;
	&lt;li&gt;The &apos;suspend&apos; management operation is called on that timer&lt;/li&gt;
	&lt;li&gt;After a few seconds, the &apos;activate&apos; operation is called on that timer&lt;/li&gt;
	&lt;li&gt;The timer will never go off again (not even by invoking &apos;trigger&apos; operation)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The cause:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Each time the timer goes off, a new java.util.TimerTask is scheduled to handle the next alarm&lt;/li&gt;
	&lt;li&gt;When the &apos;trigger&apos; operation is invoked, the TimerServiceImpl computes the timestamp of the next alarm and schedules a new TimerTask&lt;/li&gt;
	&lt;li&gt;The problem is that this new TimerTask overwrites the one currently registered in the TimerServiceImpl, because the TimerServiceImpl assigns TimerTasks to Timers using a map: &lt;a href=&quot;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/TimerServiceImpl.java#L905&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/TimerServiceImpl.java#L905&lt;/a&gt; - the TimerServiceImpl loses the reference to the previously registered TimerTask and doesn&apos;t cancel it&lt;/li&gt;
	&lt;li&gt;From now on, each new alarm registers the next TimerTask, but makes TimerServiceImpl forget the previous one&lt;/li&gt;
	&lt;li&gt;After some time, when the &apos;suspend&apos; operation is called, the TimerServiceImpl cancels its stored TimerTask. However, it doesn&apos;t know that there is another scheduled elsewhere&lt;/li&gt;
	&lt;li&gt;The TimerTask goes off during the time when the timer is suspended.&lt;/li&gt;
	&lt;li&gt;DatabaseTimerPersistence checks whether the TimerTask can run and sets the Timer&apos;s state to IN_TIMEOUT if yes (&lt;a href=&quot;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/persistence/database/DatabaseTimerPersistence.java#L395&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/persistence/database/DatabaseTimerPersistence.java#L395&lt;/a&gt;). However, this is done BEFORE checking whether the timer is suspended. DatabaseTimerPersistence commits this change. Then comes the mentioned check (&lt;a href=&quot;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/task/TimerTask.java#L141&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/blob/10.0.0.Alpha1/ejb3/src/main/java/org/jboss/as/ejb3/timerservice/task/TimerTask.java#L141&lt;/a&gt;) and it fails, so the Timer will not go off, but the Timer state remains IN_TIMEOUT forever!&lt;/li&gt;
	&lt;li&gt;With every next invocation, as the timer&apos;s state remains IN_TIMEOUT, all invocations are skipped.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12572404">WFLY-4657</key>
            <summary>EJB timer blocked after trigger+suspend+activate operations and JDBC storage</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.jboss.org/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.jboss.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="swd847">Stuart Douglas</assignee>
                                    <reporter username="jmartisk">Jan Martiska</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 May 2015 10:34:25 -0400</created>
                <updated>Thu, 4 Jun 2015 03:14:47 -0400</updated>
                            <resolved>Thu, 4 Jun 2015 03:14:47 -0400</resolved>
                                    <version>10.0.0.Alpha1</version>
                                    <fixVersion>10.0.0.Alpha2</fixVersion>
                                    <component>EJB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13073076" author="swd847" created="Tue, 2 Jun 2015 07:34:08 -0400"  >&lt;p&gt;The linked PR should fix the issue. It changes the behaviour of the &apos;trigger()&apos; operation so that it does not affect the timer state. IMHO the current behaviour is broken, a one of invocation should not modify the timer state. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310120">
                    <name>Cloners</name>
                                            <outwardlinks description="cloned from">
                                        <issuelink>
            <issuekey id="12572405">JBEAP-147</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Git Pull Request</customfieldname>
                        <customfieldvalues>
                            https://github.com/wildfly/wildfly/pull/7559
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzwi8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12310183" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Steps to Reproduce</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;The easiest is probably to build WildFly 10.0.0.Alpha1, reconfigure the distro to use the H2 ExampleDS as JDBC storage for EJB timers and then run PersistentCalendarTimerManagementTestCase#testSuspendAndTrigger from basic testsuite&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>