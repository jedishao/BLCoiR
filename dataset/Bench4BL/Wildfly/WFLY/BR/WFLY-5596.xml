<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 14:08:03 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-5596/WFLY-5596.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-5596] MessageDrivenComponent startDelivery/stopDelivery is not thread safe</title>
                <link>https://issues.jboss.org/browse/WFLY-5596</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/browse/WFLY-4470&quot; title=&quot;Duplicate message deliveries when start an MDB twice via CLI &quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-4470&quot;&gt;&lt;del&gt;WFLY-4470&lt;/del&gt;&lt;/a&gt; made a change to prevent MDBs being activated or deactivated multiple times, but it is not thread safe. A volatile boolean is used for the flag, but there is no protection against multiple threads invoking the methods simultaneously.&lt;/p&gt;

&lt;p&gt;Possible effects include:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;activating the endpoint twice, with (probably) only one deactivation later, leading to not de-registering XA resources from the recovery manager properly&lt;/li&gt;
	&lt;li&gt;activate() and deactivate() running in the wrong order if done by separate threads&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Several simple solutions probably will not work correctly. Using an AtomicBoolean would stop multiple activations/deactivations from concurrent calls, but would mean that startDelivery() could return before the activation was one. Using a synchronized block or other exclusive lock would work, however since it involves invoking non-container code (the resource adapter), there could potentially be a deadlock risk if that invoked some related container functionality.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12590644">WFLY-5596</key>
            <summary>MessageDrivenComponent startDelivery/stopDelivery is not thread safe</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.jboss.org/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.jboss.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="jmesnil">Jeff Mesnil</assignee>
                                    <reporter username="jameslivingston">James Livingston</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Oct 2015 00:19:32 -0400</created>
                <updated>Wed, 20 Jan 2016 17:26:44 -0500</updated>
                            <resolved>Wed, 23 Dec 2015 01:09:44 -0500</resolved>
                                    <version>10.0.0.CR4</version>
                                    <fixVersion>10.0.0.CR5</fixVersion>
                                    <component>EJB</component>
                    <component>JMS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13124131" author="jameslivingston" created="Mon, 2 Nov 2015 00:14:02 -0500"  >&lt;p&gt;In addition, stop() calls deactivate() even when deliveryActive is false, which means activate() may never have been called.&lt;/p&gt;</comment>
                            <comment id="13124546" author="jason.greene" created="Mon, 2 Nov 2015 22:37:46 -0500"  >&lt;p&gt;I remember glancing at this code and thinking it could be better protected. However, IIRC the only usage point is from management ops, and since these ops are declared as write operations they hold the exclusive management write lock. &lt;/p&gt;</comment>
                            <comment id="13124548" author="jameslivingston" created="Mon, 2 Nov 2015 22:54:14 -0500"  >&lt;p&gt;That is no longer true in WF 10 (&lt;a href=&quot;https://issues.jboss.org/browse/WFLY-5151&quot; title=&quot;Add support to mdb delivery-groups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-5151&quot;&gt;&lt;del&gt;WFLY-5151&lt;/del&gt;&lt;/a&gt;), MdbDeliveryControllerService.start()/stop() call those methods as well. It can be triggered by clustering events changing HA Singleton status.&lt;/p&gt;</comment>
                            <comment id="13124549" author="jameslivingston" created="Mon, 2 Nov 2015 22:55:11 -0500"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/browse/WFLY-4661&quot; title=&quot;Provide Support for Clustered Singleton MDBs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-4661&quot;&gt;&lt;del&gt;WFLY-4661&lt;/del&gt;&lt;/a&gt; rather. With only 5151 it is still within a management op.&lt;/p&gt;</comment>
                            <comment id="13131950" author="jameslivingston" created="Thu, 19 Nov 2015 21:36:32 -0500"  >&lt;p&gt;This is reproducible on WF 10 CR4, and can double-activate the endpoint&lt;/p&gt;</comment>
                            <comment id="13138775" author="jira-bugzilla-migration" created="Wed, 9 Dec 2015 02:29:51 -0500"  >&lt;p&gt;baranowb &amp;lt;bbaranow@redhat.com&amp;gt; changed the Status of &lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=1282661&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;bug 1282661&lt;/a&gt; from NEW to POST&lt;/p&gt;</comment>
                            <comment id="13140904" author="jira-bugzilla-migration" created="Mon, 14 Dec 2015 11:08:36 -0500"  >&lt;p&gt;Ivo Studensky &amp;lt;istudens@redhat.com&amp;gt; changed the Status of &lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=1282661&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;bug 1282661&lt;/a&gt; from POST to MODIFIED&lt;/p&gt;</comment>
                            <comment id="13142055" author="jira-bugzilla-migration" created="Wed, 16 Dec 2015 12:20:22 -0500"  >&lt;p&gt;Vladimir Dosoudil &amp;lt;dosoudil@redhat.com&amp;gt; changed the Status of &lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=1282661&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;bug 1282661&lt;/a&gt; from MODIFIED to ON_QA&lt;/p&gt;</comment>
                            <comment id="13151447" author="jira-bugzilla-migration" created="Wed, 20 Jan 2016 17:26:44 -0500"  >&lt;p&gt;Ondrej Chaloupka &amp;lt;ochaloup@redhat.com&amp;gt; changed the Status of &lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=1282661&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;bug 1282661&lt;/a&gt; from ON_QA to VERIFIED&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310221">
                    <name>Sequence</name>
                                            <outwardlinks description="follows up on">
                                        <issuelink>
            <issuekey id="12567223">WFLY-4470</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10011">
                    <name>Superset</name>
                                                                <inwardlinks description="is incorporated by">
                                        <issuelink>
            <issuekey id="12595853">JBEAP-2297</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310440" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Bugzilla References</customfieldname>
                        <customfieldvalues>
                            https://bugzilla.redhat.com/show_bug.cgi?id=1282661
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310341" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bugzilla Update</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10250"><![CDATA[Perform]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Git Pull Request</customfieldname>
                        <customfieldvalues>
                            https://github.com/wildfly/wildfly/pull/8365
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzzcr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12310183" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Steps to Reproduce</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;1) Take the helloworld-mdb quickstart, and add @ClusteredSingleton (from jboss-ejb3-exi-api) to a MDB.&lt;br/&gt;
2) Add a breakpoint on MessageDrivenBean.activate()&lt;br/&gt;
3) Deploy and start the server&lt;/p&gt;

&lt;p&gt;Either one or two threads may hit the breakpoint concurrently, depending on whether the first runs &quot;this.deliveryActive = true&quot; before the second does the check:&lt;br/&gt;
org.jboss.as.ejb3.component.messagedriven.MessageDrivenComponent.activate() line: 238	&lt;br/&gt;
org.jboss.as.ejb3.component.messagedriven.MessageDrivenComponent.startDelivery() line: 265	&lt;br/&gt;
org.jboss.as.ejb3.component.messagedriven.MdbDeliveryControllerService.start(org.jboss.msc.service.StartContext) line: 51	&lt;br/&gt;
org.jboss.msc.service.ServiceControllerImpl$StartTask.startService(org.jboss.msc.service.Service&amp;lt;? extends S&amp;gt;, org.jboss.msc.service.StartContext) line: 1948	&lt;br/&gt;
org.jboss.msc.service.ServiceControllerImpl$StartTask.run() line: 1881	&lt;br/&gt;
org.jboss.msc.service.ServiceContainerImpl$ContainerExecutor(java.util.concurrent.ThreadPoolExecutor).runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) line: 1142	&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run() line: 617	&lt;br/&gt;
org.jboss.msc.service.ServiceContainerImpl$ServiceThread(java.lang.Thread).run() line: 745	&lt;/p&gt;

&lt;p&gt;org.jboss.as.ejb3.component.messagedriven.MessageDrivenComponent.activate() line: 238	&lt;br/&gt;
org.jboss.as.ejb3.component.messagedriven.MessageDrivenComponent.start() line: 214	&lt;br/&gt;
org.jboss.as.ee.component.ComponentStartService$1.run() line: 54	&lt;br/&gt;
java.util.concurrent.Executors$RunnableAdapter&amp;lt;T&amp;gt;.call() line: 511	&lt;br/&gt;
java.util.concurrent.FutureTask&amp;lt;V&amp;gt;.run() line: 266	&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor.runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) line: 1142	&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run() line: 617	&lt;br/&gt;
org.jboss.threads.JBossThread(java.lang.Thread).run() line: 745	&lt;br/&gt;
org.jboss.threads.JBossThread.run() line: 320	&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>