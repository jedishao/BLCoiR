<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 14:06:07 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-2651/WFLY-2651.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-2651]  JBAS014160: Wrong tx on thread when calling async EJB method from async servlet </title>
                <link>https://issues.jboss.org/browse/WFLY-2651</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;When trying to execute asynchronous EJB bean from asynchronous servlet, the following exception is thrown (testcase is available at &lt;a href=&quot;https://github.com/eyusupov/async-testcase/):&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/eyusupov/async-testcase/):&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2013-12-13 00:42:03,489 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.as.txn&amp;#93;&lt;/span&gt; (EJB default - 1) JBAS010152: APPLICATION ERROR: transaction still active in request with status 0&lt;/p&gt;

&lt;p&gt;2013-12-13 00:42:03,494 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;org.jboss.as.ejb3.invocation&amp;#93;&lt;/span&gt; (EJB default - 1) JBAS014134: EJB Invocation failed on component AsyncBean for method public void com.okasamastarr.web.AsyncBean.count(javax.servlet.AsyncContext) throws java.io.IOException: java.lang.IllegalStateException: JBAS014160: Wrong tx on thread: expected TransactionImple &amp;lt; ac, BasicAction: 0:ffffac1e0f02:-40b55bbb:52aa1f96:8 status: ActionStatus.ABORTED &amp;gt;, actual null&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.tx.CMTTxInterceptor.endTransaction(CMTTxInterceptor.java:85) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.tx.CMTTxInterceptor.invokeInOurTx(CMTTxInterceptor.java:277) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.tx.CMTTxInterceptor.required(CMTTxInterceptor.java:340) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.tx.CMTTxInterceptor.processInvocation(CMTTxInterceptor.java:239) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.CurrentInvocationContextInterceptor.processInvocation(CurrentInvocationContextInterceptor.java:41) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.invocationmetrics.WaitTimeInterceptor.processInvocation(WaitTimeInterceptor.java:43) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.security.SecurityContextInterceptor.processInvocation(SecurityContextInterceptor.java:95) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.ShutDownInterceptorFactory$1.processInvocation(ShutDownInterceptorFactory.java:64) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.LoggingInterceptor.processInvocation(LoggingInterceptor.java:59) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ee.component.NamespaceContextInterceptor.processInvocation(NamespaceContextInterceptor.java:50)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.AdditionalSetupInterceptor.processInvocation(AdditionalSetupInterceptor.java:55) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.ContextClassLoaderInterceptor.processInvocation(ContextClassLoaderInterceptor.java:64)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;/p&gt;

&lt;p&gt;    at org.wildfly.security.manager.WildFlySecurityManager.doChecked(WildFlySecurityManager.java:437)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.AccessCheckingInterceptor.processInvocation(AccessCheckingInterceptor.java:61)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.PrivilegedWithCombinerInterceptor.processInvocation(PrivilegedWithCombinerInterceptor.java:80)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ee.component.ViewService$View.invoke(ViewService.java:165)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ee.component.ViewDescription$1.processInvocation(ViewDescription.java:182)&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.LogDiagnosticContextRecoveryInterceptor.processInvocation(LogDiagnosticContextRecoveryInterceptor.java:79) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.AsyncFutureInterceptorFactory$1$1.runInvocation(AsyncFutureInterceptorFactory.java:87) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.as.ejb3.component.interceptors.AsyncInvocationTask.run(AsyncInvocationTask.java:73) &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-ejb3-8.0.0.Beta1.jar:8.0.0.Beta1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) &lt;span class=&quot;error&quot;&gt;&amp;#91;rt.jar:1.7.0_25&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) &lt;span class=&quot;error&quot;&gt;&amp;#91;rt.jar:1.7.0_25&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at java.lang.Thread.run(Thread.java:724) &lt;span class=&quot;error&quot;&gt;&amp;#91;rt.jar:1.7.0_25&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    at org.jboss.threads.JBossThread.run(JBossThread.java:122)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Fedora 19, OpenJDK 1.7.0&lt;/p&gt;</environment>
        <key id="12527921">WFLY-2651</key>
            <summary> JBAS014160: Wrong tx on thread when calling async EJB method from async servlet </summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.jboss.org/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.jboss.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="swd847">Stuart Douglas</assignee>
                                    <reporter username="eldaryus">Eldar Yusupov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Dec 2013 08:41:23 -0500</created>
                <updated>Thu, 4 Sep 2014 09:38:14 -0400</updated>
                            <resolved>Mon, 13 Jan 2014 05:32:45 -0500</resolved>
                                    <version>8.0.0.Beta1</version>
                                    <fixVersion>8.0.0.Final</fixVersion>
                                    <component>EJB</component>
                    <component>Web (Undertow)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12931235" author="smarlow" created="Fri, 13 Dec 2013 14:02:08 -0500"  >&lt;p&gt;Looks like an undertow bug or undertow related bug, in that TransactionRollbackSetupAction.checkTransactionStatus() is rolling back the transaction that is started by CMTTxInterceptor and expected to be closed by CMTTxInterceptor.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;	  at org.jboss.as.txn.deployment.TransactionRollbackSetupAction.checkTransactionStatus(TransactionRollbackSetupAction.java:127)&lt;br/&gt;
	  at org.jboss.as.txn.deployment.TransactionRollbackSetupAction.teardown(TransactionRollbackSetupAction.java:66)&lt;br/&gt;
	  at org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$1$1.tearDown(UndertowDeploymentInfoService.java:307)&lt;br/&gt;
	  at io.undertow.servlet.core.CompositeThreadSetupAction$1.tearDown(CompositeThreadSetupAction.java:52)&lt;br/&gt;
	  at io.undertow.servlet.spec.AsyncContextImpl.onAsyncComplete(AsyncContextImpl.java:527)&lt;br/&gt;
	  at io.undertow.servlet.spec.AsyncContextImpl.complete(AsyncContextImpl.java:262)&lt;br/&gt;
	  at testcase.async.AsyncBean.count(AsyncBean.java:18)&lt;br/&gt;
	  at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)&lt;br/&gt;
	  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	  at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
	  at org.jboss.as.ee.component.ManagedReferenceMethodInterceptor.processInvocation(ManagedReferenceMethodInterceptor.java:52)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.WeavedInterceptor.processInvocation(WeavedInterceptor.java:53)&lt;br/&gt;
	  at org.jboss.as.ee.component.interceptors.UserInterceptorFactory$1.processInvocation(UserInterceptorFactory.java:63)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext$Invocation.proceed(InterceptorContext.java:406)&lt;br/&gt;
	  at org.jboss.as.weld.ejb.Jsr299BindingsInterceptor.doMethodInterception(Jsr299BindingsInterceptor.java:82)&lt;br/&gt;
	  at org.jboss.as.weld.ejb.Jsr299BindingsInterceptor.processInvocation(Jsr299BindingsInterceptor.java:93)&lt;br/&gt;
	  at org.jboss.as.ee.component.interceptors.UserInterceptorFactory$1.processInvocation(UserInterceptorFactory.java:63)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.WeavedInterceptor.processInvocation(WeavedInterceptor.java:53)&lt;br/&gt;
	  at org.jboss.as.ee.component.interceptors.UserInterceptorFactory$1.processInvocation(UserInterceptorFactory.java:63)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.invocationmetrics.ExecutionTimeInterceptor.processInvocation(ExecutionTimeInterceptor.java:43)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.jpa.interceptor.SBInvocationInterceptor.processInvocation(SBInvocationInterceptor.java:47)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext$Invocation.proceed(InterceptorContext.java:406)&lt;br/&gt;
	  at org.jboss.weld.ejb.AbstractEJBRequestScopeActivationInterceptor.aroundInvoke(AbstractEJBRequestScopeActivationInterceptor.java:55)&lt;br/&gt;
	  at org.jboss.as.weld.ejb.EjbRequestScopeActivationInterceptor.processInvocation(EjbRequestScopeActivationInterceptor.java:84)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ee.concurrent.ConcurrentContextInterceptor.processInvocation(ConcurrentContextInterceptor.java:45)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.InitialInterceptor.processInvocation(InitialInterceptor.java:21)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
	  at org.jboss.as.ee.component.interceptors.ComponentDispatcherInterceptor.processInvocation(ComponentDispatcherInterceptor.java:53)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.pool.PooledInstanceInterceptor.processInvocation(PooledInstanceInterceptor.java:51)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.tx.CMTTxInterceptor.invokeInOurTx(CMTTxInterceptor.java:273)&lt;br/&gt;
	  at org.jboss.as.ejb3.tx.CMTTxInterceptor.required(CMTTxInterceptor.java:340)&lt;br/&gt;
	  at org.jboss.as.ejb3.tx.CMTTxInterceptor.processInvocation(CMTTxInterceptor.java:239)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.CurrentInvocationContextInterceptor.processInvocation(CurrentInvocationContextInterceptor.java:41)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.invocationmetrics.WaitTimeInterceptor.processInvocation(WaitTimeInterceptor.java:43)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.security.SecurityContextInterceptor.processInvocation(SecurityContextInterceptor.java:95)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.ShutDownInterceptorFactory$1.processInvocation(ShutDownInterceptorFactory.java:64)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.LoggingInterceptor.processInvocation(LoggingInterceptor.java:59)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ee.component.NamespaceContextInterceptor.processInvocation(NamespaceContextInterceptor.java:50)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.AdditionalSetupInterceptor.processInvocation(AdditionalSetupInterceptor.java:55)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.ContextClassLoaderInterceptor.processInvocation(ContextClassLoaderInterceptor.java:64)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;br/&gt;
	  at org.wildfly.security.manager.WildFlySecurityManager.doChecked(WildFlySecurityManager.java:437)&lt;br/&gt;
	  at org.jboss.invocation.AccessCheckingInterceptor.processInvocation(AccessCheckingInterceptor.java:61)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;br/&gt;
	  at org.jboss.invocation.PrivilegedWithCombinerInterceptor.processInvocation(PrivilegedWithCombinerInterceptor.java:80)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
	  at org.jboss.as.ee.component.ViewService$View.invoke(ViewService.java:185)&lt;br/&gt;
	  at org.jboss.as.ee.component.ViewDescription$1.processInvocation(ViewDescription.java:182)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.LogDiagnosticContextRecoveryInterceptor.processInvocation(LogDiagnosticContextRecoveryInterceptor.java:79)&lt;br/&gt;
	  at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.AsyncFutureInterceptorFactory$1$1.runInvocation(AsyncFutureInterceptorFactory.java:87)&lt;br/&gt;
	  at org.jboss.as.ejb3.component.interceptors.AsyncInvocationTask.run(AsyncInvocationTask.java:73)&lt;br/&gt;
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	  at java.lang.Thread.run(Thread.java:724)&lt;br/&gt;
	  at org.jboss.threads.JBossThread.run(JBossThread.java:122)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12931241" author="smarlow" created="Fri, 13 Dec 2013 14:23:21 -0500"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=stuartdouglas&quot; class=&quot;user-hover&quot; rel=&quot;stuartdouglas&quot;&gt;Stuart douglas&lt;/a&gt; I ran the test case for this jira and I see TransactionRollbackSetupAction.changeDepth() returning zero (since thread local depth counter was at one).  The problem is that we are in a CMTTxInterceptor controlled transaction and when CMTTxInterceptor.endTransaction() tries to end the transaction, the transaction is already ended.  &lt;/p&gt;

&lt;p&gt;CMTTxInterceptor.endTransaction() calls tm.getTransaction() and gets null back, since TransactionRollbackSetupAction.checkTransactionStatus() already rolled the transaction back.  This is an error condition that CMTTxInterceptor.endTransaction() throws an &quot;Wrong tx on thread: expected&quot; error for as noted in the forum post and this jira.  Error is:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Wrong tx on thread: expected TransactionImple &amp;lt; ac, BasicAction: 0:ffff7f000001:-610d093f:52ab5be9:8 status: ActionStatus.ABORTED &amp;gt;, actual null&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12931242" author="smarlow" created="Fri, 13 Dec 2013 14:24:28 -0500"  >&lt;p&gt;You can build the test case from the attached sources or just use this war.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8080/async-testcase-1.0-SNAPSHOT/async-counter&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/async-testcase-1.0-SNAPSHOT/async-counter&lt;/a&gt; triggers the failure.&lt;/p&gt;</comment>
                            <comment id="12931245" author="smarlow" created="Fri, 13 Dec 2013 14:37:09 -0500"  >&lt;p&gt;If the WebServlet calls a synchronous bean instead (&lt;a href=&quot;http://localhost:8080/async-testcase-1.0-SNAPSHOT/sync-counter&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://localhost:8080/async-testcase-1.0-SNAPSHOT/sync-counter&lt;/a&gt;) of an asynchronous bean, the TransactionRollbackSetupAction.checkTransactionStatus() does &lt;b&gt;not&lt;/b&gt; see the CMTTxInterceptor controlled transaction.  Call stack at checkTransactionStatus time is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;at org.jboss.as.txn.deployment.TransactionRollbackSetupAction.checkTransactionStatus(TransactionRollbackSetupAction.java:113)&lt;br/&gt;
at org.jboss.as.txn.deployment.TransactionRollbackSetupAction.teardown(TransactionRollbackSetupAction.java:66)&lt;br/&gt;
at org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$1$1.tearDown(UndertowDeploymentInfoService.java:307)&lt;br/&gt;
at io.undertow.servlet.core.CompositeThreadSetupAction$1.tearDown(CompositeThreadSetupAction.java:52)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:289)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:225)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.access$000(ServletInitialHandler.java:71)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler$1.handleRequest(ServletInitialHandler.java:144)&lt;br/&gt;
at io.undertow.server.Connectors.executeRootHandler(Connectors.java:164)&lt;br/&gt;
at io.undertow.server.HttpServerExchange$1.run(HttpServerExchange.java:655)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:724)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12931246" author="smarlow" created="Fri, 13 Dec 2013 14:43:04 -0500"  >&lt;p&gt;Seems that with the synchronous bean, we end the CMTTxInterceptor.endTransaction transaction before the TransactionRollbackSetupAction.checkTransactionStatus is called (both from the same thread).  Ordering problem?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;at org.jboss.as.ejb3.tx.CMTTxInterceptor.endTransaction(CMTTxInterceptor.java:88)&lt;br/&gt;
at org.jboss.as.ejb3.tx.CMTTxInterceptor.invokeInOurTx(CMTTxInterceptor.java:277)&lt;br/&gt;
at org.jboss.as.ejb3.tx.CMTTxInterceptor.required(CMTTxInterceptor.java:340)&lt;br/&gt;
at org.jboss.as.ejb3.tx.CMTTxInterceptor.processInvocation(CMTTxInterceptor.java:239)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.component.interceptors.CurrentInvocationContextInterceptor.processInvocation(CurrentInvocationContextInterceptor.java:41)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.component.invocationmetrics.WaitTimeInterceptor.processInvocation(WaitTimeInterceptor.java:43)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.security.SecurityContextInterceptor.processInvocation(SecurityContextInterceptor.java:95)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.component.interceptors.ShutDownInterceptorFactory$1.processInvocation(ShutDownInterceptorFactory.java:64)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.component.interceptors.LoggingInterceptor.processInvocation(LoggingInterceptor.java:59)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ee.component.NamespaceContextInterceptor.processInvocation(NamespaceContextInterceptor.java:50)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.as.ejb3.component.interceptors.AdditionalSetupInterceptor.processInvocation(AdditionalSetupInterceptor.java:55)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.invocation.ContextClassLoaderInterceptor.processInvocation(ContextClassLoaderInterceptor.java:64)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;br/&gt;
at org.wildfly.security.manager.WildFlySecurityManager.doChecked(WildFlySecurityManager.java:437)&lt;br/&gt;
at org.jboss.invocation.AccessCheckingInterceptor.processInvocation(AccessCheckingInterceptor.java:61)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.run(InterceptorContext.java:325)&lt;br/&gt;
at org.jboss.invocation.PrivilegedWithCombinerInterceptor.processInvocation(PrivilegedWithCombinerInterceptor.java:80)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
at org.jboss.as.ee.component.ViewService$View.invoke(ViewService.java:185)&lt;br/&gt;
at org.jboss.as.ee.component.ViewDescription$1.processInvocation(ViewDescription.java:182)&lt;br/&gt;
at org.jboss.invocation.InterceptorContext.proceed(InterceptorContext.java:309)&lt;br/&gt;
at org.jboss.invocation.ChainedInterceptor.processInvocation(ChainedInterceptor.java:61)&lt;br/&gt;
at org.jboss.as.ee.component.ProxyInvocationHandler.invoke(ProxyInvocationHandler.java:73)&lt;br/&gt;
at testcase.async.SyncBean$$$view1.count(Unknown Source:-1)&lt;br/&gt;
at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)&lt;br/&gt;
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
at org.jboss.weld.util.reflection.Reflections.invokeAndUnwrap(Reflections.java:393)&lt;br/&gt;
at org.jboss.weld.bean.proxy.EnterpriseBeanProxyMethodHandler.invoke(EnterpriseBeanProxyMethodHandler.java:99)&lt;br/&gt;
at org.jboss.weld.bean.proxy.EnterpriseTargetBeanInstance.invoke(EnterpriseTargetBeanInstance.java:56)&lt;br/&gt;
at org.jboss.weld.bean.proxy.InjectionPointPropagatingEnterpriseTargetBeanInstance.invoke(InjectionPointPropagatingEnterpriseTargetBeanInstance.java:65)&lt;br/&gt;
at org.jboss.weld.bean.proxy.ProxyMethodHandler.invoke(ProxyMethodHandler.java:100)&lt;br/&gt;
at testcase.async.SyncBean$Proxy$_$$_Weld$EnterpriseProxy$.count(Unknown Source:-1)&lt;br/&gt;
at testcase.async.CounterServlet2.doGet(CounterServlet2.java:20)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletHandler.handleRequest(ServletHandler.java:87)&lt;br/&gt;
at io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:61)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:36)&lt;br/&gt;
at org.wildfly.extension.undertow.security.SecurityContextAssociationHandler.handleRequest(SecurityContextAssociationHandler.java:81)&lt;br/&gt;
at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:25)&lt;br/&gt;
at io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:113)&lt;br/&gt;
at io.undertow.security.handlers.AuthenticationCallHandler.handleRequest(AuthenticationCallHandler.java:52)&lt;br/&gt;
at io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:45)&lt;br/&gt;
at io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:61)&lt;br/&gt;
at io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:65)&lt;br/&gt;
at io.undertow.security.handlers.SecurityInitialHandler.handleRequest(SecurityInitialHandler.java:70)&lt;br/&gt;
at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:25)&lt;br/&gt;
at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:25)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:238)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:225)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler.access$000(ServletInitialHandler.java:71)&lt;br/&gt;
at io.undertow.servlet.handlers.ServletInitialHandler$1.handleRequest(ServletInitialHandler.java:144)&lt;br/&gt;
at io.undertow.server.Connectors.executeRootHandler(Connectors.java:164)&lt;br/&gt;
at io.undertow.server.HttpServerExchange$1.run(HttpServerExchange.java:655)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:724)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12933982" author="swd847" created="Mon, 6 Jan 2014 17:32:55 -0500"  >&lt;p&gt;This does appear to be an Undertow issue. I will have a look into it. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12379592" name="async-testcase-1.0-SNAPSHOT.war" size="5647" author="smarlow" created="Fri, 13 Dec 2013 14:24:28 -0500"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310010" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Forum Reference</customfieldname>
                        <customfieldvalues>
                            https://community.jboss.org/message/849592
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310220" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Git Pull Request</customfieldname>
                        <customfieldvalues>
                            https://github.com/wildfly/wildfly/pull/5677
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzlg9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>185419</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>