<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 15:35:43 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-6127/WFLY-6127.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-6127] Throw IllegalStateException if JTA tx has an unsynchronized persistence context and the target is synchronized persistence context</title>
                <link>https://issues.jboss.org/browse/WFLY-6127</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;SPEC: If a component is called and the JTA transaction is propagated into that component:&lt;br/&gt;
If there is a persistence context of type SynchronizationType.UNSYNCHRONIZED&lt;br/&gt;
associated with the JTA transaction and the target component specifies a persistence context of type SynchronizationType.SYNCHRONIZED, the IllegalStateException is thrown by the container&lt;/p&gt;

&lt;p&gt;We have a stateful session bean (SFB1) / PC: TRANSACTION/UNSYNCHRONIZED)&lt;br/&gt;
stateful session bean (SFB2) / PC: TRANSACTION/SYNCHRONIZED)&lt;/p&gt;

&lt;p&gt;SFB1 method M1 (REQUIRED) calls SFB2 Method 2 (REQUIRED):&lt;br/&gt;
PC is propagated from SFB1 to SFB2 without any exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12602608">WFLY-6127</key>
            <summary>Throw IllegalStateException if JTA tx has an unsynchronized persistence context and the target is synchronized persistence context</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.jboss.org/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.jboss.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="smarlow">Scott Marlow</assignee>
                                    <reporter username="mazounne81">Mazen Mahmoud</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Feb 2016 08:32:41 -0500</created>
                <updated>Fri, 9 Sep 2016 10:45:01 -0400</updated>
                            <resolved>Thu, 18 Aug 2016 23:48:29 -0400</resolved>
                                    <version>9.0.2.Final</version>
                    <version>10.0.0.Final</version>
                                    <fixVersion>10.1.0.CR1</fixVersion>
                    <fixVersion>10.1.0.Final</fixVersion>
                                    <component>JPA / Hibernate</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13158806" author="smarlow" created="Thu, 4 Feb 2016 09:19:13 -0500"  >&lt;p&gt;It has been a while since I thought we fixed this.  Could you attach TRACE output from the initial call to SFSB1.M1() and call to SFSB2.method2() and M1 returning.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.jboss.org/author/display/WFLY10/JPA+Reference+Guide#JPAReferenceGuide-Troubleshooting&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Please enable TRACE logging for org.jboss.as.jpa + com.arjuna. (clear here for doc on how) &lt;/a&gt; .&lt;/p&gt;
</comment>
                            <comment id="13158951" author="mazounne81" created="Thu, 4 Feb 2016 13:51:36 -0500"  >&lt;p&gt;Kindly find attached the call log as requested&lt;/p&gt;</comment>
                            <comment id="13158959" author="smarlow" created="Thu, 4 Feb 2016 14:24:38 -0500"  >&lt;p&gt;I recreated the bug, thanks for reporting this issue!&lt;/p&gt;</comment>
                            <comment id="13158963" author="mazounne81" created="Thu, 4 Feb 2016 14:37:13 -0500"  >&lt;p&gt;Welcome.&lt;/p&gt;</comment>
                            <comment id="13159011" author="smarlow" created="Thu, 4 Feb 2016 17:22:42 -0500"  >&lt;p&gt;&lt;a href=&quot;https://github.com/scottmarlow/wildfly/tree/WFLY-6127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/scottmarlow/wildfly/tree/WFLY-6127&lt;/a&gt; introduces a EntityManagerWrapper so we can track the SynchronizationType.  It might be more efficient to only track the SynchronizationType for persistence contents that are UNSYNCHRONIZED.  Previously, we were only checking the SynchronizationType for extended persistence contexts (since we were saving the underlying persistence provider&apos;s entity manager in the TransactionSynchronizationRegistry which doesn&apos;t expose a getSynchronizationType()).&lt;/p&gt;

&lt;p&gt;The downside of the current change is that each transaction scoped persistence context will have an additional Object associated with it (with two Object references to Objects that already exist).  &lt;/p&gt;</comment>
                            <comment id="13159443" author="smarlow" created="Fri, 5 Feb 2016 16:14:28 -0500"  >&lt;p&gt;I pushed a better version of the fix to &lt;a href=&quot;https://github.com/scottmarlow/wildfly/tree/WFLY-6127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/scottmarlow/wildfly/tree/WFLY-6127&lt;/a&gt; and squashed the commits (so previous concern mentioned about the downside is address).  With the new change, we only introduce a little more overhead for unsynchronized persistence contexts.  &lt;/p&gt;</comment>
                            <comment id="13281119" author="jason.greene" created="Thu, 18 Aug 2016 23:47:37 -0400"  >&lt;p&gt;Opening to update version&lt;/p&gt;</comment>
                            <comment id="13288791" author="veselroger" created="Mon, 5 Sep 2016 11:47:38 -0400"  >&lt;p&gt;&lt;b&gt;The obtained defect:&lt;/b&gt;&lt;br/&gt;
A defect related to the check of synchronization type (to satisfy JPA spec 2.1 section 7.6.4.1) was found in WildFly 10.1.0.Final.&lt;br/&gt;
The Method getSynchronizationType of ExtendedEntityManager class ALWAYS returns SYNCHRONIZED  type of synchronization.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;FIX:&lt;/b&gt;&lt;br/&gt;
We created a fork of WildFly-jpa project at: &lt;a href=&quot;https://github.com/argustelecom/wildfly/tree/WFLY-6127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/argustelecom/wildfly/tree/WFLY-6127&lt;/a&gt;&lt;br/&gt;
Our Fix commit: &lt;a href=&quot;https://github.com/wildfly/wildfly/commit/3bff5fde3cfc23f3999dc75c320029e69c562c40&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/commit/3bff5fde3cfc23f3999dc75c320029e69c562c40&lt;/a&gt;&lt;br/&gt;
Corrections: The method getSynchronizationType returns declared synchronization type.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Effect:&lt;/b&gt;&lt;br/&gt;
We use our own realization of Martin Fowler&#8217;s pattern &quot;Unit of Work&quot;. We initialize Unsynchronized Extended Persistence Context and our realization controls the synchronization with transaction.&lt;br/&gt;
Our Beans can be controlled by UnitOfWork, as well as be used as a part of WebService call.&lt;br/&gt;
This  requires the declaration of synchronized persistence context.&lt;/p&gt;

&lt;p&gt;We catch IllegalStateException after we have fixed the defect of synchronization type determination, because we initialize UNSYNCHRONIZED persistence context, but we declare synchronized persistence context in our beans.&lt;/p&gt;

&lt;p&gt;However, our UnitOfWork realization controls synchronization of persistence context and we can synchronize context before the synchronization type check.  &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Our actions:&lt;/b&gt;&lt;br/&gt;
We had to add the possibility to check synchronization type in the  testForMixedSynchronizationTypes method of TransactionScopedEntityManager class by isJoinToTransaction method (i.e. the actual state of synchronization).&lt;br/&gt;
This ability is realized by property &quot;jboss.as.jpa.syncasjoin&quot; in persistence.xml file. Only if this property is set to true - we perform testForMixedSynchronizationTypes by isJoinToTransaction method. The system operates as usual if this property is not defined or set to false.&lt;br/&gt;
Commit: &lt;a href=&quot;https://github.com/wildfly/wildfly/commit/195a8a65a9fae006ad603e425f6a16d896183ed2&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/commit/195a8a65a9fae006ad603e425f6a16d896183ed2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Commentary:&lt;/b&gt;&lt;br/&gt;
Though our actions deviate from JPA SPEC,  we have a valid reason for acting this way:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A question arose in the development process of the JPA specification : &quot;Should we relax this if the PC has been joined to the transaction?&quot;.&lt;br/&gt;
Unfortunately, no feedback was given and Linda DeMichiel decided to keep it as it was &lt;br/&gt;
( &lt;a href=&quot;https://java.net/projects/jpa-spec/lists/jsr338-experts/archive/2011-08/message/5&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://java.net/projects/jpa-spec/lists/jsr338-experts/archive/2011-08/message/5&lt;/a&gt; )&lt;/li&gt;
	&lt;li&gt;We found a JIRA task &lt;a href=&quot;https://java.net/jira/browse/JPA_SPEC-6&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://java.net/jira/browse/JPA_SPEC-6&lt;/a&gt; . And it was also closed too: &quot;No feedback in favor of changing current approach&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13288802" author="kostd" created="Mon, 5 Sep 2016 12:04:41 -0400"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=smarlow&quot; class=&quot;user-hover&quot; rel=&quot;smarlow&quot;&gt;Scott Marlow&lt;/a&gt;, can you accept &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=veselroger&quot; class=&quot;user-hover&quot; rel=&quot;veselroger&quot;&gt;Viacheslav Astapkovich&lt;/a&gt; `s commit (which adds the jboss.as.jpa.syncasjoin option and &quot;relaxed&quot; check against current.isJoined instead of current.getSyncType() == Synchronized)?  JCP process seems stopped (&lt;a href=&quot;https://javaee-guardians.io/lack-of-java-ee-8-progress/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://javaee-guardians.io/lack-of-java-ee-8-progress/&lt;/a&gt;) and our feedback to Linda is too late &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.jboss.org/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;What we can do to you able to accept? may be some ut or something like that?&lt;/p&gt;

&lt;p&gt;We can rework to take your comments.&lt;/p&gt;</comment>
                            <comment id="13289316" author="smarlow" created="Tue, 6 Sep 2016 10:25:29 -0400"  >&lt;p&gt;Please create a new &lt;a href=&quot;https://issues.jboss.org/browse/WFLY&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;WFLY jira&lt;/a&gt; to discuss the proposed (extension) patch &lt;a href=&quot;https://github.com/argustelecom/wildfly/tree/WFLY-6127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/argustelecom/wildfly/tree/WFLY-6127&lt;/a&gt;.  I have questions to ask about the change and whether you could instead use an application-managed entity manager instead (which is similar to extended persistence context except the app controls it.  Please include the above two comments as well.  &lt;/p&gt;</comment>
                            <comment id="13289320" author="smarlow" created="Tue, 6 Sep 2016 10:29:11 -0400"  >&lt;p&gt;WildFly 10.1.0.Final contains the fix for the reported issue.  The discussion about extended persistence context belongs in a separate jira (or could be discussed on &lt;span class=&quot;error&quot;&gt;&amp;#91;wildfly-dev@lists.jboss.org&amp;#93;&lt;/span&gt;).&lt;/p&gt;</comment>
                            <comment id="13290760" author="veselroger" created="Thu, 8 Sep 2016 12:08:12 -0400"  >&lt;p&gt;Registered as: &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-7075&quot; title=&quot;proposal (Extension): allow checking of mixed persistence context synchronization types to be skipped or to check if unsync context is already joined to JTA TX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-7075&quot;&gt;&lt;del&gt;WFLY-7075&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13290816" author="veselroger" created="Thu, 8 Sep 2016 13:58:26 -0400"  >&lt;p&gt;&quot;We have WildFly 10.1.0.Final contains the fix for the reported issue.&quot;:&lt;br/&gt;
Unfortunately, in &lt;b&gt;wildfly-jpa-10.1.0.Final&lt;/b&gt; we still always get SYNCHRONIZE when get Synchronization Type of &lt;em&gt;ExtendedEntityManager&lt;/em&gt;. Even if we have UNSYNCHRONIZED EntityManager.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Example for reproduce:&lt;/b&gt; &lt;a href=&quot;https://issues.jboss.org/secure/attachment/12409264/12409264_kitchensink-ear.rar&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.jboss.org/secure/attachment/12409264/12409264_kitchensink-ear.rar&lt;/a&gt; from &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-7075&quot; title=&quot;proposal (Extension): allow checking of mixed persistence context synchronization types to be skipped or to check if unsync context is already joined to JTA TX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-7075&quot;&gt;&lt;del&gt;WFLY-7075&lt;/del&gt;&lt;/a&gt; (modified quickstart example).&lt;br/&gt;
&lt;ins&gt;MemberRepository&lt;/ins&gt; create UNSYNCHRONIZE EntityManager, but we still get SYNCHRONIZED (printed as sysout).&lt;/p&gt;</comment>
                            <comment id="13291276" author="smarlow" created="Fri, 9 Sep 2016 10:45:01 -0400"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=veselroger&quot; class=&quot;user-hover&quot; rel=&quot;veselroger&quot;&gt;Viacheslav Astapkovich&lt;/a&gt; for reporting the &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-7075&quot; title=&quot;proposal (Extension): allow checking of mixed persistence context synchronization types to be skipped or to check if unsync context is already joined to JTA TX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-7075&quot;&gt;&lt;del&gt;WFLY-7075&lt;/del&gt;&lt;/a&gt; jira to add the suggested extension.  &lt;/p&gt;

&lt;p&gt;For applying the patch that you mention, for the org.jboss.as.jpa.container.ExtendedEntityManager.getSynchronizationType() to return the proper application specified SynchronizationType, could you please also create a tracking jira for that bug fix, which your comment correctly identifies as still unfixed after &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-6127&quot; title=&quot;Throw IllegalStateException if JTA tx has an unsynchronized persistence context and the target is synchronized persistence context&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-6127&quot;&gt;&lt;del&gt;WFLY-6127&lt;/del&gt;&lt;/a&gt; changes were applied.  We need a separate jira for that bug fix because the changes for &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-6127&quot; title=&quot;Throw IllegalStateException if JTA tx has an unsynchronized persistence context and the target is synchronized persistence context&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WFLY-6127&quot;&gt;&lt;del&gt;WFLY-6127&lt;/del&gt;&lt;/a&gt; were already released in WildFly 10.1.0, so it would be confusing to reopen it.  Thank you! -Scott&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310120">
                    <name>Cloners</name>
                                                                <inwardlinks description="cloned to">
                                        <issuelink>
            <issuekey id="12602908">JBEAP-3271</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12397538" name="server-log.txt" size="2895" author="mazounne81" created="Thu, 4 Feb 2016 13:51:08 -0500"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|i019r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>