<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 13:41:02 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFLY-1463/WFLY-1463.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFLY-1463] PersistenceUnitService depends on not-yet-available BeanManager</title>
                <link>https://issues.jboss.org/browse/WFLY-1463</link>
                <project id="12313721" key="WFLY">WildFly</project>
                    <description>&lt;p&gt;I am getting&lt;/p&gt;

&lt;p/&gt;
&lt;div id=&quot;syntaxplugin&quot; class=&quot;syntaxplugin&quot; style=&quot;border: 1px dashed #bbb; border-radius: 5px !important; overflow: auto; max-height: 30em;&quot;&gt;
&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot; style=&quot;font-size: 1em; line-height: 1.4em !important; font-weight: normal; font-style: normal; color: black;&quot;&gt;
		&lt;tbody &gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;  margin-top: 10px;   width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;17:12:25,453 ERROR [org.jboss.as.controller.management-operation] (management-handler-thread - 2) JBAS014613: Operation (&quot;deploy&quot;) failed - address: ([(&quot;deployment&quot; =&amp;gt; &quot;jpa_txTimeoutTestWithMockProvider.ear&quot;)]) - failure description: {&quot;JBAS014771: Services with missing/unavailable dependencies&quot; =&amp;gt; [&quot;jboss.persistenceunit.\&quot;jpa_txTimeoutTestWithMockProvider.ear/ejbjar.jar#mypc\&quot; is missing [jboss.deployment.subunit.\&quot;jpa_txTimeoutTestWithMockProvider.ear\&quot;.\&quot;ejbjar.jar\&quot;.beanmanager]&quot;]}&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
				&lt;tr id=&quot;syntaxplugin_code_and_gutter&quot;&gt;
						&lt;td  style=&quot; line-height: 1.4em !important; padding: 0em; vertical-align: top;&quot;&gt;
					&lt;pre style=&quot;font-size: 1em; margin: 0 10px;   margin-bottom: 10px;  width: auto; padding: 0;&quot;&gt;&lt;span style=&quot;color: black; font-family: &apos;Consolas&apos;, &apos;Bitstream Vera Sans Mono&apos;, &apos;Courier New&apos;, Courier, monospace !important;&quot;&gt;17:12:25,459 ERROR [org.jboss.as.server] (management-handler-thread - 2) JBAS015870: Deploy of deployment &quot;jpa_txTimeoutTestWithMockProvider.ear&quot; was rolled back with the following failure message: {&quot;JBAS014771: Services with missing/unavailable dependencies&quot; =&amp;gt; [&quot;jboss.persistenceunit.\&quot;jpa_txTimeoutTestWithMockProvider.ear/ejbjar.jar#mypc\&quot; is missing [jboss.deployment.subunit.\&quot;jpa_txTimeoutTestWithMockProvider.ear\&quot;.\&quot;ejbjar.jar\&quot;.beanmanager]&quot;]}&lt;/span&gt;&lt;/pre&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
			&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p/&gt;

&lt;p&gt;The problem is caused by PersistenceUnitServiceHandler.deployPersistenceUnit() which, if the PU is deployed in a CDI-enabled archive, adds a dependency on the BeanManager service. This happens in PersistenceBeginInstallProcessor which executes in the FIRST_MODULE_USE phase.&lt;/p&gt;

&lt;p&gt;However, the BeanManager service is not installed by the Weld subsystem until the INSTALL phase.&lt;/p&gt;

&lt;p&gt;This can be reproduced easily. Take for example the org.jboss.as.test.integration.jpa.mockprovider.txtimeout.TxTimeoutTestCase and add an empty beans.xml file to the ejb jar (ejbjar.addAsManifestResource(EmptyAsset.INSTANCE, &quot;beans.xml&quot;))&lt;/p&gt;

&lt;p&gt;This issue blocks proper Weld integration (implicit bean archives).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493748">WFLY-1463</key>
            <summary>PersistenceUnitService depends on not-yet-available BeanManager</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.jboss.org/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.jboss.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="smarlow">Scott Marlow</assignee>
                                    <reporter username="jharting">Jozef Hartinger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Jun 2013 11:31:43 -0400</created>
                <updated>Thu, 11 Jul 2013 22:20:48 -0400</updated>
                            <resolved>Thu, 11 Jul 2013 21:59:01 -0400</resolved>
                                    <version>8.0.0.Alpha1</version>
                                    <fixVersion>8.0.0.Alpha3</fixVersion>
                                    <component>JPA / Hibernate</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12779841" author="smarlow" created="Thu, 6 Jun 2013 11:51:40 -0400"  >&lt;p&gt;A workaround might be to add the &lt;a href=&quot;https://docs.jboss.org/author/display/WFLY8/JPA+Reference+Guide#JPAReferenceGuide-Persistenceunitproperties&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;jboss.as.jpa.classtransformer&lt;/a&gt; property (set to false) to the persistence unit definition.&lt;/p&gt;

&lt;p&gt;This would mean that class transformers will not have a chance to rewrite/enhance entities.&lt;/p&gt;</comment>
                            <comment id="12779889" author="smarlow" created="Thu, 6 Jun 2013 13:54:18 -0400"  >&lt;p&gt;For application that use Hibernate 4.1.x jars, we need to make a code change to (automatically) detect if the application sets persistence unit property &quot;hibernate.ejb.use_class_enhancer&quot; so we know whether to start the persistence unit before other deployers might read application classes (after that happens, they can&apos;t be enhanced/rewritten).&lt;/p&gt;

&lt;p&gt;For applications that use Hibernate 4.3.x jars, we already check if the &quot;hibernate.ejb.use_class_enhancer&quot; is set to true and if it is, we start the PersistenceUnitService early during FIRST_MODULE_USE (which means BeanManager will not be accessible and is not supported).  I verified that setting pu property &quot;jboss.as.jpa.classtransformer&quot; to false works around this problem with non-Hibernate persistence providers.&lt;/p&gt;

&lt;p&gt;This should be documented in the jpa documentation.&lt;/p&gt;
</comment>
                            <comment id="12780263" author="jharting" created="Fri, 7 Jun 2013 11:27:26 -0400"  >&lt;p&gt;There is a cycle that needs to be broken somehow. When a container-managed EntityManagerFactory is created, this operation consists of:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;executing class transformers&lt;/li&gt;
	&lt;li&gt;initialization of entity listeners&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;From the JPA SPI point of view, the creation of EMF is a single operation and therefore 1) and 2) cannot be split apart nor is there another initialization hook in which 2) could be performed.&lt;/p&gt;

&lt;p&gt;--&amp;gt; means &quot;depends on&quot; hereafter&lt;/p&gt;

&lt;p&gt;(initialization of entity listeners) --&amp;gt; (weld initialized) --&amp;gt; (class transformers executed)&lt;/p&gt;</comment>
                            <comment id="12780268" author="jharting" created="Fri, 7 Jun 2013 11:35:03 -0400"  >&lt;p&gt;Possible solutions:&lt;/p&gt;

&lt;p&gt;1) The persistence provider would need to initialize entity listeners lazily. In that case a proxy could be passed in during EMF creation (the proxy would not be functional at that time yet and would start working after weld initialization).&lt;/p&gt;

&lt;p&gt;Downsides: all the persistence providers would need to support this plus if there were a deployment/definition error in an entity listener it would not be discovered until runtime which is concerning&lt;/p&gt;

&lt;p&gt;2) Not to support entity listener injection by default. The user would need to decide whether to have class transformers working or CDI injection into listeners working but not both. This would be configured by a property in persistence.xml&lt;/p&gt;

&lt;p&gt;Concerns: Limiting to users plus I am not sure if we can pass the TCK with this.&lt;/p&gt;</comment>
                            <comment id="12780277" author="jharting" created="Fri, 7 Jun 2013 12:33:46 -0400"  >&lt;p&gt;A log of a conversation I had with Scott about this issue &lt;a href=&quot;https://gist.github.com/jharting/5730549&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://gist.github.com/jharting/5730549&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12782208" author="smarlow" created="Mon, 17 Jun 2013 19:55:00 -0400"  >&lt;p&gt;&lt;a href=&quot;https://github.com/scottmarlow/wildfly/tree/WFLY_1463_CreateEMFWith2phases&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/scottmarlow/wildfly/tree/WFLY_1463_CreateEMFWith2phases&lt;/a&gt; is getting closer (need to replace snapshot reference to &lt;a href=&quot;http://github.com/jipijapa/jipijapa&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://github.com/jipijapa/jipijapa&lt;/a&gt; projects).&lt;/p&gt;</comment>
                            <comment id="12783595" author="smarlow" created="Fri, 21 Jun 2013 09:31:59 -0400"  >&lt;p&gt;We need a snapshot build of jipijapa (alpha3) to test this.  Do we need anything else other than &lt;a href=&quot;https://github.com/wildfly/wildfly/pull/4598?&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/wildfly/wildfly/pull/4598?&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="12783617" author="jharting" created="Fri, 21 Jun 2013 10:33:53 -0400"  >&lt;p&gt;The PR should be sufficient. Let me rebase it.&lt;/p&gt;</comment>
                            <comment id="12783619" author="jharting" created="Fri, 21 Jun 2013 10:44:18 -0400"  >&lt;p&gt;Done&lt;/p&gt;</comment>
                            <comment id="12789238" author="smarlow" created="Thu, 11 Jul 2013 22:03:30 -0400"  >&lt;p&gt;By default, we will create the persistence unit in two phases, which works around the conflict between implicit CDI (reads application classes) + creating the persistence unit.  &lt;/p&gt;

&lt;p&gt;If the persistence unit has a hint &quot;wildfly.jpa.twophasebootstrap&quot; set to false, the persistence unit will be created in one phase (implicit CDI bean manager will not be passed in when the EntityManagerFactory is created, which means entity listeners cannot use CDI.&lt;/p&gt;</comment>
                            <comment id="12789239" author="smarlow" created="Thu, 11 Jul 2013 22:20:48 -0400"  >&lt;p&gt;We create a proxy for the bean manager during the first phase (FIRST_MODULE_USE), which is later replaced during the second phase (INSTALL) with the real CDI bean manager.  Its during the second phase that the bean manager is used for the first time.&lt;/p&gt;

&lt;p&gt;Currently, only Hibernate integration code supports the two-phase org.jipijapa.plugin.spi.EntityManagerFactoryBuilder (&lt;a href=&quot;https://github.com/jipijapa/jipijapa/blob/master/spi/src/main/java/org/jipijapa/plugin/spi/EntityManagerFactoryBuilder.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/jipijapa/jipijapa/blob/master/spi/src/main/java/org/jipijapa/plugin/spi/EntityManagerFactoryBuilder.java&lt;/a&gt;) but other persistence providers could also support the same concept (which we could enable with JipiJapa integration code).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10012">
                    <name>Dependency</name>
                                            <outwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12494051">JIPI-11</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12488507">WFLY-476</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="org.jboss.labs.jira.plugin.jboss-custom-field-types-plugin:multiurl">
                        <customfieldname>Git Pull Request</customfieldname>
                        <customfieldvalues>
                            https://github.com/wildfly/wildfly/pull/4722
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzh96f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161094</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>