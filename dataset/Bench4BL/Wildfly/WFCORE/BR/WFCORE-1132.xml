<!-- 
RSS generated by JIRA (7.2.3#72005-sha1:73be91d2b96fc29303a7eb6820acf420e5d0ed65) at Tue Dec 06 16:21:58 EST 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.jboss.org/si/jira.issueviews:issue-xml/WFCORE-1132/WFCORE-1132.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>JBoss Issue Tracker</title>
    <link>https://issues.jboss.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>7.2.3</version>
        <build-number>72005</build-number>
        <build-date>06-10-2016</build-date>
    </build-info>

<item>
            <title>[WFCORE-1132] Only set socket send and receive buffer sizes if it is in the Remoting subsystem configuration</title>
                <link>https://issues.jboss.org/browse/WFCORE-1132</link>
                <project id="12315422" key="WFCORE">WildFly Core</project>
                    <description>&lt;p&gt;Original report:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In our testing of Wildfy 10 CR4, in the performance lab, we found that one of the differences between EAP 6.4.x and Wildfly 10 was that EAP does not set the socket send and receive buffers.  We changed the configuration of Wildfly (Undertow) to remove the buffer parameters from the configuration, and we found that the buffer sizes were still be set to 8k.  We hacked XNIO to comment out the setting of these parameters, and latency improved quite a bit.&lt;/p&gt;

&lt;p&gt;So, we need a permanent fix so that the socket send and receive buffers are only set, if they are specified in the configuration.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This applies to the Remoting subsystem configuration, versions 2.0 and onwards, and also possibly to Undertow, though that subsystem does not appear to use default values.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12592648">WFCORE-1132</key>
            <summary>Only set socket send and receive buffer sizes if it is in the Remoting subsystem configuration</summary>
                <type id="1" iconUrl="https://issues.jboss.org/secure/viewavatar?size=xsmall&amp;avatarId=13263&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.jboss.org/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.jboss.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Done</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="andy.miller">Andrig Miller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Nov 2015 15:52:21 -0500</created>
                <updated>Fri, 13 Nov 2015 10:44:32 -0500</updated>
                            <resolved>Fri, 13 Nov 2015 10:44:32 -0500</resolved>
                                    <version>2.0.1.Final</version>
                                    <fixVersion>2.0.2.Final</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13128534" author="dmlloyd" created="Thu, 12 Nov 2015 16:03:48 -0500"  >&lt;p&gt;This analysis is probably wrong:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The &quot;receive-buffer-size&quot; and &quot;send-buffer-size&quot; management attributes have a default value of 8192 (bytes) as of 2.0 of the subsystem (that is, since WildFly 8 onwards).  This is obviously a very poor default.  On my system at least, the default buffer sizes are nearer to 100s of kilobytes.&lt;/p&gt;

&lt;p&gt;The performance team argues that there should be no default, letting the OS choose.  I&apos;m okay with that, and I&apos;m also okay with changing the default to something more sensible in the 128k range, depending on what works best for compatibility, etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Still figuring out what&apos;s happening here.  Those attributes seem to correspond to the Remoting buffer sizes as expected, so this problem may actually be in the Undertow subsystem after all.&lt;/p&gt;</comment>
                            <comment id="13128538" author="andy.miller" created="Thu, 12 Nov 2015 16:09:18 -0500"  >&lt;p&gt;We would prefer no defaults, and this also follows the recommendation from the networking expert on the platform performance team.&lt;/p&gt;

&lt;p&gt;One other data point, in our testing in the performance lab, latency improved significantly by removing the setting of the send and receive buffers.&lt;/p&gt;</comment>
                            <comment id="13128547" author="dmlloyd" created="Thu, 12 Nov 2015 16:23:07 -0500"  >&lt;p&gt;I&apos;ve done a search through various code bases and I&apos;m not actually finding any place which is setting the socket buffer size to 8192.  Is it possible to get a backtrace from where you observe the call to &lt;tt&gt;setSendBufferSize()&lt;/tt&gt; and/or &lt;tt&gt;setReceiveBufferSize()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="13128549" author="andy.miller" created="Thu, 12 Nov 2015 16:29:37 -0500"  >&lt;p&gt;We removed it from the Undertow configuration, as we had them specified, and STRACE still showed it being set.  We then just commented out the code in XNIO, so we didn&apos;t use profiling with the stack trace, just STRACE to see what socket options were being set.&lt;/p&gt;</comment>
                            <comment id="13128565" author="andy.miller" created="Thu, 12 Nov 2015 17:22:30 -0500"  >&lt;p&gt;Oh, one other thing.  We also tried to search the code base looking for the 8k, but it uses a hex value to set it, so it was not easy to find.&lt;/p&gt;</comment>
                            <comment id="13128571" author="jason.greene" created="Thu, 12 Nov 2015 18:08:16 -0500"  >&lt;p&gt;I just looked and I can&apos;t find anywhere the source it sets it either. I tried booting the server and setting a breakpoint (and trying to connect so that it sets the socket opts on the child socket). I also tried strace but no buffer options were set, just TCP_NODELAY.&lt;/p&gt;</comment>
                            <comment id="13128572" author="jason.greene" created="Thu, 12 Nov 2015 18:11:26 -0500"  >&lt;p&gt;Only thing I can think of is if one of the other protocols is setting it. I tried just connections over http.&lt;/p&gt;</comment>
                            <comment id="13128726" author="andy.miller" created="Fri, 13 Nov 2015 08:50:01 -0500"  >&lt;p&gt;We just found that the Remoting schema actually has 8192 as a default value.&lt;/p&gt;

&lt;p&gt;So, its coming from the schema, which is really bad in my opinion.&lt;/p&gt;</comment>
                            <comment id="13128751" author="dmlloyd" created="Fri, 13 Nov 2015 09:30:12 -0500"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=andy.miller&quot; class=&quot;user-hover&quot; rel=&quot;andy.miller&quot;&gt;Andrig Miller&lt;/a&gt; You&apos;ve made the same mistake that I, Jason, and then Brian made. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.jboss.org/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The setting in the Remoting schema is about sizing for NIO ByteBuffers used by Remoting.  For this purpose, 8192 is actually an optimal size for these buffers (since they can be filled and emptied using scatter/gather operations).  This value never makes its way to a socket option call.  It maps to RemotingOptions.&lt;span class=&quot;error&quot;&gt;&amp;#91;SEND|RECEIVE&amp;#93;&lt;/span&gt;_BUFFER_SIZE, whereas the socket options come from org.xnio.Options.&lt;span class=&quot;error&quot;&gt;&amp;#91;SEND_RECEIVE&amp;#93;&lt;/span&gt;_BUFFER.  In retrospect I might have chosen less ambiguous names...&lt;/p&gt;

&lt;p&gt;But in any event, that schema element is a red herring, and we still have failed to reproduce this problem locally.&lt;/p&gt;</comment>
                            <comment id="13128755" author="andy.miller" created="Fri, 13 Nov 2015 09:36:28 -0500"  >&lt;p&gt;Okay, I&apos;m at a loss here, but org.xnio.Options.&lt;span class=&quot;error&quot;&gt;&amp;#91;SEND_RECEIVE&amp;#93;&lt;/span&gt;_BUFFER is what we commented out in XNIO that finally showed that the socket send receive buffers where no longer being set.  And by the way, my name is not Andrew, but Andrig &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.jboss.org/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13128761" author="andy.miller" created="Fri, 13 Nov 2015 09:39:14 -0500"  >&lt;p&gt;So, when we booted Wildfly 10 CR4, and used STRACE we clearly see those send/receive buffer size set, so its happening somewhere, and commenting out the two lines of code in XNIO solved, it, but the logic clearly shows that if those values are not in the OptionMap, they don&apos;t get set, so they are being set somewhere above XNIO.&lt;/p&gt;</comment>
                            <comment id="13128764" author="dmlloyd" created="Fri, 13 Nov 2015 09:39:48 -0500"  >&lt;p&gt;Ah I did &quot;anmiller&quot; and didn&apos;t even check the result!  Sorry about that.&lt;/p&gt;</comment>
                            <comment id="13128766" author="dmlloyd" created="Fri, 13 Nov 2015 09:41:00 -0500"  >&lt;p&gt;Yeah that&apos;s why I&apos;m hoping to either reproduce it locally, or get a stacktrace capture of when that actually happens in XNIO.  I guess you could even just jam a log.error(new Throwable(), &quot;&quot;) in there.&lt;/p&gt;</comment>
                            <comment id="13128768" author="dmlloyd" created="Fri, 13 Nov 2015 09:42:25 -0500"  >&lt;p&gt;It might possibly be the HornetQ over Netty over XNIO mapping...?&lt;/p&gt;</comment>
                            <comment id="13128771" author="andy.miller" created="Fri, 13 Nov 2015 09:46:13 -0500"  >&lt;p&gt;Is that really happening?&lt;/p&gt;</comment>
                            <comment id="13128777" author="dmlloyd" created="Fri, 13 Nov 2015 09:50:51 -0500"  >&lt;p&gt;Yeah at least it was - I don&apos;t know if that&apos;s still a thing now that we&apos;re heading towards Artemis. &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=jmesnil&quot; class=&quot;user-hover&quot; rel=&quot;jmesnil&quot;&gt;Jeff Mesnil&lt;/a&gt; do you know?&lt;/p&gt;</comment>
                            <comment id="13128785" author="jmesnil" created="Fri, 13 Nov 2015 09:58:47 -0500"  >&lt;p&gt;Yes, Artemis is also using Netty over XNIO mapping.&lt;/p&gt;

&lt;p&gt;The class that is used to set the send/receive buffer sizes is at &lt;a href=&quot;https://github.com/xnio/netty-xnio-transport/blob/master/src/main/java/org/xnio/netty/transport/XnioSocketChannelConfig.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/xnio/netty-xnio-transport/blob/master/src/main/java/org/xnio/netty/transport/XnioSocketChannelConfig.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13128794" author="jason.greene" created="Fri, 13 Nov 2015 10:03:04 -0500"  >&lt;p&gt;&lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=andy.miller&quot; class=&quot;user-hover&quot; rel=&quot;andy.miller&quot;&gt;Andrig Miller&lt;/a&gt; netty-xnio is only used for JMS over HTTP Upgrade, where undertow hands off the connection. Direct connections are pure netty over NIO. &lt;/p&gt;

&lt;p&gt;I did test the JMS quick start, which uses HTTP, and it didn&apos;t set the setting.&lt;/p&gt;

&lt;p&gt;Last night I decompiled all jars in wildfly, and searched the symbol table to Options.SEND/RECEIVE_BUFFER and didn&apos;t see anything that would cause it, other than config, but I need to double check the parsers, to see if there is some funky condition where they pipe in a management setting.&lt;/p&gt;</comment>
                            <comment id="13128798" author="dmlloyd" created="Fri, 13 Nov 2015 10:05:00 -0500"  >&lt;p&gt;I think at this point the only realistic/efficient option is to capture a stack trace.&lt;/p&gt;</comment>
                            <comment id="13128802" author="dmlloyd" created="Fri, 13 Nov 2015 10:08:11 -0500"  >&lt;p&gt;No &lt;a href=&quot;https://issues.jboss.org/secure/ViewProfile.jspa?name=ctomc&quot; class=&quot;user-hover&quot; rel=&quot;ctomc&quot;&gt;Tomaz Cerar&lt;/a&gt;, you&apos;ve made the same mistake mentioned above, see: &lt;a href=&quot;#comment-13128751&quot;&gt;comment-13128751&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13128803" author="jason.greene" created="Fri, 13 Nov 2015 10:09:18 -0500"  >&lt;p&gt;Maybe we should add a comment to that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.jboss.org/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13128804" author="dmlloyd" created="Fri, 13 Nov 2015 10:10:48 -0500"  >&lt;p&gt;Something!&lt;/p&gt;</comment>
                            <comment id="13128805" author="ctomc" created="Fri, 13 Nov 2015 10:13:39 -0500"  >&lt;p&gt;You are right David, sorry for adding confusion to thread, removed the comment just to remove noise.&lt;/p&gt;</comment>
                            <comment id="13128829" author="andy.miller" created="Fri, 13 Nov 2015 10:44:32 -0500"  >&lt;p&gt;Okay, sorry for the wild goose chase.  It turns out that what we were seeing in the socket options was actually the PostgreSQL sockets being set.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310641" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Number of attachments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310640" key="com.atlassian.jira.toolkit:comments">
                        <customfieldname>Number of comments</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311940" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1|hzzo4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310840" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>