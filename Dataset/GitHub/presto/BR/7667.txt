db/TestQueues.testBasic is nondeterministic.
db/TestQueues.testBasic sometimes fails due to a race condition. Tests that have the similar wait-assert pattern can have the same issue.

In db/TestQueues.testBasic we call waitForQueryState() to wait until a query is running. This function directly checks the state machine of a query. However, a following assertion checks a counter maintains by the state change listener. It's possible that after a state change happens, the listener has not been triggered or has not finished at the point we are checking the assert. Such a race condition causes the related test (not only the TestQueues.testBasic) to be nondeterministic (see error log here).

To reproduce the issue, one can comment out this line to increase the possibility of the failure.