Deadlock caused by IDEIdleHelper and HeapStatus calls to runFinalization from UI thread.
Plugins that have multi-threaded access to a COM server dll whose ThreadingModel=Apartment are broken in Eclipse 3.2.

COM implements cross-apartment COM calls using Windows messages.
Thus the IUnknown::Release() calls from a thread in the multi-threaded-apartment (MTA) to an object owned by the single-threaded-apartment (STA) actually post a message to the main thread's dispatch loop and then block waiting for a response.
The IUnknown::Release() calls typically happen during finalization of the Java objects that are accessing the COM server via JNI.

The IDEIdleHelper and HeapStatus calls to System.runFinalization() from the UI thread cause it to block, thus its dispatch loop (i.e. Workbench.runEventLoop) is no longer functioning when objects are finalized.

Result: deadlock.

The System.runFinalization() method, unlike the System.gc() method, causes the calling thread to block on a Thread.join() call:

Here's the relevent code from the Finalizer class:


The "Secondary Finalizer" thread calls the Java objects' finalize() method, which calls IUnknown::Release(), which then deadlocks.

Besides this deadlock behaviour, in principle, it's a bad idea to block the UI thread while doing finalizations.
Especially since there's no compelling reason to do so.

Either the calls to System.runFinalization() should be removed or they should be run from a background thread.
This call is entirely optional anyways.  The objects will eventually be finalized (though there may be compelling reasons to force the finalizations).
Probably the best solution is to make both the call to gc() and to runFinalization() in a background thread.

I have confirmed this behaviour using IBM VM versions 1.4.2 and Sun VM versions 1.4.2 and 1.5.0.
I am unable to reproduce this using the IBM 1.5 vm.

I have written a small Java-only testcase that demonstrates the deadlock.
It emulates the scenario by doing a Display.syncExec() from a Java object's finalize() method so there's no need for the Eclipse team to actually use a Java/COM bridge to see the behaviour.
I'll attach the testcase to the report shortly.