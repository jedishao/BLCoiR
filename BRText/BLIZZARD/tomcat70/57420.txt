Wrong class names generated since URL_ENCODER in DirContextURLConnection is not thread safe.
We've been debugging this for a long time.
Sometimes when tomcat starts up, it will fail to deploy a webapp since it cannot find a certain class.
That class name is always complete garbage.
The error stack trace always is:
From time to time we see, that the referenced class name is actually a mix of the real class name and one or more other classes that exist in the vicinity of that class.
Finally I was able to catch this exception with the debugger.
What I see is that the problem stems from rg.apache.catalina.startup.ContextConfig.processAnnotationsJndi(ContextConfig.java:1986):
- dcUrlConn (DirContextURLConnection) contains the correct entries of the WAR file
- Enumeration<String> dirs = dcUrlConn.list()  however does not.
Calling list() again from the debugger yields the correct results.
Here's the contents of that dirs variable:
walking into the list() command leads to collection.list("/") which in turn is encoded using an URL_ENCODER (class UEncoder).
This URL_ENCODER is *not* thread safe and can result in exactly such garbage if used concurrently.
It is interesting to note that every single failure we had at this step was always caused by classes in the WEB-INF/classes directory, never in JAR files in WEB-INF/lib.
To me it appears that there are two different DirContextURLConnections with rare concurrency issues when both use the same URL_ENCODER.
Here's the full stacktrace when the error occurs: